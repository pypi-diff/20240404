# Comparing `tmp/lightning-thunder-0.1.0.tar.gz` & `tmp/lightning-thunder-0.2.0.dev20240404.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "lightning-thunder-0.1.0.tar", last modified: Wed Mar 20 19:18:02 2024, max compression
+gzip compressed data, was "lightning-thunder-0.2.0.dev20240404.tar", last modified: Thu Apr  4 12:41:35 2024, max compression
```

## Comparing `lightning-thunder-0.1.0.tar` & `lightning-thunder-0.2.0.dev20240404.tar`

### file list

```diff
@@ -1,122 +1,101 @@
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.925602 lightning-thunder-0.1.0/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    11357 2023-02-07 18:36:22.000000 lightning-thunder-0.1.0/LICENSE
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      760 2023-10-27 14:09:46.000000 lightning-thunder-0.1.0/MANIFEST.in
--rw-r--r--   0 jirka     (1000) jirka     (1000)     7834 2024-03-20 19:18:02.925602 lightning-thunder-0.1.0/PKG-INFO
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     6227 2024-03-20 18:40:16.000000 lightning-thunder-0.1.0/README.md
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.925602 lightning-thunder-0.1.0/lightning_thunder.egg-info/
--rw-r--r--   0 jirka     (1000) jirka     (1000)     7834 2024-03-20 19:18:02.000000 lightning-thunder-0.1.0/lightning_thunder.egg-info/PKG-INFO
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     3110 2024-03-20 19:18:02.000000 lightning-thunder-0.1.0/lightning_thunder.egg-info/SOURCES.txt
--rw-rw-r--   0 jirka     (1000) jirka     (1000)        1 2024-03-20 19:18:02.000000 lightning-thunder-0.1.0/lightning_thunder.egg-info/dependency_links.txt
--rw-rw-r--   0 jirka     (1000) jirka     (1000)        1 2024-03-20 19:18:02.000000 lightning-thunder-0.1.0/lightning_thunder.egg-info/not-zip-safe
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      137 2024-03-20 19:18:02.000000 lightning-thunder-0.1.0/lightning_thunder.egg-info/requires.txt
--rw-rw-r--   0 jirka     (1000) jirka     (1000)        8 2024-03-20 19:18:02.000000 lightning-thunder-0.1.0/lightning_thunder.egg-info/top_level.txt
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.913602 lightning-thunder-0.1.0/requirements/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      239 2024-03-13 16:23:32.000000 lightning-thunder-0.1.0/requirements/base.txt
--rw-rw-r--   0 jirka     (1000) jirka     (1000)       12 2023-02-09 07:47:32.000000 lightning-thunder-0.1.0/requirements/devel.txt
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      376 2024-03-05 15:18:59.000000 lightning-thunder-0.1.0/requirements/docs.txt
--rw-rw-r--   0 jirka     (1000) jirka     (1000)       22 2024-03-11 21:56:35.000000 lightning-thunder-0.1.0/requirements/notebooks.txt
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      879 2024-03-20 18:51:37.000000 lightning-thunder-0.1.0/requirements/test.txt
--rw-rw-r--   0 jirka     (1000) jirka     (1000)       38 2024-03-20 19:18:02.925602 lightning-thunder-0.1.0/setup.cfg
--rwxrwxr-x   0 jirka     (1000) jirka     (1000)     4586 2024-03-20 19:11:07.000000 lightning-thunder-0.1.0/setup.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.913602 lightning-thunder-0.1.0/thunder/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      424 2024-03-20 19:14:54.000000 lightning-thunder-0.1.0/thunder/__about__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    32320 2024-03-16 20:34:04.000000 lightning-thunder-0.1.0/thunder/__init__.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.913602 lightning-thunder-0.1.0/thunder/benchmarks/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)   101413 2024-03-11 21:56:35.000000 lightning-thunder-0.1.0/thunder/benchmarks/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    18879 2024-03-20 18:40:16.000000 lightning-thunder-0.1.0/thunder/benchmarks/benchmark_litgpt.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    19856 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/benchmarks/distributed.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     3726 2024-01-16 23:27:29.000000 lightning-thunder-0.1.0/thunder/benchmarks/einsum.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    26229 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/benchmarks/targets.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.917602 lightning-thunder-0.1.0/thunder/clang/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    62876 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/clang/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     2516 2024-02-22 16:40:23.000000 lightning-thunder-0.1.0/thunder/clang/langctx.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    31862 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/common.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.917602 lightning-thunder-0.1.0/thunder/core/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)        0 2023-05-31 07:30:47.000000 lightning-thunder-0.1.0/thunder/core/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    14999 2024-02-27 23:51:52.000000 lightning-thunder-0.1.0/thunder/core/baseutils.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    13335 2024-03-06 21:02:08.000000 lightning-thunder-0.1.0/thunder/core/codeutils.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     2139 2024-03-05 15:18:59.000000 lightning-thunder-0.1.0/thunder/core/compile_data.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     5921 2024-02-22 16:40:23.000000 lightning-thunder-0.1.0/thunder/core/devices.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    17106 2024-02-15 19:05:12.000000 lightning-thunder-0.1.0/thunder/core/dtypes.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)   252847 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/core/interpreter.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    52096 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/core/jit_ext.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     4146 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/core/langctxs.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     7046 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/core/options.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    14058 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/patterns.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)   112701 2024-03-14 22:11:46.000000 lightning-thunder-0.1.0/thunder/core/prims.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      629 2024-01-16 15:15:07.000000 lightning-thunder-0.1.0/thunder/core/profile.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    48752 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/core/proxies.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      731 2023-10-27 14:09:46.000000 lightning-thunder-0.1.0/thunder/core/pytree.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    28140 2024-03-05 15:18:59.000000 lightning-thunder-0.1.0/thunder/core/rematerialization.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.921602 lightning-thunder-0.1.0/thunder/core/script/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)        0 2023-05-31 07:30:47.000000 lightning-thunder-0.1.0/thunder/core/script/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     8642 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/algorithms.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    28000 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/frontend.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    31183 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/graph.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     4333 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/instrumentation.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      833 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/noinline.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.921602 lightning-thunder-0.1.0/thunder/core/script/parse/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      319 2023-11-09 15:26:52.000000 lightning-thunder-0.1.0/thunder/core/script/parse/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     6717 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/parse/disassemble.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    13559 2023-11-30 15:18:58.000000 lightning-thunder-0.1.0/thunder/core/script/parse/functionalize.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     3796 2023-11-09 15:26:52.000000 lightning-thunder-0.1.0/thunder/core/script/parse/instructions.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     9168 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/parse/stack_effect.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    38591 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/passes.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    23974 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/protograph.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     3488 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/protograph_passes.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    20335 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/python_ir.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     1891 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/python_ir_data.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.921602 lightning-thunder-0.1.0/thunder/core/script/values/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      204 2023-11-09 15:26:52.000000 lightning-thunder-0.1.0/thunder/core/script/values/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     6401 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/values/base.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     7471 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/values/composite.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     7777 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/values/materialization.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     7788 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/core/script/values/symbolic.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    25222 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/core/symbol.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    18726 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/core/trace.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    10446 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/core/transform_common.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)   141740 2024-03-20 18:40:16.000000 lightning-thunder-0.1.0/thunder/core/transforms.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    37038 2024-03-14 22:11:46.000000 lightning-thunder-0.1.0/thunder/core/utils.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     7373 2024-03-14 22:11:46.000000 lightning-thunder-0.1.0/thunder/core/vjp_utils.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.921602 lightning-thunder-0.1.0/thunder/cudagraphs/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     5265 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/cudagraphs/__init__.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.921602 lightning-thunder-0.1.0/thunder/distributed/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    16803 2024-03-20 18:37:51.000000 lightning-thunder-0.1.0/thunder/distributed/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     7101 2024-02-15 19:05:12.000000 lightning-thunder-0.1.0/thunder/distributed/bucketing.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     9307 2024-03-05 15:18:59.000000 lightning-thunder-0.1.0/thunder/distributed/checkpoint.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    10906 2024-02-27 23:51:52.000000 lightning-thunder-0.1.0/thunder/distributed/prims.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.921602 lightning-thunder-0.1.0/thunder/distributed/transforms/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      171 2024-02-09 10:31:18.000000 lightning-thunder-0.1.0/thunder/distributed/transforms/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     8449 2024-02-15 19:05:12.000000 lightning-thunder-0.1.0/thunder/distributed/transforms/ddp.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    28416 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/distributed/transforms/fsdp.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    10907 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/distributed/utils.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.921602 lightning-thunder-0.1.0/thunder/examine/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     8681 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/examine/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     5761 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/examine/memory_caculation.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.925602 lightning-thunder-0.1.0/thunder/executors/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      598 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/executors/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     9365 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/executors/apex_entropyex.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     4500 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/executors/cudnn_layernormex.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    22634 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/executors/cudnnex.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    10546 2024-02-15 19:05:12.000000 lightning-thunder-0.1.0/thunder/executors/data_dependent_partition.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     1085 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/executors/nvfuserex.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    73540 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/executors/nvfuserex_impl.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    10861 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/executors/passes.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    13938 2024-03-05 15:18:59.000000 lightning-thunder-0.1.0/thunder/executors/pythonex.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    26538 2024-03-20 18:40:16.000000 lightning-thunder-0.1.0/thunder/executors/sdpaex.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    14969 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/executors/torch_autograd.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     7908 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/executors/torch_compile.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    75141 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/executors/torchex.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    17107 2024-03-11 21:56:35.000000 lightning-thunder-0.1.0/thunder/executors/transformer_engineex.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    19808 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/executors/triton_crossentropy.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)      443 2023-12-07 23:51:48.000000 lightning-thunder-0.1.0/thunder/executors/triton_utils.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     2646 2023-12-12 13:54:43.000000 lightning-thunder-0.1.0/thunder/executors/utils.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.925602 lightning-thunder-0.1.0/thunder/extend/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    12091 2024-03-20 18:40:16.000000 lightning-thunder-0.1.0/thunder/extend/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)    16957 2024-03-11 21:56:35.000000 lightning-thunder-0.1.0/thunder/functional.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.925602 lightning-thunder-0.1.0/thunder/numpy/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     1652 2024-03-14 22:11:46.000000 lightning-thunder-0.1.0/thunder/numpy/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     2554 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/numpy/langctx.py
-drwxrwxr-x   0 jirka     (1000) jirka     (1000)        0 2024-03-20 19:18:02.925602 lightning-thunder-0.1.0/thunder/torch/
--rw-rw-r--   0 jirka     (1000) jirka     (1000)   142813 2024-03-16 20:32:29.000000 lightning-thunder-0.1.0/thunder/torch/__init__.py
--rw-rw-r--   0 jirka     (1000) jirka     (1000)     2494 2024-02-22 16:40:23.000000 lightning-thunder-0.1.0/thunder/torch/langctx.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.951139 lightning-thunder-0.2.0.dev20240404/
+-rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      760 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12478 2024-04-04 12:41:35.951139 lightning-thunder-0.2.0.dev20240404/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9649 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/README.md
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.951139 lightning-thunder-0.2.0.dev20240404/lightning_thunder.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    12478 2024-04-04 12:41:35.000000 lightning-thunder-0.2.0.dev20240404/lightning_thunder.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2438 2024-04-04 12:41:35.000000 lightning-thunder-0.2.0.dev20240404/lightning_thunder.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-04 12:41:35.000000 lightning-thunder-0.2.0.dev20240404/lightning_thunder.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-04 12:41:35.000000 lightning-thunder-0.2.0.dev20240404/lightning_thunder.egg-info/not-zip-safe
+-rw-r--r--   0 runner    (1001) docker     (127)      512 2024-04-04 12:41:35.000000 lightning-thunder-0.2.0.dev20240404/lightning_thunder.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        8 2024-04-04 12:41:35.000000 lightning-thunder-0.2.0.dev20240404/lightning_thunder.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.931139 lightning-thunder-0.2.0.dev20240404/requirements/
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/requirements/base.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       12 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/requirements/devel.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      344 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/requirements/docs.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      117 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/requirements/notebooks.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      864 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/requirements/test.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-04 12:41:35.951139 lightning-thunder-0.2.0.dev20240404/setup.cfg
+-rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.935139 lightning-thunder-0.2.0.dev20240404/thunder/
+-rw-r--r--   0 runner    (1001) docker     (127)      436 2024-04-04 12:41:35.000000 lightning-thunder-0.2.0.dev20240404/thunder/__about__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    33198 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.935139 lightning-thunder-0.2.0.dev20240404/thunder/benchmarks/
+-rw-r--r--   0 runner    (1001) docker     (127)   101338 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/benchmarks/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21165 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/benchmarks/benchmark_litgpt.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/benchmarks/distributed.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3726 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/benchmarks/einsum.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26212 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/benchmarks/targets.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11181 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/benchmarks/test_benchmark_litgpt.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.935139 lightning-thunder-0.2.0.dev20240404/thunder/clang/
+-rw-r--r--   0 runner    (1001) docker     (127)    63665 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/clang/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2516 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/clang/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31687 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.943139 lightning-thunder-0.2.0.dev20240404/thunder/core/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14999 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/baseutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/codeutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/compile_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5921 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/devices.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/dtypes.py
+-rw-r--r--   0 runner    (1001) docker     (127)   256512 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/interpreter.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54102 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/jit_ext.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4146 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/langctxs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/options.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/patterns.py
+-rw-r--r--   0 runner    (1001) docker     (127)   116011 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/prims.py
+-rw-r--r--   0 runner    (1001) docker     (127)      629 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/profile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    48752 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/proxies.py
+-rw-r--r--   0 runner    (1001) docker     (127)      731 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/pytree.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28140 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/rematerialization.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25222 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/symbol.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18726 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/trace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10446 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/transform_common.py
+-rw-r--r--   0 runner    (1001) docker     (127)   140309 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/transforms.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37010 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7663 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/core/vjp_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.943139 lightning-thunder-0.2.0.dev20240404/thunder/cudagraphs/
+-rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/cudagraphs/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.943139 lightning-thunder-0.2.0.dev20240404/thunder/distributed/
+-rw-r--r--   0 runner    (1001) docker     (127)    17549 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/distributed/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/distributed/bucketing.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/distributed/checkpoint.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10906 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/distributed/prims.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.943139 lightning-thunder-0.2.0.dev20240404/thunder/distributed/transforms/
+-rw-r--r--   0 runner    (1001) docker     (127)      171 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/distributed/transforms/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8449 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/distributed/transforms/ddp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28416 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/distributed/transforms/fsdp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/distributed/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.943139 lightning-thunder-0.2.0.dev20240404/thunder/examine/
+-rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/examine/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/examine/memory_caculation.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.947139 lightning-thunder-0.2.0.dev20240404/thunder/executors/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/apex_entropyex.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/cudnn_layernormex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24903 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/cudnnex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/data_dependent_partition.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1085 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/nvfuserex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    74595 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/nvfuserex_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10861 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/passes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13938 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/pythonex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/sdpaex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15020 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/torch_autograd.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7908 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/torch_compile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    76466 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/torchex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17144 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/transformer_engineex.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/triton_crossentropy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/triton_crossentropy_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)      443 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/triton_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/executors/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.947139 lightning-thunder-0.2.0.dev20240404/thunder/extend/
+-rw-r--r--   0 runner    (1001) docker     (127)    11671 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/extend/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16957 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/functional.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.947139 lightning-thunder-0.2.0.dev20240404/thunder/numpy/
+-rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/numpy/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/numpy/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/py.typed
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-04 12:41:35.951139 lightning-thunder-0.2.0.dev20240404/thunder/torch/
+-rw-r--r--   0 runner    (1001) docker     (127)   146468 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/torch/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2494 2024-04-04 12:41:33.000000 lightning-thunder-0.2.0.dev20240404/thunder/torch/langctx.py
```

### Comparing `lightning-thunder-0.1.0/LICENSE` & `lightning-thunder-0.2.0.dev20240404/LICENSE`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/MANIFEST.in` & `lightning-thunder-0.2.0.dev20240404/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/PKG-INFO` & `lightning-thunder-0.2.0.dev20240404/README.md`

 * *Files 24% similar despite different names*

```diff
@@ -1,93 +1,154 @@
-Metadata-Version: 2.1
-Name: lightning-thunder
-Version: 0.1.0
-Summary: Lightning Thunder project.
-Home-page: https://github.com/Lightning-AI/lightning-thunder
-Download-URL: https://github.com/Lightning-AI/lightning-thunder
-Author: Lightning-AI et al
-Author-email: community@lightning.ai
-License: Apache 2.0
-Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
-Project-URL: Documentation, https://lightning-thunder.rtfd.io/en/latest/
-Project-URL: Source Code, https://github.com/Lightning-AI/lightning-thunder
-Keywords: deep learning,AI
-Classifier: Environment :: Console
-Classifier: Natural Language :: English
-Classifier: Development Status :: 3 - Alpha
-Classifier: Intended Audience :: Developers
-Classifier: Topic :: Scientific/Engineering :: Artificial Intelligence
-Classifier: Topic :: Scientific/Engineering :: Information Analysis
-Classifier: License :: OSI Approved :: Apache Software License
-Classifier: Operating System :: OS Independent
-Classifier: Programming Language :: Python :: 3
-Classifier: Programming Language :: Python :: 3.10
-Requires-Python: >=3.10, <3.12
-Description-Content-Type: text/markdown
-License-File: LICENSE
-Requires-Dist: torch>=2.2.0
-Requires-Dist: looseversion==1.3.0
-Requires-Dist: lightning-utilities>=0.7.0
-Requires-Dist: numpy<2,>=1.23.0
-Requires-Dist: igraph>=0.10.4
-Requires-Dist: optree>=0.9.2
-Requires-Dist: opt_einsum>=3.3.0
-Requires-Dist: mpmath<1.4.0
+<div align="center">
+<img alt="Thunder" src="docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+    <br/>
+<br/>
+
+**Make PyTorch models Lightning fast.**
+
+______________________________________________________________________
+
+<p align="center">
+  <a href="https://lightning.ai/">Lightning.ai</a> •
+  <a href="#performance">Performance</a> •
+  <a href="#get-started">Get started</a> •
+  <a href="#install-thunder">Install</a> •
+  <a href="#hello-world">Examples</a> •
+  <a href="#inside-thunder-a-brief-look-at-the-core-features">Inside Thunder</a> •
+  <a href="#get-involved">Get involved!</a> •
+  <a href="#documentation">Documentation</a>
+</p>
 
-![](https://github.com/Lightning-AI/lightning-thunder/raw/0.1.0/docs/source/_static/images/lightning_thunder_lightmode_nobyline.png)
+[![license](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://github.com/Lightning-AI/lightning-thunder/blob/main/LICENSE)
+[![CI testing](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-testing.yml/badge.svg?event=push)](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-testing.yml)
+[![General checks](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-checks.yml/badge.svg?event=push)](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-checks.yml)
+[![Documentation Status](https://readthedocs.org/projects/lightning-thunder/badge/?version=latest)](https://lightning-thunder.readthedocs.io/en/latest/?badge=latest)
+[![pre-commit.ci status](https://results.pre-commit.ci/badge/github/Lightning-AI/lightning-thunder/main.svg)](https://results.pre-commit.ci/latest/github/Lightning-AI/lightning-thunder/main)
+
+</div>
 
 # Welcome to ⚡ Lightning Thunder
 
-Lightning Thunder is a source-to-source compiler for PyTorch.
+**Thunder makes PyTorch models Lightning fast.**
 
-It makes PyTorch programs faster both on single accelerators or in distributed settings.
+Thunder is a source-to-source compiler for PyTorch. It makes PyTorch programs faster by combining and using different hardware executors at once (for instance, [nvFuser](https://github.com/NVIDIA/Fuser), [torch.compile](https://pytorch.org/docs/stable/torch.compiler.html), [cuDNN](https://developer.nvidia.com/cudnn), and [TransformerEngine FP8](https://github.com/NVIDIA/TransformerEngine)).
 
+It supports both single and multi-GPU configurations.
 Thunder aims to be usable, understandable, and extensible.
 
-## Performance
+&#160;
+
+> \[!Note\]
+> Lightning Thunder is in alpha. Feel free to get involved, but expect a few bumps along the way.
+
+&#160;
+
+## Single-GPU performance
+
+Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
+
+<div align="center">
+<img alt="Thunder" src="docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+</div>
 
-Thunder can achieve significant speedups over standard PyTorch eager code, through the compounding effects of optimizations and the use of best in class executors. Here is an example of the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
+As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
-![](https://github.com/Lightning-AI/lightning-thunder/raw/0.1.0/docs/source/_static/images/training_throughput_single.png)
+&#160;
 
-We achieve a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
+## Multi-GPU performance
 
-Thunder supports distributed strategies like DDP and FSDP (ZeRO2 and ZeRO3). Here is the normalized throughput measured for Llama 2 7B (this time without FP8 mixed precision, support for FSDP is underway).
+Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
-![](https://github.com/Lightning-AI/lightning-thunder/raw/0.1.0/docs/source/_static/images/normalized_training_throughput_zero2.png)
+<div align="center">
+<img alt="Thunder" src="docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+</div>
 
-**NOTE: Lightning Thunder is alpha.** Feel free to get involved, expect a few bumps along the way.
+&#160;
 
-## Start with Thunder
+## Get started
 
-Try Thunder without installing by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
+The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
+
+&#160;
 
 ## Install Thunder
 
-Install [nvFuser](https://github.com/NVIDIA/Fuser) nightly, which will also install the matching PyTorch nightly:
+To use Thunder on your local machine, first install [nvFuser](https://github.com/NVIDIA/Fuser) nightly and PyTorch nightly together as follows:
 
 ```bash
+# install nvFuser which installs the matching nightly PyTorch
 pip install --pre 'nvfuser-cu121[torch]' --extra-index-url https://pypi.nvidia.com
 ```
 
-Install Thunder:
+Then, install Thunder as follows:
+
+```
+# install thunder
+pip install lightning-thunder
+```
+
+<details>
+  <summary>Advanced install options</summary>
+    <!-- following section will be skipped from PyPI description -->
+
+&#160;
+
+### Install from main
+
+Alternatively, you can install the latest version of Thunder directly from this GitHub repository as follows:
+
+```
+# 1) Install nvFuser and PyTorch nightly dependencies:
+pip install --pre 'nvfuser-cu121[torch]' --extra-index-url https://pypi.nvidia.com
+```
 
 ```bash
+# 2) Install Thunder itself
 pip install git+https://github.com/Lightning-AI/lightning-thunder.git
 ```
 
-or install from the local repo:
+&#160;
+
+### Install to tinker and contribute
+
+If you are interested in tinkering with and contributing to Thunder, we recommend cloning the Thunder repository and installing it in pip's editable mode:
+
+```bash
+git clone https://github.com/Lightning-AI/lightning-thunder.git
+cd lightning-thunder
+pip install -e .
+```
+
+&#160;
+
+### Develop and run tests
+
+After cloning the lightning-thunder repository and installing it as an editable package as explained above, ou can set up your environment for developing Thunder by installing the development requirements:
+
+```bash
+pip install -r requirements/devel.txt
+```
+
+Now you run tests:
 
 ```bash
-pip install .
+pytest thunder/tests
 ```
 
+Thunder is very thoroughly tested, so expect this to take a while.
+
+</details>
+<!-- end skipping PyPI description -->
+
+&#160;
+
 ## Hello World
 
-Here is a simple example of how Thunder lets you compile and run PyTorch code:
+Below is a simple example of how Thunder allows you to compile and run PyTorch code:
 
 ```python
 import torch
 import thunder
 
 
 def foo(a, b):
@@ -107,98 +168,76 @@
 # tensor(
 #  [[4, 4]
 #   [4, 4]])
 ```
 
 The compiled function `jfoo` takes and returns PyTorch tensors, just like the original function, so modules and functions compiled by Thunder can be used as part of larger PyTorch programs.
 
-## Running training
+&#160;
 
-Thunder is in its early stages, it should not be used for production runs yet.
+## Train models
 
-However, it can already deliver outstanding performance on models supported by [LitGPT](https://github.com/Lightning-AI/lit-gpt), such as Mistral, Llama2, Gemma, Falcon, and derivatives.
+Thunder is in its early stages and should not be used for production runs yet.
 
-Run training loop for Llama, single-GPU:
+However, it can already deliver outstanding performance for pretraining and finetuning LLMs supported by [LitGPT](https://github.com/Lightning-AI/lit-gpt), such as Mistral, Llama 2, Gemma, Falcon, and others.
 
-```bash
-python examples/lit-gpt/train.py
-```
-
-Run training loop for Llama, multi-GPU, using FSDP:
-
-```bash
-python examples/lit-gpt/train_fsdp.py
-```
+Check out [the LitGPT integration](https://github.com/Lightning-AI/litgpt/tree/main/extensions/thunder) to learn about running LitGPT and Thunder together.
 
-See [README.md](examples/lit-gpt/README.md) for details on running LitGPT with Thunder.
+&#160;
 
-## What's in the box
+## Inside Thunder: A brief look at the core features
 
-Given a python callable or PyTorch module, Thunder can generate an optimized program that:
+Given a Python callable or PyTorch module, Thunder can generate an optimized program that:
 
 - Computes its forward and backward passes
 - Coalesces operations into efficient fusion regions
 - Dispatches computations to optimized kernels
 - Distributes computations optimally across machines
 
 To do so, Thunder ships with:
 
 - A JIT for acquiring Python programs targeting PyTorch and custom operations
-- A multi-level IR to represent operations as a trace of a reduced op-set
-- An extensible set of transformations on the trace, such as `grad`, fusions, distributed (like `ddp`, `fsdp`), functional (like `vmap`, `vjp`, `jvp`)
+- A multi-level intermediate representation (IR) to represent operations as a trace of a reduced operation set
+- An extensible set of transformations on the trace of a computational graph, such as `grad`, fusions, distributed (like `ddp`, `fsdp`), functional (like `vmap`, `vjp`, `jvp`)
 - A way to dispatch operations to an extensible collection of executors
 
 Thunder is written entirely in Python. Even its trace is represented as valid Python at all stages of transformation. This allows unprecedented levels of introspection and extensibility.
 
-Thunder doesn't generate code for accelerators directly. It acquires and transforms user programs so that it's possible to optimally select or generate device code using fast executors like:
+Thunder doesn't generate code for accelerators, such as GPUs, directly. It acquires and transforms user programs so that it's possible to optimally select or generate device code using fast executors like:
 
 - [torch.compile](https://pytorch.org/get-started/pytorch-2.0/)
 - [nvFuser](https://github.com/NVIDIA/Fuser)
 - [cuDNN](https://developer.nvidia.com/cudnn)
 - [Apex](https://github.com/NVIDIA/apex)
 - [TransformerEngine](https://github.com/NVIDIA/TransformerEngine)
 - [PyTorch eager](https://github.com/pytorch/pytorch)
-- custom kernels, including those written with [OpenAI Triton](https://github.com/openai/triton)
+- Custom CUDA kernels through [PyCUDA](https://documen.tician.de/pycuda/tutorial.html#interoperability-with-other-libraries-using-the-cuda-array-interface), [Numba](https://numba.readthedocs.io/en/stable/cuda/kernels.html), [CuPy](https://docs.cupy.dev/en/stable/user_guide/kernel.html)
+- Custom kernels written in [OpenAI Triton](https://github.com/openai/triton)
 
 Modules and functions compiled with Thunder fully interoperate with vanilla PyTorch and support PyTorch's autograd. Also, Thunder works alongside torch.compile to leverage its state-of-the-art optimizations.
 
-## Build the documentation
+&#160;
+
+## Documentation
 
 Docs are currently not hosted publicly. However you can build them locally really quickly:
 
 ```bash
 make docs
 ```
 
 and point your browser to the generated docs at `docs/build/index.html`.
 
-## Develop and run tests
+&#160;
 
-You can set up your environment for developing Thunder by installing the development requirements:
+## Get involved!
 
-```bash
-pip install -r requirements/devel.txt
-```
-
-Install Thunder as an editable package (optional):
-
-```bash
-pip install -e .
-```
-
-Now you run tests:
+We appreciate your feedback and contributions. If you have feature requests, questions, or want to contribute code or config files, please don't hesitate to use the [GitHub Issue](https://github.com/Lightning-AI/lightning-thunder/issues) tracker.
 
-```bash
-pytest thunder/tests
-```
+We welcome all individual contributors, regardless of their level of experience or hardware. Your contributions are valuable, and we are excited to see what you can accomplish in this collaborative and supportive environment.
 
-Thunder is very thoroughly tested, so expect this to take a while.
+&#160;
 
 ## License
 
 Lightning Thunder is released under the [Apache 2.0](https://www.apache.org/licenses/LICENSE-2.0) license.
-See LICENSE file for details.
-
-[![CI testing](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-testing.yml/badge.svg?event=push)](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-testing.yml)
-[![General checks](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-checks.yml/badge.svg?event=push)](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-checks.yml)
-[![Documentation Status](https://readthedocs.org/projects/lightning-thunder/badge/?version=latest)](https://lightning-thunder.readthedocs.io/en/latest/?badge=latest)
-[![pre-commit.ci status](https://results.pre-commit.ci/badge/github/Lightning-AI/lightning-thunder/main.svg?badge_token=mqheL1-cTn-280Vx4cJUdg)](https://results.pre-commit.ci/latest/github/Lightning-AI/lightning-thunder/main?badge_token=mqheL1-cTn-280Vx4cJUdg)
+See the [LICENSE](LICENSE) file for details.
```

### Comparing `lightning-thunder-0.1.0/setup.py` & `lightning-thunder-0.2.0.dev20240404/setup.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,31 +1,63 @@
 #!/usr/bin/env python
 import glob
 import os
+import re
 from importlib.util import module_from_spec, spec_from_file_location
 from pathlib import Path
 
 from pkg_resources import parse_requirements
 from setuptools import find_packages, setup
 
 
 _PATH_ROOT = os.path.dirname(__file__)
 _PATH_REQUIRES = os.path.join(_PATH_ROOT, "requirements")
+# check if os env. variable is set to convert version to nightly
+_CONVERT_VERSION = int(os.environ.get("CONVERT_VERSION2NIGHTLY", 0))
 
 
 def _load_py_module(fname, pkg="thunder"):
     spec = spec_from_file_location(os.path.join(pkg, fname), os.path.join(_PATH_ROOT, pkg, fname))
     py = module_from_spec(spec)
     spec.loader.exec_module(py)
     return py
 
 
+def convert_version2nightly(about_file: str = "thunder/__about__.py") -> None:
+    """Load the actual version and convert it to the nightly version."""
+    from datetime import datetime
+
+    # load the about file
+    with open(about_file) as fo:
+        lines = fo.readlines()
+    idx = None
+    # find the line with version
+    for i, ln in enumerate(lines):
+        if ln.startswith("__version__"):
+            idx = i
+            break
+    if idx is None:
+        raise ValueError("The version is not found in the `__about__.py` file.")
+    # parse the version from variable assignment
+    version = lines[idx].split("=")[1].strip().strip('"')
+    # parse X.Y.Z version and prune any suffix
+    vers = re.match(r"(\d+)\.(\d+)\.(\d+).*", version)
+    # create timestamp  YYYYMMDD
+    timestamp = datetime.now().strftime("%Y%m%d")
+    version = f"{'.'.join(vers.groups())}.dev{timestamp}"
+    # print the new version
+    lines[idx] = f'__version__ = "{version}"\n'
+    # dump updated lines
+    with open(about_file, "w") as fo:
+        fo.writelines(lines)
+
+
 def _load_requirements(path_dir: str, file_name: str = "requirements.txt") -> list:
     reqs = parse_requirements(open(os.path.join(path_dir, file_name)).readlines())
-    return list(map(str, reqs))
+    return [r for r in list(map(str, reqs)) if "@" not in r]
 
 
 def _prepare_extras(
     requirements_dir: str = _PATH_REQUIRES, skip_files: tuple = ("base.txt", "devel.txt", "docs.txt")
 ) -> dict:
     # https://setuptools.readthedocs.io/en/latest/setuptools.html#declaring-extras
     # Define package extras. These are only installed if you specify them.
@@ -52,14 +84,17 @@
     github_source_url = os.path.join(homepage, "raw", version)
     # replace relative repository path to absolute link to the release
     #  do not replace all "docs" as in the readme we replace some other sources with particular path to docs
     text = text.replace("docs/source/_static/", f"{os.path.join(github_source_url, 'docs/source/_static/')}")
     return text
 
 
+if _CONVERT_VERSION:
+    convert_version2nightly()
+
 about = _load_py_module("__about__.py")
 
 # https://packaging.python.org/discussions/install-requires-vs-requirements /
 # keep the meta-data here for simplicity in reading this file. it's not obvious
 # what happens and to non-engineers they won't know to look in init.
 setup(
     name="lightning-thunder",
```

### Comparing `lightning-thunder-0.1.0/thunder/__init__.py` & `lightning-thunder-0.2.0.dev20240404/thunder/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -40,15 +40,15 @@
     transform_for_execution,
 )
 import thunder.extend as extend
 from thunder.extend import Executor, add_default_executor
 from thunder.core.compile_data import compile_data_and_stats
 from thunder.core.langctxs import LanguageContext
 import thunder.core.langctxs as langctxs
-from thunder.core.baseutils import run_once
+from thunder.core.baseutils import run_once, check
 from thunder.core.proxies import (
     Proxy,
     TensorProxy,
     NumberProxy,
     StringProxy,
     IntegerProxy,
     FloatProxy,
@@ -345,14 +345,19 @@
         additional_transforms = []
 
     # TODO: verify that tutorials don't have false positives and enable warning by default
     # # Make sharp_edges == warn default if not supplied and if in the general jit
     # if interpretation is INTERPRETATION_OPTIONS.TRANSLATE_PYTHON and sharp_edges is None:
     #     sharp_edges = SHARP_EDGES_OPTIONS.WARN
 
+    executor_lookasides = {}
+    for ex in executors or []:
+        # TODO: sharp edge if lookasides are shadowed?
+        executor_lookasides.update(ex._lookasides)
+
     # TODO RC1 Refine the compile data option to remove unused options
     cd = CompileData(
         fn=fn,
         langctx=langctx,
         executors_list=executors,
         cache_option=cache,
         sharp_edges=sharp_edges,
@@ -360,14 +365,15 @@
         use_cudagraphs=False,
         use_torch_compile=False,
         disable_torch_autograd_support=disable_torch_autograd,
         use_rematerialization=False,
         only_execute_prims=False,
         disable_preprocessing=True,
         compile_options=compile_options,
+        executor_lookasides=executor_lookasides,
     )
     cs = CompileStats()
 
     @_with_cache_info_ctx
     def get_computation_and_inputs(*args, **kwargs):
         # set up a record of things in the current environment that impact caching / prologues
         # this could be replaced by the respective querying in the prologues
@@ -553,47 +559,59 @@
                 tensor_cls = (pytorch.Tensor, TensorProxy)
                 requires_grad = any(isinstance(arg, tensor_cls) and arg.requires_grad for arg in inps)
 
                 if requires_grad:
                     # thunder_backward may recursively call compile and wraps the result in a
                     # torch.autograd.Function to support embedding of Thunder-compiled
                     # functions in torch's Autograd
+
+                    # Currently split_forward_backward also includes
+                    # transform_for_execution and various sorting of symbols,
+                    # applying transform_for_execution after this would be
+                    # breaking the order of operations
                     computation_trc, backward_trc = split_forward_backward(computation_trc, cd, cs, *inps)
                     # Note computation_trc and backward_trc have been appended to cs.last_(backward_)traces
                     # by split_forward_backward
+                    extraces = cs.last_traces
+                    check(
+                        not additional_transforms,
+                        lambda: "Specifying additional_transforms is not supported with PyTorch Autograd integration",
+                    )
+
+            if backward_trc is None:
+                cs.last_computation_transformation_start = time.time_ns()
+
+                ## EPILOGUE and TRANSFORMS should not mix...
+                # applies transforms
+                for transform in additional_transforms:
+                    computation_trc = transform(computation_trc, executors_list=cd.executors_list)
+                    computation_traces.append(computation_trc)
+
+                with langctxs.langctx(cd.langctx):
+                    extraces = transform_for_execution(
+                        computation_trc,
+                        executors_list=cd.executors_list,
+                    )
+                computation_trc = extraces[-1]
+                cs.last_computation_transformation_stop = time.time_ns()
 
-            cs.last_computation_transformation_start = time.time_ns()
-
-            ## EPILOGUE and TRANSFORMS should not mix...
-            # applies transforms
-            for transform in additional_transforms:
-                computation_trc = transform(computation_trc, executors_list=cd.executors_list)
-                computation_traces.append(computation_trc)
-
-            with langctxs.langctx(cd.langctx):
-                extraces = transform_for_execution(
-                    computation_trc,
-                    executors_list=cd.executors_list,
-                )
-            extrace = extraces[-1]
-            comp = extrace.python_callable()
+            comp = computation_trc.python_callable()
 
             if backward_trc is not None:
                 backward_fn = backward_trc.python_callable()
             else:
                 backward_fn = None
 
             # TODO RC1 Update the cache
             cache_entry = CacheEntry(
                 pro, protraces, comp, extraces, epilogue, epilogue_traces, backward_fn, backward_traces
             )
             if cd.cache_option is not CACHE_OPTIONS.NO_CACHING:
                 cs.interpreter_cache.append(cache_entry)
 
-            cs.last_computation_transformation_stop = time.time_ns()
             cs.last_traces += extraces
             cs.last_prologue_traces = [prologue_trc] + protraces
             cs.last_prologue = pro
 
         return cache_entry, inps, pro_to_epi
 
     cd.get_computation_and_inputs = get_computation_and_inputs
@@ -716,15 +734,15 @@
     if cs is None:
         raise TypeError(f"{fn} doesn't seem to be a thunder compiled function.")
     if cs.last_traces is None:
         raise TypeError(f"{fn} doesn't seem to have been called yet.")
     return cs.last_traces
 
 
-def last_backward_traces(fn) -> TraceCtx:
+def last_backward_traces(fn) -> list[TraceCtx]:
     """Obtains the list of backward traces that have been produced for the last run of the function and the selected prologue."""
     cs = compile_stats(fn)
     if cs is None:
         raise TypeError(f"{fn} doesn't seem to be a thunder compiled function.")
     if cs.last_backward_traces is None:
         raise TypeError(f"{fn} doesn't seem to have been called yet.")
     return cs.last_backward_traces
```

### Comparing `lightning-thunder-0.1.0/thunder/benchmarks/__init__.py` & `lightning-thunder-0.2.0.dev20240404/thunder/benchmarks/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -20,17 +20,17 @@
 
 import thunder
 import thunder.torch as ltorch
 import thunder.core.dtypes as dtypes
 import thunder.core.devices as Devices
 from thunder.core.transforms import grad, clear_grads, populate_grads
 import thunder.executors as executors
-from thunder.tests import nanogpt_model, hf_bart_self_attn, lit_gpt_model
+from thunder.tests import nanogpt_model, hf_bart_self_attn, litgpt_model
 from thunder.tests.make_tensor import make_tensor, make_tensor_like
-from thunder.tests.lit_gpt_model import Config as LitGPTConfig
+from thunder.tests.litgpt_model import Config as LitGPTConfig
 
 # List of all benchmarks
 benchmarks: list = []
 
 
 # Prints the benchmarks in alphabetical order (either by classname or the benchmark's "name" attribute)
 def list_benchmarks(use_classname: bool = True) -> None:
@@ -934,22 +934,21 @@
     return thunder.jit(fn, executors=executors_list, disable_torch_autograd=True)
 
 
 # TODO Add grad support
 def default_thunder_cudnn_executor(fn: Callable) -> Callable:
     torch.backends.cuda.matmul.allow_tf32 = True
 
-    CUDNN_AVAILABLE = package_available("cudnn")
-    assert CUDNN_AVAILABLE, "Trying to benchmark with the thunder+cudnn executor, but cudnn is not available"
+    assert package_available("cudnn"), "Trying to benchmark with the thunder+cudnn executor, but cudnn is not available"
 
     from thunder.executors.cudnnex import register_cudnnex
 
     register_cudnnex(add_to_default_executors=False)
 
-    executors_list = ("cudnn", executors.NVFUSER, executors.TORCH)
+    # executors_list = ("cudnn", executors.NVFUSER, executors.TORCH)
     return thunder.jit(fn, executors=executors, disable_torch_autograd=True)
 
 
 # TODO Add grad support
 def default_thunder_cudagraphs_executor(fn: Callable) -> Callable:
     torch.backends.cuda.matmul.allow_tf32 = True
 
@@ -1871,15 +1870,15 @@
         return gpt_mlp
 
 
 class LlamaMLPBenchmark(Benchmark, metaclass=UserFacingBenchmarkMeta):
     _args = (
         BenchmarkArg(
             name="config",
-            description="The Lit-GPT config to use. Default is 'Llama-2-7b-hf'. See the lit_gpt_model.py for details.",
+            description="The Lit-GPT config to use. Default is 'Llama-2-7b-hf'. See the litgpt_model.py for details.",
         ),
         BenchmarkArg(
             name="batchdims",
             description="The shape (Sequence[int]) of input batch dimensions. The input will have innermost dimensions of (config.seq_len, config.n_embd). Default is (16,).",
         ),
         BenchmarkArg(
             name="device",
@@ -1931,26 +1930,26 @@
         make = partial(make_tensor, device=self.device, dtype=self.tdtype, requires_grad=self.requires_grad)
         shape = self.batchdims + (self.config.block_size, self.config.n_embd)
 
         return (make(shape),), {}
 
     def fn(self) -> Callable:
         module = (
-            lit_gpt_model.LLaMAMLP(self.config)
+            litgpt_model.LLaMAMLP(self.config)
             .to(device=self.device, dtype=self.tdtype)
             .requires_grad_(self.requires_grad)
         )
         return module
 
 
 class LitGPTCausalSelfAttentionBenchmark(Benchmark, metaclass=UserFacingBenchmarkMeta):
     _args = (
         BenchmarkArg(
             name="config",
-            description="The Lit-GPT config to use. Default is 'Llama-2-7b-hf'. See the lit_gpt_model.py for details.",
+            description="The Lit-GPT config to use. Default is 'Llama-2-7b-hf'. See the litgpt_model.py for details.",
         ),
         BenchmarkArg(
             name="batchdims",
             description="The shape (Sequence[int]) of input batch dimensions. The input will have innermost dimensions of (config.seq_len, config.n_embd). Default is (16,).",
         ),
         BenchmarkArg(
             name="device",
@@ -2001,15 +2000,15 @@
         sin = make((self.config.block_size, self.config.rope_n_elem), requires_grad=False)
         mask = None
         input_pos = None
         return (x, cos, sin, mask, input_pos), {}
 
     def fn(self) -> Callable:
         module = (
-            lit_gpt_model.CausalSelfAttention(self.config)
+            litgpt_model.CausalSelfAttention(self.config)
             .to(device=self.device, dtype=self.tdtype)
             .requires_grad_(self.requires_grad)
         )
         return module
 
 
 class LlamaRMSNormBenchmark(Benchmark, metaclass=UserFacingBenchmarkMeta):
@@ -2082,15 +2081,15 @@
     def make_batch(self) -> tuple[list, dict]:
         make = partial(make_tensor, device=self.device, dtype=self.tdtype, requires_grad=self.requires_grad)
         shape = (self.size,)
         return (make(shape),), {}
 
     def fn(self) -> Callable:
         module = (
-            lit_gpt_model.RMSNorm(self.size, self.dim, self.eps)
+            litgpt_model.RMSNorm(self.size, self.dim, self.eps)
             .to(device=self.device, dtype=self.tdtype)
             .requires_grad_(self.requires_grad)
         )
         return module
 
 
 class LitGPTBenchmark(Benchmark, metaclass=UserFacingBenchmarkMeta):
@@ -2164,15 +2163,15 @@
         shape = self.batchdims + (self.config.block_size,)
 
         x = make(shape)
         return (x,), {}
 
     def fn(self) -> Callable:
         gpt = (
-            lit_gpt_model.GPT(self.config)
+            litgpt_model.GPT(self.config)
             .to(device=self.device, dtype=self.model_tdtype)
             .requires_grad_(self.requires_grad)
         )
         return gpt
 
     def postprocess_for_backward(self, output: torch.Tensor) -> torch.Tensor | None:
         if not self.requires_grad:
@@ -2195,15 +2194,15 @@
 
                 self.fused_apply_rotary_pos_emb_cached = fused_apply_rotary_pos_emb_cached
             except ImportError:
                 pass
 
         super().__init__()
         self.config = config
-        self.apply_rope = lit_gpt_model.apply_rope
+        self.apply_rope = litgpt_model.apply_rope
         self.use_apex = use_apex
 
     def forward(
         self,
         qkv: torch.Tensor,
         cos: torch.Tensor,
         sin: torch.Tensor,
@@ -2250,15 +2249,15 @@
         return q, k, v
 
 
 class LlamaQKVSplitRopeBenchmark(Benchmark, metaclass=UserFacingBenchmarkMeta):
     _args = (
         BenchmarkArg(
             name="config",
-            description="The Lit-GPT config to use. Default is 'Llama-2-7b-hf'. See the lit_gpt_model.py for details.",
+            description="The Lit-GPT config to use. Default is 'Llama-2-7b-hf'. See the litgpt_model.py for details.",
         ),
         BenchmarkArg(
             name="batchdims",
             description="The shape (Sequence[int]) of input batch dimensions. The input will have innermost dimensions of (config.block_size, config.n_embd). Default is (16,).",
         ),
         BenchmarkArg(
             name="device",
@@ -2606,15 +2605,15 @@
         self,
         config: str = "Llama-2-7b-hf",
         batchdims: Sequence[int] = (16,),
         device: str = "cuda",
         dtype: dtypes.dtype = thunder.bfloat16,
         requires_grad: bool = True,
     ) -> None:
-        from thunder.tests.lit_gpt_model import Config
+        from thunder.tests.litgpt_model import Config
 
         litgptconfig = Config.from_name(config) if not isinstance(config, Config) else config
         nanogptconfig = NanoGPTConfig(
             n_head=litgptconfig.n_head,
             seq_len=litgptconfig.block_size,
             n_embd=litgptconfig.n_embd,
         )
@@ -2789,30 +2788,28 @@
 
         # Performs torch dtype conversions
         self.tdtype: torch.dtype = ltorch.to_torch_dtype(self.dtype)
 
         # Sets required benchmark parameters
         self.devices: list[str] = [device]
 
-        self.cos, self.sin = lit_gpt_model.build_rope_cache(
+        self.cos, self.sin = litgpt_model.build_rope_cache(
             seq_len=seq_length, n_elem=self.config.rope_n_elem, device=self.device
         )
 
     def make_batch(self) -> tuple[list, dict]:
         make = partial(make_tensor, device=self.device, dtype=self.tdtype, requires_grad=self.requires_grad)
 
         a = make((self.sequences, self.seq_length, self.config.n_embd))
 
         return (a, self.cos, self.sin), {}
 
     def fn(self) -> Callable:
         model = (
-            lit_gpt_model.Block(self.config)
-            .to(device=self.device, dtype=self.tdtype)
-            .requires_grad_(self.requires_grad)
+            litgpt_model.Block(self.config).to(device=self.device, dtype=self.tdtype).requires_grad_(self.requires_grad)
         )
         return model
 
 
 # TODO Add descriptions to the executors when listed, and list them alphabetically
 # TODO Allow querying benchmark for details
 # TODO Allow specifying benchmark arguments
```

### Comparing `lightning-thunder-0.1.0/thunder/benchmarks/benchmark_litgpt.py` & `lightning-thunder-0.2.0.dev20240404/thunder/benchmarks/benchmark_litgpt.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,25 +1,22 @@
 import os
 import time
 
 import torch
 import functools
 from torch.utils.data import DataLoader, IterableDataset
 import torch.distributed as torch_dist
+from torch.distributed.device_mesh import init_device_mesh
 
 import thunder
-from thunder.tests.lit_gpt_model import Config, GPT, Block
+from thunder.tests.litgpt_model import Config, GPT, Block
 
-try:
-    from lightning.fabric.utilities.throughput import measure_flops
+from lightning.fabric.utilities.throughput import measure_flops
+from lightning.fabric.utilities import Throughput
 
-    # from lightning.fabric.utilities import Throughput
-    LIGHTNING_AVAILABLE = True
-except:
-    LIGHTNING_AVAILABLE = False
 
 world_size = int(os.environ.get("WORLD_SIZE", 1))
 local_rank = int(os.environ.get("LOCAL_RANK", 0))
 global_rank = int(os.environ.get("RANK", 0))
 if world_size > 1:
     torch_dist.init_process_group(backend="nccl")
     pg = torch_dist.distributed_c10d._get_default_group()
@@ -47,14 +44,16 @@
         distributed_mode: str = "none",
         micro_batch_size: int = 1,
         global_batch_size: int | None = None,
         model_name: str = "Llama-2-7b-hf",
         shard_mode: str = "zero2",
         bucketing_mode: str = "none",
         sharding_size: int | None = None,
+        ddp_bucket_size: float = 256.0,
+        fsdp_bucket_params: float | None = None,
         n_layers: int | None = None,
         profiler_start: int = 15,
         profiler_stop: int = 15,
     ):
         seed = 1337
         torch.manual_seed(seed)
         torch.cuda.manual_seed(seed)
@@ -74,15 +73,54 @@
         self.config = Config.from_name(self.model_name)
         self.compile = compile
         self.dynamic = dynamic
         self.distributed_mode = distributed_mode
         self.shard_mode = shard_mode
         self.bucketing_mode = bucketing_mode
         self.sharding_size = sharding_size
+        self.ddp_bucket_size = ddp_bucket_size
+        self.fsdp_bucket_params = fsdp_bucket_params
         self.micro_batch_size = micro_batch_size
+
+        # Clarify benchmark assumptions
+        if self.sharding_size is not None:
+            assert (
+                "thunder" not in self.compile
+            ), "Hybrid Sharding (FSDP/DP) using --sharding_size is not yet supported for Thunder. Coming soon."
+
+            assert self.shard_mode in [
+                "hybrid_zero2",
+                "hybrid_zero3",
+            ], "Sharding Size is only used with Hybrid FSDP/DP style parallelism."
+
+            assert (
+                world_size % self.sharding_size == 0
+            ), f"World size {world_size} is not divisible by the sharding size {self.sharding_size}"
+
+        if self.bucketing_mode != "none" and self.distributed_mode != "fsdp":
+            print(
+                f"[WARNING] --bucketing_mode {self.bucketing_mode} will be ignored as \
+             it is only used for FSDP style parallelism but running {self.distributed_mode}"
+            )
+
+        assert not (
+            "thunder" in self.compile and self.bucketing_mode == "size"
+        ), "'size' bucketing mode is not supported for Thunder. Please use 'none' or 'block'."
+
+        if self.fsdp_bucket_params is not None:
+            if self.distributed_mode != "fsdp":
+                print(
+                    f"[WARNING] Found --fsdp_bucket_params but Distributed mode is {self.distributed_mode}. Will be ignored"
+                )
+
+            if self.bucketing_mode != "size":
+                print(
+                    f"[WARNING] Bucketing mode is set to {self.bucketing_mode}. --fsdp_bucket_params will be ignored."
+                )
+
         if global_batch_size is not None:
             self.global_batch_size = global_batch_size
         else:
             self.global_batch_size = (
                 self.micro_batch_size * world_size if world_size is not None else self.micro_batch_size
             )
         assert (
@@ -105,15 +143,18 @@
         self.profiler_start = profiler_start
         self.profiler_stop = profiler_stop
 
         if n_layers is not None:
             self.config.n_layer = n_layers
 
         # Initialize the model
+        t0 = time.perf_counter()
+        print(f"Loading model with {self.config.__dict__}")
         self.model = self.init_model()
+        print(f"Time to instantiate model: {time.perf_counter() - t0:.02f} seconds.")
 
         # Setup the distributed algorithm choices
         if self.distributed_mode != "none":
             self.model = self.setup_distributed()
 
         # Initialize the optimizer after the model is sharded if using FSDP
         self.optimizer = configure_optimizers(
@@ -134,35 +175,31 @@
                 "average_iter_time": None,
                 "model_flops": None,
                 "model_flop_per_sec": None,
                 "tokens_per_sec": None,
             }
 
     def init_model(self):
-        print(f"Loading model with {self.config.__dict__}")
         init_device = torch.device("meta") if self.distributed_mode == "fsdp" else self.device
-        t0 = time.perf_counter()
         with init_device:
             model = GPT(self.config)
-            model.to(dtype=torch.bfloat16)
-        print(f"Time to instantiate model: {time.perf_counter() - t0:.02f} seconds.")
-
+        model.to(dtype=torch.bfloat16)
         return model
 
     def setup_distributed(self):
         # Distributed Setup
         # TODO: Change compiler call names
         if "thunder" in self.compile:
             if self.distributed_mode == "ddp":
                 from thunder.distributed import ddp
 
                 model = ddp(
                     self.model,
                     broadcast_from=0,
-                    bucket_size_in_mb=256.0,
+                    bucket_size_in_mb=self.ddp_bucket_size,
                 )
             elif self.distributed_mode == "fsdp":
                 from thunder.distributed import fsdp, FSDPType, FSDPBucketingStrategy
 
                 sharding_strategy = {"zero2": FSDPType.ZERO2, "zero3": FSDPType.ZERO3}[self.shard_mode]
                 bucketing_strategy = {"none": FSDPBucketingStrategy.NONE, "block": FSDPBucketingStrategy.BLOCK}[
                     self.bucketing_mode
@@ -174,34 +211,52 @@
                     bucketing_strategy=bucketing_strategy,
                 )
         else:
             if self.distributed_mode == "ddp":
                 model = torch.nn.parallel.DistributedDataParallel(
                     self.model,
                     device_ids=[local_rank],
-                    bucket_cap_mb=256.0,
+                    bucket_cap_mb=self.ddp_bucket_size,
                 )
             elif self.distributed_mode == "fsdp":
                 from torch.distributed.fsdp import FullyShardedDataParallel as FSDP, ShardingStrategy
-                from torch.distributed.fsdp.wrap import transformer_auto_wrap_policy
+                from torch.distributed.fsdp.wrap import transformer_auto_wrap_policy, size_based_auto_wrap_policy
+
+                mesh = None
+                if self.sharding_size is not None:
+                    mesh = init_device_mesh("cuda", (int(world_size / self.sharding_size), self.sharding_size))
 
                 litgpt_auto_wrap_policy = functools.partial(transformer_auto_wrap_policy, transformer_layer_cls={Block})
+                size_auto_wrap_policy = functools.partial(
+                    size_based_auto_wrap_policy, min_num_params=self.fsdp_bucket_params
+                )
                 zero_bucket_wrap_policy = lambda module, recurse, nonwrapped_numel: nonwrapped_numel >= 0
+
+                custom_wrap_policy = {
+                    "block": litgpt_auto_wrap_policy,
+                    "size": size_auto_wrap_policy,
+                    "none": zero_bucket_wrap_policy,
+                }[self.bucketing_mode]
+
                 sharding_strategy: ShardingStrategy = {
                     "zero2": ShardingStrategy.SHARD_GRAD_OP,
                     "zero3": ShardingStrategy.FULL_SHARD,
+                    "hybrid_zero2": ShardingStrategy._HYBRID_SHARD_ZERO2,
+                    "hybrid_zero3": ShardingStrategy.HYBRID_SHARD,
                 }[self.shard_mode]
+
                 # AssertionError: Dynamo only supports FSDP with use_orig_params=True
                 torch.cuda.set_device(local_rank)
                 model = FSDP(
                     self.model,
                     sharding_strategy=sharding_strategy,
-                    auto_wrap_policy=litgpt_auto_wrap_policy,
+                    auto_wrap_policy=custom_wrap_policy,
                     device_id=local_rank,
                     use_orig_params=True,
+                    device_mesh=mesh,
                 )
         return model
 
     def setup_compile(self):
         if self.compile == "inductor":
             # model = torch.compile(self.model, fullgraph=True, mode="reduce-overhead")
             print("Resetting cache size for torch.compile")
@@ -239,40 +294,46 @@
     def setup_dummy_dataloader(self):
         def pad_collate(batch):
             x, y = zip(*batch)
             x_padded = torch.nn.utils.rnn.pad_sequence(x, batch_first=True, padding_value=0)
             y_padded = torch.nn.utils.rnn.pad_sequence(y, batch_first=True, padding_value=-1)
             return x_padded, y_padded
 
-        train_data = DummyDataset(self.model.max_seq_length, self.dynamic)
+        train_data = DummyDataset(self.config.block_size, self.dynamic)
         train_dataloader = DataLoader(
             train_data, batch_size=self.micro_batch_size, num_workers=2, collate_fn=pad_collate
         )
 
         return train_dataloader
 
     def calculate_model_flops(self):
-        input_ids, targets = next(self.train_data_iter)
-        input_ids = input_ids.to(device=self.device)
-        targets = targets.to(device=self.device)
+        meta = torch.device("meta")
+        device = self.device
+        self.device = meta
+
+        # calculate flops on a meta-device model because we only care about the shapes and
+        # because the flops calculator installs hooks on the model
+        meta_model = self.init_model()
 
-        model_fwd = lambda: self.model(input_ids)
+        x = torch.randint(0, 1, (self.micro_batch_size, meta_model.config.block_size), device=meta)
+        model_fwd = lambda: meta_model(x)
         model_loss = lambda y: torch.nn.functional.cross_entropy(
-            y.reshape(-1, y.size(-1)), targets.reshape(-1), ignore_index=-1
+            y.reshape(-1, y.size(-1)), x.reshape(-1), ignore_index=-1
         )
-        if LIGHTNING_AVAILABLE:
-            self.perf_metrics["model_flops"] = measure_flops(self.model, model_fwd, model_loss) / 1e12
+        self.perf_metrics["model_flops"] = measure_flops(meta_model, model_fwd, model_loss)
+
+        self.device = device
 
     def train(self):
         t0 = None
-        # if global_rank in [0, None]:
-        #     #Calculate the model FLOPs
-        #     self.calculate_model_flops()
-        # Setup Perf Collection
-        # self.throughput = Throughput(window_size=10, world_size=world_size)
+        if global_rank in [0, None]:
+            # Calculate the model FLOPs
+            self.calculate_model_flops()
+            # Setup throughput Collection
+            self.throughput = Throughput(window_size=self.max_iters - self.warmup_iter, world_size=world_size)
 
         if "transformerengine" in self.compile:
             import transformer_engine.pytorch as te
 
             te_ctx = te.fp8_autocast
         else:
             from contextlib import nullcontext
@@ -322,53 +383,38 @@
 
             loss_item = loss.item()  # synchronization
             t1 = time.perf_counter()
             if global_rank in [0, None]:
                 print(
                     f"iter {i}: loss {loss_item:.4f}, iter time: {(t1 - iter_t0) * 1000:.2f}ms, t: {input_ids.size(1)}"
                 )
-
-            # if global_rank in [0, None] and i >=warmup_iter:
-            #     self.throughput.update(
-            #         time=(t1-t0),
-            #         flops=self.model_flops,
-            #         batches=i,
-            #         samples=(i * self.micro_batch_size * self.gradient_accumulation_steps),
-            #         lengths=(i * self.micro_batch_size * self.gradient_accumulation_steps * self.model.max_seq_length),
-            #     )
-
-            #     metrics = self.throughput.compute()
-            #     if i % 10 == 0:
-            #         print(metrics)
+                if i >= self.warmup_iter:
+                    self.throughput.update(
+                        time=(t1 - t0),
+                        flops=self.perf_metrics["model_flops"],
+                        batches=i,
+                        samples=(i * self.micro_batch_size * self.gradient_accumulation_steps),
+                        lengths=(i * self.micro_batch_size * self.gradient_accumulation_steps * self.config.block_size),
+                    )
 
         if global_rank in [0, None]:
             # print(f"Total time: {(t1 - t0):.2f}s")
-            # print(f"Average time per iter: {((t1 - t0)*1000)/(max_iters-warmup_iter):.2f}ms")
             self.perf_metrics["average_iter_time"] = ((t1 - t0) * 1000) / (self.max_iters - self.warmup_iter)
 
     def add_perf_metrics(self):
-        # tokens_per_sec = total number of benchmarked iterations x global BS x block_size / total elapsed time (s)
-        #               = global BS x block_size / (total elapsed time (s)/total number of benchmarked iterations)
-        #               = global BS x block_size / average iter time (s)
-        self.perf_metrics["tokens_per_sec"] = (
-            self.global_batch_size * self.model.max_seq_length * 1000 / self.perf_metrics["average_iter_time"]
-        )  # tokens/s
-        if self.perf_metrics["model_flops"] is not None:
-            self.perf_metrics["model_flop_per_sec"] = (
-                self.perf_metrics["model_flops"] * 1000 / self.perf_metrics["average_iter_time"]
-            )
-            if world_size is not None:
-                self.perf_metrics["model_flop_per_sec"] *= world_size
+        metrics = self.throughput.compute()
+        self.perf_metrics["tokens_per_sec"] = metrics.get("items_per_sec", metrics["device/items_per_sec"])
+        self.perf_metrics["model_flop_per_sec"] = metrics.get("flops_per_sec", metrics["device/flops_per_sec"])
         self.perf_metrics["memory_used_GB"] = torch.cuda.max_memory_allocated() / 1e9
 
     def add_model_info_to_metrics(self):
         if global_rank in [0, None]:
             self.perf_metrics["model_name"] = self.model_name
             self.perf_metrics["Num GPUS"] = world_size
-            self.perf_metrics["Seq Len"] = self.model.max_seq_length
+            self.perf_metrics["Seq Len"] = self.config.block_size
             self.perf_metrics["Micro BS"] = self.micro_batch_size
             self.perf_metrics["Global BS"] = self.global_batch_size
             self.perf_metrics["GA"] = self.gradient_accumulation_steps
             if self.distributed_mode in ["fsdp"]:
                 self.perf_metrics["Distributed Mode"] = (
                     str(self.distributed_mode)
                     + "_"
@@ -412,33 +458,36 @@
     try:
         benchmark.train()
 
         if global_rank in [0, None]:
             benchmark.add_perf_metrics()
 
             print(
-                f"Model name: {benchmark.model_name}\nSeq Length: {benchmark.model.max_seq_length}\nMicro BS: {benchmark.micro_batch_size}\nGlobal BS: {benchmark.global_batch_size}"
+                f"Model name: {benchmark.model_name}\nSeq Length: {benchmark.config.block_size}\nMicro BS: {benchmark.micro_batch_size}\nGlobal BS: {benchmark.global_batch_size}"
             )
             print(
                 f"Number of Layers: {benchmark.config.n_layer}\nNumber of parameters: {sum(p.numel() for p in benchmark.model.parameters() if p.requires_grad) / 1e9:.02f}B"
             )
             print(f"Distributed Mode: {benchmark.distributed_mode}")
             if benchmark.distributed_mode == "fsdp":
-                print(
-                    f"Sharding Mode: {benchmark.shard_mode}\nSharding Size: {benchmark.sharding_size}\nBucketing: {benchmark.bucketing_mode}"
-                )
+                print(f"Sharding Mode: {benchmark.shard_mode}\nBucketing: {benchmark.bucketing_mode}")
+                if benchmark.sharding_size is not None:
+                    print(
+                        f"Sharding Size: {benchmark.sharding_size}\nReplicate DP Groups: {int(world_size/benchmark.sharding_size)}"
+                    )
+                if benchmark.bucketing_mode == "size":
+                    print(f"Bucketing Number Params: {benchmark.fsdp_bucket_params}")
+            elif benchmark.distributed_mode == "ddp":
+                print(f"DDP Bucketing Size: {benchmark.ddp_bucket_size} MB")
             print(f"Compiler: {benchmark.compile}")
             print(f"Average iter time: {benchmark.perf_metrics['average_iter_time']:.2f} ms")
             print(f"Memory used: {benchmark.perf_metrics['memory_used_GB']:.02f} GB")
-            print(f"Throughput (Tokens/s): {benchmark.perf_metrics['tokens_per_sec']:.02f} tokens/s")
-            print(
-                f"Normalized Throughput (Tokens/s/GPU): {(benchmark.perf_metrics['tokens_per_sec']/world_size):.02f} tokens/s/gpu"
-            )
-            if benchmark.perf_metrics["model_flop_per_sec"] is not None:
-                print(f"Model TFLOP/s: {benchmark.perf_metrics['model_flop_per_sec']:.02f} TFLOP/s")
+            print(f"Tokens/s: {benchmark.perf_metrics['tokens_per_sec']:.02f}")
+            print(f"Tokens/s/GPU: {(benchmark.perf_metrics['tokens_per_sec']/world_size):.02f}")
+            print(f"TFLOP/s: {benchmark.perf_metrics['model_flop_per_sec'] / 1e12:.02f}")
 
     except Exception as error:
         # Helps catch OutOfMemory Errors and post processing of errors
         if global_rank in [0, None]:
             print("An error occurred:", type(error).__name__, "–", error)
 
     if global_rank in [0, None]:
```

### Comparing `lightning-thunder-0.1.0/thunder/benchmarks/distributed.py` & `lightning-thunder-0.2.0.dev20240404/thunder/benchmarks/distributed.py`

 * *Files 1% similar despite different names*

```diff
@@ -10,15 +10,15 @@
     BenchmarkRunStatistics,
     _nanogpt_configs,
     NanoGPTConfig,
     NanoGPTBenchmark,
     LitGPTBenchmark,
     LitGPTConfig,
 )
-from thunder.tests.lit_gpt_model import name_to_config
+from thunder.tests.litgpt_model import name_to_config
 from thunder.distributed import FSDPBucketingStrategy
 from thunder.distributed import FSDPType
 
 
 _nanogpt_model_names: tuple[str, ...] = tuple(_nanogpt_configs.keys())
 _llama_model_names: tuple[str, ...] = tuple(name_to_config.keys())
 _llama2_configs: tuple[str, ...] = ("open_llama_7b", "Llama-2-7b-hf")
@@ -295,15 +295,15 @@
                     )
             else:
                 import functools
                 from torch.distributed.fsdp import ShardingStrategy
                 from torch.distributed.fsdp.wrap import transformer_auto_wrap_policy
                 from thunder.benchmarks import get_default_torch_fsdp_executor
                 from thunder.tests.nanogpt_model import Block as NanoGPTBlock
-                from thunder.tests.lit_gpt_model import Block as GPTBlock
+                from thunder.tests.litgpt_model import Block as GPTBlock
 
                 sharding_strategy = ShardingStrategy.SHARD_GRAD_OP
                 auto_wrap_policies = (
                     None,
                     functools.partial(transformer_auto_wrap_policy, transformer_layer_cls={NanoGPTBlock, GPTBlock}),
                 )
                 for auto_wrap_policy in auto_wrap_policies:
@@ -318,17 +318,19 @@
                         world_size=world_size,
                         extended_printout=False,
                     )
                     results.append(
                         ResultFormatter(
                             model_name=args.model,
                             base_name="torch_fsdp",
-                            suffix=str(sharding_strategy).lower() + "-bucketing_" + "block"
-                            if auto_wrap_policy is not None
-                            else "none",
+                            suffix=(
+                                str(sharding_strategy).lower() + "-bucketing_" + "block"
+                                if auto_wrap_policy is not None
+                                else "none"
+                            ),
                             dtype=args.dtype,
                             world_size=world_size,
                             total_callable_construction_time=total_cct,
                             warmup_stats=all_warmup_stats,
                             benchmark_stats=all_benchmark_stats,
                             typehint=args.typehint,
                             rank_mem_info=rank_mem_info,
@@ -348,17 +350,19 @@
                             world_size=world_size,
                             extended_printout=False,
                         )
                         results.append(
                             ResultFormatter(
                                 model_name=args.model,
                                 base_name="torch_compile_fsdp",
-                                suffix=str(sharding_strategy).lower() + "-bucketing_" + "block"
-                                if auto_wrap_policy is not None
-                                else "none",
+                                suffix=(
+                                    str(sharding_strategy).lower() + "-bucketing_" + "block"
+                                    if auto_wrap_policy is not None
+                                    else "none"
+                                ),
                                 dtype=args.dtype,
                                 world_size=world_size,
                                 total_callable_construction_time=total_cct,
                                 warmup_stats=all_warmup_stats,
                                 benchmark_stats=all_benchmark_stats,
                                 typehint=args.typehint,
                                 rank_mem_info=rank_mem_info,
```

### Comparing `lightning-thunder-0.1.0/thunder/benchmarks/einsum.py` & `lightning-thunder-0.2.0.dev20240404/thunder/benchmarks/einsum.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/benchmarks/targets.py` & `lightning-thunder-0.2.0.dev20240404/thunder/benchmarks/targets.py`

 * *Files 0% similar despite different names*

```diff
@@ -35,15 +35,15 @@
     thunder_cudnn_nvfuser_executor,
     thunder_cudnn_layer_norm_executor,
     thunder_cudnn_layer_norm_nvfuser_executor,
     thunder_sdpa_executor,
     thunder_sdpa_torch_compile_nvfuser_executor,
 )
 
-from thunder.tests.lit_gpt_model import Config as LitGPTConfig
+from thunder.tests.litgpt_model import Config as LitGPTConfig
 
 
 APEX_FUSED_ROPE_AVAILABLE: bool = package_available("fused_rotary_positional_embedding")
 
 
 def make_setup(b: Benchmark):
     def setup():
@@ -869,16 +869,16 @@
         (thunder_fwd_bwd_sdpa_torch_compile_nvfuser, False),
         (torch_fwd_bwd, True),
         (torchcompile_fwd_bwd, True),
     ),
     ids=(
         "torch",
         "torch.compile",
-        "thunder-fwd-bwd",
-        "thunder+nvfuser+torch.compile-fwd-bwd",
+        "thunder",
+        "thunder+nvfuser+torch.compile",
         "torch+apex",
         "torch.compile+apex",
     ),
 )
 def test_llama2_qkv_split_rope_7b_train(benchmark, executor: Callable, use_apex: bool):
     from thunder.benchmarks import LlamaQKVSplitRopeBenchmark
```

### Comparing `lightning-thunder-0.1.0/thunder/clang/__init__.py` & `lightning-thunder-0.2.0.dev20240404/thunder/clang/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -5,15 +5,17 @@
 from collections.abc import Callable
 from collections.abc import Sequence
 from collections import namedtuple
 import operator
 from types import EllipsisType, NoneType
 import copy
 import time
+import warnings
 
+from thunder.core.baseutils import run_once
 from thunder.core.compile_data import using_symbolic_values
 from thunder.clang.langctx import register_method
 from thunder.core.langctxs import langctx, Languages
 
 import thunder.core.dtypes as dtypes
 from thunder.core import utils
 import thunder.core.prims as prims
@@ -1156,14 +1158,22 @@
                 (shape[idx] == 1) or (common_shape[idx] == shape[idx]),
                 lambda: f"Attempting to broadcast a dimension of length {shape[idx]}!",
             )
 
     return tuple(common_shape)
 
 
+@run_once
+def mT_scalar_warning():
+    warnings.warn(
+        "Tensor.mT is deprecated on 0-D tensors. This function is the identity in these cases.",
+        UserWarning,
+    )
+
+
 @clangop(method_name="mT")
 def matrix_transpose(a: TensorProxy) -> TensorProxy:
     """Transposes the last two dimensions of a tensor.
 
     This function is used to implement the `.mT` attribute.
 
     Args:
@@ -1177,14 +1187,21 @@
         >>> def func(x): return x.mT
         >>> traced_func = thunder.make_traced(func, executor="torch")
         >>> traced_func(a)
         tensor([[1, 4],
                 [2, 5],
                 [3, 6]])
     """
+
+    if a.ndim == 0:
+        mT_scalar_warning()
+        return a
+    elif a.ndim == 1:
+        raise RuntimeError(f"tensor.mT is only supported on matrices or batches of matrices. Got 1-D tensor.")
+
     dim0, dim1 = -2, -1
     dim0, dim1 = utils.canonicalize_dims(a.ndim, (dim0, dim1))
     permutation = list(range(a.ndim))
     permutation[dim0], permutation[dim1] = permutation[dim1], permutation[dim0]
     return transpose(a, permutation)
 
 
@@ -1893,7 +1910,18 @@
 def argmax(a: TensorProxy, /, dim: int | None = None, keepdim: bool | None = False):
     return _argmaxmin_helper(prims.argmax, a, dim, keepdim)
 
 
 @clangop()
 def argmin(a: TensorProxy, /, dim: int | None = None, keepdim: bool | None = False):
     return _argmaxmin_helper(prims.argmin, a, dim, keepdim)
+
+
+@clangop()
+def topk(
+    a: TensorLike, /, k: int, dim: int | None = None, largest: bool = True, sorted: bool = True, *, out=None
+) -> (TensorProxy, TensorProxy):
+    if dim is None:
+        dim = a.ndim - 1 if a.ndim > 0 else 0
+    dim = utils.canonicalize_dim(a.ndim, dim)
+
+    return prims.topk(a, k, dim, bool(largest), bool(sorted), out=out)
```

### Comparing `lightning-thunder-0.1.0/thunder/clang/langctx.py` & `lightning-thunder-0.2.0.dev20240404/thunder/clang/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/common.py` & `lightning-thunder-0.2.0.dev20240404/thunder/common.py`

 * *Files 2% similar despite different names*

```diff
@@ -150,24 +150,28 @@
         use_cudagraphs: bool = False,
         use_torch_compile: bool = False,
         disable_torch_autograd_support: bool = False,
         use_rematerialization: bool = False,
         debug_log: None | StringIO = None,
         compile_options: dict[str, Any] = {},
         get_computation_and_inputs: Callable | None = None,
+        executor_lookasides: dict[Callable, Callable] | None = None,
     ):
         # Records whether we're using the thunder.jit() entrypoint or not
         #   The thunder.jit() entrypoint introduces important architectural updates,
         #   but some components are still designed to work with the older entrypoint
         #   and are being temporarily maintained to facilitate their development.
         self.using_jit = using_jit
 
         # runs prologues to get the compute/backward/epilogue function and inputs
         self.get_computation_and_inputs = get_computation_and_inputs
 
+        # lookasides provided by the executors
+        self.executor_lookasides = executor_lookasides
+
         # Resolves cache option
         self.cache_option = resolve_cache_option(cache_option)
 
         #
         # Gathers additional metadata
         #
 
@@ -225,23 +229,15 @@
         # Possibly processes the function
         #
         self.additional_param_names = None
         self.additional_param_values = None
         self.additional_return_names = None
         self.num_constant_args = 0
 
-        self._processed_function: Callable
-
-        assert disable_preprocessing, "please use thunder.jit if you need preprocessing"
-        self._processed_function = fn
-
-    # Disallows overwriting processed_function
-    @property
-    def processed_function(self):
-        return self._processed_function
+        assert disable_preprocessing, "please use thunder.compile if you need preprocessing"
 
 
 # Common UX functions
 def _unpack_inputs(fn, tracectx: TraceCtx, args, kwargs, *, rename_proxies: bool):
     tracectx.unpacking()
 
     # Translates tensors, arrays, and dtypes to thunder.jit types
@@ -657,15 +653,15 @@
     cd: CompileData,
     cs: CompileStats,
     *,
     transforms: list[Callable] = [],
     post_optimization_transforms: list[Callable] = [],
     _using_grad_transform: bool = False,
 ) -> Callable:
-    @wraps(cd.processed_function)
+    @wraps(cd.fn)
     def _fn(*args, **kwargs) -> tuple[Any, list[TraceCtx]]:
         cs.last_trace_host_start = time.time_ns()
         cs.calls += 1
 
         # autocast related operations
         is_autocast_enabled = False
         autocast_key = None
@@ -720,19 +716,15 @@
                 cs.last_trace_host_execution_stop = time.time_ns()
                 cs.last_trace_host_stop = cs.last_trace_host_execution_stop
                 return result
         cs.cache_misses += 1
         cs.last_trace_cache_stop = time.time_ns()
 
         # Applies the autocast transform if PyTorch's autocast behavior is enabled
-        processed_function = (
-            cd.processed_function
-            if not is_autocast_enabled
-            else autocast(cd.processed_function, dtype=autocast_thunder_dtype)
-        )
+        processed_function = cd.fn if not is_autocast_enabled else autocast(cd.fn, dtype=autocast_thunder_dtype)
 
         # Resets use of compile flags
         cs.last_compile_reasons = defaultdict(list)
         with compile_data_and_stats(cd, cs):
             traces: list[TraceCtx] = []
             cs.last_traces = traces
             cs.last_backward_traces = []
@@ -831,15 +823,14 @@
                     distributed_key=distributed_key,
                 )
 
             cs.last_trace_host_stop = time.time_ns()
             return result
 
     # NOTE is_module is False
-    _fn._pfn = cd.processed_function
     _fn._lc_cd = cd
     _fn._lc_cs = cs
     _fn._lc_transforms = transforms
     _fn._lc_post_optimization_transforms = post_optimization_transforms
     _fn._using_grad_transform = _using_grad_transform
 
     return _fn
```

### Comparing `lightning-thunder-0.1.0/thunder/core/baseutils.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/baseutils.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/codeutils.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/codeutils.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/compile_data.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/compile_data.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/devices.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/devices.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/dtypes.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/dtypes.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/interpreter.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/interpreter.py`

 * *Files 1% similar despite different names*

```diff
@@ -400,14 +400,18 @@
         self._with_provenance_tracking = with_provenance_tracking
         if with_provenance_tracking:
             assert isinstance(uncacheable_classes, (list, tuple))
             uncacheable_classes = tuple(set(uncacheable_classes) | {NoneType, int, str, float, bool})
 
         self._uncacheable_classes = uncacheable_classes
 
+    @property
+    def with_provenance_tracking(self):
+        return self._with_provenance_tracking
+
     def interpret(self, inst: dis.Instruction, /, **interpreter_state) -> None | int | INTERPRETER_SIGNALS:
         return self._opcode_interpreter(inst, **interpreter_state)
 
     def lookaside(self, fn: Callable, /, *args, **kwargs) -> None | Callable:
         return self._fn_lookaside(fn, *args, **kwargs)
 
     def callback(self, id: INTERPRETER_CALLBACKS) -> None | Callable:
@@ -883,14 +887,15 @@
     return res
 
 
 class PseudoInst(str, enum.Enum):
     BINARY_SUBSCR = "BINARY_SUBSCR"
     BUILD_DICT = "BUILD_DICT"
     BUILD_TUPLE = "BUILD_TUPLE"
+    BUILD_NAMEDTUPLE = "BUILD_NAMEDTUPLE"
     CONSTANT = "CONSTANT"
     EXCEPTION_HANDLER = "EXCEPTION_HANDLER"
     INPUT_ARGS = "INPUT_ARGS"
     INPUT_KWARGS = "INPUT_KWARGS"
     INPUT_FN = "INPUT_FN"
     LOAD_ATTR = "LOAD_ATTR"
     LOOKASIDE = "LOOKASIDE"
@@ -1351,14 +1356,28 @@
 
     ux = unwrap(x)  # make the shortcut also work for WrappedValue True or False
     if ux is True or ux is False:
         return x
     return _interpret_call(impl, x)
 
 
+# https://docs.python.org/3/library/functions.html#enumerate
+def _enumerate_lookaside(obj: Iterable, start: int = 0):
+    if not wrapped_isinstance(start, int):
+        return do_raise(TypeError(f"{type(start)} object cannot be interpreted as an integer"))
+
+    def impl(obj, start):
+        n = start
+        for elem in obj:
+            yield n, elem
+            n += 1
+
+    return _interpret_call(impl, obj, wrap_const(start))
+
+
 @interpreter_needs_wrap
 def eval_lookaside(
     source: str | bytes | bytearray | CodeType,  # A python expression
     globals: dict[str, Any] | None = None,
     locals: Mapping[str, object] | None = None,
     /,
 ) -> Any:
@@ -2097,16 +2116,17 @@
 
 class MutSequenceWrapperMethods(SequenceWrapperMethods):
     def __new__(cls, iterable=()):
         assert isinstance(cls.value, type)
         return wrap_const(cls.value())
 
     def __init__(self, iterable=()):
-        SequenceWrapperMethods.__init__(self, iterable)
-        return wrap_const(None)
+        # We need to propagate the return value because it could be JIT_SIGNALS
+        res = SequenceWrapperMethods.__init__(self, iterable)
+        return res
 
     def __setitem__(self, key, value, /):
         self.track_items()
         uself = self.value
         ukey = key.value
 
         if isinstance(ukey, slice):
@@ -2584,22 +2604,72 @@
             new = self.__class__(other)
             new.update(self)
             return new
 
         return _interpret_call(impl, self, other)
 
 
+def _collections_namedtuple_lookaside(
+    typename: str,
+    field_names: Iterable[str],
+    *,
+    rename: bool = False,
+    defaults: None | Iterable[Any] = None,
+    module: None | str = None,
+):
+    # Type checks {
+    assert wrapped_isinstance(typename, str)
+    assert wrapped_isinstance(field_names, Iterable)
+    assert wrapped_isinstance(rename, bool)
+    if defaults is not None:
+        assert wrapped_isinstance(defaults, Iterable)
+    if module is not None:
+        assert wrapped_isinstance(module, str)
+    # }
+
+    # Wrap defaults {
+    if not isinstance(rename, WrappedValue):
+        rename = wrap_const(rename)
+
+    if defaults is None:
+        defaults = wrap_const(defaults)
+
+    if module is None:
+        # To prevent taking module from the direct caller,
+        # we use the module's name from the active frame
+        curr_frame = get_interpreterruntimectx().frame_stack[-1]
+        module = unwrap(curr_frame.globals).get("__name__", None)
+        module = wrap_const(module)
+    # }
+
+    # Run opaque namedtuple {
+    @interpreter_needs_wrap
+    def create_namedtuple(typename: str, field_names: str, **kwargs):
+        namedtuple_type = collections.namedtuple(typename, field_names, **kwargs)
+        return namedtuple_type
+
+    namedtuple_type = create_namedtuple(typename, field_names, rename=rename, defaults=defaults, module=module)
+    if namedtuple_type is INTERPRETER_SIGNALS.EXCEPTION_RAISED:
+        return namedtuple_type
+
+    assert wrapped_isinstance(namedtuple_type, type)
+    # }
+
+    return namedtuple_type
+
+
 _default_lookaside_map: dict[Callable, Callable] = {
     # Jit lookasides
     is_jitting: _is_jitting_lookaside,
     is_jitting_with_raise: _is_jitting_lookaside,
     call_opaque: call_opaque,
     # Python builtin lookasides
     any: _any_lookaside,
     bool: _bool_lookaside,
+    enumerate: _enumerate_lookaside,
     exec: exec_lookaside,
     eval: eval_lookaside,
     getattr: _getattr_lookaside,
     setattr: _setattr_lookaside,
     globals: _globals_lookaside,
     iter: _iter_lookaside,
     len: _len_lookaside,
@@ -2607,24 +2677,27 @@
     next: _next_lookaside,
     reversed: _reversed_lookaside,
     super: _super_lookaside,
     type.__call__: _type_lookaside,
     isinstance: _isinstance_lookaside,
     functools.reduce: _functools_reduce_lookaside,
     operator.getitem: _getitem_lookaside,
+    collections.namedtuple: _collections_namedtuple_lookaside,
 }
 
 
 # While mutuable sequences (lists) are created empty in __new__ and populated in __init__,
 # immutuable sequences (tuples) are created with contents in __new__ and __init__ is a nop
 # (object.__init__, actually).
 def _tuple_new_provenance_tracking_lookaside(cls, iterable=(), /):
+    new_tuple_type = cls.value
+    assert issubclass(new_tuple_type, tuple)
+
     if iterable == ():
         iterable = wrap_const(())
-    assert cls.value is tuple
 
     if isinstance(iterable.value, (list, tuple)):
         # special case to avoid infinite recursion
         iterable.track_items()
         item_wrappers = []
         # TODO: investigate why just taking the wrappers will break test_interpreter.py::test_module_hooks
         for i in range(len(iterable.value)):
@@ -2643,16 +2716,47 @@
                 if isinstance(runtimectx.curexc, StopIteration):
                     done = True
                 else:
                     return INTERPRETER_SIGNALS.EXCEPTION_RAISED
             else:
                 item_wrappers.append(wv)
 
-    ures = tuple(w.value for w in item_wrappers)
-    pr = ProvenanceRecord(PseudoInst.BUILD_TUPLE, inputs=[w.provenance for w in item_wrappers])
+    def is_likely_from_collections_namedtuple(tuple_type):
+        from collections import namedtuple
+
+        # Check if tuple_type code object is coming from namedtuple
+        return (
+            hasattr(tuple_type, "__repr__")
+            and hasattr(tuple_type.__repr__, "__code__")
+            and tuple_type.__repr__.__code__ in namedtuple.__code__.co_consts
+        )
+
+    # Construction of namedtuples may raise
+    try:
+        ures = tuple(w.value for w in item_wrappers)
+        # Named tuples expect varargs, not iterables at new/init
+        if is_likely_from_collections_namedtuple(new_tuple_type):
+            if hasattr(new_tuple_type, "__bases__") and new_tuple_type.__bases__ == (tuple,):
+                ures = new_tuple_type(*ures)
+                build_inst = PseudoInst.BUILD_NAMEDTUPLE
+            else:
+                return do_raise(
+                    NotImplementedError(
+                        f"The type {new_tuple_type} is likely a subclassed named tuple. "
+                        "Subclassing the types returned by `collections.namedtuple` "
+                        "is currently not supported! Please, file an issue requesting this support."
+                    )
+                )
+        else:
+            ures = new_tuple_type(ures)
+            build_inst = PseudoInst.BUILD_TUPLE
+    except Exception as e:
+        return do_raise(e)
+
+    pr = ProvenanceRecord(build_inst, inputs=[w.provenance for w in item_wrappers])
     res = wrap(ures, provenance=pr)
     res.item_wrappers = item_wrappers
 
     for u, v in zip(res.value, res.item_wrappers):
         assert u is v.value, f"{u}, {v.value}"
     return res
```

### Comparing `lightning-thunder-0.1.0/thunder/core/jit_ext.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/jit_ext.py`

 * *Files 2% similar despite different names*

```diff
@@ -3,15 +3,16 @@
 from typing import Any, Optional, Dict, Tuple, Literal
 import builtins
 import collections
 from collections.abc import ValuesView, Iterable, Iterator
 from collections.abc import Callable, Sequence
 import weakref
 import random
-from functools import partial, wraps
+from functools import partial, wraps, reduce
+import operator
 import copy
 import contextvars
 from contextlib import contextmanager
 import dis
 import warnings
 from enum import Enum, auto
 from io import StringIO
@@ -372,15 +373,17 @@
 
     pass
 
 
 def _sharp_edge(desc: str, value: Any, /) -> Any | INTERPRETER_SIGNALS:
     sharp_edges: SHARP_EDGES_OPTIONS = get_minimal_ctx().sharp_edges
 
-    s: str = f"{desc} is a sharp edge that cannot be translated to a thunder program unless using interpretation=INTERPRETATION_OPTIONS.TRANSLATE_PYTHON."
+    s: str = (
+        f"{desc} is a sharp edge that cannot be translated to a thunder program unless using interpretation=INTERPRETATION_OPTIONS.TRANSLATE_PYTHON."
+    )
 
     if sharp_edges is SHARP_EDGES_OPTIONS.ERROR:
         return do_raise(ThunderSharpEdgeError(s))
 
     # Warn and return value anyway
     if sharp_edges is SHARP_EDGES_OPTIONS.WARN:
         warnings.warn(s)
@@ -464,15 +467,17 @@
 
     pass
 
 
 def _general_jit_sharp_edge(desc: str, value: Any, /) -> Any | INTERPRETER_SIGNALS:
     sharp_edges: SHARP_EDGES_OPTIONS = get_minimal_ctx().sharp_edges
 
-    s: str = f"{desc} This is currently considered a sharp edge even with interpretation=INTERPRETATION_OPTIONS.TRANSLATE_PYTHON. For cases in which we are overly strict, please file an issue. Thank you!"
+    s: str = (
+        f"{desc} This is currently considered a sharp edge even with interpretation=INTERPRETATION_OPTIONS.TRANSLATE_PYTHON. For cases in which we are overly strict, please file an issue. Thank you!"
+    )
 
     if sharp_edges is SHARP_EDGES_OPTIONS.ERROR:
         return do_raise(JITSharpEdgeError(s))
 
     # Warn and return value anyway
     if sharp_edges is SHARP_EDGES_OPTIONS.WARN:
         warnings.warn(s)
@@ -515,24 +520,31 @@
             return [""]
 
     return "_".join(get_postfix(pr))
 
 
 class GeneralJitCtx(MinimalCtx):
     def __init__(
-        self, prologue_trace, computation_trace, *, sharp_edges: SHARP_EDGES_OPTIONS, process_group_for_ddp=None
+        self,
+        prologue_trace,
+        computation_trace,
+        *,
+        sharp_edges: SHARP_EDGES_OPTIONS,
+        process_group_for_ddp=None,
+        executor_lookasides,
     ):
         super().__init__(sharp_edges=sharp_edges)
 
         self._prologue_trace = prologue_trace
         self._computation_trace: TraceCtx = computation_trace
         self._constraints = []
         self._process_group_for_ddp = process_group_for_ddp
         self._additional_outputs = collections.defaultdict(list)
         self._proxy_swapmap: dict[Variable, Proxy] = {}
+        self._executor_lookasides: dict[Callable, Callable] = executor_lookasides
 
     @property
     def prologue_trace(self) -> TraceCtx:
         return self._prologue_trace
 
     @property
     def computation_trace(self) -> TraceCtx:
@@ -867,15 +879,20 @@
         proxy_recursion(v)
 
 
 # TODO Document this function (with steps)
 def general_jit_lookaside(fn, *args, **kwargs) -> None | Callable:
     # Identifies the lookaside
     lookaside: None | Callable
-    if isinstance(fn, Symbol) or fn in _clang_fn_set:
+
+    ctx: GeneralJitCtx = get_general_jit_ctx()
+
+    if (executor_lookaside := ctx._executor_lookasides.get(fn, None)) is not None:
+        lookaside = executor_lookaside
+    elif isinstance(fn, Symbol) or fn in _clang_fn_set:
         # Performs symbol lookasides
         # NOTE Symbols "lookaside" to themselves; this just prevents their internals from being jitted
         # NOTE clang operations are not symbols, but we still prevent their internals from being jitted
         recursively_proxy(*args, **kwargs)
         lookaside = interpreter_needs_wrap(fn)
     elif (general_jit_lookaside := _general_jit_lookaside_map.get(fn, None)) is not None:
         lookaside = general_jit_lookaside
@@ -884,27 +901,43 @@
         lookaside = default_lookaside(fn, *args, **kwargs)
 
     if lookaside is None:
 
         def is_from_torch(fn):
             return hasattr(fn, "__module__") and fn.__module__ and fn.__module__.startswith("torch")
 
-        if is_opaque(fn) and is_from_torch(fn):
+        has_tensor_arg = False
+        for a in args:
+            if isinstance(a.value, TensorProxy):
+                has_tensor_arg = True
+                break
+            if isinstance(a.value, Sequence):
+                if any(isinstance(i, TensorProxy) for i in a.value):
+                    has_tensor_arg = True
+                    break
+
+        if is_opaque(fn) and is_from_torch(fn) and has_tensor_arg:
             if fn.__module__.startswith("torch._C"):
                 return lookaside
 
             # Torch functions have __name__ defined
             fn_name = f"{fn.__module__}.{fn.__name__}"
 
-            # For now, only torch-like opaque functions are sharp edges
-            return _general_jit_sharp_edge(
-                f"Trying to call function {fn_name}, but it's unsupported. Please file an issue requesting support.",
-                None,
+            # Probably merge with sharp edges
+            calling_opaque_torch_msg = (
+                f"Trying to call function {fn_name}, but it is not yet supported. "
+                "Please file an issue requesting support. "
+                "To find out which operations are not yet recongnized by `thunder.jit`, "
+                "please run `examine` as per:\n\n"
+                "from thunder.examine import examine\n"
+                "examine(<your thunder.jit callable argument>, ...)\n"
             )
 
+            return do_raise(NotImplementedError(calling_opaque_torch_msg))
+
     return lookaside
 
 
 #
 # general_jit callbacks and callback utilities
 #
 
@@ -1343,14 +1376,28 @@
 
     si = SigInfo(name)
     si.args = [(v.proxy.name, None) for v in input_vars]
     trace._siginfo = si
     trace.args = input_proxies
 
 
+def _get_process_group_from(*fn_and_args) -> Optional["ProcessGroup"]:
+    # `ddp` and `fsdp` transforms add attribute `procses_group_for_ddp`
+    # on the Module that they wrap. This module could be passed to `thunder.jit`
+    # as the function to be jitted or as an argument of the function to be jitted.
+    found_pg = None
+    for fn_or_arg in fn_and_args:
+        pg = getattr(fn_or_arg, "process_group_for_ddp", None)
+        if pg is not None and found_pg is None:
+            found_pg = pg
+        elif pg is not None and pg != found_pg:
+            raise NotImplementedError("jitting modules with different ProcessGroup is not supported currently.")
+    return found_pg
+
+
 def thunder_general_jit(
     fn: Callable, args, kwargs, /, *, sharp_edges: SHARP_EDGES_OPTIONS
 ) -> tuple[TraceCtx, TraceCtx]:
     # TODO: move into wrap_callback or so
     if isinstance(fn, torch.nn.parallel.DistributedDataParallel):
         raise NotImplementedError(
             f"jitting DistributedDataParallel modules is not supported compile the module and then wrap in DDP"
@@ -1365,17 +1412,24 @@
     epilogue_trace: TraceCtx = TraceCtx()
 
     si = SigInfo("prologue")
     si.varargs = ("args", None)
     si.varkwargs = ("kwargs", None)
     prologue_trace._siginfo = si
 
-    process_group_for_ddp = getattr(fn, "process_group_for_ddp", None)
+    compile_data = get_compile_data()
+    executor_lookasides = {k: interpreter_needs_wrap(v) for k, v in compile_data.executor_lookasides.items()}
+
+    process_group_for_ddp: Optional["ProcessGroup"] = _get_process_group_from(fn, *args, *kwargs.values())
     ctx: GeneralJitCtx = GeneralJitCtx(
-        prologue_trace, computation_trace, sharp_edges=sharp_edges, process_group_for_ddp=process_group_for_ddp
+        prologue_trace,
+        computation_trace,
+        sharp_edges=sharp_edges,
+        process_group_for_ddp=process_group_for_ddp,
+        executor_lookasides=executor_lookasides,
     )
     jfn = interpret(
         fn,
         fn_lookaside=general_jit_lookaside,
         callbacks=general_jit_callbacks,
         with_provenance_tracking=True,
         uncacheable_classes=(torch.Tensor, int, float, str, NoneType),
```

### Comparing `lightning-thunder-0.1.0/thunder/core/langctxs.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/langctxs.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/options.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/options.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/patterns.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/patterns.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/prims.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/prims.py`

 * *Files 2% similar despite different names*

```diff
@@ -227,28 +227,30 @@
     AMIN = auto()
     PROD = auto()
     SUM = auto()
     VAR = auto()
     VAR_MEAN = auto()
     ARGMAX = auto()
     ARGMIN = auto()
+    TOPK = auto()
     # Scatter and gather prims (Experimental!)
     INDEX_ADD = auto()
     INDEX_PUT = auto()
     SCATTER_ADD = auto()
     TAKE = auto()
     TAKE_ALONG_AXIS = auto()
     # Linear algebra prims (Mostly experimental)
     MATMUL = auto()
     # NN prims (Experimental!)
     CONVOLUTION = auto()
     EMBEDDING = auto()
     EMBEDDING_BACKWARD = auto()
     LINEAR = auto()
     PAD = auto()
+    BATCH_NORM = auto()
     # Memory access methods
     ITEM = auto()
 
 
 class OpTags(Enum):
     # TODO -- Consider renaming this tag
     # The operation manipulates a tensor's shape
@@ -621,15 +623,15 @@
     utils.check(
         len(kwarg_printables) <= 1,
         lambda: f"Expected at most one kwarg for unpack_trivial but got {kwarg_printables}",
         exception_type=AssertionError,
     )
 
     result_str = "_" if bsym.output is None else f"{codeutils.prettyprint(out_printables, with_type=True)}"
-    s = f"# {result_str} {'(unused)' if bsym.output is None else ''}"
+    s = f"# {result_str}{' (unused)' if bsym.output is None else ''}"
     return s
 
 
 # Removes the inputs from unpack_trivial, so it appears to have no input
 def _unpack_trivial_bind_postprocess(bsym: BoundSymbol) -> None:
     bsym.args = ()
 
@@ -726,15 +728,33 @@
     utils.check_type(x, Sequence)
     utils.check_type(l, int)
     baseutils.check(len(x) == l, lambda x=x, l=l: f"Expected the length of {x=} to be {l=}")
 
     return list(_collectify(y) for y in x)
 
 
-# TODO Review using multi-line unpacks more cleverly
+def _make_parts_into_line_or_lines(parts: list[str], out: list[str] | None = None) -> list[str]:
+    if out is None:
+        lines = []
+    else:
+        lines = out
+    line_parts = []
+    pos = 0
+    for p in parts:
+        if pos and pos + len(p) > 80:
+            lines.append("".join(line_parts) + "\\")
+            line_parts = []
+            pos = 0
+        line_parts.append(p)
+        pos += len(p)
+
+    lines.append("".join(line_parts))
+    return lines
+
+
 # TODO Possibly put the length in the code to show the requirement
 def unpack_sequence_printer(
     bsym: BoundSymbol, out_printables: Any, arg_printables: Sequence[Printable], kwarg_printables: dict[str, Printable]
 ):
     utils.check(
         len(arg_printables) == 2,
         lambda: f"Expected two arguments for unpack_sequence but got {arg_printables}",
@@ -750,20 +770,18 @@
     x, l = arg_printables
     call_str = f"{codeutils.prettyprint(x)}"
 
     # Short-circuits if there's nothing to unpack:
     if len(bsym.output) == 0:
         return f"# {call_str} (empty sequence)"
 
-    lines = []
-    for out in out_printables:
-        line = f"{codeutils.prettyprint(out, literals_as_underscores=True)}, \\"
-        lines.append(line)
+    parts = [f"{codeutils.prettyprint(out, literals_as_underscores=True)}, " for out in out_printables]
+    parts.append(f"= {call_str}")
 
-    lines.append(f"= {call_str}")
+    lines = _make_parts_into_line_or_lines(parts)
     return lines
 
 
 def unpack_sequence_impl(x: Sequence, l: int) -> list:
     return list(x)
 
 
@@ -808,20 +826,18 @@
     (x,) = arg_printables
     call_str = f"{codeutils.prettyprint(x)}"
 
     # Short-circuits if there's nothing to unpack:
     if len(bsym.output) == 0:
         return f"# {call_str} (empty tuple)"
 
-    lines = []
-    for out in out_printables:
-        line = f"{codeutils.prettyprint(out, literals_as_underscores=True)}, \\"
-        lines.append(line)
+    parts = [f"{codeutils.prettyprint(out, literals_as_underscores=True)}, " for out in out_printables]
+    parts.append(f"= {call_str}")
 
-    lines.append(f"= {call_str}")
+    lines = _make_parts_into_line_or_lines(parts)
     return lines
 
 
 unpack_tuple = make_prim(
     PrimIDs.UNPACK_TUPLE,
     "unpack_tuple",
     meta=_unpack_tuple_meta,
@@ -861,20 +877,18 @@
     (x,) = arg_printables
     call_str = f"{codeutils.prettyprint(x)}"
 
     # Short-circuits if there's nothing to unpack:
     if len(bsym.output) == 0:
         return f"# {call_str} (empty list)"
 
-    lines = []
-    for out in out_printables:
-        line = f"{codeutils.prettyprint(out, literals_as_underscores=True)}, \\"
-        lines.append(line)
+    parts = [f"{codeutils.prettyprint(out, literals_as_underscores=True)}, " for out in out_printables]
+    parts.append(f"= {call_str}")
 
-    lines.append(f"= {call_str}")
+    lines = _make_parts_into_line_or_lines(parts)
     return lines
 
 
 unpack_list = make_prim(
     PrimIDs.UNPACK_LIST,
     "unpack_list",
     meta=_unpack_list_meta,
@@ -3011,14 +3025,41 @@
 
     return TensorProxy(like=a)
 
 
 scatter_add = make_prim(PrimIDs.SCATTER_ADD, "scatter_add", meta=scatter_add_meta)
 
 
+def topk_meta(
+    a: TensorProxy, /, k: int, dim: int, largest: Number, sorted: Number, *, out: None | TensorProxy
+) -> (TensorProxy, TensorProxy):
+    utils.check(
+        out is None,
+        lambda: "Only `out` which is None is currently supported",
+    )
+
+    utils.check_type(a, TensorProxy)
+    utils.check_type(k, int)
+    utils.check_type(dim, int)
+    utils.check(pytype(largest) is bool, lambda: f"Expected {largest=} to be a boolean value")
+    utils.check(pytype(sorted) is bool, lambda: f"Expected {sorted=} to be a boolean value")
+
+    utils.check(k >= 0 and k <= (a.shape[dim] if a.ndim > 0 else 1), lambda: f"selected index {k=} is out of range")
+
+    new_shape = a.shape
+    if a.ndim > 0:
+        new_shape = list(new_shape)
+        new_shape[dim] = k
+
+    return TensorProxy(like=a, shape=new_shape), TensorProxy(like=a, shape=new_shape, dtype=dtypes.int64)
+
+
+topk = make_prim(PrimIDs.TOPK, "topk", meta=topk_meta, tags=(OpTags.REDUCTION_OP,))
+
+
 def transpose_meta(a: TensorProxy, /, permutation: tuple[int, ...]) -> TensorProxy:
     utils.check_type(a, TensorProxy)
     utils.check_type(permutation, tuple)
     utils.check(
         a.ndim == len(permutation),
         lambda: f"Expected the length ({len(permutation)}) of the permutation={permutation} to be the number of dimensions ({a.ndim}) of a={a}",
     )
@@ -3488,7 +3529,60 @@
 # For now we just use the PyTorch implementation
 def embedding_backward_meta(grad, indices, num_weights, padding_idx, scale_grad_by_freq, sparse):
     shape = (num_weights, grad.shape[-1])
     return TensorProxy(shape=shape, device=grad.device, dtype=grad.dtype, requires_grad=False)
 
 
 embedding_backward = make_prim(PrimIDs.EMBEDDING_BACKWARD, "embedding_backward", meta=embedding_backward_meta)
+
+
+def batch_norm_meta(
+    a: TensorProxy,
+    /,
+    weight: None | TensorProxy,
+    bias: None | TensorProxy,
+    running_mean: None | TensorProxy,
+    running_var: None | TensorProxy,
+    training: bool,
+    momentum: Number,
+    eps: Number,
+) -> tuple[TensorProxy, None | TensorProxy, None | TensorProxy]:
+    # Checks types
+    utils.check_type(a, TensorProxy)
+    utils.check_type(momentum, Number)
+    utils.check_type(eps, Number)
+
+    utils.check(a.ndim >= 2, lambda: f"Input tensor must have at least batch and channel dimensions!")
+    if not training:
+        utils.check(
+            running_mean is not None and running_var is not None,
+            lambda: f"running_mean and running_var must be defined in evaluation mode",
+        )
+
+    num_features = a.shape[1]
+
+    def check_type_device_shape(param, param_name):
+        utils.check_type(param, TensorProxy)
+        utils.check_same_device(a, param)
+        utils.check(
+            param.shape == (num_features,),
+            lambda: f"Expected {param_name}.shape={param.shape} to be {(num_features,)}!",
+        )
+
+    if weight is not None:
+        check_type_device_shape(weight, "weight")
+        utils.check_same_dtype(a, weight)
+    if bias is not None:
+        check_type_device_shape(bias, "bias")
+        utils.check_same_dtype(a, bias)
+    if running_mean is not None:
+        check_type_device_shape(running_mean, "running_mean")
+    if running_var is not None:
+        check_type_device_shape(running_var, "running_var")
+    return (
+        TensorProxy(like=a),
+        (TensorProxy(like=a, shape=(num_features,)) if running_mean is None else TensorProxy(like=running_mean)),
+        (TensorProxy(like=a, shape=(num_features,)) if running_var is None else TensorProxy(like=running_var)),
+    )
+
+
+batch_norm = make_prim(PrimIDs.BATCH_NORM, "batch_norm", meta=batch_norm_meta, tags=(OpTags.REDUCTION_OP,))
```

### Comparing `lightning-thunder-0.1.0/thunder/core/profile.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/profile.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/proxies.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/proxies.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/pytree.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/pytree.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/rematerialization.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/rematerialization.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/symbol.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/symbol.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/trace.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/trace.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/transform_common.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/transform_common.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/core/transforms.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/transforms.py`

 * *Files 2% similar despite different names*

```diff
@@ -2067,6793 +2067,6704 @@
 00008120: 2072 6573 746f 7265 5f72 6564 7563 6564   restore_reduced
 00008130: 5f64 696d 7328 672c 2064 696d 732c 2061  _dims(g, dims, a
 00008140: 2e73 6861 7065 290a 2020 2020 7075 745f  .shape).    put_
 00008150: 6772 6164 2861 2c20 615f 6772 6164 290a  grad(a, a_grad).
 00008160: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
 00008170: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
 00008180: 7069 6473 2e53 554d 2c20 5f73 756d 5f70  pids.SUM, _sum_p
-00008190: 7269 6d5f 6772 6164 290a 0a0a 2320 544f  rim_grad)...# TO
-000081a0: 444f 2046 6978 2064 6976 6973 696f 6e20  DO Fix division 
-000081b0: 6279 207a 6572 6f20 7768 656e 206e 5f65  by zero when n_e
-000081c0: 6c65 6d5f 7265 6475 6365 6420 3d3d 2030  lem_reduced == 0
-000081d0: 206f 7220 7768 656e 206d 6561 6e2e 6e75   or when mean.nu
-000081e0: 6d65 6c20 3d3d 2030 0a23 2020 2062 7920  mel == 0.#   by 
-000081f0: 7265 7475 726e 696e 6720 7a65 726f 735f  returning zeros_
-00008200: 6c69 6b65 2861 2920 6f72 2073 696d 696c  like(a) or simil
-00008210: 6172 2e0a 2320 544f 444f 2046 6978 2067  ar..# TODO Fix g
-00008220: 7261 6420 7768 656e 2063 6f72 7265 6374  rad when correct
-00008230: 696f 6e20 3e20 6e5f 656c 656d 5f72 6564  ion > n_elem_red
-00008240: 7563 6564 2e0a 4074 6f72 6368 6374 780a  uced..@torchctx.
-00008250: 6465 6620 5f76 6172 5f6d 6561 6e5f 7072  def _var_mean_pr
-00008260: 696d 5f67 7261 6428 613a 2054 656e 736f  im_grad(a: Tenso
-00008270: 7250 726f 7879 2c20 2f2c 2064 696d 733a  rProxy, /, dims:
-00008280: 2053 6571 7565 6e63 655b 696e 745d 2c20   Sequence[int], 
-00008290: 2a2c 2063 6f72 7265 6374 696f 6e3a 204e  *, correction: N
-000082a0: 756d 6265 7229 202d 3e20 5465 6e73 6f72  umber) -> Tensor
-000082b0: 5072 6f78 793a 0a20 2020 2076 2c20 6d20  Proxy:.    v, m 
-000082c0: 3d20 7072 696d 732e 7661 725f 6d65 616e  = prims.var_mean
-000082d0: 2861 2c20 6469 6d73 2c20 636f 7272 6563  (a, dims, correc
-000082e0: 7469 6f6e 3d63 6f72 7265 6374 696f 6e29  tion=correction)
-000082f0: 0a0a 2020 2020 6776 203d 2067 6574 5f67  ..    gv = get_g
-00008300: 7261 6428 7629 0a20 2020 2067 6d20 3d20  rad(v).    gm = 
-00008310: 6765 745f 6772 6164 286d 290a 0a20 2020  get_grad(m)..   
-00008320: 206e 5f65 6c65 6d5f 7265 6475 6365 6420   n_elem_reduced 
-00008330: 3d20 612e 6e75 6d65 6c20 2f2f 206d 2e6e  = a.numel // m.n
-00008340: 756d 656c 2069 6620 612e 6e75 6d65 6c20  umel if a.numel 
-00008350: 213d 2030 2065 6c73 6520 310a 0a20 2020  != 0 else 1..   
-00008360: 2023 2043 6f6d 7075 7465 7320 6d65 616e   # Computes mean
-00008370: 2062 7764 0a20 2020 206d 6561 6e5f 7363   bwd.    mean_sc
-00008380: 616c 6520 3d20 312e 3020 2f20 6e5f 656c  ale = 1.0 / n_el
-00008390: 656d 5f72 6564 7563 6564 0a20 2020 206d  em_reduced.    m
-000083a0: 6561 6e5f 6772 6164 203d 206d 6561 6e5f  ean_grad = mean_
-000083b0: 7363 616c 6520 2a20 7265 7374 6f72 655f  scale * restore_
-000083c0: 7265 6475 6365 645f 6469 6d73 2867 6d2c  reduced_dims(gm,
-000083d0: 2064 696d 732c 2061 2e73 6861 7065 290a   dims, a.shape).
-000083e0: 0a20 2020 2023 2043 6f6d 7075 7465 7320  .    # Computes 
-000083f0: 7661 7220 6277 640a 2020 2020 6e6f 726d  var bwd.    norm
-00008400: 616c 697a 6174 696f 6e5f 7363 616c 6172  alization_scalar
-00008410: 203d 206e 5f65 6c65 6d5f 7265 6475 6365   = n_elem_reduce
-00008420: 6420 2d20 636f 7272 6563 7469 6f6e 0a20  d - correction. 
-00008430: 2020 2072 6573 746f 7265 645f 6776 203d     restored_gv =
-00008440: 2072 6573 746f 7265 5f72 6564 7563 6564   restore_reduced
-00008450: 5f64 696d 7328 6776 2c20 6469 6d73 2c20  _dims(gv, dims, 
-00008460: 612e 7368 6170 6529 0a20 2020 2072 6573  a.shape).    res
-00008470: 746f 7265 645f 6d65 616e 203d 2072 6573  tored_mean = res
-00008480: 746f 7265 5f72 6564 7563 6564 5f64 696d  tore_reduced_dim
-00008490: 7328 6d2c 2064 696d 732c 2061 2e73 6861  s(m, dims, a.sha
-000084a0: 7065 290a 2020 2020 7661 725f 6772 6164  pe).    var_grad
-000084b0: 203d 2028 3220 2a20 7265 7374 6f72 6564   = (2 * restored
-000084c0: 5f67 7620 2a20 2861 202d 2072 6573 746f  _gv * (a - resto
-000084d0: 7265 645f 6d65 616e 2929 202f 206e 6f72  red_mean)) / nor
-000084e0: 6d61 6c69 7a61 7469 6f6e 5f73 6361 6c61  malization_scala
-000084f0: 720a 0a20 2020 2070 7574 5f67 7261 6428  r..    put_grad(
-00008500: 612c 206d 6561 6e5f 6772 6164 202b 2076  a, mean_grad + v
-00008510: 6172 5f67 7261 6429 0a0a 2020 2020 7265  ar_grad)..    re
-00008520: 7475 726e 2076 2c20 6d0a 0a0a 7265 6769  turn v, m...regi
-00008530: 7374 6572 5f67 7261 6428 7069 6473 2e56  ster_grad(pids.V
-00008540: 4152 5f4d 4541 4e2c 205f 7661 725f 6d65  AR_MEAN, _var_me
-00008550: 616e 5f70 7269 6d5f 6772 6164 290a 0a0a  an_prim_grad)...
-00008560: 230a 2320 4c69 6e65 6172 2061 6c67 6562  #.# Linear algeb
-00008570: 7261 206f 7065 7261 746f 7220 6772 6164  ra operator grad
-00008580: 730a 230a 4074 6f72 6368 6374 780a 6465  s.#.@torchctx.de
-00008590: 6620 5f6c 696e 6561 725f 7072 696d 5f67  f _linear_prim_g
-000085a0: 7261 6428 613a 2054 656e 736f 7250 726f  rad(a: TensorPro
-000085b0: 7879 2c20 773a 2054 656e 736f 7250 726f  xy, w: TensorPro
-000085c0: 7879 2c20 6269 6173 3a20 4e6f 6e65 207c  xy, bias: None |
-000085d0: 2054 656e 736f 7250 726f 7879 2920 2d3e   TensorProxy) ->
-000085e0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
-000085f0: 2020 6677 6420 3d20 7072 696d 732e 6c69    fwd = prims.li
-00008600: 6e65 6172 2861 2c20 772c 2062 6961 7329  near(a, w, bias)
-00008610: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
-00008620: 6164 2866 7764 290a 0a20 2020 2066 6972  ad(fwd)..    fir
-00008630: 7374 5f64 696d 203d 202d 320a 2020 2020  st_dim = -2.    
-00008640: 6772 6164 5f61 203d 206c 746f 7263 682e  grad_a = ltorch.
-00008650: 6d61 746d 756c 2867 2e72 6573 6861 7065  matmul(g.reshape
-00008660: 282d 312c 2067 2e73 6861 7065 5b2d 315d  (-1, g.shape[-1]
-00008670: 292c 2077 292e 7265 7368 6170 6528 612e  ), w).reshape(a.
-00008680: 7368 6170 6529 0a0a 2020 2020 6772 6164  shape)..    grad
-00008690: 5f77 3a20 5465 6e73 6f72 5072 6f78 790a  _w: TensorProxy.
-000086a0: 2020 2020 6966 2061 2e6e 6469 6d20 3d3d      if a.ndim ==
-000086b0: 2031 3a0a 2020 2020 2020 2020 6772 6164   1:.        grad
-000086c0: 5f77 203d 206c 746f 7263 682e 6d61 746d  _w = ltorch.matm
-000086d0: 756c 2867 2e75 6e73 7175 6565 7a65 2866  ul(g.unsqueeze(f
-000086e0: 6972 7374 5f64 696d 292e 6d54 2c20 612e  irst_dim).mT, a.
-000086f0: 756e 7371 7565 657a 6528 6669 7273 745f  unsqueeze(first_
-00008700: 6469 6d29 290a 2020 2020 656c 7365 3a0a  dim)).    else:.
-00008710: 2020 2020 2020 2020 6772 6164 5f77 203d          grad_w =
-00008720: 206c 746f 7263 682e 6d61 746d 756c 2867   ltorch.matmul(g
-00008730: 2e72 6573 6861 7065 282d 312c 2067 2e73  .reshape(-1, g.s
-00008740: 6861 7065 5b2d 315d 292e 6d54 2c20 612e  hape[-1]).mT, a.
-00008750: 7265 7368 6170 6528 2d31 2c20 612e 7368  reshape(-1, a.sh
-00008760: 6170 655b 2d31 5d29 290a 0a20 2020 2070  ape[-1]))..    p
-00008770: 7574 5f67 7261 6473 2828 612c 2077 292c  ut_grads((a, w),
-00008780: 2028 6772 6164 5f61 2c20 6772 6164 5f77   (grad_a, grad_w
-00008790: 2929 0a0a 2020 2020 6966 2062 6961 7320  ))..    if bias 
-000087a0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-000087b0: 2020 2020 2069 6620 672e 6e64 696d 203e       if g.ndim >
-000087c0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-000087d0: 6772 6164 5f62 6961 7320 3d20 6c74 6f72  grad_bias = ltor
-000087e0: 6368 2e73 756d 2867 2c20 7475 706c 6528  ch.sum(g, tuple(
-000087f0: 7261 6e67 6528 672e 6e64 696d 202d 2031  range(g.ndim - 1
-00008800: 2929 290a 2020 2020 2020 2020 656c 7365  ))).        else
-00008810: 3a0a 2020 2020 2020 2020 2020 2020 6772  :.            gr
-00008820: 6164 5f62 6961 7320 3d20 670a 2020 2020  ad_bias = g.    
-00008830: 2020 2020 7075 745f 6772 6164 2862 6961      put_grad(bia
-00008840: 732c 2067 7261 645f 6269 6173 290a 0a20  s, grad_bias).. 
-00008850: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-00008860: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-00008870: 6473 2e4c 494e 4541 522c 205f 6c69 6e65  ds.LINEAR, _line
-00008880: 6172 5f70 7269 6d5f 6772 6164 290a 0a0a  ar_prim_grad)...
-00008890: 2320 544f 444f 2041 6464 2065 7870 6c69  # TODO Add expli
-000088a0: 6369 7420 6c74 6f72 6368 2076 7320 636c  cit ltorch vs cl
-000088b0: 616e 6720 6d6f 6475 6c65 2074 6f20 7468  ang module to th
-000088c0: 6520 7465 6e73 6f72 206f 7065 7261 7469  e tensor operati
-000088d0: 6f6e 7320 6265 6c6f 770a 2320 544f 444f  ons below.# TODO
-000088e0: 2063 6f75 6c64 2077 6520 6765 7420 7269   could we get ri
-000088f0: 6420 6f66 2074 6865 2066 696e 616c 2073  d of the final s
-00008900: 7175 6565 7a65 7320 696e 2074 6865 2062  queezes in the b
-00008910: 2e6e 6469 6d20 3d3d 2031 2063 6173 6520  .ndim == 1 case 
-00008920: 616e 6420 7468 6520 612e 6e64 696d 203d  and the a.ndim =
-00008930: 3d20 3120 6361 7365 3f0a 4074 6f72 6368  = 1 case?.@torch
-00008940: 6374 780a 6465 6620 5f6d 6174 6d75 6c5f  ctx.def _matmul_
-00008950: 7072 696d 5f67 7261 6428 613a 2054 656e  prim_grad(a: Ten
-00008960: 736f 7250 726f 7879 2c20 623a 2054 656e  sorProxy, b: Ten
-00008970: 736f 7250 726f 7879 2c20 2f29 202d 3e20  sorProxy, /) -> 
-00008980: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00008990: 2066 7764 203d 2070 7269 6d73 2e6d 6174   fwd = prims.mat
-000089a0: 6d75 6c28 612c 2062 290a 2020 2020 6720  mul(a, b).    g 
-000089b0: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
-000089c0: 0a20 2020 206c 6173 745f 6469 6d20 3d20  .    last_dim = 
-000089d0: 282d 312c 290a 2020 2020 6669 7273 745f  (-1,).    first_
-000089e0: 6469 6d20 3d20 282d 322c 290a 2020 2020  dim = (-2,).    
-000089f0: 6966 2061 2e6e 6469 6d20 3d3d 2031 2061  if a.ndim == 1 a
-00008a00: 6e64 2062 2e6e 6469 6d20 3d3d 2031 3a0a  nd b.ndim == 1:.
-00008a10: 2020 2020 2020 2020 7075 745f 6772 6164          put_grad
-00008a20: 7328 2861 2c20 6229 2c20 2867 202a 2062  s((a, b), (g * b
-00008a30: 2c20 6720 2a20 6129 290a 2020 2020 656c  , g * a)).    el
-00008a40: 6966 2062 2e6e 6469 6d20 3d3d 2031 3a0a  if b.ndim == 1:.
-00008a50: 2020 2020 2020 2020 6761 203d 2075 6e73          ga = uns
-00008a60: 7175 6565 7a65 2867 2c20 6c61 7374 5f64  queeze(g, last_d
-00008a70: 696d 2920 4020 756e 7371 7565 657a 6528  im) @ unsqueeze(
-00008a80: 622c 206c 6173 745f 6469 6d29 2e6d 540a  b, last_dim).mT.
-00008a90: 2020 2020 2020 2020 6762 203d 2061 2e6d          gb = a.m
-00008aa0: 5420 4020 756e 7371 7565 657a 6528 672c  T @ unsqueeze(g,
-00008ab0: 206c 6173 745f 6469 6d29 0a20 2020 2020   last_dim).     
-00008ac0: 2020 2069 6620 672e 6e64 696d 203e 2031     if g.ndim > 1
-00008ad0: 3a0a 2020 2020 2020 2020 2020 2020 6762  :.            gb
-00008ae0: 203d 2073 7175 6565 7a65 2867 622c 206c   = squeeze(gb, l
-00008af0: 6173 745f 6469 6d29 0a20 2020 2020 2020  ast_dim).       
-00008b00: 2020 2020 2067 6220 3d20 6c74 6f72 6368       gb = ltorch
-00008b10: 2e73 756d 2867 622c 2074 7570 6c65 2872  .sum(gb, tuple(r
-00008b20: 616e 6765 2867 622e 6e64 696d 202d 2031  ange(gb.ndim - 1
-00008b30: 2929 290a 2020 2020 2020 2020 7075 745f  ))).        put_
-00008b40: 6772 6164 7328 2861 2c20 6229 2c20 2867  grads((a, b), (g
-00008b50: 612c 2067 622e 7371 7565 657a 6528 2929  a, gb.squeeze())
-00008b60: 290a 2020 2020 656c 6966 2061 2e6e 6469  ).    elif a.ndi
-00008b70: 6d20 3d3d 2031 3a0a 2020 2020 2020 2020  m == 1:.        
-00008b80: 6761 203d 2075 6e73 7175 6565 7a65 2867  ga = unsqueeze(g
-00008b90: 2c20 6669 7273 745f 6469 6d29 2040 2062  , first_dim) @ b
-00008ba0: 2e6d 540a 2020 2020 2020 2020 6966 2067  .mT.        if g
-00008bb0: 2e6e 6469 6d20 3e20 313a 0a20 2020 2020  .ndim > 1:.     
-00008bc0: 2020 2020 2020 2067 6120 3d20 6c74 6f72         ga = ltor
-00008bd0: 6368 2e73 756d 2867 612c 2074 7570 6c65  ch.sum(ga, tuple
-00008be0: 2872 616e 6765 2867 612e 6e64 696d 202d  (range(ga.ndim -
-00008bf0: 2031 2929 290a 2020 2020 2020 2020 6762   1))).        gb
-00008c00: 203d 2075 6e73 7175 6565 7a65 2861 2c20   = unsqueeze(a, 
-00008c10: 6669 7273 745f 6469 6d29 2e6d 5420 4020  first_dim).mT @ 
-00008c20: 756e 7371 7565 657a 6528 672c 2066 6972  unsqueeze(g, fir
-00008c30: 7374 5f64 696d 290a 2020 2020 2020 2020  st_dim).        
-00008c40: 7075 745f 6772 6164 7328 2861 2c20 6229  put_grads((a, b)
-00008c50: 2c20 2867 612e 7371 7565 657a 6528 292c  , (ga.squeeze(),
-00008c60: 2067 6229 290a 2020 2020 656c 7365 3a0a   gb)).    else:.
-00008c70: 2020 2020 2020 2020 7075 745f 6772 6164          put_grad
-00008c80: 7328 2861 2c20 6229 2c20 2867 2040 2062  s((a, b), (g @ b
-00008c90: 2e6d 542c 2061 2e6d 5420 4020 6729 290a  .mT, a.mT @ g)).
-00008ca0: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
-00008cb0: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
-00008cc0: 7069 6473 2e4d 4154 4d55 4c2c 205f 6d61  pids.MATMUL, _ma
-00008cd0: 746d 756c 5f70 7269 6d5f 6772 6164 290a  tmul_prim_grad).
-00008ce0: 0a23 0a23 204e 4e20 6f70 6572 6174 6f72  .#.# NN operator
-00008cf0: 2067 7261 6473 0a23 0a0a 0a40 746f 7263   grads.#...@torc
-00008d00: 6863 7478 0a64 6566 205f 656d 6265 6464  hctx.def _embedd
-00008d10: 696e 675f 7072 696d 5f67 7261 6428 0a20  ing_prim_grad(. 
-00008d20: 2020 2061 3a20 5465 6e73 6f72 5072 6f78     a: TensorProx
-00008d30: 792c 202f 2c20 7765 6967 6874 2c20 2a2c  y, /, weight, *,
-00008d40: 2070 6164 6469 6e67 5f69 6478 3d2d 312c   padding_idx=-1,
-00008d50: 206d 6178 5f6e 6f72 6d3d 4e6f 6e65 2c20   max_norm=None, 
-00008d60: 6e6f 726d 5f74 7970 653d 322e 302c 2073  norm_type=2.0, s
-00008d70: 6361 6c65 5f67 7261 645f 6279 5f66 7265  cale_grad_by_fre
-00008d80: 713d 4661 6c73 652c 2073 7061 7273 653d  q=False, sparse=
-00008d90: 4661 6c73 650a 2920 2d3e 2054 656e 736f  False.) -> Tenso
-00008da0: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
-00008db0: 3d20 7072 696d 732e 656d 6265 6464 696e  = prims.embeddin
-00008dc0: 6728 0a20 2020 2020 2020 2061 2c0a 2020  g(.        a,.  
-00008dd0: 2020 2020 2020 7765 6967 6874 2c0a 2020        weight,.  
-00008de0: 2020 2020 2020 7061 6464 696e 675f 6964        padding_id
-00008df0: 783d 7061 6464 696e 675f 6964 782c 0a20  x=padding_idx,. 
-00008e00: 2020 2020 2020 206d 6178 5f6e 6f72 6d3d         max_norm=
-00008e10: 6d61 785f 6e6f 726d 2c0a 2020 2020 2020  max_norm,.      
-00008e20: 2020 6e6f 726d 5f74 7970 653d 6e6f 726d    norm_type=norm
-00008e30: 5f74 7970 652c 0a20 2020 2020 2020 2073  _type,.        s
-00008e40: 6361 6c65 5f67 7261 645f 6279 5f66 7265  cale_grad_by_fre
-00008e50: 713d 7363 616c 655f 6772 6164 5f62 795f  q=scale_grad_by_
-00008e60: 6672 6571 2c0a 2020 2020 2020 2020 7370  freq,.        sp
-00008e70: 6172 7365 3d73 7061 7273 652c 0a20 2020  arse=sparse,.   
-00008e80: 2029 0a0a 2020 2020 6720 3d20 6765 745f   )..    g = get_
-00008e90: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
-00008ea0: 6772 6164 203d 2070 7269 6d73 2e65 6d62  grad = prims.emb
-00008eb0: 6564 6469 6e67 5f62 6163 6b77 6172 6428  edding_backward(
-00008ec0: 672c 2061 2c20 7765 6967 6874 2e73 6861  g, a, weight.sha
-00008ed0: 7065 5b30 5d2c 2070 6164 6469 6e67 5f69  pe[0], padding_i
-00008ee0: 6478 2c20 7363 616c 655f 6772 6164 5f62  dx, scale_grad_b
-00008ef0: 795f 6672 6571 2c20 7370 6172 7365 290a  y_freq, sparse).
-00008f00: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-00008f10: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
-00008f20: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00008f30: 6572 5f67 7261 6428 7069 6473 2e45 4d42  er_grad(pids.EMB
-00008f40: 4544 4449 4e47 2c20 5f65 6d62 6564 6469  EDDING, _embeddi
-00008f50: 6e67 5f70 7269 6d5f 6772 6164 290a 0a23  ng_prim_grad)..#
-00008f60: 0a23 2050 6861 6e74 6f6d 2067 7261 6420  .# Phantom grad 
-00008f70: 7472 616e 7366 6f72 6d20 6865 6c70 6572  transform helper
-00008f80: 730a 230a 0a0a 6465 6620 5f67 6574 5f67  s.#...def _get_g
-00008f90: 7261 6466 6e28 6273 796d 3a20 426f 756e  radfn(bsym: Boun
-00008fa0: 6453 796d 626f 6c2c 202a 2c20 6578 6563  dSymbol, *, exec
-00008fb0: 7574 6f72 735f 6c69 7374 3a20 5365 7175  utors_list: Sequ
-00008fc0: 656e 6365 5b41 6e79 5d20 3d20 7475 706c  ence[Any] = tupl
-00008fd0: 6528 2929 202d 3e20 4e6f 6e65 207c 2043  e()) -> None | C
-00008fe0: 616c 6c61 626c 653a 0a20 2020 2023 2049  allable:.    # I
-00008ff0: 6620 6578 6563 7574 6f72 2073 7065 6369  f executor speci
-00009000: 6669 6320 6061 7567 5f66 7764 5f72 756c  fic `aug_fwd_rul
-00009010: 6560 2065 7869 7374 7320 7468 656e 2077  e` exists then w
-00009020: 6520 7769 6c6c 2075 7365 2074 6861 742c  e will use that,
-00009030: 0a20 2020 2023 2073 6f20 7765 2072 6574  .    # so we ret
-00009040: 7572 6e20 604e 6f6e 6560 2068 6572 652e  urn `None` here.
-00009050: 0a20 2020 2069 6620 6765 745f 6578 6563  .    if get_exec
-00009060: 7574 6f72 5f73 7065 6369 6669 635f 6175  utor_specific_au
-00009070: 675f 6677 645f 7275 6c65 2862 7379 6d29  g_fwd_rule(bsym)
-00009080: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00009090: 204e 6f6e 650a 0a20 2020 2063 6420 3d20   None..    cd = 
-000090a0: 6765 745f 636f 6d70 696c 655f 6461 7461  get_compile_data
-000090b0: 2829 0a20 2020 2065 7865 6375 746f 7273  ().    executors
-000090c0: 5f6c 6973 7420 3d20 6364 2e65 7865 6375  _list = cd.execu
-000090d0: 746f 7273 5f6c 6973 7420 6966 2063 6420  tors_list if cd 
-000090e0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
-000090f0: 2065 7865 6375 746f 7273 5f6c 6973 740a   executors_list.
-00009100: 2020 2020 2320 4368 6563 6b73 2069 6620      # Checks if 
-00009110: 7468 6520 6578 6563 7574 6f72 2077 6869  the executor whi
-00009120: 6368 2068 6173 2070 7269 6f72 6974 7920  ch has priority 
-00009130: 666f 7220 7468 6973 206f 7065 7261 7469  for this operati
-00009140: 6f6e 2068 6173 2061 2073 7065 6369 6669  on has a specifi
-00009150: 6320 6772 6164 2074 7261 6e73 666f 726d  c grad transform
-00009160: 2066 6f72 2069 740a 2020 2020 666f 7220   for it.    for 
-00009170: 6578 2069 6e20 6578 6563 7574 6f72 735f  ex in executors_
-00009180: 6c69 7374 3a0a 2020 2020 2020 2020 6966  list:.        if
-00009190: 2065 782e 6361 6e5f 6578 6563 7574 655f   ex.can_execute_
-000091a0: 6f72 5f66 7573 6528 6273 796d 293a 0a20  or_fuse(bsym):. 
-000091b0: 2020 2020 2020 2020 2020 2065 785f 6772             ex_gr
-000091c0: 6164 5f74 7261 6e73 666f 726d 3a20 4e6f  ad_transform: No
-000091d0: 6e65 207c 2043 616c 6c61 626c 6520 3d20  ne | Callable = 
-000091e0: 6578 2e67 6574 5f67 7261 645f 7472 616e  ex.get_grad_tran
-000091f0: 7366 6f72 6d28 6273 796d 2e73 796d 290a  sform(bsym.sym).
-00009200: 2020 2020 2020 2020 2020 2020 6966 2065              if e
-00009210: 785f 6772 6164 5f74 7261 6e73 666f 726d  x_grad_transform
-00009220: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00009230: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00009240: 7475 726e 2065 785f 6772 6164 5f74 7261  turn ex_grad_tra
-00009250: 6e73 666f 726d 0a20 2020 2020 2020 2020  nsform.         
-00009260: 2020 2062 7265 616b 0a0a 2020 2020 2320     break..    # 
-00009270: 4966 2074 6865 2065 7865 6375 746f 7220  If the executor 
-00009280: 646f 6573 6e27 7420 6465 6669 6e65 2069  doesn't define i
-00009290: 7473 206f 776e 2067 7261 6420 7472 616e  ts own grad tran
-000092a0: 7366 6f72 6d2c 2074 6869 7320 6a75 7374  sform, this just
-000092b0: 2072 6574 7572 6e73 2074 6865 2064 6566   returns the def
-000092c0: 6175 6c74 2067 7261 6420 7472 616e 7366  ault grad transf
-000092d0: 6f72 6d20 666f 7220 7468 6520 6273 796d  orm for the bsym
-000092e0: 0a20 2020 2067 7261 6466 6e20 3d20 5f67  .    gradfn = _g
-000092f0: 7261 645f 666e 5f6d 6170 2e67 6574 2862  rad_fn_map.get(b
-00009300: 7379 6d2e 7379 6d2e 6964 2c20 4e6f 6e65  sym.sym.id, None
-00009310: 290a 2020 2020 7265 7475 726e 2067 7261  ).    return gra
-00009320: 6466 6e0a 0a0a 2320 5468 6520 6465 6661  dfn...# The defa
-00009330: 756c 7420 6772 6164 2073 7065 6369 6669  ult grad specifi
-00009340: 6572 2066 6f72 2074 6865 2067 7261 6420  er for the grad 
-00009350: 7472 616e 7366 6f72 6d0a 2320 2020 466f  transform.#   Fo
-00009360: 7220 6561 6368 2074 656e 736f 7220 6f75  r each tensor ou
-00009370: 7470 7574 2022 6f22 2072 6571 7569 7269  tput "o" requiri
-00009380: 6e67 2067 7261 642c 2073 7065 6369 6669  ng grad, specifi
-00009390: 6573 2061 2067 7261 6420 6f66 206f 6e65  es a grad of one
-000093a0: 735f 6c69 6b65 286f 290a 6465 6620 5f67  s_like(o).def _g
-000093b0: 7261 645f 7370 6563 6966 6965 725f 6465  rad_specifier_de
-000093c0: 6661 756c 7428 7079 7472 6565 3a20 416e  fault(pytree: An
-000093d0: 7929 202d 3e20 4e6f 6e65 3a0a 2020 2020  y) -> None:.    
-000093e0: 666c 6174 732c 205f 203d 2074 7265 655f  flats, _ = tree_
-000093f0: 666c 6174 7465 6e28 7079 7472 6565 290a  flatten(pytree).
-00009400: 0a20 2020 2066 6f72 2066 2069 6e20 666c  .    for f in fl
-00009410: 6174 733a 0a20 2020 2020 2020 2069 6620  ats:.        if 
-00009420: 6973 696e 7374 616e 6365 2866 2c20 5465  isinstance(f, Te
-00009430: 6e73 6f72 5072 6f78 7929 2061 6e64 2066  nsorProxy) and f
-00009440: 2e72 6571 7569 7265 735f 6772 6164 3a0a  .requires_grad:.
-00009450: 2020 2020 2020 2020 2020 2020 2320 4e4f              # NO
-00009460: 5445 2054 6869 7320 7573 6573 2063 6c61  TE This uses cla
-00009470: 6e67 2e6f 6e65 735f 6c69 6b65 2066 6f72  ng.ones_like for
-00009480: 206e 6f77 2062 6563 6175 7365 206c 746f   now because lto
-00009490: 7263 682e 6f6e 6573 5f6c 696b 6520 7769  rch.ones_like wi
-000094a0: 6c6c 2065 7874 656e 6420 7468 650a 2020  ll extend the.  
-000094b0: 2020 2020 2020 2020 2020 2320 2020 6c69            #   li
-000094c0: 6665 7469 6d65 206f 6620 662c 2077 6869  fetime of f, whi
-000094d0: 6c65 2063 6c61 6e67 2e6f 6e65 735f 6c69  le clang.ones_li
-000094e0: 6b65 2077 696c 6c20 6578 7472 6163 7420  ke will extract 
-000094f0: 7468 6520 6d65 7461 6461 7461 206f 6620  the metadata of 
-00009500: 6620 6174 2074 7261 6365 2074 696d 650a  f at trace time.
-00009510: 2020 2020 2020 2020 2020 2020 7072 696d              prim
-00009520: 732e 7075 745f 6772 6164 2866 2c20 636c  s.put_grad(f, cl
-00009530: 616e 672e 6675 6c6c 5f6c 696b 6528 662c  ang.full_like(f,
-00009540: 2031 2e30 2929 0a0a 0a23 2054 4f44 4f20   1.0))...# TODO 
-00009550: 5465 7374 2077 6974 6820 6275 6666 6572  Test with buffer
-00009560: 730a 6465 6620 5f67 7261 645f 6f75 745f  s.def _grad_out_
-00009570: 7370 6563 6966 6965 725f 6465 6661 756c  specifier_defaul
-00009580: 7428 7079 7472 6565 3a20 416e 7929 202d  t(pytree: Any) -
-00009590: 3e20 6c69 7374 5b54 656e 736f 7250 726f  > list[TensorPro
-000095a0: 7879 5d3a 0a20 2020 2066 6c61 7473 2c20  xy]:.    flats, 
-000095b0: 5f20 3d20 7472 6565 5f66 6c61 7474 656e  _ = tree_flatten
-000095c0: 2870 7974 7265 6529 0a20 2020 2067 7261  (pytree).    gra
-000095d0: 6473 203d 206c 6973 7428 5b70 7269 6d73  ds = list([prims
-000095e0: 2e67 6574 5f67 7261 6428 6629 2066 6f72  .get_grad(f) for
-000095f0: 2066 2069 6e20 666c 6174 7320 6966 2069   f in flats if i
-00009600: 7369 6e73 7461 6e63 6528 662c 2054 656e  sinstance(f, Ten
-00009610: 736f 7250 726f 7879 2920 616e 6420 662e  sorProxy) and f.
-00009620: 7265 7175 6972 6573 5f67 7261 645d 290a  requires_grad]).
-00009630: 2020 2020 7265 7475 726e 2067 7261 6473      return grads
-00009640: 0a0a 0a23 2054 4f44 4f20 466f 726d 616c  ...# TODO Formal
-00009650: 6c79 2064 6566 696e 6520 7468 6520 2267  ly define the "g
-00009660: 7261 6469 656e 7422 206f 6620 6120 7465  radient" of a te
-00009670: 6e73 6f72 0a23 2054 4f44 4f20 4966 206e  nsor.# TODO If n
-00009680: 6f6e 6520 6f66 2074 6865 2069 6e70 7574  one of the input
-00009690: 7320 746f 2061 6e20 6f70 6572 6174 696f  s to an operatio
-000096a0: 6e20 7265 7175 6972 6520 6772 6164 2c20  n require grad, 
-000096b0: 7468 656e 2077 6520 636f 756c 6420 6c65  then we could le
-000096c0: 6176 6520 7468 6174 206f 7065 7261 7469  ave that operati
-000096d0: 6f6e 2061 6c6f 6e65 0a23 2020 2054 6869  on alone.#   Thi
-000096e0: 7320 636f 756c 6420 6163 7475 616c 6c79  s could actually
-000096f0: 2069 6d70 726f 7665 2070 6572 666f 726d   improve perform
-00009700: 616e 6365 2069 6620 7468 6520 6f70 6572  ance if the oper
-00009710: 6174 696f 6e20 7065 7266 6f72 6d73 2065  ation performs e
-00009720: 7874 7261 2063 6f6d 7075 7461 7469 6f6e  xtra computation
-00009730: 7320 696e 2069 7473 2067 7261 6420 7472  s in its grad tr
-00009740: 616e 7366 6f72 6d0a 2320 2020 4120 776f  ansform.#   A wo
-00009750: 726b 6172 6f75 6e64 2066 6f72 2074 6869  rkaround for thi
-00009760: 7320 776f 756c 6420 6265 2066 6f72 2074  s would be for t
-00009770: 6865 206f 7065 7261 7469 6f6e 2069 7473  he operation its
-00009780: 656c 6620 746f 2063 6865 636b 2069 6620  elf to check if 
-00009790: 6974 7320 696e 7075 7420 7265 7175 6972  its input requir
-000097a0: 6573 2067 7261 6420 6f72 206e 6f74 0a23  es grad or not.#
-000097b0: 2054 7261 6e73 666f 726d 7320 6120 6675   Transforms a fu
-000097c0: 6e63 7469 6f6e 2074 6f20 636f 6d70 7574  nction to comput
-000097d0: 6520 7468 6520 2267 7261 6469 656e 7422  e the "gradient"
-000097e0: 206f 6620 6974 7320 696e 7075 7473 2072   of its inputs r
-000097f0: 6571 7569 7269 6e67 2067 7261 642c 2070  equiring grad, p
-00009800: 6f73 7369 626c 790a 2320 2020 6d6f 6469  ossibly.#   modi
-00009810: 6669 6564 2062 7920 7468 6520 6772 6164  fied by the grad
-00009820: 2073 7065 6369 6669 6572 7320 2873 6565   specifiers (see
-00009830: 2062 656c 6f77 292e 0a23 2054 6865 206f   below)..# The o
-00009840: 7074 696f 6e61 6c20 6772 6164 5f73 7065  ptional grad_spe
-00009850: 6369 6669 6572 2061 7267 756d 656e 7420  cifier argument 
-00009860: 6163 6365 7074 7320 7468 6520 6675 6e63  accepts the func
-00009870: 7469 6f6e 2773 206f 7574 7075 742c 2072  tion's output, r
-00009880: 756e 7320 696e 2061 206e 6f2d 6772 6164  uns in a no-grad
-00009890: 2063 6f6e 7465 7874 2c0a 2320 2020 616e   context,.#   an
-000098a0: 6420 6361 6e20 7075 7420 6772 6164 7320  d can put grads 
-000098b0: 2875 7369 6e67 2070 7269 6d73 2e70 7574  (using prims.put
-000098c0: 5f67 7261 6428 2929 2066 6f72 2074 656e  _grad()) for ten
-000098d0: 736f 7273 2e20 4279 2064 6566 6175 6c74  sors. By default
-000098e0: 2c20 666f 7220 6576 6572 7920 7465 6e73  , for every tens
-000098f0: 6f72 206f 7574 7075 7420 226f 220a 2320  or output "o".# 
-00009900: 2020 7468 6174 2072 6571 7569 7265 7320    that requires 
-00009910: 6772 6164 2c20 6120 6772 6164 206f 6620  grad, a grad of 
-00009920: 6f6e 6573 5f6c 696b 6528 6f29 2069 7320  ones_like(o) is 
-00009930: 7075 742e 0a23 2054 6865 206f 7074 696f  put..# The optio
-00009940: 6e61 6c20 6772 6164 5f6f 7574 5f73 7065  nal grad_out_spe
-00009950: 6369 6669 6572 2061 6363 6570 7473 2074  cifier accepts t
-00009960: 6865 2066 756e 6374 696f 6e27 7320 696e  he function's in
-00009970: 7075 7420 616e 6420 6361 6e20 6361 6c6c  put and can call
-00009980: 2070 7269 6d73 2e67 6574 5f67 7261 6428   prims.get_grad(
-00009990: 2920 746f 0a23 2020 2061 6371 7569 7265  ) to.#   acquire
-000099a0: 2061 6e64 2072 6574 7572 6e20 6772 6164   and return grad
-000099b0: 6965 6e74 7320 6173 2064 6573 6972 6564  ients as desired
-000099c0: 2e20 4279 2064 6566 6175 6c74 2c20 7468  . By default, th
-000099d0: 6520 696e 7075 7420 6973 2066 6c61 7474  e input is flatt
-000099e0: 656e 6564 0a23 2020 2028 7472 6565 5f66  ened.#   (tree_f
-000099f0: 6c61 7474 656e 2861 7267 732c 206b 7761  latten(args, kwa
-00009a00: 7267 7329 2920 616e 6420 6120 666c 6174  rgs)) and a flat
-00009a10: 206c 6973 7420 6f66 2067 7261 6473 2066   list of grads f
-00009a20: 6f72 2061 6c6c 2074 656e 736f 7273 2072  or all tensors r
-00009a30: 6571 7569 7269 6e67 2067 7261 640a 2320  equiring grad.# 
-00009a40: 2020 616e 6420 4e6f 6e65 2066 6f72 206f    and None for o
-00009a50: 7468 6572 2069 6e70 7574 7320 6973 2072  ther inputs is r
-00009a60: 6574 7572 6e65 642e 0a23 2054 6865 2061  eturned..# The a
-00009a70: 6c67 6f72 6974 686d 2066 6f72 206d 6f64  lgorithm for mod
-00009a80: 6966 7969 6e67 2074 6865 2070 726f 6772  ifying the progr
-00009a90: 616d 2068 6173 2074 6865 2066 6f6c 6c6f  am has the follo
-00009aa0: 7769 6e67 2073 7465 7073 3a0a 2320 2020  wing steps:.#   
-00009ab0: 3129 2046 6c61 7474 656e 7320 7468 6520  1) Flattens the 
-00009ac0: 6f72 6967 696e 616c 2074 7261 6365 2066  original trace f
-00009ad0: 6f72 2074 6865 2067 7261 6420 7472 616e  or the grad tran
-00009ae0: 7366 6f72 6d20 2d2d 2065 6e73 7569 6e67  sform -- ensuing
-00009af0: 2074 6861 7420 616c 6c20 746f 702d 6c65   that all top-le
-00009b00: 7665 6c20 7379 6d62 6f6c 7320 6861 7665  vel symbols have
-00009b10: 0a23 2020 2020 2020 2061 2067 7261 6420  .#       a grad 
-00009b20: 6675 6e63 7469 6f6e 2e0a 6465 6620 6772  function..def gr
-00009b30: 6164 280a 2020 2020 6366 6e2c 2067 7261  ad(.    cfn, gra
-00009b40: 645f 7370 6563 6966 6965 723a 2043 616c  d_specifier: Cal
-00009b50: 6c61 626c 6520 3d20 5f67 7261 645f 7370  lable = _grad_sp
-00009b60: 6563 6966 6965 725f 6465 6661 756c 742c  ecifier_default,
-00009b70: 2067 7261 645f 6f75 745f 7370 6563 6966   grad_out_specif
-00009b80: 6965 723a 2043 616c 6c61 626c 6520 3d20  ier: Callable = 
-00009b90: 5f67 7261 645f 6f75 745f 7370 6563 6966  _grad_out_specif
-00009ba0: 6965 725f 6465 6661 756c 740a 2920 2d3e  ier_default.) ->
-00009bb0: 2043 616c 6c61 626c 653a 0a20 2020 2023   Callable:.    #
-00009bc0: 2043 7265 6174 6573 2061 2063 7573 746f   Creates a custo
-00009bd0: 6d20 7472 616e 7366 6f72 6d20 6361 6c6c  m transform call
-00009be0: 6162 6c65 2074 6861 7420 6269 6e64 7320  able that binds 
-00009bf0: 7468 6520 6164 6469 7469 6f6e 616c 2061  the additional a
-00009c00: 7267 756d 656e 7473 2074 6f20 7468 6520  rguments to the 
-00009c10: 6772 6164 2074 7261 6e73 666f 726d 0a20  grad transform. 
-00009c20: 2020 2040 6c61 6e67 6374 7828 4c61 6e67     @langctx(Lang
-00009c30: 7561 6765 732e 434c 414e 4729 0a20 2020  uages.CLANG).   
-00009c40: 2064 6566 205f 6772 6164 5f74 7261 6e73   def _grad_trans
-00009c50: 666f 726d 2874 7263 3a20 5472 6163 652c  form(trc: Trace,
-00009c60: 202a 2c20 6578 6563 7574 6f72 735f 6c69   *, executors_li
-00009c70: 7374 3a20 5365 7175 656e 6365 5b41 6e79  st: Sequence[Any
-00009c80: 5d29 202d 3e20 5472 6163 653a 0a20 2020  ]) -> Trace:.   
-00009c90: 2020 2020 2073 7461 7274 5f74 696d 655f       start_time_
-00009ca0: 6e73 203d 2074 696d 652e 7469 6d65 5f6e  ns = time.time_n
-00009cb0: 7328 290a 0a20 2020 2020 2020 2023 2053  s()..        # S
-00009cc0: 5445 5020 4f4e 4520 2d2d 2046 6c61 7474  TEP ONE -- Flatt
-00009cd0: 656e 7320 616e 6420 6463 6573 0a0a 2020  ens and dces..  
-00009ce0: 2020 2020 2020 2320 5265 7475 726e 7320        # Returns 
-00009cf0: 5472 7565 2069 6620 7468 6520 6273 796d  True if the bsym
-00009d00: 2068 6173 206e 6f20 6772 6164 2066 756e   has no grad fun
-00009d10: 6374 696f 6e2c 2061 6e64 2073 6f20 6d75  ction, and so mu
-00009d20: 7374 2062 6520 666c 6174 7465 6e65 6420  st be flattened 
-00009d30: 666f 7220 7468 6520 6772 6164 2074 7261  for the grad tra
-00009d40: 6e73 666f 726d 0a20 2020 2020 2020 206e  nsform.        n
-00009d50: 6576 6572 5f66 6c61 7474 656e 3a20 7365  ever_flatten: se
-00009d60: 745b 4861 7368 6162 6c65 5d20 3d20 7b70  t[Hashable] = {p
-00009d70: 7269 6d73 2e50 7269 6d49 4473 2e52 4554  rims.PrimIDs.RET
-00009d80: 5552 4e2c 2070 7269 6d73 2e50 7269 6d49  URN, prims.PrimI
-00009d90: 4473 2e55 4e50 4143 4b5f 5452 4956 4941  Ds.UNPACK_TRIVIA
-00009da0: 4c7d 0a0a 2020 2020 2020 2020 6465 6620  L}..        def 
-00009db0: 7368 6f75 6c64 5f66 6c61 7474 656e 5f66  should_flatten_f
-00009dc0: 6f72 5f67 7261 6428 6273 796d 3a20 426f  or_grad(bsym: Bo
-00009dd0: 756e 6453 796d 626f 6c29 202d 3e20 626f  undSymbol) -> bo
-00009de0: 6f6c 3a0a 2020 2020 2020 2020 2020 2020  ol:.            
-00009df0: 6966 2062 7379 6d2e 7379 6d2e 6964 2069  if bsym.sym.id i
-00009e00: 6e20 6e65 7665 725f 666c 6174 7465 6e3a  n never_flatten:
-00009e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009e20: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
-00009e30: 2020 2020 2020 2020 2020 2067 7261 6466             gradf
-00009e40: 6e3a 204e 6f6e 6520 7c20 4361 6c6c 6162  n: None | Callab
-00009e50: 6c65 203d 205f 6765 745f 6772 6164 666e  le = _get_gradfn
-00009e60: 2862 7379 6d2c 2065 7865 6375 746f 7273  (bsym, executors
-00009e70: 5f6c 6973 743d 6578 6563 7574 6f72 735f  _list=executors_
-00009e80: 6c69 7374 290a 2020 2020 2020 2020 2020  list).          
-00009e90: 2020 7265 7475 726e 2067 7261 6466 6e20    return gradfn 
-00009ea0: 6973 204e 6f6e 650a 0a20 2020 2020 2020  is None..       
-00009eb0: 2023 2054 4f44 4f20 5243 313a 206d 6179   # TODO RC1: may
-00009ec0: 6265 206d 6f76 6520 746f 2070 726f 6475  be move to produ
-00009ed0: 6365 2074 6865 7365 2061 6c77 6179 7320  ce these always 
-00009ee0: 6f6e 2063 7265 6174 696f 6e0a 2020 2020  on creation.    
-00009ef0: 2020 2020 6966 2074 7263 2e6b 7761 7267      if trc.kwarg
-00009f00: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-00009f10: 2020 2020 2020 2074 7263 2e6b 7761 7267         trc.kwarg
-00009f20: 7320 3d20 7b7d 0a20 2020 2020 2020 2069  s = {}.        i
-00009f30: 6620 7472 632e 666e 2069 7320 4e6f 6e65  f trc.fn is None
-00009f40: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-00009f50: 632e 666e 203d 2074 7263 2e70 7974 686f  c.fn = trc.pytho
-00009f60: 6e5f 6361 6c6c 6162 6c65 2829 0a0a 2020  n_callable()..  
-00009f70: 2020 2020 2020 6772 6164 7472 6320 3d20        gradtrc = 
-00009f80: 6672 6f6d 5f74 7261 6365 2874 7263 290a  from_trace(trc).
-00009f90: 2020 2020 2020 2020 666c 6174 7465 6e65          flattene
-00009fa0: 645f 6273 796d 733a 206c 6973 745b 426f  d_bsyms: list[Bo
-00009fb0: 756e 6453 796d 626f 6c5d 203d 2066 6c61  undSymbol] = fla
-00009fc0: 7474 656e 5f66 6f72 5f74 7261 6e73 666f  tten_for_transfo
-00009fd0: 726d 2873 686f 756c 645f 666c 6174 7465  rm(should_flatte
-00009fe0: 6e5f 666f 725f 6772 6164 2c20 7472 632e  n_for_grad, trc.
-00009ff0: 626f 756e 645f 7379 6d62 6f6c 7329 0a20  bound_symbols). 
-0000a000: 2020 2020 2020 2067 7261 6474 7263 2e62         gradtrc.b
-0000a010: 6f75 6e64 5f73 796d 626f 6c73 203d 2066  ound_symbols = f
-0000a020: 6c61 7474 656e 6564 5f62 7379 6d73 0a20  lattened_bsyms. 
-0000a030: 2020 2020 2020 2067 7261 6474 7263 203d         gradtrc =
-0000a040: 2064 6365 2867 7261 6474 7263 290a 0a20   dce(gradtrc).. 
-0000a050: 2020 2020 2020 2023 2053 5445 5020 5457         # STEP TW
-0000a060: 4f20 2d2d 2052 6570 6c61 6365 7320 6f72  O -- Replaces or
-0000a070: 6967 696e 616c 2063 616c 6c73 2077 6974  iginal calls wit
-0000a080: 6820 6772 6164 2063 616c 6c73 0a0a 2020  h grad calls..  
-0000a090: 2020 2020 2020 2320 4465 6669 6e65 7320        # Defines 
-0000a0a0: 7468 6520 7669 7369 746f 7220 7061 7474  the visitor patt
-0000a0b0: 6572 6e20 666f 7220 7468 6520 6669 7273  ern for the firs
-0000a0c0: 7420 7061 7373 206f 6620 7468 6520 6772  t pass of the gr
-0000a0d0: 6164 2074 7261 6e73 666f 726d 2c0a 2020  ad transform,.  
-0000a0e0: 2020 2020 2020 2320 2020 7768 6963 6820        #   which 
-0000a0f0: 7377 6170 7320 426f 756e 6453 796d 626f  swaps BoundSymbo
-0000a100: 6c73 2077 6974 6820 7468 6569 7220 6772  ls with their gr
-0000a110: 6164 2066 756e 6374 696f 6e73 0a20 2020  ad functions.   
-0000a120: 2020 2020 2064 6566 2076 6973 6974 5f28       def visit_(
-0000a130: 6273 796d 3a20 426f 756e 6453 796d 626f  bsym: BoundSymbo
-0000a140: 6c29 202d 3e20 4361 6c6c 6162 6c65 3a0a  l) -> Callable:.
-0000a150: 2020 2020 2020 2020 2020 2020 6772 6164              grad
-0000a160: 666e 3a20 4e6f 6e65 207c 2043 616c 6c61  fn: None | Calla
-0000a170: 626c 6520 3d20 5f67 6574 5f67 7261 6466  ble = _get_gradf
-0000a180: 6e28 6273 796d 2c20 6578 6563 7574 6f72  n(bsym, executor
-0000a190: 735f 6c69 7374 3d65 7865 6375 746f 7273  s_list=executors
-0000a1a0: 5f6c 6973 7429 0a20 2020 2020 2020 2020  _list).         
-0000a1b0: 2020 2063 6865 636b 280a 2020 2020 2020     check(.      
-0000a1c0: 2020 2020 2020 2020 2020 6772 6164 666e            gradfn
-0000a1d0: 2069 7320 6e6f 7420 4e6f 6e65 2c0a 2020   is not None,.  
-0000a1e0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-0000a1f0: 6d62 6461 3a20 6622 4661 696c 6564 2074  mbda: f"Failed t
-0000a200: 6f20 6669 6e64 2061 2067 7261 6466 6e20  o find a gradfn 
-0000a210: 666f 7220 7b62 7379 6d3d 7d20 6166 7465  for {bsym=} afte
-0000a220: 7220 666c 6174 7465 6e69 6e67 222c 0a20  r flattening",. 
-0000a230: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000a240: 7863 6570 7469 6f6e 5f74 7970 653d 4173  xception_type=As
-0000a250: 7365 7274 696f 6e45 7272 6f72 2c0a 2020  sertionError,.  
-0000a260: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000a270: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-0000a280: 7261 6466 6e0a 0a20 2020 2020 2020 2040  radfn..        @
-0000a290: 7772 6170 7328 7472 632e 666e 2e6d 6574  wraps(trc.fn.met
-0000a2a0: 6120 6966 2069 7369 6e73 7461 6e63 6528  a if isinstance(
-0000a2b0: 7472 632e 666e 2c20 5379 6d62 6f6c 2920  trc.fn, Symbol) 
-0000a2c0: 656c 7365 2074 7263 2e66 6e29 0a20 2020  else trc.fn).   
-0000a2d0: 2020 2020 2064 6566 2069 6e74 6572 7072       def interpr
-0000a2e0: 6574 696e 675f 666e 282a 6172 6773 2c20  eting_fn(*args, 
-0000a2f0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-0000a300: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-0000a310: 6576 616c 5f74 7261 6365 2867 7261 6474  eval_trace(gradt
-0000a320: 7263 2c20 2a61 7267 732c 2073 796d 626f  rc, *args, symbo
-0000a330: 6c5f 6d61 7070 6572 3d76 6973 6974 5f2c  l_mapper=visit_,
-0000a340: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
-0000a350: 2020 2020 2020 2023 2053 6574 7320 6772         # Sets gr
-0000a360: 6164 7320 666f 7220 6f75 7470 7574 0a20  ads for output. 
-0000a370: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
-0000a380: 4f20 5468 6973 2065 6666 6563 7469 7665  O This effective
-0000a390: 6c79 2072 756e 7320 696e 2061 206e 6f20  ly runs in a no 
-0000a3a0: 6772 6164 2063 6f6e 7465 7874 202d 2d20  grad context -- 
-0000a3b0: 7368 6f75 6c64 2069 7420 7275 6e20 696e  should it run in
-0000a3c0: 2061 2067 7261 6420 636f 6e74 6578 742c   a grad context,
-0000a3d0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-0000a3e0: 206f 7220 7368 6f75 6c64 2074 6865 7265   or should there
-0000a3f0: 2062 6520 7468 6520 6f70 7469 6f6e 2074   be the option t
-0000a400: 6f20 7275 6e20 6974 2069 6e20 6120 6772  o run it in a gr
-0000a410: 6164 2063 6f6e 7465 7874 3f0a 2020 2020  ad context?.    
-0000a420: 2020 2020 2020 2020 6772 6164 5f73 7065          grad_spe
-0000a430: 6369 6669 6572 2872 6573 756c 7429 0a20  cifier(result). 
-0000a440: 2020 2020 2020 2020 2020 2023 2043 6f6e             # Con
-0000a450: 7374 7275 6374 7320 7265 7475 726e 2076  structs return v
-0000a460: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
-0000a470: 2066 6c61 745f 6772 6164 7320 3d20 6772   flat_grads = gr
-0000a480: 6164 5f6f 7574 5f73 7065 6369 6669 6572  ad_out_specifier
-0000a490: 2828 6172 6773 2c20 6b77 6172 6773 2929  ((args, kwargs))
-0000a4a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000a4b0: 7572 6e20 666c 6174 5f67 7261 6473 0a0a  urn flat_grads..
-0000a4c0: 2020 2020 2020 2020 2320 4e4f 5445 2041          # NOTE A
-0000a4d0: 6674 6572 2074 6869 7320 6361 6c6c 2074  fter this call t
-0000a4e0: 6865 2067 7261 6474 7263 2069 7320 696e  he gradtrc is in
-0000a4f0: 7661 6c69 642c 2062 6563 6175 7365 3a0a  valid, because:.
-0000a500: 2020 2020 2020 2020 2320 2020 3129 2054          #   1) T
-0000a510: 6865 206e 6f6e 2d65 7865 6375 7461 626c  he non-executabl
-0000a520: 6520 7075 745f 6772 6164 206f 7065 7261  e put_grad opera
-0000a530: 7469 6f6e 7320 6172 6520 7374 696c 6c20  tions are still 
-0000a540: 696e 2074 6865 2074 7261 6365 2c20 616e  in the trace, an
-0000a550: 6420 6d75 6c74 6970 6c65 2063 616c 6c73  d multiple calls
-0000a560: 2074 6f20 7075 7420 6772 6164 2061 7265   to put grad are
-0000a570: 206e 6f74 2061 6363 756d 756c 6174 6564   not accumulated
-0000a580: 0a20 2020 2020 2020 2023 2020 2032 2920  .        #   2) 
-0000a590: 5468 6520 6e6f 6e2d 6578 6563 7574 6162  The non-executab
-0000a5a0: 6c65 2067 6574 5f67 7261 6420 6f70 6572  le get_grad oper
-0000a5b0: 6174 696f 6e73 2061 7265 2073 7469 6c6c  ations are still
-0000a5c0: 2069 6e20 7468 6520 7472 6163 652c 2061   in the trace, a
-0000a5d0: 6e64 2074 6865 7920 6d61 7920 7072 6f64  nd they may prod
-0000a5e0: 7563 6520 6469 6666 6572 656e 7420 7072  uce different pr
-0000a5f0: 6f78 6965 7320 7768 656e 0a20 2020 2020  oxies when.     
-0000a600: 2020 2023 2020 2020 2020 2063 616c 6c65     #       calle
-0000a610: 6420 6f6e 2074 6865 2073 616d 6520 696e  d on the same in
-0000a620: 7075 7473 0a20 2020 2020 2020 2023 2020  puts.        #  
-0000a630: 2033 2920 5468 6520 6f70 6572 6174 696f   3) The operatio
-0000a640: 6e73 2061 7265 206e 6f74 2069 6e20 6120  ns are not in a 
-0000a650: 7661 6c69 6420 6f72 6465 720a 2020 2020  valid order.    
-0000a660: 2020 2020 6772 6164 7472 6320 3d20 636f      gradtrc = co
-0000a670: 6e73 7472 7563 745f 7472 6163 6528 0a20  nstruct_trace(. 
-0000a680: 2020 2020 2020 2020 2020 2072 656e 616d             renam
-0000a690: 655f 7072 6f78 6965 733d 4661 6c73 652c  e_proxies=False,
-0000a6a0: 0a20 2020 2020 2020 2020 2020 2075 7365  .            use
-0000a6b0: 5f64 6365 3d46 616c 7365 2c0a 2020 2020  _dce=False,.    
-0000a6c0: 2020 2020 2928 696e 7465 7270 7265 7469      )(interpreti
-0000a6d0: 6e67 5f66 6e2c 202a 6772 6164 7472 632e  ng_fn, *gradtrc.
-0000a6e0: 6172 6773 2c20 2a2a 6772 6164 7472 632e  args, **gradtrc.
-0000a6f0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-0000a700: 6772 6164 7472 632e 7363 6f70 6573 203d  gradtrc.scopes =
-0000a710: 205b 6772 6164 7472 632e 626f 756e 645f   [gradtrc.bound_
-0000a720: 7379 6d62 6f6c 735d 0a20 2020 2020 2020  symbols].       
-0000a730: 2067 7261 6474 7263 2e5f 636f 6d70 6c65   gradtrc._comple
-0000a740: 7465 203d 2046 616c 7365 0a0a 2020 2020  te = False..    
-0000a750: 2020 2020 2320 5354 4550 2054 4852 4545      # STEP THREE
-0000a760: 202d 2d20 4861 6e64 6c65 7320 7075 745f   -- Handles put_
-0000a770: 6772 6164 2061 6e64 2067 6574 5f67 7261  grad and get_gra
-0000a780: 6420 6f70 6572 6174 696f 6e73 2061 6e64  d operations and
-0000a790: 2061 6363 756d 756c 6174 6573 2067 7261   accumulates gra
-0000a7a0: 6469 656e 7473 0a0a 2020 2020 2020 2020  dients..        
-0000a7b0: 2320 4163 6375 6d75 6c61 7465 7320 6772  # Accumulates gr
-0000a7c0: 6164 6965 6e74 732c 2063 7265 6174 696e  adients, creatin
-0000a7d0: 6720 7468 6520 7072 696d 616c 202d 3e20  g the primal -> 
-0000a7e0: 6163 6375 6d75 6c61 7465 6420 6772 6164  accumulated grad
-0000a7f0: 206d 6170 7069 6e67 0a20 2020 2020 2020   mapping.       
-0000a800: 2023 2053 6574 7320 7468 6520 7472 6163   # Sets the trac
-0000a810: 696e 6720 636f 6e74 6578 7420 736f 2061  ing context so a
-0000a820: 6363 756d 756c 6174 696f 6e20 6f70 6572  ccumulation oper
-0000a830: 6174 696f 6e73 2061 7265 2072 6563 6f72  ations are recor
-0000a840: 6465 6420 696e 746f 2074 6865 2074 7261  ded into the tra
-0000a850: 6365 0a20 2020 2020 2020 2074 7279 3a0a  ce.        try:.
-0000a860: 2020 2020 2020 2020 2020 2020 7472 6163              trac
-0000a870: 6563 7478 5f74 6f6b 203d 2073 6574 5f74  ectx_tok = set_t
-0000a880: 7261 6365 6374 7828 6772 6164 7472 6329  racectx(gradtrc)
-0000a890: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000a8a0: 4d61 7073 2070 7269 6d61 6c73 2074 6f20  Maps primals to 
-0000a8b0: 7468 6569 7220 6772 6164 6965 6e74 7320  their gradients 
-0000a8c0: 2877 6869 6368 2061 7265 2072 6574 7572  (which are retur
-0000a8d0: 6e65 6420 6672 6f6d 2063 616c 6c69 6e67  ned from calling
-0000a8e0: 2067 6574 5f67 7261 6420 6f6e 2074 6865   get_grad on the
-0000a8f0: 2070 7269 6d61 6c29 0a20 2020 2020 2020   primal).       
-0000a900: 2020 2020 2070 7269 6d61 6c73 5f74 6f5f       primals_to_
-0000a910: 6769 6e70 7574 5f6d 6170 3a20 6469 6374  ginput_map: dict
-0000a920: 5b56 6172 6961 626c 652c 2054 656e 736f  [Variable, Tenso
-0000a930: 7250 726f 7879 5d20 3d20 7b7d 0a0a 2020  rProxy] = {}..  
-0000a940: 2020 2020 2020 2020 2020 2320 4861 6e64            # Hand
-0000a950: 6c65 7320 7075 745f 6772 6164 206f 7065  les put_grad ope
-0000a960: 7261 7469 6f6e 730a 2020 2020 2020 2020  rations.        
-0000a970: 2020 2020 2320 4e4f 5445 2054 6869 7320      # NOTE This 
-0000a980: 6d6f 6469 6669 6573 2061 206c 6973 7420  modifies a list 
-0000a990: 7468 6174 2069 7320 6265 696e 6720 656e  that is being en
-0000a9a0: 756d 6572 6174 6564 206f 7665 722c 2062  umerated over, b
-0000a9b0: 7574 2069 7427 7320 4f4b 2062 6563 6175  ut it's OK becau
-0000a9c0: 7365 2077 6527 7265 206f 6e6c 790a 2020  se we're only.  
-0000a9d0: 2020 2020 2020 2020 2020 2320 2020 6170            #   ap
-0000a9e0: 7065 6e64 696e 6720 746f 2074 6865 2065  pending to the e
-0000a9f0: 6e64 206f 6620 7468 6520 6c69 7374 0a20  nd of the list. 
-0000aa00: 2020 2020 2020 2020 2020 2062 7379 6d3a             bsym:
-0000aa10: 2042 6f75 6e64 5379 6d62 6f6c 0a20 2020   BoundSymbol.   
-0000aa20: 2020 2020 2020 2020 2066 6f72 2062 7379           for bsy
-0000aa30: 6d20 696e 2067 7261 6474 7263 2e62 6f75  m in gradtrc.bou
-0000aa40: 6e64 5f73 796d 626f 6c73 3a0a 2020 2020  nd_symbols:.    
-0000aa50: 2020 2020 2020 2020 2020 2020 6964 3a20              id: 
-0000aa60: 4861 7368 6162 6c65 203d 2062 7379 6d2e  Hashable = bsym.
-0000aa70: 7379 6d2e 6964 0a20 2020 2020 2020 2020  sym.id.         
-0000aa80: 2020 2020 2020 2069 6620 6964 2069 7320         if id is 
-0000aa90: 7069 6473 2e50 5554 5f47 5241 443a 0a20  pids.PUT_GRAD:. 
-0000aaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aab0: 2020 2070 7269 6d61 6c3a 204e 756d 6265     primal: Numbe
-0000aac0: 7220 7c20 5465 6e73 6f72 5072 6f78 790a  r | TensorProxy.
-0000aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aae0: 2020 2020 6772 6164 3a20 4e75 6d62 6572      grad: Number
-0000aaf0: 207c 2054 656e 736f 7250 726f 7879 0a20   | TensorProxy. 
-0000ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab10: 2020 2070 7269 6d61 6c2c 2067 7261 6420     primal, grad 
-0000ab20: 3d20 6273 796d 2e66 6c61 745f 6172 6773  = bsym.flat_args
-0000ab30: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000ab40: 2020 2020 2020 2320 544f 444f 2053 7570        # TODO Sup
-0000ab50: 706f 7274 2061 7574 6f67 7261 6420 6f6e  port autograd on
-0000ab60: 206e 756d 6265 7273 0a20 2020 2020 2020   numbers.       
-0000ab70: 2020 2020 2020 2020 2020 2020 2023 2046               # F
-0000ab80: 696c 7465 7273 2063 616c 6c73 2074 6f20  ilters calls to 
-0000ab90: 7075 745f 6772 6164 2074 6861 7420 776f  put_grad that wo
-0000aba0: 756c 6420 7075 7420 6120 6772 6164 206f  uld put a grad o
-0000abb0: 6e20 6120 6e6f 6e2d 7465 6e73 6f72 206f  n a non-tensor o
-0000abc0: 7220 6120 7465 6e73 6f72 2074 6861 7420  r a tensor that 
-0000abd0: 646f 6573 6e27 7420 7265 7175 6972 6520  doesn't require 
-0000abe0: 6772 6164 0a20 2020 2020 2020 2020 2020  grad.           
-0000abf0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0000ac00: 6973 696e 7374 616e 6365 2870 7269 6d61  isinstance(prima
-0000ac10: 6c2c 2054 656e 736f 7250 726f 7879 2920  l, TensorProxy) 
-0000ac20: 6f72 206e 6f74 2070 7269 6d61 6c2e 7265  or not primal.re
-0000ac30: 7175 6972 6573 5f67 7261 643a 0a20 2020  quires_grad:.   
+00008190: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
+000081a0: 6368 6374 780a 6465 6620 5f74 6f70 6b5f  chctx.def _topk_
+000081b0: 7072 696d 5f67 7261 6428 0a20 2020 2061  prim_grad(.    a
+000081c0: 3a20 5465 6e73 6f72 5072 6f78 792c 202f  : TensorProxy, /
+000081d0: 2c20 6b3a 2069 6e74 2c20 6469 6d3a 204e  , k: int, dim: N
+000081e0: 6f6e 6520 7c20 696e 7420 3d20 4e6f 6e65  one | int = None
+000081f0: 2c20 6c61 7267 6573 743a 2062 6f6f 6c20  , largest: bool 
+00008200: 3d20 5472 7565 2c20 736f 7274 6564 3a20  = True, sorted: 
+00008210: 626f 6f6c 203d 2054 7275 652c 202a 2c20  bool = True, *, 
+00008220: 6f75 743d 4e6f 6e65 0a29 3a0a 2020 2020  out=None.):.    
+00008230: 6677 6420 3d20 7072 696d 732e 746f 706b  fwd = prims.topk
+00008240: 2861 2c20 6b2c 2064 696d 2c20 6c61 7267  (a, k, dim, larg
+00008250: 6573 742c 2073 6f72 7465 642c 206f 7574  est, sorted, out
+00008260: 3d6f 7574 290a 2020 2020 7661 6c2c 2069  =out).    val, i
+00008270: 6478 203d 2066 7764 0a0a 2020 2020 7661  dx = fwd..    va
+00008280: 6c5f 6772 6164 203d 2067 6574 5f67 7261  l_grad = get_gra
+00008290: 6428 7661 6c29 0a0a 2020 2020 615f 6772  d(val)..    a_gr
+000082a0: 6164 203d 206c 746f 7263 682e 7a65 726f  ad = ltorch.zero
+000082b0: 735f 6c69 6b65 2861 290a 2020 2020 2320  s_like(a).    # 
+000082c0: 544f 444f 3a20 7265 706c 6163 6520 7769  TODO: replace wi
+000082d0: 7468 2073 6361 7474 6572 206f 6e63 6520  th scatter once 
+000082e0: 7765 2068 6176 6520 6974 2e0a 2020 2020  we have it..    
+000082f0: 2320 7363 6174 7465 725f 6164 6420 6973  # scatter_add is
+00008300: 2061 2070 7269 6d20 616e 6420 6974 2072   a prim and it r
+00008310: 656c 6965 7320 6f6e 2061 746f 6d69 6320  elies on atomic 
+00008320: 6f70 732e 0a20 2020 2061 5f67 7261 6420  ops..    a_grad 
+00008330: 3d20 6c74 6f72 6368 2e73 6361 7474 6572  = ltorch.scatter
+00008340: 5f61 6464 2861 5f67 7261 642c 2064 696d  _add(a_grad, dim
+00008350: 2c20 6964 782c 2076 616c 5f67 7261 6429  , idx, val_grad)
+00008360: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
+00008370: 2061 5f67 7261 6429 0a0a 2020 2020 7265   a_grad)..    re
+00008380: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+00008390: 7465 725f 6772 6164 2870 6964 732e 544f  ter_grad(pids.TO
+000083a0: 504b 2c20 5f74 6f70 6b5f 7072 696d 5f67  PK, _topk_prim_g
+000083b0: 7261 6429 0a0a 0a23 2054 4f44 4f20 4669  rad)...# TODO Fi
+000083c0: 7820 6469 7669 7369 6f6e 2062 7920 7a65  x division by ze
+000083d0: 726f 2077 6865 6e20 6e5f 656c 656d 5f72  ro when n_elem_r
+000083e0: 6564 7563 6564 203d 3d20 3020 6f72 2077  educed == 0 or w
+000083f0: 6865 6e20 6d65 616e 2e6e 756d 656c 203d  hen mean.numel =
+00008400: 3d20 300a 2320 2020 6279 2072 6574 7572  = 0.#   by retur
+00008410: 6e69 6e67 207a 6572 6f73 5f6c 696b 6528  ning zeros_like(
+00008420: 6129 206f 7220 7369 6d69 6c61 722e 0a23  a) or similar..#
+00008430: 2054 4f44 4f20 4669 7820 6772 6164 2077   TODO Fix grad w
+00008440: 6865 6e20 636f 7272 6563 7469 6f6e 203e  hen correction >
+00008450: 206e 5f65 6c65 6d5f 7265 6475 6365 642e   n_elem_reduced.
+00008460: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
+00008470: 7661 725f 6d65 616e 5f70 7269 6d5f 6772  var_mean_prim_gr
+00008480: 6164 2861 3a20 5465 6e73 6f72 5072 6f78  ad(a: TensorProx
+00008490: 792c 202f 2c20 6469 6d73 3a20 5365 7175  y, /, dims: Sequ
+000084a0: 656e 6365 5b69 6e74 5d2c 202a 2c20 636f  ence[int], *, co
+000084b0: 7272 6563 7469 6f6e 3a20 4e75 6d62 6572  rrection: Number
+000084c0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
+000084d0: 3a0a 2020 2020 762c 206d 203d 2070 7269  :.    v, m = pri
+000084e0: 6d73 2e76 6172 5f6d 6561 6e28 612c 2064  ms.var_mean(a, d
+000084f0: 696d 732c 2063 6f72 7265 6374 696f 6e3d  ims, correction=
+00008500: 636f 7272 6563 7469 6f6e 290a 0a20 2020  correction)..   
+00008510: 2067 7620 3d20 6765 745f 6772 6164 2876   gv = get_grad(v
+00008520: 290a 2020 2020 676d 203d 2067 6574 5f67  ).    gm = get_g
+00008530: 7261 6428 6d29 0a0a 2020 2020 6e5f 656c  rad(m)..    n_el
+00008540: 656d 5f72 6564 7563 6564 203d 2061 2e6e  em_reduced = a.n
+00008550: 756d 656c 202f 2f20 6d2e 6e75 6d65 6c20  umel // m.numel 
+00008560: 6966 2061 2e6e 756d 656c 2021 3d20 3020  if a.numel != 0 
+00008570: 656c 7365 2031 0a0a 2020 2020 2320 436f  else 1..    # Co
+00008580: 6d70 7574 6573 206d 6561 6e20 6277 640a  mputes mean bwd.
+00008590: 2020 2020 6d65 616e 5f73 6361 6c65 203d      mean_scale =
+000085a0: 2031 2e30 202f 206e 5f65 6c65 6d5f 7265   1.0 / n_elem_re
+000085b0: 6475 6365 640a 2020 2020 6d65 616e 5f67  duced.    mean_g
+000085c0: 7261 6420 3d20 6d65 616e 5f73 6361 6c65  rad = mean_scale
+000085d0: 202a 2072 6573 746f 7265 5f72 6564 7563   * restore_reduc
+000085e0: 6564 5f64 696d 7328 676d 2c20 6469 6d73  ed_dims(gm, dims
+000085f0: 2c20 612e 7368 6170 6529 0a0a 2020 2020  , a.shape)..    
+00008600: 2320 436f 6d70 7574 6573 2076 6172 2062  # Computes var b
+00008610: 7764 0a20 2020 206e 6f72 6d61 6c69 7a61  wd.    normaliza
+00008620: 7469 6f6e 5f73 6361 6c61 7220 3d20 6e5f  tion_scalar = n_
+00008630: 656c 656d 5f72 6564 7563 6564 202d 2063  elem_reduced - c
+00008640: 6f72 7265 6374 696f 6e0a 2020 2020 7265  orrection.    re
+00008650: 7374 6f72 6564 5f67 7620 3d20 7265 7374  stored_gv = rest
+00008660: 6f72 655f 7265 6475 6365 645f 6469 6d73  ore_reduced_dims
+00008670: 2867 762c 2064 696d 732c 2061 2e73 6861  (gv, dims, a.sha
+00008680: 7065 290a 2020 2020 7265 7374 6f72 6564  pe).    restored
+00008690: 5f6d 6561 6e20 3d20 7265 7374 6f72 655f  _mean = restore_
+000086a0: 7265 6475 6365 645f 6469 6d73 286d 2c20  reduced_dims(m, 
+000086b0: 6469 6d73 2c20 612e 7368 6170 6529 0a20  dims, a.shape). 
+000086c0: 2020 2076 6172 5f67 7261 6420 3d20 2832     var_grad = (2
+000086d0: 202a 2072 6573 746f 7265 645f 6776 202a   * restored_gv *
+000086e0: 2028 6120 2d20 7265 7374 6f72 6564 5f6d   (a - restored_m
+000086f0: 6561 6e29 2920 2f20 6e6f 726d 616c 697a  ean)) / normaliz
+00008700: 6174 696f 6e5f 7363 616c 6172 0a0a 2020  ation_scalar..  
+00008710: 2020 7075 745f 6772 6164 2861 2c20 6d65    put_grad(a, me
+00008720: 616e 5f67 7261 6420 2b20 7661 725f 6772  an_grad + var_gr
+00008730: 6164 290a 0a20 2020 2072 6574 7572 6e20  ad)..    return 
+00008740: 762c 206d 0a0a 0a72 6567 6973 7465 725f  v, m...register_
+00008750: 6772 6164 2870 6964 732e 5641 525f 4d45  grad(pids.VAR_ME
+00008760: 414e 2c20 5f76 6172 5f6d 6561 6e5f 7072  AN, _var_mean_pr
+00008770: 696d 5f67 7261 6429 0a0a 0a23 0a23 204c  im_grad)...#.# L
+00008780: 696e 6561 7220 616c 6765 6272 6120 6f70  inear algebra op
+00008790: 6572 6174 6f72 2067 7261 6473 0a23 0a40  erator grads.#.@
+000087a0: 746f 7263 6863 7478 0a64 6566 205f 6c69  torchctx.def _li
+000087b0: 6e65 6172 5f70 7269 6d5f 6772 6164 2861  near_prim_grad(a
+000087c0: 3a20 5465 6e73 6f72 5072 6f78 792c 2077  : TensorProxy, w
+000087d0: 3a20 5465 6e73 6f72 5072 6f78 792c 2062  : TensorProxy, b
+000087e0: 6961 733a 204e 6f6e 6520 7c20 5465 6e73  ias: None | Tens
+000087f0: 6f72 5072 6f78 7929 202d 3e20 5465 6e73  orProxy) -> Tens
+00008800: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+00008810: 203d 2070 7269 6d73 2e6c 696e 6561 7228   = prims.linear(
+00008820: 612c 2077 2c20 6269 6173 290a 0a20 2020  a, w, bias)..   
+00008830: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
+00008840: 6429 0a0a 2020 2020 6669 7273 745f 6469  d)..    first_di
+00008850: 6d20 3d20 2d32 0a20 2020 2067 7261 645f  m = -2.    grad_
+00008860: 6120 3d20 6c74 6f72 6368 2e6d 6174 6d75  a = ltorch.matmu
+00008870: 6c28 672e 7265 7368 6170 6528 2d31 2c20  l(g.reshape(-1, 
+00008880: 672e 7368 6170 655b 2d31 5d29 2c20 7729  g.shape[-1]), w)
+00008890: 2e72 6573 6861 7065 2861 2e73 6861 7065  .reshape(a.shape
+000088a0: 290a 0a20 2020 2067 7261 645f 773a 2054  )..    grad_w: T
+000088b0: 656e 736f 7250 726f 7879 0a20 2020 2069  ensorProxy.    i
+000088c0: 6620 612e 6e64 696d 203d 3d20 313a 0a20  f a.ndim == 1:. 
+000088d0: 2020 2020 2020 2067 7261 645f 7720 3d20         grad_w = 
+000088e0: 6c74 6f72 6368 2e6d 6174 6d75 6c28 672e  ltorch.matmul(g.
+000088f0: 756e 7371 7565 657a 6528 6669 7273 745f  unsqueeze(first_
+00008900: 6469 6d29 2e6d 542c 2061 2e75 6e73 7175  dim).mT, a.unsqu
+00008910: 6565 7a65 2866 6972 7374 5f64 696d 2929  eeze(first_dim))
+00008920: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00008930: 2020 2067 7261 645f 7720 3d20 6c74 6f72     grad_w = ltor
+00008940: 6368 2e6d 6174 6d75 6c28 672e 7265 7368  ch.matmul(g.resh
+00008950: 6170 6528 2d31 2c20 672e 7368 6170 655b  ape(-1, g.shape[
+00008960: 2d31 5d29 2e6d 542c 2061 2e72 6573 6861  -1]).mT, a.resha
+00008970: 7065 282d 312c 2061 2e73 6861 7065 5b2d  pe(-1, a.shape[-
+00008980: 315d 2929 0a0a 2020 2020 7075 745f 6772  1]))..    put_gr
+00008990: 6164 7328 2861 2c20 7729 2c20 2867 7261  ads((a, w), (gra
+000089a0: 645f 612c 2067 7261 645f 7729 290a 0a20  d_a, grad_w)).. 
+000089b0: 2020 2069 6620 6269 6173 2069 7320 6e6f     if bias is no
+000089c0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+000089d0: 6966 2067 2e6e 6469 6d20 3e20 313a 0a20  if g.ndim > 1:. 
+000089e0: 2020 2020 2020 2020 2020 2067 7261 645f             grad_
+000089f0: 6269 6173 203d 206c 746f 7263 682e 7375  bias = ltorch.su
+00008a00: 6d28 672c 2074 7570 6c65 2872 616e 6765  m(g, tuple(range
+00008a10: 2867 2e6e 6469 6d20 2d20 3129 2929 0a20  (g.ndim - 1))). 
+00008a20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00008a30: 2020 2020 2020 2020 2067 7261 645f 6269           grad_bi
+00008a40: 6173 203d 2067 0a20 2020 2020 2020 2070  as = g.        p
+00008a50: 7574 5f67 7261 6428 6269 6173 2c20 6772  ut_grad(bias, gr
+00008a60: 6164 5f62 6961 7329 0a0a 2020 2020 7265  ad_bias)..    re
+00008a70: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+00008a80: 7465 725f 6772 6164 2870 6964 732e 4c49  ter_grad(pids.LI
+00008a90: 4e45 4152 2c20 5f6c 696e 6561 725f 7072  NEAR, _linear_pr
+00008aa0: 696d 5f67 7261 6429 0a0a 0a23 2054 4f44  im_grad)...# TOD
+00008ab0: 4f20 4164 6420 6578 706c 6963 6974 206c  O Add explicit l
+00008ac0: 746f 7263 6820 7673 2063 6c61 6e67 206d  torch vs clang m
+00008ad0: 6f64 756c 6520 746f 2074 6865 2074 656e  odule to the ten
+00008ae0: 736f 7220 6f70 6572 6174 696f 6e73 2062  sor operations b
+00008af0: 656c 6f77 0a23 2054 4f44 4f20 636f 756c  elow.# TODO coul
+00008b00: 6420 7765 2067 6574 2072 6964 206f 6620  d we get rid of 
+00008b10: 7468 6520 6669 6e61 6c20 7371 7565 657a  the final squeez
+00008b20: 6573 2069 6e20 7468 6520 622e 6e64 696d  es in the b.ndim
+00008b30: 203d 3d20 3120 6361 7365 2061 6e64 2074   == 1 case and t
+00008b40: 6865 2061 2e6e 6469 6d20 3d3d 2031 2063  he a.ndim == 1 c
+00008b50: 6173 653f 0a40 746f 7263 6863 7478 0a64  ase?.@torchctx.d
+00008b60: 6566 205f 6d61 746d 756c 5f70 7269 6d5f  ef _matmul_prim_
+00008b70: 6772 6164 2861 3a20 5465 6e73 6f72 5072  grad(a: TensorPr
+00008b80: 6f78 792c 2062 3a20 5465 6e73 6f72 5072  oxy, b: TensorPr
+00008b90: 6f78 792c 202f 2920 2d3e 2054 656e 736f  oxy, /) -> Tenso
+00008ba0: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
+00008bb0: 3d20 7072 696d 732e 6d61 746d 756c 2861  = prims.matmul(a
+00008bc0: 2c20 6229 0a20 2020 2067 203d 2067 6574  , b).    g = get
+00008bd0: 5f67 7261 6428 6677 6429 0a0a 2020 2020  _grad(fwd)..    
+00008be0: 6c61 7374 5f64 696d 203d 2028 2d31 2c29  last_dim = (-1,)
+00008bf0: 0a20 2020 2066 6972 7374 5f64 696d 203d  .    first_dim =
+00008c00: 2028 2d32 2c29 0a20 2020 2069 6620 612e   (-2,).    if a.
+00008c10: 6e64 696d 203d 3d20 3120 616e 6420 622e  ndim == 1 and b.
+00008c20: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
+00008c30: 2020 2070 7574 5f67 7261 6473 2828 612c     put_grads((a,
+00008c40: 2062 292c 2028 6720 2a20 622c 2067 202a   b), (g * b, g *
+00008c50: 2061 2929 0a20 2020 2065 6c69 6620 622e   a)).    elif b.
+00008c60: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
+00008c70: 2020 2067 6120 3d20 756e 7371 7565 657a     ga = unsqueez
+00008c80: 6528 672c 206c 6173 745f 6469 6d29 2040  e(g, last_dim) @
+00008c90: 2075 6e73 7175 6565 7a65 2862 2c20 6c61   unsqueeze(b, la
+00008ca0: 7374 5f64 696d 292e 6d54 0a20 2020 2020  st_dim).mT.     
+00008cb0: 2020 2067 6220 3d20 612e 6d54 2040 2075     gb = a.mT @ u
+00008cc0: 6e73 7175 6565 7a65 2867 2c20 6c61 7374  nsqueeze(g, last
+00008cd0: 5f64 696d 290a 2020 2020 2020 2020 6966  _dim).        if
+00008ce0: 2067 2e6e 6469 6d20 3e20 313a 0a20 2020   g.ndim > 1:.   
+00008cf0: 2020 2020 2020 2020 2067 6220 3d20 7371           gb = sq
+00008d00: 7565 657a 6528 6762 2c20 6c61 7374 5f64  ueeze(gb, last_d
+00008d10: 696d 290a 2020 2020 2020 2020 2020 2020  im).            
+00008d20: 6762 203d 206c 746f 7263 682e 7375 6d28  gb = ltorch.sum(
+00008d30: 6762 2c20 7475 706c 6528 7261 6e67 6528  gb, tuple(range(
+00008d40: 6762 2e6e 6469 6d20 2d20 3129 2929 0a20  gb.ndim - 1))). 
+00008d50: 2020 2020 2020 2070 7574 5f67 7261 6473         put_grads
+00008d60: 2828 612c 2062 292c 2028 6761 2c20 6762  ((a, b), (ga, gb
+00008d70: 2e73 7175 6565 7a65 2829 2929 0a20 2020  .squeeze())).   
+00008d80: 2065 6c69 6620 612e 6e64 696d 203d 3d20   elif a.ndim == 
+00008d90: 313a 0a20 2020 2020 2020 2067 6120 3d20  1:.        ga = 
+00008da0: 756e 7371 7565 657a 6528 672c 2066 6972  unsqueeze(g, fir
+00008db0: 7374 5f64 696d 2920 4020 622e 6d54 0a20  st_dim) @ b.mT. 
+00008dc0: 2020 2020 2020 2069 6620 672e 6e64 696d         if g.ndim
+00008dd0: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
+00008de0: 2020 6761 203d 206c 746f 7263 682e 7375    ga = ltorch.su
+00008df0: 6d28 6761 2c20 7475 706c 6528 7261 6e67  m(ga, tuple(rang
+00008e00: 6528 6761 2e6e 6469 6d20 2d20 3129 2929  e(ga.ndim - 1)))
+00008e10: 0a20 2020 2020 2020 2067 6220 3d20 756e  .        gb = un
+00008e20: 7371 7565 657a 6528 612c 2066 6972 7374  squeeze(a, first
+00008e30: 5f64 696d 292e 6d54 2040 2075 6e73 7175  _dim).mT @ unsqu
+00008e40: 6565 7a65 2867 2c20 6669 7273 745f 6469  eeze(g, first_di
+00008e50: 6d29 0a20 2020 2020 2020 2070 7574 5f67  m).        put_g
+00008e60: 7261 6473 2828 612c 2062 292c 2028 6761  rads((a, b), (ga
+00008e70: 2e73 7175 6565 7a65 2829 2c20 6762 2929  .squeeze(), gb))
+00008e80: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00008e90: 2020 2070 7574 5f67 7261 6473 2828 612c     put_grads((a,
+00008ea0: 2062 292c 2028 6720 4020 622e 6d54 2c20   b), (g @ b.mT, 
+00008eb0: 612e 6d54 2040 2067 2929 0a0a 2020 2020  a.mT @ g))..    
+00008ec0: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
+00008ed0: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+00008ee0: 4d41 544d 554c 2c20 5f6d 6174 6d75 6c5f  MATMUL, _matmul_
+00008ef0: 7072 696d 5f67 7261 6429 0a0a 230a 2320  prim_grad)..#.# 
+00008f00: 4e4e 206f 7065 7261 746f 7220 6772 6164  NN operator grad
+00008f10: 730a 230a 0a0a 4074 6f72 6368 6374 780a  s.#...@torchctx.
+00008f20: 6465 6620 5f65 6d62 6564 6469 6e67 5f70  def _embedding_p
+00008f30: 7269 6d5f 6772 6164 280a 2020 2020 613a  rim_grad(.    a:
+00008f40: 2054 656e 736f 7250 726f 7879 2c20 2f2c   TensorProxy, /,
+00008f50: 2077 6569 6768 742c 202a 2c20 7061 6464   weight, *, padd
+00008f60: 696e 675f 6964 783d 2d31 2c20 6d61 785f  ing_idx=-1, max_
+00008f70: 6e6f 726d 3d4e 6f6e 652c 206e 6f72 6d5f  norm=None, norm_
+00008f80: 7479 7065 3d32 2e30 2c20 7363 616c 655f  type=2.0, scale_
+00008f90: 6772 6164 5f62 795f 6672 6571 3d46 616c  grad_by_freq=Fal
+00008fa0: 7365 2c20 7370 6172 7365 3d46 616c 7365  se, sparse=False
+00008fb0: 0a29 202d 3e20 5465 6e73 6f72 5072 6f78  .) -> TensorProx
+00008fc0: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
+00008fd0: 6d73 2e65 6d62 6564 6469 6e67 280a 2020  ms.embedding(.  
+00008fe0: 2020 2020 2020 612c 0a20 2020 2020 2020        a,.       
+00008ff0: 2077 6569 6768 742c 0a20 2020 2020 2020   weight,.       
+00009000: 2070 6164 6469 6e67 5f69 6478 3d70 6164   padding_idx=pad
+00009010: 6469 6e67 5f69 6478 2c0a 2020 2020 2020  ding_idx,.      
+00009020: 2020 6d61 785f 6e6f 726d 3d6d 6178 5f6e    max_norm=max_n
+00009030: 6f72 6d2c 0a20 2020 2020 2020 206e 6f72  orm,.        nor
+00009040: 6d5f 7479 7065 3d6e 6f72 6d5f 7479 7065  m_type=norm_type
+00009050: 2c0a 2020 2020 2020 2020 7363 616c 655f  ,.        scale_
+00009060: 6772 6164 5f62 795f 6672 6571 3d73 6361  grad_by_freq=sca
+00009070: 6c65 5f67 7261 645f 6279 5f66 7265 712c  le_grad_by_freq,
+00009080: 0a20 2020 2020 2020 2073 7061 7273 653d  .        sparse=
+00009090: 7370 6172 7365 2c0a 2020 2020 290a 0a20  sparse,.    ).. 
+000090a0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+000090b0: 6677 6429 0a20 2020 2061 5f67 7261 6420  fwd).    a_grad 
+000090c0: 3d20 7072 696d 732e 656d 6265 6464 696e  = prims.embeddin
+000090d0: 675f 6261 636b 7761 7264 2867 2c20 612c  g_backward(g, a,
+000090e0: 2077 6569 6768 742e 7368 6170 655b 305d   weight.shape[0]
+000090f0: 2c20 7061 6464 696e 675f 6964 782c 2073  , padding_idx, s
+00009100: 6361 6c65 5f67 7261 645f 6279 5f66 7265  cale_grad_by_fre
+00009110: 712c 2073 7061 7273 6529 0a20 2020 2070  q, sparse).    p
+00009120: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
+00009130: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
+00009140: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
+00009150: 6164 2870 6964 732e 454d 4245 4444 494e  ad(pids.EMBEDDIN
+00009160: 472c 205f 656d 6265 6464 696e 675f 7072  G, _embedding_pr
+00009170: 696d 5f67 7261 6429 0a0a 230a 2320 5068  im_grad)..#.# Ph
+00009180: 616e 746f 6d20 6772 6164 2074 7261 6e73  antom grad trans
+00009190: 666f 726d 2068 656c 7065 7273 0a23 0a0a  form helpers.#..
+000091a0: 0a64 6566 205f 6765 745f 6772 6164 666e  .def _get_gradfn
+000091b0: 2862 7379 6d3a 2042 6f75 6e64 5379 6d62  (bsym: BoundSymb
+000091c0: 6f6c 2c20 2a2c 2065 7865 6375 746f 7273  ol, *, executors
+000091d0: 5f6c 6973 743a 2053 6571 7565 6e63 655b  _list: Sequence[
+000091e0: 416e 795d 203d 2074 7570 6c65 2829 2920  Any] = tuple()) 
+000091f0: 2d3e 204e 6f6e 6520 7c20 4361 6c6c 6162  -> None | Callab
+00009200: 6c65 3a0a 2020 2020 6364 203d 2067 6574  le:.    cd = get
+00009210: 5f63 6f6d 7069 6c65 5f64 6174 6128 290a  _compile_data().
+00009220: 2020 2020 6578 6563 7574 6f72 735f 6c69      executors_li
+00009230: 7374 203d 2063 642e 6578 6563 7574 6f72  st = cd.executor
+00009240: 735f 6c69 7374 2069 6620 6364 2069 7320  s_list if cd is 
+00009250: 6e6f 7420 4e6f 6e65 2065 6c73 6520 6578  not None else ex
+00009260: 6563 7574 6f72 735f 6c69 7374 0a20 2020  ecutors_list.   
+00009270: 2023 2043 6865 636b 7320 6966 2074 6865   # Checks if the
+00009280: 2065 7865 6375 746f 7220 7768 6963 6820   executor which 
+00009290: 6861 7320 7072 696f 7269 7479 2066 6f72  has priority for
+000092a0: 2074 6869 7320 6f70 6572 6174 696f 6e20   this operation 
+000092b0: 6861 7320 6120 7370 6563 6966 6963 2067  has a specific g
+000092c0: 7261 6420 7472 616e 7366 6f72 6d20 666f  rad transform fo
+000092d0: 7220 6974 0a20 2020 2066 6f72 2065 7820  r it.    for ex 
+000092e0: 696e 2065 7865 6375 746f 7273 5f6c 6973  in executors_lis
+000092f0: 743a 0a20 2020 2020 2020 2069 6620 6578  t:.        if ex
+00009300: 2e63 616e 5f65 7865 6375 7465 5f6f 725f  .can_execute_or_
+00009310: 6675 7365 2862 7379 6d29 3a0a 2020 2020  fuse(bsym):.    
+00009320: 2020 2020 2020 2020 6578 5f67 7261 645f          ex_grad_
+00009330: 7472 616e 7366 6f72 6d3a 204e 6f6e 6520  transform: None 
+00009340: 7c20 4361 6c6c 6162 6c65 203d 2065 782e  | Callable = ex.
+00009350: 6765 745f 6772 6164 5f74 7261 6e73 666f  get_grad_transfo
+00009360: 726d 2862 7379 6d2e 7379 6d29 0a20 2020  rm(bsym.sym).   
+00009370: 2020 2020 2020 2020 2069 6620 6578 5f67           if ex_g
+00009380: 7261 645f 7472 616e 7366 6f72 6d20 6973  rad_transform is
+00009390: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000093a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000093b0: 6e20 6578 5f67 7261 645f 7472 616e 7366  n ex_grad_transf
+000093c0: 6f72 6d0a 2020 2020 2020 2020 2020 2020  orm.            
+000093d0: 6272 6561 6b0a 0a20 2020 2023 2049 6620  break..    # If 
+000093e0: 7468 6520 6578 6563 7574 6f72 2064 6f65  the executor doe
+000093f0: 736e 2774 2064 6566 696e 6520 6974 7320  sn't define its 
+00009400: 6f77 6e20 6772 6164 2074 7261 6e73 666f  own grad transfo
+00009410: 726d 2c20 7468 6973 206a 7573 7420 7265  rm, this just re
+00009420: 7475 726e 7320 7468 6520 6465 6661 756c  turns the defaul
+00009430: 7420 6772 6164 2074 7261 6e73 666f 726d  t grad transform
+00009440: 2066 6f72 2074 6865 2062 7379 6d0a 2020   for the bsym.  
+00009450: 2020 6772 6164 666e 203d 205f 6772 6164    gradfn = _grad
+00009460: 5f66 6e5f 6d61 702e 6765 7428 6273 796d  _fn_map.get(bsym
+00009470: 2e73 796d 2e69 642c 204e 6f6e 6529 0a20  .sym.id, None). 
+00009480: 2020 2072 6574 7572 6e20 6772 6164 666e     return gradfn
+00009490: 0a0a 0a23 2054 6865 2064 6566 6175 6c74  ...# The default
+000094a0: 2067 7261 6420 7370 6563 6966 6965 7220   grad specifier 
+000094b0: 666f 7220 7468 6520 6772 6164 2074 7261  for the grad tra
+000094c0: 6e73 666f 726d 0a23 2020 2046 6f72 2065  nsform.#   For e
+000094d0: 6163 6820 7465 6e73 6f72 206f 7574 7075  ach tensor outpu
+000094e0: 7420 226f 2220 7265 7175 6972 696e 6720  t "o" requiring 
+000094f0: 6772 6164 2c20 7370 6563 6966 6965 7320  grad, specifies 
+00009500: 6120 6772 6164 206f 6620 6f6e 6573 5f6c  a grad of ones_l
+00009510: 696b 6528 6f29 0a64 6566 205f 6772 6164  ike(o).def _grad
+00009520: 5f73 7065 6369 6669 6572 5f64 6566 6175  _specifier_defau
+00009530: 6c74 2870 7974 7265 653a 2041 6e79 2920  lt(pytree: Any) 
+00009540: 2d3e 204e 6f6e 653a 0a20 2020 2066 6c61  -> None:.    fla
+00009550: 7473 2c20 5f20 3d20 7472 6565 5f66 6c61  ts, _ = tree_fla
+00009560: 7474 656e 2870 7974 7265 6529 0a0a 2020  tten(pytree)..  
+00009570: 2020 666f 7220 6620 696e 2066 6c61 7473    for f in flats
+00009580: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
+00009590: 6e73 7461 6e63 6528 662c 2054 656e 736f  nstance(f, Tenso
+000095a0: 7250 726f 7879 2920 616e 6420 662e 7265  rProxy) and f.re
+000095b0: 7175 6972 6573 5f67 7261 643a 0a20 2020  quires_grad:.   
+000095c0: 2020 2020 2020 2020 2023 204e 4f54 4520           # NOTE 
+000095d0: 5468 6973 2075 7365 7320 636c 616e 672e  This uses clang.
+000095e0: 6f6e 6573 5f6c 696b 6520 666f 7220 6e6f  ones_like for no
+000095f0: 7720 6265 6361 7573 6520 6c74 6f72 6368  w because ltorch
+00009600: 2e6f 6e65 735f 6c69 6b65 2077 696c 6c20  .ones_like will 
+00009610: 6578 7465 6e64 2074 6865 0a20 2020 2020  extend the.     
+00009620: 2020 2020 2020 2023 2020 206c 6966 6574         #   lifet
+00009630: 696d 6520 6f66 2066 2c20 7768 696c 6520  ime of f, while 
+00009640: 636c 616e 672e 6f6e 6573 5f6c 696b 6520  clang.ones_like 
+00009650: 7769 6c6c 2065 7874 7261 6374 2074 6865  will extract the
+00009660: 206d 6574 6164 6174 6120 6f66 2066 2061   metadata of f a
+00009670: 7420 7472 6163 6520 7469 6d65 0a20 2020  t trace time.   
+00009680: 2020 2020 2020 2020 2070 7269 6d73 2e70           prims.p
+00009690: 7574 5f67 7261 6428 662c 2063 6c61 6e67  ut_grad(f, clang
+000096a0: 2e66 756c 6c5f 6c69 6b65 2866 2c20 312e  .full_like(f, 1.
+000096b0: 3029 290a 0a0a 2320 544f 444f 2054 6573  0))...# TODO Tes
+000096c0: 7420 7769 7468 2062 7566 6665 7273 0a64  t with buffers.d
+000096d0: 6566 205f 6772 6164 5f6f 7574 5f73 7065  ef _grad_out_spe
+000096e0: 6369 6669 6572 5f64 6566 6175 6c74 2870  cifier_default(p
+000096f0: 7974 7265 653a 2041 6e79 2920 2d3e 206c  ytree: Any) -> l
+00009700: 6973 745b 5465 6e73 6f72 5072 6f78 795d  ist[TensorProxy]
+00009710: 3a0a 2020 2020 666c 6174 732c 205f 203d  :.    flats, _ =
+00009720: 2074 7265 655f 666c 6174 7465 6e28 7079   tree_flatten(py
+00009730: 7472 6565 290a 2020 2020 6772 6164 7320  tree).    grads 
+00009740: 3d20 6c69 7374 285b 7072 696d 732e 6765  = list([prims.ge
+00009750: 745f 6772 6164 2866 2920 666f 7220 6620  t_grad(f) for f 
+00009760: 696e 2066 6c61 7473 2069 6620 6973 696e  in flats if isin
+00009770: 7374 616e 6365 2866 2c20 5465 6e73 6f72  stance(f, Tensor
+00009780: 5072 6f78 7929 2061 6e64 2066 2e72 6571  Proxy) and f.req
+00009790: 7569 7265 735f 6772 6164 5d29 0a20 2020  uires_grad]).   
+000097a0: 2072 6574 7572 6e20 6772 6164 730a 0a0a   return grads...
+000097b0: 2320 544f 444f 2046 6f72 6d61 6c6c 7920  # TODO Formally 
+000097c0: 6465 6669 6e65 2074 6865 2022 6772 6164  define the "grad
+000097d0: 6965 6e74 2220 6f66 2061 2074 656e 736f  ient" of a tenso
+000097e0: 720a 2320 544f 444f 2049 6620 6e6f 6e65  r.# TODO If none
+000097f0: 206f 6620 7468 6520 696e 7075 7473 2074   of the inputs t
+00009800: 6f20 616e 206f 7065 7261 7469 6f6e 2072  o an operation r
+00009810: 6571 7569 7265 2067 7261 642c 2074 6865  equire grad, the
+00009820: 6e20 7765 2063 6f75 6c64 206c 6561 7665  n we could leave
+00009830: 2074 6861 7420 6f70 6572 6174 696f 6e20   that operation 
+00009840: 616c 6f6e 650a 2320 2020 5468 6973 2063  alone.#   This c
+00009850: 6f75 6c64 2061 6374 7561 6c6c 7920 696d  ould actually im
+00009860: 7072 6f76 6520 7065 7266 6f72 6d61 6e63  prove performanc
+00009870: 6520 6966 2074 6865 206f 7065 7261 7469  e if the operati
+00009880: 6f6e 2070 6572 666f 726d 7320 6578 7472  on performs extr
+00009890: 6120 636f 6d70 7574 6174 696f 6e73 2069  a computations i
+000098a0: 6e20 6974 7320 6772 6164 2074 7261 6e73  n its grad trans
+000098b0: 666f 726d 0a23 2020 2041 2077 6f72 6b61  form.#   A worka
+000098c0: 726f 756e 6420 666f 7220 7468 6973 2077  round for this w
+000098d0: 6f75 6c64 2062 6520 666f 7220 7468 6520  ould be for the 
+000098e0: 6f70 6572 6174 696f 6e20 6974 7365 6c66  operation itself
+000098f0: 2074 6f20 6368 6563 6b20 6966 2069 7473   to check if its
+00009900: 2069 6e70 7574 2072 6571 7569 7265 7320   input requires 
+00009910: 6772 6164 206f 7220 6e6f 740a 2320 5472  grad or not.# Tr
+00009920: 616e 7366 6f72 6d73 2061 2066 756e 6374  ansforms a funct
+00009930: 696f 6e20 746f 2063 6f6d 7075 7465 2074  ion to compute t
+00009940: 6865 2022 6772 6164 6965 6e74 2220 6f66  he "gradient" of
+00009950: 2069 7473 2069 6e70 7574 7320 7265 7175   its inputs requ
+00009960: 6972 696e 6720 6772 6164 2c20 706f 7373  iring grad, poss
+00009970: 6962 6c79 0a23 2020 206d 6f64 6966 6965  ibly.#   modifie
+00009980: 6420 6279 2074 6865 2067 7261 6420 7370  d by the grad sp
+00009990: 6563 6966 6965 7273 2028 7365 6520 6265  ecifiers (see be
+000099a0: 6c6f 7729 2e0a 2320 5468 6520 6f70 7469  low)..# The opti
+000099b0: 6f6e 616c 2067 7261 645f 7370 6563 6966  onal grad_specif
+000099c0: 6965 7220 6172 6775 6d65 6e74 2061 6363  ier argument acc
+000099d0: 6570 7473 2074 6865 2066 756e 6374 696f  epts the functio
+000099e0: 6e27 7320 6f75 7470 7574 2c20 7275 6e73  n's output, runs
+000099f0: 2069 6e20 6120 6e6f 2d67 7261 6420 636f   in a no-grad co
+00009a00: 6e74 6578 742c 0a23 2020 2061 6e64 2063  ntext,.#   and c
+00009a10: 616e 2070 7574 2067 7261 6473 2028 7573  an put grads (us
+00009a20: 696e 6720 7072 696d 732e 7075 745f 6772  ing prims.put_gr
+00009a30: 6164 2829 2920 666f 7220 7465 6e73 6f72  ad()) for tensor
+00009a40: 732e 2042 7920 6465 6661 756c 742c 2066  s. By default, f
+00009a50: 6f72 2065 7665 7279 2074 656e 736f 7220  or every tensor 
+00009a60: 6f75 7470 7574 2022 6f22 0a23 2020 2074  output "o".#   t
+00009a70: 6861 7420 7265 7175 6972 6573 2067 7261  hat requires gra
+00009a80: 642c 2061 2067 7261 6420 6f66 206f 6e65  d, a grad of one
+00009a90: 735f 6c69 6b65 286f 2920 6973 2070 7574  s_like(o) is put
+00009aa0: 2e0a 2320 5468 6520 6f70 7469 6f6e 616c  ..# The optional
+00009ab0: 2067 7261 645f 6f75 745f 7370 6563 6966   grad_out_specif
+00009ac0: 6965 7220 6163 6365 7074 7320 7468 6520  ier accepts the 
+00009ad0: 6675 6e63 7469 6f6e 2773 2069 6e70 7574  function's input
+00009ae0: 2061 6e64 2063 616e 2063 616c 6c20 7072   and can call pr
+00009af0: 696d 732e 6765 745f 6772 6164 2829 2074  ims.get_grad() t
+00009b00: 6f0a 2320 2020 6163 7175 6972 6520 616e  o.#   acquire an
+00009b10: 6420 7265 7475 726e 2067 7261 6469 656e  d return gradien
+00009b20: 7473 2061 7320 6465 7369 7265 642e 2042  ts as desired. B
+00009b30: 7920 6465 6661 756c 742c 2074 6865 2069  y default, the i
+00009b40: 6e70 7574 2069 7320 666c 6174 7465 6e65  nput is flattene
+00009b50: 640a 2320 2020 2874 7265 655f 666c 6174  d.#   (tree_flat
+00009b60: 7465 6e28 6172 6773 2c20 6b77 6172 6773  ten(args, kwargs
+00009b70: 2929 2061 6e64 2061 2066 6c61 7420 6c69  )) and a flat li
+00009b80: 7374 206f 6620 6772 6164 7320 666f 7220  st of grads for 
+00009b90: 616c 6c20 7465 6e73 6f72 7320 7265 7175  all tensors requ
+00009ba0: 6972 696e 6720 6772 6164 0a23 2020 2061  iring grad.#   a
+00009bb0: 6e64 204e 6f6e 6520 666f 7220 6f74 6865  nd None for othe
+00009bc0: 7220 696e 7075 7473 2069 7320 7265 7475  r inputs is retu
+00009bd0: 726e 6564 2e0a 2320 5468 6520 616c 676f  rned..# The algo
+00009be0: 7269 7468 6d20 666f 7220 6d6f 6469 6679  rithm for modify
+00009bf0: 696e 6720 7468 6520 7072 6f67 7261 6d20  ing the program 
+00009c00: 6861 7320 7468 6520 666f 6c6c 6f77 696e  has the followin
+00009c10: 6720 7374 6570 733a 0a23 2020 2031 2920  g steps:.#   1) 
+00009c20: 466c 6174 7465 6e73 2074 6865 206f 7269  Flattens the ori
+00009c30: 6769 6e61 6c20 7472 6163 6520 666f 7220  ginal trace for 
+00009c40: 7468 6520 6772 6164 2074 7261 6e73 666f  the grad transfo
+00009c50: 726d 202d 2d20 656e 7375 696e 6720 7468  rm -- ensuing th
+00009c60: 6174 2061 6c6c 2074 6f70 2d6c 6576 656c  at all top-level
+00009c70: 2073 796d 626f 6c73 2068 6176 650a 2320   symbols have.# 
+00009c80: 2020 2020 2020 6120 6772 6164 2066 756e        a grad fun
+00009c90: 6374 696f 6e2e 0a64 6566 2067 7261 6428  ction..def grad(
+00009ca0: 0a20 2020 2063 666e 2c20 6772 6164 5f73  .    cfn, grad_s
+00009cb0: 7065 6369 6669 6572 3a20 4361 6c6c 6162  pecifier: Callab
+00009cc0: 6c65 203d 205f 6772 6164 5f73 7065 6369  le = _grad_speci
+00009cd0: 6669 6572 5f64 6566 6175 6c74 2c20 6772  fier_default, gr
+00009ce0: 6164 5f6f 7574 5f73 7065 6369 6669 6572  ad_out_specifier
+00009cf0: 3a20 4361 6c6c 6162 6c65 203d 205f 6772  : Callable = _gr
+00009d00: 6164 5f6f 7574 5f73 7065 6369 6669 6572  ad_out_specifier
+00009d10: 5f64 6566 6175 6c74 0a29 202d 3e20 4361  _default.) -> Ca
+00009d20: 6c6c 6162 6c65 3a0a 2020 2020 2320 4372  llable:.    # Cr
+00009d30: 6561 7465 7320 6120 6375 7374 6f6d 2074  eates a custom t
+00009d40: 7261 6e73 666f 726d 2063 616c 6c61 626c  ransform callabl
+00009d50: 6520 7468 6174 2062 696e 6473 2074 6865  e that binds the
+00009d60: 2061 6464 6974 696f 6e61 6c20 6172 6775   additional argu
+00009d70: 6d65 6e74 7320 746f 2074 6865 2067 7261  ments to the gra
+00009d80: 6420 7472 616e 7366 6f72 6d0a 2020 2020  d transform.    
+00009d90: 406c 616e 6763 7478 284c 616e 6775 6167  @langctx(Languag
+00009da0: 6573 2e43 4c41 4e47 290a 2020 2020 6465  es.CLANG).    de
+00009db0: 6620 5f67 7261 645f 7472 616e 7366 6f72  f _grad_transfor
+00009dc0: 6d28 7472 633a 2054 7261 6365 2c20 2a2c  m(trc: Trace, *,
+00009dd0: 2065 7865 6375 746f 7273 5f6c 6973 743a   executors_list:
+00009de0: 2053 6571 7565 6e63 655b 416e 795d 2920   Sequence[Any]) 
+00009df0: 2d3e 2054 7261 6365 3a0a 2020 2020 2020  -> Trace:.      
+00009e00: 2020 7374 6172 745f 7469 6d65 5f6e 7320    start_time_ns 
+00009e10: 3d20 7469 6d65 2e74 696d 655f 6e73 2829  = time.time_ns()
+00009e20: 0a0a 2020 2020 2020 2020 2320 5354 4550  ..        # STEP
+00009e30: 204f 4e45 202d 2d20 466c 6174 7465 6e73   ONE -- Flattens
+00009e40: 2061 6e64 2064 6365 730a 0a20 2020 2020   and dces..     
+00009e50: 2020 2023 2052 6574 7572 6e73 2054 7275     # Returns Tru
+00009e60: 6520 6966 2074 6865 2062 7379 6d20 6861  e if the bsym ha
+00009e70: 7320 6e6f 2067 7261 6420 6675 6e63 7469  s no grad functi
+00009e80: 6f6e 2c20 616e 6420 736f 206d 7573 7420  on, and so must 
+00009e90: 6265 2066 6c61 7474 656e 6564 2066 6f72  be flattened for
+00009ea0: 2074 6865 2067 7261 6420 7472 616e 7366   the grad transf
+00009eb0: 6f72 6d0a 2020 2020 2020 2020 6e65 7665  orm.        neve
+00009ec0: 725f 666c 6174 7465 6e3a 2073 6574 5b48  r_flatten: set[H
+00009ed0: 6173 6861 626c 655d 203d 207b 7072 696d  ashable] = {prim
+00009ee0: 732e 5072 696d 4944 732e 5245 5455 524e  s.PrimIDs.RETURN
+00009ef0: 2c20 7072 696d 732e 5072 696d 4944 732e  , prims.PrimIDs.
+00009f00: 554e 5041 434b 5f54 5249 5649 414c 7d0a  UNPACK_TRIVIAL}.
+00009f10: 0a20 2020 2020 2020 2064 6566 2073 686f  .        def sho
+00009f20: 756c 645f 666c 6174 7465 6e5f 666f 725f  uld_flatten_for_
+00009f30: 6772 6164 2862 7379 6d3a 2042 6f75 6e64  grad(bsym: Bound
+00009f40: 5379 6d62 6f6c 2920 2d3e 2062 6f6f 6c3a  Symbol) -> bool:
+00009f50: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00009f60: 6273 796d 2e73 796d 2e69 6420 696e 206e  bsym.sym.id in n
+00009f70: 6576 6572 5f66 6c61 7474 656e 3a0a 2020  ever_flatten:.  
+00009f80: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00009f90: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
+00009fa0: 2020 2020 2020 2020 6772 6164 666e 3a20          gradfn: 
+00009fb0: 4e6f 6e65 207c 2043 616c 6c61 626c 6520  None | Callable 
+00009fc0: 3d20 5f67 6574 5f67 7261 6466 6e28 6273  = _get_gradfn(bs
+00009fd0: 796d 2c20 6578 6563 7574 6f72 735f 6c69  ym, executors_li
+00009fe0: 7374 3d65 7865 6375 746f 7273 5f6c 6973  st=executors_lis
+00009ff0: 7429 0a20 2020 2020 2020 2020 2020 2072  t).            r
+0000a000: 6574 7572 6e20 6772 6164 666e 2069 7320  eturn gradfn is 
+0000a010: 4e6f 6e65 0a0a 2020 2020 2020 2020 2320  None..        # 
+0000a020: 544f 444f 2052 4331 3a20 6d61 7962 6520  TODO RC1: maybe 
+0000a030: 6d6f 7665 2074 6f20 7072 6f64 7563 6520  move to produce 
+0000a040: 7468 6573 6520 616c 7761 7973 206f 6e20  these always on 
+0000a050: 6372 6561 7469 6f6e 0a20 2020 2020 2020  creation.       
+0000a060: 2069 6620 7472 632e 6b77 6172 6773 2069   if trc.kwargs i
+0000a070: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000a080: 2020 2020 7472 632e 6b77 6172 6773 203d      trc.kwargs =
+0000a090: 207b 7d0a 2020 2020 2020 2020 6966 2074   {}.        if t
+0000a0a0: 7263 2e66 6e20 6973 204e 6f6e 653a 0a20  rc.fn is None:. 
+0000a0b0: 2020 2020 2020 2020 2020 2074 7263 2e66             trc.f
+0000a0c0: 6e20 3d20 7472 632e 7079 7468 6f6e 5f63  n = trc.python_c
+0000a0d0: 616c 6c61 626c 6528 290a 0a20 2020 2020  allable()..     
+0000a0e0: 2020 2067 7261 6474 7263 203d 2066 726f     gradtrc = fro
+0000a0f0: 6d5f 7472 6163 6528 7472 6329 0a20 2020  m_trace(trc).   
+0000a100: 2020 2020 2066 6c61 7474 656e 6564 5f62       flattened_b
+0000a110: 7379 6d73 3a20 6c69 7374 5b42 6f75 6e64  syms: list[Bound
+0000a120: 5379 6d62 6f6c 5d20 3d20 666c 6174 7465  Symbol] = flatte
+0000a130: 6e5f 666f 725f 7472 616e 7366 6f72 6d28  n_for_transform(
+0000a140: 7368 6f75 6c64 5f66 6c61 7474 656e 5f66  should_flatten_f
+0000a150: 6f72 5f67 7261 642c 2074 7263 2e62 6f75  or_grad, trc.bou
+0000a160: 6e64 5f73 796d 626f 6c73 290a 2020 2020  nd_symbols).    
+0000a170: 2020 2020 6772 6164 7472 632e 626f 756e      gradtrc.boun
+0000a180: 645f 7379 6d62 6f6c 7320 3d20 666c 6174  d_symbols = flat
+0000a190: 7465 6e65 645f 6273 796d 730a 2020 2020  tened_bsyms.    
+0000a1a0: 2020 2020 6772 6164 7472 6320 3d20 6463      gradtrc = dc
+0000a1b0: 6528 6772 6164 7472 6329 0a0a 2020 2020  e(gradtrc)..    
+0000a1c0: 2020 2020 2320 5354 4550 2054 574f 202d      # STEP TWO -
+0000a1d0: 2d20 5265 706c 6163 6573 206f 7269 6769  - Replaces origi
+0000a1e0: 6e61 6c20 6361 6c6c 7320 7769 7468 2067  nal calls with g
+0000a1f0: 7261 6420 6361 6c6c 730a 0a20 2020 2020  rad calls..     
+0000a200: 2020 2023 2044 6566 696e 6573 2074 6865     # Defines the
+0000a210: 2076 6973 6974 6f72 2070 6174 7465 726e   visitor pattern
+0000a220: 2066 6f72 2074 6865 2066 6972 7374 2070   for the first p
+0000a230: 6173 7320 6f66 2074 6865 2067 7261 6420  ass of the grad 
+0000a240: 7472 616e 7366 6f72 6d2c 0a20 2020 2020  transform,.     
+0000a250: 2020 2023 2020 2077 6869 6368 2073 7761     #   which swa
+0000a260: 7073 2042 6f75 6e64 5379 6d62 6f6c 7320  ps BoundSymbols 
+0000a270: 7769 7468 2074 6865 6972 2067 7261 6420  with their grad 
+0000a280: 6675 6e63 7469 6f6e 730a 2020 2020 2020  functions.      
+0000a290: 2020 6465 6620 7669 7369 745f 2862 7379    def visit_(bsy
+0000a2a0: 6d3a 2042 6f75 6e64 5379 6d62 6f6c 2920  m: BoundSymbol) 
+0000a2b0: 2d3e 2043 616c 6c61 626c 653a 0a20 2020  -> Callable:.   
+0000a2c0: 2020 2020 2020 2020 2067 7261 6466 6e3a           gradfn:
+0000a2d0: 204e 6f6e 6520 7c20 4361 6c6c 6162 6c65   None | Callable
+0000a2e0: 203d 205f 6765 745f 6772 6164 666e 2862   = _get_gradfn(b
+0000a2f0: 7379 6d2c 2065 7865 6375 746f 7273 5f6c  sym, executors_l
+0000a300: 6973 743d 6578 6563 7574 6f72 735f 6c69  ist=executors_li
+0000a310: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
+0000a320: 6368 6563 6b28 0a20 2020 2020 2020 2020  check(.         
+0000a330: 2020 2020 2020 2067 7261 6466 6e20 6973         gradfn is
+0000a340: 206e 6f74 204e 6f6e 652c 0a20 2020 2020   not None,.     
+0000a350: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
+0000a360: 613a 2066 2246 6169 6c65 6420 746f 2066  a: f"Failed to f
+0000a370: 696e 6420 6120 6772 6164 666e 2066 6f72  ind a gradfn for
+0000a380: 207b 6273 796d 3d7d 2061 6674 6572 2066   {bsym=} after f
+0000a390: 6c61 7474 656e 696e 6722 2c0a 2020 2020  lattening",.    
+0000a3a0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0000a3b0: 7074 696f 6e5f 7479 7065 3d41 7373 6572  ption_type=Asser
+0000a3c0: 7469 6f6e 4572 726f 722c 0a20 2020 2020  tionError,.     
+0000a3d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000a3e0: 2020 2020 2072 6574 7572 6e20 6772 6164       return grad
+0000a3f0: 666e 0a0a 2020 2020 2020 2020 4077 7261  fn..        @wra
+0000a400: 7073 2874 7263 2e66 6e2e 6d65 7461 2069  ps(trc.fn.meta i
+0000a410: 6620 6973 696e 7374 616e 6365 2874 7263  f isinstance(trc
+0000a420: 2e66 6e2c 2053 796d 626f 6c29 2065 6c73  .fn, Symbol) els
+0000a430: 6520 7472 632e 666e 290a 2020 2020 2020  e trc.fn).      
+0000a440: 2020 6465 6620 696e 7465 7270 7265 7469    def interpreti
+0000a450: 6e67 5f66 6e28 2a61 7267 732c 202a 2a6b  ng_fn(*args, **k
+0000a460: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+0000a470: 2020 2020 7265 7375 6c74 203d 2065 7661      result = eva
+0000a480: 6c5f 7472 6163 6528 6772 6164 7472 632c  l_trace(gradtrc,
+0000a490: 202a 6172 6773 2c20 7379 6d62 6f6c 5f6d   *args, symbol_m
+0000a4a0: 6170 7065 723d 7669 7369 745f 2c20 2a2a  apper=visit_, **
+0000a4b0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+0000a4c0: 2020 2020 2320 5365 7473 2067 7261 6473      # Sets grads
+0000a4d0: 2066 6f72 206f 7574 7075 740a 2020 2020   for output.    
+0000a4e0: 2020 2020 2020 2020 2320 544f 444f 2054          # TODO T
+0000a4f0: 6869 7320 6566 6665 6374 6976 656c 7920  his effectively 
+0000a500: 7275 6e73 2069 6e20 6120 6e6f 2067 7261  runs in a no gra
+0000a510: 6420 636f 6e74 6578 7420 2d2d 2073 686f  d context -- sho
+0000a520: 756c 6420 6974 2072 756e 2069 6e20 6120  uld it run in a 
+0000a530: 6772 6164 2063 6f6e 7465 7874 2c0a 2020  grad context,.  
+0000a540: 2020 2020 2020 2020 2020 2320 2020 6f72            #   or
+0000a550: 2073 686f 756c 6420 7468 6572 6520 6265   should there be
+0000a560: 2074 6865 206f 7074 696f 6e20 746f 2072   the option to r
+0000a570: 756e 2069 7420 696e 2061 2067 7261 6420  un it in a grad 
+0000a580: 636f 6e74 6578 743f 0a20 2020 2020 2020  context?.       
+0000a590: 2020 2020 2067 7261 645f 7370 6563 6966       grad_specif
+0000a5a0: 6965 7228 7265 7375 6c74 290a 2020 2020  ier(result).    
+0000a5b0: 2020 2020 2020 2020 2320 436f 6e73 7472          # Constr
+0000a5c0: 7563 7473 2072 6574 7572 6e20 7661 6c75  ucts return valu
+0000a5d0: 650a 2020 2020 2020 2020 2020 2020 666c  e.            fl
+0000a5e0: 6174 5f67 7261 6473 203d 2067 7261 645f  at_grads = grad_
+0000a5f0: 6f75 745f 7370 6563 6966 6965 7228 2861  out_specifier((a
+0000a600: 7267 732c 206b 7761 7267 7329 290a 2020  rgs, kwargs)).  
+0000a610: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000a620: 2066 6c61 745f 6772 6164 730a 0a20 2020   flat_grads..   
+0000a630: 2020 2020 2023 204e 4f54 4520 4166 7465       # NOTE Afte
+0000a640: 7220 7468 6973 2063 616c 6c20 7468 6520  r this call the 
+0000a650: 6772 6164 7472 6320 6973 2069 6e76 616c  gradtrc is inval
+0000a660: 6964 2c20 6265 6361 7573 653a 0a20 2020  id, because:.   
+0000a670: 2020 2020 2023 2020 2031 2920 5468 6520       #   1) The 
+0000a680: 6e6f 6e2d 6578 6563 7574 6162 6c65 2070  non-executable p
+0000a690: 7574 5f67 7261 6420 6f70 6572 6174 696f  ut_grad operatio
+0000a6a0: 6e73 2061 7265 2073 7469 6c6c 2069 6e20  ns are still in 
+0000a6b0: 7468 6520 7472 6163 652c 2061 6e64 206d  the trace, and m
+0000a6c0: 756c 7469 706c 6520 6361 6c6c 7320 746f  ultiple calls to
+0000a6d0: 2070 7574 2067 7261 6420 6172 6520 6e6f   put grad are no
+0000a6e0: 7420 6163 6375 6d75 6c61 7465 640a 2020  t accumulated.  
+0000a6f0: 2020 2020 2020 2320 2020 3229 2054 6865        #   2) The
+0000a700: 206e 6f6e 2d65 7865 6375 7461 626c 6520   non-executable 
+0000a710: 6765 745f 6772 6164 206f 7065 7261 7469  get_grad operati
+0000a720: 6f6e 7320 6172 6520 7374 696c 6c20 696e  ons are still in
+0000a730: 2074 6865 2074 7261 6365 2c20 616e 6420   the trace, and 
+0000a740: 7468 6579 206d 6179 2070 726f 6475 6365  they may produce
+0000a750: 2064 6966 6665 7265 6e74 2070 726f 7869   different proxi
+0000a760: 6573 2077 6865 6e0a 2020 2020 2020 2020  es when.        
+0000a770: 2320 2020 2020 2020 6361 6c6c 6564 206f  #       called o
+0000a780: 6e20 7468 6520 7361 6d65 2069 6e70 7574  n the same input
+0000a790: 730a 2020 2020 2020 2020 2320 2020 3329  s.        #   3)
+0000a7a0: 2054 6865 206f 7065 7261 7469 6f6e 7320   The operations 
+0000a7b0: 6172 6520 6e6f 7420 696e 2061 2076 616c  are not in a val
+0000a7c0: 6964 206f 7264 6572 0a20 2020 2020 2020  id order.       
+0000a7d0: 2067 7261 6474 7263 203d 2063 6f6e 7374   gradtrc = const
+0000a7e0: 7275 6374 5f74 7261 6365 280a 2020 2020  ruct_trace(.    
+0000a7f0: 2020 2020 2020 2020 7265 6e61 6d65 5f70          rename_p
+0000a800: 726f 7869 6573 3d46 616c 7365 2c0a 2020  roxies=False,.  
+0000a810: 2020 2020 2020 2020 2020 7573 655f 6463            use_dc
+0000a820: 653d 4661 6c73 652c 0a20 2020 2020 2020  e=False,.       
+0000a830: 2029 2869 6e74 6572 7072 6574 696e 675f   )(interpreting_
+0000a840: 666e 2c20 2a67 7261 6474 7263 2e61 7267  fn, *gradtrc.arg
+0000a850: 732c 202a 2a67 7261 6474 7263 2e6b 7761  s, **gradtrc.kwa
+0000a860: 7267 7329 0a20 2020 2020 2020 2067 7261  rgs).        gra
+0000a870: 6474 7263 2e73 636f 7065 7320 3d20 5b67  dtrc.scopes = [g
+0000a880: 7261 6474 7263 2e62 6f75 6e64 5f73 796d  radtrc.bound_sym
+0000a890: 626f 6c73 5d0a 2020 2020 2020 2020 6772  bols].        gr
+0000a8a0: 6164 7472 632e 5f63 6f6d 706c 6574 6520  adtrc._complete 
+0000a8b0: 3d20 4661 6c73 650a 0a20 2020 2020 2020  = False..       
+0000a8c0: 2023 2053 5445 5020 5448 5245 4520 2d2d   # STEP THREE --
+0000a8d0: 2048 616e 646c 6573 2070 7574 5f67 7261   Handles put_gra
+0000a8e0: 6420 616e 6420 6765 745f 6772 6164 206f  d and get_grad o
+0000a8f0: 7065 7261 7469 6f6e 7320 616e 6420 6163  perations and ac
+0000a900: 6375 6d75 6c61 7465 7320 6772 6164 6965  cumulates gradie
+0000a910: 6e74 730a 0a20 2020 2020 2020 2023 2041  nts..        # A
+0000a920: 6363 756d 756c 6174 6573 2067 7261 6469  ccumulates gradi
+0000a930: 656e 7473 2c20 6372 6561 7469 6e67 2074  ents, creating t
+0000a940: 6865 2070 7269 6d61 6c20 2d3e 2061 6363  he primal -> acc
+0000a950: 756d 756c 6174 6564 2067 7261 6420 6d61  umulated grad ma
+0000a960: 7070 696e 670a 2020 2020 2020 2020 2320  pping.        # 
+0000a970: 5365 7473 2074 6865 2074 7261 6369 6e67  Sets the tracing
+0000a980: 2063 6f6e 7465 7874 2073 6f20 6163 6375   context so accu
+0000a990: 6d75 6c61 7469 6f6e 206f 7065 7261 7469  mulation operati
+0000a9a0: 6f6e 7320 6172 6520 7265 636f 7264 6564  ons are recorded
+0000a9b0: 2069 6e74 6f20 7468 6520 7472 6163 650a   into the trace.
+0000a9c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000a9d0: 2020 2020 2020 2020 2074 7261 6365 6374           tracect
+0000a9e0: 785f 746f 6b20 3d20 7365 745f 7472 6163  x_tok = set_trac
+0000a9f0: 6563 7478 2867 7261 6474 7263 290a 0a20  ectx(gradtrc).. 
+0000aa00: 2020 2020 2020 2020 2020 2023 204d 6170             # Map
+0000aa10: 7320 7072 696d 616c 7320 746f 2074 6865  s primals to the
+0000aa20: 6972 2067 7261 6469 656e 7473 2028 7768  ir gradients (wh
+0000aa30: 6963 6820 6172 6520 7265 7475 726e 6564  ich are returned
+0000aa40: 2066 726f 6d20 6361 6c6c 696e 6720 6765   from calling ge
+0000aa50: 745f 6772 6164 206f 6e20 7468 6520 7072  t_grad on the pr
+0000aa60: 696d 616c 290a 2020 2020 2020 2020 2020  imal).          
+0000aa70: 2020 7072 696d 616c 735f 746f 5f67 696e    primals_to_gin
+0000aa80: 7075 745f 6d61 703a 2064 6963 745b 5661  put_map: dict[Va
+0000aa90: 7269 6162 6c65 2c20 5465 6e73 6f72 5072  riable, TensorPr
+0000aaa0: 6f78 795d 203d 207b 7d0a 0a20 2020 2020  oxy] = {}..     
+0000aab0: 2020 2020 2020 2023 2048 616e 646c 6573         # Handles
+0000aac0: 2070 7574 5f67 7261 6420 6f70 6572 6174   put_grad operat
+0000aad0: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
+0000aae0: 2023 204e 4f54 4520 5468 6973 206d 6f64   # NOTE This mod
+0000aaf0: 6966 6965 7320 6120 6c69 7374 2074 6861  ifies a list tha
+0000ab00: 7420 6973 2062 6569 6e67 2065 6e75 6d65  t is being enume
+0000ab10: 7261 7465 6420 6f76 6572 2c20 6275 7420  rated over, but 
+0000ab20: 6974 2773 204f 4b20 6265 6361 7573 6520  it's OK because 
+0000ab30: 7765 2772 6520 6f6e 6c79 0a20 2020 2020  we're only.     
+0000ab40: 2020 2020 2020 2023 2020 2061 7070 656e         #   appen
+0000ab50: 6469 6e67 2074 6f20 7468 6520 656e 6420  ding to the end 
+0000ab60: 6f66 2074 6865 206c 6973 740a 2020 2020  of the list.    
+0000ab70: 2020 2020 2020 2020 6273 796d 3a20 426f          bsym: Bo
+0000ab80: 756e 6453 796d 626f 6c0a 2020 2020 2020  undSymbol.      
+0000ab90: 2020 2020 2020 666f 7220 6273 796d 2069        for bsym i
+0000aba0: 6e20 6772 6164 7472 632e 626f 756e 645f  n gradtrc.bound_
+0000abb0: 7379 6d62 6f6c 733a 0a20 2020 2020 2020  symbols:.       
+0000abc0: 2020 2020 2020 2020 2069 643a 2048 6173           id: Has
+0000abd0: 6861 626c 6520 3d20 6273 796d 2e73 796d  hable = bsym.sym
+0000abe0: 2e69 640a 2020 2020 2020 2020 2020 2020  .id.            
+0000abf0: 2020 2020 6966 2069 6420 6973 2070 6964      if id is pid
+0000ac00: 732e 5055 545f 4752 4144 3a0a 2020 2020  s.PUT_GRAD:.    
+0000ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac20: 7072 696d 616c 3a20 4e75 6d62 6572 207c  primal: Number |
+0000ac30: 2054 656e 736f 7250 726f 7879 0a20 2020   TensorProxy.   
 0000ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac50: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
-0000ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac70: 2020 2023 2054 4f44 4f20 5375 7070 6f72     # TODO Suppor
-0000ac80: 7420 636f 6d70 6c65 7820 6175 746f 6772  t complex autogr
-0000ac90: 6164 0a20 2020 2020 2020 2020 2020 2020  ad.             
-0000aca0: 2020 2020 2020 2063 6865 636b 280a 2020         check(.  
-0000acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000acc0: 2020 2020 2020 6e6f 7420 6474 7970 6573        not dtypes
-0000acd0: 2e69 735f 636f 6d70 6c65 785f 6474 7970  .is_complex_dtyp
-0000ace0: 6528 6474 7970 6573 2e74 6f5f 6474 7970  e(dtypes.to_dtyp
-0000acf0: 6528 7072 696d 616c 2929 2c0a 2020 2020  e(primal)),.    
-0000ad00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad10: 2020 2020 6c61 6d62 6461 3a20 6622 436f      lambda: f"Co
-0000ad20: 6d70 6c65 7820 6772 6164 2069 7320 6e6f  mplex grad is no
-0000ad30: 7420 7375 7070 6f72 7465 6420 7965 7422  t supported yet"
-0000ad40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ad50: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000ad60: 2020 2020 2020 2020 2020 2020 2076 7072               vpr
-0000ad70: 696d 616c 3a20 5661 7269 6162 6c65 203d  imal: Variable =
-0000ad80: 2076 6172 6961 626c 6569 6679 2870 7269   variableify(pri
-0000ad90: 6d61 6c29 0a20 2020 2020 2020 2020 2020  mal).           
-0000ada0: 2020 2020 2020 2020 2061 6363 756d 3a20           accum: 
-0000adb0: 4e6f 6e65 207c 2054 656e 736f 7250 726f  None | TensorPro
-0000adc0: 7879 203d 2070 7269 6d61 6c73 5f74 6f5f  xy = primals_to_
-0000add0: 6769 6e70 7574 5f6d 6170 2e67 6574 2876  ginput_map.get(v
-0000ade0: 7072 696d 616c 2c20 4e6f 6e65 290a 0a20  primal, None).. 
-0000adf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae00: 2020 2069 6620 6163 6375 6d20 6973 204e     if accum is N
-0000ae10: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000ae20: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0000ae30: 6d61 6c73 5f74 6f5f 6769 6e70 7574 5f6d  mals_to_ginput_m
-0000ae40: 6170 5b76 7072 696d 616c 5d20 3d20 6772  ap[vprimal] = gr
-0000ae50: 6164 0a20 2020 2020 2020 2020 2020 2020  ad.             
-0000ae60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000ac50: 2067 7261 643a 204e 756d 6265 7220 7c20   grad: Number | 
+0000ac60: 5465 6e73 6f72 5072 6f78 790a 2020 2020  TensorProxy.    
+0000ac70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac80: 7072 696d 616c 2c20 6772 6164 203d 2062  primal, grad = b
+0000ac90: 7379 6d2e 666c 6174 5f61 7267 730a 0a20  sym.flat_args.. 
+0000aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000acb0: 2020 2023 2054 4f44 4f20 5375 7070 6f72     # TODO Suppor
+0000acc0: 7420 6175 746f 6772 6164 206f 6e20 6e75  t autograd on nu
+0000acd0: 6d62 6572 730a 2020 2020 2020 2020 2020  mbers.          
+0000ace0: 2020 2020 2020 2020 2020 2320 4669 6c74            # Filt
+0000acf0: 6572 7320 6361 6c6c 7320 746f 2070 7574  ers calls to put
+0000ad00: 5f67 7261 6420 7468 6174 2077 6f75 6c64  _grad that would
+0000ad10: 2070 7574 2061 2067 7261 6420 6f6e 2061   put a grad on a
+0000ad20: 206e 6f6e 2d74 656e 736f 7220 6f72 2061   non-tensor or a
+0000ad30: 2074 656e 736f 7220 7468 6174 2064 6f65   tensor that doe
+0000ad40: 736e 2774 2072 6571 7569 7265 2067 7261  sn't require gra
+0000ad50: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+0000ad60: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
+0000ad70: 6e73 7461 6e63 6528 7072 696d 616c 2c20  nstance(primal, 
+0000ad80: 5465 6e73 6f72 5072 6f78 7929 206f 7220  TensorProxy) or 
+0000ad90: 6e6f 7420 7072 696d 616c 2e72 6571 7569  not primal.requi
+0000ada0: 7265 735f 6772 6164 3a0a 2020 2020 2020  res_grad:.      
+0000adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000adc0: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
+0000add0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ade0: 2320 544f 444f 2053 7570 706f 7274 2063  # TODO Support c
+0000adf0: 6f6d 706c 6578 2061 7574 6f67 7261 640a  omplex autograd.
+0000ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ae10: 2020 2020 6368 6563 6b28 0a20 2020 2020      check(.     
+0000ae20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ae30: 2020 206e 6f74 2064 7479 7065 732e 6973     not dtypes.is
+0000ae40: 5f63 6f6d 706c 6578 5f64 7479 7065 2864  _complex_dtype(d
+0000ae50: 7479 7065 732e 746f 5f64 7479 7065 2870  types.to_dtype(p
+0000ae60: 7269 6d61 6c29 292c 0a20 2020 2020 2020  rimal)),.       
 0000ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae80: 2020 2020 2061 6363 756d 203d 2061 6363       accum = acc
-0000ae90: 756d 202b 2067 7261 640a 2020 2020 2020  um + grad.      
-0000aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aeb0: 2020 7072 696d 616c 735f 746f 5f67 696e    primals_to_gin
-0000aec0: 7075 745f 6d61 705b 7670 7269 6d61 6c5d  put_map[vprimal]
-0000aed0: 203d 2061 6363 756d 0a0a 2020 2020 2020   = accum..      
-0000aee0: 2020 2020 2020 2320 4861 6e64 6c65 7320        # Handles 
-0000aef0: 6765 745f 6772 6164 206f 7065 7261 7469  get_grad operati
-0000af00: 6f6e 730a 0a20 2020 2020 2020 2020 2020  ons..           
-0000af10: 2023 2052 6573 6574 7320 7468 6520 7377   # Resets the sw
-0000af20: 6170 6d61 7020 666f 7220 6772 6164 730a  apmap for grads.
-0000af30: 2020 2020 2020 2020 2020 2020 7377 6170              swap
-0000af40: 6d61 703a 2064 6963 745b 5661 7269 6162  map: dict[Variab
-0000af50: 6c65 2c20 5072 6f78 795d 203d 207b 7d0a  le, Proxy] = {}.
-0000af60: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0000af70: 2062 7379 6d20 696e 2067 7261 6474 7263   bsym in gradtrc
-0000af80: 2e62 6f75 6e64 5f73 796d 626f 6c73 3a0a  .bound_symbols:.
-0000af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000afa0: 6964 3a20 4861 7368 6162 6c65 203d 2062  id: Hashable = b
-0000afb0: 7379 6d2e 7379 6d2e 6964 0a20 2020 2020  sym.sym.id.     
-0000afc0: 2020 2020 2020 2020 2020 2069 6620 6964             if id
-0000afd0: 2069 7320 7069 6473 2e47 4554 5f47 5241   is pids.GET_GRA
-0000afe0: 443a 0a20 2020 2020 2020 2020 2020 2020  D:.             
-0000aff0: 2020 2020 2020 2070 7269 6d61 6c3a 204e         primal: N
-0000b000: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-0000b010: 6f78 790a 2020 2020 2020 2020 2020 2020  oxy.            
-0000b020: 2020 2020 2020 2020 2870 7269 6d61 6c2c          (primal,
-0000b030: 2920 3d20 6273 796d 2e66 6c61 745f 6172  ) = bsym.flat_ar
-0000b040: 6773 0a20 2020 2020 2020 2020 2020 2020  gs.             
-0000b050: 2020 2020 2020 2067 7261 643a 204e 756d         grad: Num
-0000b060: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-0000b070: 7920 3d20 6273 796d 2e6f 7574 7075 740a  y = bsym.output.
-0000b080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b090: 2020 2020 2076 7072 696d 616c 3a20 5661       vprimal: Va
-0000b0a0: 7269 6162 6c65 0a20 2020 2020 2020 2020  riable.         
-0000b0b0: 2020 2020 2020 2020 2020 2076 6772 6164             vgrad
-0000b0c0: 3a20 5661 7269 6162 6c65 0a20 2020 2020  : Variable.     
-0000b0d0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0000b0e0: 7072 696d 616c 2c20 7667 7261 6420 3d20  primal, vgrad = 
-0000b0f0: 7661 7269 6162 6c65 6966 7928 7072 696d  variableify(prim
-0000b100: 616c 292c 2076 6172 6961 626c 6569 6679  al), variableify
-0000b110: 2867 7261 6429 0a0a 2020 2020 2020 2020  (grad)..        
-0000b120: 2020 2020 2020 2020 2020 2020 6163 7475              actu
-0000b130: 616c 5f67 7261 643a 204e 6f6e 6520 7c20  al_grad: None | 
-0000b140: 5465 6e73 6f72 5072 6f78 7920 3d20 7072  TensorProxy = pr
-0000b150: 696d 616c 735f 746f 5f67 696e 7075 745f  imals_to_ginput_
-0000b160: 6d61 702e 6765 7428 7670 7269 6d61 6c2c  map.get(vprimal,
-0000b170: 204e 6f6e 6529 0a0a 2020 2020 2020 2020   None)..        
-0000b180: 2020 2020 2020 2020 2020 2020 2320 4e4f              # NO
-0000b190: 5445 2049 6620 6163 7475 616c 5f67 7261  TE If actual_gra
-0000b1a0: 6420 6973 204e 6f6e 6520 7468 656e 2074  d is None then t
-0000b1b0: 6865 7265 2773 2061 2067 6574 5f67 7261  here's a get_gra
-0000b1c0: 6428 2920 7265 7175 6573 7420 666f 7220  d() request for 
-0000b1d0: 6120 7465 6e73 6f72 2077 6869 6368 0a20  a tensor which. 
-0000b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1f0: 2020 2023 2020 2068 6173 206e 6f20 7075     #   has no pu
-0000b200: 745f 6772 6164 2829 2c20 736f 2077 6520  t_grad(), so we 
-0000b210: 7265 7475 726e 207a 6572 6f73 2066 6f72  return zeros for
-0000b220: 2074 6865 2067 7261 640a 2020 2020 2020   the grad.      
-0000b230: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000b240: 544f 444f 2052 6576 6973 6974 2074 6869  TODO Revisit thi
-0000b250: 7320 2d2d 2063 616e 2077 6520 7265 6d6f  s -- can we remo
-0000b260: 7665 2074 6865 7365 2063 6f6d 7075 7461  ve these computa
-0000b270: 7469 6f6e 732c 206f 7220 7573 6520 6120  tions, or use a 
-0000b280: 7370 6563 6961 6c20 5a65 726f 5465 6e73  special ZeroTens
-0000b290: 6f72 0a20 2020 2020 2020 2020 2020 2020  or.             
-0000b2a0: 2020 2020 2020 2023 2020 2074 6f20 7369         #   to si
-0000b2b0: 6d70 6c69 6679 2074 6865 6d3f 0a20 2020  mplify them?.   
-0000b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b2d0: 2069 6620 6163 7475 616c 5f67 7261 6420   if actual_grad 
-0000b2e0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0000b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b300: 2061 6374 7561 6c5f 6772 6164 203d 206c   actual_grad = l
-0000b310: 746f 7263 682e 7a65 726f 735f 6c69 6b65  torch.zeros_like
-0000b320: 2870 7269 6d61 6c29 0a20 2020 2020 2020  (primal).       
-0000b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b340: 2070 7269 6d61 6c73 5f74 6f5f 6769 6e70   primals_to_ginp
-0000b350: 7574 5f6d 6170 5b76 7072 696d 616c 5d20  ut_map[vprimal] 
-0000b360: 3d20 6163 7475 616c 5f67 7261 640a 0a20  = actual_grad.. 
-0000b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b380: 2020 2023 2055 7064 6174 6573 2074 6865     # Updates the
-0000b390: 2067 7261 6420 616c 6961 7320 6d61 700a   grad alias map.
-0000b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3b0: 2020 2020 7661 6374 7561 6c5f 6772 6164      vactual_grad
-0000b3c0: 3a20 5661 7269 6162 6c65 203d 2076 6172  : Variable = var
-0000b3d0: 6961 626c 6569 6679 2861 6374 7561 6c5f  iableify(actual_
-0000b3e0: 6772 6164 290a 2020 2020 2020 2020 2020  grad).          
-0000b3f0: 2020 2020 2020 2020 2020 6966 2076 6163            if vac
-0000b400: 7475 616c 5f67 7261 6420 213d 2076 6772  tual_grad != vgr
-0000b410: 6164 3a0a 2020 2020 2020 2020 2020 2020  ad:.            
-0000b420: 2020 2020 2020 2020 2020 2020 7377 6170              swap
-0000b430: 6d61 705b 7667 7261 645d 203d 2061 6374  map[vgrad] = act
-0000b440: 7561 6c5f 6772 6164 0a0a 2020 2020 2020  ual_grad..      
-0000b450: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
-0000b460: 2020 2020 2020 2023 2052 6573 746f 7265         # Restore
-0000b470: 7320 7363 6f70 650a 2020 2020 2020 2020  s scope.        
-0000b480: 2020 2020 7265 7365 745f 7472 6163 6563      reset_tracec
-0000b490: 7478 2874 7261 6365 6374 785f 746f 6b29  tx(tracectx_tok)
-0000b4a0: 0a0a 2020 2020 2020 2020 2320 4669 6c74  ..        # Filt
-0000b4b0: 6572 7320 7075 745f 6772 6164 2061 6e64  ers put_grad and
-0000b4c0: 2067 6574 5f67 7261 6420 6f70 6572 6174   get_grad operat
-0000b4d0: 696f 6e73 2061 6e64 2061 7070 6c69 6573  ions and applies
-0000b4e0: 2074 6865 2073 7761 706d 6170 0a20 2020   the swapmap.   
-0000b4f0: 2020 2020 2064 6566 205f 6669 6c74 6572       def _filter
-0000b500: 2862 7379 6d3a 2042 6f75 6e64 5379 6d62  (bsym: BoundSymb
-0000b510: 6f6c 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ol) -> bool:.   
-0000b520: 2020 2020 2020 2020 2069 643a 2048 6173           id: Has
-0000b530: 6861 626c 6520 3d20 6273 796d 2e73 796d  hable = bsym.sym
-0000b540: 2e69 640a 2020 2020 2020 2020 2020 2020  .id.            
-0000b550: 7265 7475 726e 2069 6420 696e 2028 7069  return id in (pi
-0000b560: 6473 2e50 5554 5f47 5241 442c 2070 6964  ds.PUT_GRAD, pid
-0000b570: 732e 4745 545f 4752 4144 290a 0a20 2020  s.GET_GRAD)..   
-0000b580: 2020 2020 2067 7261 6474 7263 2e62 6f75       gradtrc.bou
-0000b590: 6e64 5f73 796d 626f 6c73 203d 205b 0a20  nd_symbols = [. 
-0000b5a0: 2020 2020 2020 2020 2020 2062 7379 6d2e             bsym.
-0000b5b0: 6672 6f6d 5f62 7379 6d5f 7377 6170 5f70  from_bsym_swap_p
-0000b5c0: 726f 7869 6573 2873 7761 706d 6170 2920  roxies(swapmap) 
-0000b5d0: 666f 7220 6273 796d 2069 6e20 6772 6164  for bsym in grad
-0000b5e0: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
-0000b5f0: 7320 6966 206e 6f74 205f 6669 6c74 6572  s if not _filter
-0000b600: 2862 7379 6d29 0a20 2020 2020 2020 205d  (bsym).        ]
-0000b610: 0a0a 2020 2020 2020 2020 2320 5354 4550  ..        # STEP
-0000b620: 2046 4f55 5220 2d2d 2d20 4f72 6465 7273   FOUR --- Orders
-0000b630: 2074 6865 206f 7065 7261 7469 6f6e 730a   the operations.
-0000b640: 2020 2020 2020 2020 2320 544f 444f 2043          # TODO C
-0000b650: 6f6e 7369 6465 7220 616c 7465 726e 6174  onsider alternat
-0000b660: 6976 6520 7363 6865 6475 6c69 6e67 2061  ive scheduling a
-0000b670: 6c67 6f72 6974 686d 732c 206d 6179 6265  lgorithms, maybe
-0000b680: 2062 7920 7573 696e 6720 6772 6170 6820   by using graph 
-0000b690: 6665 6174 7572 6573 0a20 2020 2020 2020  features.       
-0000b6a0: 2023 2020 2053 6f6d 6520 6964 6561 7320   #   Some ideas 
-0000b6b0: 6172 6520 6c6f 6f6b 696e 6720 6174 206d  are looking at m
-0000b6c0: 656d 6f72 792d 7361 7669 6e67 206e 6f64  emory-saving nod
-0000b6d0: 6573 2c20 616e 6420 6e6f 6465 7320 7769  es, and nodes wi
-0000b6e0: 7468 2061 2068 6967 6820 696e 2d64 6567  th a high in-deg
-0000b6f0: 7265 6520 6f72 2068 6967 6820 6f75 742d  ree or high out-
-0000b700: 6465 6772 6565 0a0a 2020 2020 2020 2020  degree..        
-0000b710: 2320 4372 6561 7465 7320 616e 2069 6e69  # Creates an ini
-0000b720: 7469 616c 2076 616c 6964 206f 7264 6572  tial valid order
-0000b730: 696e 6720 746f 2044 4345 2c20 736f 2074  ing to DCE, so t
-0000b740: 6861 7420 6164 6469 7469 6f6e 616c 206f  hat additional o
-0000b750: 7264 6572 696e 6720 616e 616c 7973 6973  rdering analysis
-0000b760: 2064 6f65 736e 2774 206e 6565 6420 746f   doesn't need to
-0000b770: 2063 6f6e 7369 6465 7220 616c 6c20 7379   consider all sy
-0000b780: 6d62 6f6c 730a 2020 2020 2020 2020 726f  mbols.        ro
-0000b790: 6f74 732c 206c 6561 7665 7320 3d20 6273  ots, leaves = bs
-0000b7a0: 796d 5f6c 6973 745f 746f 5f64 6167 2867  ym_list_to_dag(g
-0000b7b0: 7261 6474 7263 2e62 6f75 6e64 5f73 796d  radtrc.bound_sym
-0000b7c0: 626f 6c73 290a 2020 2020 2020 2020 6f72  bols).        or
-0000b7d0: 6465 7265 645f 6273 796d 7320 3d20 746f  dered_bsyms = to
-0000b7e0: 706f 736f 7274 5f62 7379 6d5f 6461 6728  posort_bsym_dag(
-0000b7f0: 726f 6f74 732c 2054 4f50 4f53 4f52 545f  roots, TOPOSORT_
-0000b800: 4f52 4445 522e 544f 505f 444f 574e 290a  ORDER.TOP_DOWN).
-0000b810: 2020 2020 2020 2020 6772 6164 7472 632e          gradtrc.
-0000b820: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
-0000b830: 6f72 6465 7265 645f 6273 796d 730a 2020  ordered_bsyms.  
-0000b840: 2020 2020 2020 6772 6164 7472 6320 3d20        gradtrc = 
-0000b850: 6463 6528 6772 6164 7472 6329 0a0a 2020  dce(gradtrc)..  
-0000b860: 2020 2020 2020 2320 4964 656e 7469 6669        # Identifi
-0000b870: 6573 2074 6865 206f 7264 6572 206f 6620  es the order of 
-0000b880: 426f 756e 6453 796d 626f 6c73 2075 7369  BoundSymbols usi
-0000b890: 6e67 2061 2022 4446 5320 616e 6420 6368  ng a "DFS and ch
-0000b8a0: 6169 6e22 2061 6c67 6f72 6974 686d 0a20  ain" algorithm. 
-0000b8b0: 2020 2020 2020 2023 2054 4f44 4f20 456c         # TODO El
-0000b8c0: 6162 6f72 6174 6520 6f6e 2074 6869 7320  aborate on this 
-0000b8d0: 616c 676f 7269 7468 6d20 616e 6420 7468  algorithm and th
-0000b8e0: 6520 696d 706c 656d 656e 7461 7469 6f6e  e implementation
-0000b8f0: 0a20 2020 2020 2020 2072 6f6f 7473 2c20  .        roots, 
-0000b900: 6c65 6176 6573 203d 2062 7379 6d5f 6c69  leaves = bsym_li
-0000b910: 7374 5f74 6f5f 6461 6728 6772 6164 7472  st_to_dag(gradtr
-0000b920: 632e 626f 756e 645f 7379 6d62 6f6c 7329  c.bound_symbols)
-0000b930: 0a20 2020 2020 2020 2063 6865 636b 280a  .        check(.
-0000b940: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
-0000b950: 6c65 6176 6573 2920 3d3d 2031 2c0a 2020  leaves) == 1,.  
-0000b960: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
-0000b970: 3a20 6622 4578 7065 6374 6564 206f 6e6c  : f"Expected onl
-0000b980: 7920 6f6e 6520 6c65 6166 206e 6f64 6520  y one leaf node 
-0000b990: 7768 656e 2073 6f72 7469 6e67 2066 6f72  when sorting for
-0000b9a0: 2067 7261 642c 2066 6f75 6e64 2074 6865   grad, found the
-0000b9b0: 7265 2077 6572 6520 7b6c 656e 286c 6561  re were {len(lea
-0000b9c0: 7665 7329 7d20 6c65 6176 6573 222c 0a20  ves)} leaves",. 
-0000b9d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000b9e0: 2028 6c65 6166 2c29 203d 206c 6561 7665   (leaf,) = leave
-0000b9f0: 730a 0a20 2020 2020 2020 2023 2043 6f6d  s..        # Com
-0000ba00: 7075 7465 7320 7468 6520 7465 6e73 6f72  putes the tensor
-0000ba10: 206d 656d 6f72 7920 7573 6564 2062 7920   memory used by 
-0000ba20: 7468 6520 6769 7665 6e20 7079 7472 6565  the given pytree
-0000ba30: 0a20 2020 2020 2020 2064 6566 206d 656d  .        def mem
-0000ba40: 6f72 795f 7573 6564 2870 7974 7265 6529  ory_used(pytree)
-0000ba50: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
-0000ba60: 2020 2020 206d 656d 6f72 795f 7573 653a       memory_use:
-0000ba70: 2069 6e74 203d 2030 0a0a 2020 2020 2020   int = 0..      
-0000ba80: 2020 2020 2020 6465 6620 636f 756e 745f        def count_
-0000ba90: 6d65 6d6f 7279 5f75 7365 2878 293a 0a20  memory_use(x):. 
-0000baa0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000bab0: 6f6e 6c6f 6361 6c20 6d65 6d6f 7279 5f75  onlocal memory_u
-0000bac0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0000bad0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0000bae0: 2878 2c20 5465 6e73 6f72 5072 6f78 7929  (x, TensorProxy)
-0000baf0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000bb00: 2020 2020 2020 6d65 6d6f 7279 5f75 7365        memory_use
-0000bb10: 202b 3d20 782e 6474 7970 652e 5f62 7974   += x.dtype._byt
-0000bb20: 6573 202a 2078 2e6e 756d 656c 0a0a 2020  es * x.numel..  
-0000bb30: 2020 2020 2020 2020 2020 7472 6565 5f6d            tree_m
-0000bb40: 6170 2863 6f75 6e74 5f6d 656d 6f72 795f  ap(count_memory_
-0000bb50: 7573 652c 2070 7974 7265 6529 0a20 2020  use, pytree).   
-0000bb60: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000bb70: 6d65 6d6f 7279 5f75 7365 0a0a 2020 2020  memory_use..    
-0000bb80: 2020 2020 2320 5472 7565 2077 6865 6e20      # True when 
-0000bb90: 6120 6e6f 6465 2069 7320 6120 226c 696e  a node is a "lin
-0000bba0: 6b22 202d 2d20 6120 6e6f 6465 2077 6974  k" -- a node wit
-0000bbb0: 6820 6f6e 6c79 206f 6e65 2063 6869 6c64  h only one child
-0000bbc0: 2061 6e64 2061 7420 6d6f 7374 206f 6e65   and at most one
-0000bbd0: 2070 6172 656e 740a 2020 2020 2020 2020   parent.        
-0000bbe0: 2320 2020 436f 6e63 6570 7475 616c 6c79  #   Conceptually
-0000bbf0: 2074 6865 206e 6f64 6520 6973 2061 2022   the node is a "
-0000bc00: 6c69 6e6b 2220 696e 2061 2063 6861 696e  link" in a chain
-0000bc10: 206f 6620 6e6f 6465 7320 6c69 6b65 2041   of nodes like A
-0000bc20: 202d 3e20 4220 2d3e 2043 0a20 2020 2020   -> B -> C.     
-0000bc30: 2020 2064 6566 2069 735f 6c69 6e6b 286e     def is_link(n
-0000bc40: 3a20 4e6f 6465 2920 2d3e 2062 6f6f 6c3a  : Node) -> bool:
-0000bc50: 0a20 2020 2020 2020 2020 2020 205f 6973  .            _is
-0000bc60: 5f6c 696e 6b20 3d20 6c65 6e28 6e2e 6368  _link = len(n.ch
-0000bc70: 696c 6472 656e 2920 3d3d 2031 2061 6e64  ildren) == 1 and
-0000bc80: 206c 656e 286e 2e70 6172 656e 7473 2920   len(n.parents) 
-0000bc90: 3c3d 2031 0a20 2020 2020 2020 2020 2020  <= 1.           
-0000bca0: 2072 6574 7572 6e20 5f69 735f 6c69 6e6b   return _is_link
-0000bcb0: 0a0a 2020 2020 2020 2020 636f 756e 7465  ..        counte
-0000bcc0: 723a 2069 6e74 203d 2030 0a0a 2020 2020  r: int = 0..    
-0000bcd0: 2020 2020 6465 6620 5f63 6861 696e 2863      def _chain(c
-0000bce0: 3a20 6c69 7374 5b4e 6f64 655d 2c20 656e  : list[Node], en
-0000bcf0: 643a 204e 6f64 6529 202d 3e20 6c69 7374  d: Node) -> list
-0000bd00: 5b4e 6f64 655d 3a0a 2020 2020 2020 2020  [Node]:.        
-0000bd10: 2020 2020 6e6f 6e6c 6f63 616c 2063 6f75      nonlocal cou
-0000bd20: 6e74 6572 0a0a 2020 2020 2020 2020 2020  nter..          
-0000bd30: 2020 2320 544f 444f 2045 7870 6572 696d    # TODO Experim
-0000bd40: 656e 7420 7769 7468 206e 6f74 2061 6c77  ent with not alw
-0000bd50: 6179 7320 6675 7369 6e67 2074 6869 7320  ays fusing this 
-0000bd60: 696e 746f 2074 6865 2063 6f6e 7375 6d65  into the consume
-0000bd70: 7220 2d2d 2074 6865 7265 2063 6f75 6c64  r -- there could
-0000bd80: 2062 6520 616e 0a20 2020 2020 2020 2020   be an.         
-0000bd90: 2020 2023 2020 2069 6e74 6572 6573 7469     #   interesti
-0000bda0: 6e67 206d 696e 6375 740a 2020 2020 2020  ng mincut.      
-0000bdb0: 2020 2020 2020 2320 4e4f 5445 2049 6e20        # NOTE In 
-0000bdc0: 7468 6973 2063 6173 6520 7468 6520 6368  this case the ch
-0000bdd0: 6169 6e20 6361 6e6e 6f74 2062 6520 6578  ain cannot be ex
-0000bde0: 7465 6e64 6564 2c20 616e 6420 6974 7320  tended, and its 
-0000bdf0: 6f72 6967 696e 2069 7320 696e 7075 7420  origin is input 
-0000be00: 746f 2074 6865 2066 756e 6374 696f 6e0a  to the function.
-0000be10: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0000be20: 736f 2074 6869 7320 6a75 7374 2066 7573  so this just fus
-0000be30: 6573 2069 7420 696e 746f 2074 6865 2063  es it into the c
-0000be40: 6f6e 7375 6d65 720a 2020 2020 2020 2020  onsumer.        
-0000be50: 2020 2020 6966 206c 656e 2865 6e64 2e70      if len(end.p
-0000be60: 6172 656e 7473 2920 3d3d 2030 3a0a 2020  arents) == 0:.  
-0000be70: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0000be80: 7220 6e20 696e 2063 3a0a 2020 2020 2020  r n in c:.      
-0000be90: 2020 2020 2020 2020 2020 2020 2020 6e2e                n.
-0000bea0: 6e75 6d62 6572 203d 2063 6f75 6e74 6572  number = counter
-0000beb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bec0: 2020 2020 2063 6f75 6e74 6572 202b 3d20       counter += 
-0000bed0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-0000bee0: 2020 7265 7475 726e 205b 5d0a 0a20 2020    return []..   
-0000bef0: 2020 2020 2020 2020 2023 204e 4f54 4520           # NOTE 
-0000bf00: 6c65 6e28 656e 642e 7061 7265 6e74 7329  len(end.parents)
-0000bf10: 203d 3d20 3120 6f6e 2074 6869 7320 7061   == 1 on this pa
-0000bf20: 7468 0a20 2020 2020 2020 2020 2020 2028  th.            (
-0000bf30: 7061 7265 6e74 2c29 203d 2065 6e64 2e70  parent,) = end.p
-0000bf40: 6172 656e 7473 0a0a 2020 2020 2020 2020  arents..        
-0000bf50: 2020 2020 2320 4578 7465 6e64 7320 7468      # Extends th
-0000bf60: 6520 6368 6169 6e20 6966 2074 6865 2070  e chain if the p
-0000bf70: 6172 656e 7420 6973 2061 206c 696e 6b0a  arent is a link.
-0000bf80: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0000bf90: 735f 6c69 6e6b 2870 6172 656e 7429 3a0a  s_link(parent):.
-0000bfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bfb0: 632e 6170 7065 6e64 2870 6172 656e 7429  c.append(parent)
-0000bfc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bfd0: 2072 6574 7572 6e20 5f63 6861 696e 2863   return _chain(c
-0000bfe0: 2c20 7061 7265 6e74 290a 0a20 2020 2020  , parent)..     
-0000bff0: 2020 2020 2020 2023 204e 4f54 4520 496e         # NOTE In
-0000c000: 2074 6869 7320 6361 7365 2074 6865 2063   this case the c
-0000c010: 6861 696e 2068 6173 2061 2070 6172 656e  hain has a paren
-0000c020: 7420 7468 6174 2069 7320 6e6f 7420 6120  t that is not a 
-0000c030: 6c69 6e6b 0a20 2020 2020 2020 2020 2020  link.           
-0000c040: 2023 2046 696e 6473 2074 6865 206d 696e   # Finds the min
-0000c050: 6375 740a 2020 2020 2020 2020 2020 2020  cut.            
-0000c060: 6d69 6e63 7574 5f69 6478 3a20 696e 7420  mincut_idx: int 
-0000c070: 3d20 6c65 6e28 6329 0a20 2020 2020 2020  = len(c).       
-0000c080: 2020 2020 206d 696e 5f6d 656d 6f72 795f       min_memory_
-0000c090: 7573 6167 653a 2069 6e74 203d 206d 656d  usage: int = mem
-0000c0a0: 6f72 795f 7573 6564 2870 6172 656e 742e  ory_used(parent.
-0000c0b0: 6273 796d 2e6f 7574 7075 7429 0a0a 2020  bsym.output)..  
-0000c0c0: 2020 2020 2020 2020 2020 666f 7220 6964            for id
-0000c0d0: 782c 206e 2069 6e20 656e 756d 6572 6174  x, n in enumerat
-0000c0e0: 6528 6329 3a0a 2020 2020 2020 2020 2020  e(c):.          
-0000c0f0: 2020 2020 2020 6d65 6d20 3d20 6d65 6d6f        mem = memo
-0000c100: 7279 5f75 7365 6428 6e2e 6273 796d 2e6f  ry_used(n.bsym.o
-0000c110: 7574 7075 7429 0a20 2020 2020 2020 2020  utput).         
-0000c120: 2020 2020 2020 2069 6620 6d65 6d20 3c20         if mem < 
-0000c130: 6d69 6e5f 6d65 6d6f 7279 5f75 7361 6765  min_memory_usage
-0000c140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c150: 2020 2020 2020 6d69 6e63 7574 5f69 6478        mincut_idx
-0000c160: 203d 2069 6478 0a20 2020 2020 2020 2020   = idx.         
-0000c170: 2020 2020 2020 2020 2020 206d 696e 5f6d             min_m
-0000c180: 656d 6f72 795f 7573 6167 6520 3d20 6d65  emory_usage = me
-0000c190: 6d0a 0a20 2020 2020 2020 2020 2020 2066  m..            f
-0000c1a0: 6f72 2069 6478 2c20 6e20 696e 2065 6e75  or idx, n in enu
-0000c1b0: 6d65 7261 7465 2863 293a 0a20 2020 2020  merate(c):.     
-0000c1c0: 2020 2020 2020 2020 2020 2069 6620 6964             if id
-0000c1d0: 7820 3c20 6d69 6e63 7574 5f69 6478 3a0a  x < mincut_idx:.
-0000c1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c1f0: 2020 2020 6e2e 6e75 6d62 6572 203d 2063      n.number = c
-0000c200: 6f75 6e74 6572 0a20 2020 2020 2020 2020  ounter.         
-0000c210: 2020 2020 2020 2020 2020 2063 6f75 6e74             count
-0000c220: 6572 202b 3d20 310a 0a20 2020 2020 2020  er += 1..       
-0000c230: 2020 2020 2023 2052 6574 7572 6e73 2074       # Returns t
-0000c240: 6865 2070 726f 6475 6365 722d 7369 6465  he producer-side
-0000c250: 2063 6861 696e 2063 7574 2069 6620 6974   chain cut if it
-0000c260: 2065 7869 7374 730a 2020 2020 2020 2020   exists.        
-0000c270: 2020 2020 6966 206d 696e 6375 745f 6964      if mincut_id
-0000c280: 7820 3c20 6c65 6e28 6329 3a0a 2020 2020  x < len(c):.    
-0000c290: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000c2a0: 726e 205b 635b 6d69 6e63 7574 5f69 6478  rn [c[mincut_idx
-0000c2b0: 5d5d 0a20 2020 2020 2020 2020 2020 2065  ]].            e
-0000c2c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000c2d0: 2020 2020 2061 7373 6572 7420 6d69 6e63       assert minc
-0000c2e0: 7574 5f69 6478 203d 3d20 6c65 6e28 6329  ut_idx == len(c)
-0000c2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c300: 2072 6574 7572 6e20 656e 642e 7061 7265   return end.pare
-0000c310: 6e74 730a 0a20 2020 2020 2020 2064 6566  nts..        def
-0000c320: 2063 6861 696e 5f6f 7574 286e 3a20 4e6f   chain_out(n: No
-0000c330: 6465 2c20 7374 6163 6b3a 206c 6973 745b  de, stack: list[
-0000c340: 4e6f 6465 5d29 202d 3e20 4e6f 6e65 3a0a  Node]) -> None:.
-0000c350: 2020 2020 2020 2020 2020 2020 2320 5368              # Sh
-0000c360: 6f72 742d 6369 7263 7569 7473 2069 6620  ort-circuits if 
-0000c370: 7468 6520 6f72 6967 696e 616c 206e 6f64  the original nod
-0000c380: 6520 6e20 6361 6e6e 6f74 2062 6520 7061  e n cannot be pa
-0000c390: 7274 206f 6620 6120 6368 6169 6e0a 2020  rt of a chain.  
-0000c3a0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0000c3b0: 2069 735f 6c69 6e6b 286e 293a 0a20 2020   is_link(n):.   
-0000c3c0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-0000c3d0: 636b 2e61 7070 656e 6428 6e29 0a20 2020  ck.append(n).   
-0000c3e0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000c3f0: 7572 6e0a 0a20 2020 2020 2020 2020 2020  urn..           
-0000c400: 2023 204e 4f54 4520 6973 5f6c 696e 6b28   # NOTE is_link(
-0000c410: 6e29 203d 3d20 5472 7565 0a20 2020 2020  n) == True.     
-0000c420: 2020 2020 2020 2070 6f73 745f 6368 6169         post_chai
-0000c430: 6e3a 206c 6973 745b 4e6f 6465 5d20 3d20  n: list[Node] = 
-0000c440: 5f63 6861 696e 285b 6e5d 2c20 6e29 0a0a  _chain([n], n)..
-0000c450: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000c460: 7063 2069 6e20 706f 7374 5f63 6861 696e  pc in post_chain
-0000c470: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c480: 2020 7374 6163 6b2e 6170 7065 6e64 2870    stack.append(p
-0000c490: 6329 0a0a 2020 2020 2020 2020 7374 6163  c)..        stac
-0000c4a0: 6b3a 206c 6973 745b 4e6f 6465 5d20 3d20  k: list[Node] = 
-0000c4b0: 5b6c 6561 665d 0a20 2020 2020 2020 2077  [leaf].        w
-0000c4c0: 6869 6c65 206c 656e 2873 7461 636b 2920  hile len(stack) 
-0000c4d0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-0000c4e0: 206e 3a20 4e6f 6465 203d 2073 7461 636b   n: Node = stack
-0000c4f0: 2e70 6f70 2829 0a0a 2020 2020 2020 2020  .pop()..        
-0000c500: 2020 2020 6966 206e 2e6e 756d 6265 7220      if n.number 
-0000c510: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0000c520: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0000c530: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
-0000c540: 2020 206e 2e6e 756d 6265 7220 3d20 636f     n.number = co
-0000c550: 756e 7465 720a 2020 2020 2020 2020 2020  unter.          
-0000c560: 2020 636f 756e 7465 7220 2b3d 2031 0a0a    counter += 1..
-0000c570: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000c580: 7020 696e 206e 2e70 6172 656e 7473 3a0a  p in n.parents:.
-0000c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5a0: 6368 6169 6e5f 6f75 7428 702c 2073 7461  chain_out(p, sta
-0000c5b0: 636b 290a 0a20 2020 2020 2020 2064 6566  ck)..        def
-0000c5c0: 205f 7365 6c65 6374 6f72 2865 6c69 6769   _selector(eligi
-0000c5d0: 626c 655f 6e6f 6465 733a 206c 6973 745b  ble_nodes: list[
-0000c5e0: 4e6f 6465 5d29 202d 3e20 696e 743a 0a20  Node]) -> int:. 
-0000c5f0: 2020 2020 2020 2020 2020 206d 696e 5f69             min_i
-0000c600: 6478 3a20 696e 7420 3d20 300a 2020 2020  dx: int = 0.    
-0000c610: 2020 2020 2020 2020 6d69 6e5f 6e75 6d62          min_numb
-0000c620: 6572 3a20 696e 7420 3d20 656c 6967 6962  er: int = eligib
-0000c630: 6c65 5f6e 6f64 6573 5b30 5d2e 6e75 6d62  le_nodes[0].numb
-0000c640: 6572 0a0a 2020 2020 2020 2020 2020 2020  er..            
-0000c650: 2320 4e4f 5445 2041 6c74 686f 7567 6820  # NOTE Although 
-0000c660: 7765 2776 6520 616c 7265 6164 7920 7072  we've already pr
-0000c670: 6f63 6573 7365 6420 7468 6520 6669 7273  ocessed the firs
-0000c680: 7420 656c 656d 656e 7420 6865 7265 2c20  t element here, 
-0000c690: 7468 6973 2073 7469 6c6c 0a20 2020 2020  this still.     
-0000c6a0: 2020 2020 2020 2023 2020 2065 6e75 6d65         #   enume
-0000c6b0: 7261 7465 7320 7468 6520 656e 7469 7265  rates the entire
-0000c6c0: 206c 6973 7420 6320 746f 2061 6c69 676e   list c to align
-0000c6d0: 2074 6865 2065 6e75 6d65 7261 7469 6f6e   the enumeration
-0000c6e0: 2069 6478 2070 726f 7065 726c 790a 2020   idx properly.  
-0000c6f0: 2020 2020 2020 2020 2020 666f 7220 6964            for id
-0000c700: 782c 206e 2069 6e20 656e 756d 6572 6174  x, n in enumerat
-0000c710: 6528 656c 6967 6962 6c65 5f6e 6f64 6573  e(eligible_nodes
-0000c720: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000c730: 2020 2063 6865 636b 286e 2e6e 756d 6265     check(n.numbe
-0000c740: 7220 6973 206e 6f74 204e 6f6e 652c 206c  r is not None, l
-0000c750: 616d 6264 613a 2066 2245 7870 6563 7465  ambda: f"Expecte
-0000c760: 6420 6561 6368 206e 6f64 6520 746f 2062  d each node to b
-0000c770: 6520 6e75 6d62 6572 6564 2c20 6275 7420  e numbered, but 
-0000c780: 7b6e 7d20 7761 7320 6e6f 7422 290a 0a20  {n} was not").. 
-0000c790: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000c7a0: 6620 6e2e 6e75 6d62 6572 203c 206d 696e  f n.number < min
-0000c7b0: 5f6e 756d 6265 723a 0a20 2020 2020 2020  _number:.       
-0000c7c0: 2020 2020 2020 2020 2020 2020 206d 696e               min
-0000c7d0: 5f69 6478 203d 2069 6478 0a20 2020 2020  _idx = idx.     
-0000c7e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000c7f0: 696e 5f6e 756d 6265 7220 3d20 6e2e 6e75  in_number = n.nu
-0000c800: 6d62 6572 0a0a 2020 2020 2020 2020 2020  mber..          
-0000c810: 2020 7265 7475 726e 206d 696e 5f69 6478    return min_idx
-0000c820: 0a0a 2020 2020 2020 2020 736f 7274 6564  ..        sorted
-0000c830: 5f62 7379 6d73 203d 2074 6f70 6f73 6f72  _bsyms = toposor
-0000c840: 745f 6273 796d 5f64 6167 286c 6561 7665  t_bsym_dag(leave
-0000c850: 732c 2074 6f70 6f73 6f72 745f 6f72 6465  s, toposort_orde
-0000c860: 723d 544f 504f 534f 5254 5f4f 5244 4552  r=TOPOSORT_ORDER
-0000c870: 2e42 4f54 544f 4d5f 5550 2c20 7365 6c65  .BOTTOM_UP, sele
-0000c880: 6374 6f72 3d5f 7365 6c65 6374 6f72 290a  ctor=_selector).
-0000c890: 2020 2020 2020 2020 6772 6164 7472 632e          gradtrc.
-0000c8a0: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
-0000c8b0: 736f 7274 6564 5f62 7379 6d73 0a20 2020  sorted_bsyms.   
-0000c8c0: 2020 2020 2067 7261 6474 7263 203d 2064       gradtrc = d
-0000c8d0: 6365 2867 7261 6474 7263 290a 0a20 2020  ce(gradtrc)..   
-0000c8e0: 2020 2020 2023 2054 4f44 4f20 436f 6e73       # TODO Cons
-0000c8f0: 6964 6572 2068 6f77 2074 6f20 6861 6e64  ider how to hand
-0000c900: 6c65 2067 7261 6420 772e 722e 742e 206f  le grad w.r.t. o
-0000c910: 6e6c 7920 736f 6d65 206f 7574 7075 7473  nly some outputs
-0000c920: 202d 2d20 7368 6f75 6c64 2061 6c6c 2067   -- should all g
-0000c930: 7261 640a 2020 2020 2020 2020 2320 2020  rad.        #   
-0000c940: 6f70 6572 6174 696f 6e73 2075 7369 6e67  operations using
-0000c950: 2074 6865 206f 7468 6572 206f 7574 7075   the other outpu
-0000c960: 7420 6265 2072 656d 6f76 6564 3f20 5768  t be removed? Wh
-0000c970: 6174 206b 696e 6420 6f66 2061 7373 756d  at kind of assum
-0000c980: 7074 696f 6e20 646f 6573 2074 6861 740a  ption does that.
-0000c990: 2020 2020 2020 2020 2320 2020 6d61 6b65          #   make
-0000c9a0: 2061 626f 7574 2074 6865 2067 7261 6420   about the grad 
-0000c9b0: 7374 7275 6374 7572 653f 2050 726f 6261  structure? Proba
-0000c9c0: 626c 7920 736f 6d65 206b 696e 6420 6f66  bly some kind of
-0000c9d0: 2069 6e64 6570 656e 6465 6e63 6520 6173   independence as
-0000c9e0: 7375 6d70 7469 6f6e 3f20 4172 650a 2020  sumption? Are.  
-0000c9f0: 2020 2020 2020 2320 2020 7468 6572 6520        #   there 
-0000ca00: 7072 6163 7469 6361 6c20 6578 616d 706c  practical exampl
-0000ca10: 6573 2077 6865 7265 2074 6861 7427 7320  es where that's 
-0000ca20: 616e 2069 7373 7565 3f0a 0a20 2020 2020  an issue?..     
-0000ca30: 2020 2065 6e64 5f74 696d 655f 6e73 203d     end_time_ns =
-0000ca40: 2074 696d 652e 7469 6d65 5f6e 7328 290a   time.time_ns().
-0000ca50: 2020 2020 2020 2020 656c 6170 7365 645f          elapsed_
-0000ca60: 7469 6d65 5f6e 7320 3d20 656e 645f 7469  time_ns = end_ti
-0000ca70: 6d65 5f6e 7320 2d20 7374 6172 745f 7469  me_ns - start_ti
-0000ca80: 6d65 5f6e 730a 2020 2020 2020 2020 656c  me_ns.        el
-0000ca90: 6170 7365 645f 7469 6d65 5f6d 696c 6c69  apsed_time_milli
-0000caa0: 7320 3d20 656c 6170 7365 645f 7469 6d65  s = elapsed_time
-0000cab0: 5f6e 7320 2f2f 2031 3030 3030 3030 0a20  _ns // 1000000. 
-0000cac0: 2020 2020 2020 2067 7261 6474 7263 2e73         gradtrc.s
-0000cad0: 6574 5f70 726f 7665 6e61 6e63 6528 5472  et_provenance(Tr
-0000cae0: 6163 6550 726f 7665 6e61 6e63 6528 6622  aceProvenance(f"
-0000caf0: 4772 6164 2028 746f 6f6b 207b 656c 6170  Grad (took {elap
-0000cb00: 7365 645f 7469 6d65 5f6d 696c 6c69 737d  sed_time_millis}
-0000cb10: 206d 696c 6c69 7365 636f 6e64 7329 2229   milliseconds)")
-0000cb20: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-0000cb30: 6e20 6772 6164 7472 630a 0a20 2020 2023  n gradtrc..    #
-0000cb40: 204e 4f54 4520 5468 6973 2069 7320 6120   NOTE This is a 
-0000cb50: 6b6c 7564 6765 2074 6f20 696e 6469 6361  kludge to indica
-0000cb60: 7465 2074 6861 7420 7765 2073 686f 756c  te that we shoul
-0000cb70: 646e 2774 2075 7365 2050 7954 6f72 6368  dn't use PyTorch
-0000cb80: 2773 2061 7574 6f67 7261 6420 6265 6361  's autograd beca
-0000cb90: 7573 650a 2020 2020 2320 2020 7765 2772  use.    #   we'r
-0000cba0: 6520 7573 696e 6720 6f75 7220 6f77 6e20  e using our own 
-0000cbb0: 6175 746f 6772 6164 2074 7261 6e73 666f  autograd transfo
-0000cbc0: 726d 0a20 2020 2063 666e 2e5f 7573 696e  rm.    cfn._usin
-0000cbd0: 675f 6772 6164 5f74 7261 6e73 666f 726d  g_grad_transform
-0000cbe0: 203d 2054 7275 650a 0a20 2020 2072 6574   = True..    ret
-0000cbf0: 7572 6e20 6164 645f 7472 616e 7366 6f72  urn add_transfor
-0000cc00: 6d28 6366 6e2c 205f 6772 6164 5f74 7261  m(cfn, _grad_tra
-0000cc10: 6e73 666f 726d 290a 0a0a 6465 6620 6772  nsform)...def gr
-0000cc20: 6164 5f76 3128 0a20 2020 2063 666e 2c0a  ad_v1(.    cfn,.
-0000cc30: 2920 2d3e 2043 616c 6c61 626c 653a 0a20  ) -> Callable:. 
-0000cc40: 2020 2064 6566 2067 7261 6428 6675 6e63     def grad(func
-0000cc50: 293a 0a20 2020 2020 2020 2064 6566 2067  ):.        def g
-0000cc60: 7261 645f 6675 6e63 282a 6172 6773 2c20  rad_func(*args, 
-0000cc70: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-0000cc80: 2020 2020 2020 205f 2c20 6772 6164 7320         _, grads 
-0000cc90: 3d20 7661 6c75 655f 616e 645f 6772 6164  = value_and_grad
-0000cca0: 2866 756e 6329 282a 6172 6773 2c20 2a2a  (func)(*args, **
-0000ccb0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-0000ccc0: 2020 2020 6772 6164 7320 3d20 5b67 2066      grads = [g f
-0000ccd0: 6f72 2067 2069 6e20 6772 6164 7320 6966  or g in grads if
-0000cce0: 2067 2069 7320 6e6f 7420 4e6f 6e65 5d0a   g is not None].
-0000ccf0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000cd00: 726e 2067 7261 6473 0a0a 2020 2020 2020  rn grads..      
-0000cd10: 2020 7265 7475 726e 2067 7261 645f 6675    return grad_fu
-0000cd20: 6e63 0a0a 2020 2020 6465 6620 5f67 7261  nc..    def _gra
-0000cd30: 645f 7472 616e 7366 6f72 6d28 7472 633a  d_transform(trc:
-0000cd40: 2054 7261 6365 2c20 2a2c 2065 7865 6375   Trace, *, execu
-0000cd50: 746f 7273 5f6c 6973 743a 2053 6571 7565  tors_list: Seque
-0000cd60: 6e63 655b 416e 795d 2920 2d3e 2054 7261  nce[Any]) -> Tra
-0000cd70: 6365 3a0a 2020 2020 2020 2020 6772 6164  ce:.        grad
-0000cd80: 7472 6320 3d20 636f 6e73 7472 7563 745f  trc = construct_
-0000cd90: 7472 6163 6528 2928 6772 6164 2874 7263  trace()(grad(trc
-0000cda0: 2e70 7974 686f 6e5f 6361 6c6c 6162 6c65  .python_callable
-0000cdb0: 2829 292c 202a 7472 632e 6172 6773 2c20  ()), *trc.args, 
-0000cdc0: 2a2a 7472 632e 6b77 6172 6773 290a 2020  **trc.kwargs).  
-0000cdd0: 2020 2020 2020 7265 7475 726e 2067 7261        return gra
-0000cde0: 6474 7263 0a0a 2020 2020 6366 6e2e 5f75  dtrc..    cfn._u
-0000cdf0: 7369 6e67 5f67 7261 645f 7472 616e 7366  sing_grad_transf
-0000ce00: 6f72 6d20 3d20 5472 7565 0a20 2020 2072  orm = True.    r
-0000ce10: 6574 7572 6e20 6164 645f 7472 616e 7366  eturn add_transf
-0000ce20: 6f72 6d28 6366 6e2c 205f 6772 6164 5f74  orm(cfn, _grad_t
-0000ce30: 7261 6e73 666f 726d 290a 0a0a 636c 6173  ransform)...clas
-0000ce40: 7320 5472 616e 7366 6f72 6d73 2845 6e75  s Transforms(Enu
-0000ce50: 6d29 3a0a 2020 2020 4964 656e 7469 7479  m):.    Identity
-0000ce60: 4f70 203d 2061 7574 6f28 290a 2020 2020  Op = auto().    
-0000ce70: 566d 6170 4f70 203d 2061 7574 6f28 290a  VmapOp = auto().
-0000ce80: 2020 2020 4a76 704f 7020 3d20 6175 746f      JvpOp = auto
-0000ce90: 2829 0a20 2020 2056 6a70 4f70 203d 2061  ().    VjpOp = a
-0000cea0: 7574 6f28 290a 0a0a 406c 7275 5f63 6163  uto()...@lru_cac
-0000ceb0: 6865 286d 6178 7369 7a65 3d4e 6f6e 6529  he(maxsize=None)
-0000cec0: 0a64 6566 2073 796d 626f 6c5f 746f 5f65  .def symbol_to_e
-0000ced0: 7661 6c28 626f 756e 645f 7379 6d62 6f6c  val(bound_symbol
-0000cee0: 293a 0a20 2020 2022 2222 4d61 7020 6120  ):.    """Map a 
-0000cef0: 426f 756e 6453 796d 626f 6c20 746f 2061  BoundSymbol to a
-0000cf00: 2066 756e 6374 696f 6e20 7468 6174 2065   function that e
-0000cf10: 7661 6c75 6174 6573 2069 742e 0a0a 2020  valuates it...  
-0000cf20: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0000cf30: 626f 756e 645f 7379 6d62 6f6c 3a20 426f  bound_symbol: Bo
-0000cf40: 756e 6453 796d 626f 6c20 746f 206d 6170  undSymbol to map
-0000cf50: 0a20 2020 2022 2222 0a20 2020 2023 2053  .    """.    # S
-0000cf60: 796d 626f 6c20 6973 2063 616c 6c61 626c  ymbol is callabl
-0000cf70: 650a 2020 2020 7265 7475 726e 2062 6f75  e.    return bou
-0000cf80: 6e64 5f73 796d 626f 6c2e 7379 6d0a 0a0a  nd_symbol.sym...
-0000cf90: 2320 544f 444f 3a20 4375 7272 656e 746c  # TODO: Currentl
-0000cfa0: 7920 7765 2075 7365 2074 7261 6365 2e61  y we use trace.a
-0000cfb0: 7267 7320 616e 6420 7472 6163 652e 6b77  rgs and trace.kw
-0000cfc0: 6172 6773 2074 6f20 6765 7420 7468 6520  args to get the 
-0000cfd0: 6172 6775 6d65 6e74 730a 2320 4d61 7962  arguments.# Mayb
-0000cfe0: 6520 7765 2073 686f 756c 6420 7573 6520  e we should use 
-0000cff0: 7468 6573 6520 696e 7374 6561 640a 7472  these instead.tr
-0000d000: 616e 7366 6f72 6d5f 736b 6970 5f6c 6973  ansform_skip_lis
-0000d010: 7420 3d20 280a 2020 2020 7072 696d 732e  t = (.    prims.
-0000d020: 5072 696d 4944 732e 554e 5041 434b 5f45  PrimIDs.UNPACK_E
-0000d030: 4d50 5459 5f44 4943 542c 0a20 2020 2070  MPTY_DICT,.    p
-0000d040: 7269 6d73 2e50 7269 6d49 4473 2e55 4e50  rims.PrimIDs.UNP
-0000d050: 4143 4b5f 4b45 592c 0a20 2020 2070 7269  ACK_KEY,.    pri
-0000d060: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
-0000d070: 4b5f 5345 5155 454e 4345 2c0a 2020 2020  K_SEQUENCE,.    
-0000d080: 7072 696d 732e 5072 696d 4944 732e 554e  prims.PrimIDs.UN
-0000d090: 5041 434b 5f54 5249 5649 414c 2c0a 2020  PACK_TRIVIAL,.  
-0000d0a0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-0000d0b0: 5245 5455 524e 2c0a 290a 0a0a 6465 6620  RETURN,.)...def 
-0000d0c0: 6576 616c 5f74 7261 6365 2874 7261 6365  eval_trace(trace
-0000d0d0: 2c20 2a61 7267 732c 2073 796d 626f 6c5f  , *args, symbol_
-0000d0e0: 6d61 7070 6572 3d73 796d 626f 6c5f 746f  mapper=symbol_to
-0000d0f0: 5f65 7661 6c2c 2077 6974 685f 656e 763d  _eval, with_env=
-0000d100: 4661 6c73 652c 202a 2a6b 7761 7267 7329  False, **kwargs)
-0000d110: 3a0a 2020 2020 2222 2245 7661 6c75 6174  :.    """Evaluat
-0000d120: 6520 6120 7472 6163 652e 0a0a 2020 2020  e a trace...    
-0000d130: 4172 6773 3a0a 2020 2020 2020 2020 7472  Args:.        tr
-0000d140: 6163 653a 2074 7261 6365 2074 6f20 6576  ace: trace to ev
-0000d150: 616c 7561 7465 0a20 2020 2020 2020 202a  aluate.        *
-0000d160: 6172 6773 3a20 6172 6775 6d65 6e74 7320  args: arguments 
-0000d170: 746f 2065 7661 6c75 6174 6520 7468 6520  to evaluate the 
-0000d180: 7472 6163 6520 7769 7468 0a20 2020 2020  trace with.     
-0000d190: 2020 2073 796d 626f 6c5f 6d61 7070 6572     symbol_mapper
-0000d1a0: 3a20 6675 6e63 7469 6f6e 2074 6861 7420  : function that 
-0000d1b0: 6d61 7073 2061 2073 796d 626f 6c20 746f  maps a symbol to
-0000d1c0: 2061 2066 756e 6374 696f 6e20 7468 6174   a function that
-0000d1d0: 2065 7661 6c75 6174 6573 2069 740a 2020   evaluates it.  
-0000d1e0: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-0000d1f0: 6b65 7977 6f72 6420 6172 6775 6d65 6e74  keyword argument
-0000d200: 7320 746f 2065 7661 6c75 6174 6520 7468  s to evaluate th
-0000d210: 6520 7472 6163 6520 7769 7468 0a0a 2020  e trace with..  
-0000d220: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-0000d230: 2020 2072 6573 756c 7420 6f66 2065 7661     result of eva
-0000d240: 6c75 6174 696e 6720 7468 6520 7472 6163  luating the trac
-0000d250: 650a 2020 2020 2222 220a 2020 2020 656e  e.    """.    en
-0000d260: 7620 3d20 7b7d 0a0a 2020 2020 6465 6620  v = {}..    def 
-0000d270: 7265 6164 2878 3a20 5661 7269 6162 6c65  read(x: Variable
-0000d280: 293a 0a20 2020 2020 2020 2069 6620 6973  ):.        if is
-0000d290: 696e 7374 616e 6365 2878 2c20 5661 7269  instance(x, Vari
-0000d2a0: 6162 6c65 293a 0a20 2020 2020 2020 2020  able):.         
-0000d2b0: 2020 2072 6574 7572 6e20 656e 765b 782e     return env[x.
-0000d2c0: 6e61 6d65 5d0a 2020 2020 2020 2020 656c  name].        el
-0000d2d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000d2e0: 7265 7475 726e 2078 0a0a 2020 2020 6465  return x..    de
-0000d2f0: 6620 7772 6974 6528 763a 2056 6172 6961  f write(v: Varia
-0000d300: 626c 652c 2076 616c 3a20 416e 792c 2061  ble, val: Any, a
-0000d310: 6c6c 6f77 5f64 7570 6c69 6361 7465 733d  llow_duplicates=
-0000d320: 4661 6c73 6529 202d 3e20 4e6f 6e65 3a0a  False) -> None:.
-0000d330: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-0000d340: 7369 6e73 7461 6e63 6528 762c 2056 6172  sinstance(v, Var
-0000d350: 6961 626c 6529 3a0a 2020 2020 2020 2020  iable):.        
-0000d360: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-0000d370: 2020 2023 2044 7570 6c69 6361 7465 7320     # Duplicates 
-0000d380: 6172 6520 616c 6c6f 7765 6420 616e 6420  are allowed and 
-0000d390: 6f76 6572 7772 6974 7465 6e0a 2020 2020  overwritten.    
-0000d3a0: 2020 2020 6966 2076 2e6e 616d 6520 696e      if v.name in
-0000d3b0: 2065 6e76 3a0a 2020 2020 2020 2020 2020   env:.          
-0000d3c0: 2020 6966 2061 6c6c 6f77 5f64 7570 6c69    if allow_dupli
-0000d3d0: 6361 7465 733a 0a20 2020 2020 2020 2020  cates:.         
-0000d3e0: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-0000d3f0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000d400: 5661 6c75 6545 7272 6f72 2866 2256 6172  ValueError(f"Var
-0000d410: 6961 626c 6520 7b76 2e6e 616d 657d 2069  iable {v.name} i
-0000d420: 7320 6265 696e 6720 6f76 6572 7772 6974  s being overwrit
-0000d430: 7465 6e20 7468 6973 2069 7320 6e6f 7420  ten this is not 
-0000d440: 616c 6c6f 7765 6422 290a 2020 2020 2020  allowed").      
-0000d450: 2020 656e 765b 762e 6e61 6d65 5d20 3d20    env[v.name] = 
-0000d460: 7661 6c0a 0a20 2020 2073 6166 655f 6d61  val..    safe_ma
-0000d470: 705f 666c 6174 2877 7269 7465 2c20 6c69  p_flat(write, li
-0000d480: 7374 2874 7261 6365 2e61 7267 7329 2c20  st(trace.args), 
-0000d490: 6c69 7374 2861 7267 7329 290a 2020 2020  list(args)).    
-0000d4a0: 7361 6665 5f6d 6170 5f66 6c61 7428 7772  safe_map_flat(wr
-0000d4b0: 6974 652c 206c 6973 7428 7472 6163 652e  ite, list(trace.
-0000d4c0: 6b77 6172 6773 2e76 616c 7565 7328 2929  kwargs.values())
-0000d4d0: 2c20 6c69 7374 286b 7761 7267 732e 7661  , list(kwargs.va
-0000d4e0: 6c75 6573 2829 2929 0a0a 2020 2020 666f  lues()))..    fo
-0000d4f0: 7220 7379 6d62 6f6c 2069 6e20 7472 6163  r symbol in trac
-0000d500: 652e 626f 756e 645f 7379 6d62 6f6c 733a  e.bound_symbols:
-0000d510: 0a20 2020 2020 2020 2069 6620 7379 6d62  .        if symb
-0000d520: 6f6c 2e73 796d 2e69 6420 696e 2074 7261  ol.sym.id in tra
-0000d530: 6e73 666f 726d 5f73 6b69 705f 6c69 7374  nsform_skip_list
-0000d540: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-0000d550: 6e74 696e 7565 0a20 2020 2020 2020 2061  ntinue.        a
-0000d560: 7267 7320 3d20 7472 6565 5f6d 6170 2872  rgs = tree_map(r
-0000d570: 6561 642c 2073 796d 626f 6c2e 6172 6773  ead, symbol.args
-0000d580: 290a 2020 2020 2020 2020 6b77 6172 6773  ).        kwargs
-0000d590: 203d 2074 7265 655f 6d61 7028 7265 6164   = tree_map(read
-0000d5a0: 2c20 7379 6d62 6f6c 2e6b 7761 7267 7329  , symbol.kwargs)
-0000d5b0: 0a20 2020 2020 2020 2070 7269 6d5f 6675  .        prim_fu
-0000d5c0: 6e63 203d 2073 796d 626f 6c5f 6d61 7070  nc = symbol_mapp
-0000d5d0: 6572 2873 796d 626f 6c29 0a20 2020 2020  er(symbol).     
-0000d5e0: 2020 2069 6620 7072 696d 5f66 756e 6320     if prim_func 
-0000d5f0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0000d600: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-0000d610: 2020 2020 2020 7265 7375 6c74 203d 2070        result = p
-0000d620: 7269 6d5f 6675 6e63 282a 6172 6773 2c20  rim_func(*args, 
-0000d630: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
-0000d640: 2020 7361 6665 5f6d 6170 5f66 6c61 7428    safe_map_flat(
-0000d650: 7772 6974 652c 206c 6973 7428 7365 7175  write, list(sequ
-0000d660: 656e 6369 6679 2873 796d 626f 6c2e 6f75  encify(symbol.ou
-0000d670: 7470 7574 2929 2c20 6c69 7374 2873 6571  tput)), list(seq
-0000d680: 7565 6e63 6966 7928 7265 7375 6c74 2929  uencify(result))
-0000d690: 290a 0a20 2020 2069 6620 7769 7468 5f65  )..    if with_e
-0000d6a0: 6e76 3a0a 2020 2020 2020 2020 7265 7475  nv:.        retu
-0000d6b0: 726e 2074 7265 655f 6d61 7028 7265 6164  rn tree_map(read
-0000d6c0: 2c20 7472 6163 652e 6f75 7470 7574 292c  , trace.output),
-0000d6d0: 2065 6e76 0a0a 2020 2020 7265 7475 726e   env..    return
-0000d6e0: 2074 7265 655f 6d61 7028 7265 6164 2c20   tree_map(read, 
-0000d6f0: 7472 6163 652e 6f75 7470 7574 290a 0a0a  trace.output)...
-0000d700: 6465 6620 5f69 6465 6e74 6974 795f 6361  def _identity_ca
-0000d710: 6c6c 5f6d 6574 6166 756e 6328 2a61 7267  ll_metafunc(*arg
-0000d720: 732c 2074 7261 6365 3a20 5472 6163 652c  s, trace: Trace,
-0000d730: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-0000d740: 7769 7468 2064 6574 6163 6865 645f 7472  with detached_tr
-0000d750: 6163 6528 293a 0a20 2020 2020 2020 2072  ace():.        r
-0000d760: 6574 7572 6e20 6576 616c 5f74 7261 6365  eturn eval_trace
-0000d770: 2874 7261 6365 2c20 2a61 7267 732c 202a  (trace, *args, *
-0000d780: 2a6b 7761 7267 7329 0a0a 0a69 6465 6e74  *kwargs)...ident
-0000d790: 6974 795f 6361 6c6c 203d 2053 796d 626f  ity_call = Symbo
-0000d7a0: 6c28 6964 3d54 7261 6e73 666f 726d 732e  l(id=Transforms.
-0000d7b0: 4964 656e 7469 7479 4f70 2c20 6e61 6d65  IdentityOp, name
-0000d7c0: 3d22 6964 656e 7469 7479 5f63 616c 6c22  ="identity_call"
-0000d7d0: 2c20 6d65 7461 3d5f 6964 656e 7469 7479  , meta=_identity
-0000d7e0: 5f63 616c 6c5f 6d65 7461 6675 6e63 290a  _call_metafunc).
-0000d7f0: 0a0a 6465 6620 6964 656e 7469 7479 2866  ..def identity(f
-0000d800: 756e 6329 3a0a 2020 2020 2222 2249 6465  unc):.    """Ide
-0000d810: 6e74 6974 7920 7472 616e 7366 6f72 6d20  ntity transform 
-0000d820: 666f 7220 6120 5468 756e 6465 7220 6675  for a Thunder fu
-0000d830: 6e63 7469 6f6e 2e0a 0a20 2020 2041 7267  nction...    Arg
-0000d840: 733a 0a20 2020 2020 2020 2066 756e 6320  s:.        func 
-0000d850: 2843 616c 6c61 626c 6529 3a20 4120 5468  (Callable): A Th
-0000d860: 756e 6465 7220 6675 6e63 7469 6f6e 2074  under function t
-0000d870: 6f20 6265 2074 7261 6e73 666f 726d 6564  o be transformed
-0000d880: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
-0000d890: 6566 2077 7261 7070 6572 282a 6172 6773  ef wrapper(*args
-0000d8a0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0000d8b0: 2020 2020 2074 7261 6365 203d 2063 6f6e       trace = con
-0000d8c0: 7374 7275 6374 5f74 7261 6365 2829 2866  struct_trace()(f
-0000d8d0: 756e 632c 202a 6172 6773 2c20 2a2a 6b77  unc, *args, **kw
-0000d8e0: 6172 6773 290a 2020 2020 2020 2020 7265  args).        re
-0000d8f0: 7475 726e 2069 6465 6e74 6974 795f 6361  turn identity_ca
-0000d900: 6c6c 282a 6172 6773 2c20 2a2a 6b77 6172  ll(*args, **kwar
-0000d910: 6773 2c20 7472 6163 653d 7472 6163 6529  gs, trace=trace)
-0000d920: 0a0a 2020 2020 7265 7475 726e 2077 7261  ..    return wra
-0000d930: 7070 6572 0a0a 0a64 6566 205f 6964 656e  pper...def _iden
-0000d940: 7469 7479 5f63 616c 6c5f 7079 746f 7263  tity_call_pytorc
-0000d950: 6828 2a61 7267 732c 2074 7261 6365 3a20  h(*args, trace: 
-0000d960: 5472 6163 652c 202a 2a6b 7761 7267 7329  Trace, **kwargs)
-0000d970: 3a0a 2020 2020 696d 706f 7274 2074 6f72  :.    import tor
-0000d980: 6368 0a0a 2020 2020 6465 6620 7379 6d62  ch..    def symb
-0000d990: 6f6c 5f6d 6170 7065 7228 6f70 293a 0a20  ol_mapper(op):. 
-0000d9a0: 2020 2020 2020 2069 6620 6f70 2e6f 7020         if op.op 
-0000d9b0: 3d3d 2054 7261 6e73 666f 726d 732e 4964  == Transforms.Id
-0000d9c0: 656e 7469 7479 4f70 3a0a 2020 2020 2020  entityOp:.      
-0000d9d0: 2020 2020 2020 7265 7475 726e 205f 6964        return _id
-0000d9e0: 656e 7469 7479 5f63 616c 6c5f 7079 746f  entity_call_pyto
-0000d9f0: 7263 680a 0a20 2020 2020 2020 2074 6f72  rch..        tor
-0000da00: 6368 5f6f 7020 3d20 6f70 735f 746f 5f74  ch_op = ops_to_t
-0000da10: 6f72 6368 5f6f 7073 5f6d 6170 5b6f 702e  orch_ops_map[op.
-0000da20: 6f70 5d0a 2020 2020 2020 2020 6966 2069  op].        if i
-0000da30: 7369 6e73 7461 6e63 6528 746f 7263 685f  sinstance(torch_
-0000da40: 6f70 2c20 7374 7229 3a0a 2020 2020 2020  op, str):.      
-0000da50: 2020 2020 2020 7265 7475 726e 2067 6574        return get
-0000da60: 6174 7472 2874 6f72 6368 2c20 746f 7263  attr(torch, torc
-0000da70: 685f 6f70 2e73 7472 6970 2822 7079 746f  h_op.strip("pyto
-0000da80: 7263 682e 2229 290a 2020 2020 2020 2020  rch.")).        
-0000da90: 7265 7475 726e 2074 6f72 6368 5f6f 700a  return torch_op.
-0000daa0: 0a20 2020 2077 6974 6820 6465 7461 6368  .    with detach
-0000dab0: 6564 5f74 7261 6365 2829 3a0a 2020 2020  ed_trace():.    
-0000dac0: 2020 2020 7265 7475 726e 2065 7661 6c5f      return eval_
-0000dad0: 7472 6163 6528 7472 6163 652c 202a 6172  trace(trace, *ar
-0000dae0: 6773 2c20 2a2a 6b77 6172 6773 2c20 7379  gs, **kwargs, sy
-0000daf0: 6d62 6f6c 5f6d 6170 7065 723d 7379 6d62  mbol_mapper=symb
-0000db00: 6f6c 5f6d 6170 7065 7229 0a0a 0a23 2052  ol_mapper)...# R
-0000db10: 6567 6973 7465 7220 7468 6520 6964 656e  egister the iden
-0000db20: 7469 7479 2063 616c 6c20 666f 7220 5079  tity call for Py
-0000db30: 546f 7263 6820 6578 6563 7574 6f72 2e0a  Torch executor..
-0000db40: 2320 6f70 735f 746f 5f74 6f72 6368 5f6f  # ops_to_torch_o
-0000db50: 7073 5f6d 6170 5b54 7261 6e73 666f 726d  ps_map[Transform
-0000db60: 732e 4964 656e 7469 7479 4f70 5d20 3d20  s.IdentityOp] = 
-0000db70: 5f69 6465 6e74 6974 795f 6361 6c6c 5f70  _identity_call_p
-0000db80: 7974 6f72 6368 0a0a 0a23 2056 4d41 5020  ytorch...# VMAP 
-0000db90: 7472 616e 7366 6f72 6d0a 2320 2d2d 2d2d  transform.# ----
-0000dba0: 2d2d 2d2d 2d2d 2d2d 2d0a 0a0a 636c 6173  ---------...clas
-0000dbb0: 7320 4e6f 744d 6170 7065 643a 0a20 2020  s NotMapped:.   
-0000dbc0: 2022 2222 5265 7072 6573 656e 7473 2061   """Represents a
-0000dbd0: 206e 6f6e 2d62 6174 6368 6564 2064 696d   non-batched dim
-0000dbe0: 656e 7369 6f6e 2e22 2222 0a0a 2020 2020  ension."""..    
-0000dbf0: 6465 6620 5f5f 7265 7072 5f5f 2873 656c  def __repr__(sel
-0000dc00: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
-0000dc10: 726e 2022 6e6f 745f 6d61 7070 6564 220a  rn "not_mapped".
-0000dc20: 0a0a 4064 6174 6163 6c61 7373 2866 726f  ..@dataclass(fro
-0000dc30: 7a65 6e3d 5472 7565 290a 636c 6173 7320  zen=True).class 
-0000dc40: 4261 7463 6865 6456 616c 7565 3a0a 2020  BatchedValue:.  
-0000dc50: 2020 2222 2242 6174 6368 6564 2076 616c    """Batched val
-0000dc60: 7565 2066 6f72 2074 6865 2076 6d61 7020  ue for the vmap 
-0000dc70: 7472 616e 7366 6f72 6d2e 0a0a 2020 2020  transform...    
-0000dc80: 4174 7472 6962 7574 6573 3a0a 2020 2020  Attributes:.    
-0000dc90: 2020 2020 7661 6c75 653a 2042 6174 6368      value: Batch
-0000dca0: 6564 2076 616c 7565 2e0a 2020 2020 2020  ed value..      
-0000dcb0: 2020 6261 7463 685f 6469 6d3a 2042 6174    batch_dim: Bat
-0000dcc0: 6368 696e 6720 6469 6d65 6e73 696f 6e20  ching dimension 
-0000dcd0: 6f72 206e 6f74 5f6d 6170 7065 640a 2020  or not_mapped.  
-0000dce0: 2020 2222 220a 0a20 2020 2076 616c 7565    """..    value
-0000dcf0: 3a20 416e 790a 2020 2020 6261 7463 685f  : Any.    batch_
-0000dd00: 6469 6d3a 2069 6e74 207c 204e 6f74 4d61  dim: int | NotMa
-0000dd10: 7070 6564 0a0a 2020 2020 6465 6620 5f5f  pped..    def __
-0000dd20: 6974 6572 5f5f 2873 656c 6629 3a0a 2020  iter__(self):.  
-0000dd30: 2020 2020 2020 7969 656c 6420 7365 6c66        yield self
-0000dd40: 2e76 616c 7565 0a20 2020 2020 2020 2079  .value.        y
-0000dd50: 6965 6c64 2073 656c 662e 6261 7463 685f  ield self.batch_
-0000dd60: 6469 6d0a 0a0a 6465 6620 7061 6972 5f74  dim...def pair_t
-0000dd70: 6f5f 6261 7463 6865 645f 7661 6c75 6528  o_batched_value(
-0000dd80: 7061 6972 293a 0a20 2020 2022 2222 436f  pair):.    """Co
-0000dd90: 6e76 6572 7473 2061 2070 6169 7220 746f  nverts a pair to
-0000dda0: 2061 2042 6174 6368 6564 5661 6c75 652e   a BatchedValue.
-0000ddb0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0000ddc0: 2020 2020 7061 6972 2028 5365 7175 656e      pair (Sequen
-0000ddd0: 6365 293a 2050 6169 7220 746f 2063 6f6e  ce): Pair to con
-0000dde0: 7665 7274 2e0a 0a20 2020 2052 6574 7572  vert...    Retur
-0000ddf0: 6e73 3a0a 2020 2020 2020 2020 4261 7463  ns:.        Batc
-0000de00: 6865 6456 616c 7565 3a20 4261 7463 6865  hedValue: Batche
-0000de10: 6456 616c 7565 2072 6570 7265 7365 6e74  dValue represent
-0000de20: 6174 696f 6e20 6f66 2074 6865 2070 6169  ation of the pai
-0000de30: 722e 0a20 2020 2022 2222 0a20 2020 2069  r..    """.    i
-0000de40: 6620 6973 696e 7374 616e 6365 2870 6169  f isinstance(pai
-0000de50: 722c 2042 6174 6368 6564 5661 6c75 6529  r, BatchedValue)
-0000de60: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000de70: 2070 6169 720a 2020 2020 656c 7365 3a0a   pair.    else:.
-0000de80: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-0000de90: 7369 6e73 7461 6e63 6528 7061 6972 2c20  sinstance(pair, 
-0000dea0: 5365 7175 656e 6365 2920 616e 6420 6c65  Sequence) and le
-0000deb0: 6e28 7061 6972 2920 3d3d 2032 0a20 2020  n(pair) == 2.   
-0000dec0: 2020 2020 2072 6574 7572 6e20 4261 7463       return Batc
-0000ded0: 6865 6456 616c 7565 282a 7061 6972 290a  hedValue(*pair).
-0000dee0: 0a0a 6465 6620 7665 6374 6f72 697a 6564  ..def vectorized
-0000def0: 5f62 6174 6368 6572 2870 7269 6d2c 2061  _batcher(prim, a
-0000df00: 7869 735f 7369 7a65 2c20 6261 7463 6865  xis_size, batche
-0000df10: 645f 7661 6c75 6573 2c20 2a2a 6b77 6172  d_values, **kwar
-0000df20: 6773 293a 0a20 2020 2062 6174 6368 5f64  gs):.    batch_d
-0000df30: 696d 203d 2062 6174 6368 6564 5f76 616c  im = batched_val
-0000df40: 7565 735b 305d 2e62 6174 6368 5f64 696d  ues[0].batch_dim
-0000df50: 0a20 2020 2061 7373 6572 7420 616c 6c28  .    assert all(
-0000df60: 0a20 2020 2020 2020 2062 6174 6368 5f64  .        batch_d
-0000df70: 696d 203d 3d20 6276 2e62 6174 6368 5f64  im == bv.batch_d
-0000df80: 696d 2066 6f72 2062 7620 696e 2062 6174  im for bv in bat
-0000df90: 6368 6564 5f76 616c 7565 735b 313a 5d0a  ched_values[1:].
-0000dfa0: 2020 2020 292c 2066 2260 7665 6374 6f72      ), f"`vector
-0000dfb0: 697a 6564 5f62 6174 6368 6572 6020 676f  ized_batcher` go
-0000dfc0: 7420 6469 6666 6572 656e 7420 6261 7463  t different batc
-0000dfd0: 6865 6420 6469 6d65 6e73 696f 6e73 207b  hed dimensions {
-0000dfe0: 5b62 762e 6261 7463 685f 6469 6d20 666f  [bv.batch_dim fo
-0000dff0: 7220 6276 2069 6e20 6261 7463 6865 645f  r bv in batched_
-0000e000: 7661 6c75 6573 5d7d 220a 2020 2020 7265  values]}".    re
-0000e010: 7475 726e 2042 6174 6368 6564 5661 6c75  turn BatchedValu
-0000e020: 6528 7072 696d 282a 5b62 762e 7661 6c75  e(prim(*[bv.valu
-0000e030: 6520 666f 7220 6276 2069 6e20 6261 7463  e for bv in batc
-0000e040: 6865 645f 7661 6c75 6573 5d2c 202a 2a6b  hed_values], **k
-0000e050: 7761 7267 7329 2c20 6261 7463 685f 6469  wargs), batch_di
-0000e060: 6d29 0a0a 0a6e 6f74 5f6d 6170 7065 6420  m)...not_mapped 
-0000e070: 3d20 4e6f 744d 6170 7065 6428 290a 0a0a  = NotMapped()...
-0000e080: 6465 6620 6d6f 7665 6469 6d28 782c 2073  def movedim(x, s
-0000e090: 7263 3a20 696e 742c 2064 7374 3a20 696e  rc: int, dst: in
-0000e0a0: 7429 3a0a 2020 2020 7065 726d 203d 205b  t):.    perm = [
-0000e0b0: 6920 666f 7220 6920 696e 2072 616e 6765  i for i in range
-0000e0c0: 2878 2e6e 6469 6d29 2069 6620 6920 213d  (x.ndim) if i !=
-0000e0d0: 2073 7263 5d0a 2020 2020 7065 726d 2e69   src].    perm.i
-0000e0e0: 6e73 6572 7428 6473 742c 2073 7263 290a  nsert(dst, src).
-0000e0f0: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
-0000e100: 2e74 7261 6e73 706f 7365 2878 2c20 7475  .transpose(x, tu
-0000e110: 706c 6528 7065 726d 2929 0a0a 0a64 6566  ple(perm))...def
-0000e120: 206d 6f76 655f 6261 7463 685f 6469 6d28   move_batch_dim(
-0000e130: 6178 6973 5f73 697a 652c 2073 7263 2c20  axis_size, src, 
-0000e140: 6473 742c 2078 293a 0a20 2020 2069 6620  dst, x):.    if 
-0000e150: 7372 6320 6973 206e 6f74 5f6d 6170 7065  src is not_mappe
-0000e160: 643a 0a20 2020 2020 2020 2069 6620 6973  d:.        if is
-0000e170: 696e 7374 616e 6365 2878 2c20 4e75 6d62  instance(x, Numb
-0000e180: 6572 293a 0a20 2020 2020 2020 2020 2020  er):.           
-0000e190: 2072 6574 7572 6e20 780a 2020 2020 2020   return x.      
-0000e1a0: 2020 7461 7267 6574 5f73 6861 7065 203d    target_shape =
-0000e1b0: 206c 6973 7428 782e 7368 6170 6529 0a20   list(x.shape). 
-0000e1c0: 2020 2020 2020 2074 6172 6765 745f 7368         target_sh
-0000e1d0: 6170 652e 696e 7365 7274 2864 7374 2c20  ape.insert(dst, 
-0000e1e0: 6178 6973 5f73 697a 6529 0a20 2020 2020  axis_size).     
-0000e1f0: 2020 2062 6361 7374 5f64 696d 7320 3d20     bcast_dims = 
-0000e200: 6c69 7374 2872 616e 6765 286c 656e 2874  list(range(len(t
-0000e210: 6172 6765 745f 7368 6170 6529 2929 0a20  arget_shape))). 
-0000e220: 2020 2020 2020 2062 6361 7374 5f64 696d         bcast_dim
-0000e230: 732e 706f 7028 6473 7429 0a20 2020 2020  s.pop(dst).     
-0000e240: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
-0000e250: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
-0000e260: 2878 2c20 7461 7267 6574 5f73 6861 7065  (x, target_shape
-0000e270: 2c20 6263 6173 745f 6469 6d73 290a 2020  , bcast_dims).  
-0000e280: 2020 656c 6966 2073 7263 203d 3d20 6473    elif src == ds
-0000e290: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
-0000e2a0: 6e20 780a 2020 2020 656c 7365 3a0a 2020  n x.    else:.  
-0000e2b0: 2020 2020 2020 7265 7475 726e 206d 6f76        return mov
-0000e2c0: 6564 696d 2878 2c20 7372 632c 2064 7374  edim(x, src, dst
-0000e2d0: 290a 0a0a 6465 6620 6269 6e61 7279 5f6f  )...def binary_o
-0000e2e0: 705f 6261 7463 6869 6e67 5f72 756c 6528  p_batching_rule(
-0000e2f0: 6f70 3a20 7072 696d 732e 5072 696d 4944  op: prims.PrimID
-0000e300: 732c 2061 7869 735f 7369 7a65 3a20 696e  s, axis_size: in
-0000e310: 742c 2076 616c 735f 696e 3a20 4261 7463  t, vals_in: Batc
-0000e320: 6865 6456 616c 7565 293a 0a20 2020 2028  hedValue):.    (
-0000e330: 2878 2c20 785f 6264 696d 292c 2028 792c  (x, x_bdim), (y,
-0000e340: 2079 5f62 6469 6d29 2920 3d20 7661 6c73   y_bdim)) = vals
-0000e350: 5f69 6e0a 2020 2020 6966 2078 5f62 6469  _in.    if x_bdi
-0000e360: 6d20 213d 2079 5f62 6469 6d3a 0a20 2020  m != y_bdim:.   
-0000e370: 2020 2020 2069 6620 785f 6264 696d 2069       if x_bdim i
-0000e380: 7320 6e6f 745f 6d61 7070 6564 3a0a 2020  s not_mapped:.  
-0000e390: 2020 2020 2020 2020 2020 7820 3d20 6d6f            x = mo
-0000e3a0: 7665 5f62 6174 6368 5f64 696d 2861 7869  ve_batch_dim(axi
-0000e3b0: 735f 7369 7a65 2c20 785f 6264 696d 2c20  s_size, x_bdim, 
-0000e3c0: 795f 6264 696d 2c20 7829 0a20 2020 2020  y_bdim, x).     
-0000e3d0: 2020 2020 2020 2078 5f62 6469 6d20 3d20         x_bdim = 
-0000e3e0: 795f 6264 696d 0a20 2020 2020 2020 2065  y_bdim.        e
-0000e3f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000e400: 2079 203d 206d 6f76 655f 6261 7463 685f   y = move_batch_
-0000e410: 6469 6d28 6178 6973 5f73 697a 652c 2079  dim(axis_size, y
-0000e420: 5f62 6469 6d2c 2078 5f62 6469 6d2c 2079  _bdim, x_bdim, y
-0000e430: 290a 2020 2020 7265 7475 726e 2042 6174  ).    return Bat
-0000e440: 6368 6564 5661 6c75 6528 6f70 2878 2c20  chedValue(op(x, 
-0000e450: 7929 2c20 785f 6264 696d 290a 0a0a 6465  y), x_bdim)...de
-0000e460: 6620 7369 6e5f 766d 6170 2861 7869 735f  f sin_vmap(axis_
-0000e470: 7369 7a65 3a20 696e 742c 2061 3a20 4261  size: int, a: Ba
-0000e480: 7463 6865 6456 616c 7565 2920 2d3e 2042  tchedValue) -> B
-0000e490: 6174 6368 6564 5661 6c75 653a 0a20 2020  atchedValue:.   
-0000e4a0: 2072 6574 7572 6e20 7665 6374 6f72 697a   return vectoriz
-0000e4b0: 6564 5f62 6174 6368 6572 2870 7269 6d73  ed_batcher(prims
-0000e4c0: 2e73 696e 2c20 6178 6973 5f73 697a 652c  .sin, axis_size,
-0000e4d0: 2028 612c 2929 0a0a 0a64 6566 2063 6f73   (a,))...def cos
-0000e4e0: 5f76 6d61 7028 6178 6973 5f73 697a 653a  _vmap(axis_size:
-0000e4f0: 2069 6e74 2c20 613a 2042 6174 6368 6564   int, a: Batched
-0000e500: 5661 6c75 6529 202d 3e20 4261 7463 6865  Value) -> Batche
-0000e510: 6456 616c 7565 3a0a 2020 2020 7265 7475  dValue:.    retu
-0000e520: 726e 2076 6563 746f 7269 7a65 645f 6261  rn vectorized_ba
-0000e530: 7463 6865 7228 7072 696d 732e 636f 732c  tcher(prims.cos,
-0000e540: 2061 7869 735f 7369 7a65 2c20 2861 2c29   axis_size, (a,)
-0000e550: 290a 0a0a 6465 6620 6d75 6c5f 766d 6170  )...def mul_vmap
-0000e560: 2861 7869 735f 7369 7a65 3a20 696e 742c  (axis_size: int,
-0000e570: 2061 3a20 4261 7463 6865 6456 616c 7565   a: BatchedValue
-0000e580: 2c20 623a 2042 6174 6368 6564 5661 6c75  , b: BatchedValu
-0000e590: 6529 202d 3e20 4261 7463 6865 6456 616c  e) -> BatchedVal
-0000e5a0: 7565 3a0a 2020 2020 7265 7475 726e 2062  ue:.    return b
-0000e5b0: 696e 6172 795f 6f70 5f62 6174 6368 696e  inary_op_batchin
-0000e5c0: 675f 7275 6c65 2870 7269 6d73 2e6d 756c  g_rule(prims.mul
-0000e5d0: 2c20 6178 6973 5f73 697a 652c 2028 612c  , axis_size, (a,
-0000e5e0: 2062 2929 0a0a 0a64 6566 2061 6464 5f76   b))...def add_v
-0000e5f0: 6d61 7028 6178 6973 5f73 697a 653a 2069  map(axis_size: i
-0000e600: 6e74 2c20 613a 2042 6174 6368 6564 5661  nt, a: BatchedVa
-0000e610: 6c75 652c 2062 3a20 4261 7463 6865 6456  lue, b: BatchedV
-0000e620: 616c 7565 2920 2d3e 2042 6174 6368 6564  alue) -> Batched
-0000e630: 5661 6c75 653a 0a20 2020 2072 6574 7572  Value:.    retur
-0000e640: 6e20 6269 6e61 7279 5f6f 705f 6261 7463  n binary_op_batc
-0000e650: 6869 6e67 5f72 756c 6528 7072 696d 732e  hing_rule(prims.
-0000e660: 6164 642c 2061 7869 735f 7369 7a65 2c20  add, axis_size, 
-0000e670: 2861 2c20 6229 290a 0a0a 6465 6620 7375  (a, b))...def su
-0000e680: 6d5f 766d 6170 2861 7869 735f 7369 7a65  m_vmap(axis_size
-0000e690: 3a20 696e 742c 2061 3a20 4261 7463 6865  : int, a: Batche
-0000e6a0: 6456 616c 7565 2c20 6469 6d73 3a20 5365  dValue, dims: Se
-0000e6b0: 7175 656e 6365 5b69 6e74 5d2c 202a 2a6b  quence[int], **k
-0000e6c0: 7761 7267 7329 202d 3e20 4261 7463 6865  wargs) -> Batche
-0000e6d0: 6456 616c 7565 3a0a 2020 2020 6264 696d  dValue:.    bdim
-0000e6e0: 203d 2061 2e62 6174 6368 5f64 696d 0a20   = a.batch_dim. 
-0000e6f0: 2020 2023 2054 4f44 4f3a 2072 656d 6f76     # TODO: remov
-0000e700: 6520 7468 6973 2077 6865 6e20 6469 6d73  e this when dims
-0000e710: 2062 6563 6f6d 6573 2061 206d 616e 6461   becomes a manda
-0000e720: 746f 7279 206b 7761 7267 0a20 2020 2069  tory kwarg.    i
-0000e730: 6620 6c65 6e28 6469 6d73 2920 3e20 303a  f len(dims) > 0:
-0000e740: 0a20 2020 2020 2020 2064 696d 732c 205f  .        dims, _
-0000e750: 203d 2073 6166 655f 7a69 7028 2a64 696d   = safe_zip(*dim
-0000e760: 7329 0a20 2020 2064 696d 735f 6265 666f  s).    dims_befo
-0000e770: 7265 203d 2074 7570 6c65 2865 6c20 666f  re = tuple(el fo
-0000e780: 7220 656c 2069 6e20 6469 6d73 2069 6620  r el in dims if 
-0000e790: 656c 203c 2062 6469 6d29 0a20 2020 2064  el < bdim).    d
-0000e7a0: 696d 735f 6166 7465 7220 3d20 7475 706c  ims_after = tupl
-0000e7b0: 6528 656c 202b 2031 2066 6f72 2065 6c20  e(el + 1 for el 
-0000e7c0: 696e 2064 696d 7320 6966 2065 6c20 3e3d  in dims if el >=
-0000e7d0: 2062 6469 6d29 0a20 2020 2062 6174 6368   bdim).    batch
-0000e7e0: 6564 5f64 696d 7320 3d20 6469 6d73 5f62  ed_dims = dims_b
-0000e7f0: 6566 6f72 6520 2b20 6469 6d73 5f61 6674  efore + dims_aft
-0000e800: 6572 0a20 2020 2072 6574 7572 6e20 7665  er.    return ve
-0000e810: 6374 6f72 697a 6564 5f62 6174 6368 6572  ctorized_batcher
-0000e820: 2870 7269 6d73 2e73 756d 2c20 6178 6973  (prims.sum, axis
-0000e830: 5f73 697a 652c 2028 612c 292c 2064 696d  _size, (a,), dim
-0000e840: 733d 6261 7463 6865 645f 6469 6d73 2c20  s=batched_dims, 
-0000e850: 2a2a 6b77 6172 6773 290a 0a0a 2320 544f  **kwargs)...# TO
-0000e860: 444f 3a20 506c 6561 7365 2074 6573 7420  DO: Please test 
-0000e870: 7468 6973 2065 7874 656e 7369 7665 6c79  this extensively
-0000e880: 0a64 6566 2062 726f 6164 6361 7374 5f69  .def broadcast_i
-0000e890: 6e5f 6469 6d5f 766d 6170 280a 2020 2020  n_dim_vmap(.    
-0000e8a0: 6178 6973 5f73 697a 653a 2069 6e74 2c20  axis_size: int, 
-0000e8b0: 613a 2042 6174 6368 6564 5661 6c75 652c  a: BatchedValue,
-0000e8c0: 2073 6861 7065 3a20 5365 7175 656e 6365   shape: Sequence
-0000e8d0: 5b42 6174 6368 6564 5661 6c75 655d 2c20  [BatchedValue], 
-0000e8e0: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-0000e8f0: 696f 6e73 3a20 5365 7175 656e 6365 5b42  ions: Sequence[B
-0000e900: 6174 6368 6564 5661 6c75 655d 0a29 202d  atchedValue].) -
-0000e910: 3e20 4261 7463 6865 6456 616c 7565 3a0a  > BatchedValue:.
-0000e920: 2020 2020 6264 696d 203d 2061 2e62 6174      bdim = a.bat
-0000e930: 6368 5f64 696d 0a20 2020 2023 2054 4f44  ch_dim.    # TOD
-0000e940: 4f3a 2072 656d 6f76 6520 7468 6973 2077  O: remove this w
-0000e950: 6865 6e20 7368 6170 6520 616e 6420 6272  hen shape and br
-0000e960: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
-0000e970: 6e73 2062 6563 6f6d 6520 6d61 6e64 6174  ns become mandat
-0000e980: 6f72 7920 6b77 6172 6773 0a20 2020 2073  ory kwargs.    s
-0000e990: 6861 7065 2c20 5f20 3d20 7361 6665 5f7a  hape, _ = safe_z
-0000e9a0: 6970 282a 7368 6170 6529 0a20 2020 2069  ip(*shape).    i
-0000e9b0: 6620 6c65 6e28 6272 6f61 6463 6173 745f  f len(broadcast_
-0000e9c0: 6469 6d65 6e73 696f 6e73 2920 3e20 303a  dimensions) > 0:
-0000e9d0: 0a20 2020 2020 2020 2062 726f 6164 6361  .        broadca
-0000e9e0: 7374 5f64 696d 656e 7369 6f6e 732c 205f  st_dimensions, _
-0000e9f0: 203d 2073 6166 655f 7a69 7028 2a62 726f   = safe_zip(*bro
-0000ea00: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-0000ea10: 7329 0a20 2020 2069 6620 6264 696d 2069  s).    if bdim i
-0000ea20: 7320 6e6f 745f 6d61 7070 6564 3a0a 2020  s not_mapped:.  
-0000ea30: 2020 2020 2020 7265 7475 726e 2042 6174        return Bat
-0000ea40: 6368 6564 5661 6c75 6528 7072 696d 732e  chedValue(prims.
-0000ea50: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
-0000ea60: 2861 2e76 616c 7565 2c20 7368 6170 652c  (a.value, shape,
-0000ea70: 2062 726f 6164 6361 7374 5f64 696d 656e   broadcast_dimen
-0000ea80: 7369 6f6e 7329 2c20 6264 696d 290a 2020  sions), bdim).  
-0000ea90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000eaa0: 6e65 775f 6264 696d 203d 2062 6469 6d20  new_bdim = bdim 
-0000eab0: 2b20 7375 6d28 3120 666f 7220 6469 6d20  + sum(1 for dim 
-0000eac0: 696e 2062 726f 6164 6361 7374 5f64 696d  in broadcast_dim
-0000ead0: 656e 7369 6f6e 7320 6966 2064 696d 203c  ensions if dim <
-0000eae0: 2062 6469 6d29 0a20 2020 2020 2020 206e   bdim).        n
-0000eaf0: 6577 5f73 6861 7065 203d 206c 6973 7428  ew_shape = list(
-0000eb00: 7368 6170 6529 0a20 2020 2020 2020 206e  shape).        n
-0000eb10: 6577 5f73 6861 7065 2e69 6e73 6572 7428  ew_shape.insert(
-0000eb20: 6e65 775f 6264 696d 2c20 6178 6973 5f73  new_bdim, axis_s
-0000eb30: 697a 6529 0a20 2020 2020 2020 206e 6577  ize).        new
-0000eb40: 5f62 726f 6164 6361 7374 5f64 696d 656e  _broadcast_dimen
-0000eb50: 7369 6f6e 7320 3d20 2830 2c29 202b 2074  sions = (0,) + t
-0000eb60: 7570 6c65 2864 696d 202b 2031 2069 6620  uple(dim + 1 if 
-0000eb70: 6469 6d20 3e3d 2062 6469 6d20 656c 7365  dim >= bdim else
-0000eb80: 2064 696d 2066 6f72 2064 696d 2069 6e20   dim for dim in 
-0000eb90: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-0000eba0: 696f 6e73 290a 2020 2020 2020 2020 6966  ions).        if
-0000ebb0: 2062 726f 6164 6361 7374 5f64 696d 656e   broadcast_dimen
-0000ebc0: 7369 6f6e 7320 3d3d 2028 293a 0a20 2020  sions == ():.   
-0000ebd0: 2020 2020 2020 2020 206e 6577 5f62 726f           new_bro
-0000ebe0: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-0000ebf0: 7320 3d20 2829 0a20 2020 2020 2020 2072  s = ().        r
-0000ec00: 6574 7572 6e20 4261 7463 6865 6456 616c  eturn BatchedVal
-0000ec10: 7565 2870 7269 6d73 2e62 726f 6164 6361  ue(prims.broadca
-0000ec20: 7374 5f69 6e5f 6469 6d28 612e 7661 6c75  st_in_dim(a.valu
-0000ec30: 652c 206e 6577 5f73 6861 7065 2c20 6e65  e, new_shape, ne
-0000ec40: 775f 6272 6f61 6463 6173 745f 6469 6d65  w_broadcast_dime
-0000ec50: 6e73 696f 6e73 292c 206e 6577 5f62 6469  nsions), new_bdi
-0000ec60: 6d29 0a0a 0a76 6d61 705f 696d 706c 733a  m)...vmap_impls:
-0000ec70: 2064 6963 745b 7072 696d 732e 5379 6d62   dict[prims.Symb
-0000ec80: 6f6c 2c20 4361 6c6c 6162 6c65 5d20 3d20  ol, Callable] = 
-0000ec90: 6469 6374 2829 0a0a 0a64 6566 2075 6e77  dict()...def unw
-0000eca0: 7261 705f 6f6e 655f 6c65 7665 6c5f 6f66  rap_one_level_of
-0000ecb0: 5f73 7562 7379 6d62 6f6c 7328 7472 6163  _subsymbols(trac
-0000ecc0: 6529 3a0a 2020 2020 6e65 775f 7379 6d62  e):.    new_symb
-0000ecd0: 6f6c 735f 6974 6572 203d 2028 0a20 2020  ols_iter = (.   
-0000ece0: 2020 2020 2062 6f75 6e64 5f73 796d 626f       bound_symbo
-0000ecf0: 6c2e 7375 6273 796d 626f 6c73 2069 6620  l.subsymbols if 
-0000ed00: 6c65 6e28 626f 756e 645f 7379 6d62 6f6c  len(bound_symbol
-0000ed10: 2e73 7562 7379 6d62 6f6c 7329 203e 2030  .subsymbols) > 0
-0000ed20: 2065 6c73 6520 5b62 6f75 6e64 5f73 796d   else [bound_sym
-0000ed30: 626f 6c5d 0a20 2020 2020 2020 2066 6f72  bol].        for
-0000ed40: 2062 6f75 6e64 5f73 796d 626f 6c20 696e   bound_symbol in
-0000ed50: 2074 7261 6365 2e62 6f75 6e64 5f73 796d   trace.bound_sym
-0000ed60: 626f 6c73 0a20 2020 2029 0a20 2020 206e  bols.    ).    n
-0000ed70: 6577 5f73 796d 626f 6c73 203d 206c 6973  ew_symbols = lis
-0000ed80: 7428 6368 6169 6e2e 6672 6f6d 5f69 7465  t(chain.from_ite
-0000ed90: 7261 626c 6528 6e65 775f 7379 6d62 6f6c  rable(new_symbol
-0000eda0: 735f 6974 6572 2929 0a20 2020 2074 7261  s_iter)).    tra
-0000edb0: 6365 2e62 6f75 6e64 5f73 796d 626f 6c73  ce.bound_symbols
-0000edc0: 203d 206e 6577 5f73 796d 626f 6c73 0a20   = new_symbols. 
-0000edd0: 2020 2072 6574 7572 6e20 7472 6163 650a     return trace.
-0000ede0: 0a0a 6465 6620 6465 636f 6d70 6f73 6564  ..def decomposed
-0000edf0: 5f66 6e5f 766d 6170 5f72 756c 6528 6178  _fn_vmap_rule(ax
-0000ee00: 6973 5f73 697a 652c 202a 6172 6773 2c20  is_size, *args, 
-0000ee10: 666e 2c20 2a2a 6b77 6172 6773 293a 0a20  fn, **kwargs):. 
-0000ee20: 2020 2061 7267 732c 2069 6e5f 6469 6d73     args, in_dims
-0000ee30: 203d 2075 6e7a 6970 3228 6172 6773 290a   = unzip2(args).
-0000ee40: 2020 2020 756e 6261 7463 6865 645f 6172      unbatched_ar
-0000ee50: 6773 203d 2074 7265 655f 6d61 7028 6c61  gs = tree_map(la
-0000ee60: 6d62 6461 2078 3a20 7265 6d6f 7665 5f62  mbda x: remove_b
-0000ee70: 6174 6368 5f64 696d 2878 2920 6966 2069  atch_dim(x) if i
-0000ee80: 7369 6e73 7461 6e63 6528 782c 2054 656e  sinstance(x, Ten
-0000ee90: 736f 7250 726f 7879 2920 656c 7365 2078  sorProxy) else x
-0000eea0: 2c20 6172 6773 290a 2020 2020 7472 6163  , args).    trac
-0000eeb0: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
-0000eec0: 6163 6528 2928 666e 2c20 2a75 6e62 6174  ace()(fn, *unbat
-0000eed0: 6368 6564 5f61 7267 732c 202a 2a6b 7761  ched_args, **kwa
-0000eee0: 7267 7329 0a20 2020 2074 7261 6365 203d  rgs).    trace =
-0000eef0: 2075 6e77 7261 705f 6f6e 655f 6c65 7665   unwrap_one_leve
-0000ef00: 6c5f 6f66 5f73 7562 7379 6d62 6f6c 7328  l_of_subsymbols(
-0000ef10: 7472 6163 6529 0a20 2020 206f 7574 7320  trace).    outs 
-0000ef20: 3d20 5f76 6d61 705f 6361 6c6c 5f6d 6574  = _vmap_call_met
-0000ef30: 6166 756e 6328 4661 6c73 652c 2061 7267  afunc(False, arg
-0000ef40: 732c 2069 6e5f 6469 6d73 2c20 302c 2061  s, in_dims, 0, a
-0000ef50: 7869 735f 7369 7a65 2c20 6675 6e63 7469  xis_size, functi
-0000ef60: 6f6e 5f74 7261 6365 3d74 7261 6365 2c20  on_trace=trace, 
-0000ef70: 2a2a 6b77 6172 6773 290a 2020 2020 6966  **kwargs).    if
-0000ef80: 2069 7369 6e73 7461 6e63 6528 6f75 7473   isinstance(outs
-0000ef90: 2c20 5365 7175 656e 6365 293a 0a20 2020  , Sequence):.   
-0000efa0: 2020 2020 206f 7574 5f64 696d 7320 3d20       out_dims = 
-0000efb0: 2830 2c29 202a 206c 656e 286f 7574 7329  (0,) * len(outs)
-0000efc0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000efd0: 7361 6665 5f6d 6170 2870 6169 725f 746f  safe_map(pair_to
-0000efe0: 5f62 6174 6368 6564 5f76 616c 7565 2c20  _batched_value, 
-0000eff0: 7361 6665 5f7a 6970 286f 7574 732c 206f  safe_zip(outs, o
-0000f000: 7574 5f64 696d 7329 290a 2020 2020 7265  ut_dims)).    re
-0000f010: 7475 726e 2042 6174 6368 6564 5661 6c75  turn BatchedValu
-0000f020: 6528 6f75 7473 2c20 3029 0a0a 0a76 6d61  e(outs, 0)...vma
-0000f030: 705f 696d 706c 735b 7072 696d 732e 5072  p_impls[prims.Pr
-0000f040: 696d 4944 732e 5349 4e5d 203d 2073 696e  imIDs.SIN] = sin
-0000f050: 5f76 6d61 700a 766d 6170 5f69 6d70 6c73  _vmap.vmap_impls
-0000f060: 5b70 7269 6d73 2e50 7269 6d49 4473 2e43  [prims.PrimIDs.C
-0000f070: 4f53 5d20 3d20 636f 735f 766d 6170 0a76  OS] = cos_vmap.v
-0000f080: 6d61 705f 696d 706c 735b 7072 696d 732e  map_impls[prims.
-0000f090: 5072 696d 4944 732e 4d55 4c5d 203d 206d  PrimIDs.MUL] = m
-0000f0a0: 756c 5f76 6d61 700a 766d 6170 5f69 6d70  ul_vmap.vmap_imp
-0000f0b0: 6c73 5b70 7269 6d73 2e50 7269 6d49 4473  ls[prims.PrimIDs
-0000f0c0: 2e41 4444 5d20 3d20 6164 645f 766d 6170  .ADD] = add_vmap
-0000f0d0: 0a76 6d61 705f 696d 706c 735b 7072 696d  .vmap_impls[prim
-0000f0e0: 732e 5072 696d 4944 732e 5355 4d5d 203d  s.PrimIDs.SUM] =
-0000f0f0: 2073 756d 5f76 6d61 700a 766d 6170 5f69   sum_vmap.vmap_i
-0000f100: 6d70 6c73 5b70 7269 6d73 2e50 7269 6d49  mpls[prims.PrimI
-0000f110: 4473 2e42 524f 4144 4341 5354 5f49 4e5f  Ds.BROADCAST_IN_
-0000f120: 4449 4d5d 203d 2062 726f 6164 6361 7374  DIM] = broadcast
-0000f130: 5f69 6e5f 6469 6d5f 766d 6170 0a0a 0a64  _in_dim_vmap...d
-0000f140: 6566 2076 6d61 705f 7379 6d62 6f6c 5f6d  ef vmap_symbol_m
-0000f150: 6170 7065 7228 7379 6d62 6f6c 3a20 7072  apper(symbol: pr
-0000f160: 696d 732e 5379 6d62 6f6c 2c20 2a2c 2061  ims.Symbol, *, a
-0000f170: 7869 735f 7369 7a65 3a20 696e 7429 3a0a  xis_size: int):.
-0000f180: 2020 2020 2222 224d 6170 7320 6120 7379      """Maps a sy
-0000f190: 6d62 6f6c 2074 6f20 6120 766d 6170 2066  mbol to a vmap f
-0000f1a0: 756e 6374 696f 6e20 7468 6174 2065 7661  unction that eva
-0000f1b0: 6c75 6174 6573 2069 742e 0a0a 2020 2020  luates it...    
-0000f1c0: 4172 6773 3a0a 2020 2020 2020 2020 7379  Args:.        sy
-0000f1d0: 6d62 6f6c 2028 7072 696d 732e 5379 6d62  mbol (prims.Symb
-0000f1e0: 6f6c 293a 2053 796d 626f 6c20 746f 2065  ol): Symbol to e
-0000f1f0: 7661 6c75 6174 652e 0a0a 2020 2020 5261  valuate...    Ra
-0000f200: 6973 6573 3a0a 2020 2020 2020 2020 4e6f  ises:.        No
-0000f210: 7449 6d70 6c65 6d65 6e74 6564 4572 726f  tImplementedErro
-0000f220: 723a 2049 6620 7468 6520 766d 6170 2066  r: If the vmap f
-0000f230: 6f72 2074 6865 2073 796d 626f 6c20 6973  or the symbol is
-0000f240: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
-0000f250: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-0000f260: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
-0000f270: 3a20 766d 6170 2066 756e 6374 696f 6e20  : vmap function 
-0000f280: 7468 6174 2065 7661 6c75 6174 6573 2074  that evaluates t
-0000f290: 6865 2073 796d 626f 6c2e 0a20 2020 2022  he symbol..    "
-0000f2a0: 2222 0a0a 2020 2020 6465 6620 7772 6170  ""..    def wrap
-0000f2b0: 5f61 7267 2878 293a 0a20 2020 2020 2020  _arg(x):.       
-0000f2c0: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
-0000f2d0: 2c20 4261 7463 6865 6456 616c 7565 293a  , BatchedValue):
-0000f2e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000f2f0: 7572 6e20 780a 2020 2020 2020 2020 656c  urn x.        el
-0000f300: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
-0000f310: 204e 756d 6265 7229 3a0a 2020 2020 2020   Number):.      
-0000f320: 2020 2020 2020 7265 7475 726e 2042 6174        return Bat
-0000f330: 6368 6564 5661 6c75 6528 782c 206e 6f74  chedValue(x, not
-0000f340: 5f6d 6170 7065 6429 0a20 2020 2020 2020  _mapped).       
-0000f350: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000f360: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0000f370: 726f 7228 6622 766d 6170 2077 7261 705f  ror(f"vmap wrap_
-0000f380: 6172 6720 676f 7420 616e 2075 6e73 7570  arg got an unsup
-0000f390: 706f 7274 6564 2074 7970 6520 7b74 7970  ported type {typ
-0000f3a0: 6528 7829 7d22 290a 0a20 2020 2069 6620  e(x)}")..    if 
-0000f3b0: 7379 6d62 6f6c 2e61 7265 5f61 6c6c 5f61  symbol.are_all_a
-0000f3c0: 7267 735f 636f 6e73 7461 6e74 3a0a 0a20  rgs_constant:.. 
-0000f3d0: 2020 2020 2020 2064 6566 205f 766d 6170         def _vmap
-0000f3e0: 5f69 6d70 6c5f 636f 6e73 7428 7379 6d62  _impl_const(symb
-0000f3f0: 6f6c 2c20 2a61 7267 732c 202a 2a6b 7761  ol, *args, **kwa
-0000f400: 7267 7329 3a0a 2020 2020 2020 2020 2020  rgs):.          
-0000f410: 2020 6f75 7420 3d20 7379 6d62 6f6c 5f74    out = symbol_t
-0000f420: 6f5f 6576 616c 2873 796d 626f 6c29 282a  o_eval(symbol)(*
-0000f430: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
-0000f440: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000f450: 6973 696e 7374 616e 6365 286f 7574 2c20  isinstance(out, 
-0000f460: 5365 7175 656e 6365 293a 0a20 2020 2020  Sequence):.     
-0000f470: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000f480: 6e20 7361 6665 5f6d 6170 2870 6169 725f  n safe_map(pair_
-0000f490: 746f 5f62 6174 6368 6564 5f76 616c 7565  to_batched_value
-0000f4a0: 2c20 7361 6665 5f7a 6970 2861 7267 732c  , safe_zip(args,
-0000f4b0: 205b 6e6f 745f 6d61 7070 6564 5d20 2a20   [not_mapped] * 
-0000f4c0: 6c65 6e28 6f75 7429 2929 0a0a 2020 2020  len(out)))..    
-0000f4d0: 2020 2020 2020 2020 7265 7475 726e 2042          return B
-0000f4e0: 6174 6368 6564 5661 6c75 6528 6f75 742c  atchedValue(out,
-0000f4f0: 206e 6f74 5f6d 6170 7065 6429 0a0a 2020   not_mapped)..  
-0000f500: 2020 2020 2020 7265 7475 726e 2070 6172        return par
-0000f510: 7469 616c 285f 766d 6170 5f69 6d70 6c5f  tial(_vmap_impl_
-0000f520: 636f 6e73 742c 2073 796d 626f 6c29 0a0a  const, symbol)..
-0000f530: 2020 2020 766d 6170 5f69 6d70 6c20 3d20      vmap_impl = 
-0000f540: 766d 6170 5f69 6d70 6c73 2e67 6574 2873  vmap_impls.get(s
-0000f550: 796d 626f 6c2e 7379 6d2e 6964 290a 2020  ymbol.sym.id).  
-0000f560: 2020 6966 2076 6d61 705f 696d 706c 2069    if vmap_impl i
-0000f570: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000f580: 6966 206c 656e 2873 796d 626f 6c2e 7375  if len(symbol.su
-0000f590: 6273 796d 626f 6c73 2920 3e20 303a 0a20  bsymbols) > 0:. 
-0000f5a0: 2020 2020 2020 2020 2020 2076 6d61 705f             vmap_
-0000f5b0: 696d 706c 203d 2070 6172 7469 616c 2864  impl = partial(d
-0000f5c0: 6563 6f6d 706f 7365 645f 666e 5f76 6d61  ecomposed_fn_vma
-0000f5d0: 705f 7275 6c65 2c20 666e 3d73 796d 626f  p_rule, fn=symbo
-0000f5e0: 6c2e 7379 6d29 0a20 2020 2020 2020 2065  l.sym).        e
-0000f5f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000f600: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
-0000f610: 656e 7465 6445 7272 6f72 2866 2276 6d61  entedError(f"vma
-0000f620: 7020 666f 7220 7b73 796d 626f 6c2e 7379  p for {symbol.sy
-0000f630: 6d2e 6964 7d20 6973 206e 6f74 2069 6d70  m.id} is not imp
-0000f640: 6c65 6d65 6e74 6564 2229 0a0a 2020 2020  lemented")..    
-0000f650: 6465 6620 5f76 6d61 705f 696d 706c 282a  def _vmap_impl(*
-0000f660: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-0000f670: 0a20 2020 2020 2020 2061 7267 7320 3d20  .        args = 
-0000f680: 7472 6565 5f6d 6170 2877 7261 705f 6172  tree_map(wrap_ar
-0000f690: 672c 2061 7267 7329 0a20 2020 2020 2020  g, args).       
-0000f6a0: 2061 7373 6572 7420 616c 6c28 6973 696e   assert all(isin
-0000f6b0: 7374 616e 6365 2861 7267 2c20 4261 7463  stance(arg, Batc
-0000f6c0: 6865 6456 616c 7565 2920 666f 7220 6172  hedValue) for ar
-0000f6d0: 6720 696e 2074 7265 655f 666c 6174 7465  g in tree_flatte
-0000f6e0: 6e28 6172 6773 295b 305d 290a 2020 2020  n(args)[0]).    
-0000f6f0: 2020 2020 7265 7475 726e 2076 6d61 705f      return vmap_
-0000f700: 696d 706c 2861 7869 735f 7369 7a65 2c20  impl(axis_size, 
-0000f710: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
-0000f720: 0a0a 2020 2020 7265 7475 726e 205f 766d  ..    return _vm
-0000f730: 6170 5f69 6d70 6c0a 0a0a 6465 6620 7265  ap_impl...def re
-0000f740: 6d6f 7665 5f62 6174 6368 5f64 696d 2874  move_batch_dim(t
-0000f750: 656e 736f 723a 2054 656e 736f 7250 726f  ensor: TensorPro
-0000f760: 7879 2c20 6261 7463 685f 6469 6d3a 2069  xy, batch_dim: i
-0000f770: 6e74 203d 2030 2920 2d3e 2054 656e 736f  nt = 0) -> Tenso
-0000f780: 7250 726f 7879 3a0a 2020 2020 2222 2252  rProxy:.    """R
-0000f790: 656d 6f76 6573 2074 6865 2062 6174 6368  emoves the batch
-0000f7a0: 2064 696d 656e 7369 6f6e 2066 726f 6d20   dimension from 
-0000f7b0: 6120 7465 6e73 6f72 2e0a 0a20 2020 2041  a tensor...    A
-0000f7c0: 7267 733a 0a20 2020 2020 2020 2074 656e  rgs:.        ten
-0000f7d0: 736f 7220 2854 656e 736f 7250 726f 7879  sor (TensorProxy
-0000f7e0: 293a 2054 656e 736f 7220 746f 2072 656d  ): Tensor to rem
-0000f7f0: 6f76 6520 7468 6520 6261 7463 6820 6469  ove the batch di
-0000f800: 6d65 6e73 696f 6e20 6672 6f6d 2e0a 0a20  mension from... 
-0000f810: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-0000f820: 2020 2020 5465 6e73 6f72 5072 6f78 793a      TensorProxy:
-0000f830: 2054 656e 736f 7220 7769 7468 2074 6865   Tensor with the
-0000f840: 2062 6174 6368 2064 696d 656e 7369 6f6e   batch dimension
-0000f850: 2072 656d 6f76 6564 2e0a 2020 2020 2222   removed..    ""
-0000f860: 220a 2020 2020 6e65 775f 7368 6170 6520  ".    new_shape 
-0000f870: 3d20 7465 6e73 6f72 2e73 6861 7065 5b3a  = tensor.shape[:
-0000f880: 6261 7463 685f 6469 6d5d 202b 2074 656e  batch_dim] + ten
-0000f890: 736f 722e 7368 6170 655b 6261 7463 685f  sor.shape[batch_
-0000f8a0: 6469 6d20 2b20 3120 3a5d 0a20 2020 2072  dim + 1 :].    r
-0000f8b0: 6574 7572 6e20 5465 6e73 6f72 5072 6f78  eturn TensorProx
-0000f8c0: 7928 6c69 6b65 3d74 656e 736f 722c 2073  y(like=tensor, s
-0000f8d0: 6861 7065 3d6e 6577 5f73 6861 7065 290a  hape=new_shape).
-0000f8e0: 0a0a 2320 544f 444f 3a20 696e 204a 4158  ..# TODO: in JAX
-0000f8f0: 2061 7267 732c 2069 6e5f 6469 6d73 2061   args, in_dims a
-0000f900: 7265 2066 6c61 7474 656e 6564 2074 6865  re flattened the
-0000f910: 2073 616d 6520 7761 790a 2320 544f 444f   same way.# TODO
-0000f920: 3a20 696e 204a 4158 206f 7574 5f64 696d  : in JAX out_dim
-0000f930: 7320 6172 6520 666c 6174 7465 6e65 6420  s are flattened 
-0000f940: 6173 2077 656c 6c0a 6465 6620 5f76 6d61  as well.def _vma
-0000f950: 705f 6361 6c6c 5f6d 6574 6166 756e 6328  p_call_metafunc(
-0000f960: 6465 7461 6368 6564 3a20 626f 6f6c 2c20  detached: bool, 
-0000f970: 6172 6773 2c20 696e 5f64 696d 732c 206f  args, in_dims, o
-0000f980: 7574 5f64 696d 732c 2061 7869 735f 7369  ut_dims, axis_si
-0000f990: 7a65 2c20 6675 6e63 7469 6f6e 5f74 7261  ze, function_tra
-0000f9a0: 6365 3a20 5472 6163 652c 202a 2a6b 7761  ce: Trace, **kwa
-0000f9b0: 7267 7329 3a0a 2020 2020 2222 224d 6574  rgs):.    """Met
-0000f9c0: 6166 756e 6374 696f 6e20 666f 7220 766d  afunction for vm
-0000f9d0: 6170 2063 616c 6c2e 0a0a 2020 2020 4172  ap call...    Ar
-0000f9e0: 6773 3a0a 2020 2020 2020 2020 6465 7461  gs:.        deta
-0000f9f0: 6368 6564 2028 626f 6f6c 293a 2057 6865  ched (bool): Whe
-0000fa00: 7468 6572 2074 6f20 6465 7461 6368 2074  ther to detach t
-0000fa10: 6865 2074 7261 6365 2e0a 2020 2020 2020  he trace..      
-0000fa20: 2020 6172 6773 2028 5475 706c 655b 5072    args (Tuple[Pr
-0000fa30: 6f78 795d 293a 2041 7267 756d 656e 7473  oxy]): Arguments
-0000fa40: 2074 6f20 7468 6520 6675 6e63 7469 6f6e   to the function
-0000fa50: 2e0a 2020 2020 2020 2020 696e 5f64 696d  ..        in_dim
-0000fa60: 7320 2854 7570 6c65 5b69 6e74 5d29 3a20  s (Tuple[int]): 
-0000fa70: 4261 7463 6820 6469 6d65 6e73 696f 6e20  Batch dimension 
-0000fa80: 666f 7220 6561 6368 2061 7267 756d 656e  for each argumen
-0000fa90: 742e 0a20 2020 2020 2020 206f 7574 5f64  t..        out_d
-0000faa0: 696d 7320 2854 7570 6c65 5b69 6e74 5d29  ims (Tuple[int])
-0000fab0: 3a20 4261 7463 6820 6469 6d65 6e73 696f  : Batch dimensio
-0000fac0: 6e20 666f 7220 7265 7475 726e 2076 616c  n for return val
-0000fad0: 7565 732e 0a20 2020 2020 2020 2066 756e  ues..        fun
-0000fae0: 6374 696f 6e5f 7472 6163 6520 2854 7261  ction_trace (Tra
-0000faf0: 6365 293a 2054 7261 6365 2074 6f20 7573  ce): Trace to us
-0000fb00: 6520 666f 7220 7468 6520 6675 6e63 7469  e for the functi
-0000fb10: 6f6e 2e0a 2020 2020 2020 2020 6b77 6172  on..        kwar
-0000fb20: 6773 3a20 4b65 7977 6f72 6420 6172 6775  gs: Keyword argu
-0000fb30: 6d65 6e74 732e 0a0a 2020 2020 5261 6973  ments...    Rais
-0000fb40: 6573 3a0a 2020 2020 2020 2020 4173 7365  es:.        Asse
-0000fb50: 7274 696f 6e45 7272 6f72 3a20 4966 2074  rtionError: If t
-0000fb60: 6865 2076 6d61 7020 666f 7220 6b65 7977  he vmap for keyw
-0000fb70: 6f72 6420 6172 6775 6d65 6e74 7320 6973  ord arguments is
-0000fb80: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
-0000fb90: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-0000fba0: 2020 2020 2020 2020 5265 7375 6c74 206f          Result o
-0000fbb0: 6620 7468 6520 766d 6170 2074 7261 6e73  f the vmap trans
-0000fbc0: 666f 726d 2e0a 2020 2020 2222 220a 2020  form..    """.  
-0000fbd0: 2020 636f 6d6d 6f6e 5f64 6576 6963 6520    common_device 
-0000fbe0: 3d20 7b78 2e64 6576 6963 6520 666f 7220  = {x.device for 
-0000fbf0: 7820 696e 2061 7267 7320 6966 2069 7369  x in args if isi
-0000fc00: 6e73 7461 6e63 6528 782c 2054 656e 736f  nstance(x, Tenso
-0000fc10: 7250 726f 7879 297d 0a20 2020 2061 7373  rProxy)}.    ass
-0000fc20: 6572 7420 6c65 6e28 636f 6d6d 6f6e 5f64  ert len(common_d
-0000fc30: 6576 6963 6529 203c 3d20 312c 2022 766d  evice) <= 1, "vm
-0000fc40: 6170 2066 6f72 206d 756c 7469 706c 6520  ap for multiple 
-0000fc50: 6465 7669 6365 7320 6973 206e 6f74 2069  devices is not i
-0000fc60: 6d70 6c65 6d65 6e74 6564 220a 2020 2020  mplemented".    
-0000fc70: 2863 6f6d 6d6f 6e5f 6465 7669 6365 2c29  (common_device,)
-0000fc80: 203d 2063 6f6d 6d6f 6e5f 6465 7669 6365   = common_device
-0000fc90: 2069 6620 6c65 6e28 636f 6d6d 6f6e 5f64   if len(common_d
-0000fca0: 6576 6963 6529 203d 3d20 3120 656c 7365  evice) == 1 else
-0000fcb0: 2028 6370 752c 290a 0a20 2020 2069 6620   (cpu,)..    if 
-0000fcc0: 6178 6973 5f73 697a 6520 6973 204e 6f6e  axis_size is Non
-0000fcd0: 653a 0a20 2020 2020 2020 2028 6178 6973  e:.        (axis
-0000fce0: 5f73 697a 652c 2920 3d20 7b78 2e73 6861  _size,) = {x.sha
-0000fcf0: 7065 5b61 785d 2066 6f72 2078 2c20 6178  pe[ax] for x, ax
-0000fd00: 2069 6e20 7a69 7028 6172 6773 2c20 696e   in zip(args, in
-0000fd10: 5f64 696d 7329 2069 6620 6178 2069 7320  _dims) if ax is 
-0000fd20: 6e6f 7420 6e6f 745f 6d61 7070 6564 7d0a  not not_mapped}.
-0000fd30: 2020 2020 696e 5f64 696d 7320 3d20 696e      in_dims = in
-0000fd40: 5f64 696d 7320 6966 2069 7369 6e73 7461  _dims if isinsta
-0000fd50: 6e63 6528 696e 5f64 696d 732c 2053 6571  nce(in_dims, Seq
-0000fd60: 7565 6e63 6529 2065 6c73 6520 2869 6e5f  uence) else (in_
-0000fd70: 6469 6d73 2c29 0a20 2020 2069 6e5f 6469  dims,).    in_di
-0000fd80: 6d73 203d 2074 7570 6c65 286e 6f74 5f6d  ms = tuple(not_m
-0000fd90: 6170 7065 6420 6966 2069 7369 6e73 7461  apped if isinsta
-0000fda0: 6e63 6528 612c 204e 756d 6265 7229 2065  nce(a, Number) e
-0000fdb0: 6c73 6520 6420 666f 7220 612c 2064 2069  lse d for a, d i
-0000fdc0: 6e20 7361 6665 5f7a 6970 2861 7267 732c  n safe_zip(args,
-0000fdd0: 2069 6e5f 6469 6d73 2929 0a20 2020 206f   in_dims)).    o
-0000fde0: 7574 5f64 696d 7320 3d20 6f75 745f 6469  ut_dims = out_di
-0000fdf0: 6d73 2069 6620 6973 696e 7374 616e 6365  ms if isinstance
-0000fe00: 286f 7574 5f64 696d 732c 2053 6571 7565  (out_dims, Seque
-0000fe10: 6e63 6529 2065 6c73 6520 286f 7574 5f64  nce) else (out_d
-0000fe20: 696d 732c 290a 0a20 2020 2063 7478 203d  ims,)..    ctx =
-0000fe30: 2064 6574 6163 6865 645f 7472 6163 6528   detached_trace(
-0000fe40: 2920 6966 2064 6574 6163 6865 6420 656c  ) if detached el
-0000fe50: 7365 206e 756c 6c63 6f6e 7465 7874 2829  se nullcontext()
-0000fe60: 0a20 2020 2077 6974 6820 6374 783a 0a20  .    with ctx:. 
-0000fe70: 2020 2020 2020 2023 2057 6520 7072 6f70         # We prop
-0000fe80: 6167 6174 6520 7468 6520 4261 7463 6856  agate the BatchV
-0000fe90: 616c 7565 2074 6872 6f75 6768 2074 6865  alue through the
-0000fea0: 2074 7261 6365 2c20 616e 6420 7468 656e   trace, and then
-0000feb0: 2075 6e77 7261 7020 6974 2061 7420 7468   unwrap it at th
-0000fec0: 6520 656e 640a 2020 2020 2020 2020 6261  e end.        ba
-0000fed0: 7463 6865 645f 6172 6773 203d 2073 6166  tched_args = saf
-0000fee0: 655f 6d61 7028 7061 6972 5f74 6f5f 6261  e_map(pair_to_ba
-0000fef0: 7463 6865 645f 7661 6c75 652c 2073 6166  tched_value, saf
-0000ff00: 655f 7a69 7028 6172 6773 2c20 696e 5f64  e_zip(args, in_d
-0000ff10: 696d 7329 290a 2020 2020 2020 2020 7265  ims)).        re
-0000ff20: 7375 6c74 203d 2065 7661 6c5f 7472 6163  sult = eval_trac
-0000ff30: 6528 0a20 2020 2020 2020 2020 2020 2066  e(.            f
-0000ff40: 756e 6374 696f 6e5f 7472 6163 652c 202a  unction_trace, *
-0000ff50: 6261 7463 6865 645f 6172 6773 2c20 7379  batched_args, sy
-0000ff60: 6d62 6f6c 5f6d 6170 7065 723d 7061 7274  mbol_mapper=part
-0000ff70: 6961 6c28 766d 6170 5f73 796d 626f 6c5f  ial(vmap_symbol_
-0000ff80: 6d61 7070 6572 2c20 6178 6973 5f73 697a  mapper, axis_siz
-0000ff90: 653d 6178 6973 5f73 697a 6529 2c20 2a2a  e=axis_size), **
-0000ffa0: 6b77 6172 6773 0a20 2020 2020 2020 2029  kwargs.        )
-0000ffb0: 0a20 2020 2020 2020 2023 2055 6e77 7261  .        # Unwra
-0000ffc0: 7070 696e 6720 7468 6520 4261 7463 6865  pping the Batche
-0000ffd0: 6456 616c 7565 2773 0a20 2020 2020 2020  dValue's.       
-0000ffe0: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-0000fff0: 6573 756c 742c 2053 6571 7565 6e63 6529  esult, Sequence)
-00010000: 3a0a 2020 2020 2020 2020 2020 2020 666c  :.            fl
-00010010: 6174 5f72 6573 756c 742c 2073 7065 6320  at_result, spec 
-00010020: 3d20 7472 6565 5f66 6c61 7474 656e 2872  = tree_flatten(r
-00010030: 6573 756c 7429 0a20 2020 2020 2020 2020  esult).         
-00010040: 2020 2061 7373 6572 7420 616c 6c28 6973     assert all(is
-00010050: 696e 7374 616e 6365 2878 2c20 4261 7463  instance(x, Batc
-00010060: 6865 6456 616c 7565 2920 666f 7220 7820  hedValue) for x 
-00010070: 696e 2066 6c61 745f 7265 7375 6c74 290a  in flat_result).
-00010080: 2020 2020 2020 2020 2020 2020 6f75 7473              outs
-00010090: 2c20 6264 696d 7320 3d20 756e 7a69 7032  , bdims = unzip2
-000100a0: 2866 6c61 745f 7265 7375 6c74 290a 2020  (flat_result).  
-000100b0: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
-000100c0: 3a20 6861 6e64 6c65 2074 6865 2063 6173  : handle the cas
-000100d0: 6520 7768 6572 6520 6f75 745f 6469 6d73  e where out_dims
-000100e0: 2069 7320 6120 7369 6e67 6c65 2076 616c   is a single val
-000100f0: 7565 2062 6574 7465 720a 2020 2020 2020  ue better.      
-00010100: 2020 2020 2020 6966 206c 656e 286f 7574        if len(out
-00010110: 5f64 696d 7329 203d 3d20 313a 0a20 2020  _dims) == 1:.   
-00010120: 2020 2020 2020 2020 2020 2020 206f 7574               out
-00010130: 5f64 696d 7320 3d20 6f75 745f 6469 6d73  _dims = out_dims
-00010140: 202a 206c 656e 286f 7574 7329 0a20 2020   * len(outs).   
-00010150: 2020 2020 2020 2020 206f 7574 7320 3d20           outs = 
-00010160: 7361 6665 5f6d 6170 2870 6172 7469 616c  safe_map(partial
-00010170: 286d 6f76 655f 6261 7463 685f 6469 6d2c  (move_batch_dim,
-00010180: 2061 7869 735f 7369 7a65 292c 2062 6469   axis_size), bdi
-00010190: 6d73 2c20 6f75 745f 6469 6d73 2c20 6f75  ms, out_dims, ou
-000101a0: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
-000101b0: 7265 7475 726e 2074 7265 655f 756e 666c  return tree_unfl
-000101c0: 6174 7465 6e28 6f75 7473 2c20 7370 6563  atten(outs, spec
-000101d0: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
-000101e0: 6e73 7461 6e63 6528 7265 7375 6c74 2c20  nstance(result, 
-000101f0: 4e75 6d62 6572 2920 616e 6420 6178 6973  Number) and axis
-00010200: 5f73 697a 6520 6973 206e 6f74 204e 6f6e  _size is not Non
-00010210: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00010220: 2054 4f44 4f3a 2066 6574 6368 2074 6865   TODO: fetch the
-00010230: 2064 6566 6175 6c74 2064 6576 6963 6520   default device 
-00010240: 6672 6f6d 2074 6865 2063 6f6e 7465 7874  from the context
-00010250: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00010260: 756c 7420 3d20 6675 6c6c 2873 6861 7065  ult = full(shape
-00010270: 3d28 292c 2066 696c 6c5f 7661 6c75 653d  =(), fill_value=
-00010280: 7265 7375 6c74 2c20 6465 7669 6365 3d63  result, device=c
-00010290: 6f6d 6d6f 6e5f 6465 7669 6365 290a 2020  ommon_device).  
-000102a0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-000102b0: 203d 2042 6174 6368 6564 5661 6c75 6528   = BatchedValue(
-000102c0: 7265 7375 6c74 2c20 6e6f 745f 6d61 7070  result, not_mapp
-000102d0: 6564 290a 2020 2020 2020 2020 656c 6966  ed).        elif
-000102e0: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
-000102f0: 6c74 2c20 4261 7463 6865 6456 616c 7565  lt, BatchedValue
-00010300: 2920 616e 6420 6973 696e 7374 616e 6365  ) and isinstance
-00010310: 2872 6573 756c 742e 7661 6c75 652c 204e  (result.value, N
-00010320: 756d 6265 7229 2061 6e64 2061 7869 735f  umber) and axis_
-00010330: 7369 7a65 2069 7320 6e6f 7420 4e6f 6e65  size is not None
-00010340: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00010350: 7375 6c74 203d 2042 6174 6368 6564 5661  sult = BatchedVa
-00010360: 6c75 6528 6675 6c6c 2873 6861 7065 3d28  lue(full(shape=(
-00010370: 292c 2066 696c 6c5f 7661 6c75 653d 7265  ), fill_value=re
-00010380: 7375 6c74 2e76 616c 7565 2c20 6465 7669  sult.value, devi
-00010390: 6365 3d63 6f6d 6d6f 6e5f 6465 7669 6365  ce=common_device
-000103a0: 292c 2072 6573 756c 742e 6261 7463 685f  ), result.batch_
-000103b0: 6469 6d29 0a20 2020 2020 2020 2061 7373  dim).        ass
-000103c0: 6572 7420 6973 696e 7374 616e 6365 2872  ert isinstance(r
-000103d0: 6573 756c 742c 2042 6174 6368 6564 5661  esult, BatchedVa
-000103e0: 6c75 6529 0a20 2020 2020 2020 206f 7574  lue).        out
-000103f0: 203d 206d 6f76 655f 6261 7463 685f 6469   = move_batch_di
-00010400: 6d28 6178 6973 5f73 697a 652c 2072 6573  m(axis_size, res
-00010410: 756c 742e 6261 7463 685f 6469 6d2c 206f  ult.batch_dim, o
-00010420: 7574 5f64 696d 735b 305d 2c20 7265 7375  ut_dims[0], resu
-00010430: 6c74 2e76 616c 7565 290a 2020 2020 2020  lt.value).      
-00010440: 2020 7265 7475 726e 206f 7574 0a0a 0a76    return out...v
-00010450: 6d61 705f 6361 6c6c 203d 2053 796d 626f  map_call = Symbo
-00010460: 6c28 6964 3d54 7261 6e73 666f 726d 732e  l(id=Transforms.
-00010470: 566d 6170 4f70 2c20 6e61 6d65 3d22 766d  VmapOp, name="vm
-00010480: 6170 5f63 616c 6c22 2c20 6d65 7461 3d70  ap_call", meta=p
-00010490: 6172 7469 616c 285f 766d 6170 5f63 616c  artial(_vmap_cal
-000104a0: 6c5f 6d65 7461 6675 6e63 2c20 4661 6c73  l_metafunc, Fals
-000104b0: 6529 290a 0a0a 2320 544f 444f 3a20 686f  e))...# TODO: ho
-000104c0: 7720 7368 6f75 6c64 2077 6520 6861 6e64  w should we hand
-000104d0: 6c65 206f 7574 5f64 696d 7320 6865 7265  le out_dims here
-000104e0: 3f0a 2320 616c 7468 6f75 6768 2068 6572  ?.# although her
-000104f0: 6520 7765 2061 7265 2063 616c 6c69 6e67  e we are calling
-00010500: 2076 6d61 7020 6f66 2069 6465 6e74 6974   vmap of identit
-00010510: 792c 2073 6f20 7765 2073 686f 756c 6420  y, so we should 
-00010520: 6b6e 6f77 2066 726f 6d20 7468 6520 6361  know from the ca
-00010530: 6c6c 2074 6f20 766d 6170 0a23 2054 6869  ll to vmap.# Thi
-00010540: 7320 7368 6f75 6c64 2062 6520 6669 6e65  s should be fine
-00010550: 2e20 4966 2077 6520 6861 7665 2076 6d61  . If we have vma
-00010560: 7028 6964 656e 7469 7479 2866 756e 6329  p(identity(func)
-00010570: 2c20 6f75 745f 6469 6d73 3d4e 2920 7468  , out_dims=N) th
-00010580: 656e 2074 6869 7320 7275 6c65 2069 7320  en this rule is 
-00010590: 6669 7273 7420 7573 6564 0a23 2074 6f20  first used.# to 
-000105a0: 6765 7420 7468 6520 766d 6170 7065 6420  get the vmapped 
-000105b0: 7265 7375 6c74 206f 6620 6964 656e 7469  result of identi
-000105c0: 7479 2866 756e 6329 2069 6e20 766d 6170  ty(func) in vmap
-000105d0: 5f73 796d 626f 6c5f 6d61 7070 6572 2c20  _symbol_mapper, 
-000105e0: 616e 6420 6f75 745f 6469 6d73 2069 7320  and out_dims is 
-000105f0: 6861 6e64 6c65 640a 2320 6166 7465 7220  handled.# after 
-00010600: 7468 6174 2069 6e20 7468 6520 6f75 7465  that in the oute
-00010610: 7220 5f76 6d61 705f 6361 6c6c 5f6d 6574  r _vmap_call_met
-00010620: 6166 756e 632e 0a64 6566 205f 6964 656e  afunc..def _iden
-00010630: 7469 7479 5f63 616c 6c5f 766d 6170 2861  tity_call_vmap(a
-00010640: 7869 735f 7369 7a65 2c20 2a62 6174 6368  xis_size, *batch
-00010650: 6564 5f61 7267 732c 2074 7261 6365 3a20  ed_args, trace: 
-00010660: 5472 6163 652c 202a 2a6b 7761 7267 7329  Trace, **kwargs)
-00010670: 3a0a 2020 2020 6172 6773 2c20 696e 5f64  :.    args, in_d
-00010680: 696d 7320 3d20 756e 7a69 7032 2862 6174  ims = unzip2(bat
-00010690: 6368 6564 5f61 7267 7329 0a20 2020 206f  ched_args).    o
-000106a0: 7574 5f64 696d 7320 3d20 3020 2023 2046  ut_dims = 0  # F
-000106b0: 6978 6d65 0a20 2020 206f 7574 732c 206f  ixme.    outs, o
-000106c0: 7574 5f64 696d 7320 3d20 5f76 6d61 705f  ut_dims = _vmap_
-000106d0: 6361 6c6c 5f6d 6574 6166 756e 6328 4661  call_metafunc(Fa
-000106e0: 6c73 652c 2061 7267 732c 2069 6e5f 6469  lse, args, in_di
-000106f0: 6d73 2c20 6f75 745f 6469 6d73 2c20 6178  ms, out_dims, ax
-00010700: 6973 5f73 697a 652c 2066 756e 6374 696f  is_size, functio
-00010710: 6e5f 7472 6163 653d 7472 6163 652c 202a  n_trace=trace, *
-00010720: 2a6b 7761 7267 7329 0a20 2020 2069 6620  *kwargs).    if 
-00010730: 6973 696e 7374 616e 6365 286f 7574 732c  isinstance(outs,
-00010740: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
-00010750: 2020 2020 7265 7475 726e 2073 6166 655f      return safe_
-00010760: 6d61 7028 7061 6972 5f74 6f5f 6261 7463  map(pair_to_batc
-00010770: 6865 645f 7661 6c75 652c 2073 6166 655f  hed_value, safe_
-00010780: 7a69 7028 6f75 7473 2c20 6f75 745f 6469  zip(outs, out_di
-00010790: 6d73 2929 0a20 2020 2072 6574 7572 6e20  ms)).    return 
-000107a0: 4261 7463 6865 6456 616c 7565 286f 7574  BatchedValue(out
-000107b0: 732c 206f 7574 5f64 696d 7329 0a0a 0a76  s, out_dims)...v
-000107c0: 6d61 705f 696d 706c 735b 5472 616e 7366  map_impls[Transf
-000107d0: 6f72 6d73 2e49 6465 6e74 6974 794f 705d  orms.IdentityOp]
-000107e0: 203d 205f 6964 656e 7469 7479 5f63 616c   = _identity_cal
-000107f0: 6c5f 766d 6170 0a0a 0a64 6566 205f 6a76  l_vmap...def _jv
-00010800: 705f 6361 6c6c 5f76 6d61 7028 6178 6973  p_call_vmap(axis
-00010810: 5f73 697a 652c 2062 6174 6368 6564 5f70  _size, batched_p
-00010820: 7269 6d61 6c73 2c20 6261 7463 6865 645f  rimals, batched_
-00010830: 7461 6e67 656e 7473 2c20 2a2c 2066 756e  tangents, *, fun
-00010840: 6374 696f 6e5f 7472 6163 653a 2054 7261  ction_trace: Tra
-00010850: 6365 2c20 2a2a 6b77 6172 6773 293a 0a20  ce, **kwargs):. 
-00010860: 2020 2070 7269 6d61 6c73 2c20 7072 696d     primals, prim
-00010870: 616c 735f 6264 696d 7320 3d20 7361 6665  als_bdims = safe
-00010880: 5f7a 6970 282a 6261 7463 6865 645f 7072  _zip(*batched_pr
-00010890: 696d 616c 7329 0a20 2020 2074 616e 6765  imals).    tange
-000108a0: 6e74 732c 2074 616e 6765 6e74 735f 6264  nts, tangents_bd
-000108b0: 696d 7320 3d20 7361 6665 5f7a 6970 282a  ims = safe_zip(*
-000108c0: 6261 7463 6865 645f 7461 6e67 656e 7473  batched_tangents
-000108d0: 290a 2020 2020 6a76 705f 6675 6e63 203d  ).    jvp_func =
-000108e0: 2070 6172 7469 616c 285f 6a76 705f 6361   partial(_jvp_ca
-000108f0: 6c6c 5f6d 6574 6166 756e 632c 2046 616c  ll_metafunc, Fal
-00010900: 7365 2c20 6675 6e63 7469 6f6e 5f74 7261  se, function_tra
-00010910: 6365 3d66 756e 6374 696f 6e5f 7472 6163  ce=function_trac
-00010920: 6529 0a20 2020 2076 6d61 7070 6564 5f6a  e).    vmapped_j
-00010930: 7670 5f66 756e 6320 3d20 766d 6170 286a  vp_func = vmap(j
-00010940: 7670 5f66 756e 632c 2069 6e5f 6469 6d73  vp_func, in_dims
-00010950: 3d28 7072 696d 616c 735f 6264 696d 732c  =(primals_bdims,
-00010960: 2074 616e 6765 6e74 735f 6264 696d 7329   tangents_bdims)
-00010970: 2c20 6178 6973 5f73 697a 653d 6178 6973  , axis_size=axis
-00010980: 5f73 697a 6529 0a20 2020 2072 6573 756c  _size).    resul
-00010990: 7420 3d20 766d 6170 7065 645f 6a76 705f  t = vmapped_jvp_
-000109a0: 6675 6e63 2870 7269 6d61 6c73 2c20 7461  func(primals, ta
-000109b0: 6e67 656e 7473 2c20 2a2a 6b77 6172 6773  ngents, **kwargs
-000109c0: 290a 2020 2020 7265 7475 726e 2074 7265  ).    return tre
-000109d0: 655f 6d61 7028 6c61 6d62 6461 2078 3a20  e_map(lambda x: 
-000109e0: 4261 7463 6865 6456 616c 7565 2878 2c20  BatchedValue(x, 
-000109f0: 3029 2c20 7265 7375 6c74 290a 0a0a 766d  0), result)...vm
-00010a00: 6170 5f69 6d70 6c73 5b54 7261 6e73 666f  ap_impls[Transfo
-00010a10: 726d 732e 4a76 704f 705d 203d 205f 6a76  rms.JvpOp] = _jv
-00010a20: 705f 6361 6c6c 5f76 6d61 700a 0a0a 6465  p_call_vmap...de
-00010a30: 6620 766d 6170 2866 756e 632c 2069 6e5f  f vmap(func, in_
-00010a40: 6469 6d73 3d30 2c20 6f75 745f 6469 6d73  dims=0, out_dims
-00010a50: 3d30 2c20 6178 6973 5f73 697a 653d 4e6f  =0, axis_size=No
-00010a60: 6e65 293a 0a20 2020 2022 2222 5665 6374  ne):.    """Vect
-00010a70: 6f72 697a 696e 6720 7472 616e 7366 6f72  orizing transfor
-00010a80: 6d20 666f 7220 6120 5468 756e 6465 7220  m for a Thunder 
-00010a90: 6675 6e63 7469 6f6e 2e0a 0a20 2020 2041  function...    A
-00010aa0: 7267 733a 0a20 2020 2020 2020 2066 756e  rgs:.        fun
-00010ab0: 6320 2843 616c 6c61 626c 6529 3a20 4120  c (Callable): A 
-00010ac0: 5468 756e 6465 7220 6675 6e63 7469 6f6e  Thunder function
-00010ad0: 2074 6f20 6265 2074 7261 6e73 666f 726d   to be transform
-00010ae0: 6564 2e0a 0a20 2020 2052 6574 7572 6e73  ed...    Returns
-00010af0: 3a0a 2020 2020 2020 2020 4361 6c6c 6162  :.        Callab
-00010b00: 6c65 3a20 4120 766d 6170 7065 6420 7665  le: A vmapped ve
-00010b10: 7273 696f 6e20 6f66 2074 6865 2066 756e  rsion of the fun
-00010b20: 6374 696f 6e2e 0a20 2020 2022 2222 0a0a  ction..    """..
-00010b30: 2020 2020 2320 544f 444f 3a20 666c 6174      # TODO: flat
-00010b40: 7465 6e0a 2020 2020 2320 496e 204a 4158  ten.    # In JAX
-00010b50: 2066 6c61 7474 656e 696e 6720 6f66 2069   flattening of i
-00010b60: 6e5f 6469 6d73 2069 7320 7261 7468 6572  n_dims is rather
-00010b70: 2063 6f6d 706c 6963 6174 6564 2062 6563   complicated bec
-00010b80: 6175 7365 2069 7420 6361 6e20 6f70 7469  ause it can opti
-00010b90: 6f6e 616c 6c79 2062 650a 2020 2020 2320  onally be.    # 
-00010ba0: 7370 6563 6966 6965 6420 6173 2061 20e2  specified as a .
-00010bb0: 809c 7072 6566 6978 e280 9d20 7079 7472  ..prefix... pytr
-00010bc0: 6565 2c20 6d65 616e 696e 6720 7468 6174  ee, meaning that
-00010bd0: 2061 2073 696e 676c 6520 6c65 6166 2076   a single leaf v
-00010be0: 616c 7565 2063 616e 2062 6520 6170 706c  alue can be appl
-00010bf0: 6965 640a 2020 2020 2320 746f 2061 6e20  ied.    # to an 
-00010c00: 656e 7469 7265 2073 7562 2d70 7974 7265  entire sub-pytre
-00010c10: 652e 0a0a 2020 2020 6465 6620 666c 6174  e...    def flat
-00010c20: 7465 6e5f 6675 6e63 5f66 6f72 5f76 6d61  ten_func_for_vma
-00010c30: 7028 6675 6e63 2c20 6172 6773 2c20 6b77  p(func, args, kw
-00010c40: 6172 6773 293a 0a20 2020 2020 2020 2066  args):.        f
-00010c50: 6c61 745f 6172 6773 2c20 7370 6563 203d  lat_args, spec =
-00010c60: 2074 7265 655f 666c 6174 7465 6e28 2861   tree_flatten((a
-00010c70: 7267 732c 206b 7761 7267 7329 290a 0a20  rgs, kwargs)).. 
-00010c80: 2020 2020 2020 2064 6566 2066 6c61 745f         def flat_
-00010c90: 6675 6e63 282a 666c 6174 5f61 7267 7329  func(*flat_args)
-00010ca0: 3a0a 2020 2020 2020 2020 2020 2020 666e  :.            fn
-00010cb0: 5f61 7267 732c 2066 6e5f 6b77 6172 6773  _args, fn_kwargs
-00010cc0: 203d 2074 7265 655f 756e 666c 6174 7465   = tree_unflatte
-00010cd0: 6e28 666c 6174 5f61 7267 732c 2073 7065  n(flat_args, spe
-00010ce0: 6329 0a20 2020 2020 2020 2020 2020 2072  c).            r
-00010cf0: 6574 7572 6e20 6675 6e63 282a 666e 5f61  eturn func(*fn_a
-00010d00: 7267 732c 202a 2a66 6e5f 6b77 6172 6773  rgs, **fn_kwargs
-00010d10: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00010d20: 6e20 666c 6174 5f66 756e 632c 2066 6c61  n flat_func, fla
-00010d30: 745f 6172 6773 2c20 7370 6563 0a0a 2020  t_args, spec..  
-00010d40: 2020 6465 6620 7772 6170 7065 7228 2a61    def wrapper(*a
-00010d50: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
-00010d60: 2020 2020 2020 2020 6675 6e63 5f66 6c61          func_fla
-00010d70: 742c 2061 7267 735f 666c 6174 2c20 6172  t, args_flat, ar
-00010d80: 6773 5f73 7065 6320 3d20 666c 6174 7465  gs_spec = flatte
-00010d90: 6e5f 6675 6e63 5f66 6f72 5f76 6d61 7028  n_func_for_vmap(
-00010da0: 6675 6e63 2c20 6172 6773 2c20 6b77 6172  func, args, kwar
-00010db0: 6773 290a 2020 2020 2020 2020 6966 2069  gs).        if i
-00010dc0: 7369 6e73 7461 6e63 6528 696e 5f64 696d  sinstance(in_dim
-00010dd0: 732c 2069 6e74 293a 0a20 2020 2020 2020  s, int):.       
-00010de0: 2020 2020 2069 6e5f 6469 6d73 5f66 6c61       in_dims_fla
-00010df0: 7420 3d20 2869 6e5f 6469 6d73 2c29 202a  t = (in_dims,) *
-00010e00: 206c 656e 2861 7267 735f 666c 6174 290a   len(args_flat).
-00010e10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00010e20: 2020 2020 2020 2020 2020 696e 5f64 696d            in_dim
-00010e30: 735f 666c 6174 2c20 696e 5f64 696d 735f  s_flat, in_dims_
-00010e40: 7370 6563 203d 2074 7265 655f 666c 6174  spec = tree_flat
-00010e50: 7465 6e28 696e 5f64 696d 7329 0a20 2020  ten(in_dims).   
-00010e60: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00010e70: 6c65 6e28 696e 5f64 696d 735f 666c 6174  len(in_dims_flat
-00010e80: 2920 3d3d 206c 656e 2861 7267 735f 666c  ) == len(args_fl
-00010e90: 6174 292c 2022 696e 5f64 696d 7320 6d75  at), "in_dims mu
-00010ea0: 7374 2068 6176 6520 7468 6520 7361 6d65  st have the same
-00010eb0: 206c 656e 6774 6820 6173 2061 7267 732c   length as args,
-00010ec0: 206b 7761 7267 7322 0a20 2020 2020 2020   kwargs".       
-00010ed0: 2075 6e62 6174 6368 6564 5f61 7267 735f   unbatched_args_
-00010ee0: 666c 6174 203d 205b 7265 6d6f 7665 5f62  flat = [remove_b
-00010ef0: 6174 6368 5f64 696d 2861 7267 2920 6966  atch_dim(arg) if
-00010f00: 2069 7369 6e73 7461 6e63 6528 6172 672c   isinstance(arg,
-00010f10: 2054 656e 736f 7250 726f 7879 2920 656c   TensorProxy) el
-00010f20: 7365 2061 7267 2066 6f72 2061 7267 2069  se arg for arg i
-00010f30: 6e20 6172 6773 5f66 6c61 745d 0a20 2020  n args_flat].   
-00010f40: 2020 2020 2074 7261 6365 203d 2063 6f6e       trace = con
-00010f50: 7374 7275 6374 5f74 7261 6365 2829 2866  struct_trace()(f
-00010f60: 756e 635f 666c 6174 2c20 2a75 6e62 6174  unc_flat, *unbat
-00010f70: 6368 6564 5f61 7267 735f 666c 6174 290a  ched_args_flat).
-00010f80: 2020 2020 2020 2020 6f75 7473 203d 2076          outs = v
-00010f90: 6d61 705f 6361 6c6c 2861 7267 735f 666c  map_call(args_fl
-00010fa0: 6174 2c20 696e 5f64 696d 735f 666c 6174  at, in_dims_flat
-00010fb0: 2c20 6f75 745f 6469 6d73 2c20 6178 6973  , out_dims, axis
-00010fc0: 5f73 697a 653d 6178 6973 5f73 697a 652c  _size=axis_size,
-00010fd0: 2066 756e 6374 696f 6e5f 7472 6163 653d   function_trace=
-00010fe0: 7472 6163 6529 0a20 2020 2020 2020 2072  trace).        r
-00010ff0: 6574 7572 6e20 6f75 7473 0a0a 2020 2020  eturn outs..    
-00011000: 7265 7475 726e 2077 7261 7070 6572 0a0a  return wrapper..
-00011010: 0a23 2054 4f44 4f20 5468 6973 2066 756e  .# TODO This fun
-00011020: 6374 696f 6e20 636f 6d6d 656e 7465 6420  ction commented 
-00011030: 6f75 7420 6265 6361 7573 6520 6974 2063  out because it c
-00011040: 616c 6c73 206d 616b 655f 7472 6163 6564  alls make_traced
-00011050: 2c20 7768 6963 6820 646f 6573 206e 6f74  , which does not
-00011060: 2065 7869 7374 0a23 2064 6566 2076 6d61   exist.# def vma
-00011070: 705f 6561 6765 7228 6675 6e63 2c20 6172  p_eager(func, ar
-00011080: 6773 2c20 696e 5f64 696d 733d 302c 206f  gs, in_dims=0, o
-00011090: 7574 5f64 696d 733d 302c 2061 7869 735f  ut_dims=0, axis_
-000110a0: 7369 7a65 3d4e 6f6e 652c 2065 7865 6375  size=None, execu
-000110b0: 746f 723d 2274 6f72 6368 2229 3a0a 2320  tor="torch"):.# 
-000110c0: 2020 2020 2222 2243 6f6d 7075 7465 7320      """Computes 
-000110d0: 7468 6520 766d 6170 206f 6620 6120 5468  the vmap of a Th
-000110e0: 756e 6465 7220 6675 6e63 7469 6f6e 2e0a  under function..
-000110f0: 0a23 2020 2020 2041 7267 733a 0a23 2020  .#     Args:.#  
-00011100: 2020 2020 2020 2066 756e 6320 2843 616c         func (Cal
-00011110: 6c61 626c 6529 3a20 4120 5468 756e 6465  lable): A Thunde
-00011120: 7220 6675 6e63 7469 6f6e 2074 6f20 6265  r function to be
-00011130: 2074 7261 6e73 666f 726d 6564 2e0a 2320   transformed..# 
-00011140: 2020 2020 2020 2020 6172 6773 2028 5f74          args (_t
-00011150: 7970 655f 293a 2041 7267 7320 6f66 2074  ype_): Args of t
-00011160: 6865 2066 756e 6374 696f 6e2e 0a23 2020  he function..#  
-00011170: 2020 2020 2020 2065 7865 6375 746f 7220         executor 
-00011180: 2873 7472 2c20 6f70 7469 6f6e 616c 293a  (str, optional):
-00011190: 2045 7865 6375 746f 7220 746f 2075 7365   Executor to use
-000111a0: 2e20 4465 6661 756c 7473 2074 6f20 2274  . Defaults to "t
-000111b0: 6f72 6368 222e 0a0a 2320 2020 2020 5265  orch"...#     Re
-000111c0: 7475 726e 733a 0a23 2020 2020 2020 2020  turns:.#        
-000111d0: 2054 6865 2072 6573 756c 7420 6f66 2074   The result of t
-000111e0: 6865 2076 6d61 7070 6564 2066 756e 6374  he vmapped funct
-000111f0: 696f 6e2e 0a23 2020 2020 2022 2222 0a23  ion..#     """.#
-00011200: 2020 2020 2023 2054 4f44 4f3a 2066 6978       # TODO: fix
-00011210: 2074 6869 7320 2d20 6e6f 7420 616c 6c20   this - not all 
-00011220: 6172 6773 206d 6179 2062 6520 6261 7463  args may be batc
-00011230: 6865 640a 2320 2020 2020 2320 544f 444f  hed.#     # TODO
-00011240: 3a20 6865 7265 2077 6520 6173 7375 6d65  : here we assume
-00011250: 2062 6174 6368 2061 7869 7320 6973 2030   batch axis is 0
-00011260: 0a23 2020 2020 2076 6d61 705f 7472 6163  .#     vmap_trac
-00011270: 6520 3d20 6d61 6b65 5f74 7261 6365 280a  e = make_trace(.
-00011280: 2320 2020 2020 2020 2020 766d 6170 2866  #         vmap(f
-00011290: 756e 632c 2069 6e5f 6469 6d73 3d69 6e5f  unc, in_dims=in_
-000112a0: 6469 6d73 2c20 6f75 745f 6469 6d73 3d6f  dims, out_dims=o
-000112b0: 7574 5f64 696d 732c 2061 7869 735f 7369  ut_dims, axis_si
-000112c0: 7a65 3d61 7869 735f 7369 7a65 292c 2065  ze=axis_size), e
-000112d0: 7865 6375 746f 723d 6578 6563 7574 6f72  xecutor=executor
-000112e0: 2c0a 2320 2020 2020 2020 2020 2a61 7267  ,.#         *arg
-000112f0: 7329 0a23 2020 2020 2076 6d61 705f 7472  s).#     vmap_tr
-00011300: 6163 6564 203d 206d 616b 655f 7472 6163  aced = make_trac
-00011310: 6564 2870 6172 7469 616c 2865 7661 6c5f  ed(partial(eval_
-00011320: 7472 6163 652c 2076 6d61 705f 7472 6163  trace, vmap_trac
-00011330: 6529 2c20 6578 6563 7574 6f72 3d65 7865  e), executor=exe
-00011340: 6375 746f 7229 0a23 2020 2020 2072 6574  cutor).#     ret
-00011350: 7572 6e20 766d 6170 5f74 7261 6365 6428  urn vmap_traced(
-00011360: 2a61 7267 7329 0a0a 0a23 204a 5650 2074  *args)...# JVP t
-00011370: 7261 6e73 666f 726d 0a23 202d 2d2d 2d2d  ransform.# -----
-00011380: 2d2d 2d2d 2d2d 2d2d 0a0a 0a40 6461 7461  --------...@data
-00011390: 636c 6173 7328 6672 6f7a 656e 3d54 7275  class(frozen=Tru
-000113a0: 6529 0a63 6c61 7373 204a 5650 4475 616c  e).class JVPDual
-000113b0: 3a0a 2020 2020 2222 2244 7561 6c20 6e75  :.    """Dual nu
-000113c0: 6d62 6572 2066 6f72 2074 6865 204a 5650  mber for the JVP
-000113d0: 2074 7261 6e73 666f 726d 2e0a 0a20 2020   transform...   
-000113e0: 2041 7474 7269 6275 7465 733a 0a20 2020   Attributes:.   
-000113f0: 2020 2020 2070 7269 6d61 6c3a 2050 7269       primal: Pri
-00011400: 6d61 6c20 7661 6c75 652e 0a20 2020 2020  mal value..     
-00011410: 2020 2074 616e 6765 6e74 3a20 5461 6e67     tangent: Tang
-00011420: 656e 7420 7661 6c75 652e 0a20 2020 2022  ent value..    "
-00011430: 2222 0a0a 2020 2020 7072 696d 616c 3a20  ""..    primal: 
-00011440: 416e 790a 2020 2020 7461 6e67 656e 743a  Any.    tangent:
-00011450: 2041 6e79 0a0a 2020 2020 6465 6620 5f5f   Any..    def __
-00011460: 6974 6572 5f5f 2873 656c 6629 3a0a 2020  iter__(self):.  
-00011470: 2020 2020 2020 7969 656c 6420 7365 6c66        yield self
-00011480: 2e70 7269 6d61 6c0a 2020 2020 2020 2020  .primal.        
-00011490: 7969 656c 6420 7365 6c66 2e74 616e 6765  yield self.tange
-000114a0: 6e74 0a0a 0a64 6566 2070 6169 725f 746f  nt...def pair_to
-000114b0: 5f6a 7670 5f64 7561 6c28 7061 6972 293a  _jvp_dual(pair):
-000114c0: 0a20 2020 2022 2222 436f 6e76 6572 7473  .    """Converts
-000114d0: 2061 2070 6169 7220 746f 2061 204a 5650   a pair to a JVP
-000114e0: 4475 616c 2e0a 0a20 2020 2041 7267 733a  Dual...    Args:
-000114f0: 0a20 2020 2020 2020 2070 6169 7220 2853  .        pair (S
-00011500: 6571 7565 6e63 6529 3a20 5061 6972 2074  equence): Pair t
-00011510: 6f20 636f 6e76 6572 742e 0a0a 2020 2020  o convert...    
-00011520: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00011530: 204a 5650 4475 616c 3a20 4a56 5044 7561   JVPDual: JVPDua
-00011540: 6c20 7265 7072 6573 656e 7461 7469 6f6e  l representation
-00011550: 206f 6620 7468 6520 7061 6972 2e0a 2020   of the pair..  
-00011560: 2020 2222 220a 2020 2020 6966 2069 7369    """.    if isi
-00011570: 6e73 7461 6e63 6528 7061 6972 2c20 4a56  nstance(pair, JV
-00011580: 5044 7561 6c29 3a0a 2020 2020 2020 2020  PDual):.        
-00011590: 7265 7475 726e 2070 6169 720a 2020 2020  return pair.    
-000115a0: 656c 7365 3a0a 2020 2020 2020 2020 6173  else:.        as
-000115b0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-000115c0: 7061 6972 2c20 5365 7175 656e 6365 2920  pair, Sequence) 
-000115d0: 616e 6420 6c65 6e28 7061 6972 2920 3d3d  and len(pair) ==
-000115e0: 2032 0a20 2020 2020 2020 2072 6574 7572   2.        retur
-000115f0: 6e20 4a56 5044 7561 6c28 2a70 6169 7229  n JVPDual(*pair)
-00011600: 0a0a 0a64 6566 2073 696e 5f6a 7670 2861  ...def sin_jvp(a
-00011610: 3a20 4a56 5044 7561 6c29 3a0a 2020 2020  : JVPDual):.    
-00011620: 782c 2078 6420 3d20 610a 2020 2020 7265  x, xd = a.    re
-00011630: 7475 726e 204a 5650 4475 616c 2870 7269  turn JVPDual(pri
-00011640: 6d73 2e73 696e 2878 292c 2070 7269 6d73  ms.sin(x), prims
-00011650: 2e63 6f73 2878 2920 2a20 7864 290a 0a0a  .cos(x) * xd)...
-00011660: 6465 6620 6d75 6c5f 6a76 7028 613a 204a  def mul_jvp(a: J
-00011670: 5650 4475 616c 2c20 623a 204a 5650 4475  VPDual, b: JVPDu
-00011680: 616c 293a 0a20 2020 2078 2c20 7864 203d  al):.    x, xd =
-00011690: 2061 0a20 2020 2079 2c20 7964 203d 2062   a.    y, yd = b
-000116a0: 0a20 2020 2072 6574 7572 6e20 4a56 5044  .    return JVPD
-000116b0: 7561 6c28 7820 2a20 792c 2078 202a 2079  ual(x * y, x * y
-000116c0: 6420 2b20 7920 2a20 7864 290a 0a0a 6465  d + y * xd)...de
-000116d0: 6620 6164 645f 6a76 7028 613a 204a 5650  f add_jvp(a: JVP
-000116e0: 4475 616c 2c20 623a 204a 5650 4475 616c  Dual, b: JVPDual
-000116f0: 293a 0a20 2020 2078 2c20 7864 203d 2061  ):.    x, xd = a
-00011700: 0a20 2020 2079 2c20 7964 203d 2062 0a20  .    y, yd = b. 
-00011710: 2020 2072 6574 7572 6e20 4a56 5044 7561     return JVPDua
-00011720: 6c28 7820 2b20 792c 2078 6420 2b20 7964  l(x + y, xd + yd
-00011730: 290a 0a0a 6465 6620 6272 6f61 6463 6173  )...def broadcas
-00011740: 745f 696e 5f64 696d 5f6a 7670 2861 3a20  t_in_dim_jvp(a: 
-00011750: 4a56 5044 7561 6c2c 2073 6861 7065 3a20  JVPDual, shape: 
-00011760: 7475 706c 655b 4a56 5044 7561 6c2c 202e  tuple[JVPDual, .
-00011770: 2e2e 5d2c 2062 726f 6164 6361 7374 5f64  ..], broadcast_d
-00011780: 696d 656e 7369 6f6e 733a 2074 7570 6c65  imensions: tuple
-00011790: 5b4a 5650 4475 616c 2c20 2e2e 2e5d 2920  [JVPDual, ...]) 
-000117a0: 2d3e 204a 5650 4475 616c 3a0a 2020 2020  -> JVPDual:.    
-000117b0: 782c 2078 6420 3d20 610a 2020 2020 2320  x, xd = a.    # 
-000117c0: 544f 444f 3a20 7368 6170 6520 616e 6420  TODO: shape and 
-000117d0: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-000117e0: 696f 6e73 2073 686f 756c 6420 6265 2074  ions should be t
-000117f0: 7570 6c65 7320 6f66 2069 6e74 730a 2020  uples of ints.  
-00011800: 2020 2320 6275 7420 666f 7220 6e6f 7720    # but for now 
-00011810: 6974 2773 2061 2074 7570 6c65 206f 6620  it's a tuple of 
-00011820: 4a56 5044 7561 6c73 0a20 2020 2069 6620  JVPDuals.    if 
-00011830: 6c65 6e28 7368 6170 6529 203e 2030 2061  len(shape) > 0 a
-00011840: 6e64 2069 7369 6e73 7461 6e63 6528 7368  nd isinstance(sh
-00011850: 6170 655b 305d 2c20 4a56 5044 7561 6c29  ape[0], JVPDual)
-00011860: 3a0a 2020 2020 2020 2020 7368 6170 652c  :.        shape,
-00011870: 205f 203d 2073 6166 655f 7a69 7028 2a73   _ = safe_zip(*s
-00011880: 6861 7065 290a 2020 2020 6966 206c 656e  hape).    if len
-00011890: 2862 726f 6164 6361 7374 5f64 696d 656e  (broadcast_dimen
-000118a0: 7369 6f6e 7329 203e 2030 2061 6e64 2069  sions) > 0 and i
-000118b0: 7369 6e73 7461 6e63 6528 6272 6f61 6463  sinstance(broadc
-000118c0: 6173 745f 6469 6d65 6e73 696f 6e73 5b30  ast_dimensions[0
-000118d0: 5d2c 204a 5650 4475 616c 293a 0a20 2020  ], JVPDual):.   
-000118e0: 2020 2020 2062 726f 6164 6361 7374 5f64       broadcast_d
-000118f0: 696d 656e 7369 6f6e 732c 205f 203d 2073  imensions, _ = s
-00011900: 6166 655f 7a69 7028 2a62 726f 6164 6361  afe_zip(*broadca
-00011910: 7374 5f64 696d 656e 7369 6f6e 7329 0a20  st_dimensions). 
-00011920: 2020 2072 6574 7572 6e20 4a56 5044 7561     return JVPDua
-00011930: 6c28 0a20 2020 2020 2020 2070 7269 6d73  l(.        prims
-00011940: 2e62 726f 6164 6361 7374 5f69 6e5f 6469  .broadcast_in_di
-00011950: 6d28 782c 2073 6861 7065 2c20 6272 6f61  m(x, shape, broa
-00011960: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
-00011970: 292c 2070 7269 6d73 2e62 726f 6164 6361  ), prims.broadca
-00011980: 7374 5f69 6e5f 6469 6d28 7864 2c20 7368  st_in_dim(xd, sh
-00011990: 6170 652c 2062 726f 6164 6361 7374 5f64  ape, broadcast_d
-000119a0: 696d 656e 7369 6f6e 7329 0a20 2020 2029  imensions).    )
-000119b0: 0a0a 0a64 6566 2075 6e70 6163 6b5f 7365  ...def unpack_se
-000119c0: 7175 656e 6365 5f6a 7670 2873 6571 7565  quence_jvp(seque
-000119d0: 6e63 653a 204a 5650 4475 616c 2c20 6c65  nce: JVPDual, le
-000119e0: 6e67 7468 3a20 4a56 5044 7561 6c29 202d  ngth: JVPDual) -
-000119f0: 3e20 4a56 5044 7561 6c3a 0a20 2020 2078  > JVPDual:.    x
-00011a00: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
-00011a10: 6461 2078 3a20 782e 7072 696d 616c 2c20  da x: x.primal, 
-00011a20: 7365 7175 656e 6365 290a 2020 2020 7864  sequence).    xd
-00011a30: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
-00011a40: 6461 2078 3a20 782e 7461 6e67 656e 742c  da x: x.tangent,
-00011a50: 2073 6571 7565 6e63 6529 0a20 2020 206c   sequence).    l
-00011a60: 656e 6774 682c 205f 203d 206c 656e 6774  ength, _ = lengt
-00011a70: 680a 2020 2020 7072 696d 616c 7320 3d20  h.    primals = 
-00011a80: 7072 696d 732e 756e 7061 636b 5f73 6571  prims.unpack_seq
-00011a90: 7565 6e63 6528 782c 206c 656e 6774 6829  uence(x, length)
-00011aa0: 0a20 2020 2074 616e 6765 6e74 7320 3d20  .    tangents = 
-00011ab0: 7072 696d 732e 756e 7061 636b 5f73 6571  prims.unpack_seq
-00011ac0: 7565 6e63 6528 7864 2c20 6c65 6e67 7468  uence(xd, length
-00011ad0: 290a 2020 2020 7265 7475 726e 2073 6166  ).    return saf
-00011ae0: 655f 6d61 7028 7061 6972 5f74 6f5f 6a76  e_map(pair_to_jv
-00011af0: 705f 6475 616c 2c20 7361 6665 5f7a 6970  p_dual, safe_zip
-00011b00: 2870 7269 6d61 6c73 2c20 7461 6e67 656e  (primals, tangen
-00011b10: 7473 2929 0a0a 0a64 6566 2075 6e70 6163  ts))...def unpac
-00011b20: 6b5f 7472 6976 6961 6c5f 6a76 7028 783a  k_trivial_jvp(x:
-00011b30: 204a 5650 4475 616c 2920 2d3e 204a 5650   JVPDual) -> JVP
-00011b40: 4475 616c 3a0a 2020 2020 7265 7475 726e  Dual:.    return
-00011b50: 2078 0a0a 0a6a 7670 5f69 6d70 6c73 3a20   x...jvp_impls: 
-00011b60: 6469 6374 5b70 7269 6d73 2e53 796d 626f  dict[prims.Symbo
-00011b70: 6c2c 2043 616c 6c61 626c 655d 203d 2064  l, Callable] = d
-00011b80: 6963 7428 290a 0a6a 7670 5f69 6d70 6c73  ict()..jvp_impls
-00011b90: 5b70 7269 6d73 2e50 7269 6d49 4473 2e53  [prims.PrimIDs.S
-00011ba0: 494e 5d20 3d20 7369 6e5f 6a76 700a 6a76  IN] = sin_jvp.jv
-00011bb0: 705f 696d 706c 735b 7072 696d 732e 5072  p_impls[prims.Pr
-00011bc0: 696d 4944 732e 4d55 4c5d 203d 206d 756c  imIDs.MUL] = mul
-00011bd0: 5f6a 7670 0a6a 7670 5f69 6d70 6c73 5b70  _jvp.jvp_impls[p
-00011be0: 7269 6d73 2e50 7269 6d49 4473 2e41 4444  rims.PrimIDs.ADD
-00011bf0: 5d20 3d20 6164 645f 6a76 700a 6a76 705f  ] = add_jvp.jvp_
-00011c00: 696d 706c 735b 7072 696d 732e 5072 696d  impls[prims.Prim
-00011c10: 4944 732e 4252 4f41 4443 4153 545f 494e  IDs.BROADCAST_IN
-00011c20: 5f44 494d 5d20 3d20 6272 6f61 6463 6173  _DIM] = broadcas
-00011c30: 745f 696e 5f64 696d 5f6a 7670 0a23 206a  t_in_dim_jvp.# j
-00011c40: 7670 5f69 6d70 6c73 5b70 7269 6d73 2e50  vp_impls[prims.P
-00011c50: 7269 6d49 4473 2e55 4e50 4143 4b5f 5345  rimIDs.UNPACK_SE
-00011c60: 5155 454e 4345 5d20 3d20 756e 7061 636b  QUENCE] = unpack
-00011c70: 5f73 6571 7565 6e63 655f 6a76 700a 2320  _sequence_jvp.# 
-00011c80: 6a76 705f 696d 706c 735b 7072 696d 732e  jvp_impls[prims.
-00011c90: 5072 696d 4944 732e 554e 5041 434b 5f54  PrimIDs.UNPACK_T
-00011ca0: 5249 5649 414c 5d20 3d20 756e 7061 636b  RIVIAL] = unpack
-00011cb0: 5f74 7269 7669 616c 5f6a 7670 0a0a 0a64  _trivial_jvp...d
-00011cc0: 6566 206a 7670 5f73 796d 626f 6c5f 6d61  ef jvp_symbol_ma
-00011cd0: 7070 6572 2873 796d 626f 6c3a 2070 7269  pper(symbol: pri
-00011ce0: 6d73 2e53 796d 626f 6c29 3a0a 2020 2020  ms.Symbol):.    
-00011cf0: 2222 224d 6170 7320 6120 7379 6d62 6f6c  """Maps a symbol
-00011d00: 2074 6f20 6120 4a56 5020 6675 6e63 7469   to a JVP functi
-00011d10: 6f6e 2074 6861 7420 6576 616c 7561 7465  on that evaluate
-00011d20: 7320 6974 2e0a 0a20 2020 2041 7267 733a  s it...    Args:
-00011d30: 0a20 2020 2020 2020 2073 796d 626f 6c20  .        symbol 
-00011d40: 2870 7269 6d73 2e53 796d 626f 6c29 3a20  (prims.Symbol): 
-00011d50: 5379 6d62 6f6c 2074 6f20 6576 616c 7561  Symbol to evalua
-00011d60: 7465 2e0a 0a20 2020 2052 6169 7365 733a  te...    Raises:
-00011d70: 0a20 2020 2020 2020 204e 6f74 496d 706c  .        NotImpl
-00011d80: 656d 656e 7465 6445 7272 6f72 3a20 4966  ementedError: If
-00011d90: 2074 6865 204a 5650 2066 6f72 2074 6865   the JVP for the
-00011da0: 2073 796d 626f 6c20 6973 206e 6f74 2069   symbol is not i
-00011db0: 6d70 6c65 6d65 6e74 6564 2e0a 0a20 2020  mplemented...   
-00011dc0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00011dd0: 2020 4361 6c6c 6162 6c65 3a20 4a56 5020    Callable: JVP 
-00011de0: 6675 6e63 7469 6f6e 2074 6861 7420 6576  function that ev
-00011df0: 616c 7561 7465 7320 7468 6520 7379 6d62  aluates the symb
-00011e00: 6f6c 2e0a 2020 2020 2222 220a 0a20 2020  ol..    """..   
-00011e10: 2064 6566 2077 7261 705f 6172 6728 7829   def wrap_arg(x)
-00011e20: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-00011e30: 6e73 7461 6e63 6528 782c 204a 5650 4475  nstance(x, JVPDu
-00011e40: 616c 293a 0a20 2020 2020 2020 2020 2020  al):.           
-00011e50: 2072 6574 7572 6e20 780a 2020 2020 2020   return x.      
-00011e60: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-00011e70: 6528 782c 204e 756d 6265 7229 3a0a 2020  e(x, Number):.  
-00011e80: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00011e90: 204a 5650 4475 616c 2878 2c20 7479 7065   JVPDual(x, type
-00011ea0: 2878 2928 3029 290a 2020 2020 2020 2020  (x)(0)).        
-00011eb0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00011ec0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00011ed0: 6f72 2866 224a 5650 2077 7261 705f 6172  or(f"JVP wrap_ar
-00011ee0: 6720 676f 7420 616e 2075 6e73 7570 706f  g got an unsuppo
-00011ef0: 7274 6564 2074 7970 6520 7b74 7970 6528  rted type {type(
-00011f00: 7829 7d22 290a 0a20 2020 2023 2049 6620  x)}")..    # If 
-00011f10: 7379 6d62 6f6c 2e61 7267 7320 646f 6573  symbol.args does
-00011f20: 6e27 7420 6861 7665 2073 7562 636c 6173  n't have subclas
-00011f30: 7365 7320 6f66 2056 6172 6961 626c 652c  ses of Variable,
-00011f40: 2074 6865 6e20 7765 206e 6565 6420 746f   then we need to
-00011f50: 2072 6574 7572 6e20 6120 7a65 726f 2074   return a zero t
-00011f60: 616e 6765 6e74 0a20 2020 2023 2054 4f44  angent.    # TOD
-00011f70: 4f3a 2074 6865 7265 206d 6179 2062 6520  O: there may be 
-00011f80: 6120 6265 7474 6572 2077 6179 2074 6f20  a better way to 
-00011f90: 6465 7465 6374 2063 6f6e 7374 616e 7473  detect constants
-00011fa0: 2069 6e20 7468 6520 7472 6163 650a 2020   in the trace.  
-00011fb0: 2020 6966 2073 796d 626f 6c2e 6172 655f    if symbol.are_
-00011fc0: 616c 6c5f 6172 6773 5f63 6f6e 7374 616e  all_args_constan
-00011fd0: 743a 0a0a 2020 2020 2020 2020 6465 6620  t:..        def 
-00011fe0: 7a65 726f 735f 6c69 6b65 2878 293a 0a20  zeros_like(x):. 
-00011ff0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-00012000: 696e 7374 616e 6365 2878 2c20 5465 6e73  instance(x, Tens
-00012010: 6f72 5072 6f78 7929 3a0a 2020 2020 2020  orProxy):.      
-00012020: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00012030: 2066 756c 6c5f 6c69 6b65 2878 2c20 6669   full_like(x, fi
-00012040: 6c6c 5f76 616c 7565 3d30 290a 2020 2020  ll_value=0).    
-00012050: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-00012060: 6e73 7461 6e63 6528 782c 204e 756d 6265  nstance(x, Numbe
-00012070: 7250 726f 7879 293a 0a20 2020 2020 2020  rProxy):.       
-00012080: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00012090: 7479 7065 2878 2e76 616c 7565 2928 3029  type(x.value)(0)
-000120a0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-000120b0: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-000120c0: 4e75 6d62 6572 293a 0a20 2020 2020 2020  Number):.       
-000120d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000120e0: 7479 7065 2878 2928 3029 0a20 2020 2020  type(x)(0).     
-000120f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00012100: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00012110: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
-00012120: 7a65 726f 735f 6c69 6b65 2069 6e73 6964  zeros_like insid
-00012130: 6520 4a56 5020 676f 7420 616e 2075 6e73  e JVP got an uns
-00012140: 7570 706f 7274 6564 2074 7970 6520 7b74  upported type {t
-00012150: 7970 6528 7829 7d22 290a 0a20 2020 2020  ype(x)}")..     
-00012160: 2020 2064 6566 206a 7670 5f69 6d70 6c5f     def jvp_impl_
-00012170: 636f 6e73 7428 7379 6d62 6f6c 2c20 2a61  const(symbol, *a
-00012180: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
-00012190: 2020 2020 2020 2020 2020 2020 7072 696d              prim
-000121a0: 616c 7320 3d20 7379 6d62 6f6c 5f74 6f5f  als = symbol_to_
-000121b0: 6576 616c 2873 796d 626f 6c29 282a 6172  eval(symbol)(*ar
-000121c0: 6773 2c20 2a2a 6b77 6172 6773 290a 2020  gs, **kwargs).  
-000121d0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-000121e0: 6e73 7461 6e63 6528 7072 696d 616c 732c  nstance(primals,
-000121f0: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
-00012200: 2020 2020 2020 2020 2020 2020 7461 6e67              tang
-00012210: 656e 7473 203d 2074 7570 6c65 287a 6572  ents = tuple(zer
-00012220: 6f73 5f6c 696b 6528 7029 2066 6f72 2070  os_like(p) for p
-00012230: 2069 6e20 7072 696d 616c 7329 0a20 2020   in primals).   
-00012240: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00012250: 7572 6e20 7361 6665 5f6d 6170 2870 6169  urn safe_map(pai
-00012260: 725f 746f 5f6a 7670 5f64 7561 6c2c 2073  r_to_jvp_dual, s
-00012270: 6166 655f 7a69 7028 7072 696d 616c 732c  afe_zip(primals,
-00012280: 2074 616e 6765 6e74 7329 290a 2020 2020   tangents)).    
-00012290: 2020 2020 2020 2020 7265 7475 726e 204a          return J
-000122a0: 5650 4475 616c 2870 7269 6d61 6c73 2c20  VPDual(primals, 
-000122b0: 7a65 726f 735f 6c69 6b65 2870 7269 6d61  zeros_like(prima
-000122c0: 6c73 2929 0a0a 2020 2020 2020 2020 7265  ls))..        re
-000122d0: 7475 726e 2070 6172 7469 616c 286a 7670  turn partial(jvp
-000122e0: 5f69 6d70 6c5f 636f 6e73 742c 2073 796d  _impl_const, sym
-000122f0: 626f 6c29 0a0a 2020 2020 2320 4e6f 726d  bol)..    # Norm
-00012300: 616c 2063 6173 652c 2077 6520 6861 7665  al case, we have
-00012310: 2061 2070 726f 7879 2074 616e 6765 6e74   a proxy tangent
-00012320: 0a20 2020 206a 7670 5f69 6d70 6c20 3d20  .    jvp_impl = 
-00012330: 6a76 705f 696d 706c 732e 6765 7428 7379  jvp_impls.get(sy
-00012340: 6d62 6f6c 2e73 796d 2e69 6429 0a20 2020  mbol.sym.id).   
-00012350: 2069 6620 6a76 705f 696d 706c 2069 7320   if jvp_impl is 
-00012360: 4e6f 6e65 3a0a 2020 2020 2020 2020 7261  None:.        ra
-00012370: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
-00012380: 6564 4572 726f 7228 6622 4a56 5020 666f  edError(f"JVP fo
-00012390: 7220 7b73 796d 626f 6c2e 7379 6d2e 6964  r {symbol.sym.id
-000123a0: 7d20 6973 206e 6f74 2069 6d70 6c65 6d65  } is not impleme
-000123b0: 6e74 6564 2229 0a0a 2020 2020 6465 6620  nted")..    def 
-000123c0: 5f6a 7670 5f69 6d70 6c28 2a61 7267 732c  _jvp_impl(*args,
-000123d0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-000123e0: 2020 2020 6172 6773 203d 2074 7265 655f      args = tree_
-000123f0: 6d61 7028 7772 6170 5f61 7267 2c20 6172  map(wrap_arg, ar
-00012400: 6773 290a 2020 2020 2020 2020 2320 4578  gs).        # Ex
-00012410: 7065 6374 696e 6720 4a56 5044 7561 6c73  pecting JVPDuals
-00012420: 2077 7261 7070 696e 6720 7061 6972 7320   wrapping pairs 
-00012430: 6f66 2070 7269 6d61 6c73 2061 6e64 2074  of primals and t
-00012440: 616e 6765 6e74 730a 2020 2020 2020 2020  angents.        
-00012450: 6173 7365 7274 2061 6c6c 2869 7369 6e73  assert all(isins
-00012460: 7461 6e63 6528 6172 672c 204a 5650 4475  tance(arg, JVPDu
-00012470: 616c 2920 666f 7220 6172 6720 696e 2074  al) for arg in t
-00012480: 7265 655f 666c 6174 7465 6e28 6172 6773  ree_flatten(args
-00012490: 295b 305d 290a 2020 2020 2020 2020 7265  )[0]).        re
-000124a0: 7475 726e 206a 7670 5f69 6d70 6c28 2a61  turn jvp_impl(*a
-000124b0: 7267 732c 202a 2a6b 7761 7267 7329 0a0a  rgs, **kwargs)..
-000124c0: 2020 2020 7265 7475 726e 205f 6a76 705f      return _jvp_
-000124d0: 696d 706c 0a0a 0a64 6566 205f 6a76 705f  impl...def _jvp_
-000124e0: 6361 6c6c 5f6d 6574 6166 756e 6328 6465  call_metafunc(de
-000124f0: 7461 6368 6564 3a20 626f 6f6c 2c20 7072  tached: bool, pr
-00012500: 696d 616c 732c 2074 616e 6765 6e74 732c  imals, tangents,
-00012510: 202a 2c20 6675 6e63 7469 6f6e 5f74 7261   *, function_tra
-00012520: 6365 3a20 5472 6163 652c 202a 2a6b 7761  ce: Trace, **kwa
-00012530: 7267 7329 3a0a 2020 2020 2222 224d 6574  rgs):.    """Met
-00012540: 6166 756e 6374 696f 6e20 666f 7220 7468  afunction for th
-00012550: 6520 4a56 5020 7472 616e 7366 6f72 6d2e  e JVP transform.
-00012560: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00012570: 2020 2020 6465 7461 6368 6564 2028 626f      detached (bo
-00012580: 6f6c 293a 2057 6865 7468 6572 2074 6f20  ol): Whether to 
-00012590: 6465 7461 6368 2074 6865 2074 7261 6365  detach the trace
-000125a0: 2e0a 2020 2020 2020 2020 7072 696d 616c  ..        primal
-000125b0: 7320 2854 7570 6c65 5b50 726f 7879 5d29  s (Tuple[Proxy])
-000125c0: 3a20 5072 696d 616c 2076 616c 7565 732e  : Primal values.
-000125d0: 0a20 2020 2020 2020 2074 616e 6765 6e74  .        tangent
-000125e0: 7320 2854 7570 6c65 5b50 726f 7879 5d29  s (Tuple[Proxy])
-000125f0: 3a20 5461 6e67 656e 7420 7661 6c75 6573  : Tangent values
-00012600: 2e0a 2020 2020 2020 2020 6675 6e63 7469  ..        functi
-00012610: 6f6e 5f74 7261 6365 2028 5472 6163 6529  on_trace (Trace)
-00012620: 3a20 5472 6163 6520 6f66 2074 6865 2066  : Trace of the f
-00012630: 756e 6374 696f 6e20 746f 2062 6520 7472  unction to be tr
-00012640: 616e 7366 6f72 6d65 642e 0a20 2020 2020  ansformed..     
-00012650: 2020 206b 7761 7267 733a 204b 6579 776f     kwargs: Keywo
-00012660: 7264 2061 7267 756d 656e 7473 2e0a 0a20  rd arguments... 
-00012670: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
-00012680: 2020 2041 7373 6572 7469 6f6e 4572 726f     AssertionErro
-00012690: 723a 2049 6620 7468 6520 4a56 5020 666f  r: If the JVP fo
-000126a0: 7220 6b65 7977 6f72 6420 6172 6775 6d65  r keyword argume
-000126b0: 6e74 7320 6973 206e 6f74 2069 6d70 6c65  nts is not imple
-000126c0: 6d65 6e74 6564 2e0a 0a20 2020 2052 6574  mented...    Ret
-000126d0: 7572 6e73 3a0a 2020 2020 2020 2020 5265  urns:.        Re
-000126e0: 7375 6c74 206f 6620 7468 6520 4a56 5020  sult of the JVP 
-000126f0: 7472 616e 7366 6f72 6d2e 0a20 2020 2022  transform..    "
-00012700: 2222 0a20 2020 2061 7373 6572 7420 6c65  "".    assert le
-00012710: 6e28 6b77 6172 6773 2920 3d3d 2030 2c20  n(kwargs) == 0, 
-00012720: 224a 5650 2066 6f72 206b 7761 7267 7320  "JVP for kwargs 
-00012730: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
-00012740: 6564 220a 0a20 2020 2063 7478 203d 2064  ed"..    ctx = d
-00012750: 6574 6163 6865 645f 7472 6163 6528 2920  etached_trace() 
-00012760: 6966 2064 6574 6163 6865 6420 656c 7365  if detached else
-00012770: 206e 756c 6c63 6f6e 7465 7874 2829 0a20   nullcontext(). 
-00012780: 2020 2077 6974 6820 6374 783a 0a20 2020     with ctx:.   
-00012790: 2020 2020 2023 2057 7261 7070 696e 6720       # Wrapping 
-000127a0: 7468 6520 7072 696d 616c 7320 616e 6420  the primals and 
-000127b0: 7461 6e67 656e 7473 2069 6e20 4a56 5044  tangents in JVPD
-000127c0: 7561 6c73 2069 7320 6e6f 7420 7374 7269  uals is not stri
-000127d0: 6374 6c79 206e 6563 6573 7361 7279 2c20  ctly necessary, 
-000127e0: 6275 7420 6974 206d 616b 6573 0a20 2020  but it makes.   
-000127f0: 2020 2020 2023 2074 6865 2063 6f64 6520       # the code 
-00012800: 6d6f 7265 2072 6561 6461 626c 650a 2020  more readable.  
-00012810: 2020 2020 2020 2320 5765 2070 726f 7061        # We propa
-00012820: 6761 7465 2074 6865 204a 5650 4475 616c  gate the JVPDual
-00012830: 7320 7468 726f 7567 6820 7468 6520 7472  s through the tr
-00012840: 6163 652c 2061 6e64 2074 6865 6e20 756e  ace, and then un
-00012850: 7772 6170 2074 6865 6d20 6174 2074 6865  wrap them at the
-00012860: 2065 6e64 0a20 2020 2020 2020 2070 7269   end.        pri
-00012870: 6d61 6c73 5f74 616e 6765 6e74 735f 6475  mals_tangents_du
-00012880: 616c 7320 3d20 7361 6665 5f6d 6170 2870  als = safe_map(p
-00012890: 6169 725f 746f 5f6a 7670 5f64 7561 6c2c  air_to_jvp_dual,
-000128a0: 2073 6166 655f 7a69 7028 7072 696d 616c   safe_zip(primal
-000128b0: 732c 2074 616e 6765 6e74 7329 290a 2020  s, tangents)).  
-000128c0: 2020 2020 2020 7265 7375 6c74 203d 2065        result = e
-000128d0: 7661 6c5f 7472 6163 6528 6675 6e63 7469  val_trace(functi
-000128e0: 6f6e 5f74 7261 6365 2c20 2a70 7269 6d61  on_trace, *prima
-000128f0: 6c73 5f74 616e 6765 6e74 735f 6475 616c  ls_tangents_dual
-00012900: 732c 2073 796d 626f 6c5f 6d61 7070 6572  s, symbol_mapper
-00012910: 3d6a 7670 5f73 796d 626f 6c5f 6d61 7070  =jvp_symbol_mapp
-00012920: 6572 290a 2020 2020 2020 2020 2320 556e  er).        # Un
-00012930: 7772 6170 7069 6e67 2074 6865 204a 5650  wrapping the JVP
-00012940: 4475 616c 730a 2020 2020 2020 2020 6966  Duals.        if
-00012950: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
-00012960: 6c74 2c20 5365 7175 656e 6365 293a 0a20  lt, Sequence):. 
-00012970: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00012980: 7420 616c 6c28 6973 696e 7374 616e 6365  t all(isinstance
-00012990: 2878 2c20 4a56 5044 7561 6c29 2066 6f72  (x, JVPDual) for
-000129a0: 2078 2069 6e20 7265 7375 6c74 290a 2020   x in result).  
-000129b0: 2020 2020 2020 2020 2020 7072 696d 616c            primal
-000129c0: 732c 2074 616e 6765 6e74 7320 3d20 756e  s, tangents = un
-000129d0: 7a69 7032 2872 6573 756c 7429 0a20 2020  zip2(result).   
-000129e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000129f0: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
-00012a00: 730a 2020 2020 2020 2020 6173 7365 7274  s.        assert
-00012a10: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
-00012a20: 6c74 2c20 4a56 5044 7561 6c29 0a20 2020  lt, JVPDual).   
-00012a30: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
-00012a40: 6c74 2e70 7269 6d61 6c2c 2072 6573 756c  lt.primal, resul
-00012a50: 742e 7461 6e67 656e 740a 0a0a 6a76 705f  t.tangent...jvp_
-00012a60: 6361 6c6c 203d 2053 796d 626f 6c28 6964  call = Symbol(id
-00012a70: 3d54 7261 6e73 666f 726d 732e 4a76 704f  =Transforms.JvpO
-00012a80: 702c 206e 616d 653d 226a 7670 5f63 616c  p, name="jvp_cal
-00012a90: 6c22 2c20 6d65 7461 3d70 6172 7469 616c  l", meta=partial
-00012aa0: 285f 6a76 705f 6361 6c6c 5f6d 6574 6166  (_jvp_call_metaf
-00012ab0: 756e 632c 2046 616c 7365 2929 0a0a 0a64  unc, False))...d
-00012ac0: 6566 205f 6964 656e 7469 7479 5f63 616c  ef _identity_cal
-00012ad0: 6c5f 6a76 7028 2a61 7267 733a 204a 5650  l_jvp(*args: JVP
-00012ae0: 4475 616c 2c20 7472 6163 653a 2054 7261  Dual, trace: Tra
-00012af0: 6365 2c20 2a2a 6b77 6172 6773 293a 0a20  ce, **kwargs):. 
-00012b00: 2020 2070 7269 6d61 6c73 2c20 7461 6e67     primals, tang
-00012b10: 656e 7473 203d 2075 6e7a 6970 3228 6172  ents = unzip2(ar
-00012b20: 6773 290a 2020 2020 6f75 745f 7072 696d  gs).    out_prim
-00012b30: 616c 732c 206f 7574 5f74 616e 6765 6e74  als, out_tangent
-00012b40: 7320 3d20 5f6a 7670 5f63 616c 6c5f 6d65  s = _jvp_call_me
-00012b50: 7461 6675 6e63 2846 616c 7365 2c20 7072  tafunc(False, pr
-00012b60: 696d 616c 732c 2074 616e 6765 6e74 732c  imals, tangents,
-00012b70: 2074 7261 6365 2c20 2a2a 6b77 6172 6773   trace, **kwargs
-00012b80: 290a 2020 2020 6966 2069 7369 6e73 7461  ).    if isinsta
-00012b90: 6e63 6528 6f75 745f 7072 696d 616c 732c  nce(out_primals,
-00012ba0: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
-00012bb0: 2020 2020 7265 7475 726e 2073 6166 655f      return safe_
-00012bc0: 6d61 7028 7061 6972 5f74 6f5f 6a76 705f  map(pair_to_jvp_
-00012bd0: 6475 616c 2c20 7361 6665 5f7a 6970 286f  dual, safe_zip(o
-00012be0: 7574 5f70 7269 6d61 6c73 2c20 6f75 745f  ut_primals, out_
-00012bf0: 7461 6e67 656e 7473 2929 0a20 2020 2072  tangents)).    r
-00012c00: 6574 7572 6e20 4a56 5044 7561 6c28 6f75  eturn JVPDual(ou
-00012c10: 745f 7072 696d 616c 732c 206f 7574 5f74  t_primals, out_t
-00012c20: 616e 6765 6e74 7329 0a0a 0a6a 7670 5f69  angents)...jvp_i
-00012c30: 6d70 6c73 5b54 7261 6e73 666f 726d 732e  mpls[Transforms.
-00012c40: 4964 656e 7469 7479 4f70 5d20 3d20 5f69  IdentityOp] = _i
-00012c50: 6465 6e74 6974 795f 6361 6c6c 5f6a 7670  dentity_call_jvp
-00012c60: 0a0a 0a64 6566 205f 766d 6170 5f63 616c  ...def _vmap_cal
-00012c70: 6c5f 6a76 7028 6172 6773 3a20 4a56 5044  l_jvp(args: JVPD
-00012c80: 7561 6c2c 2069 6e5f 6469 6d73 2c20 6f75  ual, in_dims, ou
-00012c90: 745f 6469 6d73 2c20 6178 6973 5f73 697a  t_dims, axis_siz
-00012ca0: 652c 2074 7261 6365 3a20 5472 6163 652c  e, trace: Trace,
-00012cb0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-00012cc0: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
-00012cd0: 7320 3d20 7361 6665 5f7a 6970 282a 6172  s = safe_zip(*ar
-00012ce0: 6773 290a 2020 2020 696e 5f64 696d 732c  gs).    in_dims,
-00012cf0: 205f 203d 2073 6166 655f 7a69 7028 2a69   _ = safe_zip(*i
-00012d00: 6e5f 6469 6d73 290a 2020 2020 6f75 745f  n_dims).    out_
-00012d10: 6469 6d73 2c20 5f20 3d20 7361 6665 5f7a  dims, _ = safe_z
-00012d20: 6970 282a 6f75 745f 6469 6d73 290a 2020  ip(*out_dims).  
-00012d30: 2020 766d 6170 7065 645f 7472 6163 6520    vmapped_trace 
-00012d40: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
-00012d50: 6528 2928 0a20 2020 2020 2020 2076 6d61  e()(.        vma
-00012d60: 7028 7061 7274 6961 6c28 6576 616c 5f74  p(partial(eval_t
-00012d70: 7261 6365 2c20 7472 6163 6529 2c20 696e  race, trace), in
-00012d80: 5f64 696d 733d 696e 5f64 696d 732c 206f  _dims=in_dims, o
-00012d90: 7574 5f64 696d 733d 6f75 745f 6469 6d73  ut_dims=out_dims
-00012da0: 2c20 6178 6973 5f73 697a 653d 6178 6973  , axis_size=axis
-00012db0: 5f73 697a 6529 2c20 2a70 7269 6d61 6c73  _size), *primals
-00012dc0: 0a20 2020 2029 0a20 2020 2076 6d61 7070  .    ).    vmapp
-00012dd0: 6564 5f66 756e 6320 3d20 7061 7274 6961  ed_func = partia
-00012de0: 6c28 6576 616c 5f74 7261 6365 2c20 766d  l(eval_trace, vm
-00012df0: 6170 7065 645f 7472 6163 6529 0a20 2020  apped_trace).   
-00012e00: 206f 7574 5f70 7269 6d61 6c73 2c20 6f75   out_primals, ou
-00012e10: 745f 7461 6e67 656e 7473 203d 206a 7670  t_tangents = jvp
-00012e20: 2876 6d61 7070 6564 5f66 756e 6329 2870  (vmapped_func)(p
-00012e30: 7269 6d61 6c73 2c20 7461 6e67 656e 7473  rimals, tangents
-00012e40: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-00012e50: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
-00012e60: 745f 7072 696d 616c 732c 2053 6571 7565  t_primals, Seque
-00012e70: 6e63 6529 3a0a 2020 2020 2020 2020 7265  nce):.        re
-00012e80: 7475 726e 2073 6166 655f 6d61 7028 7061  turn safe_map(pa
-00012e90: 6972 5f74 6f5f 6a76 705f 6475 616c 2c20  ir_to_jvp_dual, 
-00012ea0: 7361 6665 5f7a 6970 286f 7574 5f70 7269  safe_zip(out_pri
-00012eb0: 6d61 6c73 2c20 6f75 745f 7461 6e67 656e  mals, out_tangen
-00012ec0: 7473 2929 0a20 2020 2072 6574 7572 6e20  ts)).    return 
-00012ed0: 4a56 5044 7561 6c28 6f75 745f 7072 696d  JVPDual(out_prim
-00012ee0: 616c 732c 206f 7574 5f74 616e 6765 6e74  als, out_tangent
-00012ef0: 7329 0a0a 0a6a 7670 5f69 6d70 6c73 5b54  s)...jvp_impls[T
-00012f00: 7261 6e73 666f 726d 732e 566d 6170 4f70  ransforms.VmapOp
-00012f10: 5d20 3d20 5f76 6d61 705f 6361 6c6c 5f6a  ] = _vmap_call_j
-00012f20: 7670 0a0a 0a64 6566 206a 7670 2866 756e  vp...def jvp(fun
-00012f30: 6329 3a0a 2020 2020 2222 224a 6163 6f62  c):.    """Jacob
-00012f40: 6961 6e2d 7665 6374 6f72 2070 726f 6475  ian-vector produ
-00012f50: 6374 2074 7261 6e73 666f 726d 2066 6f72  ct transform for
-00012f60: 2061 2054 6875 6e64 6572 2066 756e 6374   a Thunder funct
-00012f70: 696f 6e2e 0a0a 2020 2020 4172 6773 3a0a  ion...    Args:.
-00012f80: 2020 2020 2020 2020 6675 6e63 2028 4361          func (Ca
-00012f90: 6c6c 6162 6c65 293a 2041 2054 6875 6e64  llable): A Thund
-00012fa0: 6572 2066 756e 6374 696f 6e20 746f 2062  er function to b
-00012fb0: 6520 7472 616e 7366 6f72 6d65 642e 0a0a  e transformed...
-00012fc0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-00012fd0: 2020 2020 2043 616c 6c61 626c 653a 2041       Callable: A
-00012fe0: 2066 756e 6374 696f 6e20 7468 6174 2063   function that c
-00012ff0: 6f6d 7075 7465 7320 7468 6520 4a61 636f  omputes the Jaco
-00013000: 6269 616e 2d76 6563 746f 7220 7072 6f64  bian-vector prod
-00013010: 7563 740a 2020 2020 2020 2020 2020 2020  uct.            
-00013020: 7461 6b69 6e67 2070 7269 6d61 6c73 2061  taking primals a
-00013030: 6e64 2074 616e 6765 6e74 7320 6173 2061  nd tangents as a
-00013040: 7267 756d 656e 7473 2e0a 2020 2020 2222  rguments..    ""
-00013050: 220a 0a20 2020 2064 6566 2077 7261 7070  "..    def wrapp
-00013060: 6572 2870 7269 6d61 6c73 2c20 7461 6e67  er(primals, tang
-00013070: 656e 7473 293a 0a20 2020 2020 2020 2074  ents):.        t
-00013080: 7261 6365 203d 2063 6f6e 7374 7275 6374  race = construct
-00013090: 5f74 7261 6365 2829 2866 756e 632c 202a  _trace()(func, *
-000130a0: 7072 696d 616c 7329 0a20 2020 2020 2020  primals).       
-000130b0: 2072 6574 7572 6e20 6a76 705f 6361 6c6c   return jvp_call
-000130c0: 2870 7269 6d61 6c73 2c20 7461 6e67 656e  (primals, tangen
-000130d0: 7473 2c20 6675 6e63 7469 6f6e 5f74 7261  ts, function_tra
-000130e0: 6365 3d74 7261 6365 290a 0a20 2020 2072  ce=trace)..    r
-000130f0: 6574 7572 6e20 7772 6170 7065 720a 0a0a  eturn wrapper...
-00013100: 2320 544f 444f 2054 6869 7320 6675 6e63  # TODO This func
-00013110: 7469 6f6e 2063 6f6d 6d65 6e74 6564 206f  tion commented o
-00013120: 7574 2062 6563 6175 7365 2069 7420 6361  ut because it ca
-00013130: 6c6c 7320 6d61 6b65 5f74 7261 6365 642c  lls make_traced,
-00013140: 2077 6869 6368 2064 6f65 7320 6e6f 7420   which does not 
-00013150: 6578 6973 740a 2320 6465 6620 6a76 705f  exist.# def jvp_
-00013160: 6561 6765 7228 6675 6e63 2c20 7072 696d  eager(func, prim
-00013170: 616c 732c 2074 616e 6765 6e74 732c 2065  als, tangents, e
-00013180: 7865 6375 746f 723d 2274 6f72 6368 2229  xecutor="torch")
-00013190: 3a0a 2320 2020 2020 2222 2243 6f6d 7075  :.#     """Compu
-000131a0: 7465 7320 7468 6520 4a61 636f 6269 616e  tes the Jacobian
-000131b0: 2d76 6563 746f 7220 7072 6f64 7563 7420  -vector product 
-000131c0: 6f66 2061 2054 6875 6e64 6572 2066 756e  of a Thunder fun
-000131d0: 6374 696f 6e2e 0a0a 2320 2020 2020 4172  ction...#     Ar
-000131e0: 6773 3a0a 2320 2020 2020 2020 2020 6675  gs:.#         fu
-000131f0: 6e63 2028 4361 6c6c 6162 6c65 293a 2041  nc (Callable): A
-00013200: 2054 6875 6e64 6572 2066 756e 6374 696f   Thunder functio
-00013210: 6e20 746f 2062 6520 7472 616e 7366 6f72  n to be transfor
-00013220: 6d65 642e 0a23 2020 2020 2020 2020 2070  med..#         p
-00013230: 7269 6d61 6c73 2028 5f74 7970 655f 293a  rimals (_type_):
-00013240: 2050 7269 6d61 6c73 206f 6620 7468 6520   Primals of the 
-00013250: 6675 6e63 7469 6f6e 2e0a 2320 2020 2020  function..#     
-00013260: 2020 2020 7461 6e67 656e 7473 2028 5f74      tangents (_t
-00013270: 7970 655f 293a 2054 616e 6765 6e74 7320  ype_): Tangents 
-00013280: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
-00013290: 0a23 2020 2020 2020 2020 2065 7865 6375  .#         execu
-000132a0: 746f 7220 2873 7472 2c20 6f70 7469 6f6e  tor (str, option
-000132b0: 616c 293a 2045 7865 6375 746f 7220 746f  al): Executor to
-000132c0: 2075 7365 2e20 4465 6661 756c 7473 2074   use. Defaults t
-000132d0: 6f20 2274 6f72 6368 222e 0a0a 2320 2020  o "torch"...#   
-000132e0: 2020 5265 7475 726e 733a 0a23 2020 2020    Returns:.#    
-000132f0: 2020 2020 2054 6865 2072 6573 756c 7420       The result 
-00013300: 6f66 2074 6865 204a 6163 6f62 6961 6e2d  of the Jacobian-
-00013310: 7665 6374 6f72 2070 726f 6475 6374 2e0a  vector product..
-00013320: 2320 2020 2020 2222 220a 2320 2020 2020  #     """.#     
-00013330: 7472 6163 6520 3d20 6d61 6b65 5f74 7261  trace = make_tra
-00013340: 6365 2866 756e 632c 2065 7865 6375 746f  ce(func, executo
-00013350: 723d 6578 6563 7574 6f72 2c20 2a70 7269  r=executor, *pri
-00013360: 6d61 6c73 290a 0a23 2020 2020 2064 6566  mals)..#     def
-00013370: 206a 7670 5f66 756e 6328 2a70 7269 6d61   jvp_func(*prima
-00013380: 6c73 5f61 6e64 5f74 616e 6765 6e74 7329  ls_and_tangents)
-00013390: 3a0a 2320 2020 2020 2020 2020 5f70 7269  :.#         _pri
-000133a0: 6d61 6c73 2c20 5f74 616e 6765 6e74 7320  mals, _tangents 
-000133b0: 3d20 7072 696d 616c 735f 616e 645f 7461  = primals_and_ta
-000133c0: 6e67 656e 7473 5b3a 206c 656e 2870 7269  ngents[: len(pri
-000133d0: 6d61 6c73 295d 2c20 7072 696d 616c 735f  mals)], primals_
-000133e0: 616e 645f 7461 6e67 656e 7473 5b6c 656e  and_tangents[len
-000133f0: 2870 7269 6d61 6c73 2920 3a5d 0a23 2020  (primals) :].#  
-00013400: 2020 2020 2020 2072 6574 7572 6e20 5f6a         return _j
-00013410: 7670 5f63 616c 6c5f 6d65 7461 6675 6e63  vp_call_metafunc
-00013420: 285f 7072 696d 616c 732c 205f 7461 6e67  (_primals, _tang
-00013430: 656e 7473 2c20 7472 6163 652c 2064 6574  ents, trace, det
-00013440: 6163 6865 643d 4661 6c73 6529 0a0a 2320  ached=False)..# 
-00013450: 2020 2020 6a76 705f 7472 6163 6520 3d20      jvp_trace = 
-00013460: 6d61 6b65 5f74 7261 6365 286a 7670 5f66  make_trace(jvp_f
-00013470: 756e 632c 2065 7865 6375 746f 723d 6578  unc, executor=ex
-00013480: 6563 7574 6f72 2928 2a70 7269 6d61 6c73  ecutor)(*primals
-00013490: 2c20 2a74 616e 6765 6e74 7329 0a23 2020  , *tangents).#  
-000134a0: 2020 206a 7670 5f74 7261 6365 6420 3d20     jvp_traced = 
-000134b0: 6d61 6b65 5f74 7261 6365 6428 7061 7274  make_traced(part
-000134c0: 6961 6c28 6576 616c 5f74 7261 6365 2c20  ial(eval_trace, 
-000134d0: 6a76 705f 7472 6163 6529 2c20 6578 6563  jvp_trace), exec
-000134e0: 7574 6f72 3d65 7865 6375 746f 7229 0a23  utor=executor).#
-000134f0: 2020 2020 2072 6574 7572 6e20 6a76 705f       return jvp_
-00013500: 7472 6163 6564 282a 7072 696d 616c 732c  traced(*primals,
-00013510: 202a 7461 6e67 656e 7473 290a 0a0a 2320   *tangents)...# 
-00013520: 564a 5020 7472 616e 7366 6f72 6d0a 2320  VJP transform.# 
-00013530: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 4064  =============.@d
-00013540: 6174 6163 6c61 7373 2866 726f 7a65 6e3d  ataclass(frozen=
-00013550: 5472 7565 290a 636c 6173 7320 564a 5044  True).class VJPD
-00013560: 7561 6c3a 0a20 2020 2022 2222 4120 7061  ual:.    """A pa
-00013570: 6972 206f 6620 7072 696d 616c 2061 6e64  ir of primal and
-00013580: 2073 6176 6564 2069 6e66 6f72 6d61 7469   saved informati
-00013590: 6f6e 2066 6f72 2062 6163 6b77 6172 6420  on for backward 
-000135a0: 2872 6573 6964 7561 6c73 292e 0a0a 2020  (residuals)...  
-000135b0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-000135c0: 7072 696d 616c 2028 556e 696f 6e5b 5072  primal (Union[Pr
-000135d0: 6f78 792c 204e 756d 6265 725d 293a 2050  oxy, Number]): P
-000135e0: 7269 6d61 6c20 7661 6c75 652c 2069 2e65  rimal value, i.e
-000135f0: 2e2c 2074 6865 2076 616c 7565 2062 6569  ., the value bei
-00013600: 6e67 2064 6966 6665 7265 6e74 6961 7465  ng differentiate
-00013610: 642e 0a20 2020 2020 2020 2072 6573 6964  d..        resid
-00013620: 7561 6c73 2028 5475 706c 655b 5072 6f78  uals (Tuple[Prox
-00013630: 792c 202e 2e2e 5d29 3a20 5265 7369 6475  y, ...]): Residu
-00013640: 616c 732c 2069 2e65 2e2c 2074 6865 2076  als, i.e., the v
-00013650: 616c 7565 7320 7468 6174 2061 7265 0a20  alues that are. 
-00013660: 2020 2020 2020 2020 2020 2073 6176 6564             saved
-00013670: 2066 6f72 2074 6865 2062 6163 6b77 6172   for the backwar
-00013680: 642e 0a0a 2020 2020 5969 656c 6473 3a0a  d...    Yields:.
-00013690: 2020 2020 2020 2020 5475 706c 655b 5661          Tuple[Va
-000136a0: 7269 6162 6c65 2c20 5475 706c 655b 5661  riable, Tuple[Va
-000136b0: 7269 6162 6c65 2c20 2e2e 2e5d 2c20 4361  riable, ...], Ca
-000136c0: 6c6c 6162 6c65 5d3a 2050 7269 6d61 6c20  llable]: Primal 
-000136d0: 616e 6420 7265 7369 6475 616c 730a 2020  and residuals.  
-000136e0: 2020 2222 220a 0a20 2020 2070 7269 6d61    """..    prima
-000136f0: 6c3a 2050 726f 7879 207c 204e 756d 6265  l: Proxy | Numbe
-00013700: 720a 2020 2020 7265 7369 6475 616c 733a  r.    residuals:
-00013710: 2074 7570 6c65 5b50 726f 7879 2c20 2e2e   tuple[Proxy, ..
-00013720: 2e5d 0a0a 2020 2020 6465 6620 5f5f 6974  .]..    def __it
-00013730: 6572 5f5f 2873 656c 6629 3a0a 2020 2020  er__(self):.    
-00013740: 2020 2020 7969 656c 6420 7365 6c66 2e70      yield self.p
-00013750: 7269 6d61 6c0a 2020 2020 2020 2020 7969  rimal.        yi
-00013760: 656c 6420 7365 6c66 2e72 6573 6964 7561  eld self.residua
-00013770: 6c73 0a0a 0a63 6c61 7373 204e 6f50 756c  ls...class NoPul
-00013780: 6c62 6163 6b3a 0a20 2020 2022 2222 4120  lback:.    """A 
-00013790: 6475 6d6d 7920 7075 6c6c 6261 636b 2066  dummy pullback f
-000137a0: 756e 6374 696f 6e20 7468 6174 2072 6574  unction that ret
-000137b0: 7572 6e73 204e 6f6e 6520 6f72 2072 6169  urns None or rai
-000137c0: 7365 7320 616e 2065 7272 6f72 2e22 2222  ses an error."""
-000137d0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-000137e0: 5f5f 2873 656c 662c 206e 756d 5f61 7267  __(self, num_arg
-000137f0: 733d 3029 3a0a 2020 2020 2020 2020 7365  s=0):.        se
-00013800: 6c66 2e6e 756d 5f61 7267 7320 3d20 6e75  lf.num_args = nu
-00013810: 6d5f 6172 6773 0a0a 2020 2020 6465 6620  m_args..    def 
-00013820: 5f5f 6361 6c6c 5f5f 2873 656c 662c 202a  __call__(self, *
-00013830: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-00013840: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00013850: 2e6e 756d 5f61 7267 7320 3e20 303a 0a20  .num_args > 0:. 
-00013860: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00013870: 6e20 284e 6f6e 652c 2920 2a20 7365 6c66  n (None,) * self
-00013880: 2e6e 756d 5f61 7267 730a 2020 2020 2020  .num_args.      
-00013890: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-000138a0: 7272 6f72 2822 5075 6c6c 6261 636b 2063  rror("Pullback c
-000138b0: 616c 6c65 6420 6f6e 2061 206e 6f6e 2d64  alled on a non-d
-000138c0: 6966 6665 7265 6e74 6961 626c 6520 7379  ifferentiable sy
-000138d0: 6d62 6f6c 206f 7220 6120 636f 6e73 7461  mbol or a consta
-000138e0: 6e74 2e22 290a 0a0a 636c 6173 7320 5a65  nt.")...class Ze
-000138f0: 726f 4261 636b 7761 7264 3a0a 2020 2020  roBackward:.    
-00013900: 2222 2241 2068 656c 7065 7220 6261 636b  """A helper back
-00013910: 7761 7264 2066 756e 6374 696f 6e20 7468  ward function th
-00013920: 6174 2072 6574 7572 6e73 207a 6572 6f73  at returns zeros
-00013930: 2e22 2222 0a0a 2020 2020 6465 6620 5f5f  ."""..    def __
-00013940: 696e 6974 5f5f 2873 656c 662c 206e 756d  init__(self, num
-00013950: 5f61 7267 7329 3a0a 2020 2020 2020 2020  _args):.        
-00013960: 7365 6c66 2e6e 756d 5f61 7267 7320 3d20  self.num_args = 
-00013970: 6e75 6d5f 6172 6773 0a0a 2020 2020 6465  num_args..    de
-00013980: 6620 5f5f 6361 6c6c 5f5f 2873 656c 662c  f __call__(self,
-00013990: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
-000139a0: 293a 0a20 2020 2020 2020 2023 2041 7373  ):.        # Ass
-000139b0: 756d 696e 6720 7468 6174 2074 6865 2066  uming that the f
-000139c0: 6972 7374 2061 7267 756d 656e 7473 2061  irst arguments a
-000139d0: 7265 2074 6865 2066 6f72 7761 7264 2061  re the forward a
-000139e0: 7267 756d 656e 7473 0a20 2020 2020 2020  rguments.       
-000139f0: 2066 6f72 7761 7264 5f61 7267 7320 3d20   forward_args = 
-00013a00: 6172 6773 5b3a 2073 656c 662e 6e75 6d5f  args[: self.num_
-00013a10: 6172 6773 5d0a 0a20 2020 2020 2020 2064  args]..        d
-00013a20: 6566 207a 6572 6f73 5f6c 696b 6528 7829  ef zeros_like(x)
-00013a30: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00013a40: 2069 7369 6e73 7461 6e63 6528 782c 2054   isinstance(x, T
-00013a50: 656e 736f 7250 726f 7879 293a 0a20 2020  ensorProxy):.   
-00013a60: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00013a70: 7572 6e20 6675 6c6c 5f6c 696b 6528 782c  urn full_like(x,
-00013a80: 2066 696c 6c5f 7661 6c75 653d 3029 0a20   fill_value=0). 
-00013a90: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00013aa0: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
-00013ab0: 6d62 6572 5072 6f78 7929 3a0a 2020 2020  mberProxy):.    
-00013ac0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00013ad0: 726e 2074 7970 6528 782e 7661 6c75 6529  rn type(x.value)
-00013ae0: 2830 290a 2020 2020 2020 2020 2020 2020  (0).            
-00013af0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-00013b00: 782c 204e 756d 6265 7229 3a0a 2020 2020  x, Number):.    
-00013b10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00013b20: 726e 2074 7970 6528 7829 2830 290a 2020  rn type(x)(0).  
-00013b30: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00013b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b50: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00013b60: 2866 227a 6572 6f73 5f6c 696b 6520 696e  (f"zeros_like in
-00013b70: 7369 6465 205a 6572 6f42 6163 6b77 6172  side ZeroBackwar
-00013b80: 6420 676f 7420 616e 2075 6e73 7570 706f  d got an unsuppo
-00013b90: 7274 6564 2074 7970 6520 7b74 7970 6528  rted type {type(
-00013ba0: 7829 7d22 290a 0a20 2020 2020 2020 2072  x)}")..        r
-00013bb0: 6574 7572 6e20 7475 706c 6528 7a65 726f  eturn tuple(zero
-00013bc0: 735f 6c69 6b65 2861 7267 2920 666f 7220  s_like(arg) for 
-00013bd0: 6172 6720 696e 2066 6f72 7761 7264 5f61  arg in forward_a
-00013be0: 7267 7329 0a0a 0a23 204d 6170 7069 6e67  rgs)...# Mapping
-00013bf0: 2066 726f 6d20 7379 6d62 6f6c 7320 746f   from symbols to
-00013c00: 2061 7567 6d65 6e74 6564 2070 7269 6d61   augmented prima
-00013c10: 6c20 2866 6f72 7761 7264 2920 6675 6e63  l (forward) func
-00013c20: 7469 6f6e 7320 7573 6564 2069 6e20 564a  tions used in VJ
-00013c30: 500a 2320 5468 6520 6175 676d 656e 7465  P.# The augmente
-00013c40: 645f 7072 696d 616c 2066 756e 6374 696f  d_primal functio
-00013c50: 6e20 7461 6b65 7320 7468 6520 7072 696d  n takes the prim
-00013c60: 616c 2076 616c 7565 7320 616e 6420 7265  al values and re
-00013c70: 7475 726e 7320 7468 6520 7072 696d 616c  turns the primal
-00013c80: 0a23 2072 6573 756c 7420 616e 6420 7468  .# result and th
-00013c90: 6520 7265 7369 6475 616c 7320 2873 6176  e residuals (sav
-00013ca0: 6564 2076 616c 7565 7320 666f 7220 7468  ed values for th
-00013cb0: 6520 6261 636b 7761 7264 292e 0a61 7567  e backward)..aug
-00013cc0: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
-00013cd0: 6d70 6c73 203d 207b 0a20 2020 2070 7269  mpls = {.    pri
-00013ce0: 6d73 2e50 7269 6d49 4473 2e41 434f 533a  ms.PrimIDs.ACOS:
-00013cf0: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
-00013d00: 732e 6163 6f73 2878 292c 2028 782c 2929  s.acos(x), (x,))
-00013d10: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00013d20: 4944 732e 4143 4f53 483a 206c 616d 6264  IDs.ACOSH: lambd
-00013d30: 6120 783a 2028 7072 696d 732e 6163 6f73  a x: (prims.acos
-00013d40: 6828 7829 2c20 2878 2c29 292c 0a20 2020  h(x), (x,)),.   
-00013d50: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
-00013d60: 5349 4e3a 206c 616d 6264 6120 783a 2028  SIN: lambda x: (
-00013d70: 7072 696d 732e 6173 696e 2878 292c 2028  prims.asin(x), (
-00013d80: 782c 2929 2c0a 2020 2020 7072 696d 732e  x,)),.    prims.
-00013d90: 5072 696d 4944 732e 4153 494e 483a 206c  PrimIDs.ASINH: l
-00013da0: 616d 6264 6120 783a 2028 7072 696d 732e  ambda x: (prims.
-00013db0: 6173 696e 6828 7829 2c20 2878 2c29 292c  asinh(x), (x,)),
-00013dc0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00013dd0: 4473 2e41 5441 4e3a 206c 616d 6264 6120  Ds.ATAN: lambda 
-00013de0: 783a 2028 7072 696d 732e 6174 616e 2878  x: (prims.atan(x
-00013df0: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
-00013e00: 696d 732e 5072 696d 4944 732e 4154 414e  ims.PrimIDs.ATAN
-00013e10: 483a 206c 616d 6264 6120 783a 2028 7072  H: lambda x: (pr
-00013e20: 696d 732e 6174 616e 6828 7829 2c20 2878  ims.atanh(x), (x
-00013e30: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00013e40: 7269 6d49 4473 2e41 5441 4e32 3a20 6c61  rimIDs.ATAN2: la
-00013e50: 6d62 6461 2078 2c20 793a 2028 7072 696d  mbda x, y: (prim
-00013e60: 732e 6174 616e 3228 782c 2079 292c 2028  s.atan2(x, y), (
-00013e70: 782c 2079 2929 2c0a 2020 2020 7072 696d  x, y)),.    prim
-00013e80: 732e 5072 696d 4944 732e 434f 5348 3a20  s.PrimIDs.COSH: 
-00013e90: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-00013ea0: 2e63 6f73 6828 7829 2c20 2878 2c29 292c  .cosh(x), (x,)),
-00013eb0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00013ec0: 4473 2e44 4947 414d 4d41 3a20 6c61 6d62  Ds.DIGAMMA: lamb
-00013ed0: 6461 2078 3a20 2870 7269 6d73 2e64 6967  da x: (prims.dig
-00013ee0: 616d 6d61 2878 292c 2028 782c 2929 2c0a  amma(x), (x,)),.
-00013ef0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00013f00: 732e 4552 4643 3a20 6c61 6d62 6461 2078  s.ERFC: lambda x
-00013f10: 3a20 2870 7269 6d73 2e65 7266 6328 7829  : (prims.erfc(x)
-00013f20: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
-00013f30: 6d73 2e50 7269 6d49 4473 2e45 5246 494e  ms.PrimIDs.ERFIN
-00013f40: 563a 206c 616d 6264 6120 783a 2028 7072  V: lambda x: (pr
-00013f50: 696d 732e 6572 6669 6e76 2878 292c 2028  ims.erfinv(x), (
-00013f60: 7072 696d 732e 6572 6669 6e76 2878 292c  prims.erfinv(x),
-00013f70: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
-00013f80: 696d 4944 732e 4552 4643 494e 563a 206c  imIDs.ERFCINV: l
-00013f90: 616d 6264 6120 783a 2028 7072 696d 732e  ambda x: (prims.
-00013fa0: 6572 6663 696e 7628 7829 2c20 2870 7269  erfcinv(x), (pri
-00013fb0: 6d73 2e65 7266 6369 6e76 2878 292c 2929  ms.erfcinv(x),))
-00013fc0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00013fd0: 4944 732e 4558 5032 3a20 6c61 6d62 6461  IDs.EXP2: lambda
-00013fe0: 2078 3a20 2870 7269 6d73 2e65 7870 3228   x: (prims.exp2(
-00013ff0: 7829 2c20 2870 7269 6d73 2e65 7870 3228  x), (prims.exp2(
-00014000: 7829 2c29 292c 0a20 2020 2070 7269 6d73  x),)),.    prims
-00014010: 2e50 7269 6d49 4473 2e45 5850 4d31 3a20  .PrimIDs.EXPM1: 
-00014020: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-00014030: 2e65 7870 6d31 2878 292c 2028 7072 696d  .expm1(x), (prim
-00014040: 732e 6578 706d 3128 7829 2c29 292c 0a20  s.expm1(x),)),. 
-00014050: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014060: 2e4c 4741 4d4d 413a 206c 616d 6264 6120  .LGAMMA: lambda 
-00014070: 783a 2028 7072 696d 732e 6c67 616d 6d61  x: (prims.lgamma
-00014080: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
-00014090: 7072 696d 732e 5072 696d 4944 732e 4e44  prims.PrimIDs.ND
-000140a0: 5452 493a 206c 616d 6264 6120 783a 2028  TRI: lambda x: (
-000140b0: 7072 696d 732e 6e64 7472 6928 7829 2c20  prims.ndtri(x), 
-000140c0: 2870 7269 6d73 2e6e 6474 7269 2878 292c  (prims.ndtri(x),
-000140d0: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
-000140e0: 696d 4944 732e 5349 4e48 3a20 6c61 6d62  imIDs.SINH: lamb
-000140f0: 6461 2078 3a20 2870 7269 6d73 2e73 696e  da x: (prims.sin
-00014100: 6828 7829 2c20 2878 2c29 292c 0a20 2020  h(x), (x,)),.   
-00014110: 2070 7269 6d73 2e50 7269 6d49 4473 2e53   prims.PrimIDs.S
-00014120: 5152 543a 206c 616d 6264 6120 783a 2028  QRT: lambda x: (
-00014130: 7072 696d 732e 7371 7274 2878 292c 2028  prims.sqrt(x), (
-00014140: 7072 696d 732e 7371 7274 2878 292c 2929  prims.sqrt(x),))
-00014150: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014160: 4944 732e 4e45 3a20 6c61 6d62 6461 2078  IDs.NE: lambda x
-00014170: 2c20 793a 2028 7072 696d 732e 6e65 2878  , y: (prims.ne(x
-00014180: 2c20 7929 2c20 2878 2c20 7929 292c 0a20  , y), (x, y)),. 
-00014190: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-000141a0: 2e47 543a 206c 616d 6264 6120 782c 2079  .GT: lambda x, y
-000141b0: 3a20 2870 7269 6d73 2e67 7428 782c 2079  : (prims.gt(x, y
-000141c0: 292c 2028 782c 2079 2929 2c0a 2020 2020  ), (x, y)),.    
-000141d0: 7072 696d 732e 5072 696d 4944 732e 4c45  prims.PrimIDs.LE
-000141e0: 3a20 6c61 6d62 6461 2078 2c20 793a 2028  : lambda x, y: (
-000141f0: 7072 696d 732e 6c65 2878 2c20 7929 2c20  prims.le(x, y), 
-00014200: 2878 2c20 7929 292c 0a20 2020 2070 7269  (x, y)),.    pri
-00014210: 6d73 2e50 7269 6d49 4473 2e4c 4f47 3130  ms.PrimIDs.LOG10
-00014220: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
-00014230: 6d73 2e6c 6f67 3130 2878 292c 2028 782c  ms.log10(x), (x,
-00014240: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
-00014250: 696d 4944 732e 4c4f 4731 503a 206c 616d  imIDs.LOG1P: lam
-00014260: 6264 6120 783a 2028 7072 696d 732e 6c6f  bda x: (prims.lo
-00014270: 6731 7028 7829 2c20 2878 2c29 292c 0a20  g1p(x), (x,)),. 
-00014280: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014290: 2e4c 4f47 323a 206c 616d 6264 6120 783a  .LOG2: lambda x:
-000142a0: 2028 7072 696d 732e 6c6f 6732 2878 292c   (prims.log2(x),
-000142b0: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
-000142c0: 732e 5072 696d 4944 732e 5a45 5441 3a20  s.PrimIDs.ZETA: 
-000142d0: 6c61 6d62 6461 2078 2c20 793a 2028 7072  lambda x, y: (pr
-000142e0: 696d 732e 7a65 7461 2878 2c20 7929 2c20  ims.zeta(x, y), 
-000142f0: 2878 2c20 7929 292c 0a20 2020 2070 7269  (x, y)),.    pri
-00014300: 6d73 2e50 7269 6d49 4473 2e46 4d4f 443a  ms.PrimIDs.FMOD:
-00014310: 206c 616d 6264 6120 782c 2079 3a20 2870   lambda x, y: (p
-00014320: 7269 6d73 2e66 6d6f 6428 782c 2079 292c  rims.fmod(x, y),
-00014330: 2028 782c 2079 2929 2c0a 7d0a 0a0a 2320   (x, y)),.}...# 
-00014340: 4d61 7070 696e 6720 6672 6f6d 2073 796d  Mapping from sym
-00014350: 626f 6c73 2074 6f20 6261 636b 7761 7264  bols to backward
-00014360: 2066 756e 6374 696f 6e73 2075 7365 6420   functions used 
-00014370: 696e 2056 4a50 0a23 2054 6865 2062 6163  in VJP.# The bac
-00014380: 6b77 6172 6420 6675 6e63 7469 6f6e 2074  kward function t
-00014390: 616b 6573 2074 6865 2072 6573 6964 7561  akes the residua
-000143a0: 6c73 2061 6e64 2063 6f74 616e 6765 6e74  ls and cotangent
-000143b0: 7320 616e 6420 7265 7475 726e 7320 7468  s and returns th
-000143c0: 650a 2320 7665 6374 6f72 2d4a 6163 6f62  e.# vector-Jacob
-000143d0: 6961 6e20 7072 6f64 7563 7473 2066 6f72  ian products for
-000143e0: 2065 6163 6820 6172 6775 6d65 6e74 2e0a   each argument..
-000143f0: 6261 636b 7761 7264 5f69 6d70 6c73 203d  backward_impls =
-00014400: 207b 0a20 2020 2070 7269 6d73 2e50 7269   {.    prims.Pri
-00014410: 6d49 4473 2e41 434f 533a 206c 616d 6264  mIDs.ACOS: lambd
-00014420: 6120 782c 2067 3a20 2d67 202f 2070 7269  a x, g: -g / pri
-00014430: 6d73 2e73 7172 7428 312e 3020 2d20 7820  ms.sqrt(1.0 - x 
-00014440: 2a20 7829 2c0a 2020 2020 7072 696d 732e  * x),.    prims.
-00014450: 5072 696d 4944 732e 4143 4f53 483a 206c  PrimIDs.ACOSH: l
-00014460: 616d 6264 6120 782c 2067 3a20 6720 2a20  ambda x, g: g * 
-00014470: 7072 696d 732e 7273 7172 7428 7820 2a20  prims.rsqrt(x * 
-00014480: 7820 2d20 312e 3029 2c0a 2020 2020 7072  x - 1.0),.    pr
-00014490: 696d 732e 5072 696d 4944 732e 4153 494e  ims.PrimIDs.ASIN
-000144a0: 3a20 6c61 6d62 6461 2078 2c20 673a 2067  : lambda x, g: g
-000144b0: 202f 2070 7269 6d73 2e73 7172 7428 312e   / prims.sqrt(1.
-000144c0: 3020 2d20 7820 2a20 7829 2c0a 2020 2020  0 - x * x),.    
-000144d0: 7072 696d 732e 5072 696d 4944 732e 4153  prims.PrimIDs.AS
-000144e0: 494e 483a 206c 616d 6264 6120 782c 2067  INH: lambda x, g
-000144f0: 3a20 6720 2a20 7072 696d 732e 7273 7172  : g * prims.rsqr
-00014500: 7428 312e 3020 2b20 7820 2a20 7829 2c0a  t(1.0 + x * x),.
-00014510: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014520: 732e 4154 414e 3a20 6c61 6d62 6461 2078  s.ATAN: lambda x
-00014530: 2c20 673a 2067 202f 2028 312e 3020 2b20  , g: g / (1.0 + 
-00014540: 7820 2a20 7829 2c0a 2020 2020 7072 696d  x * x),.    prim
-00014550: 732e 5072 696d 4944 732e 4154 414e 483a  s.PrimIDs.ATANH:
-00014560: 206c 616d 6264 6120 782c 2067 3a20 6720   lambda x, g: g 
-00014570: 2f20 2831 2e30 202d 2078 202a 2078 292c  / (1.0 - x * x),
-00014580: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00014590: 4473 2e43 4f53 483a 206c 616d 6264 6120  Ds.COSH: lambda 
-000145a0: 782c 2067 3a20 7072 696d 732e 6d75 6c28  x, g: prims.mul(
-000145b0: 672c 2070 7269 6d73 2e73 696e 6828 7829  g, prims.sinh(x)
-000145c0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-000145d0: 6d49 4473 2e45 5246 433a 206c 616d 6264  mIDs.ERFC: lambd
-000145e0: 6120 782c 2067 3a20 2d67 202a 2032 2e30  a x, g: -g * 2.0
-000145f0: 202f 206d 6174 682e 7371 7274 286d 6174   / math.sqrt(mat
-00014600: 682e 7069 2920 2a20 7072 696d 732e 6578  h.pi) * prims.ex
-00014610: 7028 2d78 202a 2078 292c 0a20 2020 2070  p(-x * x),.    p
-00014620: 7269 6d73 2e50 7269 6d49 4473 2e45 5246  rims.PrimIDs.ERF
-00014630: 494e 563a 206c 616d 6264 6120 7265 7375  INV: lambda resu
-00014640: 6c74 2c20 673a 2067 202a 2030 2e35 202a  lt, g: g * 0.5 *
-00014650: 206d 6174 682e 7371 7274 286d 6174 682e   math.sqrt(math.
-00014660: 7069 2920 2a20 7072 696d 732e 6578 7028  pi) * prims.exp(
-00014670: 7265 7375 6c74 2a2a 3229 2c0a 2020 2020  result**2),.    
-00014680: 7072 696d 732e 5072 696d 4944 732e 4552  prims.PrimIDs.ER
-00014690: 4643 494e 563a 206c 616d 6264 6120 7265  FCINV: lambda re
-000146a0: 7375 6c74 2c20 673a 202d 6720 2a20 302e  sult, g: -g * 0.
-000146b0: 3520 2a20 6d61 7468 2e73 7172 7428 6d61  5 * math.sqrt(ma
-000146c0: 7468 2e70 6929 202a 2070 7269 6d73 2e65  th.pi) * prims.e
-000146d0: 7870 2872 6573 756c 742a 2a32 292c 0a20  xp(result**2),. 
-000146e0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-000146f0: 2e45 5850 323a 206c 616d 6264 6120 7265  .EXP2: lambda re
-00014700: 7375 6c74 2c20 673a 2067 202a 2072 6573  sult, g: g * res
-00014710: 756c 7420 2a20 6d61 7468 2e6c 6f67 2832  ult * math.log(2
-00014720: 2e30 292c 0a20 2020 2070 7269 6d73 2e50  .0),.    prims.P
-00014730: 7269 6d49 4473 2e45 5850 4d31 3a20 6c61  rimIDs.EXPM1: la
-00014740: 6d62 6461 2072 6573 756c 742c 2067 3a20  mbda result, g: 
-00014750: 6720 2a20 2872 6573 756c 7420 2b20 312e  g * (result + 1.
-00014760: 3029 2c0a 2020 2020 7072 696d 732e 5072  0),.    prims.Pr
-00014770: 696d 4944 732e 4c47 414d 4d41 3a20 6c61  imIDs.LGAMMA: la
-00014780: 6d62 6461 2078 2c20 673a 2067 202a 2070  mbda x, g: g * p
-00014790: 7269 6d73 2e64 6967 616d 6d61 2878 292c  rims.digamma(x),
-000147a0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-000147b0: 4473 2e4e 4454 5249 3a20 6c61 6d62 6461  Ds.NDTRI: lambda
-000147c0: 2072 6573 756c 742c 2067 3a20 6720 2a20   result, g: g * 
-000147d0: 7072 696d 732e 6578 7028 302e 3520 2a20  prims.exp(0.5 * 
-000147e0: 7265 7375 6c74 2a2a 3229 202a 206d 6174  result**2) * mat
-000147f0: 682e 7371 7274 2832 2e30 202a 206d 6174  h.sqrt(2.0 * mat
-00014800: 682e 7069 292c 0a20 2020 2070 7269 6d73  h.pi),.    prims
-00014810: 2e50 7269 6d49 4473 2e53 494e 483a 206c  .PrimIDs.SINH: l
-00014820: 616d 6264 6120 782c 2067 3a20 7072 696d  ambda x, g: prim
-00014830: 732e 6d75 6c28 672c 2070 7269 6d73 2e63  s.mul(g, prims.c
-00014840: 6f73 6828 7829 292c 0a20 2020 2070 7269  osh(x)),.    pri
-00014850: 6d73 2e50 7269 6d49 4473 2e53 5152 543a  ms.PrimIDs.SQRT:
-00014860: 206c 616d 6264 6120 7265 7375 6c74 2c20   lambda result, 
-00014870: 673a 2067 202f 2028 322e 3020 2a20 7265  g: g / (2.0 * re
-00014880: 7375 6c74 292c 0a20 2020 2070 7269 6d73  sult),.    prims
-00014890: 2e50 7269 6d49 4473 2e4e 453a 205a 6572  .PrimIDs.NE: Zer
-000148a0: 6f42 6163 6b77 6172 6428 6e75 6d5f 6172  oBackward(num_ar
-000148b0: 6773 3d32 292c 0a20 2020 2070 7269 6d73  gs=2),.    prims
-000148c0: 2e50 7269 6d49 4473 2e47 543a 205a 6572  .PrimIDs.GT: Zer
-000148d0: 6f42 6163 6b77 6172 6428 6e75 6d5f 6172  oBackward(num_ar
-000148e0: 6773 3d32 292c 0a20 2020 2070 7269 6d73  gs=2),.    prims
-000148f0: 2e50 7269 6d49 4473 2e4c 453a 205a 6572  .PrimIDs.LE: Zer
-00014900: 6f42 6163 6b77 6172 6428 6e75 6d5f 6172  oBackward(num_ar
-00014910: 6773 3d32 292c 0a20 2020 2070 7269 6d73  gs=2),.    prims
-00014920: 2e50 7269 6d49 4473 2e4c 4f47 3130 3a20  .PrimIDs.LOG10: 
-00014930: 6c61 6d62 6461 2078 2c20 673a 2067 202f  lambda x, g: g /
-00014940: 2028 7820 2a20 322e 3330 3235 3835 3039   (x * 2.30258509
-00014950: 3239 3934 3034 3629 2c0a 2020 2020 7072  2994046),.    pr
-00014960: 696d 732e 5072 696d 4944 732e 4c4f 4731  ims.PrimIDs.LOG1
-00014970: 503a 206c 616d 6264 6120 782c 2067 3a20  P: lambda x, g: 
-00014980: 6720 2f20 2878 202b 2031 292c 0a20 2020  g / (x + 1),.   
-00014990: 2070 7269 6d73 2e50 7269 6d49 4473 2e4c   prims.PrimIDs.L
-000149a0: 4f47 323a 206c 616d 6264 6120 782c 2067  OG2: lambda x, g
-000149b0: 3a20 6720 2f20 2878 202a 2030 2e36 3933  : g / (x * 0.693
-000149c0: 3134 3731 3830 3535 3939 3435 3329 2c0a  1471805599453),.
-000149d0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-000149e0: 732e 464d 4f44 3a20 6c61 6d62 6461 2078  s.FMOD: lambda x
-000149f0: 2c20 792c 2067 3a20 2867 2c20 2d67 202a  , y, g: (g, -g *
-00014a00: 2070 7269 6d73 2e74 7275 6e63 2878 202f   prims.trunc(x /
-00014a10: 2079 2929 2c0a 7d0a 0a0a 4064 6174 6163   y)),.}...@datac
-00014a20: 6c61 7373 282a 2a64 6566 6175 6c74 5f64  lass(**default_d
-00014a30: 6174 6163 6c61 7373 5f70 6172 616d 7329  ataclass_params)
-00014a40: 0a63 6c61 7373 2052 756c 6549 6e66 6f3a  .class RuleInfo:
-00014a50: 0a20 2020 2063 6865 636b 6572 3a20 4361  .    checker: Ca
-00014a60: 6c6c 6162 6c65 0a20 2020 2072 756c 653a  llable.    rule:
-00014a70: 2043 616c 6c61 626c 650a 2020 2020 6677   Callable.    fw
-00014a80: 5f66 616c 6c62 6163 6b3a 2043 616c 6c61  _fallback: Calla
-00014a90: 626c 650a 2020 2020 6277 5f66 616c 6c62  ble.    bw_fallb
-00014aa0: 6163 6b3a 2043 616c 6c61 626c 650a 2020  ack: Callable.  
-00014ab0: 2020 6578 6563 7574 6f72 3a20 4578 6563    executor: Exec
-00014ac0: 7574 6f72 0a0a 0a64 6566 2072 6567 6973  utor...def regis
-00014ad0: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
-00014ae0: 7277 6172 6428 6f70 293a 0a20 2020 2022  rward(op):.    "
-00014af0: 2222 4465 636f 7261 746f 7220 746f 2072  ""Decorator to r
-00014b00: 6567 6973 7465 7220 616e 2061 7567 6d65  egister an augme
-00014b10: 6e74 6564 2066 6f72 7761 7264 2069 6d70  nted forward imp
-00014b20: 6c65 6d65 6e74 6174 696f 6e20 666f 7220  lementation for 
-00014b30: 6120 7379 6d62 6f6c 2e0a 0a20 2020 2041  a symbol...    A
-00014b40: 7267 733a 0a20 2020 2020 2020 206f 7020  rgs:.        op 
-00014b50: 284f 7073 293a 2053 796d 626f 6c20 666f  (Ops): Symbol fo
-00014b60: 7220 7768 6963 6820 746f 2072 6567 6973  r which to regis
-00014b70: 7465 7220 7468 6520 6175 676d 656e 7465  ter the augmente
-00014b80: 6420 666f 7277 6172 6420 696d 706c 656d  d forward implem
-00014b90: 656e 7461 7469 6f6e 2e0a 0a20 2020 2052  entation...    R
-00014ba0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00014bb0: 4361 6c6c 6162 6c65 3a20 4465 636f 7261  Callable: Decora
-00014bc0: 746f 7220 6675 6e63 7469 6f6e 2e0a 2020  tor function..  
-00014bd0: 2020 2222 220a 0a20 2020 2064 6566 2064    """..    def d
-00014be0: 6563 6f72 6174 6f72 2866 756e 6329 3a0a  ecorator(func):.
-00014bf0: 2020 2020 2020 2020 6175 676d 656e 7465          augmente
-00014c00: 645f 666f 7277 6172 645f 696d 706c 735b  d_forward_impls[
-00014c10: 6f70 5d20 3d20 6675 6e63 0a20 2020 2020  op] = func.     
-00014c20: 2020 2072 6574 7572 6e20 6675 6e63 0a0a     return func..
-00014c30: 2020 2020 7265 7475 726e 2064 6563 6f72      return decor
-00014c40: 6174 6f72 0a0a 0a64 6566 2072 6567 6973  ator...def regis
-00014c50: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
-00014c60: 7277 6172 645f 7769 7468 5f63 6865 636b  rward_with_check
-00014c70: 6572 2865 7865 6375 746f 722c 206f 702c  er(executor, op,
-00014c80: 2063 6865 636b 6572 2c20 7275 6c65 293a   checker, rule):
-00014c90: 0a20 2020 2022 2222 4465 636f 7261 746f  .    """Decorato
-00014ca0: 7220 746f 2072 6567 6973 7465 7220 616e  r to register an
-00014cb0: 2061 7567 6d65 6e74 6564 2066 6f72 7761   augmented forwa
-00014cc0: 7264 2069 6d70 6c65 6d65 6e74 6174 696f  rd implementatio
-00014cd0: 6e20 666f 7220 6120 7379 6d62 6f6c 2e0a  n for a symbol..
-00014ce0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-00014cf0: 2020 2065 7865 6375 746f 7220 2845 7865     executor (Exe
-00014d00: 6375 746f 7229 3a20 4578 6563 7574 6f72  cutor): Executor
-00014d10: 2074 6f20 7768 6963 6820 7468 6520 7275   to which the ru
-00014d20: 6c65 2061 7070 6c69 6573 2e0a 2020 2020  le applies..    
-00014d30: 2020 2020 6f70 2028 4f70 7329 3a20 5379      op (Ops): Sy
-00014d40: 6d62 6f6c 2066 6f72 2077 6869 6368 2074  mbol for which t
-00014d50: 6f20 7265 6769 7374 6572 2074 6865 2061  o register the a
-00014d60: 7567 6d65 6e74 6564 2066 6f72 7761 7264  ugmented forward
-00014d70: 2069 6d70 6c65 6d65 6e74 6174 696f 6e2e   implementation.
-00014d80: 0a20 2020 2020 2020 2063 6865 636b 6572  .        checker
-00014d90: 2028 4361 6c6c 6162 6c65 293a 2046 756e   (Callable): Fun
-00014da0: 6374 696f 6e20 7468 6174 2063 6865 636b  ction that check
-00014db0: 7320 6966 2074 6865 2072 756c 6520 7368  s if the rule sh
-00014dc0: 6f75 6c64 2062 6520 6170 706c 6965 642e  ould be applied.
-00014dd0: 0a20 2020 2020 2020 2072 756c 6520 2843  .        rule (C
-00014de0: 616c 6c61 626c 6529 3a20 4675 6e63 7469  allable): Functi
-00014df0: 6f6e 2074 6861 7420 6170 706c 6965 7320  on that applies 
-00014e00: 7468 6520 7275 6c65 2e0a 2020 2020 2222  the rule..    ""
-00014e10: 220a 2020 2020 6677 5f66 616c 6c62 6163  ".    fw_fallbac
-00014e20: 6b20 3d20 6175 676d 656e 7465 645f 666f  k = augmented_fo
-00014e30: 7277 6172 645f 696d 706c 732e 6765 7428  rward_impls.get(
-00014e40: 6f70 2c20 4e6f 6e65 290a 2020 2020 6277  op, None).    bw
-00014e50: 5f66 616c 6c62 6163 6b20 3d20 6261 636b  _fallback = back
-00014e60: 7761 7264 5f69 6d70 6c73 2e67 6574 286f  ward_impls.get(o
-00014e70: 702c 204e 6f6e 6529 0a20 2020 2061 7567  p, None).    aug
-00014e80: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
-00014e90: 6d70 6c73 5b65 7865 6375 746f 722c 206f  mpls[executor, o
-00014ea0: 705d 203d 2052 756c 6549 6e66 6f28 6368  p] = RuleInfo(ch
-00014eb0: 6563 6b65 722c 2072 756c 652c 2066 775f  ecker, rule, fw_
-00014ec0: 6661 6c6c 6261 636b 2c20 6277 5f66 616c  fallback, bw_fal
-00014ed0: 6c62 6163 6b2c 2065 7865 6375 746f 7229  lback, executor)
-00014ee0: 0a0a 0a64 6566 2064 6572 6567 6973 7465  ...def deregiste
-00014ef0: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
-00014f00: 6172 645f 616e 645f 6261 636b 7761 7264  ard_and_backward
-00014f10: 286f 7029 3a0a 2020 2020 2222 2244 6572  (op):.    """Der
-00014f20: 6567 6973 7465 7273 2061 6e20 6175 676d  egisters an augm
-00014f30: 656e 7465 6420 666f 7277 6172 6420 696d  ented forward im
-00014f40: 706c 656d 656e 7461 7469 6f6e 2061 6e64  plementation and
-00014f50: 2061 2062 6163 6b77 6172 640a 2020 2020   a backward.    
-00014f60: 696d 706c 656d 656e 7461 7469 6f6e 2066  implementation f
-00014f70: 6f72 2061 2073 796d 626f 6c2e 0a0a 2020  or a symbol...  
-00014f80: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00014f90: 6f70 2028 4f70 7329 3a20 5379 6d62 6f6c  op (Ops): Symbol
-00014fa0: 2066 6f72 2077 6869 6368 2074 6f20 6465   for which to de
-00014fb0: 7265 6769 7374 6572 2074 6865 2061 7567  register the aug
-00014fc0: 6d65 6e74 6564 2066 6f72 7761 7264 0a20  mented forward. 
-00014fd0: 2020 2020 2020 2069 6d70 6c65 6d65 6e74         implement
-00014fe0: 6174 696f 6e20 616e 6420 7468 6520 6261  ation and the ba
-00014ff0: 636b 7761 7264 2069 6d70 6c65 6d65 6e74  ckward implement
-00015000: 6174 696f 6e2e 0a0a 2020 2020 5265 7475  ation...    Retu
-00015010: 726e 733a 0a20 2020 2020 2020 204e 6f6e  rns:.        Non
-00015020: 650a 2020 2020 2222 220a 2020 2020 2320  e.    """.    # 
-00015030: 5265 7374 6f72 6520 7468 6520 6661 6c6c  Restore the fall
-00015040: 6261 636b 2069 6d70 6c65 6d65 6e74 6174  back implementat
-00015050: 696f 6e20 6966 2069 7420 6578 6973 7473  ion if it exists
-00015060: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
-00015070: 6365 2861 7567 6d65 6e74 6564 5f66 6f72  ce(augmented_for
-00015080: 7761 7264 5f69 6d70 6c73 5b6f 705d 2c20  ward_impls[op], 
-00015090: 5275 6c65 496e 666f 293a 0a20 2020 2020  RuleInfo):.     
-000150a0: 2020 2062 6163 6b77 6172 645f 696d 706c     backward_impl
-000150b0: 735b 6f70 5d20 3d20 6175 676d 656e 7465  s[op] = augmente
-000150c0: 645f 666f 7277 6172 645f 696d 706c 735b  d_forward_impls[
-000150d0: 6f70 5d2e 6277 5f66 616c 6c62 6163 6b0a  op].bw_fallback.
-000150e0: 2020 2020 2020 2020 6175 676d 656e 7465          augmente
-000150f0: 645f 666f 7277 6172 645f 696d 706c 735b  d_forward_impls[
-00015100: 6f70 5d20 3d20 6175 676d 656e 7465 645f  op] = augmented_
-00015110: 666f 7277 6172 645f 696d 706c 735b 6f70  forward_impls[op
-00015120: 5d2e 6677 5f66 616c 6c62 6163 6b0a 2020  ].fw_fallback.  
-00015130: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00015140: 6465 6c20 6175 676d 656e 7465 645f 666f  del augmented_fo
-00015150: 7277 6172 645f 696d 706c 735b 6f70 5d0a  rward_impls[op].
-00015160: 2020 2020 2020 2020 6465 6c20 6261 636b          del back
-00015170: 7761 7264 5f69 6d70 6c73 5b6f 705d 0a0a  ward_impls[op]..
-00015180: 0a64 6566 2072 6567 6973 7465 725f 6261  .def register_ba
-00015190: 636b 7761 7264 286f 7029 3a0a 2020 2020  ckward(op):.    
-000151a0: 2222 2244 6563 6f72 6174 6f72 2074 6f20  """Decorator to 
-000151b0: 7265 6769 7374 6572 2061 2062 6163 6b77  register a backw
-000151c0: 6172 6420 696d 706c 656d 656e 7461 7469  ard implementati
-000151d0: 6f6e 2066 6f72 2061 2073 796d 626f 6c2e  on for a symbol.
-000151e0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-000151f0: 2020 2020 6f70 2028 4f70 7329 3a20 5379      op (Ops): Sy
-00015200: 6d62 6f6c 2066 6f72 2077 6869 6368 2074  mbol for which t
-00015210: 6f20 7265 6769 7374 6572 2074 6865 2062  o register the b
-00015220: 6163 6b77 6172 6420 696d 706c 656d 656e  ackward implemen
-00015230: 7461 7469 6f6e 2e0a 0a20 2020 2052 6574  tation...    Ret
-00015240: 7572 6e73 3a0a 2020 2020 2020 2020 4361  urns:.        Ca
-00015250: 6c6c 6162 6c65 3a20 4465 636f 7261 746f  llable: Decorato
-00015260: 7220 6675 6e63 7469 6f6e 2e0a 2020 2020  r function..    
-00015270: 2222 220a 0a20 2020 2064 6566 2064 6563  """..    def dec
-00015280: 6f72 6174 6f72 2866 756e 6329 3a0a 2020  orator(func):.  
-00015290: 2020 2020 2020 6261 636b 7761 7264 5f69        backward_i
-000152a0: 6d70 6c73 5b6f 705d 203d 2066 756e 630a  mpls[op] = func.
-000152b0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-000152c0: 756e 630a 0a20 2020 2072 6574 7572 6e20  unc..    return 
-000152d0: 6465 636f 7261 746f 720a 0a0a 6465 6620  decorator...def 
-000152e0: 7265 7374 6f72 655f 7265 6475 6365 645f  restore_reduced_
-000152f0: 6469 6d73 2878 2c20 7265 6475 6365 645f  dims(x, reduced_
-00015300: 6469 6d73 2c20 6f72 6967 696e 616c 5f73  dims, original_s
-00015310: 6861 7065 293a 0a20 2020 2022 2222 5265  hape):.    """Re
-00015320: 7374 6f72 6573 2074 6865 2072 6564 7563  stores the reduc
-00015330: 6564 2064 696d 656e 7369 6f6e 7320 6f66  ed dimensions of
-00015340: 2061 2074 656e 736f 722e 0a0a 2020 2020   a tensor...    
-00015350: 4172 6773 3a0a 2020 2020 2020 2020 7820  Args:.        x 
-00015360: 2856 6172 6961 626c 6529 3a20 5465 6e73  (Variable): Tens
-00015370: 6f72 2074 6f20 6265 2072 6573 6861 7065  or to be reshape
-00015380: 642e 0a20 2020 2020 2020 2072 6564 7563  d..        reduc
-00015390: 6564 5f64 696d 7320 2854 7570 6c65 5b69  ed_dims (Tuple[i
-000153a0: 6e74 2c20 2e2e 2e5d 293a 2054 7570 6c65  nt, ...]): Tuple
-000153b0: 206f 6620 7265 6475 6365 6420 6469 6d65   of reduced dime
-000153c0: 6e73 696f 6e73 2e0a 2020 2020 2020 2020  nsions..        
-000153d0: 6f72 6967 696e 616c 5f73 6861 7065 2028  original_shape (
-000153e0: 5475 706c 655b 696e 742c 202e 2e2e 5d29  Tuple[int, ...])
-000153f0: 3a20 4f72 6967 696e 616c 2073 6861 7065  : Original shape
-00015400: 206f 6620 7468 6520 7465 6e73 6f72 2e0a   of the tensor..
-00015410: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-00015420: 2020 2020 2020 5661 7269 6162 6c65 3a20        Variable: 
-00015430: 5465 6e73 6f72 2077 6974 6820 7468 6520  Tensor with the 
-00015440: 7265 6475 6365 6420 6469 6d65 6e73 696f  reduced dimensio
-00015450: 6e73 2072 6573 746f 7265 642e 0a20 2020  ns restored..   
-00015460: 2022 2222 0a20 2020 2069 6620 6f72 6967   """.    if orig
-00015470: 696e 616c 5f73 6861 7065 203d 3d20 2829  inal_shape == ()
-00015480: 3a20 2023 2073 6361 6c61 720a 2020 2020  :  # scalar.    
-00015490: 2020 2020 7265 7475 726e 2078 0a0a 2020      return x..  
-000154a0: 2020 756e 7371 7565 657a 6564 203d 2063    unsqueezed = c
-000154b0: 6c61 6e67 2e75 6e73 7175 6565 7a65 2878  lang.unsqueeze(x
-000154c0: 2c20 7265 6475 6365 645f 6469 6d73 290a  , reduced_dims).
-000154d0: 2020 2020 7265 7475 726e 2063 6c61 6e67      return clang
-000154e0: 2e65 7870 616e 6428 756e 7371 7565 657a  .expand(unsqueez
-000154f0: 6564 2c20 6f72 6967 696e 616c 5f73 6861  ed, original_sha
-00015500: 7065 290a 0a0a 4072 6567 6973 7465 725f  pe)...@register_
-00015510: 6261 636b 7761 7264 2870 7269 6d73 2e50  backward(prims.P
-00015520: 7269 6d49 4473 2e5a 4554 4129 0a64 6566  rimIDs.ZETA).def
-00015530: 207a 6574 615f 6261 636b 7761 7264 2878   zeta_backward(x
-00015540: 2c20 792c 2067 293a 0a20 2020 2023 2054  , y, g):.    # T
-00015550: 6865 2064 6572 6976 6174 6976 6520 7772  he derivative wr
-00015560: 7420 7468 6520 6669 7273 7420 6172 6775  t the first argu
-00015570: 6d65 6e74 2069 7320 6e6f 7420 6578 7072  ment is not expr
-00015580: 6573 7369 626c 6520 696e 2074 6572 6d73  essible in terms
-00015590: 206f 6620 7a65 7461 206f 720a 2020 2020   of zeta or.    
-000155a0: 2320 6f74 6865 7220 7370 6563 6961 6c20  # other special 
-000155b0: 6675 6e63 7469 6f6e 730a 2020 2020 2320  functions.    # 
-000155c0: 5468 6572 6566 6f72 652c 2077 6520 636f  Therefore, we co
-000155d0: 6d70 7574 6520 6f6e 6c79 2074 6865 2064  mpute only the d
-000155e0: 6572 6976 6174 6976 6520 7772 7420 7468  erivative wrt th
-000155f0: 6520 7365 636f 6e64 2061 7267 756d 656e  e second argumen
-00015600: 740a 2020 2020 6779 203d 2067 202a 202d  t.    gy = g * -
-00015610: 7820 2a20 7072 696d 732e 7a65 7461 2878  x * prims.zeta(x
-00015620: 202b 2031 2e30 2c20 7929 0a0a 2020 2020   + 1.0, y)..    
-00015630: 2320 5265 7475 726e 2061 206d 6170 7070  # Return a mappp
-00015640: 696e 6720 6672 6f6d 2074 6865 2066 6f72  ing from the for
-00015650: 7761 7264 2061 7267 756d 656e 7473 2074  ward arguments t
-00015660: 6f20 7468 6520 6772 6164 6965 6e74 730a  o the gradients.
-00015670: 2020 2020 7265 7475 726e 207b 2279 223a      return {"y":
-00015680: 2067 797d 0a0a 0a40 7265 6769 7374 6572   gy}...@register
-00015690: 5f62 6163 6b77 6172 6428 7072 696d 732e  _backward(prims.
-000156a0: 5072 696d 4944 732e 4449 4741 4d4d 4129  PrimIDs.DIGAMMA)
-000156b0: 0a64 6566 2064 6967 616d 6d61 5f62 6163  .def digamma_bac
-000156c0: 6b77 6172 6428 613a 2050 726f 7879 2c20  kward(a: Proxy, 
-000156d0: 6729 3a0a 2020 2020 6672 6f6d 2074 6875  g):.    from thu
-000156e0: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
-000156f0: 7420 706f 6c79 6761 6d6d 610a 0a20 2020  t polygamma..   
-00015700: 2072 6574 7572 6e20 6720 2a20 706f 6c79   return g * poly
-00015710: 6761 6d6d 6128 312c 2061 290a 0a0a 4072  gamma(1, a)...@r
-00015720: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
-00015730: 645f 666f 7277 6172 6428 2274 6f72 6368  d_forward("torch
-00015740: 2e70 6f6c 7967 616d 6d61 2229 0a64 6566  .polygamma").def
-00015750: 2070 6f6c 7967 616d 6d61 5f61 7567 5f66   polygamma_aug_f
-00015760: 7764 286e 3a20 696e 742c 2061 3a20 5072  wd(n: int, a: Pr
-00015770: 6f78 7929 3a0a 2020 2020 6672 6f6d 2074  oxy):.    from t
-00015780: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
-00015790: 6f72 7420 706f 6c79 6761 6d6d 610a 0a20  ort polygamma.. 
-000157a0: 2020 2070 7269 6d61 6c20 3d20 706f 6c79     primal = poly
-000157b0: 6761 6d6d 6128 6e2c 2061 290a 2020 2020  gamma(n, a).    
-000157c0: 7265 7369 6475 616c 7320 3d20 286e 2c20  residuals = (n, 
-000157d0: 6129 0a20 2020 2072 6574 7572 6e20 564a  a).    return VJ
-000157e0: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
-000157f0: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
-00015800: 7374 6572 5f62 6163 6b77 6172 6428 2274  ster_backward("t
-00015810: 6f72 6368 2e70 6f6c 7967 616d 6d61 2229  orch.polygamma")
-00015820: 0a64 6566 2070 6f6c 7967 616d 6d61 5f62  .def polygamma_b
-00015830: 6163 6b77 6172 6428 6e3a 2069 6e74 2c20  ackward(n: int, 
-00015840: 613a 2050 726f 7879 2c20 6729 3a0a 2020  a: Proxy, g):.  
-00015850: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
-00015860: 6f72 6368 2069 6d70 6f72 7420 706f 6c79  orch import poly
-00015870: 6761 6d6d 610a 0a20 2020 2072 6574 7572  gamma..    retur
-00015880: 6e20 4e6f 6e65 2c20 6720 2a20 706f 6c79  n None, g * poly
-00015890: 6761 6d6d 6128 6e20 2b20 312c 2061 290a  gamma(n + 1, a).
-000158a0: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
-000158b0: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
-000158c0: 4473 2e41 5441 4e32 290a 6465 6620 6174  Ds.ATAN2).def at
-000158d0: 616e 325f 6261 636b 7761 7264 2878 2c20  an2_backward(x, 
-000158e0: 792c 2067 293a 0a20 2020 2061 6c70 6861  y, g):.    alpha
-000158f0: 203d 2031 2e30 202f 2028 7820 2a20 7820   = 1.0 / (x * x 
-00015900: 2b20 7920 2a20 7929 0a20 2020 2067 7261  + y * y).    gra
-00015910: 645f 7820 3d20 6720 2a20 7920 2a20 616c  d_x = g * y * al
-00015920: 7068 610a 2020 2020 6772 6164 5f79 203d  pha.    grad_y =
-00015930: 2067 202a 202d 7820 2a20 616c 7068 610a   g * -x * alpha.
-00015940: 2020 2020 7265 7475 726e 2067 7261 645f      return grad_
-00015950: 782c 2067 7261 645f 790a 0a0a 4072 6567  x, grad_y...@reg
-00015960: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-00015970: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
-00015980: 696d 4944 732e 5641 5229 0a64 6566 2076  imIDs.VAR).def v
-00015990: 6172 5f61 7567 5f66 7764 2861 2c20 6469  ar_aug_fwd(a, di
-000159a0: 6d2c 202a 2c20 636f 7272 6563 7469 6f6e  m, *, correction
-000159b0: 293a 0a20 2020 2076 203d 2070 7269 6d73  ):.    v = prims
-000159c0: 2e76 6172 2861 2c20 6469 6d2c 2063 6f72  .var(a, dim, cor
-000159d0: 7265 6374 696f 6e3d 636f 7272 6563 7469  rection=correcti
-000159e0: 6f6e 290a 2020 2020 7265 7475 726e 2056  on).    return V
-000159f0: 4a50 4475 616c 2828 762c 292c 2028 612c  JPDual((v,), (a,
-00015a00: 2064 696d 2c20 636f 7272 6563 7469 6f6e   dim, correction
-00015a10: 2c20 7629 290a 0a0a 2320 544f 444f 3a20  , v))...# TODO: 
-00015a20: 6669 7820 6469 7669 7369 6f6e 2062 7920  fix division by 
-00015a30: 7a65 726f 2077 6865 6e20 6e5f 656c 656d  zero when n_elem
-00015a40: 5f72 6564 7563 6564 203d 3d20 3020 6f72  _reduced == 0 or
-00015a50: 2077 6865 6e20 762e 6e75 6d65 6c20 3d3d   when v.numel ==
-00015a60: 2030 0a23 2062 7920 7265 7475 726e 696e   0.# by returnin
-00015a70: 6720 7a65 726f 735f 6c69 6b65 2861 2920  g zeros_like(a) 
-00015a80: 6f72 2073 696d 696c 6172 2e0a 2320 544f  or similar..# TO
-00015a90: 444f 3a20 6669 7820 6772 6164 2077 6865  DO: fix grad whe
-00015aa0: 6e20 636f 7272 6563 7469 6f6e 203e 206e  n correction > n
-00015ab0: 5f65 6c65 6d5f 7265 6475 6365 642e 0a40  _elem_reduced..@
-00015ac0: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
-00015ad0: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
-00015ae0: 5641 5229 0a64 6566 2076 6172 5f62 6163  VAR).def var_bac
-00015af0: 6b77 6172 6428 612c 2064 696d 2c20 636f  kward(a, dim, co
-00015b00: 7272 6563 7469 6f6e 2c20 762c 2067 293a  rrection, v, g):
-00015b10: 0a20 2020 206e 5f65 6c65 6d5f 7265 6475  .    n_elem_redu
-00015b20: 6365 6420 3d20 612e 6e75 6d65 6c20 2f2f  ced = a.numel //
-00015b30: 2076 2e6e 756d 656c 2069 6620 612e 6e75   v.numel if a.nu
-00015b40: 6d65 6c20 213d 2030 2065 6c73 6520 310a  mel != 0 else 1.
-00015b50: 2020 2020 6e6f 726d 616c 697a 6174 696f      normalizatio
-00015b60: 6e5f 7363 616c 6172 203d 206e 5f65 6c65  n_scalar = n_ele
-00015b70: 6d5f 7265 6475 6365 6420 2d20 636f 7272  m_reduced - corr
-00015b80: 6563 7469 6f6e 0a20 2020 2067 203d 2072  ection.    g = r
-00015b90: 6573 746f 7265 5f72 6564 7563 6564 5f64  estore_reduced_d
-00015ba0: 696d 7328 672c 2064 696d 2c20 612e 7368  ims(g, dim, a.sh
-00015bb0: 6170 6529 0a20 2020 2069 6620 612e 6474  ape).    if a.dt
-00015bc0: 7970 6520 213d 2076 2e64 7479 7065 3a0a  ype != v.dtype:.
-00015bd0: 2020 2020 2020 2020 6120 3d20 7072 696d          a = prim
-00015be0: 732e 636f 6e76 6572 745f 656c 656d 656e  s.convert_elemen
-00015bf0: 745f 7479 7065 2861 2c20 762e 6474 7970  t_type(a, v.dtyp
-00015c00: 6529 0a20 2020 206d 6561 6e20 3d20 7072  e).    mean = pr
-00015c10: 696d 732e 7375 6d28 612c 2064 696d 2920  ims.sum(a, dim) 
-00015c20: 2f20 6e5f 656c 656d 5f72 6564 7563 6564  / n_elem_reduced
-00015c30: 0a20 2020 206d 6561 6e20 3d20 7265 7374  .    mean = rest
-00015c40: 6f72 655f 7265 6475 6365 645f 6469 6d73  ore_reduced_dims
-00015c50: 286d 6561 6e2c 2064 696d 2c20 612e 7368  (mean, dim, a.sh
-00015c60: 6170 6529 0a20 2020 2072 6574 7572 6e20  ape).    return 
-00015c70: 2832 202a 2067 202a 2028 6120 2d20 6d65  (2 * g * (a - me
-00015c80: 616e 2929 202f 206e 6f72 6d61 6c69 7a61  an)) / normaliza
-00015c90: 7469 6f6e 5f73 6361 6c61 720a 0a0a 6465  tion_scalar...de
-00015ca0: 6620 6e5f 656c 656d 5f72 6564 7563 6564  f n_elem_reduced
-00015cb0: 2861 5f6e 6469 6d2c 2061 5f73 6861 7065  (a_ndim, a_shape
-00015cc0: 2c20 6469 6d73 293a 0a20 2020 2064 696d  , dims):.    dim
-00015cd0: 7320 3d20 7574 696c 732e 6361 6e6f 6e69  s = utils.canoni
-00015ce0: 6361 6c69 7a65 5f64 696d 7328 615f 6e64  calize_dims(a_nd
-00015cf0: 696d 2c20 6469 6d73 290a 2020 2020 7265  im, dims).    re
-00015d00: 6475 6374 696f 6e5f 7369 7a65 203d 2031  duction_size = 1
-00015d10: 0a20 2020 2066 6f72 2069 6478 2c20 7369  .    for idx, si
-00015d20: 7a65 2069 6e20 656e 756d 6572 6174 6528  ze in enumerate(
-00015d30: 615f 7368 6170 6529 3a0a 2020 2020 2020  a_shape):.      
-00015d40: 2020 6966 2069 6478 2069 6e20 6469 6d73    if idx in dims
-00015d50: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00015d60: 6475 6374 696f 6e5f 7369 7a65 202a 3d20  duction_size *= 
-00015d70: 7369 7a65 0a20 2020 2072 6574 7572 6e20  size.    return 
-00015d80: 7265 6475 6374 696f 6e5f 7369 7a65 0a0a  reduction_size..
-00015d90: 0a64 6566 206d 6561 6e5f 6261 636b 7761  .def mean_backwa
-00015da0: 7264 2861 5f6e 6469 6d2c 2061 5f73 6861  rd(a_ndim, a_sha
-00015db0: 7065 2c20 6469 6d73 2c20 6772 6164 293a  pe, dims, grad):
-00015dc0: 0a20 2020 206d 6561 6e5f 6c6f 6361 6c5f  .    mean_local_
-00015dd0: 6772 6164 203d 2031 2e30 202f 206e 5f65  grad = 1.0 / n_e
-00015de0: 6c65 6d5f 7265 6475 6365 6428 615f 6e64  lem_reduced(a_nd
-00015df0: 696d 2c20 615f 7368 6170 652c 2064 696d  im, a_shape, dim
-00015e00: 7329 0a20 2020 2072 6574 7572 6e20 7265  s).    return re
-00015e10: 7374 6f72 655f 7265 6475 6365 645f 6469  store_reduced_di
-00015e20: 6d73 2867 7261 642c 2064 696d 732c 2061  ms(grad, dims, a
-00015e30: 5f73 6861 7065 2920 2a20 6d65 616e 5f6c  _shape) * mean_l
-00015e40: 6f63 616c 5f67 7261 640a 0a0a 4072 6567  ocal_grad...@reg
-00015e50: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-00015e60: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
-00015e70: 696d 4944 732e 5041 4429 0a64 6566 2070  imIDs.PAD).def p
-00015e80: 6164 5f61 7567 5f66 7764 2861 2c20 7061  ad_aug_fwd(a, pa
-00015e90: 6464 696e 675f 7661 6c75 652c 2070 6164  dding_value, pad
-00015ea0: 6469 6e67 5f63 6f6e 6669 6729 3a0a 2020  ding_config):.  
-00015eb0: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
-00015ec0: 2828 7072 696d 732e 7061 6428 612c 2070  ((prims.pad(a, p
-00015ed0: 6164 6469 6e67 5f76 616c 7565 2c20 7061  adding_value, pa
-00015ee0: 6464 696e 675f 636f 6e66 6967 292c 292c  dding_config),),
-00015ef0: 2028 612c 2070 6164 6469 6e67 5f63 6f6e   (a, padding_con
-00015f00: 6669 6729 290a 0a0a 4072 6567 6973 7465  fig))...@registe
-00015f10: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
-00015f20: 2e50 7269 6d49 4473 2e50 4144 290a 6465  .PrimIDs.PAD).de
-00015f30: 6620 7061 645f 6261 636b 7761 7264 2861  f pad_backward(a
-00015f40: 2c20 7061 6464 696e 675f 636f 6e66 6967  , padding_config
-00015f50: 2c20 6729 3a0a 2020 2020 2320 5368 6f72  , g):.    # Shor
-00015f60: 7420 6369 7263 7569 7420 6f6e 2065 6d70  t circuit on emp
-00015f70: 7479 2069 6e70 7574 2e0a 2020 2020 6966  ty input..    if
-00015f80: 2061 6e79 2864 696d 203d 3d20 3020 666f   any(dim == 0 fo
-00015f90: 7220 6469 6d20 696e 2061 2e73 6861 7065  r dim in a.shape
-00015fa0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00015fb0: 6e20 6675 6c6c 5f6c 696b 6528 612c 2066  n full_like(a, f
-00015fc0: 696c 6c5f 7661 6c75 653d 3029 0a0a 2020  ill_value=0)..  
-00015fd0: 2020 2320 556e 2d70 6164 2062 7920 7061    # Un-pad by pa
-00015fe0: 6464 696e 6720 7769 7468 207a 6572 6f20  dding with zero 
-00015ff0: 7661 6c75 6573 0a20 2020 207a 6572 6f5f  values.    zero_
-00016000: 7061 6464 696e 675f 636f 6e66 6967 203d  padding_config =
-00016010: 205b 282d 6c6f 2c20 2d68 692c 2030 2920   [(-lo, -hi, 0) 
-00016020: 666f 7220 6c6f 2c20 6869 2c20 5f20 696e  for lo, hi, _ in
-00016030: 2070 6164 6469 6e67 5f63 6f6e 6669 675d   padding_config]
-00016040: 0a0a 2020 2020 6720 3d20 7072 696d 732e  ..    g = prims.
-00016050: 7061 6428 672c 2030 2e30 2c20 7a65 726f  pad(g, 0.0, zero
-00016060: 5f70 6164 6469 6e67 5f63 6f6e 6669 6729  _padding_config)
-00016070: 0a0a 2020 2020 2320 556e 2d73 6c69 6365  ..    # Un-slice
-00016080: 2062 7920 736c 6963 696e 6720 7769 7468   by slicing with
-00016090: 2061 2073 7472 6964 6520 6f66 2076 616c   a stride of val
-000160a0: 7565 2028 6469 6c61 7469 6f6e 202b 2031  ue (dilation + 1
-000160b0: 290a 2020 2020 666f 7220 6469 6d2c 2028  ).    for dim, (
-000160c0: 5f2c 205f 2c20 6429 2069 6e20 656e 756d  _, _, d) in enum
-000160d0: 6572 6174 6528 7061 6464 696e 675f 636f  erate(padding_co
-000160e0: 6e66 6967 293a 0a20 2020 2020 2020 2067  nfig):.        g
-000160f0: 203d 2073 6c69 6365 5f69 6e5f 6469 6d28   = slice_in_dim(
-00016100: 672c 2030 2c20 672e 7368 6170 655b 6469  g, 0, g.shape[di
-00016110: 6d5d 2c20 7374 7269 6465 3d64 202b 2031  m], stride=d + 1
-00016120: 2c20 6469 6d3d 6469 6d29 0a0a 2020 2020  , dim=dim)..    
-00016130: 7265 7475 726e 2067 0a0a 0a40 7265 6769  return g...@regi
-00016140: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
-00016150: 6f72 7761 7264 2870 7269 6d73 2e50 7269  orward(prims.Pri
-00016160: 6d49 4473 2e50 524f 4429 0a64 6566 2070  mIDs.PROD).def p
-00016170: 726f 645f 6175 675f 6677 6428 782c 2064  rod_aug_fwd(x, d
-00016180: 696d 7329 3a0a 2020 2020 2222 2241 7567  ims):.    """Aug
-00016190: 6d65 6e74 6564 2070 726f 6420 6f70 6572  mented prod oper
-000161a0: 6174 696f 6e2e 0a0a 2020 2020 4172 6773  ation...    Args
-000161b0: 3a0a 2020 2020 2020 2020 7820 2856 6172  :.        x (Var
-000161c0: 6961 626c 6529 3a20 5465 6e73 6f72 2074  iable): Tensor t
-000161d0: 6f20 6265 206d 756c 7469 706c 6965 642e  o be multiplied.
-000161e0: 0a20 2020 2020 2020 2064 696d 7320 2854  .        dims (T
-000161f0: 7570 6c65 5b69 6e74 2c20 2e2e 2e5d 293a  uple[int, ...]):
-00016200: 2044 696d 656e 7369 6f6e 7320 746f 2062   Dimensions to b
-00016210: 6520 6d75 6c74 6970 6c69 6564 2e0a 0a20  e multiplied... 
-00016220: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00016230: 2020 2020 564a 5044 7561 6c3a 2050 7269      VJPDual: Pri
-00016240: 6d61 6c20 616e 6420 7265 7369 6475 616c  mal and residual
-00016250: 732e 0a20 2020 2022 2222 0a20 2020 2070  s..    """.    p
-00016260: 7269 6d61 6c20 3d20 7072 696d 732e 7072  rimal = prims.pr
-00016270: 6f64 2878 2c20 6469 6d73 290a 0a20 2020  od(x, dims)..   
-00016280: 2072 6573 6964 7561 6c73 203d 2028 0a20   residuals = (. 
-00016290: 2020 2020 2020 2070 7269 6d61 6c2c 0a20         primal,. 
-000162a0: 2020 2020 2020 2078 2c0a 2020 2020 2020         x,.      
-000162b0: 2020 782e 7368 6170 652c 0a20 2020 2020    x.shape,.     
-000162c0: 2020 2064 696d 732c 0a20 2020 2029 0a20     dims,.    ). 
-000162d0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
-000162e0: 6c28 7072 696d 616c 2c20 7265 7369 6475  l(primal, residu
-000162f0: 616c 7329 0a0a 0a40 7265 6769 7374 6572  als)...@register
-00016300: 5f62 6163 6b77 6172 6428 7072 696d 732e  _backward(prims.
-00016310: 5072 696d 4944 732e 5052 4f44 290a 6465  PrimIDs.PROD).de
-00016320: 6620 7072 6f64 5f70 756c 6c62 6163 6b28  f prod_pullback(
-00016330: 7072 696d 616c 2c20 782c 2078 5f73 6861  primal, x, x_sha
-00016340: 7065 2c20 7265 6475 6365 645f 6469 6d73  pe, reduced_dims
-00016350: 2c20 6729 3a0a 2020 2020 7265 7475 726e  , g):.    return
-00016360: 2070 7269 6d73 2e64 6976 2872 6573 746f   prims.div(resto
-00016370: 7265 5f72 6564 7563 6564 5f64 696d 7328  re_reduced_dims(
-00016380: 7072 696d 616c 202a 2067 2c20 7265 6475  primal * g, redu
-00016390: 6365 645f 6469 6d73 2c20 785f 7368 6170  ced_dims, x_shap
-000163a0: 6529 2c20 7829 0a0a 0a64 6566 206b 6565  e), x)...def kee
-000163b0: 7064 696d 5f72 6564 7563 7469 6f6e 2872  pdim_reduction(r
-000163c0: 6564 7563 7469 6f6e 5f66 6e2c 2078 2c20  eduction_fn, x, 
-000163d0: 6469 6d73 293a 0a20 2020 2022 2222 4170  dims):.    """Ap
-000163e0: 706c 6965 7320 7265 6475 6374 696f 6e20  plies reduction 
-000163f0: 616e 6420 6669 7865 7320 6f75 7470 7574  and fixes output
-00016400: 2074 6f20 636f 6e66 6f72 6d20 746f 206b   to conform to k
-00016410: 6565 7064 696d 3d54 7275 6522 2222 0a20  eepdim=True""". 
-00016420: 2020 206f 7574 203d 2072 6564 7563 7469     out = reducti
-00016430: 6f6e 5f66 6e28 782c 2064 696d 7329 0a20  on_fn(x, dims). 
-00016440: 2020 2061 7267 6d61 785f 7375 6d5f 6f75     argmax_sum_ou
-00016450: 745f 7368 6170 6520 3d20 5b78 2e73 6861  t_shape = [x.sha
-00016460: 7065 5b69 5d20 6966 2069 206e 6f74 2069  pe[i] if i not i
-00016470: 6e20 6469 6d73 2065 6c73 6520 3120 666f  n dims else 1 fo
-00016480: 7220 6920 696e 2072 616e 6765 2878 2e6e  r i in range(x.n
-00016490: 6469 6d29 5d0a 2020 2020 6272 6f61 6463  dim)].    broadc
-000164a0: 6173 745f 6469 6d73 203d 205b 6920 666f  ast_dims = [i fo
-000164b0: 7220 6920 696e 2072 616e 6765 2878 2e6e  r i in range(x.n
-000164c0: 6469 6d29 2069 6620 6920 6e6f 7420 696e  dim) if i not in
-000164d0: 2064 696d 735d 0a20 2020 2072 6574 7572   dims].    retur
-000164e0: 6e20 7072 696d 732e 6272 6f61 6463 6173  n prims.broadcas
-000164f0: 745f 696e 5f64 696d 286f 7574 2c20 6172  t_in_dim(out, ar
-00016500: 676d 6178 5f73 756d 5f6f 7574 5f73 6861  gmax_sum_out_sha
-00016510: 7065 2c20 6272 6f61 6463 6173 745f 6469  pe, broadcast_di
-00016520: 6d73 290a 0a0a 2320 496e 7370 6972 6564  ms)...# Inspired
-00016530: 2066 726f 6d20 6874 7470 733a 2f2f 6769   from https://gi
-00016540: 7468 7562 2e63 6f6d 2f48 4950 532f 6175  thub.com/HIPS/au
-00016550: 746f 6772 6164 2f62 6c6f 622f 6d61 7374  tograd/blob/mast
-00016560: 6572 2f61 7574 6f67 7261 642f 6e75 6d70  er/autograd/nump
-00016570: 792f 6e75 6d70 795f 766a 7073 2e70 7923  y/numpy_vjps.py#
-00016580: 4c33 3533 0a64 6566 2067 7261 645f 6368  L353.def grad_ch
-00016590: 6f6f 7365 725f 6261 636b 7761 7264 2870  ooser_backward(p
-000165a0: 7269 6d61 6c2c 2078 2c20 785f 7368 6170  rimal, x, x_shap
-000165b0: 652c 2072 6564 7563 6564 5f64 696d 732c  e, reduced_dims,
-000165c0: 2067 293a 0a20 2020 2022 2222 4275 696c   g):.    """Buil
-000165d0: 6473 2067 7261 6469 656e 7420 6f66 2066  ds gradient of f
-000165e0: 756e 6374 696f 6e73 2074 6861 7420 6368  unctions that ch
-000165f0: 6f6f 7365 2061 2073 696e 676c 6520 6974  oose a single it
-00016600: 656d 2c20 7375 6368 2061 7320 6d69 6e20  em, such as min 
-00016610: 6f72 206d 6178 2e22 2222 0a20 2020 2067  or max.""".    g
-00016620: 5f72 6570 6561 7465 6420 3d20 7265 7374  _repeated = rest
-00016630: 6f72 655f 7265 6475 6365 645f 6469 6d73  ore_reduced_dims
-00016640: 2867 2c20 7265 6475 6365 645f 6469 6d73  (g, reduced_dims
-00016650: 2c20 785f 7368 6170 6529 0a20 2020 2070  , x_shape).    p
-00016660: 7269 6d61 6c5f 7265 7065 6174 6564 203d  rimal_repeated =
-00016670: 2072 6573 746f 7265 5f72 6564 7563 6564   restore_reduced
-00016680: 5f64 696d 7328 7072 696d 616c 2c20 7265  _dims(primal, re
-00016690: 6475 6365 645f 6469 6d73 2c20 785f 7368  duced_dims, x_sh
-000166a0: 6170 6529 0a20 2020 2061 7267 6d61 785f  ape).    argmax_
-000166b0: 6c6f 6361 7469 6f6e 7320 3d20 7820 3d3d  locations = x ==
-000166c0: 2070 7269 6d61 6c5f 7265 7065 6174 6564   primal_repeated
-000166d0: 0a20 2020 2061 7267 6d61 785f 7375 6d20  .    argmax_sum 
-000166e0: 3d20 6b65 6570 6469 6d5f 7265 6475 6374  = keepdim_reduct
-000166f0: 696f 6e28 7072 696d 732e 7375 6d2c 2061  ion(prims.sum, a
-00016700: 7267 6d61 785f 6c6f 6361 7469 6f6e 732c  rgmax_locations,
-00016710: 2072 6564 7563 6564 5f64 696d 7329 0a20   reduced_dims). 
-00016720: 2020 206f 7574 203d 2067 5f72 6570 6561     out = g_repea
-00016730: 7465 6420 2a20 6172 676d 6178 5f6c 6f63  ted * argmax_loc
-00016740: 6174 696f 6e73 202f 2061 7267 6d61 785f  ations / argmax_
-00016750: 7375 6d0a 2020 2020 7265 7475 726e 206f  sum.    return o
-00016760: 7574 0a0a 0a72 6567 6973 7465 725f 6261  ut...register_ba
-00016770: 636b 7761 7264 2870 7269 6d73 2e50 7269  ckward(prims.Pri
-00016780: 6d49 4473 2e41 4d49 4e29 2867 7261 645f  mIDs.AMIN)(grad_
-00016790: 6368 6f6f 7365 725f 6261 636b 7761 7264  chooser_backward
-000167a0: 290a 0a0a 4072 6567 6973 7465 725f 6175  )...@register_au
-000167b0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
-000167c0: 7072 696d 732e 5072 696d 4944 732e 414d  prims.PrimIDs.AM
-000167d0: 494e 290a 6465 6620 616d 696e 5f61 7567  IN).def amin_aug
-000167e0: 5f66 7764 2878 2c20 6469 6d73 293a 0a20  _fwd(x, dims):. 
-000167f0: 2020 2022 2222 4175 676d 656e 7465 6420     """Augmented 
-00016800: 616d 696e 206f 7065 7261 7469 6f6e 2e0a  amin operation..
-00016810: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00016820: 2020 7820 2856 6172 6961 626c 6529 3a20    x (Variable): 
-00016830: 5465 6e73 6f72 2074 6f20 636f 6d70 7574  Tensor to comput
-00016840: 6520 616d 696e 206f 6e2e 0a20 2020 2020  e amin on..     
-00016850: 2020 2064 696d 7320 2854 7570 6c65 5b69     dims (Tuple[i
-00016860: 6e74 2c20 2e2e 2e5d 293a 2044 696d 656e  nt, ...]): Dimen
-00016870: 7369 6f6e 7320 746f 2063 6f6d 7075 7465  sions to compute
-00016880: 2061 6d69 6e20 6f76 6572 2e0a 2020 2020   amin over..    
-00016890: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-000168a0: 2056 4a50 4475 616c 3a20 5072 696d 616c   VJPDual: Primal
-000168b0: 2061 6e64 2072 6573 6964 7561 6c73 2e0a   and residuals..
-000168c0: 2020 2020 2222 220a 2020 2020 7072 696d      """.    prim
-000168d0: 616c 203d 2070 7269 6d73 2e61 6d69 6e28  al = prims.amin(
-000168e0: 782c 2064 696d 7329 0a0a 2020 2020 7265  x, dims)..    re
-000168f0: 7369 6475 616c 7320 3d20 280a 2020 2020  siduals = (.    
-00016900: 2020 2020 7072 696d 616c 2c0a 2020 2020      primal,.    
-00016910: 2020 2020 782c 0a20 2020 2020 2020 2078      x,.        x
-00016920: 2e73 6861 7065 2c0a 2020 2020 2020 2020  .shape,.        
-00016930: 6469 6d73 2c0a 2020 2020 290a 0a20 2020  dims,.    )..   
-00016940: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
-00016950: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
-00016960: 7329 0a0a 0a40 7265 6769 7374 6572 5f61  s)...@register_a
-00016970: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-00016980: 2870 7269 6d73 2e50 7269 6d49 4473 2e50  (prims.PrimIDs.P
-00016990: 4f57 290a 6465 6620 706f 775f 6175 675f  OW).def pow_aug_
-000169a0: 6665 6428 782c 2079 293a 0a20 2020 2022  fed(x, y):.    "
-000169b0: 2222 4175 676d 656e 7465 6420 7468 6520  ""Augmented the 
-000169c0: 706f 7720 6f70 6572 6174 696f 6e2e 0a0a  pow operation...
-000169d0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-000169e0: 2020 7820 2856 6172 6961 626c 6529 3a20    x (Variable): 
-000169f0: 5465 6e73 6f72 2077 6974 6820 7468 6520  Tensor with the 
-00016a00: 6261 7365 2074 6f20 6265 2065 7870 6f6e  base to be expon
-00016a10: 656e 7469 6174 6564 2e0a 2020 2020 2020  entiated..      
-00016a20: 2020 7920 2856 6172 6961 626c 6529 3a20    y (Variable): 
-00016a30: 5465 6e73 6f72 2077 6974 6820 706f 7765  Tensor with powe
-00016a40: 7220 746f 2072 6169 7365 2074 6f2e 0a0a  r to raise to...
-00016a50: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-00016a60: 2020 2020 2056 4a50 4475 616c 3a20 5072       VJPDual: Pr
-00016a70: 696d 616c 2061 6e64 2072 6573 6964 7561  imal and residua
-00016a80: 6c73 2e0a 2020 2020 2222 220a 2020 2020  ls..    """.    
-00016a90: 7072 696d 616c 203d 2070 7269 6d73 2e70  primal = prims.p
-00016aa0: 6f77 2878 2c20 7929 0a20 2020 2072 6573  ow(x, y).    res
-00016ab0: 6964 7561 6c73 203d 2028 7072 696d 616c  iduals = (primal
-00016ac0: 2c20 782c 2079 290a 2020 2020 7265 7475  , x, y).    retu
-00016ad0: 726e 2056 4a50 4475 616c 2870 7269 6d61  rn VJPDual(prima
-00016ae0: 6c2c 2072 6573 6964 7561 6c73 290a 0a0a  l, residuals)...
-00016af0: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
-00016b00: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
-00016b10: 2e50 4f57 290a 6465 6620 706f 775f 6261  .POW).def pow_ba
-00016b20: 636b 7761 7264 2872 6573 756c 742c 2078  ckward(result, x
-00016b30: 2c20 792c 2067 293a 0a20 2020 2069 6d70  , y, g):.    imp
-00016b40: 6f72 7420 7468 756e 6465 722e 636c 616e  ort thunder.clan
-00016b50: 6720 6173 2074 6c61 6e67 0a0a 2020 2020  g as tlang..    
-00016b60: 6772 6573 756c 7420 3d20 6720 2a20 7265  gresult = g * re
-00016b70: 7375 6c74 2020 2320 7265 7573 6520 636f  sult  # reuse co
-00016b80: 6d6d 6f6e 2066 6163 746f 720a 2020 2020  mmon factor.    
-00016b90: 6478 203d 2067 202a 2079 202a 2078 202a  dx = g * y * x *
-00016ba0: 2a20 2879 202d 2031 290a 2020 2020 6479  * (y - 1).    dy
-00016bb0: 203d 2067 7265 7375 6c74 202a 2074 6c61   = gresult * tla
-00016bc0: 6e67 2e6c 6f67 2878 290a 2020 2020 7265  ng.log(x).    re
-00016bd0: 7475 726e 2064 782c 2064 790a 0a0a 4072  turn dx, dy...@r
-00016be0: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
-00016bf0: 645f 666f 7277 6172 6428 7072 696d 732e  d_forward(prims.
-00016c00: 5072 696d 4944 732e 5441 4e29 0a64 6566  PrimIDs.TAN).def
-00016c10: 2074 616e 5f61 7567 5f66 7764 2878 293a   tan_aug_fwd(x):
-00016c20: 0a20 2020 2022 2222 4175 676d 656e 7465  .    """Augmente
-00016c30: 6420 7461 6e20 6f70 6572 6174 696f 6e2e  d tan operation.
-00016c40: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00016c50: 2020 2020 7820 2856 6172 6961 626c 6529      x (Variable)
-00016c60: 3a20 5465 6e73 6f72 2074 6f20 6265 2070  : Tensor to be p
-00016c70: 6173 7365 6420 746f 2074 616e 2e0a 2020  assed to tan..  
-00016c80: 2020 2222 220a 0a20 2020 2070 7269 6d61    """..    prima
-00016c90: 6c20 3d20 7072 696d 732e 7461 6e28 7829  l = prims.tan(x)
-00016ca0: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
-00016cb0: 2028 7072 696d 616c 2c29 0a20 2020 2072   (primal,).    r
-00016cc0: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
-00016cd0: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
-00016ce0: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
-00016cf0: 6b77 6172 6428 7072 696d 732e 5072 696d  kward(prims.Prim
-00016d00: 4944 732e 5441 4e29 0a64 6566 2074 616e  IDs.TAN).def tan
-00016d10: 5f62 6163 6b77 6172 6428 7265 7375 6c74  _backward(result
-00016d20: 2c20 6729 3a0a 2020 2020 7265 7475 726e  , g):.    return
-00016d30: 2067 202a 2028 3120 2b20 7265 7375 6c74   g * (1 + result
-00016d40: 202a 2072 6573 756c 7429 0a0a 0a23 204e   * result)...# N
-00016d50: 4f54 453a 204a 6178 2075 7365 7320 6e70  OTE: Jax uses np
-00016d60: 2e61 7267 736f 7274 2069 6e20 6974 7320  .argsort in its 
-00016d70: 7472 616e 7370 6f73 6520 766a 7020 636f  transpose vjp co
-00016d80: 6d70 7574 6174 696f 6e0a 6465 6620 5f61  mputation.def _a
-00016d90: 7267 736f 7274 2873 6571 293a 0a20 2020  rgsort(seq):.   
-00016da0: 2072 6574 7572 6e20 736f 7274 6564 2872   return sorted(r
-00016db0: 616e 6765 286c 656e 2873 6571 2929 2c20  ange(len(seq)), 
-00016dc0: 6b65 793d 7365 712e 5f5f 6765 7469 7465  key=seq.__getite
-00016dd0: 6d5f 5f29 0a0a 0a40 7265 6769 7374 6572  m__)...@register
-00016de0: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
-00016df0: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
-00016e00: 2e44 4556 4943 455f 5055 5429 0a64 6566  .DEVICE_PUT).def
-00016e10: 2064 6576 6963 655f 7075 745f 6175 675f   device_put_aug_
-00016e20: 6677 6428 613a 2054 656e 736f 7250 726f  fwd(a: TensorPro
-00016e30: 7879 2c20 6465 7669 6365 3a20 4465 7669  xy, device: Devi
-00016e40: 6365 2920 2d3e 2054 656e 736f 7250 726f  ce) -> TensorPro
-00016e50: 7879 3a0a 2020 2020 7072 696d 616c 203d  xy:.    primal =
-00016e60: 2070 7269 6d73 2e64 6576 6963 655f 7075   prims.device_pu
-00016e70: 7428 612c 2064 6576 6963 6529 0a20 2020  t(a, device).   
-00016e80: 2072 6573 6964 7561 6c73 203d 2028 612e   residuals = (a.
-00016e90: 6465 7669 6365 2c29 0a20 2020 2072 6574  device,).    ret
-00016ea0: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
-00016eb0: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
-00016ec0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-00016ed0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
-00016ee0: 732e 4445 5649 4345 5f50 5554 290a 6465  s.DEVICE_PUT).de
-00016ef0: 6620 6465 7669 6365 5f70 7574 5f62 6163  f device_put_bac
-00016f00: 6b77 6172 6428 6f72 6967 5f64 6576 6963  kward(orig_devic
-00016f10: 652c 2067 293a 0a20 2020 2072 6574 7572  e, g):.    retur
-00016f20: 6e20 7072 696d 732e 6465 7669 6365 5f70  n prims.device_p
-00016f30: 7574 2867 2c20 6f72 6967 5f64 6576 6963  ut(g, orig_devic
-00016f40: 6529 2c20 4e6f 6e65 0a0a 0a40 7265 6769  e), None...@regi
-00016f50: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
-00016f60: 6f72 7761 7264 2870 7269 6d73 2e50 7269  orward(prims.Pri
-00016f70: 6d49 4473 2e43 4f4e 564f 4c55 5449 4f4e  mIDs.CONVOLUTION
-00016f80: 290a 6465 6620 636f 6e76 6f6c 7574 696f  ).def convolutio
-00016f90: 6e5f 6175 675f 6677 6428 0a20 2020 2061  n_aug_fwd(.    a
-00016fa0: 3a20 5072 6f78 792c 0a20 2020 2077 6569  : Proxy,.    wei
-00016fb0: 6768 742c 0a20 2020 2062 6961 732c 0a20  ght,.    bias,. 
-00016fc0: 2020 2073 7472 6964 652c 0a20 2020 2070     stride,.    p
-00016fd0: 6164 6469 6e67 2c0a 2020 2020 6469 6c61  adding,.    dila
-00016fe0: 7469 6f6e 2c0a 2020 2020 7472 616e 7370  tion,.    transp
-00016ff0: 6f73 6564 2c0a 2020 2020 6f75 7470 7574  osed,.    output
-00017000: 5f70 6164 6469 6e67 2c0a 2020 2020 6772  _padding,.    gr
-00017010: 6f75 7073 2c0a 293a 0a20 2020 2070 7269  oups,.):.    pri
-00017020: 6d61 6c20 3d20 636f 6e76 6f6c 7574 696f  mal = convolutio
-00017030: 6e28 612c 2077 6569 6768 742c 2062 6961  n(a, weight, bia
-00017040: 732c 2073 7472 6964 652c 2070 6164 6469  s, stride, paddi
-00017050: 6e67 2c20 6469 6c61 7469 6f6e 2c20 7472  ng, dilation, tr
-00017060: 616e 7370 6f73 6564 2c20 6f75 7470 7574  ansposed, output
-00017070: 5f70 6164 6469 6e67 2c20 6772 6f75 7073  _padding, groups
-00017080: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
-00017090: 3d20 2870 7269 6d61 6c2c 2061 2c20 7765  = (primal, a, we
-000170a0: 6967 6874 2c20 6269 6173 2c20 7374 7269  ight, bias, stri
-000170b0: 6465 2c20 7061 6464 696e 672c 2064 696c  de, padding, dil
-000170c0: 6174 696f 6e2c 2074 7261 6e73 706f 7365  ation, transpose
-000170d0: 642c 206f 7574 7075 745f 7061 6464 696e  d, output_paddin
-000170e0: 672c 2067 726f 7570 7329 0a20 2020 2072  g, groups).    r
-000170f0: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
-00017100: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
-00017110: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
-00017120: 6b77 6172 6428 7072 696d 732e 5072 696d  kward(prims.Prim
-00017130: 4944 732e 434f 4e56 4f4c 5554 494f 4e29  IDs.CONVOLUTION)
-00017140: 0a64 6566 2063 6f6e 766f 6c75 7469 6f6e  .def convolution
-00017150: 5f62 6163 6b77 6172 6428 0a20 2020 206f  _backward(.    o
-00017160: 7574 7075 743a 2050 726f 7879 2c0a 2020  utput: Proxy,.  
-00017170: 2020 696e 7075 743a 2050 726f 7879 2c0a    input: Proxy,.
-00017180: 2020 2020 7765 6967 6874 2c0a 2020 2020      weight,.    
-00017190: 6269 6173 2c0a 2020 2020 7374 7269 6465  bias,.    stride
-000171a0: 2c0a 2020 2020 7061 6464 696e 672c 0a20  ,.    padding,. 
-000171b0: 2020 2064 696c 6174 696f 6e2c 0a20 2020     dilation,.   
-000171c0: 2074 7261 6e73 706f 7365 642c 0a20 2020   transposed,.   
-000171d0: 206f 7574 7075 745f 7061 6464 696e 672c   output_padding,
-000171e0: 0a20 2020 2067 726f 7570 732c 0a20 2020  .    groups,.   
-000171f0: 2067 7261 642c 0a29 3a0a 2020 2020 2320   grad,.):.    # 
-00017200: 5472 616e 7370 6f73 6564 2063 6f6e 766f  Transposed convo
-00017210: 6c75 7469 6f6e 2069 7320 6e6f 7420 7375  lution is not su
-00017220: 7070 6f72 7465 6421 0a20 2020 2061 7373  pported!.    ass
-00017230: 6572 7420 7472 616e 7370 6f73 6564 203d  ert transposed =
-00017240: 3d20 300a 0a20 2020 2069 6e70 7574 5f67  = 0..    input_g
-00017250: 7261 6420 3d20 4e6f 6e65 0a20 2020 2077  rad = None.    w
-00017260: 6569 6768 745f 6772 6164 203d 204e 6f6e  eight_grad = Non
-00017270: 650a 2020 2020 6269 6173 5f67 7261 6420  e.    bias_grad 
-00017280: 3d20 4e6f 6e65 0a0a 2020 2020 2320 5368  = None..    # Sh
-00017290: 6f72 7420 6369 7263 7569 7420 6f6e 207a  ort circuit on z
-000172a0: 6572 6f2d 6469 6d20 6772 6164 0a20 2020  ero-dim grad.   
-000172b0: 2069 6620 616e 7928 7320 3d3d 2030 2066   if any(s == 0 f
-000172c0: 6f72 2073 2069 6e20 6772 6164 2e73 6861  or s in grad.sha
-000172d0: 7065 293a 0a20 2020 2020 2020 2069 6e70  pe):.        inp
-000172e0: 7574 5f67 7261 6420 3d20 6675 6c6c 5f6c  ut_grad = full_l
-000172f0: 696b 6528 696e 7075 742c 2066 696c 6c5f  ike(input, fill_
-00017300: 7661 6c75 653d 3029 0a20 2020 2020 2020  value=0).       
-00017310: 2077 6569 6768 745f 6772 6164 203d 2066   weight_grad = f
-00017320: 756c 6c5f 6c69 6b65 2877 6569 6768 742c  ull_like(weight,
-00017330: 2066 696c 6c5f 7661 6c75 653d 3029 0a20   fill_value=0). 
-00017340: 2020 2020 2020 2069 6620 6269 6173 2069         if bias i
-00017350: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00017360: 2020 2020 2020 2020 6269 6173 5f67 7261          bias_gra
-00017370: 6420 3d20 6675 6c6c 5f6c 696b 6528 6269  d = full_like(bi
-00017380: 6173 2c20 6669 6c6c 5f76 616c 7565 3d30  as, fill_value=0
-00017390: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000173a0: 2028 696e 7075 745f 6772 6164 2c20 7765   (input_grad, we
-000173b0: 6967 6874 5f67 7261 642c 2062 6961 735f  ight_grad, bias_
-000173c0: 6772 6164 2920 2b20 2828 4e6f 6e65 2c29  grad) + ((None,)
-000173d0: 202a 2036 290a 0a20 2020 2062 6174 6368   * 6)..    batch
-000173e0: 2c20 696e 5f63 6861 6e6e 656c 732c 202a  , in_channels, *
-000173f0: 7370 6174 6961 6c5f 6469 6d73 203d 2069  spatial_dims = i
-00017400: 6e70 7574 2e73 6861 7065 0a20 2020 206f  nput.shape.    o
-00017410: 7574 5f63 6861 6e6e 656c 732c 2067 696e  ut_channels, gin
-00017420: 5f63 6861 6e6e 656c 732c 202a 6b65 726e  _channels, *kern
-00017430: 656c 5f64 696d 7320 3d20 7765 6967 6874  el_dims = weight
-00017440: 2e73 6861 7065 0a20 2020 2064 696d 203d  .shape.    dim =
-00017450: 206c 656e 2873 7061 7469 616c 5f64 696d   len(spatial_dim
-00017460: 7329 0a0a 2020 2020 6465 6620 6d61 7962  s)..    def mayb
-00017470: 655f 6578 7061 6e64 5f73 6571 2873 2c20  e_expand_seq(s, 
-00017480: 6469 6d29 3a0a 2020 2020 2020 2020 6966  dim):.        if
-00017490: 206c 656e 2873 2920 3d3d 2031 3a0a 2020   len(s) == 1:.  
-000174a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000174b0: 2028 735b 305d 2c29 202a 2064 696d 0a20   (s[0],) * dim. 
-000174c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000174d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000174e0: 730a 0a20 2020 2073 7472 6964 6520 3d20  s..    stride = 
-000174f0: 6d61 7962 655f 6578 7061 6e64 5f73 6571  maybe_expand_seq
-00017500: 2873 7472 6964 652c 2064 696d 290a 2020  (stride, dim).  
-00017510: 2020 7061 6464 696e 6720 3d20 6d61 7962    padding = mayb
-00017520: 655f 6578 7061 6e64 5f73 6571 2870 6164  e_expand_seq(pad
-00017530: 6469 6e67 2c20 6469 6d29 0a20 2020 2064  ding, dim).    d
-00017540: 696c 6174 696f 6e20 3d20 6d61 7962 655f  ilation = maybe_
-00017550: 6578 7061 6e64 5f73 6571 2864 696c 6174  expand_seq(dilat
-00017560: 696f 6e2c 2064 696d 290a 0a20 2020 2064  ion, dim)..    d
-00017570: 6566 2063 6f6e 765f 7472 616e 7370 6f73  ef conv_transpos
-00017580: 6528 7429 3a0a 2020 2020 2020 2020 7265  e(t):.        re
-00017590: 7475 726e 2070 7269 6d73 2e74 7261 6e73  turn prims.trans
-000175a0: 706f 7365 2874 2c20 2831 2c20 3029 202b  pose(t, (1, 0) +
-000175b0: 2074 7570 6c65 2872 616e 6765 2832 2c20   tuple(range(2, 
-000175c0: 742e 6e64 696d 2929 290a 0a20 2020 2023  t.ndim)))..    #
-000175d0: 2069 6e70 7574 5f67 7261 6420 3d20 7b0a   input_grad = {.
-000175e0: 2020 2020 6465 6620 7472 616e 7370 6f73      def transpos
-000175f0: 655f 616e 645f 666c 6970 5f77 6569 6768  e_and_flip_weigh
-00017600: 7428 7765 6967 6874 293a 0a20 2020 2020  t(weight):.     
-00017610: 2020 2023 2054 6865 206c 696e 6573 2062     # The lines b
-00017620: 656c 6f77 2061 7265 2074 7261 6e73 706f  elow are transpo
-00017630: 7369 6e67 2074 6865 2063 6861 6e6e 656c  sing the channel
-00017640: 7320 6469 6d73 2e0a 2020 2020 2020 2020  s dims..        
-00017650: 2320 5765 2061 6c73 6f20 6e65 6564 2074  # We also need t
-00017660: 6f20 6578 7472 6163 7420 7468 6520 6772  o extract the gr
-00017670: 6f75 7020 696e 666f 726d 6174 696f 6e20  oup information 
-00017680: 616e 6420 6d65 7267 6520 6974 0a20 2020  and merge it.   
-00017690: 2020 2020 2023 2077 6974 6820 7468 6520       # with the 
-000176a0: 6469 6d65 6e73 696f 6e20 636f 7272 6573  dimension corres
-000176b0: 706f 6e64 696e 6720 746f 2074 6865 2022  ponding to the "
-000176c0: 6f75 745f 6368 616e 6e65 6c73 2220 6469  out_channels" di
-000176d0: 6d2e 0a20 2020 2020 2020 2023 2028 6f75  m..        # (ou
-000176e0: 745f 6368 616e 6e65 6c73 2c20 6769 6e5f  t_channels, gin_
-000176f0: 6368 616e 6e65 6c73 2920 2d3e 2028 6769  channels) -> (gi
-00017700: 6e5f 6368 616e 6e65 6c73 2c20 6f75 745f  n_channels, out_
-00017710: 6368 616e 6e65 6c73 290a 2020 2020 2020  channels).      
-00017720: 2020 7765 6967 6874 203d 2063 6f6e 765f    weight = conv_
-00017730: 7472 616e 7370 6f73 6528 7765 6967 6874  transpose(weight
-00017740: 290a 2020 2020 2020 2020 2320 5370 6c69  ).        # Spli
-00017750: 7420 286f 7574 5f63 6861 6e6e 656c 732c  t (out_channels,
-00017760: 2920 2d3e 2028 6772 6f75 7073 2c20 6f75  ) -> (groups, ou
-00017770: 745f 6368 616e 6e65 6c73 202f 2f20 6772  t_channels // gr
-00017780: 6f75 7073 290a 2020 2020 2020 2020 7765  oups).        we
-00017790: 6967 6874 203d 2077 6569 6768 742e 7265  ight = weight.re
-000177a0: 7368 6170 6528 5b67 696e 5f63 6861 6e6e  shape([gin_chann
-000177b0: 656c 732c 2067 726f 7570 732c 206f 7574  els, groups, out
-000177c0: 5f63 6861 6e6e 656c 7320 2f2f 2067 726f  _channels // gro
-000177d0: 7570 735d 202b 206b 6572 6e65 6c5f 6469  ups] + kernel_di
-000177e0: 6d73 290a 2020 2020 2020 2020 2320 4d6f  ms).        # Mo
-000177f0: 7669 6e67 2067 726f 7570 7320 746f 2074  ving groups to t
-00017800: 6865 206c 6566 742d 6d6f 7374 2070 6f73  he left-most pos
-00017810: 6974 696f 6e2e 0a20 2020 2020 2020 2023  ition..        #
-00017820: 2028 6769 6e5f 6368 616e 6e65 6c73 2c20   (gin_channels, 
-00017830: 6772 6f75 7073 2c20 6f75 745f 6368 616e  groups, out_chan
-00017840: 6e65 6c73 202f 2f20 6772 6f75 7073 2920  nels // groups) 
-00017850: 2d3e 2028 6772 6f75 7073 2c20 6769 6e5f  -> (groups, gin_
-00017860: 6368 616e 6e65 6c73 2c20 6f75 745f 6368  channels, out_ch
-00017870: 616e 6e65 6c73 202f 2f20 6772 6f75 7073  annels // groups
-00017880: 290a 2020 2020 2020 2020 7765 6967 6874  ).        weight
-00017890: 203d 2063 6f6e 765f 7472 616e 7370 6f73   = conv_transpos
-000178a0: 6528 7765 6967 6874 290a 2020 2020 2020  e(weight).      
-000178b0: 2020 2320 5371 7561 7368 2028 6772 6f75    # Squash (grou
-000178c0: 7073 2c20 6769 6e5f 6368 616e 6e65 6c73  ps, gin_channels
-000178d0: 2920 2d3e 2028 696e 5f63 6861 6e6e 656c  ) -> (in_channel
-000178e0: 7329 0a20 2020 2020 2020 2077 6569 6768  s).        weigh
-000178f0: 7420 3d20 7765 6967 6874 2e72 6573 6861  t = weight.resha
-00017900: 7065 285b 696e 5f63 6861 6e6e 656c 732c  pe([in_channels,
-00017910: 206f 7574 5f63 6861 6e6e 656c 7320 2f2f   out_channels //
-00017920: 2067 726f 7570 735d 202b 206b 6572 6e65   groups] + kerne
-00017930: 6c5f 6469 6d73 290a 0a20 2020 2020 2020  l_dims)..       
-00017940: 2023 2046 6c69 7020 7370 6174 6961 6c20   # Flip spatial 
-00017950: 6469 6d65 6e73 696f 6e73 0a20 2020 2020  dimensions.     
-00017960: 2020 2077 6569 6768 7420 3d20 7072 696d     weight = prim
-00017970: 732e 666c 6970 2877 6569 6768 742c 2074  s.flip(weight, t
-00017980: 7570 6c65 2872 616e 6765 2832 2c20 7765  uple(range(2, we
-00017990: 6967 6874 2e6e 6469 6d29 2929 0a20 2020  ight.ndim))).   
-000179a0: 2020 2020 2072 6574 7572 6e20 7765 6967       return weig
-000179b0: 6874 0a0a 2020 2020 2320 5765 206e 6565  ht..    # We nee
-000179c0: 6420 746f 2070 6164 2074 6865 2067 7261  d to pad the gra
-000179d0: 6469 656e 7420 746f 2062 6520 6162 6c65  dient to be able
-000179e0: 2074 6f20 6669 7420 6b65 726e 656c 2077   to fit kernel w
-000179f0: 696e 646f 7773 2e0a 2020 2020 696e 6974  indows..    init
-00017a00: 6961 6c5f 6772 6164 5f70 6164 6469 6e67  ial_grad_padding
-00017a10: 203d 205b 6420 2a20 286b 202d 2031 2920   = [d * (k - 1) 
-00017a20: 666f 7220 642c 206b 2069 6e20 7a69 7028  for d, k in zip(
-00017a30: 6469 6c61 7469 6f6e 2c20 6b65 726e 656c  dilation, kernel
-00017a40: 5f64 696d 7329 5d0a 0a20 2020 2069 6e70  _dims)]..    inp
-00017a50: 7574 5f67 7261 6420 3d20 636f 6e76 6f6c  ut_grad = convol
-00017a60: 7574 696f 6e28 0a20 2020 2020 2020 2070  ution(.        p
-00017a70: 7269 6d73 2e70 6164 280a 2020 2020 2020  rims.pad(.      
-00017a80: 2020 2020 2020 6772 6164 2c0a 2020 2020        grad,.    
-00017a90: 2020 2020 2020 2020 302e 302c 0a20 2020          0.0,.   
-00017aa0: 2020 2020 2020 2020 2023 2054 6865 2070           # The p
-00017ab0: 6978 6573 2061 7265 2073 7472 6964 6520  ixes are stride 
-00017ac0: 6177 6179 2066 726f 6d20 6561 6368 206f  away from each o
-00017ad0: 7468 6572 2069 6e20 7468 6520 6f72 6967  ther in the orig
-00017ae0: 696e 616c 2069 6e70 7574 2e0a 2020 2020  inal input..    
-00017af0: 2020 2020 2020 2020 2320 4865 6e63 6520          # Hence 
-00017b00: 7765 206e 6565 6420 746f 2064 696c 6174  we need to dilat
-00017b10: 6520 7468 6520 6772 6164 6965 6e74 2062  e the gradient b
-00017b20: 7920 6469 6c61 7469 6f6e 3d73 7472 6964  y dilation=strid
-00017b30: 6520 2d20 310a 2020 2020 2020 2020 2020  e - 1.          
-00017b40: 2020 2320 736f 2074 6861 7420 7468 6572    # so that ther
-00017b50: 6520 6172 6520 7374 7269 6465 202d 2031  e are stride - 1
-00017b60: 207a 6572 6f73 2062 6574 7765 656e 2074   zeros between t
-00017b70: 6865 2070 6978 656c 732e 0a20 2020 2020  he pixels..     
-00017b80: 2020 2020 2020 205b 2830 2c20 302c 2030         [(0, 0, 0
-00017b90: 292c 2028 302c 2030 2c20 3029 5d20 2b20  ), (0, 0, 0)] + 
-00017ba0: 5b28 302c 2030 2c20 7320 2d20 3129 2066  [(0, 0, s - 1) f
-00017bb0: 6f72 2073 2069 6e20 7374 7269 6465 5d2c  or s in stride],
-00017bc0: 0a20 2020 2020 2020 2029 2c0a 2020 2020  .        ),.    
-00017bd0: 2020 2020 7472 616e 7370 6f73 655f 616e      transpose_an
-00017be0: 645f 666c 6970 5f77 6569 6768 7428 7765  d_flip_weight(we
-00017bf0: 6967 6874 292c 0a20 2020 2020 2020 204e  ight),.        N
-00017c00: 6f6e 652c 0a20 2020 2020 2020 2023 2053  one,.        # S
-00017c10: 6574 7469 6e67 2073 7472 6964 6520 746f  etting stride to
-00017c20: 2031 2061 7320 7468 6520 6469 7374 616e   1 as the distan
-00017c30: 6365 2062 6574 7765 656e 2070 6978 656c  ce between pixel
-00017c40: 7320 6973 2074 616b 656e 0a20 2020 2020  s is taken.     
-00017c50: 2020 2023 2063 6172 6520 6279 2074 6865     # care by the
-00017c60: 2070 6164 2072 6967 6874 2061 626f 7665   pad right above
-00017c70: 2e0a 2020 2020 2020 2020 2831 2c29 2c0a  ..        (1,),.
-00017c80: 2020 2020 2020 2020 696e 6974 6961 6c5f          initial_
-00017c90: 6772 6164 5f70 6164 6469 6e67 2c0a 2020  grad_padding,.  
-00017ca0: 2020 2020 2020 6469 6c61 7469 6f6e 2c0a        dilation,.
-00017cb0: 2020 2020 2020 2020 7472 616e 7370 6f73          transpos
-00017cc0: 6564 2c0a 2020 2020 2020 2020 6f75 7470  ed,.        outp
-00017cd0: 7574 5f70 6164 6469 6e67 2c0a 2020 2020  ut_padding,.    
-00017ce0: 2020 2020 6772 6f75 7073 2c0a 2020 2020      groups,.    
-00017cf0: 290a 0a20 2020 2064 6566 2070 6164 5f74  )..    def pad_t
-00017d00: 6f5f 696e 7075 7428 6772 6164 293a 0a20  o_input(grad):. 
-00017d10: 2020 2020 2020 2023 2057 6520 6e65 6564         # We need
-00017d20: 2074 6f20 756e 7061 6420 7468 6520 7061   to unpad the pa
-00017d30: 6464 696e 6720 646f 6e65 2074 6f20 7468  dding done to th
-00017d40: 6520 696e 7075 7420 7072 696f 7220 746f  e input prior to
-00017d50: 2074 6865 2063 6f6e 766f 6c75 7469 6f6e   the convolution
-00017d60: 2e0a 2020 2020 2020 2020 2320 4e6f 7465  ..        # Note
-00017d70: 2074 6861 7420 6c6f 7720 616e 6420 6869   that low and hi
-00017d80: 6768 2070 6164 6469 6e67 2061 7265 206e  gh padding are n
-00017d90: 6f74 206e 6563 6573 7361 7269 6c79 2065  ot necessarily e
-00017da0: 7175 616c 2c20 736f 2077 6520 6361 6e6e  qual, so we cann
-00017db0: 6f74 0a20 2020 2020 2020 2023 2061 6273  ot.        # abs
-00017dc0: 6f72 6220 6974 2069 6e74 6f20 7468 6520  orb it into the 
-00017dd0: 636f 6e76 6f6c 7574 696f 6e20 6a75 7374  convolution just
-00017de0: 2079 6574 2c20 756e 6c65 7373 2074 6865   yet, unless the
-00017df0: 2041 5049 2069 7320 6d6f 6469 6669 6564   API is modified
-00017e00: 2e0a 2020 2020 2020 2020 7061 645f 636f  ..        pad_co
-00017e10: 6e66 6967 203d 205b 2830 2c20 302c 2030  nfig = [(0, 0, 0
-00017e20: 292c 2028 302c 2030 2c20 3029 5d0a 2020  ), (0, 0, 0)].  
-00017e30: 2020 2020 2020 666f 7220 6f2c 2069 2c20        for o, i, 
-00017e40: 672c 2070 2069 6e20 7a69 7028 6772 6164  g, p in zip(grad
-00017e50: 2e73 6861 7065 5b32 3a5d 2c20 7370 6174  .shape[2:], spat
-00017e60: 6961 6c5f 6469 6d73 2c20 696e 7075 745f  ial_dims, input_
-00017e70: 6772 6164 2e73 6861 7065 5b32 3a5d 2c20  grad.shape[2:], 
-00017e80: 7061 6464 696e 6729 3a0a 2020 2020 2020  padding):.      
-00017e90: 2020 2020 2020 6c6f 203d 202d 700a 2020        lo = -p.  
-00017ea0: 2020 2020 2020 2020 2020 2320 4e6f 7465            # Note
-00017eb0: 2074 6861 7420 2869 202b 2032 202a 2070   that (i + 2 * p
-00017ec0: 2920 6973 2074 6865 2073 697a 6520 6f66  ) is the size of
-00017ed0: 2074 6865 2070 6164 6465 6420 696e 7075   the padded inpu
-00017ee0: 742c 0a20 2020 2020 2020 2020 2020 2023  t,.            #
-00017ef0: 2073 6f20 7468 6520 7175 616e 7469 7479   so the quantity
-00017f00: 2028 6920 2b20 3220 2a20 7029 202d 2067   (i + 2 * p) - g
-00017f10: 2074 656c 6c73 2075 7320 6279 2068 6f77   tells us by how
-00017f20: 206d 7563 680a 2020 2020 2020 2020 2020   much.          
-00017f30: 2020 2320 7765 206e 6565 6420 746f 2070    # we need to p
-00017f40: 6164 2074 6865 2067 7261 6469 656e 7420  ad the gradient 
-00017f50: 736f 2074 6861 7420 7468 6520 656c 656d  so that the elem
-00017f60: 656e 7473 206f 7574 7369 6465 0a20 2020  ents outside.   
-00017f70: 2020 2020 2020 2020 2023 206f 6620 7468           # of th
-00017f80: 6520 636f 6e76 6f6c 7574 696f 6e20 7265  e convolution re
-00017f90: 6365 6976 6520 7a65 726f 2067 7261 6469  ceive zero gradi
-00017fa0: 656e 742e 0a20 2020 2020 2020 2020 2020  ent..           
-00017fb0: 2023 2070 2069 7320 6164 6469 7469 6f6e   # p is addition
-00017fc0: 616c 6c79 2073 7562 7472 6163 7465 6420  ally subtracted 
-00017fd0: 746f 206e 6567 6174 6520 7468 6520 696e  to negate the in
-00017fe0: 7075 7427 7320 7061 640a 2020 2020 2020  put's pad.      
-00017ff0: 2020 2020 2020 2320 696e 2066 6f72 7761        # in forwa
-00018000: 7264 2e0a 2020 2020 2020 2020 2020 2020  rd..            
-00018010: 6869 203d 2028 6920 2b20 3220 2a20 7029  hi = (i + 2 * p)
-00018020: 202d 2067 202d 2070 0a20 2020 2020 2020   - g - p.       
-00018030: 2020 2020 2070 6164 5f63 6f6e 6669 672e       pad_config.
-00018040: 6170 7065 6e64 2828 6c6f 2c20 6869 2c20  append((lo, hi, 
-00018050: 3029 290a 2020 2020 2020 2020 7265 7475  0)).        retu
-00018060: 726e 2070 7269 6d73 2e70 6164 2867 7261  rn prims.pad(gra
-00018070: 642c 2030 2e30 2c20 7061 645f 636f 6e66  d, 0.0, pad_conf
-00018080: 6967 290a 0a20 2020 2069 6e70 7574 5f67  ig)..    input_g
-00018090: 7261 6420 3d20 7061 645f 746f 5f69 6e70  rad = pad_to_inp
-000180a0: 7574 2869 6e70 7574 5f67 7261 6429 0a20  ut(input_grad). 
-000180b0: 2020 2023 207d 0a0a 2020 2020 2320 6269     # }..    # bi
-000180c0: 6173 5f67 7261 6420 3d20 7b0a 2020 2020  as_grad = {.    
-000180d0: 6966 2062 6961 7320 6973 206e 6f74 204e  if bias is not N
-000180e0: 6f6e 653a 0a20 2020 2020 2020 2069 6d70  one:.        imp
-000180f0: 6f72 7420 7468 756e 6465 722e 746f 7263  ort thunder.torc
-00018100: 6820 6173 206c 746f 7263 680a 0a20 2020  h as ltorch..   
-00018110: 2020 2020 2062 6961 735f 6772 6164 203d       bias_grad =
-00018120: 206c 746f 7263 682e 7375 6d28 6772 6164   ltorch.sum(grad
-00018130: 2c20 5b64 2066 6f72 2064 2069 6e20 7261  , [d for d in ra
-00018140: 6e67 6528 6772 6164 2e6e 6469 6d29 2069  nge(grad.ndim) i
-00018150: 6620 6420 213d 2031 5d29 0a20 2020 2023  f d != 1]).    #
-00018160: 207d 0a0a 2020 2020 2320 7765 6967 6874   }..    # weight
-00018170: 2067 7261 6420 3d20 7b0a 2020 2020 6465   grad = {.    de
-00018180: 6620 7061 645f 7472 616e 7370 6f73 655f  f pad_transpose_
-00018190: 616e 645f 7075 7368 5f67 726f 7570 735f  and_push_groups_
-000181a0: 696e 746f 5f62 6174 6368 6573 2874 293a  into_batches(t):
-000181b0: 0a20 2020 2020 2020 2023 2046 6972 7374  .        # First
-000181c0: 2070 6164 2c2e 2e2e 0a20 2020 2020 2020   pad,....       
-000181d0: 2023 2050 6164 2061 7320 6e65 6365 7373   # Pad as necess
-000181e0: 6172 7920 736f 2074 6861 7420 696e 2063  ary so that in c
-000181f0: 6f6e 766f 6c75 7469 6f6e 7320 7765 206e  onvolutions we n
-00018200: 6576 6572 2061 6476 616e 6365 0a20 2020  ever advance.   
-00018210: 2020 2020 2023 2070 6173 7420 7265 6c65       # past rele
-00018220: 7661 6e74 2069 6e70 7574 732e 0a20 2020  vant inputs..   
-00018230: 2020 2020 2070 6164 5f63 6f6e 6669 6720       pad_config 
-00018240: 3d20 5b28 302c 2030 2c20 3029 2c20 2830  = [(0, 0, 0), (0
-00018250: 2c20 302c 2030 295d 0a20 2020 2020 2020  , 0, 0)].       
-00018260: 2066 6f72 206f 2c20 692c 206b 2c20 702c   for o, i, k, p,
-00018270: 2073 2c20 6420 696e 207a 6970 2867 7261   s, d in zip(gra
-00018280: 642e 7368 6170 655b 323a 5d2c 2073 7061  d.shape[2:], spa
-00018290: 7469 616c 5f64 696d 732c 206b 6572 6e65  tial_dims, kerne
-000182a0: 6c5f 6469 6d73 2c20 7061 6464 696e 672c  l_dims, padding,
-000182b0: 2073 7472 6964 652c 2064 696c 6174 696f   stride, dilatio
-000182c0: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
-000182d0: 2320 5061 6464 696e 6720 6672 6f6d 2062  # Padding from b
-000182e0: 656c 6f77 2069 7320 7468 6520 7361 6d65  elow is the same
-000182f0: 2e0a 2020 2020 2020 2020 2020 2020 6c6f  ..            lo
-00018300: 203d 2070 0a20 2020 2020 2020 2020 2020   = p.           
-00018310: 2023 2054 6865 7265 2069 7320 616c 7761   # There is alwa
-00018320: 7973 2074 6865 206d 6178 2069 6e64 6578  ys the max index
-00018330: 2069 6478 2069 6e20 7468 6520 696e 7075   idx in the inpu
-00018340: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-00018350: 7468 6520 7661 6c75 6520 6f66 2077 6869  the value of whi
-00018360: 6368 2c20 696e 7075 745b 6964 785d 2c20  ch, input[idx], 
-00018370: 7468 6520 6b65 726e 656c 2074 6f75 6368  the kernel touch
-00018380: 6573 2e0a 2020 2020 2020 2020 2020 2020  es..            
-00018390: 2320 5468 6520 6b65 726e 656c 2072 6561  # The kernel rea
-000183a0: 6368 2c20 6f72 206b 5f72 6561 6368 2c20  ch, or k_reach, 
-000183b0: 6973 2065 7861 6374 6c79 2069 6478 202b  is exactly idx +
-000183c0: 2031 2e0a 2020 2020 2020 2020 2020 2020   1..            
-000183d0: 2320 5765 2075 7365 2069 7420 746f 2064  # We use it to d
-000183e0: 6563 6964 6520 6279 2068 6f77 206d 7563  ecide by how muc
-000183f0: 6820 7765 206e 6565 6420 746f 2070 6164  h we need to pad
-00018400: 2066 726f 6d20 6162 6f76 650a 2020 2020   from above.    
-00018410: 2020 2020 2020 2020 2320 6173 2074 6f20          # as to 
-00018420: 6e6f 7420 6d6f 7665 2070 6173 7420 7265  not move past re
-00018430: 6c65 7661 6e74 2076 616c 7565 732e 0a20  levant values.. 
-00018440: 2020 2020 2020 2020 2020 206b 5f72 6561             k_rea
-00018450: 6368 203d 2028 6f20 2d20 3129 202a 2073  ch = (o - 1) * s
-00018460: 202b 2064 202a 2028 6b20 2d20 3129 202b   + d * (k - 1) +
-00018470: 2031 0a20 2020 2020 2020 2020 2020 2023   1.            #
-00018480: 2054 6865 2070 6164 2066 726f 6d20 6162   The pad from ab
-00018490: 6f76 6520 6571 7561 6c73 206b 5f72 6561  ove equals k_rea
-000184a0: 6368 206d 696e 7573 2074 6865 206c 656e  ch minus the len
-000184b0: 6774 680a 2020 2020 2020 2020 2020 2020  gth.            
-000184c0: 2320 6f66 2074 6865 2069 6e70 7574 2070  # of the input p
-000184d0: 6164 6465 6420 6672 6f6d 2062 656c 6f77  added from below
-000184e0: 2e0a 2020 2020 2020 2020 2020 2020 6869  ..            hi
-000184f0: 203d 206b 5f72 6561 6368 202d 2028 6920   = k_reach - (i 
-00018500: 2b20 7029 0a20 2020 2020 2020 2020 2020  + p).           
-00018510: 2070 6164 5f63 6f6e 6669 672e 6170 7065   pad_config.appe
-00018520: 6e64 2828 6c6f 2c20 6869 2c20 3029 290a  nd((lo, hi, 0)).
-00018530: 2020 2020 2020 2020 7420 3d20 7072 696d          t = prim
-00018540: 732e 7061 6428 742c 2030 2e30 2c20 7061  s.pad(t, 0.0, pa
-00018550: 645f 636f 6e66 6967 290a 0a20 2020 2020  d_config)..     
-00018560: 2020 205f 2c20 5f2c 202a 745f 7370 6174     _, _, *t_spat
-00018570: 6961 6c5f 6469 6d73 203d 2074 2e73 6861  ial_dims = t.sha
-00018580: 7065 0a0a 2020 2020 2020 2020 2320 2e2e  pe..        # ..
-00018590: 2e20 7468 656e 2064 6f20 7468 6520 7265  . then do the re
-000185a0: 7374 2e0a 2020 2020 2020 2020 2320 742e  st..        # t.
-000185b0: 7368 6170 6520 3d3d 2028 6261 7463 682c  shape == (batch,
-000185c0: 2069 6e5f 6368 616e 6e65 6c73 2c20 2e2e   in_channels, ..
-000185d0: 2e29 0a20 2020 2020 2020 2023 2054 6865  .).        # The
-000185e0: 2072 6573 756c 7420 6f66 2074 6869 7320   result of this 
-000185f0: 6675 6e63 7469 6f6e 2068 6173 2073 6861  function has sha
-00018600: 7065 0a20 2020 2020 2020 2023 2028 696e  pe.        # (in
-00018610: 5f63 6861 6e6e 656c 732c 2062 6174 6368  _channels, batch
-00018620: 202a 2067 726f 7570 7329 0a20 2020 2020   * groups).     
-00018630: 2020 2023 2028 6261 7463 682c 2069 6e5f     # (batch, in_
-00018640: 6368 616e 6e65 6c73 2920 2d3e 2028 696e  channels) -> (in
-00018650: 5f63 6861 6e6e 656c 732c 2062 6174 6368  _channels, batch
-00018660: 290a 2020 2020 2020 2020 7420 3d20 636f  ).        t = co
-00018670: 6e76 5f74 7261 6e73 706f 7365 2874 290a  nv_transpose(t).
-00018680: 2020 2020 2020 2020 2320 5370 6c69 7420          # Split 
-00018690: 2869 6e5f 6368 616e 6e65 6c73 2c29 202d  (in_channels,) -
-000186a0: 3e20 2867 726f 7570 732c 2067 696e 5f63  > (groups, gin_c
-000186b0: 6861 6e6e 656c 7329 0a20 2020 2020 2020  hannels).       
-000186c0: 2074 203d 2074 2e72 6573 6861 7065 285b   t = t.reshape([
-000186d0: 6772 6f75 7073 2c20 6769 6e5f 6368 616e  groups, gin_chan
-000186e0: 6e65 6c73 2c20 6261 7463 685d 202b 2074  nels, batch] + t
-000186f0: 5f73 7061 7469 616c 5f64 696d 7329 0a20  _spatial_dims). 
-00018700: 2020 2020 2020 2023 2054 7261 6e73 706f         # Transpo
-00018710: 7365 2028 6772 6f75 7073 2c20 6769 6e5f  se (groups, gin_
-00018720: 6368 616e 6e65 6c73 2c20 6261 7463 6829  channels, batch)
-00018730: 202d 3e20 2867 696e 5f63 6861 6e6e 656c   -> (gin_channel
-00018740: 732c 2067 726f 7570 732c 2062 6174 6368  s, groups, batch
-00018750: 290a 2020 2020 2020 2020 7420 3d20 636f  ).        t = co
-00018760: 6e76 5f74 7261 6e73 706f 7365 2874 290a  nv_transpose(t).
-00018770: 2020 2020 2020 2020 2320 466c 6174 7465          # Flatte
-00018780: 6e20 2867 726f 7570 732c 2062 6174 6368  n (groups, batch
-00018790: 2920 2d3e 2028 6772 6f75 7073 202a 2062  ) -> (groups * b
-000187a0: 6174 6368 2c29 0a20 2020 2020 2020 2074  atch,).        t
-000187b0: 203d 2074 2e72 6573 6861 7065 285b 6769   = t.reshape([gi
-000187c0: 6e5f 6368 616e 6e65 6c73 2c20 6772 6f75  n_channels, grou
-000187d0: 7073 202a 2062 6174 6368 5d20 2b20 745f  ps * batch] + t_
-000187e0: 7370 6174 6961 6c5f 6469 6d73 290a 2020  spatial_dims).  
-000187f0: 2020 2020 2020 7265 7475 726e 2074 0a0a        return t..
-00018800: 2020 2020 2320 696e 7075 7420 7769 6c6c      # input will
-00018810: 2068 6176 6520 7368 6170 6520 2867 696e   have shape (gin
-00018820: 5f63 6861 6e6e 656c 732c 2067 726f 7570  _channels, group
-00018830: 7320 2a20 6261 7463 6829 0a20 2020 2069  s * batch).    i
-00018840: 6e70 7574 203d 2070 6164 5f74 7261 6e73  nput = pad_trans
-00018850: 706f 7365 5f61 6e64 5f70 7573 685f 6772  pose_and_push_gr
-00018860: 6f75 7073 5f69 6e74 6f5f 6261 7463 6865  oups_into_batche
-00018870: 7328 696e 7075 7429 0a20 2020 2023 2067  s(input).    # g
-00018880: 7261 6420 7769 6c6c 2068 6176 6520 7368  rad will have sh
-00018890: 6170 6520 286f 7574 5f63 6861 6e6e 656c  ape (out_channel
-000188a0: 732c 2062 6174 6368 290a 2020 2020 2320  s, batch).    # 
-000188b0: 4e6f 7465 2074 6861 7420 7468 6573 6520  Note that these 
-000188c0: 7368 6170 6573 2061 7265 2063 6f6d 7061  shapes are compa
-000188d0: 7469 626c 6520 666f 7220 6120 6772 6f75  tible for a grou
-000188e0: 7020 636f 6e76 6f6c 7574 696f 6e2e 0a20  p convolution.. 
-000188f0: 2020 2067 7261 6420 3d20 636f 6e76 5f74     grad = conv_t
-00018900: 7261 6e73 706f 7365 2867 7261 6429 0a0a  ranspose(grad)..
-00018910: 2020 2020 2320 5768 7920 646f 2077 6520      # Why do we 
-00018920: 666c 6970 2073 7472 6964 6520 616e 6420  flip stride and 
-00018930: 6469 6c61 7469 6f6e 3f0a 2020 2020 2320  dilation?.    # 
-00018940: 6b65 726e 656c 5b69 5d20 616e 6420 6b65  kernel[i] and ke
-00018950: 726e 656c 5b69 202b 2031 5d20 6172 6520  rnel[i + 1] are 
-00018960: 6469 6c61 7469 6f6e 2061 7061 7274 2066  dilation apart f
-00018970: 726f 6d20 6561 6368 206f 7468 6572 2c0a  rom each other,.
-00018980: 2020 2020 2320 736f 2064 696c 6174 696f      # so dilatio
-00018990: 6e20 6265 636f 6d65 7320 7468 6520 6e65  n becomes the ne
-000189a0: 7720 7374 7269 6465 2e0a 2020 2020 2320  w stride..    # 
-000189b0: 416c 6c20 7468 6520 656c 656d 656e 7473  All the elements
-000189c0: 2074 6861 7420 6b65 726e 656c 5b69 5d20   that kernel[i] 
-000189d0: 746f 7563 6865 7320 6172 6520 7374 7269  touches are stri
-000189e0: 6465 2061 7761 7920 6672 6f6d 2065 6163  de away from eac
-000189f0: 6820 6f74 6865 722c 0a20 2020 2023 2068  h other,.    # h
-00018a00: 656e 6365 2073 7472 6964 6520 6265 636f  ence stride beco
-00018a10: 6d65 7320 7468 6520 6e65 7720 6469 6c61  mes the new dila
-00018a20: 7469 6f6e 2e0a 2020 2020 7765 6967 6874  tion..    weight
-00018a30: 5f67 7261 6420 3d20 636f 6e76 6f6c 7574  _grad = convolut
-00018a40: 696f 6e28 0a20 2020 2020 2020 2069 6e70  ion(.        inp
-00018a50: 7574 2c0a 2020 2020 2020 2020 6772 6164  ut,.        grad
-00018a60: 2c0a 2020 2020 2020 2020 4e6f 6e65 2c0a  ,.        None,.
-00018a70: 2020 2020 2020 2020 6469 6c61 7469 6f6e          dilation
-00018a80: 2c20 2023 2073 6574 2073 7472 6964 653d  ,  # set stride=
-00018a90: 6469 6c61 7469 6f6e 0a20 2020 2020 2020  dilation.       
-00018aa0: 2028 302c 292c 0a20 2020 2020 2020 2073   (0,),.        s
-00018ab0: 7472 6964 652c 2020 2320 7365 7420 6469  tride,  # set di
-00018ac0: 6c61 7469 6f6e 3d73 7472 6964 650a 2020  lation=stride.  
-00018ad0: 2020 2020 2020 7472 616e 7370 6f73 6564        transposed
-00018ae0: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
-00018af0: 5f70 6164 6469 6e67 2c0a 2020 2020 2020  _padding,.      
-00018b00: 2020 6772 6f75 7073 2c0a 2020 2020 290a    groups,.    ).
-00018b10: 0a20 2020 2023 2054 6865 2072 6573 756c  .    # The resul
-00018b20: 7420 6f66 2074 6865 2063 6f6e 766f 6c75  t of the convolu
-00018b30: 7469 6f6e 2068 6173 2073 6861 7065 2028  tion has shape (
-00018b40: 6769 6e5f 6368 616e 6e65 6c73 2c20 6f75  gin_channels, ou
-00018b50: 745f 6368 616e 6e65 6c73 292c 0a20 2020  t_channels),.   
-00018b60: 2023 2073 6f20 7472 616e 7370 6f73 6974   # so transposit
-00018b70: 696f 6e20 6973 2072 6571 7569 7265 642e  ion is required.
-00018b80: 0a20 2020 2077 6569 6768 745f 6772 6164  .    weight_grad
-00018b90: 203d 2063 6f6e 765f 7472 616e 7370 6f73   = conv_transpos
-00018ba0: 6528 7765 6967 6874 5f67 7261 6429 0a20  e(weight_grad). 
-00018bb0: 2020 2023 207d 0a0a 2020 2020 7265 7475     # }..    retu
-00018bc0: 726e 2028 696e 7075 745f 6772 6164 2c20  rn (input_grad, 
-00018bd0: 7765 6967 6874 5f67 7261 642c 2062 6961  weight_grad, bia
-00018be0: 735f 6772 6164 290a 0a0a 4072 6567 6973  s_grad)...@regis
-00018bf0: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
-00018c00: 7277 6172 6428 2274 6f72 6368 2e6c 6f67  rward("torch.log
-00018c10: 5f73 6f66 746d 6178 2229 0a64 6566 206c  _softmax").def l
-00018c20: 6f67 5f73 6f66 746d 6178 5f61 7567 5f66  og_softmax_aug_f
-00018c30: 7764 2869 6e70 7574 3a20 5465 6e73 6f72  wd(input: Tensor
-00018c40: 5072 6f78 792c 2064 696d 3a20 696e 742c  Proxy, dim: int,
-00018c50: 202a 2c20 6474 7970 653d 4e6f 6e65 2920   *, dtype=None) 
-00018c60: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
-00018c70: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
-00018c80: 6368 2069 6d70 6f72 7420 6c6f 675f 736f  ch import log_so
-00018c90: 6674 6d61 780a 0a20 2020 2070 7269 6d61  ftmax..    prima
-00018ca0: 6c20 3d20 6c6f 675f 736f 6674 6d61 7828  l = log_softmax(
-00018cb0: 696e 7075 742c 2064 696d 3d64 696d 2c20  input, dim=dim, 
-00018cc0: 6474 7970 653d 6474 7970 6529 0a20 2020  dtype=dtype).   
-00018cd0: 2072 6573 6964 7561 6c73 203d 2028 7072   residuals = (pr
-00018ce0: 696d 616c 2c20 6469 6d2c 2069 6e70 7574  imal, dim, input
-00018cf0: 2e64 7479 7065 290a 2020 2020 7265 7475  .dtype).    retu
-00018d00: 726e 2056 4a50 4475 616c 2870 7269 6d61  rn VJPDual(prima
-00018d10: 6c2c 2072 6573 6964 7561 6c73 290a 0a0a  l, residuals)...
-00018d20: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
-00018d30: 7264 2822 746f 7263 682e 6c6f 675f 736f  rd("torch.log_so
-00018d40: 6674 6d61 7822 290a 6465 6620 6c6f 675f  ftmax").def log_
-00018d50: 736f 6674 6d61 785f 6261 636b 7761 7264  softmax_backward
-00018d60: 2870 7269 6d61 6c2c 2064 696d 2c20 6474  (primal, dim, dt
-00018d70: 7970 652c 2067 293a 0a20 2020 2066 726f  ype, g):.    fro
-00018d80: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
-00018d90: 696d 706f 7274 206c 6f67 5f73 6f66 746d  import log_softm
-00018da0: 6178 5f62 6163 6b77 6172 640a 0a20 2020  ax_backward..   
-00018db0: 2072 6574 7572 6e20 6c6f 675f 736f 6674   return log_soft
-00018dc0: 6d61 785f 6261 636b 7761 7264 2867 2c20  max_backward(g, 
-00018dd0: 7072 696d 616c 2c20 6469 6d2c 2064 7479  primal, dim, dty
-00018de0: 7065 290a 0a0a 4072 6567 6973 7465 725f  pe)...@register_
-00018df0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00018e00: 6428 2274 6f72 6368 2e6e 6e2e 6675 6e63  d("torch.nn.func
-00018e10: 7469 6f6e 616c 2e6e 6c6c 5f6c 6f73 7322  tional.nll_loss"
-00018e20: 290a 6465 6620 6e6c 6c5f 6c6f 7373 5f61  ).def nll_loss_a
-00018e30: 7567 5f66 7764 280a 2020 2020 696e 7075  ug_fwd(.    inpu
-00018e40: 743a 2050 726f 7879 2c0a 2020 2020 7461  t: Proxy,.    ta
-00018e50: 7267 6574 3a20 5072 6f78 792c 0a20 2020  rget: Proxy,.   
-00018e60: 2077 6569 6768 743a 204e 6f6e 6520 7c20   weight: None | 
-00018e70: 5072 6f78 792c 0a20 2020 2069 676e 6f72  Proxy,.    ignor
-00018e80: 655f 696e 6465 783a 2069 6e74 2c0a 2020  e_index: int,.  
-00018e90: 2020 7265 6475 6374 696f 6e3a 2073 7472    reduction: str
-00018ea0: 2c0a 2920 2d3e 2056 4a50 4475 616c 3a0a  ,.) -> VJPDual:.
-00018eb0: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
-00018ec0: 2e74 6f72 6368 2069 6d70 6f72 7420 5f6e  .torch import _n
-00018ed0: 6c6c 5f6c 6f73 735f 6865 6c70 6572 0a0a  ll_loss_helper..
-00018ee0: 2020 2020 7072 696d 616c 2c20 746f 7461      primal, tota
-00018ef0: 6c5f 7765 6967 6874 203d 205f 6e6c 6c5f  l_weight = _nll_
-00018f00: 6c6f 7373 5f68 656c 7065 7228 0a20 2020  loss_helper(.   
-00018f10: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
-00018f20: 2020 2020 7461 7267 6574 2c0a 2020 2020      target,.    
-00018f30: 2020 2020 7765 6967 6874 2c0a 2020 2020      weight,.    
-00018f40: 2020 2020 6967 6e6f 7265 5f69 6e64 6578      ignore_index
-00018f50: 2c0a 2020 2020 2020 2020 7265 6475 6374  ,.        reduct
-00018f60: 696f 6e2c 0a20 2020 2029 0a20 2020 2072  ion,.    ).    r
-00018f70: 6573 6964 7561 6c73 203d 2028 696e 7075  esiduals = (inpu
-00018f80: 742c 2074 6172 6765 742c 2077 6569 6768  t, target, weigh
-00018f90: 742c 2072 6564 7563 7469 6f6e 2c20 6967  t, reduction, ig
-00018fa0: 6e6f 7265 5f69 6e64 6578 2c20 746f 7461  nore_index, tota
-00018fb0: 6c5f 7765 6967 6874 290a 2020 2020 7265  l_weight).    re
-00018fc0: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
-00018fd0: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
-00018fe0: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
-00018ff0: 7761 7264 2822 746f 7263 682e 6e6e 2e66  ward("torch.nn.f
-00019000: 756e 6374 696f 6e61 6c2e 6e6c 6c5f 6c6f  unctional.nll_lo
-00019010: 7373 2229 0a64 6566 206e 6c6c 5f6c 6f73  ss").def nll_los
-00019020: 735f 6261 636b 7761 7264 2869 6e70 7574  s_backward(input
-00019030: 2c20 7461 7267 6574 2c20 7765 6967 6874  , target, weight
-00019040: 2c20 7265 6475 6374 696f 6e2c 2069 676e  , reduction, ign
-00019050: 6f72 655f 696e 6465 782c 2074 6f74 616c  ore_index, total
-00019060: 5f77 6569 6768 742c 2067 293a 0a20 2020  _weight, g):.   
-00019070: 2066 726f 6d20 7468 756e 6465 722e 746f   from thunder.to
-00019080: 7263 6820 696d 706f 7274 206e 6c6c 5f6c  rch import nll_l
-00019090: 6f73 735f 6261 636b 7761 7264 0a0a 2020  oss_backward..  
-000190a0: 2020 6769 6e70 7574 203d 206e 6c6c 5f6c    ginput = nll_l
-000190b0: 6f73 735f 6261 636b 7761 7264 2867 2c20  oss_backward(g, 
-000190c0: 696e 7075 742c 2074 6172 6765 742c 2077  input, target, w
-000190d0: 6569 6768 742c 2072 6564 7563 7469 6f6e  eight, reduction
-000190e0: 2c20 6967 6e6f 7265 5f69 6e64 6578 2c20  , ignore_index, 
-000190f0: 746f 7461 6c5f 7765 6967 6874 290a 2020  total_weight).  
-00019100: 2020 7265 7475 726e 2067 696e 7075 742c    return ginput,
-00019110: 202a 2828 4e6f 6e65 2c29 202a 2034 290a   *((None,) * 4).
-00019120: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
-00019130: 656e 7465 645f 666f 7277 6172 6428 2274  ented_forward("t
-00019140: 6f72 6368 2e73 706c 6974 2229 0a64 6566  orch.split").def
-00019150: 2073 706c 6974 5f61 7567 5f66 7764 2861   split_aug_fwd(a
-00019160: 3a20 5465 6e73 6f72 5072 6f78 792c 2073  : TensorProxy, s
-00019170: 706c 6974 5f73 697a 655f 6f72 5f73 6563  plit_size_or_sec
-00019180: 7469 6f6e 733a 2069 6e74 207c 2053 6571  tions: int | Seq
-00019190: 7565 6e63 655b 696e 745d 2c20 6469 6d3a  uence[int], dim:
-000191a0: 2069 6e74 203d 2030 2920 2d3e 2056 4a50   int = 0) -> VJP
-000191b0: 4475 616c 3a0a 2020 2020 6672 6f6d 2074  Dual:.    from t
-000191c0: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
-000191d0: 6f72 7420 7370 6c69 740a 0a20 2020 2070  ort split..    p
-000191e0: 7269 6d61 6c20 3d20 7370 6c69 7428 612c  rimal = split(a,
-000191f0: 2073 706c 6974 5f73 697a 655f 6f72 5f73   split_size_or_s
-00019200: 6563 7469 6f6e 732c 2064 696d 290a 2020  ections, dim).  
-00019210: 2020 7265 7369 6475 616c 7320 3d20 2864    residuals = (d
-00019220: 696d 2c29 0a20 2020 2072 6574 7572 6e20  im,).    return 
-00019230: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
-00019240: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
-00019250: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
-00019260: 2274 6f72 6368 2e73 706c 6974 2229 0a64  "torch.split").d
-00019270: 6566 2073 706c 6974 5f62 6163 6b77 6172  ef split_backwar
-00019280: 6428 6469 6d2c 202a 6772 6164 7329 3a0a  d(dim, *grads):.
-00019290: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
-000192a0: 2e74 6f72 6368 2069 6d70 6f72 7420 6361  .torch import ca
-000192b0: 740a 0a20 2020 2072 6574 7572 6e20 6361  t..    return ca
-000192c0: 7428 6772 6164 732c 2064 696d 290a 0a0a  t(grads, dim)...
-000192d0: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
-000192e0: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
-000192f0: 6368 2e6e 6e2e 6675 6e63 7469 6f6e 616c  ch.nn.functional
-00019300: 2e65 6d62 6564 6469 6e67 2229 0a64 6566  .embedding").def
-00019310: 2065 6d62 6564 6469 6e67 5f61 7567 5f66   embedding_aug_f
-00019320: 7764 280a 2020 2020 613a 2050 726f 7879  wd(.    a: Proxy
-00019330: 2c0a 2020 2020 7765 6967 6874 3a20 5072  ,.    weight: Pr
-00019340: 6f78 792c 0a20 2020 2070 6164 6469 6e67  oxy,.    padding
-00019350: 5f69 6478 3a20 696e 7420 7c20 4e6f 6e65  _idx: int | None
-00019360: 2c0a 2020 2020 6d61 785f 6e6f 726d 3a20  ,.    max_norm: 
-00019370: 666c 6f61 7420 7c20 4e6f 6e65 2c0a 2020  float | None,.  
-00019380: 2020 6e6f 726d 5f74 7970 653a 2066 6c6f    norm_type: flo
-00019390: 6174 2c0a 2020 2020 7363 616c 655f 6772  at,.    scale_gr
-000193a0: 6164 5f62 795f 6672 6571 3a20 626f 6f6c  ad_by_freq: bool
-000193b0: 2c0a 2020 2020 7370 6172 7365 3a20 626f  ,.    sparse: bo
-000193c0: 6f6c 2c0a 2920 2d3e 2056 4a50 4475 616c  ol,.) -> VJPDual
-000193d0: 3a0a 2020 2020 6672 6f6d 2074 6875 6e64  :.    from thund
-000193e0: 6572 2e74 6f72 6368 2069 6d70 6f72 7420  er.torch import 
-000193f0: 656d 6265 6464 696e 670a 0a20 2020 2070  embedding..    p
-00019400: 7269 6d61 6c20 3d20 656d 6265 6464 696e  rimal = embeddin
-00019410: 6728 0a20 2020 2020 2020 2061 2c0a 2020  g(.        a,.  
-00019420: 2020 2020 2020 7765 6967 6874 2c0a 2020        weight,.  
-00019430: 2020 2020 2020 7061 6464 696e 675f 6964        padding_id
-00019440: 783d 7061 6464 696e 675f 6964 782c 0a20  x=padding_idx,. 
-00019450: 2020 2020 2020 206d 6178 5f6e 6f72 6d3d         max_norm=
-00019460: 6d61 785f 6e6f 726d 2c0a 2020 2020 2020  max_norm,.      
-00019470: 2020 6e6f 726d 5f74 7970 653d 6e6f 726d    norm_type=norm
-00019480: 5f74 7970 652c 0a20 2020 2020 2020 2073  _type,.        s
-00019490: 6361 6c65 5f67 7261 645f 6279 5f66 7265  cale_grad_by_fre
-000194a0: 713d 7363 616c 655f 6772 6164 5f62 795f  q=scale_grad_by_
-000194b0: 6672 6571 2c0a 2020 2020 2020 2020 7370  freq,.        sp
-000194c0: 6172 7365 3d73 7061 7273 652c 0a20 2020  arse=sparse,.   
-000194d0: 2029 0a20 2020 2072 6573 6964 7561 6c73   ).    residuals
-000194e0: 203d 2028 612c 2077 6569 6768 742e 7368   = (a, weight.sh
-000194f0: 6170 655b 305d 2c20 7061 6464 696e 675f  ape[0], padding_
-00019500: 6964 782c 2073 6361 6c65 5f67 7261 645f  idx, scale_grad_
-00019510: 6279 5f66 7265 712c 2073 7061 7273 6529  by_freq, sparse)
-00019520: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
-00019530: 7561 6c28 7072 696d 616c 2c20 7265 7369  ual(primal, resi
-00019540: 6475 616c 7329 0a0a 0a40 7265 6769 7374  duals)...@regist
-00019550: 6572 5f62 6163 6b77 6172 6428 2274 6f72  er_backward("tor
-00019560: 6368 2e6e 6e2e 6675 6e63 7469 6f6e 616c  ch.nn.functional
-00019570: 2e65 6d62 6564 6469 6e67 2229 0a64 6566  .embedding").def
-00019580: 2065 6d62 6564 6469 6e67 5f62 6163 6b77   embedding_backw
-00019590: 6172 6428 612c 206e 756d 5f77 6569 6768  ard(a, num_weigh
-000195a0: 7473 2c20 7061 6464 696e 675f 6964 782c  ts, padding_idx,
-000195b0: 2073 6361 6c65 5f67 7261 645f 6279 5f66   scale_grad_by_f
-000195c0: 7265 712c 2073 7061 7273 652c 2067 293a  req, sparse, g):
-000195d0: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
-000195e0: 722e 746f 7263 6820 696d 706f 7274 2065  r.torch import e
-000195f0: 6d62 6564 6469 6e67 5f62 6163 6b77 6172  mbedding_backwar
-00019600: 640a 0a20 2020 2070 6164 6469 6e67 5f69  d..    padding_i
-00019610: 6478 203d 202d 3120 6966 2070 6164 6469  dx = -1 if paddi
-00019620: 6e67 5f69 6478 2069 7320 4e6f 6e65 2065  ng_idx is None e
-00019630: 6c73 6520 7061 6464 696e 675f 6964 780a  lse padding_idx.
-00019640: 2020 2020 6777 6569 6768 7420 3d20 656d      gweight = em
-00019650: 6265 6464 696e 675f 6261 636b 7761 7264  bedding_backward
-00019660: 2867 2c20 612c 206e 756d 5f77 6569 6768  (g, a, num_weigh
-00019670: 7473 2c20 7061 6464 696e 675f 6964 782c  ts, padding_idx,
-00019680: 2073 6361 6c65 5f67 7261 645f 6279 5f66   scale_grad_by_f
-00019690: 7265 712c 2073 7061 7273 6529 0a20 2020  req, sparse).   
-000196a0: 2072 6574 7572 6e20 6777 6569 6768 740a   return gweight.
-000196b0: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
-000196c0: 656e 7465 645f 666f 7277 6172 6428 2274  ented_forward("t
-000196d0: 6f72 6368 2e63 756d 7375 6d22 290a 6465  orch.cumsum").de
-000196e0: 6620 6375 6d73 756d 5f61 7567 5f66 7764  f cumsum_aug_fwd
-000196f0: 2861 3a20 5072 6f78 792c 2064 696d 3a20  (a: Proxy, dim: 
-00019700: 696e 742c 202a 2c20 6474 7970 653a 204e  int, *, dtype: N
-00019710: 6f6e 6520 7c20 6474 7970 6573 2e64 7479  one | dtypes.dty
-00019720: 7065 203d 204e 6f6e 6529 202d 3e20 564a  pe = None) -> VJ
-00019730: 5044 7561 6c3a 0a20 2020 2066 726f 6d20  PDual:.    from 
-00019740: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
-00019750: 706f 7274 2063 756d 7375 6d0a 0a20 2020  port cumsum..   
-00019760: 2070 7269 6d61 6c20 3d20 6375 6d73 756d   primal = cumsum
-00019770: 2861 2c20 6469 6d2c 2064 7479 7065 3d64  (a, dim, dtype=d
-00019780: 7479 7065 290a 2020 2020 7265 7369 6475  type).    residu
-00019790: 616c 7320 3d20 280a 2020 2020 2020 2020  als = (.        
-000197a0: 612e 6474 7970 652c 0a20 2020 2020 2020  a.dtype,.       
-000197b0: 2064 696d 2c0a 2020 2020 290a 2020 2020   dim,.    ).    
-000197c0: 7265 7475 726e 2056 4a50 4475 616c 2870  return VJPDual(p
-000197d0: 7269 6d61 6c2c 2072 6573 6964 7561 6c73  rimal, residuals
-000197e0: 290a 0a0a 4072 6567 6973 7465 725f 6261  )...@register_ba
-000197f0: 636b 7761 7264 2822 746f 7263 682e 6375  ckward("torch.cu
-00019800: 6d73 756d 2229 0a64 6566 2063 756d 7375  msum").def cumsu
-00019810: 6d5f 6261 636b 7761 7264 2861 5f64 7479  m_backward(a_dty
-00019820: 7065 2c20 6469 6d2c 2067 293a 0a20 2020  pe, dim, g):.   
-00019830: 2067 203d 2067 2e74 6f28 615f 6474 7970   g = g.to(a_dtyp
-00019840: 6529 0a20 2020 2069 6620 672e 6e75 6d65  e).    if g.nume
-00019850: 6c20 3c3d 2031 206f 7220 672e 7368 6170  l <= 1 or g.shap
-00019860: 655b 6469 6d5d 203d 3d20 313a 0a20 2020  e[dim] == 1:.   
-00019870: 2020 2020 2072 6574 7572 6e20 670a 2020       return g.  
-00019880: 2020 7265 7475 726e 2067 2e66 6c69 7028    return g.flip(
-00019890: 6469 6d29 2e63 756d 7375 6d28 6469 6d29  dim).cumsum(dim)
-000198a0: 2e66 6c69 7028 6469 6d29 0a0a 0a40 7265  .flip(dim)...@re
-000198b0: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
-000198c0: 5f66 6f72 7761 7264 2822 746f 7263 682e  _forward("torch.
-000198d0: 736f 6674 6d61 7822 290a 6465 6620 736f  softmax").def so
-000198e0: 6674 6d61 785f 6175 675f 6677 6428 613a  ftmax_aug_fwd(a:
-000198f0: 2050 726f 7879 2c20 6469 6d3a 2069 6e74   Proxy, dim: int
-00019900: 2c20 6474 7970 653a 2064 7479 7065 732e  , dtype: dtypes.
-00019910: 6474 7970 6520 7c20 4e6f 6e65 203d 204e  dtype | None = N
-00019920: 6f6e 6529 202d 3e20 564a 5044 7561 6c3a  one) -> VJPDual:
-00019930: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
-00019940: 722e 746f 7263 6820 696d 706f 7274 2073  r.torch import s
-00019950: 6f66 746d 6178 0a0a 2020 2020 7072 696d  oftmax..    prim
-00019960: 616c 203d 2073 6f66 746d 6178 2861 2c20  al = softmax(a, 
-00019970: 6469 6d2c 2064 7479 7065 3d64 7479 7065  dim, dtype=dtype
-00019980: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
-00019990: 3d20 2870 7269 6d61 6c2c 2064 696d 290a  = (primal, dim).
-000199a0: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
-000199b0: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
-000199c0: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
-000199d0: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
-000199e0: 682e 736f 6674 6d61 7822 290a 6465 6620  h.softmax").def 
-000199f0: 736f 6674 6d61 785f 6261 636b 7761 7264  softmax_backward
-00019a00: 2870 7269 6d61 6c2c 2064 696d 2c20 6729  (primal, dim, g)
-00019a10: 3a0a 2020 2020 7265 7475 726e 2070 7269  :.    return pri
-00019a20: 6d61 6c20 2a20 2867 202d 2028 7072 696d  mal * (g - (prim
-00019a30: 616c 202a 2067 292e 7375 6d28 6469 6d2c  al * g).sum(dim,
-00019a40: 206b 6565 7064 696d 3d54 7275 6529 290a   keepdim=True)).
-00019a50: 0a0a 6465 6620 6974 6572 5f62 6f75 6e64  ..def iter_bound
-00019a60: 5f73 796d 626f 6c73 2862 6f75 6e64 5f73  _symbols(bound_s
-00019a70: 796d 626f 6c73 293a 0a20 2020 2022 2222  ymbols):.    """
-00019a80: 4974 6572 6174 6520 6f76 6572 2062 6f75  Iterate over bou
-00019a90: 6e64 2073 796d 626f 6c73 2c20 736b 6970  nd symbols, skip
-00019aa0: 7069 6e67 2073 796d 626f 6c73 2074 6861  ping symbols tha
-00019ab0: 7420 6172 6520 6e6f 7420 7375 7070 6f72  t are not suppor
-00019ac0: 7465 6420 6279 0a20 2020 2074 6865 2074  ted by.    the t
-00019ad0: 7261 6e73 666f 726d 7320 696e 6672 6173  ransforms infras
-00019ae0: 7472 7563 7475 7265 2e0a 0a20 2020 2041  tructure...    A
-00019af0: 7267 733a 0a20 2020 2020 2020 2062 6f75  rgs:.        bou
-00019b00: 6e64 5f73 796d 626f 6c73 2028 4c69 7374  nd_symbols (List
-00019b10: 5b42 6f75 6e64 5379 6d62 6f6c 5d29 3a20  [BoundSymbol]): 
-00019b20: 4c69 7374 206f 6620 626f 756e 6420 7379  List of bound sy
-00019b30: 6d62 6f6c 730a 0a20 2020 2059 6965 6c64  mbols..    Yield
-00019b40: 733a 0a20 2020 2020 2020 2042 6f75 6e64  s:.        Bound
-00019b50: 5379 6d62 6f6c 3a20 426f 756e 6420 7379  Symbol: Bound sy
-00019b60: 6d62 6f6c 7320 7468 6174 2061 7265 2073  mbols that are s
-00019b70: 7570 706f 7274 6564 2062 7920 7468 6520  upported by the 
-00019b80: 7472 616e 7366 6f72 6d73 0a20 2020 2020  transforms.     
-00019b90: 2020 2069 6e66 7261 7374 7275 6374 7572     infrastructur
-00019ba0: 650a 2020 2020 2222 220a 2020 2020 666f  e.    """.    fo
-00019bb0: 7220 7379 6d62 6f6c 2069 6e20 626f 756e  r symbol in boun
-00019bc0: 645f 7379 6d62 6f6c 733a 0a20 2020 2020  d_symbols:.     
-00019bd0: 2020 2069 6620 7379 6d62 6f6c 2e73 796d     if symbol.sym
-00019be0: 2e69 6420 696e 2074 7261 6e73 666f 726d  .id in transform
-00019bf0: 5f73 6b69 705f 6c69 7374 3a0a 2020 2020  _skip_list:.    
-00019c00: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00019c10: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00019c20: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-00019c30: 2073 796d 626f 6c0a 0a0a 6465 6620 6465   symbol...def de
-00019c40: 636f 6e73 7472 7563 745f 666f 7277 6172  construct_forwar
-00019c50: 645f 656e 765f 666f 725f 6261 636b 7761  d_env_for_backwa
-00019c60: 7264 2874 7261 6365 2c20 656e 7629 3a0a  rd(trace, env):.
-00019c70: 2020 2020 2320 4e6f 7465 205b 5361 7669      # Note [Savi
-00019c80: 6e67 2074 6865 2066 6f72 7761 7264 2065  ng the forward e
-00019c90: 6e76 6972 6f6e 6d65 6e74 2069 6e20 7468  nvironment in th
-00019ca0: 6520 6261 636b 7761 7264 2072 756c 655d  e backward rule]
-00019cb0: 0a20 2020 2023 2057 6520 6361 6e6e 6f74  .    # We cannot
-00019cc0: 2073 6176 6520 7468 6520 7472 6163 6520   save the trace 
-00019cd0: 6f62 6a65 6374 2069 6e20 7468 6520 7265  object in the re
-00019ce0: 7369 6475 616c 7320 6265 6361 7573 6520  siduals because 
-00019cf0: 6578 6563 7574 6f72 7320 6d61 7920 6e6f  executors may no
-00019d00: 740a 2020 2020 2320 6265 2061 626c 6520  t.    # be able 
-00019d10: 746f 2072 6574 7572 6e20 6974 2066 6f72  to return it for
-00019d20: 2074 6865 2073 706c 6974 7465 6420 666f   the splitted fo
-00019d30: 7277 6172 642f 6261 636b 7761 7264 2070  rward/backward p
-00019d40: 6173 7365 732e 2049 6e73 7465 6164 2c20  asses. Instead, 
-00019d50: 7765 0a20 2020 2023 2073 6176 6520 6172  we.    # save ar
-00019d60: 6773 2061 6e64 206b 7761 7267 7320 6f66  gs and kwargs of
-00019d70: 2074 6865 206f 7269 6769 6e61 6c20 6675   the original fu
-00019d80: 6e63 7469 6f6e 2063 616c 6c20 616e 6420  nction call and 
-00019d90: 7265 636f 6e73 7472 7563 7420 7468 650a  reconstruct the.
-00019da0: 2020 2020 2320 7472 6163 6520 6f62 6a65      # trace obje
-00019db0: 6374 2061 6e64 2069 7473 2065 6e76 6972  ct and its envir
-00019dc0: 6f6e 6d65 6e74 2064 6963 7420 696e 2074  onment dict in t
-00019dd0: 6865 2062 6163 6b77 6172 6420 7275 6c65  he backward rule
-00019de0: 2e20 4865 7265 2077 6520 7265 6c79 0a20  . Here we rely. 
-00019df0: 2020 2023 206f 6e20 7468 6520 6661 6374     # on the fact
-00019e00: 2074 6861 7420 7468 6520 6f72 6465 7220   that the order 
-00019e10: 6f66 2074 6865 2073 796d 626f 6c73 2069  of the symbols i
-00019e20: 6e20 7468 6520 7472 6163 6520 6973 2064  n the trace is d
-00019e30: 6574 6572 6d69 6e69 7374 6963 0a20 2020  eterministic.   
-00019e40: 2023 2061 6e64 2061 6c77 6179 7320 7468   # and always th
-00019e50: 6520 7361 6d65 2066 6f72 2074 6865 2073  e same for the s
-00019e60: 616d 6520 6675 6e63 7469 6f6e 2063 616c  ame function cal
-00019e70: 6c20 616e 6420 7468 6520 7361 6d65 2073  l and the same s
-00019e80: 6574 206f 660a 2020 2020 2320 6172 6775  et of.    # argu
-00019e90: 6d65 6e74 732e 2053 6565 2074 6573 745f  ments. See test_
-00019ea0: 6772 6164 2e70 793a 7465 7374 5f74 6f72  grad.py:test_tor
-00019eb0: 6368 5f61 7574 6f67 7261 645f 6675 6e63  ch_autograd_func
-00019ec0: 7469 6f6e 2066 6f72 2061 6e20 6578 616d  tion for an exam
-00019ed0: 706c 650a 2020 2020 2320 7768 6572 6520  ple.    # where 
-00019ee0: 7468 6973 2069 7320 7465 7374 6564 2e0a  this is tested..
-00019ef0: 2020 2020 626f 756e 645f 7379 6d62 6f6c      bound_symbol
-00019f00: 7320 3d20 6974 6572 5f62 6f75 6e64 5f73  s = iter_bound_s
-00019f10: 796d 626f 6c73 2874 7261 6365 2e62 6f75  ymbols(trace.bou
-00019f20: 6e64 5f73 796d 626f 6c73 290a 2020 2020  nd_symbols).    
-00019f30: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-00019f40: 7264 203d 2074 7570 6c65 2865 6e76 5b73  rd = tuple(env[s
-00019f50: 6571 7565 6e63 6966 7928 7379 6d62 6f6c  equencify(symbol
-00019f60: 2e6f 7574 7075 7429 5b30 5d2e 6e61 6d65  .output)[0].name
-00019f70: 5d2e 7265 7369 6475 616c 7320 666f 7220  ].residuals for 
-00019f80: 7379 6d62 6f6c 2069 6e20 626f 756e 645f  symbol in bound_
-00019f90: 7379 6d62 6f6c 7329 0a20 2020 2072 6574  symbols).    ret
-00019fa0: 7572 6e20 7361 7665 645f 666f 725f 6261  urn saved_for_ba
-00019fb0: 636b 7761 7264 0a0a 0a64 6566 2072 6563  ckward...def rec
-00019fc0: 6f6e 7374 7275 6374 5f66 6f72 7761 7264  onstruct_forward
-00019fd0: 5f65 6e76 5f66 6f72 5f62 6163 6b77 6172  _env_for_backwar
-00019fe0: 6428 7472 6163 652c 2073 6176 6564 5f66  d(trace, saved_f
-00019ff0: 6f72 5f62 6163 6b77 6172 6429 3a0a 2020  or_backward):.  
-0001a000: 2020 626f 756e 645f 7379 6d62 6f6c 7320    bound_symbols 
-0001a010: 3d20 6974 6572 5f62 6f75 6e64 5f73 796d  = iter_bound_sym
-0001a020: 626f 6c73 2874 7261 6365 2e62 6f75 6e64  bols(trace.bound
-0001a030: 5f73 796d 626f 6c73 290a 0a20 2020 2072  _symbols)..    r
-0001a040: 6563 6f6e 7374 7275 6374 6564 5f65 6e76  econstructed_env
-0001a050: 203d 207b 7d0a 0a20 2020 2066 6f72 2069   = {}..    for i
-0001a060: 6478 2c20 7379 6d20 696e 2065 6e75 6d65  dx, sym in enume
-0001a070: 7261 7465 2862 6f75 6e64 5f73 796d 626f  rate(bound_symbo
-0001a080: 6c73 293a 0a20 2020 2020 2020 206b 203d  ls):.        k =
-0001a090: 2073 6571 7565 6e63 6966 7928 7379 6d2e   sequencify(sym.
-0001a0a0: 6f75 7470 7574 295b 305d 2e6e 616d 650a  output)[0].name.
-0001a0b0: 2020 2020 2020 2020 7620 3d20 564a 5044          v = VJPD
-0001a0c0: 7561 6c28 4e6f 6e65 2c20 7361 7665 645f  ual(None, saved_
-0001a0d0: 666f 725f 6261 636b 7761 7264 5b69 6478  for_backward[idx
-0001a0e0: 5d29 0a20 2020 2020 2020 2072 6563 6f6e  ]).        recon
-0001a0f0: 7374 7275 6374 6564 5f65 6e76 5b6b 5d20  structed_env[k] 
-0001a100: 3d20 760a 0a20 2020 2072 6574 7572 6e20  = v..    return 
-0001a110: 7265 636f 6e73 7472 7563 7465 645f 656e  reconstructed_en
-0001a120: 760a 0a0a 6465 6620 6465 636f 6d70 6f73  v...def decompos
-0001a130: 6564 5f66 6e5f 6175 675f 6677 645f 7275  ed_fn_aug_fwd_ru
-0001a140: 6c65 282a 6172 6773 2c20 6465 636f 6d70  le(*args, decomp
-0001a150: 6f73 6564 5f66 6e2c 202a 2a6b 7761 7267  osed_fn, **kwarg
-0001a160: 7329 3a0a 2020 2020 2222 2241 7567 6d65  s):.    """Augme
-0001a170: 6e74 6564 2066 6f72 7761 7264 2072 756c  nted forward rul
-0001a180: 6520 666f 7220 636f 6d70 6f73 6974 6520  e for composite 
-0001a190: 6675 6e63 7469 6f6e 7320 696d 706c 656d  functions implem
-0001a1a0: 656e 7465 6420 696e 2074 6572 6d73 206f  ented in terms o
-0001a1b0: 6620 6f74 6865 7220 6675 6e63 7469 6f6e  f other function
-0001a1c0: 7320 7468 6174 2061 7265 0a20 2020 2073  s that are.    s
-0001a1d0: 7570 706f 7365 6420 746f 2062 6520 7375  upposed to be su
-0001a1e0: 7070 6f72 7465 6420 6279 2074 6865 2056  pported by the V
-0001a1f0: 4a50 2069 6e66 7261 7374 7275 6374 7572  JP infrastructur
-0001a200: 652e 0a0a 2020 2020 4172 6773 3a0a 2020  e...    Args:.  
-0001a210: 2020 2020 2020 6465 636f 6d70 6f73 6564        decomposed
-0001a220: 5f66 6e20 2843 616c 6c61 626c 6529 3a20  _fn (Callable): 
-0001a230: 6465 636f 6d70 6f73 6564 2076 6572 7369  decomposed versi
-0001a240: 6f6e 206f 6620 7468 6520 6675 6e63 7469  on of the functi
-0001a250: 6f6e 0a0a 2020 2020 5265 7475 726e 733a  on..    Returns:
-0001a260: 0a20 2020 2020 2020 2043 616c 6c61 626c  .        Callabl
-0001a270: 653a 2041 7567 6d65 6e74 6564 2066 6f72  e: Augmented for
-0001a280: 7761 7264 2072 756c 6520 666f 7220 7468  ward rule for th
-0001a290: 6520 636f 6d70 6f73 6974 6520 6675 6e63  e composite func
-0001a2a0: 7469 6f6e 0a20 2020 2022 2222 0a20 2020  tion.    """.   
-0001a2b0: 2074 7261 6365 203d 2063 6f6e 7374 7275   trace = constru
-0001a2c0: 6374 5f74 7261 6365 2829 2864 6563 6f6d  ct_trace()(decom
-0001a2d0: 706f 7365 645f 666e 2c20 2a61 7267 732c  posed_fn, *args,
-0001a2e0: 202a 2a6b 7761 7267 7329 0a20 2020 2074   **kwargs).    t
-0001a2f0: 7261 6365 203d 2075 6e77 7261 705f 6f6e  race = unwrap_on
-0001a300: 655f 6c65 7665 6c5f 6f66 5f73 7562 7379  e_level_of_subsy
-0001a310: 6d62 6f6c 7328 7472 6163 6529 0a20 2020  mbols(trace).   
-0001a320: 2023 2054 6865 7265 206d 6179 2062 6520   # There may be 
-0001a330: 6120 6465 6164 206e 6f64 6520 6c69 6b65  a dead node like
-0001a340: 2022 5f20 3d20 7072 696d 732e 636f 6e76   "_ = prims.conv
-0001a350: 6572 745f 656c 656d 656e 745f 7479 7065  ert_element_type
-0001a360: 2830 2c20 666c 6f61 7429 220a 2020 2020  (0, float)".    
-0001a370: 2320 696e 2074 6865 2074 7261 6365 2e20  # in the trace. 
-0001a380: 5765 206e 6565 6420 746f 2072 656d 6f76  We need to remov
-0001a390: 6520 6974 2062 6566 6f72 6520 7765 2063  e it before we c
-0001a3a0: 616e 2075 7365 2074 6865 2074 7261 6365  an use the trace
-0001a3b0: 2066 6f72 0a20 2020 2023 2061 7567 6d65   for.    # augme
-0001a3c0: 6e74 6564 5f66 6f72 7761 7264 5f70 6173  nted_forward_pas
-0001a3d0: 732e 0a20 2020 2074 7261 6365 203d 2064  s..    trace = d
-0001a3e0: 6365 2874 7261 6365 290a 2020 2020 7265  ce(trace).    re
-0001a3f0: 7375 6c74 2c20 656e 7620 3d20 6175 676d  sult, env = augm
-0001a400: 656e 7465 645f 666f 7277 6172 645f 7061  ented_forward_pa
-0001a410: 7373 282a 6172 6773 2c20 7472 6163 653d  ss(*args, trace=
-0001a420: 7472 6163 652c 202a 2a6b 7761 7267 7329  trace, **kwargs)
-0001a430: 0a20 2020 2073 6176 6564 5f66 6f72 5f62  .    saved_for_b
-0001a440: 6163 6b77 6172 6420 3d20 6465 636f 6e73  ackward = decons
-0001a450: 7472 7563 745f 666f 7277 6172 645f 656e  truct_forward_en
-0001a460: 765f 666f 725f 6261 636b 7761 7264 2874  v_for_backward(t
-0001a470: 7261 6365 2c20 656e 7629 0a20 2020 2023  race, env).    #
-0001a480: 2053 7461 7469 6320 6361 6368 696e 6720   Static caching 
-0001a490: 646f 6573 206e 6f74 2077 6974 6820 7769  does not with wi
-0001a4a0: 7468 206b 7761 7267 7320 6469 6374 732c  th kwargs dicts,
-0001a4b0: 2073 6f20 7765 2772 6520 636f 6e76 6572   so we're conver
-0001a4c0: 7469 6e67 2074 6865 6d0a 2020 2020 2320  ting them.    # 
-0001a4d0: 746f 204e 6f6e 6520 666f 7220 6e6f 7720  to None for now 
-0001a4e0: 7768 656e 2070 6f73 7369 626c 652e 0a20  when possible.. 
-0001a4f0: 2020 206b 7761 7267 7320 3d20 4e6f 6e65     kwargs = None
-0001a500: 2069 6620 6e6f 7420 6b77 6172 6773 2065   if not kwargs e
-0001a510: 6c73 6520 6b77 6172 6773 0a20 2020 2072  lse kwargs.    r
-0001a520: 6573 6964 7561 6c73 203d 2028 6172 6773  esiduals = (args
-0001a530: 2c20 6b77 6172 6773 2c20 7361 7665 645f  , kwargs, saved_
-0001a540: 666f 725f 6261 636b 7761 7264 290a 2020  for_backward).  
-0001a550: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
-0001a560: 2872 6573 756c 742c 2072 6573 6964 7561  (result, residua
-0001a570: 6c73 290a 0a0a 6465 6620 6465 636f 6d70  ls)...def decomp
-0001a580: 6f73 6564 5f66 6e5f 6261 636b 7761 7264  osed_fn_backward
-0001a590: 5f72 756c 6528 6465 636f 6d70 6f73 6564  _rule(decomposed
-0001a5a0: 5f66 6e2c 2061 7267 732c 206b 7761 7267  _fn, args, kwarg
-0001a5b0: 732c 2073 6176 6564 5f66 6f72 5f62 6163  s, saved_for_bac
-0001a5c0: 6b77 6172 642c 202a 6772 6164 7329 3a0a  kward, *grads):.
-0001a5d0: 2020 2020 6b77 6172 6773 203d 207b 7d20      kwargs = {} 
-0001a5e0: 6966 206b 7761 7267 7320 6973 204e 6f6e  if kwargs is Non
-0001a5f0: 6520 656c 7365 206b 7761 7267 730a 2020  e else kwargs.  
-0001a600: 2020 7472 6163 6520 3d20 636f 6e73 7472    trace = constr
-0001a610: 7563 745f 7472 6163 6528 2928 6465 636f  uct_trace()(deco
-0001a620: 6d70 6f73 6564 5f66 6e2c 202a 6172 6773  mposed_fn, *args
-0001a630: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-0001a640: 7472 6163 6520 3d20 756e 7772 6170 5f6f  trace = unwrap_o
-0001a650: 6e65 5f6c 6576 656c 5f6f 665f 7375 6273  ne_level_of_subs
-0001a660: 796d 626f 6c73 2874 7261 6365 290a 2020  ymbols(trace).  
-0001a670: 2020 7472 6163 6520 3d20 6463 6528 7472    trace = dce(tr
-0001a680: 6163 6529 0a20 2020 2023 2062 6f75 6e64  ace).    # bound
-0001a690: 5f73 796d 626f 6c73 203d 2069 7465 725f  _symbols = iter_
-0001a6a0: 626f 756e 645f 7379 6d62 6f6c 7328 7472  bound_symbols(tr
-0001a6b0: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
-0001a6c0: 7329 0a20 2020 2023 2072 6563 6f6e 7374  s).    # reconst
-0001a6d0: 7275 6374 6564 5f65 6e76 203d 207b 0a20  ructed_env = {. 
-0001a6e0: 2020 2023 2020 2020 2073 6571 7565 6e63     #     sequenc
-0001a6f0: 6966 7928 7379 6d62 6f6c 2e6f 7574 7075  ify(symbol.outpu
-0001a700: 7429 5b30 5d2e 6e61 6d65 3a20 564a 5044  t)[0].name: VJPD
-0001a710: 7561 6c28 4e6f 6e65 2c20 7361 7665 645f  ual(None, saved_
-0001a720: 666f 725f 6261 636b 7761 7264 5b69 5d29  for_backward[i])
-0001a730: 0a20 2020 2023 2020 2020 2066 6f72 2069  .    #     for i
-0001a740: 2c20 7379 6d62 6f6c 2069 6e20 656e 756d  , symbol in enum
-0001a750: 6572 6174 6528 626f 756e 645f 7379 6d62  erate(bound_symb
-0001a760: 6f6c 7329 0a20 2020 2023 207d 0a20 2020  ols).    # }.   
-0001a770: 2072 6563 6f6e 7374 7275 6374 6564 5f65   reconstructed_e
-0001a780: 6e76 203d 2072 6563 6f6e 7374 7275 6374  nv = reconstruct
-0001a790: 5f66 6f72 7761 7264 5f65 6e76 5f66 6f72  _forward_env_for
-0001a7a0: 5f62 6163 6b77 6172 6428 7472 6163 652c  _backward(trace,
-0001a7b0: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-0001a7c0: 6172 6429 0a20 2020 2072 6573 756c 7420  ard).    result 
-0001a7d0: 3d20 6261 636b 7761 7264 5f70 6173 7328  = backward_pass(
-0001a7e0: 7265 636f 6e73 7472 7563 7465 645f 656e  reconstructed_en
-0001a7f0: 762c 2074 7261 6365 2c20 6772 6164 7329  v, trace, grads)
-0001a800: 0a20 2020 2069 6620 6c65 6e28 6172 6773  .    if len(args
-0001a810: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-0001a820: 7265 7475 726e 2072 6573 756c 745b 305d  return result[0]
-0001a830: 0a20 2020 2023 2042 6163 6b77 6172 6420  .    # Backward 
-0001a840: 7061 7373 206d 6967 6874 2072 6574 7572  pass might retur
-0001a850: 6e20 6120 6469 6374 2077 6974 6820 6772  n a dict with gr
-0001a860: 6164 7320 6275 7420 6375 7272 656e 7420  ads but current 
-0001a870: 696e 7465 7266 6163 6520 6f66 0a20 2020  interface of.   
-0001a880: 2023 2062 6163 6b77 6172 6420 7275 6c65   # backward rule
-0001a890: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-0001a8a0: 7420 6974 2e20 536f 2077 6520 6a75 7374  t it. So we just
-0001a8b0: 2064 726f 7020 6974 2066 6f72 206e 6f77   drop it for now
-0001a8c0: 2e0a 2020 2020 656c 6966 2069 7369 6e73  ..    elif isins
-0001a8d0: 7461 6e63 6528 7265 7375 6c74 5b2d 315d  tance(result[-1]
-0001a8e0: 2c20 6469 6374 293a 0a20 2020 2020 2020  , dict):.       
-0001a8f0: 2072 6574 7572 6e20 7265 7375 6c74 5b3a   return result[:
-0001a900: 2d31 5d0a 2020 2020 7265 7475 726e 2072  -1].    return r
-0001a910: 6573 756c 740a 0a0a 4072 6567 6973 7465  esult...@registe
-0001a920: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
-0001a930: 6172 6428 2274 6f72 6368 2e54 656e 736f  ard("torch.Tenso
-0001a940: 722e 636f 6e74 6967 756f 7573 2229 0a40  r.contiguous").@
-0001a950: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
-0001a960: 6564 5f66 6f72 7761 7264 2822 746f 7263  ed_forward("torc
-0001a970: 682e 636f 6e74 6967 756f 7573 2229 0a64  h.contiguous").d
-0001a980: 6566 2063 6f6e 7469 6775 6f75 735f 6175  ef contiguous_au
-0001a990: 675f 6677 6428 783a 2054 656e 736f 7250  g_fwd(x: TensorP
-0001a9a0: 726f 7879 2c20 2f2c 202a 2c20 6d65 6d6f  roxy, /, *, memo
-0001a9b0: 7279 5f66 6f72 6d61 743a 2074 6f72 6368  ry_format: torch
-0001a9c0: 2e6d 656d 6f72 795f 666f 726d 6174 203d  .memory_format =
-0001a9d0: 2074 6f72 6368 2e63 6f6e 7469 6775 6f75   torch.contiguou
-0001a9e0: 735f 666f 726d 6174 2920 2d3e 2056 4a50  s_format) -> VJP
-0001a9f0: 4475 616c 3a0a 2020 2020 6672 6f6d 2074  Dual:.    from t
-0001aa00: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
-0001aa10: 6f72 7420 636f 6e74 6967 756f 7573 0a0a  ort contiguous..
-0001aa20: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
-0001aa30: 616c 2863 6f6e 7469 6775 6f75 7328 782c  al(contiguous(x,
-0001aa40: 206d 656d 6f72 795f 666f 726d 6174 3d6d   memory_format=m
-0001aa50: 656d 6f72 795f 666f 726d 6174 292c 2074  emory_format), t
-0001aa60: 7570 6c65 2829 290a 0a0a 4072 6567 6973  uple())...@regis
-0001aa70: 7465 725f 6261 636b 7761 7264 2822 746f  ter_backward("to
-0001aa80: 7263 682e 5465 6e73 6f72 2e63 6f6e 7469  rch.Tensor.conti
-0001aa90: 6775 6f75 7322 290a 4072 6567 6973 7465  guous").@registe
-0001aaa0: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
-0001aab0: 682e 636f 6e74 6967 756f 7573 2229 0a64  h.contiguous").d
-0001aac0: 6566 2063 6f6e 7469 6775 6f75 735f 6261  ef contiguous_ba
-0001aad0: 636b 7761 7264 282a 7265 7369 6475 616c  ckward(*residual
-0001aae0: 735f 616e 645f 6772 6164 2920 2d3e 2054  s_and_grad) -> T
-0001aaf0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-0001ab00: 2320 5265 7369 6475 616c 7320 6973 206e  # Residuals is n
-0001ab10: 6f74 2065 6d70 7479 2062 6563 6175 7365  ot empty because
-0001ab20: 2063 6f6e 7469 6775 6f75 7320 7379 6d62   contiguous symb
-0001ab30: 6f6c 2068 6173 2074 6865 2073 616d 6520  ol has the same 
-0001ab40: 6f75 7470 7574 2061 7320 6974 7320 696e  output as its in
-0001ab50: 7075 740a 2020 2020 6720 3d20 7265 7369  put.    g = resi
-0001ab60: 6475 616c 735f 616e 645f 6772 6164 5b2d  duals_and_grad[-
-0001ab70: 315d 0a20 2020 2072 6574 7572 6e20 670a  1].    return g.
-0001ab80: 0a0a 6465 6620 7265 6369 7072 6f63 616c  ..def reciprocal
-0001ab90: 5f61 7567 5f66 7764 2861 3a20 5465 6e73  _aug_fwd(a: Tens
-0001aba0: 6f72 5072 6f78 7929 202d 3e20 564a 5044  orProxy) -> VJPD
-0001abb0: 7561 6c3a 0a20 2020 2070 7269 6d61 6c20  ual:.    primal 
-0001abc0: 3d20 7265 6369 7072 6f63 616c 2861 290a  = reciprocal(a).
-0001abd0: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
-0001abe0: 616c 2870 7269 6d61 6c2c 2028 7072 696d  al(primal, (prim
-0001abf0: 616c 2c29 290a 0a0a 6465 6620 7265 6369  al,))...def reci
-0001ac00: 7072 6f63 616c 5f62 6163 6b77 6172 6428  procal_backward(
-0001ac10: 7072 696d 616c 2c20 6729 3a0a 2020 2020  primal, g):.    
-0001ac20: 7265 7475 726e 202d 6720 2a20 7072 696d  return -g * prim
-0001ac30: 616c 202a 2070 7269 6d61 6c0a 0a0a 4070  al * primal...@p
-0001ac40: 6172 7469 616c 2872 6567 6973 7465 725f  artial(register_
-0001ac50: 6772 6164 2c20 7072 696d 732e 5072 696d  grad, prims.Prim
-0001ac60: 4944 732e 5245 4349 5052 4f43 414c 290a  IDs.RECIPROCAL).
-0001ac70: 6465 6620 7265 6369 7072 6f63 616c 5f6a  def reciprocal_j
-0001ac80: 6f69 6e74 5f66 6f72 7761 7264 5f62 6163  oint_forward_bac
-0001ac90: 6b77 6172 645f 7275 6c65 2861 3a20 5465  kward_rule(a: Te
-0001aca0: 6e73 6f72 5072 6f78 7929 202d 3e20 5465  nsorProxy) -> Te
-0001acb0: 6e73 6f72 5072 6f78 793a 0a20 2020 2072  nsorProxy:.    r
-0001acc0: 6573 756c 742c 2073 6176 6564 203d 2072  esult, saved = r
-0001acd0: 6563 6970 726f 6361 6c5f 6175 675f 6677  eciprocal_aug_fw
-0001ace0: 6428 6129 0a20 2020 2067 203d 2067 6574  d(a).    g = get
-0001acf0: 5f67 7261 6428 7265 7375 6c74 290a 2020  _grad(result).  
-0001ad00: 2020 6761 203d 2072 6563 6970 726f 6361    ga = reciproca
-0001ad10: 6c5f 6261 636b 7761 7264 282a 7361 7665  l_backward(*save
-0001ad20: 642c 2067 290a 2020 2020 7075 745f 6772  d, g).    put_gr
-0001ad30: 6164 2861 2c20 6761 290a 2020 2020 7265  ad(a, ga).    re
-0001ad40: 7475 726e 2072 6573 756c 740a 0a0a 4072  turn result...@r
-0001ad50: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
-0001ad60: 645f 666f 7277 6172 6428 2274 6f72 6368  d_forward("torch
-0001ad70: 2e69 6e64 6578 5f70 7574 2229 0a64 6566  .index_put").def
-0001ad80: 2069 6e64 6578 5f70 7574 5f61 7567 5f66   index_put_aug_f
-0001ad90: 7764 280a 2020 2020 613a 2054 656e 736f  wd(.    a: Tenso
-0001ada0: 7250 726f 7879 2c20 2f2c 2069 6e64 6963  rProxy, /, indic
-0001adb0: 6573 3a20 5365 7175 656e 6365 5b54 656e  es: Sequence[Ten
-0001adc0: 736f 7250 726f 7879 5d2c 2076 616c 7565  sorProxy], value
-0001add0: 733a 2054 656e 736f 7250 726f 7879 2c20  s: TensorProxy, 
-0001ade0: 6163 6375 6d75 6c61 7465 3a20 626f 6f6c  accumulate: bool
-0001adf0: 203d 2046 616c 7365 0a29 202d 3e20 564a   = False.) -> VJ
-0001ae00: 5044 7561 6c3a 0a20 2020 2070 7269 6d61  PDual:.    prima
-0001ae10: 6c20 3d20 636c 616e 672e 696e 6465 785f  l = clang.index_
-0001ae20: 7075 7428 612c 2069 6e64 6963 6573 2c20  put(a, indices, 
-0001ae30: 7661 6c75 6573 2c20 6163 6375 6d75 6c61  values, accumula
-0001ae40: 7465 290a 2020 2020 7265 7369 6475 616c  te).    residual
-0001ae50: 7320 3d20 280a 2020 2020 2020 2020 696e  s = (.        in
-0001ae60: 6469 6365 732c 0a20 2020 2020 2020 2076  dices,.        v
-0001ae70: 616c 7565 732c 0a20 2020 2020 2020 2061  alues,.        a
-0001ae80: 6363 756d 756c 6174 652c 0a20 2020 2029  ccumulate,.    )
-0001ae90: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
-0001aea0: 7561 6c28 7072 696d 616c 2c20 7265 7369  ual(primal, resi
-0001aeb0: 6475 616c 7329 0a0a 0a64 6566 2073 756d  duals)...def sum
-0001aec0: 5f74 6f28 613a 2054 656e 736f 7250 726f  _to(a: TensorPro
-0001aed0: 7879 2c20 7368 6170 653a 2053 6571 7565  xy, shape: Seque
-0001aee0: 6e63 655b 696e 745d 2920 2d3e 2054 656e  nce[int]) -> Ten
-0001aef0: 736f 7250 726f 7879 3a0a 2020 2020 6966  sorProxy:.    if
-0001af00: 206e 6f74 2073 6861 7065 3a0a 2020 2020   not shape:.    
-0001af10: 2020 2020 7265 7475 726e 2061 2e73 756d      return a.sum
-0001af20: 2829 0a20 2020 206c 6561 6469 6e67 5f64  ().    leading_d
-0001af30: 696d 7320 3d20 612e 6e64 696d 202d 206c  ims = a.ndim - l
-0001af40: 656e 2873 6861 7065 290a 2020 2020 7265  en(shape).    re
-0001af50: 6475 6365 5f64 696d 7320 3d20 7475 706c  duce_dims = tupl
-0001af60: 6528 7261 6e67 6528 6c65 6164 696e 675f  e(range(leading_
-0001af70: 6469 6d73 2929 202b 2074 7570 6c65 280a  dims)) + tuple(.
-0001af80: 2020 2020 2020 2020 6920 666f 7220 6920          i for i 
-0001af90: 696e 2072 616e 6765 286c 6561 6469 6e67  in range(leading
-0001afa0: 5f64 696d 732c 2061 2e6e 6469 6d29 2069  _dims, a.ndim) i
-0001afb0: 6620 7368 6170 655b 6920 2d20 6c65 6164  f shape[i - lead
-0001afc0: 696e 675f 6469 6d73 5d20 3d3d 2031 2061  ing_dims] == 1 a
-0001afd0: 6e64 2061 2e73 6861 7065 5b69 5d20 213d  nd a.shape[i] !=
-0001afe0: 2031 0a20 2020 2029 0a20 2020 2061 203d   1.    ).    a =
-0001aff0: 206c 746f 7263 682e 7375 6d28 612c 2064   ltorch.sum(a, d
-0001b000: 696d 3d72 6564 7563 655f 6469 6d73 2c20  im=reduce_dims, 
-0001b010: 6b65 6570 6469 6d3d 5472 7565 290a 2020  keepdim=True).  
-0001b020: 2020 6966 206c 6561 6469 6e67 5f64 696d    if leading_dim
-0001b030: 7320 3e20 303a 0a20 2020 2020 2020 2072  s > 0:.        r
-0001b040: 6574 7572 6e20 6c74 6f72 6368 2e76 6965  eturn ltorch.vie
-0001b050: 7728 612c 2073 6861 7065 290a 2020 2020  w(a, shape).    
-0001b060: 7265 7475 726e 2061 0a0a 0a40 7265 6769  return a...@regi
-0001b070: 7374 6572 5f62 6163 6b77 6172 6428 2274  ster_backward("t
-0001b080: 6f72 6368 2e69 6e64 6578 5f70 7574 2229  orch.index_put")
-0001b090: 0a64 6566 2069 6e64 6578 5f70 7574 5f62  .def index_put_b
-0001b0a0: 6163 6b77 6172 6428 696e 6469 6365 733a  ackward(indices:
-0001b0b0: 2053 6571 7565 6e63 655b 5465 6e73 6f72   Sequence[Tensor
-0001b0c0: 5072 6f78 795d 2c20 7661 6c75 6573 3a20  Proxy], values: 
-0001b0d0: 5465 6e73 6f72 5072 6f78 792c 2061 6363  TensorProxy, acc
-0001b0e0: 756d 756c 6174 653a 2062 6f6f 6c2c 2067  umulate: bool, g
-0001b0f0: 3a20 5465 6e73 6f72 5072 6f78 7929 3a0a  : TensorProxy):.
-0001b100: 2020 2020 675f 7661 6c75 6573 203d 2067      g_values = g
-0001b110: 5b69 6e64 6963 6573 5d0a 2020 2020 2320  [indices].    # 
-0001b120: 746f 7263 6820 6861 7320 6578 7472 6120  torch has extra 
-0001b130: 6c6f 6769 6320 746f 2068 616e 646c 6520  logic to handle 
-0001b140: 7468 6520 6578 7061 6e64 6564 2076 616c  the expanded val
-0001b150: 7565 730a 2020 2020 6966 206e 6f74 2075  ues.    if not u
-0001b160: 7469 6c73 2e73 616d 655f 7368 6170 6528  tils.same_shape(
-0001b170: 675f 7661 6c75 6573 2e73 6861 7065 2c20  g_values.shape, 
-0001b180: 7661 6c75 6573 2e73 6861 7065 293a 0a20  values.shape):. 
-0001b190: 2020 2020 2020 2069 6620 636c 616e 672e         if clang.
-0001b1a0: 636f 6d70 7574 655f 6272 6f61 6463 6173  compute_broadcas
-0001b1b0: 745f 7368 6170 6528 675f 7661 6c75 6573  t_shape(g_values
-0001b1c0: 2e73 6861 7065 2c20 7661 6c75 6573 2e73  .shape, values.s
-0001b1d0: 6861 7065 293a 0a20 2020 2020 2020 2020  hape):.         
-0001b1e0: 2020 2067 5f76 616c 7565 7320 3d20 7375     g_values = su
-0001b1f0: 6d5f 746f 2867 5f76 616c 7565 732c 2076  m_to(g_values, v
-0001b200: 616c 7565 732e 7368 6170 6529 0a20 2020  alues.shape).   
-0001b210: 2069 6620 6163 6375 6d75 6c61 7465 3a0a   if accumulate:.
-0001b220: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-0001b230: 2c20 675f 7661 6c75 6573 0a20 2020 2072  , g_values.    r
-0001b240: 6574 7572 6e20 636c 616e 672e 696e 6465  eturn clang.inde
-0001b250: 785f 7075 7428 672c 2069 6e64 6963 6573  x_put(g, indices
-0001b260: 2c20 6c74 6f72 6368 2e7a 6572 6f73 5f6c  , ltorch.zeros_l
-0001b270: 696b 6528 7661 6c75 6573 292c 2046 616c  ike(values), Fal
-0001b280: 7365 292c 2067 5f76 616c 7565 730a 0a0a  se), g_values...
-0001b290: 6465 6620 756e 6966 6f72 6d5f 6175 675f  def uniform_aug_
-0001b2a0: 6677 6428 7368 6170 652c 206d 696e 7661  fwd(shape, minva
-0001b2b0: 6c2c 206d 6178 7661 6c2c 202a 2c20 6465  l, maxval, *, de
-0001b2c0: 7669 6365 2c20 6474 7970 6529 3a0a 2020  vice, dtype):.  
-0001b2d0: 2020 7072 696d 616c 203d 2070 7269 6d73    primal = prims
-0001b2e0: 2e75 6e69 666f 726d 2873 6861 7065 2c20  .uniform(shape, 
-0001b2f0: 6d69 6e76 616c 2c20 6d61 7876 616c 2c20  minval, maxval, 
-0001b300: 6465 7669 6365 3d64 6576 6963 652c 2064  device=device, d
-0001b310: 7479 7065 3d64 7479 7065 290a 2020 2020  type=dtype).    
-0001b320: 7265 7475 726e 2056 4a50 4475 616c 2870  return VJPDual(p
-0001b330: 7269 6d61 6c2c 2028 7072 696d 616c 2c20  rimal, (primal, 
-0001b340: 6d69 6e76 616c 2c20 6d61 7876 616c 2929  minval, maxval))
-0001b350: 0a0a 0a64 6566 2075 6e69 666f 726d 5f62  ...def uniform_b
-0001b360: 6163 6b77 6172 6428 7072 696d 616c 2c20  ackward(primal, 
-0001b370: 6d69 6e76 616c 2c20 6d61 7876 616c 2c20  minval, maxval, 
-0001b380: 6729 3a0a 2020 2020 2320 756e 6966 6f72  g):.    # unifor
-0001b390: 6d20 6973 2069 6d70 6c65 6d65 6e74 6564  m is implemented
-0001b3a0: 2061 7320 286d 6178 7661 6c20 2d20 6d69   as (maxval - mi
-0001b3b0: 6e76 616c 2920 2a20 756e 6966 6f72 6d28  nval) * uniform(
-0001b3c0: 7368 6170 652c 2030 2c20 3129 202b 206d  shape, 0, 1) + m
-0001b3d0: 696e 7661 6c0a 2020 2020 756e 7363 616c  inval.    unscal
-0001b3e0: 6564 5f70 7269 6d61 6c20 3d20 2870 7269  ed_primal = (pri
-0001b3f0: 6d61 6c20 2d20 6d69 6e76 616c 2920 2f20  mal - minval) / 
-0001b400: 286d 6178 7661 6c20 2d20 6d69 6e76 616c  (maxval - minval
-0001b410: 290a 2020 2020 7265 6475 6365 5f61 6c6c  ).    reduce_all
-0001b420: 5f64 696d 7320 3d20 7475 706c 6528 7261  _dims = tuple(ra
-0001b430: 6e67 6528 672e 6e64 696d 2929 0a20 2020  nge(g.ndim)).   
-0001b440: 2073 756d 203d 2070 6172 7469 616c 2870   sum = partial(p
-0001b450: 7269 6d73 2e73 756d 2c20 6469 6d73 3d72  rims.sum, dims=r
-0001b460: 6564 7563 655f 616c 6c5f 6469 6d73 290a  educe_all_dims).
-0001b470: 2020 2020 7265 7475 726e 204e 6f6e 652c      return None,
-0001b480: 2073 756d 2867 202a 2028 3120 2d20 756e   sum(g * (1 - un
-0001b490: 7363 616c 6564 5f70 7269 6d61 6c29 292c  scaled_primal)),
-0001b4a0: 2073 756d 2867 202a 2075 6e73 6361 6c65   sum(g * unscale
-0001b4b0: 645f 7072 696d 616c 290a 0a0a 6e6f 6e64  d_primal)...nond
-0001b4c0: 6966 6665 7265 6e74 6961 626c 655f 766a  ifferentiable_vj
-0001b4d0: 705f 7379 6d62 6f6c 7320 3d20 2870 7269  p_symbols = (pri
-0001b4e0: 6d73 2e50 7269 6d49 4473 2e42 4954 5749  ms.PrimIDs.BITWI
-0001b4f0: 5345 5f41 4e44 2c20 7072 696d 732e 5072  SE_AND, prims.Pr
-0001b500: 696d 4944 732e 5349 474e 4249 542c 2070  imIDs.SIGNBIT, p
-0001b510: 7269 6d73 2e50 7269 6d49 4473 2e46 554c  rims.PrimIDs.FUL
-0001b520: 4c29 0a0a 0a64 6566 2067 6574 5f65 7865  L)...def get_exe
-0001b530: 6375 746f 725f 7370 6563 6966 6963 5f61  cutor_specific_a
-0001b540: 7567 5f66 7764 5f72 756c 6528 7379 6d62  ug_fwd_rule(symb
-0001b550: 6f6c 3a20 426f 756e 6453 796d 626f 6c29  ol: BoundSymbol)
-0001b560: 202d 3e20 5275 6c65 496e 666f 207c 204e   -> RuleInfo | N
-0001b570: 6f6e 653a 0a20 2020 2022 2222 4765 7420  one:.    """Get 
-0001b580: 6578 6563 7574 6f72 2073 7065 6369 6669  executor specifi
-0001b590: 6320 6175 676d 656e 7465 6420 666f 7277  c augmented forw
-0001b5a0: 6172 6420 7275 6c65 2e0a 0a20 2020 2041  ard rule...    A
-0001b5b0: 7267 733a 0a20 2020 2020 2020 2073 796d  rgs:.        sym
-0001b5c0: 626f 6c20 2842 6f75 6e64 5379 6d62 6f6c  bol (BoundSymbol
-0001b5d0: 293a 2042 6f75 6e64 5379 6d62 6f6c 2074  ): BoundSymbol t
-0001b5e0: 6f20 6765 7420 7468 6520 7275 6c65 2066  o get the rule f
-0001b5f0: 6f72 2e0a 0a20 2020 2052 6574 7572 6e73  or...    Returns
-0001b600: 3a0a 2020 2020 2020 2020 5275 6c65 496e  :.        RuleIn
-0001b610: 666f 3a20 5275 6c65 2069 6e66 6f20 666f  fo: Rule info fo
-0001b620: 7220 7468 6520 7379 6d62 6f6c 2e0a 2020  r the symbol..  
-0001b630: 2020 2222 220a 2020 2020 6364 203d 2067    """.    cd = g
-0001b640: 6574 5f63 6f6d 7069 6c65 5f64 6174 6128  et_compile_data(
-0001b650: 290a 2020 2020 6966 2063 6420 6973 204e  ).    if cd is N
-0001b660: 6f6e 653a 0a20 2020 2020 2020 2072 6574  one:.        ret
-0001b670: 7572 6e20 4e6f 6e65 0a0a 2020 2020 2320  urn None..    # 
-0001b680: 5365 6172 6368 2066 6f72 2074 6865 2065  Search for the e
-0001b690: 7865 6375 746f 7220 7370 6563 6966 6963  xecutor specific
-0001b6a0: 2072 756c 6573 2e20 5768 656e 2074 6865   rules. When the
-0001b6b0: 7265 2061 7265 206d 756c 7469 706c 6520  re are multiple 
-0001b6c0: 7275 6c65 730a 2020 2020 2320 666f 7220  rules.    # for 
-0001b6d0: 7468 6520 7361 6d65 2073 796d 626f 6c2c  the same symbol,
-0001b6e0: 2077 6520 7573 6520 7468 6520 6c65 6674   we use the left
-0001b6f0: 2d6d 6f73 7420 6578 6563 7574 6f72 2069  -most executor i
-0001b700: 6e20 7468 6520 6c69 7374 2028 692e 652e  n the list (i.e.
-0001b710: 0a20 2020 2023 2074 6865 206f 6e65 2077  .    # the one w
-0001b720: 6974 6820 7468 6520 6869 6768 6573 7420  ith the highest 
-0001b730: 7072 696f 7269 7479 2920 616e 6420 7765  priority) and we
-0001b740: 2066 616c 6c62 6163 6b20 746f 2074 6865   fallback to the
-0001b750: 206e 6578 7420 6f6e 6520 6966 0a20 2020   next one if.   
-0001b760: 2023 2074 6865 2063 6865 636b 6572 2072   # the checker r
-0001b770: 6574 7572 6e73 2046 616c 7365 2e0a 2020  eturns False..  
-0001b780: 2020 666f 7220 6578 6563 7574 6f72 2069    for executor i
-0001b790: 6e20 6364 2e65 7865 6375 746f 7273 5f6c  n cd.executors_l
-0001b7a0: 6973 743a 0a20 2020 2020 2020 2063 616e  ist:.        can
-0001b7b0: 6469 6461 7465 203d 2061 7567 6d65 6e74  didate = augment
-0001b7c0: 6564 5f66 6f72 7761 7264 5f69 6d70 6c73  ed_forward_impls
-0001b7d0: 2e67 6574 2828 6578 6563 7574 6f72 2c20  .get((executor, 
-0001b7e0: 7379 6d62 6f6c 2e73 796d 2e69 6429 290a  symbol.sym.id)).
-0001b7f0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001b800: 7461 6e63 6528 6361 6e64 6964 6174 652c  tance(candidate,
-0001b810: 2052 756c 6549 6e66 6f29 2061 6e64 2063   RuleInfo) and c
-0001b820: 616e 6469 6461 7465 2e63 6865 636b 6572  andidate.checker
-0001b830: 282a 7379 6d62 6f6c 2e61 7267 732c 202a  (*symbol.args, *
-0001b840: 2a73 796d 626f 6c2e 6b77 6172 6773 293a  *symbol.kwargs):
-0001b850: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001b860: 7572 6e20 6361 6e64 6964 6174 650a 0a20  urn candidate.. 
-0001b870: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-0001b880: 0a64 6566 2069 735f 636f 6e73 7461 6e74  .def is_constant
-0001b890: 5f66 6f72 5f76 6a70 2873 796d 626f 6c3a  _for_vjp(symbol:
-0001b8a0: 2070 7269 6d73 2e53 796d 626f 6c29 202d   prims.Symbol) -
-0001b8b0: 3e20 626f 6f6c 3a0a 2020 2020 2222 2243  > bool:.    """C
-0001b8c0: 6865 636b 2069 6620 6120 7379 6d62 6f6c  heck if a symbol
-0001b8d0: 2069 7320 636f 6e73 7461 6e74 2066 6f72   is constant for
-0001b8e0: 2074 6865 2056 4a50 2074 7261 6e73 666f   the VJP transfo
-0001b8f0: 726d 2e0a 0a20 2020 2041 7267 733a 0a20  rm...    Args:. 
-0001b900: 2020 2020 2020 2073 796d 626f 6c20 2870         symbol (p
-0001b910: 7269 6d73 2e53 796d 626f 6c29 3a20 5379  rims.Symbol): Sy
-0001b920: 6d62 6f6c 2074 6f20 6368 6563 6b2e 0a0a  mbol to check...
-0001b930: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0001b940: 2020 2020 2062 6f6f 6c3a 2054 7275 6520       bool: True 
-0001b950: 6966 2074 6865 2073 796d 626f 6c20 6973  if the symbol is
-0001b960: 2063 6f6e 7374 616e 742c 2046 616c 7365   constant, False
-0001b970: 206f 7468 6572 7769 7365 2e0a 2020 2020   otherwise..    
-0001b980: 2222 220a 2020 2020 6172 655f 616c 6c5f  """.    are_all_
-0001b990: 6172 6773 5f6e 6f6e 5f64 6966 6665 7265  args_non_differe
-0001b9a0: 6e74 6961 626c 6520 3d20 6e6f 7420 616e  ntiable = not an
-0001b9b0: 7928 6973 696e 7374 616e 6365 2861 7267  y(isinstance(arg
-0001b9c0: 2c20 2846 6c6f 6174 5072 6f78 792c 2054  , (FloatProxy, T
-0001b9d0: 656e 736f 7250 726f 7879 2929 2066 6f72  ensorProxy)) for
-0001b9e0: 2061 7267 2069 6e20 7379 6d62 6f6c 2e66   arg in symbol.f
-0001b9f0: 6c61 745f 6172 6773 290a 2020 2020 7265  lat_args).    re
-0001ba00: 7475 726e 2028 0a20 2020 2020 2020 2061  turn (.        a
-0001ba10: 7265 5f61 6c6c 5f61 7267 735f 6e6f 6e5f  re_all_args_non_
-0001ba20: 6469 6666 6572 656e 7469 6162 6c65 0a20  differentiable. 
-0001ba30: 2020 2020 2020 206f 7220 7379 6d62 6f6c         or symbol
-0001ba40: 2e61 7265 5f61 6c6c 5f61 7267 735f 636f  .are_all_args_co
-0001ba50: 6e73 7461 6e74 0a20 2020 2020 2020 206f  nstant.        o
-0001ba60: 7220 7379 6d62 6f6c 2e73 796d 2e69 6420  r symbol.sym.id 
-0001ba70: 696e 206e 6f6e 6469 6666 6572 656e 7469  in nondifferenti
-0001ba80: 6162 6c65 5f76 6a70 5f73 796d 626f 6c73  able_vjp_symbols
-0001ba90: 0a20 2020 2029 0a0a 0a64 6566 2076 6a70  .    )...def vjp
-0001baa0: 5f73 796d 626f 6c5f 6d61 7070 6572 2873  _symbol_mapper(s
-0001bab0: 796d 626f 6c3a 2070 7269 6d73 2e53 796d  ymbol: prims.Sym
-0001bac0: 626f 6c2c 202a 6172 6773 2c20 2a2a 6b77  bol, *args, **kw
-0001bad0: 6172 6773 293a 0a20 2020 2022 2222 5379  args):.    """Sy
-0001bae0: 6d62 6f6c 206d 6170 7065 7220 666f 7220  mbol mapper for 
-0001baf0: 7468 6520 564a 5020 7472 616e 7366 6f72  the VJP transfor
-0001bb00: 6d2e 0a0a 2020 2020 4172 6773 3a0a 2020  m...    Args:.  
-0001bb10: 2020 2020 2020 7379 6d62 6f6c 2028 7072        symbol (pr
-0001bb20: 696d 732e 5379 6d62 6f6c 293a 2053 796d  ims.Symbol): Sym
-0001bb30: 626f 6c20 746f 2062 6520 6d61 7070 6564  bol to be mapped
-0001bb40: 2e0a 2020 2020 2020 2020 6172 6773 2028  ..        args (
-0001bb50: 5475 706c 655b 5661 7269 6162 6c65 5d29  Tuple[Variable])
-0001bb60: 3a20 4172 6775 6d65 6e74 7320 746f 2074  : Arguments to t
-0001bb70: 6865 2073 796d 626f 6c2e 0a20 2020 2020  he symbol..     
-0001bb80: 2020 206b 7761 7267 7320 2844 6963 745b     kwargs (Dict[
-0001bb90: 7374 722c 2056 6172 6961 626c 655d 293a  str, Variable]):
-0001bba0: 204b 6579 776f 7264 2061 7267 756d 656e   Keyword argumen
-0001bbb0: 7473 2074 6f20 7468 6520 7379 6d62 6f6c  ts to the symbol
-0001bbc0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-0001bbd0: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
-0001bbe0: 3a20 4120 6675 6e63 7469 6f6e 2074 6861  : A function tha
-0001bbf0: 7420 636f 6d70 7574 6573 2074 6865 2056  t computes the V
-0001bc00: 4a50 206f 6620 7468 6520 7379 6d62 6f6c  JP of the symbol
-0001bc10: 2e0a 2020 2020 2222 220a 2020 2020 2320  ..    """.    # 
-0001bc20: 436f 6e73 7461 6e74 2063 6173 650a 2020  Constant case.  
-0001bc30: 2020 6966 2069 735f 636f 6e73 7461 6e74    if is_constant
-0001bc40: 5f66 6f72 5f76 6a70 2873 796d 626f 6c29  _for_vjp(symbol)
-0001bc50: 3a0a 0a20 2020 2020 2020 2064 6566 2076  :..        def v
-0001bc60: 6a70 5f69 6d70 6c5f 636f 6e73 7428 7379  jp_impl_const(sy
-0001bc70: 6d62 6f6c 2c20 2a61 7267 732c 202a 2a6b  mbol, *args, **k
-0001bc80: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-0001bc90: 2020 2020 6172 6773 2c20 6b77 6172 6773      args, kwargs
-0001bca0: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
-0001bcb0: 6461 2078 3a20 782e 7072 696d 616c 2069  da x: x.primal i
-0001bcc0: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-0001bcd0: 564a 5044 7561 6c29 2065 6c73 6520 782c  VJPDual) else x,
-0001bce0: 2028 6172 6773 2c20 6b77 6172 6773 2929   (args, kwargs))
-0001bcf0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0001bd00: 6d61 6c73 203d 2073 796d 626f 6c5f 746f  mals = symbol_to
-0001bd10: 5f65 7661 6c28 7379 6d62 6f6c 2928 2a61  _eval(symbol)(*a
-0001bd20: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
-0001bd30: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0001bd40: 696e 7374 616e 6365 2870 7269 6d61 6c73  instance(primals
-0001bd50: 2c20 5365 7175 656e 6365 293a 0a20 2020  , Sequence):.   
-0001bd60: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0001bd70: 7572 6e20 7472 6565 5f6d 6170 286c 616d  urn tree_map(lam
-0001bd80: 6264 6120 783a 2056 4a50 4475 616c 2878  bda x: VJPDual(x
-0001bd90: 2c20 7475 706c 6528 2929 2c20 7072 696d  , tuple()), prim
-0001bda0: 616c 7329 0a20 2020 2020 2020 2020 2020  als).           
-0001bdb0: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
-0001bdc0: 7072 696d 616c 732c 2074 7570 6c65 2829  primals, tuple()
-0001bdd0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-0001bde0: 6e20 7061 7274 6961 6c28 766a 705f 696d  n partial(vjp_im
-0001bdf0: 706c 5f63 6f6e 7374 2c20 7379 6d62 6f6c  pl_const, symbol
-0001be00: 290a 0a20 2020 2023 204e 6f72 6d61 6c20  )..    # Normal 
-0001be10: 6361 7365 2c20 7765 2068 6176 6520 6120  case, we have a 
-0001be20: 7072 6f78 7920 7461 6e67 656e 740a 2020  proxy tangent.  
-0001be30: 2020 766a 705f 696d 706c 203d 2061 7567    vjp_impl = aug
-0001be40: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
-0001be50: 6d70 6c73 2e67 6574 2873 796d 626f 6c2e  mpls.get(symbol.
-0001be60: 7379 6d2e 6964 290a 2020 2020 766a 705f  sym.id).    vjp_
-0001be70: 696d 706c 203d 2067 6574 5f65 7865 6375  impl = get_execu
-0001be80: 746f 725f 7370 6563 6966 6963 5f61 7567  tor_specific_aug
-0001be90: 5f66 7764 5f72 756c 6528 7379 6d62 6f6c  _fwd_rule(symbol
-0001bea0: 2920 6f72 2076 6a70 5f69 6d70 6c0a 0a20  ) or vjp_impl.. 
-0001beb0: 2020 2069 6620 5f67 6574 5f67 7261 6466     if _get_gradf
-0001bec0: 6e28 7379 6d62 6f6c 2920 6973 206e 6f74  n(symbol) is not
-0001bed0: 204e 6f6e 653a 0a20 2020 2020 2020 2076   None:.        v
-0001bee0: 6a70 5f69 6d70 6c2c 2062 6163 6b77 6172  jp_impl, backwar
-0001bef0: 645f 666e 203d 206d 616b 655f 6175 675f  d_fn = make_aug_
-0001bf00: 666f 7277 6172 645f 616e 645f 6261 636b  forward_and_back
-0001bf10: 7761 7264 2873 796d 626f 6c29 0a0a 2020  ward(symbol)..  
-0001bf20: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0001bf30: 766a 705f 696d 706c 2c20 5275 6c65 496e  vjp_impl, RuleIn
-0001bf40: 666f 293a 0a20 2020 2020 2020 2023 2057  fo):.        # W
-0001bf50: 6520 7368 6f75 6c64 2075 7365 2074 6869  e should use thi
-0001bf60: 7320 7275 6c65 206f 6e6c 7920 6966 2063  s rule only if c
-0001bf70: 6865 636b 6572 2072 6574 7572 6e73 2054  hecker returns T
-0001bf80: 7275 6520 666f 7220 7468 6520 6375 7272  rue for the curr
-0001bf90: 656e 740a 2020 2020 2020 2020 2320 7379  ent.        # sy
-0001bfa0: 6d62 6f6c 2773 2061 7267 756d 656e 7473  mbol's arguments
-0001bfb0: 0a20 2020 2020 2020 2069 6620 766a 705f  .        if vjp_
-0001bfc0: 696d 706c 2e63 6865 636b 6572 282a 7379  impl.checker(*sy
-0001bfd0: 6d62 6f6c 2e61 7267 732c 202a 2a73 796d  mbol.args, **sym
-0001bfe0: 626f 6c2e 6b77 6172 6773 293a 0a20 2020  bol.kwargs):.   
-0001bff0: 2020 2020 2020 2020 2076 6a70 5f69 6d70           vjp_imp
-0001c000: 6c20 3d20 766a 705f 696d 706c 2e72 756c  l = vjp_impl.rul
-0001c010: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-0001c020: 2020 2020 2020 2020 2020 2020 766a 705f              vjp_
-0001c030: 696d 706c 203d 2076 6a70 5f69 6d70 6c2e  impl = vjp_impl.
-0001c040: 6677 5f66 616c 6c62 6163 6b0a 0a20 2020  fw_fallback..   
-0001c050: 2069 6620 766a 705f 696d 706c 2069 7320   if vjp_impl is 
-0001c060: 4e6f 6e65 3a0a 2020 2020 2020 2020 2320  None:.        # 
-0001c070: 5765 2063 6f75 6c64 206e 6f74 2066 696e  We could not fin
-0001c080: 6420 6120 564a 5020 666f 7220 7468 6973  d a VJP for this
-0001c090: 2073 796d 626f 6c2c 2073 6f20 7765 2074   symbol, so we t
-0001c0a0: 7279 2074 6f20 6465 636f 6d70 6f73 6520  ry to decompose 
-0001c0b0: 6974 0a20 2020 2020 2020 2069 6620 6c65  it.        if le
-0001c0c0: 6e28 7379 6d62 6f6c 2e73 7562 7379 6d62  n(symbol.subsymb
-0001c0d0: 6f6c 7329 203e 2030 2061 6e64 206e 6f74  ols) > 0 and not
-0001c0e0: 2069 7369 6e73 7461 6e63 6528 7379 6d62   isinstance(symb
-0001c0f0: 6f6c 2e73 796d 2e69 642c 2070 7269 6d73  ol.sym.id, prims
-0001c100: 2e50 7269 6d49 4473 293a 0a20 2020 2020  .PrimIDs):.     
-0001c110: 2020 2020 2020 2076 6a70 5f69 6d70 6c20         vjp_impl 
-0001c120: 3d20 7061 7274 6961 6c28 6465 636f 6d70  = partial(decomp
-0001c130: 6f73 6564 5f66 6e5f 6175 675f 6677 645f  osed_fn_aug_fwd_
-0001c140: 7275 6c65 2c20 6465 636f 6d70 6f73 6564  rule, decomposed
-0001c150: 5f66 6e3d 7379 6d62 6f6c 2e73 796d 290a  _fn=symbol.sym).
-0001c160: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001c170: 2020 2020 2020 2020 2020 2320 5765 2063            # We c
-0001c180: 6f75 6c64 206e 6f74 2066 696e 6420 6120  ould not find a 
-0001c190: 564a 5020 666f 7220 7468 6973 2073 796d  VJP for this sym
-0001c1a0: 626f 6c20 616e 6420 7765 2063 6f75 6c64  bol and we could
-0001c1b0: 206e 6f74 2064 6563 6f6d 706f 7365 2069   not decompose i
-0001c1c0: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-0001c1d0: 4974 2063 6f75 6c64 2062 6520 6120 746f  It could be a to
-0001c1e0: 7263 682e 6472 6f70 6f75 7420 7769 7468  rch.dropout with
-0001c1f0: 2030 2e30 2070 726f 6261 6269 6c69 7479   0.0 probability
-0001c200: 2c20 736f 2077 6520 736b 6970 2069 740a  , so we skip it.
-0001c210: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0001c220: 796d 626f 6c2e 7379 6d2e 6964 203d 3d20  ymbol.sym.id == 
-0001c230: 2274 6f72 6368 2e6e 6e2e 6675 6e63 7469  "torch.nn.functi
-0001c240: 6f6e 616c 2e64 726f 706f 7574 223a 0a20  onal.dropout":. 
-0001c250: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001c260: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
-0001c270: 2020 2020 2020 2070 7269 6e74 2866 2256         print(f"V
-0001c280: 4a50 2066 6f72 207b 7379 6d62 6f6c 7d20  JP for {symbol} 
-0001c290: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
-0001c2a0: 6564 2229 0a20 2020 2020 2020 2020 2020  ed").           
-0001c2b0: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
-0001c2c0: 656e 7465 6445 7272 6f72 2866 2256 4a50  entedError(f"VJP
-0001c2d0: 2066 6f72 207b 7379 6d62 6f6c 2e73 796d   for {symbol.sym
-0001c2e0: 2e69 647d 2069 7320 6e6f 7420 696d 706c  .id} is not impl
-0001c2f0: 656d 656e 7465 6422 290a 0a20 2020 2064  emented")..    d
-0001c300: 6566 205f 766a 705f 696d 706c 282a 6172  ef _vjp_impl(*ar
-0001c310: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
-0001c320: 2020 2020 2020 2070 7269 6d61 6c73 2c20         primals, 
-0001c330: 6b77 6172 6773 203d 2074 7265 655f 6d61  kwargs = tree_ma
-0001c340: 7028 6c61 6d62 6461 2078 3a20 782e 7072  p(lambda x: x.pr
-0001c350: 696d 616c 2069 6620 6973 696e 7374 616e  imal if isinstan
-0001c360: 6365 2878 2c20 564a 5044 7561 6c29 2065  ce(x, VJPDual) e
-0001c370: 6c73 6520 782c 2028 6172 6773 2c20 6b77  lse x, (args, kw
-0001c380: 6172 6773 2929 0a20 2020 2020 2020 206f  args)).        o
-0001c390: 7574 5f70 7269 6d61 6c2c 206f 7574 5f72  ut_primal, out_r
-0001c3a0: 6573 6964 7561 6c73 203d 2076 6a70 5f69  esiduals = vjp_i
-0001c3b0: 6d70 6c28 2a70 7269 6d61 6c73 2c20 2a2a  mpl(*primals, **
-0001c3c0: 6b77 6172 6773 290a 0a20 2020 2020 2020  kwargs)..       
-0001c3d0: 2023 2057 6520 6172 6520 7361 7669 6e67   # We are saving
-0001c3e0: 2074 6865 2072 6573 6964 7561 6c73 2061   the residuals a
-0001c3f0: 6e64 2070 756c 6c62 6163 6b20 6f6e 6c79  nd pullback only
-0001c400: 2069 6e20 7468 6520 6669 7273 7420 6f75   in the first ou
-0001c410: 7470 7574 0a20 2020 2020 2020 2023 2062  tput.        # b
-0001c420: 6163 6b77 6172 645f 7061 7373 2074 6865  ackward_pass the
-0001c430: 6e20 7265 7472 6965 7665 7320 7468 6520  n retrieves the 
-0001c440: 7265 7369 6475 616c 7320 616e 6420 7075  residuals and pu
-0001c450: 6c6c 6261 636b 2066 726f 6d20 7468 6520  llback from the 
-0001c460: 6669 7273 7420 6f75 7470 7574 0a20 2020  first output.   
-0001c470: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0001c480: 6365 286f 7574 5f70 7269 6d61 6c2c 2053  ce(out_primal, S
-0001c490: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-0001c4a0: 2020 2020 2020 7265 7475 726e 2028 564a        return (VJ
-0001c4b0: 5044 7561 6c28 6f75 745f 7072 696d 616c  PDual(out_primal
-0001c4c0: 5b30 5d2c 206f 7574 5f72 6573 6964 7561  [0], out_residua
-0001c4d0: 6c73 292c 202a 2856 4a50 4475 616c 286f  ls), *(VJPDual(o
-0001c4e0: 2c20 7475 706c 6528 2929 2066 6f72 206f  , tuple()) for o
-0001c4f0: 2069 6e20 6f75 745f 7072 696d 616c 5b31   in out_primal[1
-0001c500: 3a5d 2929 0a0a 2020 2020 2020 2020 7265  :]))..        re
-0001c510: 7475 726e 2028 564a 5044 7561 6c28 6f75  turn (VJPDual(ou
-0001c520: 745f 7072 696d 616c 2c20 6f75 745f 7265  t_primal, out_re
-0001c530: 7369 6475 616c 7329 2c29 0a0a 2020 2020  siduals),)..    
-0001c540: 7265 7475 726e 205f 766a 705f 696d 706c  return _vjp_impl
-0001c550: 0a0a 0a64 6566 2063 6865 636b 5f62 7379  ...def check_bsy
-0001c560: 6d5f 666f 725f 766a 7028 6273 796d 293a  m_for_vjp(bsym):
-0001c570: 0a20 2020 2022 2222 0a20 2020 2043 6865  .    """.    Che
-0001c580: 636b 2069 6620 6120 626f 756e 6420 7379  ck if a bound sy
-0001c590: 6d62 6f6c 2069 7320 7375 7070 6f72 7465  mbol is supporte
-0001c5a0: 6420 6279 2076 6a70 2e0a 0a20 2020 2041  d by vjp...    A
-0001c5b0: 7267 733a 0a20 2020 2020 2020 2062 7379  rgs:.        bsy
-0001c5c0: 6d20 2842 6f75 6e64 5379 6d62 6f6c 293a  m (BoundSymbol):
-0001c5d0: 2054 6865 2062 6f75 6e64 2073 796d 626f   The bound symbo
-0001c5e0: 6c20 746f 2063 6865 636b 2e0a 0a20 2020  l to check...   
-0001c5f0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0001c600: 2020 626f 6f6c 3a20 5472 7565 2069 6620    bool: True if 
-0001c610: 7468 6520 626f 756e 6420 7379 6d62 6f6c  the bound symbol
-0001c620: 2069 7320 7375 7070 6f72 7465 6420 6279   is supported by
-0001c630: 2076 6a70 2c20 4661 6c73 6520 6f74 6865   vjp, False othe
-0001c640: 7277 6973 652e 0a20 2020 2022 2222 0a0a  rwise..    """..
-0001c650: 2020 2020 6966 2062 7379 6d2e 7379 6d2e      if bsym.sym.
-0001c660: 6964 2069 6e20 7472 616e 7366 6f72 6d5f  id in transform_
-0001c670: 736b 6970 5f6c 6973 743a 0a20 2020 2020  skip_list:.     
-0001c680: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
-0001c690: 2020 2020 6966 2062 7379 6d2e 7379 6d2e      if bsym.sym.
-0001c6a0: 6964 2069 6e20 6261 636b 7761 7264 5f69  id in backward_i
-0001c6b0: 6d70 6c73 2061 6e64 2062 7379 6d2e 7379  mpls and bsym.sy
-0001c6c0: 6d2e 6964 2069 6e20 6175 676d 656e 7465  m.id in augmente
-0001c6d0: 645f 666f 7277 6172 645f 696d 706c 733a  d_forward_impls:
-0001c6e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001c6f0: 5472 7565 0a0a 2020 2020 6966 2062 7379  True..    if bsy
-0001c700: 6d2e 7379 6d2e 6964 2069 6e20 5f67 7261  m.sym.id in _gra
-0001c710: 645f 666e 5f6d 6170 3a0a 2020 2020 2020  d_fn_map:.      
-0001c720: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
-0001c730: 2020 2023 2057 6520 636f 756c 6420 6e6f     # We could no
-0001c740: 7420 6669 6e64 2061 2056 4a50 2066 6f72  t find a VJP for
-0001c750: 2074 6869 7320 7379 6d62 6f6c 2c20 736f   this symbol, so
-0001c760: 2077 6520 7472 7920 746f 2064 6563 6f6d   we try to decom
-0001c770: 706f 7365 2069 740a 2020 2020 2320 696e  pose it.    # in
-0001c780: 746f 2073 7562 2d73 796d 626f 6c73 2061  to sub-symbols a
-0001c790: 6e64 2063 6865 636b 2069 6620 7468 6579  nd check if they
-0001c7a0: 2061 7265 2073 7570 706f 7274 6564 0a20   are supported. 
-0001c7b0: 2020 2069 6620 6c65 6e28 6273 796d 2e73     if len(bsym.s
-0001c7c0: 7562 7379 6d62 6f6c 7329 203e 2030 2061  ubsymbols) > 0 a
-0001c7d0: 6e64 206e 6f74 2062 7379 6d2e 7379 6d2e  nd not bsym.sym.
-0001c7e0: 6973 5f70 7269 6d3a 0a20 2020 2020 2020  is_prim:.       
-0001c7f0: 2073 7562 7472 6163 6520 3d20 636f 6e73   subtrace = cons
-0001c800: 7472 7563 745f 7472 6163 6528 2928 6273  truct_trace()(bs
-0001c810: 796d 2e73 796d 2c20 2a62 7379 6d2e 6172  ym.sym, *bsym.ar
-0001c820: 6773 2c20 2a2a 6273 796d 2e6b 7761 7267  gs, **bsym.kwarg
-0001c830: 7329 0a20 2020 2020 2020 2073 7562 7472  s).        subtr
-0001c840: 6163 6520 3d20 756e 7772 6170 5f6f 6e65  ace = unwrap_one
-0001c850: 5f6c 6576 656c 5f6f 665f 7375 6273 796d  _level_of_subsym
-0001c860: 626f 6c73 2873 7562 7472 6163 6529 0a20  bols(subtrace). 
-0001c870: 2020 2020 2020 2061 6c6c 5f73 7570 706f         all_suppo
-0001c880: 7274 6564 203d 2061 6c6c 2863 6865 636b  rted = all(check
-0001c890: 5f62 7379 6d5f 666f 725f 766a 7028 7375  _bsym_for_vjp(su
-0001c8a0: 6262 7379 6d29 2066 6f72 2073 7562 6273  bbsym) for subbs
-0001c8b0: 796d 2069 6e20 7375 6274 7261 6365 2e62  ym in subtrace.b
-0001c8c0: 6f75 6e64 5f73 796d 626f 6c73 290a 2020  ound_symbols).  
-0001c8d0: 2020 2020 2020 7265 7475 726e 2061 6c6c        return all
-0001c8e0: 5f73 7570 706f 7274 6564 0a0a 2020 2020  _supported..    
-0001c8f0: 7265 7475 726e 2046 616c 7365 0a0a 0a64  return False...d
-0001c900: 6566 2061 7567 6d65 6e74 6564 5f66 6f72  ef augmented_for
-0001c910: 7761 7264 5f70 6173 7328 2a61 7267 732c  ward_pass(*args,
-0001c920: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
-0001c930: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
-0001c940: 2241 7567 6d65 6e74 6564 2066 6f72 7761  "Augmented forwa
-0001c950: 7264 2070 6173 7320 666f 7220 7468 6520  rd pass for the 
-0001c960: 564a 5020 7472 616e 7366 6f72 6d2e 0a0a  VJP transform...
-0001c970: 2020 2020 5468 6520 6175 676d 656e 7465      The augmente
-0001c980: 6420 666f 7277 6172 6420 7061 7373 2069  d forward pass i
-0001c990: 7320 6120 666f 7277 6172 6420 7061 7373  s a forward pass
-0001c9a0: 2074 6861 7420 7265 7475 726e 7320 7468   that returns th
-0001c9b0: 6520 7265 7369 6475 616c 730a 2020 2020  e residuals.    
-0001c9c0: 6f66 2074 6865 2066 6f72 7761 7264 2070  of the forward p
-0001c9d0: 6173 732e 0a20 2020 2054 6865 7365 2072  ass..    These r
-0001c9e0: 6573 6964 7561 6c73 2061 7265 2075 7365  esiduals are use
-0001c9f0: 6420 696e 2074 6865 2062 6163 6b77 6172  d in the backwar
-0001ca00: 6420 7061 7373 2074 6f20 636f 6d70 7574  d pass to comput
-0001ca10: 6520 7468 6520 564a 5020 616e 6420 7468  e the VJP and th
-0001ca20: 6579 0a20 2020 2061 7265 2072 6563 6f72  ey.    are recor
-0001ca30: 6465 6420 696e 2074 6865 2065 6e76 6972  ded in the envir
-0001ca40: 6f6e 6d65 6e74 2064 6963 7469 6f6e 6172  onment dictionar
-0001ca50: 7920 666f 7220 6561 6368 2076 6172 6961  y for each varia
-0001ca60: 626c 652e 0a0a 2020 2020 4172 6773 3a0a  ble...    Args:.
-0001ca70: 2020 2020 2020 2020 6172 6773 2028 5475          args (Tu
-0001ca80: 706c 655b 5661 7269 6162 6c65 5d29 3a20  ple[Variable]): 
-0001ca90: 4172 6775 6d65 6e74 7320 746f 2074 6865  Arguments to the
-0001caa0: 2066 756e 6374 696f 6e2e 0a20 2020 2020   function..     
-0001cab0: 2020 2074 7261 6365 2028 5472 6163 6529     trace (Trace)
-0001cac0: 3a20 5472 6163 6520 6f66 2074 6865 2066  : Trace of the f
-0001cad0: 756e 6374 696f 6e2e 0a20 2020 2020 2020  unction..       
-0001cae0: 206b 7761 7267 7320 2844 6963 745b 7374   kwargs (Dict[st
-0001caf0: 722c 2056 6172 6961 626c 655d 293a 204b  r, Variable]): K
-0001cb00: 6579 776f 7264 2061 7267 756d 656e 7473  eyword arguments
-0001cb10: 2074 6f20 7468 6520 6675 6e63 7469 6f6e   to the function
-0001cb20: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-0001cb30: 2020 2020 2020 2020 5475 706c 655b 416e          Tuple[An
-0001cb40: 792c 2044 6963 745b 7374 722c 2041 6e79  y, Dict[str, Any
-0001cb50: 5d5d 3a20 5475 706c 6520 6f66 2074 6865  ]]: Tuple of the
-0001cb60: 2070 7269 6d61 6c20 6f75 7470 7574 7320   primal outputs 
-0001cb70: 616e 6420 7468 6520 656e 7669 726f 6e6d  and the environm
-0001cb80: 656e 742e 0a20 2020 2022 2222 0a20 2020  ent..    """.   
-0001cb90: 2061 7267 732c 206b 7761 7267 7320 3d20   args, kwargs = 
-0001cba0: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
-0001cbb0: 783a 2056 4a50 4475 616c 2878 2c20 7475  x: VJPDual(x, tu
-0001cbc0: 706c 6528 2929 2c20 2861 7267 732c 206b  ple()), (args, k
-0001cbd0: 7761 7267 7329 290a 2020 2020 7265 7375  wargs)).    resu
-0001cbe0: 6c74 2c20 656e 7620 3d20 6576 616c 5f74  lt, env = eval_t
-0001cbf0: 7261 6365 280a 2020 2020 2020 2020 7472  race(.        tr
-0001cc00: 6163 652c 0a20 2020 2020 2020 202a 6172  ace,.        *ar
-0001cc10: 6773 2c0a 2020 2020 2020 2020 2a2a 6b77  gs,.        **kw
-0001cc20: 6172 6773 2c0a 2020 2020 2020 2020 7769  args,.        wi
-0001cc30: 7468 5f65 6e76 3d54 7275 652c 0a20 2020  th_env=True,.   
-0001cc40: 2020 2020 2073 796d 626f 6c5f 6d61 7070       symbol_mapp
-0001cc50: 6572 3d76 6a70 5f73 796d 626f 6c5f 6d61  er=vjp_symbol_ma
-0001cc60: 7070 6572 2c0a 2020 2020 290a 2020 2020  pper,.    ).    
-0001cc70: 7265 7375 6c74 203d 2074 7265 655f 6d61  result = tree_ma
-0001cc80: 7028 6c61 6d62 6461 2078 3a20 782e 7072  p(lambda x: x.pr
-0001cc90: 696d 616c 2069 6620 6973 696e 7374 616e  imal if isinstan
-0001cca0: 6365 2878 2c20 564a 5044 7561 6c29 2065  ce(x, VJPDual) e
-0001ccb0: 6c73 6520 782c 2072 6573 756c 7429 0a20  lse x, result). 
-0001ccc0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-0001ccd0: 2c20 656e 760a 0a0a 2320 544f 444f 3a20  , env...# TODO: 
-0001cce0: 496e 7374 6561 6420 6f66 2075 7369 6e67  Instead of using
-0001ccf0: 2074 6865 2065 6e76 6972 6f6e 6d65 6e74   the environment
-0001cd00: 2064 6963 7469 6f6e 6172 792c 2077 6520   dictionary, we 
-0001cd10: 636f 756c 6420 7573 6520 7468 6520 7472  could use the tr
-0001cd20: 6163 650a 2320 7379 6d62 6f6c 7320 6f72  ace.# symbols or
-0001cd30: 6465 7220 2874 6861 7420 7368 6f75 6c64  der (that should
-0001cd40: 2062 6520 6465 7465 726d 696e 6973 7469   be deterministi
-0001cd50: 6329 2074 6f20 7265 7472 6965 7665 2074  c) to retrieve t
-0001cd60: 6865 2072 6573 6964 7561 6c73 206e 6565  he residuals nee
-0001cd70: 6465 640a 2320 666f 7220 7468 6520 6261  ded.# for the ba
-0001cd80: 636b 7761 7264 2070 6173 732e 0a64 6566  ckward pass..def
-0001cd90: 2062 6163 6b77 6172 645f 7061 7373 2866   backward_pass(f
-0001cda0: 6f72 7761 7264 5f65 6e76 2c20 7472 6163  orward_env, trac
-0001cdb0: 652c 2069 6e69 745f 636f 7461 6e67 656e  e, init_cotangen
-0001cdc0: 7473 293a 0a20 2020 2022 2222 4261 636b  ts):.    """Back
-0001cdd0: 7761 7264 2070 6173 7320 666f 7220 7468  ward pass for th
-0001cde0: 6520 564a 5020 7472 616e 7366 6f72 6d2e  e VJP transform.
-0001cdf0: 0a0a 2020 2020 5468 6520 6261 636b 7761  ..    The backwa
-0001ce00: 7264 2070 6173 7320 6973 2061 2072 6576  rd pass is a rev
-0001ce10: 6572 7365 206d 6f64 6520 6175 746f 6d61  erse mode automa
-0001ce20: 7469 6320 6469 6666 6572 656e 7469 6174  tic differentiat
-0001ce30: 696f 6e20 7061 7373 2074 6861 740a 2020  ion pass that.  
-0001ce40: 2020 636f 6d70 7574 6573 2074 6865 2076    computes the v
-0001ce50: 6563 746f 722d 4a61 636f 6269 616e 2070  ector-Jacobian p
-0001ce60: 726f 6475 6374 2028 564a 5029 206f 6620  roduct (VJP) of 
-0001ce70: 7468 6520 6675 6e63 7469 6f6e 2e0a 0a20  the function... 
-0001ce80: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0001ce90: 2066 6f72 7761 7264 5f65 6e76 2028 4469   forward_env (Di
-0001cea0: 6374 5b73 7472 2c20 416e 795d 293a 2045  ct[str, Any]): E
-0001ceb0: 6e76 6972 6f6e 6d65 6e74 206f 6620 7468  nvironment of th
-0001cec0: 6520 666f 7277 6172 6420 7061 7373 2e0a  e forward pass..
-0001ced0: 2020 2020 2020 2020 7472 6163 6520 2854          trace (T
-0001cee0: 7261 6365 293a 2054 7261 6365 206f 6620  race): Trace of 
-0001cef0: 7468 6520 6675 6e63 7469 6f6e 2e0a 2020  the function..  
-0001cf00: 2020 2020 2020 696e 6974 5f63 6f74 616e        init_cotan
-0001cf10: 6765 6e74 7320 2854 7570 6c65 5b56 6172  gents (Tuple[Var
-0001cf20: 6961 626c 655d 293a 2049 6e69 7469 616c  iable]): Initial
-0001cf30: 2063 6f74 616e 6765 6e74 732e 0a0a 2020   cotangents...  
-0001cf40: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-0001cf50: 2020 2054 7570 6c65 5b50 726f 7879 2c20     Tuple[Proxy, 
-0001cf60: 2e2e 2e5d 3a20 5475 706c 6520 6f66 2074  ...]: Tuple of t
-0001cf70: 6865 2072 6573 756c 7473 206f 6620 7468  he results of th
-0001cf80: 6520 6261 636b 7761 7264 2070 6173 7320  e backward pass 
-0001cf90: 666f 7220 6561 6368 2069 6e70 7574 2e0a  for each input..
-0001cfa0: 2020 2020 2222 220a 2020 2020 656e 7620      """.    env 
-0001cfb0: 3d20 7b7d 0a0a 2020 2020 6465 6620 6765  = {}..    def ge
-0001cfc0: 745f 6772 6164 2878 3a20 5661 7269 6162  t_grad(x: Variab
-0001cfd0: 6c65 293a 0a20 2020 2020 2020 2069 6620  le):.        if 
-0001cfe0: 6973 696e 7374 616e 6365 2878 2c20 5661  isinstance(x, Va
-0001cff0: 7269 6162 6c65 293a 0a20 2020 2020 2020  riable):.       
-0001d000: 2020 2020 2023 2052 6574 7572 6e20 4e6f       # Return No
-0001d010: 6e65 2069 6620 7468 6520 7661 7269 6162  ne if the variab
-0001d020: 6c65 2077 6173 206e 6f74 2075 7365 6420  le was not used 
-0001d030: 696e 2074 6865 2063 6f6d 7075 7461 7469  in the computati
-0001d040: 6f6e 2061 6e64 0a20 2020 2020 2020 2020  on and.         
-0001d050: 2020 2023 2068 656e 6365 206e 6f74 2069     # hence not i
-0001d060: 6e20 7468 6520 656e 760a 2020 2020 2020  n the env.      
-0001d070: 2020 2020 2020 7265 7475 726e 2065 6e76        return env
-0001d080: 2e67 6574 2878 2e6e 616d 652c 204e 6f6e  .get(x.name, Non
-0001d090: 6529 0a20 2020 2020 2020 2065 6c73 653a  e).        else:
-0001d0a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001d0b0: 7572 6e20 780a 0a20 2020 2064 6566 2070  urn x..    def p
-0001d0c0: 7574 5f67 7261 6428 763a 2056 6172 6961  ut_grad(v: Varia
-0001d0d0: 626c 652c 2076 616c 3a20 416e 7929 202d  ble, val: Any) -
-0001d0e0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0001d0f0: 6966 2069 7369 6e73 7461 6e63 6528 762c  if isinstance(v,
-0001d100: 2056 6172 6961 626c 6529 3a0a 2020 2020   Variable):.    
-0001d110: 2020 2020 2020 2020 6966 2076 2e6e 616d          if v.nam
-0001d120: 6520 696e 2065 6e76 3a0a 2020 2020 2020  e in env:.      
-0001d130: 2020 2020 2020 2020 2020 6966 2076 616c            if val
-0001d140: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0001d150: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001d160: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
-0001d170: 2020 2020 2023 2041 6363 756d 756c 6174       # Accumulat
-0001d180: 6520 636f 7461 6e67 656e 7473 0a20 2020  e cotangents.   
-0001d190: 2020 2020 2020 2020 2020 2020 2065 6e76               env
-0001d1a0: 5b76 2e6e 616d 655d 203d 2063 6c61 6e67  [v.name] = clang
-0001d1b0: 2e61 6464 2865 6e76 5b76 2e6e 616d 655d  .add(env[v.name]
-0001d1c0: 2c20 7661 6c29 2069 6620 656e 765b 762e  , val) if env[v.
-0001d1d0: 6e61 6d65 5d20 6973 206e 6f74 204e 6f6e  name] is not Non
-0001d1e0: 6520 656c 7365 2076 616c 0a20 2020 2020  e else val.     
-0001d1f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001d200: 6e0a 2020 2020 2020 2020 2020 2020 656e  n.            en
-0001d210: 765b 762e 6e61 6d65 5d20 3d20 7661 6c0a  v[v.name] = val.
-0001d220: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-0001d230: 6e73 7461 6e63 6528 762c 2053 6571 7565  nstance(v, Seque
-0001d240: 6e63 6529 2061 6e64 2061 6c6c 2869 7369  nce) and all(isi
-0001d250: 6e73 7461 6e63 6528 782c 2069 6e74 2920  nstance(x, int) 
-0001d260: 666f 7220 7820 696e 2076 293a 0a20 2020  for x in v):.   
-0001d270: 2020 2020 2020 2020 2023 2054 4f44 4f3a           # TODO:
-0001d280: 2072 656d 6f76 6520 7768 656e 2077 6520   remove when we 
-0001d290: 6d6f 7665 2064 696d 7320 746f 206b 7761  move dims to kwa
-0001d2a0: 7267 730a 2020 2020 2020 2020 2020 2020  rgs.            
-0001d2b0: 7061 7373 0a20 2020 2020 2020 2065 6c69  pass.        eli
-0001d2c0: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
-0001d2d0: 7374 7229 3a0a 2020 2020 2020 2020 2020  str):.          
-0001d2e0: 2020 656e 765b 765d 203d 2076 616c 0a20    env[v] = val. 
-0001d2f0: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
-0001d300: 7374 616e 6365 2876 2c20 5365 7175 656e  stance(v, Sequen
-0001d310: 6365 2920 616e 6420 7661 6c20 6973 204e  ce) and val is N
-0001d320: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001d330: 2023 2062 726f 6164 6361 7374 204e 6f6e   # broadcast Non
-0001d340: 6520 746f 2074 6865 2072 6967 6874 2073  e to the right s
-0001d350: 6861 7065 0a20 2020 2020 2020 2020 2020  hape.           
-0001d360: 2073 6166 655f 6d61 7028 7075 745f 6772   safe_map(put_gr
-0001d370: 6164 2c20 762c 205b 4e6f 6e65 5d20 2a20  ad, v, [None] * 
-0001d380: 6c65 6e28 7629 290a 2020 2020 2020 2020  len(v)).        
-0001d390: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-0001d3a0: 762c 2053 6571 7565 6e63 6529 2061 6e64  v, Sequence) and
-0001d3b0: 2069 7369 6e73 7461 6e63 6528 7661 6c2c   isinstance(val,
-0001d3c0: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
-0001d3d0: 2020 2020 2020 2020 7361 6665 5f6d 6170          safe_map
-0001d3e0: 5f66 6c61 7428 7075 745f 6772 6164 2c20  _flat(put_grad, 
-0001d3f0: 762c 2076 616c 290a 2020 2020 2020 2020  v, val).        
-0001d400: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001d410: 2020 2320 536b 6970 2077 7269 7469 6e67    # Skip writing
-0001d420: 2074 6f20 636f 6e73 7461 6e74 730a 2020   to constants.  
-0001d430: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
-0001d440: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0001d450: 6528 696e 6974 5f63 6f74 616e 6765 6e74  e(init_cotangent
-0001d460: 732c 2053 6571 7565 6e63 6529 2061 6e64  s, Sequence) and
-0001d470: 206c 656e 2869 6e69 745f 636f 7461 6e67   len(init_cotang
-0001d480: 656e 7473 2920 3d3d 2031 2061 6e64 206e  ents) == 1 and n
-0001d490: 6f74 2069 7369 6e73 7461 6e63 6528 7472  ot isinstance(tr
-0001d4a0: 6163 652e 6f75 7470 7574 2c20 5365 7175  ace.output, Sequ
-0001d4b0: 656e 6365 293a 0a20 2020 2020 2020 2069  ence):.        i
-0001d4c0: 6e69 745f 636f 7461 6e67 656e 7473 203d  nit_cotangents =
-0001d4d0: 2069 6e69 745f 636f 7461 6e67 656e 7473   init_cotangents
-0001d4e0: 5b30 5d0a 2020 2020 7361 6665 5f6d 6170  [0].    safe_map
-0001d4f0: 5f66 6c61 7428 7075 745f 6772 6164 2c20  _flat(put_grad, 
-0001d500: 7472 6163 652e 6f75 7470 7574 2c20 696e  trace.output, in
-0001d510: 6974 5f63 6f74 616e 6765 6e74 7329 0a0a  it_cotangents)..
-0001d520: 2020 2020 666f 7220 7379 6d62 6f6c 2069      for symbol i
-0001d530: 6e20 7265 7665 7273 6564 2874 7261 6365  n reversed(trace
-0001d540: 2e62 6f75 6e64 5f73 796d 626f 6c73 293a  .bound_symbols):
-0001d550: 0a20 2020 2020 2020 2069 6620 7379 6d62  .        if symb
-0001d560: 6f6c 2e73 796d 2e69 6420 696e 2074 7261  ol.sym.id in tra
-0001d570: 6e73 666f 726d 5f73 6b69 705f 6c69 7374  nsform_skip_list
-0001d580: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-0001d590: 6e74 696e 7565 0a20 2020 2020 2020 2073  ntinue.        s
-0001d5a0: 796d 626f 6c5f 6f75 7470 7574 203d 2073  ymbol_output = s
-0001d5b0: 6571 7565 6e63 6966 7928 7379 6d62 6f6c  equencify(symbol
-0001d5c0: 2e6f 7574 7075 7429 0a0a 2020 2020 2020  .output)..      
-0001d5d0: 2020 636f 7461 6e67 656e 7473 203d 2074    cotangents = t
-0001d5e0: 7265 655f 6d61 7028 6765 745f 6772 6164  ree_map(get_grad
-0001d5f0: 2c20 7379 6d62 6f6c 5f6f 7574 7075 7429  , symbol_output)
-0001d600: 0a20 2020 2020 2020 2023 2048 6176 696e  .        # Havin
-0001d610: 6720 6120 7369 6e67 6c65 2063 6f74 616e  g a single cotan
-0001d620: 6765 6e74 2069 7320 6120 636f 6d6d 6f6e  gent is a common
-0001d630: 2063 6173 652c 2073 6f20 7765 2066 6c61   case, so we fla
-0001d640: 7474 656e 2069 740a 2020 2020 2020 2020  tten it.        
-0001d650: 2320 4f74 6865 7277 6973 652c 2077 6520  # Otherwise, we 
-0001d660: 7769 6c6c 206e 6565 6420 746f 2072 6577  will need to rew
-0001d670: 7269 7465 2074 6865 2070 756c 6c62 6163  rite the pullbac
-0001d680: 6b20 6675 6e63 7469 6f6e 730a 2020 2020  k functions.    
-0001d690: 2020 2020 636f 7461 6e67 656e 7473 203d      cotangents =
-0001d6a0: 2074 7265 655f 666c 6174 7465 6e28 636f   tree_flatten(co
-0001d6b0: 7461 6e67 656e 7473 295b 305d 0a20 2020  tangents)[0].   
-0001d6c0: 2020 2020 2072 6573 6964 7561 6c73 203d       residuals =
-0001d6d0: 2066 6f72 7761 7264 5f65 6e76 5b73 796d   forward_env[sym
-0001d6e0: 626f 6c5f 6f75 7470 7574 5b30 5d2e 6e61  bol_output[0].na
-0001d6f0: 6d65 5d2e 7265 7369 6475 616c 730a 2020  me].residuals.  
-0001d700: 2020 2020 2020 6966 2069 735f 636f 6e73        if is_cons
-0001d710: 7461 6e74 5f66 6f72 5f76 6a70 2873 796d  tant_for_vjp(sym
-0001d720: 626f 6c29 3a0a 2020 2020 2020 2020 2020  bol):.          
-0001d730: 2020 2320 5765 2063 616e 2073 6b69 7020    # We can skip 
-0001d740: 7468 6520 7075 6c6c 6261 636b 2069 6620  the pullback if 
-0001d750: 616c 6c20 7468 6520 6172 6775 6d65 6e74  all the argument
-0001d760: 7320 6172 6520 636f 6e73 7461 6e74 0a20  s are constant. 
-0001d770: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0001d780: 6e75 650a 0a20 2020 2020 2020 2069 6620  nue..        if 
-0001d790: 616c 6c28 636f 7461 6e67 656e 7420 6973  all(cotangent is
-0001d7a0: 204e 6f6e 6520 666f 7220 636f 7461 6e67   None for cotang
-0001d7b0: 656e 7420 696e 2063 6f74 616e 6765 6e74  ent in cotangent
-0001d7c0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0001d7d0: 2320 5765 2063 616e 2073 6b69 7020 7468  # We can skip th
-0001d7e0: 6520 7075 6c6c 6261 636b 2069 6620 7468  e pullback if th
-0001d7f0: 6520 636f 7461 6e67 656e 7420 6973 204e  e cotangent is N
-0001d800: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-0001d810: 7361 6665 5f6d 6170 2870 7574 5f67 7261  safe_map(put_gra
-0001d820: 642c 2073 796d 626f 6c2e 6172 6773 2c20  d, symbol.args, 
-0001d830: 284e 6f6e 652c 2920 2a20 6c65 6e28 7379  (None,) * len(sy
-0001d840: 6d62 6f6c 2e61 7267 7329 290a 2020 2020  mbol.args)).    
-0001d850: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0001d860: 0a0a 2020 2020 2020 2020 6966 2073 796d  ..        if sym
-0001d870: 626f 6c2e 7379 6d2e 6964 203d 3d20 2274  bol.sym.id == "t
-0001d880: 6f72 6368 2e6e 6e2e 6675 6e63 7469 6f6e  orch.nn.function
-0001d890: 616c 2e64 726f 706f 7574 2220 616e 6420  al.dropout" and 
-0001d8a0: 6e6f 7420 7379 6d62 6f6c 2e73 7562 7379  not symbol.subsy
-0001d8b0: 6d62 6f6c 733a 0a20 2020 2020 2020 2020  mbols:.         
-0001d8c0: 2020 2023 2057 6520 6361 6e20 736b 6970     # We can skip
-0001d8d0: 2074 6865 2070 756c 6c62 6163 6b20 6966   the pullback if
-0001d8e0: 2074 6865 2064 726f 706f 7574 2070 726f   the dropout pro
-0001d8f0: 6261 6269 6c69 7479 2069 7320 302e 300a  bability is 0.0.
-0001d900: 2020 2020 2020 2020 2020 2020 2320 4173              # As
-0001d910: 7375 6d69 6e67 2074 6861 7420 7468 6520  suming that the 
-0001d920: 6472 6f70 6f75 7420 7379 6d62 6f6c 2068  dropout symbol h
-0001d930: 6173 2074 6865 2073 616d 6520 6f75 7470  as the same outp
-0001d940: 7574 2061 6e64 2061 7267 756d 656e 740a  ut and argument.
-0001d950: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0001d960: 7274 2073 796d 626f 6c2e 6f75 7470 7574  rt symbol.output
-0001d970: 2e6e 616d 6520 3d3d 2073 796d 626f 6c2e  .name == symbol.
-0001d980: 6172 6773 5b30 5d2e 6e61 6d65 2c20 2244  args[0].name, "D
-0001d990: 726f 706f 7574 2073 796d 626f 6c20 6861  ropout symbol ha
-0001d9a0: 7320 6120 6469 6666 6572 656e 7420 6f75  s a different ou
-0001d9b0: 7470 7574 2061 6e64 2061 7267 756d 656e  tput and argumen
-0001d9c0: 7422 0a20 2020 2020 2020 2020 2020 2069  t".            i
-0001d9d0: 6620 7379 6d62 6f6c 2e61 7267 735b 315d  f symbol.args[1]
-0001d9e0: 203d 3d20 302e 3020 6f72 2073 796d 626f   == 0.0 or symbo
-0001d9f0: 6c2e 6172 6773 5b32 5d20 6973 2046 616c  l.args[2] is Fal
-0001da00: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001da10: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
-0001da20: 2020 2020 2020 6261 636b 7761 7264 203d        backward =
-0001da30: 2062 6163 6b77 6172 645f 696d 706c 732e   backward_impls.
-0001da40: 6765 7428 7379 6d62 6f6c 2e73 796d 2e69  get(symbol.sym.i
-0001da50: 6429 0a20 2020 2020 2020 2061 7567 5f66  d).        aug_f
-0001da60: 6f72 7761 7264 203d 2061 7567 6d65 6e74  orward = augment
-0001da70: 6564 5f66 6f72 7761 7264 5f69 6d70 6c73  ed_forward_impls
-0001da80: 2e67 6574 2873 796d 626f 6c2e 7379 6d2e  .get(symbol.sym.
-0001da90: 6964 290a 2020 2020 2020 2020 6175 675f  id).        aug_
-0001daa0: 666f 7277 6172 6420 3d20 6765 745f 6578  forward = get_ex
-0001dab0: 6563 7574 6f72 5f73 7065 6369 6669 635f  ecutor_specific_
-0001dac0: 6175 675f 6677 645f 7275 6c65 2873 796d  aug_fwd_rule(sym
-0001dad0: 626f 6c29 206f 7220 6175 675f 666f 7277  bol) or aug_forw
-0001dae0: 6172 640a 0a20 2020 2020 2020 2069 6620  ard..        if 
-0001daf0: 5f67 6574 5f67 7261 6466 6e28 7379 6d62  _get_gradfn(symb
-0001db00: 6f6c 2920 6973 206e 6f74 204e 6f6e 653a  ol) is not None:
-0001db10: 0a20 2020 2020 2020 2020 2020 2061 7567  .            aug
-0001db20: 5f66 6f72 7761 7264 2c20 6261 636b 7761  _forward, backwa
-0001db30: 7264 203d 206d 616b 655f 6175 675f 666f  rd = make_aug_fo
-0001db40: 7277 6172 645f 616e 645f 6261 636b 7761  rward_and_backwa
-0001db50: 7264 2873 796d 626f 6c29 0a0a 2020 2020  rd(symbol)..    
-0001db60: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0001db70: 6528 6175 675f 666f 7277 6172 642c 2052  e(aug_forward, R
-0001db80: 756c 6549 6e66 6f29 3a0a 2020 2020 2020  uleInfo):.      
-0001db90: 2020 2020 2020 6261 636b 7761 7264 203d        backward =
-0001dba0: 2062 6163 6b77 6172 645f 696d 706c 735b   backward_impls[
-0001dbb0: 6175 675f 666f 7277 6172 642e 6578 6563  aug_forward.exec
-0001dbc0: 7574 6f72 2c20 7379 6d62 6f6c 2e73 796d  utor, symbol.sym
-0001dbd0: 2e69 645d 0a0a 2020 2020 2020 2020 6966  .id]..        if
-0001dbe0: 2062 6163 6b77 6172 6420 6973 204e 6f6e   backward is Non
-0001dbf0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-0001dc00: 6620 6c65 6e28 7379 6d62 6f6c 2e73 7562  f len(symbol.sub
-0001dc10: 7379 6d62 6f6c 7329 203e 2030 2061 6e64  symbols) > 0 and
-0001dc20: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-0001dc30: 7379 6d62 6f6c 2e73 796d 2e69 642c 2070  symbol.sym.id, p
-0001dc40: 7269 6d73 2e50 7269 6d49 4473 293a 0a20  rims.PrimIDs):. 
-0001dc50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001dc60: 2057 6520 636f 756c 6420 6e6f 7420 6669   We could not fi
-0001dc70: 6e64 2061 2062 6163 6b77 6172 6420 666f  nd a backward fo
-0001dc80: 7220 7468 6973 2073 796d 626f 6c2c 2073  r this symbol, s
-0001dc90: 6f20 7765 2074 7279 2074 6f20 6465 636f  o we try to deco
-0001dca0: 6d70 6f73 6520 6974 0a20 2020 2020 2020  mpose it.       
-0001dcb0: 2020 2020 2020 2020 2062 6163 6b77 6172           backwar
-0001dcc0: 6420 3d20 7061 7274 6961 6c28 6465 636f  d = partial(deco
-0001dcd0: 6d70 6f73 6564 5f66 6e5f 6261 636b 7761  mposed_fn_backwa
-0001dce0: 7264 5f72 756c 652c 2073 796d 626f 6c2e  rd_rule, symbol.
-0001dcf0: 7379 6d29 0a20 2020 2020 2020 2020 2020  sym).           
-0001dd00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001dd10: 2020 2020 2020 2023 2057 6520 636f 756c         # We coul
-0001dd20: 6420 6e6f 7420 6669 6e64 2061 2062 6163  d not find a bac
-0001dd30: 6b77 6172 6420 666f 7220 7468 6973 2073  kward for this s
-0001dd40: 796d 626f 6c20 616e 6420 7765 2063 6f75  ymbol and we cou
-0001dd50: 6c64 206e 6f74 2064 6563 6f6d 706f 7365  ld not decompose
-0001dd60: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
-0001dd70: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
-0001dd80: 6c65 6d65 6e74 6564 4572 726f 7228 6622  lementedError(f"
-0001dd90: 4261 636b 7761 7264 2066 6f72 207b 7379  Backward for {sy
-0001dda0: 6d62 6f6c 2e73 796d 2e69 647d 2069 7320  mbol.sym.id} is 
-0001ddb0: 6e6f 7420 696d 706c 656d 656e 7465 6422  not implemented"
-0001ddc0: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
-0001ddd0: 7420 3d20 6261 636b 7761 7264 282a 7265  t = backward(*re
-0001dde0: 7369 6475 616c 732c 202a 636f 7461 6e67  siduals, *cotang
-0001ddf0: 656e 7473 290a 2020 2020 2020 2020 6966  ents).        if
-0001de00: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
-0001de10: 6c74 2c20 6469 6374 293a 0a20 2020 2020  lt, dict):.     
-0001de20: 2020 2020 2020 2023 2049 6620 7468 6520         # If the 
-0001de30: 6261 636b 7761 7264 2072 6574 7572 6e73  backward returns
-0001de40: 2061 2064 6963 742c 2077 6520 6173 7375   a dict, we assu
-0001de50: 6d65 2074 6861 7420 6974 2069 7320 6120  me that it is a 
-0001de60: 6469 6374 206f 660a 2020 2020 2020 2020  dict of.        
-0001de70: 2020 2020 2320 666f 7277 6172 6420 6172      # forward ar
-0001de80: 6775 6d65 6e74 7320 746f 2074 6865 2063  guments to the c
-0001de90: 6f72 7265 7370 6f6e 6469 6e67 0a20 2020  orresponding.   
-0001dea0: 2020 2020 2020 2020 2023 2067 7261 6469           # gradi
-0001deb0: 656e 7473 2f63 6f74 616e 6765 6e74 732f  ents/cotangents/
-0001dec0: 6164 6a6f 696e 7473 2f73 656e 7369 7469  adjoints/sensiti
-0001ded0: 7669 7469 6573 2e0a 2020 2020 2020 2020  vities..        
-0001dee0: 2020 2020 7573 6564 5f6e 616d 6573 203d      used_names =
-0001def0: 2073 6574 2829 0a20 2020 2020 2020 2020   set().         
-0001df00: 2020 2066 6f72 2069 2c20 286b 2c20 7629     for i, (k, v)
-0001df10: 2069 6e20 656e 756d 6572 6174 6528 696e   in enumerate(in
-0001df20: 7370 6563 742e 7369 676e 6174 7572 6528  spect.signature(
-0001df30: 6175 675f 666f 7277 6172 6429 2e70 6172  aug_forward).par
-0001df40: 616d 6574 6572 732e 6974 656d 7328 2929  ameters.items())
-0001df50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001df60: 2020 6966 2076 2e6b 696e 6420 696e 2028    if v.kind in (
-0001df70: 696e 7370 6563 742e 5061 7261 6d65 7465  inspect.Paramete
-0001df80: 722e 504f 5349 5449 4f4e 414c 5f4f 4e4c  r.POSITIONAL_ONL
-0001df90: 592c 2069 6e73 7065 6374 2e50 6172 616d  Y, inspect.Param
-0001dfa0: 6574 6572 2e50 4f53 4954 494f 4e41 4c5f  eter.POSITIONAL_
-0001dfb0: 4f52 5f4b 4559 574f 5244 293a 0a20 2020  OR_KEYWORD):.   
-0001dfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dfd0: 2070 7574 5f67 7261 6428 7379 6d62 6f6c   put_grad(symbol
-0001dfe0: 2e61 7267 735b 695d 2c20 7265 7375 6c74  .args[i], result
-0001dff0: 2e67 6574 286b 2c20 4e6f 6e65 2929 0a20  .get(k, None)). 
-0001e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e010: 2020 2075 7365 645f 6e61 6d65 732e 6164     used_names.ad
-0001e020: 6428 6b29 0a0a 2020 2020 2020 2020 2020  d(k)..          
-0001e030: 2020 2320 466f 7220 6465 7665 6c6f 7065    # For develope
-0001e040: 7220 636f 6e76 656e 6965 6e63 652c 2077  r convenience, w
-0001e050: 6520 616c 6c6f 7720 7573 696e 6720 7468  e allow using th
-0001e060: 6520 6e61 6d65 2066 726f 6d20 7468 650a  e name from the.
-0001e070: 2020 2020 2020 2020 2020 2020 2320 666f              # fo
-0001e080: 7277 6172 6420 6d65 7461 2069 6e20 6164  rward meta in ad
-0001e090: 6469 7469 6f6e 2074 6f20 7468 6520 6e61  dition to the na
-0001e0a0: 6d65 2066 726f 6d20 7468 6520 6175 676d  me from the augm
-0001e0b0: 656e 7465 6420 666f 7277 6172 640a 2020  ented forward.  
-0001e0c0: 2020 2020 2020 2020 2020 2320 7369 676e            # sign
-0001e0d0: 6174 7572 652e 0a20 2020 2020 2020 2020  ature..         
-0001e0e0: 2020 2023 2049 6620 626f 7468 206e 616d     # If both nam
-0001e0f0: 6573 2061 7265 2075 7365 642c 2074 6865  es are used, the
-0001e100: 206f 6e65 2066 726f 6d20 7468 6520 666f   one from the fo
-0001e110: 7277 6172 6420 6d65 7461 2074 616b 6573  rward meta takes
-0001e120: 0a20 2020 2020 2020 2020 2020 2023 2070  .            # p
-0001e130: 7265 6365 6465 6e63 652e 0a20 2020 2020  recedence..     
-0001e140: 2020 2020 2020 2066 6f72 2069 2c20 286b         for i, (k
-0001e150: 2c20 7629 2069 6e20 656e 756d 6572 6174  , v) in enumerat
-0001e160: 6528 696e 7370 6563 742e 7369 676e 6174  e(inspect.signat
-0001e170: 7572 6528 7379 6d62 6f6c 2e73 796d 2e6d  ure(symbol.sym.m
-0001e180: 6574 6129 2e70 6172 616d 6574 6572 732e  eta).parameters.
-0001e190: 6974 656d 7328 2929 3a0a 2020 2020 2020  items()):.      
-0001e1a0: 2020 2020 2020 2020 2020 6966 2076 2e6b            if v.k
-0001e1b0: 696e 6420 696e 2028 696e 7370 6563 742e  ind in (inspect.
-0001e1c0: 5061 7261 6d65 7465 722e 504f 5349 5449  Parameter.POSITI
-0001e1d0: 4f4e 414c 5f4f 4e4c 592c 2069 6e73 7065  ONAL_ONLY, inspe
-0001e1e0: 6374 2e50 6172 616d 6574 6572 2e50 4f53  ct.Parameter.POS
-0001e1f0: 4954 494f 4e41 4c5f 4f52 5f4b 4559 574f  ITIONAL_OR_KEYWO
-0001e200: 5244 293a 0a20 2020 2020 2020 2020 2020  RD):.           
-0001e210: 2020 2020 2020 2020 2069 6620 6b20 6e6f           if k no
-0001e220: 7420 696e 2075 7365 645f 6e61 6d65 733a  t in used_names:
-0001e230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e240: 2020 2020 2020 2020 2070 7574 5f67 7261           put_gra
-0001e250: 6428 7379 6d62 6f6c 2e61 7267 735b 695d  d(symbol.args[i]
-0001e260: 2c20 7265 7375 6c74 2e67 6574 286b 2c20  , result.get(k, 
-0001e270: 4e6f 6e65 2929 0a20 2020 2020 2020 2020  None)).         
-0001e280: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-0001e290: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
-0001e2a0: 7374 616e 6365 2872 6573 756c 742c 2053  stance(result, S
-0001e2b0: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-0001e2c0: 2020 2020 2020 7265 7375 6c74 203d 2028        result = (
-0001e2d0: 7265 7375 6c74 2c29 0a0a 2020 2020 2020  result,)..      
-0001e2e0: 2020 6465 6620 6973 5f64 6966 6665 7265    def is_differe
-0001e2f0: 6e74 6961 626c 6528 6172 6729 3a0a 2020  ntiable(arg):.  
-0001e300: 2020 2020 2020 2020 2020 6d61 7463 6820            match 
-0001e310: 6172 673a 0a20 2020 2020 2020 2020 2020  arg:.           
-0001e320: 2020 2020 2063 6173 6520 5465 6e73 6f72       case Tensor
-0001e330: 5072 6f78 7928 293a 0a20 2020 2020 2020  Proxy():.       
-0001e340: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0001e350: 7572 6e20 6474 7970 6573 2e69 735f 696e  urn dtypes.is_in
-0001e360: 6578 6163 745f 6474 7970 6528 6172 672e  exact_dtype(arg.
-0001e370: 6474 7970 6529 0a20 2020 2020 2020 2020  dtype).         
-0001e380: 2020 2020 2020 2063 6173 6520 5365 7175         case Sequ
-0001e390: 656e 6365 2829 3a0a 2020 2020 2020 2020  ence():.        
-0001e3a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001e3b0: 726e 2061 7267 2061 6e64 2061 6c6c 2869  rn arg and all(i
-0001e3c0: 7369 6e73 7461 6e63 6528 782c 2054 656e  sinstance(x, Ten
-0001e3d0: 736f 7250 726f 7879 2920 616e 6420 6474  sorProxy) and dt
-0001e3e0: 7970 6573 2e69 735f 696e 6578 6163 745f  ypes.is_inexact_
-0001e3f0: 6474 7970 6528 782e 6474 7970 6529 2066  dtype(x.dtype) f
-0001e400: 6f72 2078 2069 6e20 6172 6729 0a20 2020  or x in arg).   
-0001e410: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-0001e420: 6520 5f3a 0a20 2020 2020 2020 2020 2020  e _:.           
-0001e430: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001e440: 4661 6c73 650a 0a20 2020 2020 2020 2069  False..        i
-0001e450: 6620 6c65 6e28 7379 6d62 6f6c 2e61 7267  f len(symbol.arg
-0001e460: 7329 2021 3d20 286f 7269 675f 7265 735f  s) != (orig_res_
-0001e470: 6c65 6e20 3a3d 206c 656e 2872 6573 756c  len := len(resul
-0001e480: 7429 293a 0a20 2020 2020 2020 2020 2020  t)):.           
-0001e490: 2063 6865 636b 280a 2020 2020 2020 2020   check(.        
-0001e4a0: 2020 2020 2020 2020 6f72 6967 5f72 6573          orig_res
-0001e4b0: 5f6c 656e 203c 3d20 6c65 6e28 7379 6d62  _len <= len(symb
-0001e4c0: 6f6c 2e61 7267 7329 2c0a 2020 2020 2020  ol.args),.      
-0001e4d0: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
-0001e4e0: 3a20 6622 4261 636b 7761 7264 2066 6f72  : f"Backward for
-0001e4f0: 207b 7379 6d62 6f6c 2e73 796d 2e69 647d   {symbol.sym.id}
-0001e500: 2072 6574 7572 6e65 6420 7b6f 7269 675f   returned {orig_
-0001e510: 7265 735f 6c65 6e7d 2076 616c 7565 732c  res_len} values,
-0001e520: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0001e530: 2020 202b 2066 2262 7574 2065 7870 6563     + f"but expec
-0001e540: 7465 6420 6174 206d 6f73 7420 7b6c 656e  ted at most {len
-0001e550: 2873 796d 626f 6c2e 6172 6773 297d 222c  (symbol.args)}",
-0001e560: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001e570: 2020 2020 2020 2020 2020 2023 2041 7373             # Ass
-0001e580: 756d 696e 6720 7468 6174 2074 6865 206e  uming that the n
-0001e590: 6f6e 2d64 6966 6665 7265 6e74 6961 626c  on-differentiabl
-0001e5a0: 6520 6172 6775 6d65 6e74 7320 7765 7265  e arguments were
-0001e5b0: 2064 726f 7070 6564 2066 726f 6d0a 2020   dropped from.  
-0001e5c0: 2020 2020 2020 2020 2020 2320 7468 6520            # the 
-0001e5d0: 6261 636b 7761 7264 2066 756e 6374 696f  backward functio
-0001e5e0: 6e2c 2077 6520 6172 6520 676f 696e 6720  n, we are going 
-0001e5f0: 746f 2061 7070 656e 6420 4e6f 6e65 2074  to append None t
-0001e600: 6f20 7468 6520 7265 7375 6c74 0a20 2020  o the result.   
-0001e610: 2020 2020 2020 2020 2023 2074 6f20 6d61           # to ma
-0001e620: 7463 6820 7468 6520 6e75 6d62 6572 206f  tch the number o
-0001e630: 6620 6172 6775 6d65 6e74 732e 2041 6c74  f arguments. Alt
-0001e640: 6572 6e61 7469 7665 6c79 2c20 7765 2063  ernatively, we c
-0001e650: 6f75 6c64 206a 7573 740a 2020 2020 2020  ould just.      
-0001e660: 2020 2020 2020 2320 6861 7665 2061 2066        # have a f
-0001e670: 6f72 2d6c 6f6f 7020 7769 7468 2061 2063  or-loop with a c
-0001e680: 6f6e 6469 7469 6f6e 616c 2077 6865 6e20  onditional when 
-0001e690: 7772 6974 696e 6720 746f 2074 6865 0a20  writing to the. 
-0001e6a0: 2020 2020 2020 2020 2020 2023 2065 6e76             # env
-0001e6b0: 6972 6f6e 6d65 6e74 2e0a 0a20 2020 2020  ironment...     
-0001e6c0: 2020 2020 2020 2069 7465 725f 7265 7375         iter_resu
-0001e6d0: 6c74 203d 2069 7465 7228 7265 7375 6c74  lt = iter(result
-0001e6e0: 290a 2020 2020 2020 2020 2020 2020 6e5f  ).            n_
-0001e6f0: 6469 6666 6572 656e 7469 6162 6c65 5f61  differentiable_a
-0001e700: 7267 7320 3d20 7375 6d28 626f 6f6c 2869  rgs = sum(bool(i
-0001e710: 735f 6469 6666 6572 656e 7469 6162 6c65  s_differentiable
-0001e720: 2861 7267 2929 2066 6f72 2061 7267 2069  (arg)) for arg i
-0001e730: 6e20 7379 6d62 6f6c 2e61 7267 7329 0a20  n symbol.args). 
-0001e740: 2020 2020 2020 2020 2020 2063 6865 636b             check
-0001e750: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001e760: 2020 6e5f 6469 6666 6572 656e 7469 6162    n_differentiab
-0001e770: 6c65 5f61 7267 7320 3c3d 206f 7269 675f  le_args <= orig_
-0001e780: 7265 735f 6c65 6e2c 0a20 2020 2020 2020  res_len,.       
-0001e790: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
-0001e7a0: 2066 2242 6163 6b77 6172 6420 666f 7220   f"Backward for 
-0001e7b0: 7b73 796d 626f 6c2e 7379 6d2e 6964 7d20  {symbol.sym.id} 
-0001e7c0: 7265 7475 726e 6564 207b 6f72 6967 5f72  returned {orig_r
-0001e7d0: 6573 5f6c 656e 7d20 7661 6c75 6528 7329  es_len} value(s)
-0001e7e0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
-0001e7f0: 2020 2020 2b20 6622 6275 7420 6578 7065      + f"but expe
-0001e800: 6374 6564 207b 6e5f 6469 6666 6572 656e  cted {n_differen
-0001e810: 7469 6162 6c65 5f61 7267 737d 222c 0a20  tiable_args}",. 
-0001e820: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0001e830: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-0001e840: 203d 2074 7570 6c65 286e 6578 7428 6974   = tuple(next(it
-0001e850: 6572 5f72 6573 756c 7429 2069 6620 6973  er_result) if is
-0001e860: 5f64 6966 6665 7265 6e74 6961 626c 6528  _differentiable(
-0001e870: 6172 6729 2065 6c73 6520 4e6f 6e65 2066  arg) else None f
-0001e880: 6f72 2061 7267 2069 6e20 7379 6d62 6f6c  or arg in symbol
-0001e890: 2e61 7267 7329 0a0a 2020 2020 2020 2020  .args)..        
-0001e8a0: 2320 5365 6520 2242 6163 6b77 6172 6420  # See "Backward 
-0001e8b0: 696d 706c 2066 6f72 206f 7073 206f 6620  impl for ops of 
-0001e8c0: 7468 6520 7479 7065 2053 6571 7565 6e63  the type Sequenc
-0001e8d0: 655b 5465 6e73 6f72 5072 6f78 795d 2c20  e[TensorProxy], 
-0001e8e0: 2e2e 2e20 2d3e 202e 2e2e 2072 6573 756c  ... -> ... resul
-0001e8f0: 7473 2069 6e20 4e6f 6e65 2067 7261 6473  ts in None grads
-0001e900: 2e22 0a20 2020 2020 2020 2023 2054 6869  .".        # Thi
-0001e910: 7320 6973 2061 2074 656d 706f 7261 7279  s is a temporary
-0001e920: 2077 6f72 6b61 726f 756e 642e 0a20 2020   workaround..   
-0001e930: 2020 2020 2069 6620 7379 6d62 6f6c 2e73       if symbol.s
-0001e940: 796d 2e69 6420 696e 2028 7072 696d 732e  ym.id in (prims.
-0001e950: 5072 696d 4944 732e 4341 542c 2022 746f  PrimIDs.CAT, "to
-0001e960: 7263 682e 6361 7422 2c20 2274 6f72 6368  rch.cat", "torch
-0001e970: 2e73 7461 636b 2229 3a0a 2020 2020 2020  .stack"):.      
-0001e980: 2020 2020 2020 7361 6665 5f6d 6170 5f66        safe_map_f
-0001e990: 6c61 7428 7075 745f 6772 6164 2c20 7379  lat(put_grad, sy
-0001e9a0: 6d62 6f6c 2e61 7267 732c 2072 6573 756c  mbol.args, resul
-0001e9b0: 7429 0a20 2020 2020 2020 2065 6c73 653a  t).        else:
-0001e9c0: 0a20 2020 2020 2020 2020 2020 2073 6166  .            saf
-0001e9d0: 655f 6d61 7028 7075 745f 6772 6164 2c20  e_map(put_grad, 
-0001e9e0: 7379 6d62 6f6c 2e61 7267 732c 2072 6573  symbol.args, res
-0001e9f0: 756c 7429 0a0a 2020 2020 6465 6620 6765  ult)..    def ge
-0001ea00: 745f 696e 6578 6163 745f 6474 7970 655f  t_inexact_dtype_
-0001ea10: 6f72 5f6e 6f6e 6528 7829 3a0a 2020 2020  or_none(x):.    
-0001ea20: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0001ea30: 6528 782c 2028 5465 6e73 6f72 5072 6f78  e(x, (TensorProx
-0001ea40: 792c 2046 7574 7572 6554 656e 736f 7250  y, FutureTensorP
-0001ea50: 726f 7879 2929 2061 6e64 2064 7479 7065  roxy)) and dtype
-0001ea60: 732e 6973 5f69 6e65 7861 6374 5f64 7479  s.is_inexact_dty
-0001ea70: 7065 2878 2e64 7479 7065 293a 0a20 2020  pe(x.dtype):.   
-0001ea80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001ea90: 780a 2020 2020 2020 2020 656c 7365 3a0a  x.        else:.
-0001eaa0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001eab0: 726e 204e 6f6e 650a 0a20 2020 2067 6172  rn None..    gar
-0001eac0: 6773 203d 2074 7265 655f 6d61 7028 6765  gs = tree_map(ge
-0001ead0: 745f 6772 6164 2c20 7475 706c 6528 7472  t_grad, tuple(tr
-0001eae0: 6163 652e 6172 6773 2929 0a20 2020 2067  ace.args)).    g
-0001eaf0: 6b77 6172 6773 203d 2074 7265 655f 6d61  kwargs = tree_ma
-0001eb00: 7028 6765 745f 6772 6164 2c20 7472 6163  p(get_grad, trac
-0001eb10: 652e 6b77 6172 6773 290a 2020 2020 676b  e.kwargs).    gk
-0001eb20: 7761 7267 7320 3d20 7b6b 3a20 7620 666f  wargs = {k: v fo
-0001eb30: 7220 6b2c 2076 2069 6e20 676b 7761 7267  r k, v in gkwarg
-0001eb40: 732e 6974 656d 7328 2920 6966 2076 2069  s.items() if v i
-0001eb50: 7320 6e6f 7420 4e6f 6e65 7d0a 2020 2020  s not None}.    
-0001eb60: 6761 7267 732c 2067 6b77 6172 6773 203d  gargs, gkwargs =
-0001eb70: 2074 7265 655f 6d61 7028 6765 745f 696e   tree_map(get_in
-0001eb80: 6578 6163 745f 6474 7970 655f 6f72 5f6e  exact_dtype_or_n
-0001eb90: 6f6e 652c 2028 6761 7267 732c 2067 6b77  one, (gargs, gkw
-0001eba0: 6172 6773 2929 0a20 2020 2072 6574 7572  args)).    retur
-0001ebb0: 6e20 6761 7267 7320 2b20 2867 6b77 6172  n gargs + (gkwar
-0001ebc0: 6773 2c29 2069 6620 6c65 6e28 676b 7761  gs,) if len(gkwa
-0001ebd0: 7267 7329 2021 3d20 3020 656c 7365 2067  rgs) != 0 else g
-0001ebe0: 6172 6773 0a0a 0a64 6566 2076 6a70 5f63  args...def vjp_c
-0001ebf0: 616c 6c5f 6d65 7461 6675 6e63 2864 6574  all_metafunc(det
-0001ec00: 6163 6865 643a 2062 6f6f 6c2c 2070 7269  ached: bool, pri
-0001ec10: 6d61 6c73 2c20 636f 7461 6e67 656e 7473  mals, cotangents
-0001ec20: 2c20 7472 6163 653a 2054 7261 6365 2c20  , trace: Trace, 
-0001ec30: 2a2a 6b77 6172 6773 293a 0a20 2020 2023  **kwargs):.    #
-0001ec40: 2041 7373 756d 696e 6720 7072 696d 616c   Assuming primal
-0001ec50: 7320 6973 2066 6c61 740a 0a20 2020 2069  s is flat..    i
-0001ec60: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-0001ec70: 2870 7269 6d61 6c73 2c20 5365 7175 656e  (primals, Sequen
-0001ec80: 6365 293a 0a20 2020 2020 2020 2070 7269  ce):.        pri
-0001ec90: 6d61 6c73 203d 2028 7072 696d 616c 732c  mals = (primals,
-0001eca0: 290a 0a20 2020 2063 7478 203d 2064 6574  )..    ctx = det
-0001ecb0: 6163 6865 645f 7472 6163 6528 2920 6966  ached_trace() if
-0001ecc0: 2064 6574 6163 6865 6420 656c 7365 206e   detached else n
-0001ecd0: 756c 6c63 6f6e 7465 7874 2829 0a20 2020  ullcontext().   
-0001ece0: 2077 6974 6820 6374 783a 0a20 2020 2020   with ctx:.     
-0001ecf0: 2020 2072 6573 756c 742c 2065 6e76 203d     result, env =
-0001ed00: 2061 7567 6d65 6e74 6564 5f66 6f72 7761   augmented_forwa
-0001ed10: 7264 5f70 6173 7328 2a70 7269 6d61 6c73  rd_pass(*primals
-0001ed20: 2c20 7472 6163 653d 7472 6163 652c 202a  , trace=trace, *
-0001ed30: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
-0001ed40: 2063 6865 636b 280a 2020 2020 2020 2020   check(.        
-0001ed50: 2020 2020 6c65 6e28 7265 7375 6c74 2920      len(result) 
-0001ed60: 3d3d 206c 656e 2863 6f74 616e 6765 6e74  == len(cotangent
-0001ed70: 7329 2069 6620 6973 696e 7374 616e 6365  s) if isinstance
-0001ed80: 2872 6573 756c 742c 2053 6571 7565 6e63  (result, Sequenc
-0001ed90: 6529 2065 6c73 6520 5472 7565 2c0a 2020  e) else True,.  
-0001eda0: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
-0001edb0: 3a20 6622 4578 7065 6374 6564 2063 6f74  : f"Expected cot
-0001edc0: 616e 6765 6e74 7320 746f 2062 6520 6120  angents to be a 
-0001edd0: 7365 7175 656e 6365 206f 6620 6c65 6e67  sequence of leng
-0001ede0: 7468 207b 6c65 6e28 7265 7375 6c74 297d  th {len(result)}
-0001edf0: 2c20 676f 7420 6120 7365 7175 656e 6365  , got a sequence
-0001ee00: 206f 6620 6c65 6e67 7468 207b 6c65 6e28   of length {len(
-0001ee10: 636f 7461 6e67 656e 7473 297d 222c 0a20  cotangents)}",. 
-0001ee20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001ee30: 2072 6574 7572 6e20 7265 7375 6c74 2c20   return result, 
-0001ee40: 6261 636b 7761 7264 5f70 6173 7328 656e  backward_pass(en
-0001ee50: 762c 2074 7261 6365 2c20 636f 7461 6e67  v, trace, cotang
-0001ee60: 656e 7473 290a 0a0a 2320 544f 444f 3a20  ents)...# TODO: 
-0001ee70: 4361 6e27 7420 7573 6520 6120 5379 6d62  Can't use a Symb
-0001ee80: 6f6c 2068 6572 6520 6265 6361 7573 6520  ol here because 
-0001ee90: 6d69 7865 6420 6578 6563 7574 6f72 2073  mixed executor s
-0001eea0: 7962 7379 6d62 6f6c 7320 7365 656d 2074  ybsymbols seem t
-0001eeb0: 6f20 6265 0a23 2075 6e73 7570 706f 7274  o be.# unsupport
-0001eec0: 6564 2e20 5365 6520 6973 7375 6520 2243  ed. See issue "C
-0001eed0: 6f75 6c64 206e 6f74 2066 696e 6420 616e  ould not find an
-0001eee0: 2065 7865 6375 746f 7220 666f 7220 626f   executor for bo
-0001eef0: 756e 6420 7379 6d62 6f6c 2077 6865 6e20  und symbol when 
-0001ef00: 6974 7320 7375 6273 796d 626f 6c73 0a23  its subsymbols.#
-0001ef10: 2061 7265 206e 6f74 2066 756c 6c79 2073   are not fully s
-0001ef20: 7570 706f 7274 6564 2062 7920 6120 7369  upported by a si
-0001ef30: 6e67 6c65 2065 7865 6375 746f 7222 0a76  ngle executor".v
-0001ef40: 6a70 5f63 616c 6c20 3d20 7061 7274 6961  jp_call = partia
-0001ef50: 6c28 0a20 2020 2076 6a70 5f63 616c 6c5f  l(.    vjp_call_
-0001ef60: 6d65 7461 6675 6e63 2c20 4661 6c73 650a  metafunc, False.
-0001ef70: 2920 2023 2053 796d 626f 6c28 6964 3d54  )  # Symbol(id=T
-0001ef80: 7261 6e73 666f 726d 732e 566a 704f 702c  ransforms.VjpOp,
-0001ef90: 206e 616d 653d 2276 6a70 5f63 616c 6c22   name="vjp_call"
-0001efa0: 2c20 6d65 7461 3d70 6172 7469 616c 2876  , meta=partial(v
-0001efb0: 6a70 5f63 616c 6c5f 6d65 7461 6675 6e63  jp_call_metafunc
-0001efc0: 2c20 4661 6c73 6529 290a 0a0a 6465 6620  , False))...def 
-0001efd0: 766a 7028 6675 6e63 293a 0a20 2020 2022  vjp(func):.    "
-0001efe0: 2222 436f 6d70 7574 6573 2074 6865 2056  ""Computes the V
-0001eff0: 4a50 206f 6620 6120 6675 6e63 7469 6f6e  JP of a function
-0001f000: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-0001f010: 2020 2020 2066 756e 6320 2843 616c 6c61       func (Calla
-0001f020: 626c 6529 3a20 4675 6e63 7469 6f6e 2074  ble): Function t
-0001f030: 6f20 6265 2064 6966 6665 7265 6e74 6961  o be differentia
-0001f040: 7465 642e 0a20 2020 2022 2222 0a0a 2020  ted..    """..  
-0001f050: 2020 6465 6620 5f76 6a70 2870 7269 6d61    def _vjp(prima
-0001f060: 6c73 2c20 636f 7461 6e67 656e 7473 2c20  ls, cotangents, 
-0001f070: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-0001f080: 2020 2066 6c61 745f 6675 6e63 2c20 666c     flat_func, fl
-0001f090: 6174 5f61 7267 732c 2073 7065 6320 3d20  at_args, spec = 
-0001f0a0: 666c 6174 7465 6e5f 6675 6e63 2866 756e  flatten_func(fun
-0001f0b0: 632c 2070 7269 6d61 6c73 2c20 6b77 6172  c, primals, kwar
-0001f0c0: 6773 290a 2020 2020 2020 2020 7472 6163  gs).        trac
-0001f0d0: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
-0001f0e0: 6163 6528 2928 666c 6174 5f66 756e 632c  ace()(flat_func,
-0001f0f0: 202a 666c 6174 5f61 7267 7329 0a20 2020   *flat_args).   
-0001f100: 2020 2020 2072 6573 756c 742c 2076 6a70       result, vjp
-0001f110: 5f72 6573 756c 7420 3d20 766a 705f 6361  _result = vjp_ca
-0001f120: 6c6c 2866 6c61 745f 6172 6773 2c20 636f  ll(flat_args, co
-0001f130: 7461 6e67 656e 7473 2c20 7472 6163 653d  tangents, trace=
-0001f140: 7472 6163 6529 0a20 2020 2020 2020 2067  trace).        g
-0001f150: 7072 696d 616c 732c 2067 6b77 6172 6773  primals, gkwargs
-0001f160: 203d 2074 7265 655f 756e 666c 6174 7465   = tree_unflatte
-0001f170: 6e28 766a 705f 7265 7375 6c74 2c20 7370  n(vjp_result, sp
-0001f180: 6563 290a 2020 2020 2020 2020 6772 6164  ec).        grad
-0001f190: 7320 3d20 6770 7269 6d61 6c73 202b 2028  s = gprimals + (
-0001f1a0: 676b 7761 7267 732c 2920 6966 206c 656e  gkwargs,) if len
-0001f1b0: 2867 6b77 6172 6773 2920 213d 2030 2065  (gkwargs) != 0 e
-0001f1c0: 6c73 6520 6770 7269 6d61 6c73 0a20 2020  lse gprimals.   
-0001f1d0: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
-0001f1e0: 6c74 2c20 6772 6164 730a 0a20 2020 2072  lt, grads..    r
-0001f1f0: 6574 7572 6e20 5f76 6a70 0a0a 0a64 6566  eturn _vjp...def
-0001f200: 2076 616c 7565 5f61 6e64 5f67 7261 6428   value_and_grad(
-0001f210: 6675 6e63 293a 0a20 2020 2022 2222 436f  func):.    """Co
-0001f220: 6d70 7574 6573 2074 6865 2076 616c 7565  mputes the value
-0001f230: 2061 6e64 2067 7261 6469 656e 7420 6f66   and gradient of
-0001f240: 2061 2066 756e 6374 696f 6e2e 0a0a 2020   a function...  
-0001f250: 2020 5468 6973 2069 7320 6120 636f 6e76    This is a conv
-0001f260: 656e 6965 6e63 6520 6675 6e63 7469 6f6e  enience function
-0001f270: 2074 6861 7420 636f 6d62 696e 6573 2074   that combines t
-0001f280: 6865 2066 756e 6374 696f 6e61 6c69 7479  he functionality
-0001f290: 206f 660a 2020 2020 6076 6a70 5f63 616c   of.    `vjp_cal
-0001f2a0: 6c60 2077 6974 6820 696d 706c 6963 6974  l` with implicit
-0001f2b0: 2069 6e69 7469 616c 697a 6174 696f 6e20   initialization 
-0001f2c0: 6f66 2074 6865 2063 6f74 616e 6765 6e74  of the cotangent
-0001f2d0: 2074 6f20 312e 0a0a 2020 2020 4172 6773   to 1...    Args
-0001f2e0: 3a0a 2020 2020 2020 2020 6675 6e63 2028  :.        func (
-0001f2f0: 4361 6c6c 6162 6c65 293a 2046 756e 6374  Callable): Funct
-0001f300: 696f 6e20 746f 2062 6520 6469 6666 6572  ion to be differ
-0001f310: 656e 7469 6174 6564 2e0a 2020 2020 2222  entiated..    ""
-0001f320: 220a 0a20 2020 2064 6566 206f 6e65 735f  "..    def ones_
-0001f330: 6c69 6b65 2878 293a 0a20 2020 2020 2020  like(x):.       
-0001f340: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
-0001f350: 2c20 5465 6e73 6f72 5072 6f78 7929 3a0a  , TensorProxy):.
-0001f360: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001f370: 726e 2066 756c 6c5f 6c69 6b65 2878 2c20  rn full_like(x, 
-0001f380: 6669 6c6c 5f76 616c 7565 3d31 290a 2020  fill_value=1).  
-0001f390: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
-0001f3a0: 7461 6e63 6528 782c 204e 756d 6265 7250  tance(x, NumberP
-0001f3b0: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
-0001f3c0: 2020 2072 6574 7572 6e20 7479 7065 2878     return type(x
-0001f3d0: 2e76 616c 7565 2928 3129 0a20 2020 2020  .value)(1).     
-0001f3e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001f3f0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-0001f400: 4572 726f 7228 6622 6f6e 6573 5f6c 696b  Error(f"ones_lik
-0001f410: 6520 696e 7369 6465 2076 616c 7565 5f61  e inside value_a
-0001f420: 6e64 5f67 7261 6420 676f 7420 616e 2075  nd_grad got an u
-0001f430: 6e73 7570 706f 7274 6564 2074 7970 6520  nsupported type 
-0001f440: 7b74 7970 6528 7829 7d22 290a 0a20 2020  {type(x)}")..   
-0001f450: 2064 6566 205f 7661 6c75 655f 616e 645f   def _value_and_
-0001f460: 6772 6164 282a 6172 6773 2c20 2a2a 6b77  grad(*args, **kw
-0001f470: 6172 6773 293a 0a20 2020 2020 2020 2074  args):.        t
-0001f480: 7261 6365 203d 2063 6f6e 7374 7275 6374  race = construct
-0001f490: 5f74 7261 6365 2829 2866 756e 632c 202a  _trace()(func, *
-0001f4a0: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
-0001f4b0: 2020 2020 2020 2020 636f 7461 6e67 656e          cotangen
-0001f4c0: 7473 203d 2074 7265 655f 6d61 7028 6c61  ts = tree_map(la
-0001f4d0: 6d62 6461 2076 3a20 6f6e 6573 5f6c 696b  mbda v: ones_lik
-0001f4e0: 6528 7629 2c20 7472 6163 652e 6f75 7470  e(v), trace.outp
-0001f4f0: 7574 290a 2020 2020 2020 2020 7265 7475  ut).        retu
-0001f500: 726e 2076 6a70 2866 756e 6329 2861 7267  rn vjp(func)(arg
-0001f510: 732c 2063 6f74 616e 6765 6e74 732c 202a  s, cotangents, *
-0001f520: 2a6b 7761 7267 7329 0a0a 2020 2020 7265  *kwargs)..    re
-0001f530: 7475 726e 205f 7661 6c75 655f 616e 645f  turn _value_and_
-0001f540: 6772 6164 0a0a 0a46 6f72 7761 7264 4261  grad...ForwardBa
-0001f550: 636b 7761 7264 5472 6163 6573 203d 206e  ckwardTraces = n
-0001f560: 616d 6564 7475 706c 6528 2246 6f72 7761  amedtuple("Forwa
-0001f570: 7264 4261 636b 7761 7264 5472 6163 6573  rdBackwardTraces
-0001f580: 222c 205b 2266 6f72 7761 7264 5f74 7261  ", ["forward_tra
-0001f590: 6365 222c 2022 6261 636b 7761 7264 5f74  ce", "backward_t
-0001f5a0: 7261 6365 225d 290a 0a0a 6465 6620 5f73  race"])...def _s
-0001f5b0: 706c 6974 5f73 6176 6564 5f66 6f72 5f62  plit_saved_for_b
-0001f5c0: 6163 6b77 6172 645f 696e 746f 5f74 656e  ackward_into_ten
-0001f5d0: 736f 7273 5f61 6e64 5f6f 7468 6572 280a  sors_and_other(.
-0001f5e0: 2020 2020 7361 7665 645f 666f 725f 6261      saved_for_ba
-0001f5f0: 636b 7761 7264 3a20 5365 7175 656e 6365  ckward: Sequence
-0001f600: 5b56 6172 6961 626c 655d 2c0a 2920 2d3e  [Variable],.) ->
-0001f610: 2074 7570 6c65 5b53 6571 7565 6e63 655b   tuple[Sequence[
-0001f620: 5661 7269 6162 6c65 5d2c 2053 6571 7565  Variable], Seque
-0001f630: 6e63 655b 5661 7269 6162 6c65 5d5d 3a0a  nce[Variable]]:.
-0001f640: 2020 2020 2222 2253 706c 6974 7320 7361      """Splits sa
-0001f650: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f660: 2069 6e74 6f20 7465 6e73 6f72 7320 616e   into tensors an
-0001f670: 6420 6f74 6865 722e 0a0a 2020 2020 4172  d other...    Ar
-0001f680: 6773 3a0a 2020 2020 2020 2020 7361 7665  gs:.        save
-0001f690: 645f 666f 725f 6261 636b 7761 7264 2028  d_for_backward (
-0001f6a0: 5365 7175 656e 6365 5b56 6172 6961 626c  Sequence[Variabl
-0001f6b0: 655d 293a 2053 6176 6564 5f66 6f72 5f62  e]): Saved_for_b
-0001f6c0: 6163 6b77 6172 6420 746f 2073 706c 6974  ackward to split
-0001f6d0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-0001f6e0: 2020 2020 2020 2020 7475 706c 655b 5365          tuple[Se
-0001f6f0: 7175 656e 6365 5b56 6172 6961 626c 655d  quence[Variable]
-0001f700: 2c20 5365 7175 656e 6365 5b56 6172 6961  , Sequence[Varia
-0001f710: 626c 655d 5d3a 2054 7570 6c65 206f 6620  ble]]: Tuple of 
-0001f720: 7465 6e73 6f72 7320 616e 6420 6f74 6865  tensors and othe
-0001f730: 722e 0a20 2020 2022 2222 0a20 2020 2069  r..    """.    i
-0001f740: 735f 7465 6e73 6f72 203d 206c 616d 6264  s_tensor = lambd
-0001f750: 6120 783a 2069 7369 6e73 7461 6e63 6528  a x: isinstance(
-0001f760: 782c 2054 656e 736f 7250 726f 7879 290a  x, TensorProxy).
-0001f770: 2020 2020 6f74 6865 722c 2074 656e 736f      other, tenso
-0001f780: 7273 203d 2075 7469 6c73 2e70 6172 7469  rs = utils.parti
-0001f790: 7469 6f6e 2869 735f 7465 6e73 6f72 2c20  tion(is_tensor, 
-0001f7a0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-0001f7b0: 7264 290a 2020 2020 7265 7475 726e 2074  rd).    return t
-0001f7c0: 7570 6c65 2874 656e 736f 7273 292c 2074  uple(tensors), t
-0001f7d0: 7570 6c65 286f 7468 6572 290a 0a0a 6465  uple(other)...de
-0001f7e0: 6620 5f75 7064 6174 655f 666f 7277 6172  f _update_forwar
-0001f7f0: 645f 7769 7468 5f6e 6577 5f73 6176 6564  d_with_new_saved
-0001f800: 5f66 6f72 5f62 6163 6b77 6172 6428 666f  _for_backward(fo
-0001f810: 7277 6172 645f 7472 6163 653a 2054 7261  rward_trace: Tra
-0001f820: 6365 2c20 7361 7665 645f 666f 725f 6261  ce, saved_for_ba
-0001f830: 636b 7761 7264 3a20 5365 7175 656e 6365  ckward: Sequence
-0001f840: 5b56 6172 6961 626c 655d 2920 2d3e 204e  [Variable]) -> N
-0001f850: 6f6e 653a 0a20 2020 2022 2222 5570 6461  one:.    """Upda
-0001f860: 7465 7320 7468 6520 666f 7277 6172 6420  tes the forward 
-0001f870: 7472 6163 6520 7769 7468 206e 6577 2073  trace with new s
-0001f880: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001f890: 642e 0a0a 2020 2020 5468 6973 2069 7320  d...    This is 
-0001f8a0: 6e65 6365 7373 6172 7920 6265 6361 7573  necessary becaus
-0001f8b0: 6520 7468 6520 7570 6461 7465 6420 7361  e the updated sa
-0001f8c0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f8d0: 2069 7320 6e6f 7420 6176 6169 6c61 626c   is not availabl
-0001f8e0: 650a 2020 2020 7768 656e 2074 6865 2066  e.    when the f
-0001f8f0: 6f72 7761 7264 2061 6e64 2062 6163 6b77  orward and backw
-0001f900: 6172 6420 7472 6163 6573 2061 7265 2063  ard traces are c
-0001f910: 6f6e 7374 7275 6374 6564 2e0a 0a20 2020  onstructed...   
-0001f920: 2041 7267 733a 0a20 2020 2020 2020 2066   Args:.        f
-0001f930: 6f72 7761 7264 5f74 7261 6365 2028 5472  orward_trace (Tr
-0001f940: 6163 6529 3a20 466f 7277 6172 6420 7472  ace): Forward tr
-0001f950: 6163 6520 746f 2075 7064 6174 652e 0a20  ace to update.. 
-0001f960: 2020 2020 2020 2073 6176 6564 5f66 6f72         saved_for
-0001f970: 5f62 6163 6b77 6172 6420 2853 6571 7565  _backward (Seque
-0001f980: 6e63 655b 5661 7269 6162 6c65 5d29 3a20  nce[Variable]): 
-0001f990: 5361 7665 645f 666f 725f 6261 636b 7761  Saved_for_backwa
-0001f9a0: 7264 2074 6f20 7573 6520 746f 0a20 2020  rd to use to.   
-0001f9b0: 2020 2020 2020 2020 2075 7064 6174 6520           update 
-0001f9c0: 7468 6520 666f 7277 6172 6420 7472 6163  the forward trac
-0001f9d0: 652e 0a20 2020 2022 2222 0a20 2020 2073  e..    """.    s
-0001f9e0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001f9f0: 6420 3d20 7472 6565 5f6d 6170 286c 616d  d = tree_map(lam
-0001fa00: 6264 6120 783a 2078 2e76 616c 7565 2069  bda x: x.value i
-0001fa10: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-0001fa20: 4e75 6d62 6572 5072 6f78 7929 2065 6c73  NumberProxy) els
-0001fa30: 6520 782c 2073 6176 6564 5f66 6f72 5f62  e x, saved_for_b
-0001fa40: 6163 6b77 6172 6429 0a20 2020 2073 6176  ackward).    sav
-0001fa50: 6564 5f74 656e 736f 7273 2c20 7361 7665  ed_tensors, save
-0001fa60: 645f 6f74 6865 7220 3d20 5f73 706c 6974  d_other = _split
-0001fa70: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
-0001fa80: 6172 645f 696e 746f 5f74 656e 736f 7273  ard_into_tensors
-0001fa90: 5f61 6e64 5f6f 7468 6572 2873 6176 6564  _and_other(saved
-0001faa0: 5f66 6f72 5f62 6163 6b77 6172 6429 0a20  _for_backward). 
-0001fab0: 2020 2061 7373 6572 7420 666f 7277 6172     assert forwar
-0001fac0: 645f 7472 6163 652e 626f 756e 645f 7379  d_trace.bound_sy
-0001fad0: 6d62 6f6c 735b 2d31 5d2e 7379 6d2e 6964  mbols[-1].sym.id
-0001fae0: 203d 3d20 7072 696d 732e 5072 696d 4944   == prims.PrimID
-0001faf0: 732e 5245 5455 524e 0a20 2020 206e 6577  s.RETURN.    new
-0001fb00: 5f72 6574 7572 6e20 3d20 2866 6f72 7761  _return = (forwa
-0001fb10: 7264 5f74 7261 6365 2e6f 7574 7075 745b  rd_trace.output[
-0001fb20: 305d 2c20 2873 6176 6564 5f74 656e 736f  0], (saved_tenso
-0001fb30: 7273 2c20 7361 7665 645f 6f74 6865 7229  rs, saved_other)
-0001fb40: 290a 2020 2020 666f 7277 6172 645f 7472  ).    forward_tr
-0001fb50: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
-0001fb60: 735b 2d31 5d20 3d20 7265 706c 6163 6528  s[-1] = replace(
-0001fb70: 666f 7277 6172 645f 7472 6163 652e 626f  forward_trace.bo
-0001fb80: 756e 645f 7379 6d62 6f6c 735b 2d31 5d2c  und_symbols[-1],
-0001fb90: 2061 7267 733d 6e65 775f 7265 7475 726e   args=new_return
-0001fba0: 290a 0a0a 6465 6620 5f75 7064 6174 655f  )...def _update_
-0001fbb0: 6261 636b 7761 7264 5f77 6974 685f 6e65  backward_with_ne
-0001fbc0: 775f 7361 7665 645f 666f 725f 6261 636b  w_saved_for_back
-0001fbd0: 7761 7264 2862 6163 6b77 6172 645f 7472  ward(backward_tr
-0001fbe0: 6163 653a 2054 7261 6365 2c20 7361 7665  ace: Trace, save
-0001fbf0: 645f 666f 725f 6261 636b 7761 7264 3a20  d_for_backward: 
-0001fc00: 5365 7175 656e 6365 5b56 6172 6961 626c  Sequence[Variabl
-0001fc10: 655d 2920 2d3e 204e 6f6e 653a 0a20 2020  e]) -> None:.   
-0001fc20: 2022 2222 5570 6461 7465 7320 7468 6520   """Updates the 
-0001fc30: 6261 636b 7761 7264 2074 7261 6365 2077  backward trace w
-0001fc40: 6974 6820 6e65 7720 7361 7665 645f 666f  ith new saved_fo
-0001fc50: 725f 6261 636b 7761 7264 2e0a 0a20 2020  r_backward...   
-0001fc60: 2054 6869 7320 6973 206e 6563 6573 7361   This is necessa
-0001fc70: 7279 2062 6563 6175 7365 2074 6865 2075  ry because the u
-0001fc80: 7064 6174 6564 2073 6176 6564 5f66 6f72  pdated saved_for
-0001fc90: 5f62 6163 6b77 6172 6420 6973 0a20 2020  _backward is.   
-0001fca0: 206e 6f74 2061 7661 696c 6162 6c65 2077   not available w
-0001fcb0: 6865 6e20 7468 6520 6261 636b 7761 7264  hen the backward
-0001fcc0: 2074 7261 6365 2069 7320 636f 6e73 7472   trace is constr
-0001fcd0: 7563 7465 642e 0a0a 2020 2020 4172 6773  ucted...    Args
-0001fce0: 3a0a 2020 2020 2020 2020 6261 636b 7761  :.        backwa
-0001fcf0: 7264 5f74 7261 6365 2028 5472 6163 6529  rd_trace (Trace)
-0001fd00: 3a20 4261 636b 7761 7264 2074 7261 6365  : Backward trace
-0001fd10: 2074 6f20 7570 6461 7465 2e0a 2020 2020   to update..    
-0001fd20: 2020 2020 7361 7665 645f 666f 725f 6261      saved_for_ba
-0001fd30: 636b 7761 7264 2028 5365 7175 656e 6365  ckward (Sequence
-0001fd40: 5b56 6172 6961 626c 655d 293a 2053 6176  [Variable]): Sav
-0001fd50: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-0001fd60: 746f 2075 7365 2074 6f0a 2020 2020 2020  to use to.      
-0001fd70: 2020 2020 2020 7570 6461 7465 2074 6865        update the
-0001fd80: 2062 6163 6b77 6172 6420 7472 6163 652e   backward trace.
-0001fd90: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
-0001fda0: 6620 756e 7061 636b 696e 675f 666e 2873  f unpacking_fn(s
-0001fdb0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001fdc0: 642c 2063 6f74 616e 6765 6e74 7329 3a0a  d, cotangents):.
-0001fdd0: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
-0001fde0: 2020 636f 7461 6e67 656e 7473 203d 2062    cotangents = b
-0001fdf0: 6163 6b77 6172 645f 7472 6163 652e 6172  ackward_trace.ar
-0001fe00: 6773 5b31 5d0a 2020 2020 7361 7665 645f  gs[1].    saved_
-0001fe10: 7465 6e73 6f72 732c 2073 6176 6564 5f6f  tensors, saved_o
-0001fe20: 7468 6572 203d 205f 7370 6c69 745f 7361  ther = _split_sa
-0001fe30: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001fe40: 5f69 6e74 6f5f 7465 6e73 6f72 735f 616e  _into_tensors_an
-0001fe50: 645f 6f74 6865 7228 7361 7665 645f 666f  d_other(saved_fo
-0001fe60: 725f 6261 636b 7761 7264 290a 2020 2020  r_backward).    
-0001fe70: 756e 7061 636b 696e 675f 7472 6163 6520  unpacking_trace 
-0001fe80: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
-0001fe90: 6528 7265 6e61 6d65 5f70 726f 7869 6573  e(rename_proxies
-0001fea0: 3d46 616c 7365 2c20 7573 655f 6463 653d  =False, use_dce=
-0001feb0: 4661 6c73 6529 280a 2020 2020 2020 2020  False)(.        
-0001fec0: 756e 7061 636b 696e 675f 666e 2c20 2873  unpacking_fn, (s
-0001fed0: 6176 6564 5f74 656e 736f 7273 2c20 7361  aved_tensors, sa
-0001fee0: 7665 645f 6f74 6865 7229 2c20 636f 7461  ved_other), cota
-0001fef0: 6e67 656e 7473 0a20 2020 2029 0a20 2020  ngents.    ).   
-0001ff00: 2061 7373 6572 7420 756e 7061 636b 696e   assert unpackin
-0001ff10: 675f 7472 6163 652e 626f 756e 645f 7379  g_trace.bound_sy
-0001ff20: 6d62 6f6c 735b 2d31 5d2e 7379 6d2e 6964  mbols[-1].sym.id
-0001ff30: 203d 3d20 7072 696d 732e 5072 696d 4944   == prims.PrimID
-0001ff40: 732e 5245 5455 524e 0a0a 2020 2020 6261  s.RETURN..    ba
-0001ff50: 636b 7761 7264 5f74 7261 6365 2e61 7267  ckward_trace.arg
-0001ff60: 7320 3d20 756e 7061 636b 696e 675f 7472  s = unpacking_tr
-0001ff70: 6163 652e 6172 6773 0a20 2020 2062 6163  ace.args.    bac
-0001ff80: 6b77 6172 645f 7472 6163 655f 6273 796d  kward_trace_bsym
-0001ff90: 735f 7769 7468 6f75 745f 756e 7061 636b  s_without_unpack
-0001ffa0: 696e 6720 3d20 280a 2020 2020 2020 2020  ing = (.        
-0001ffb0: 6273 796d 0a20 2020 2020 2020 2066 6f72  bsym.        for
-0001ffc0: 2062 7379 6d20 696e 2062 6163 6b77 6172   bsym in backwar
-0001ffd0: 645f 7472 6163 652e 626f 756e 645f 7379  d_trace.bound_sy
-0001ffe0: 6d62 6f6c 730a 2020 2020 2020 2020 6966  mbols.        if
-0001fff0: 2062 7379 6d2e 7379 6d2e 6964 0a20 2020   bsym.sym.id.   
-00020000: 2020 2020 206e 6f74 2069 6e20 280a 2020       not in (.  
-00020010: 2020 2020 2020 2020 2020 7072 696d 732e            prims.
-00020020: 5072 696d 4944 732e 554e 5041 434b 5f45  PrimIDs.UNPACK_E
-00020030: 4d50 5459 5f44 4943 542c 0a20 2020 2020  MPTY_DICT,.     
-00020040: 2020 2020 2020 2070 7269 6d73 2e50 7269         prims.Pri
-00020050: 6d49 4473 2e55 4e50 4143 4b5f 4b45 592c  mIDs.UNPACK_KEY,
-00020060: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00020070: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
-00020080: 4b5f 5345 5155 454e 4345 2c0a 2020 2020  K_SEQUENCE,.    
-00020090: 2020 2020 2020 2020 7072 696d 732e 5072          prims.Pr
-000200a0: 696d 4944 732e 554e 5041 434b 5f54 5249  imIDs.UNPACK_TRI
-000200b0: 5649 414c 2c0a 2020 2020 2020 2020 290a  VIAL,.        ).
-000200c0: 2020 2020 290a 2020 2020 6261 636b 7761      ).    backwa
-000200d0: 7264 5f74 7261 6365 2e62 6f75 6e64 5f73  rd_trace.bound_s
-000200e0: 796d 626f 6c73 203d 206c 6973 7428 282a  ymbols = list((*
-000200f0: 756e 7061 636b 696e 675f 7472 6163 652e  unpacking_trace.
-00020100: 626f 756e 645f 7379 6d62 6f6c 735b 3a2d  bound_symbols[:-
-00020110: 315d 2c20 2a62 6163 6b77 6172 645f 7472  1], *backward_tr
-00020120: 6163 655f 6273 796d 735f 7769 7468 6f75  ace_bsyms_withou
-00020130: 745f 756e 7061 636b 696e 6729 290a 0a0a  t_unpacking))...
-00020140: 2320 4e4f 5445 3a20 5265 7475 726e 696e  # NOTE: Returnin
-00020150: 6720 6e61 6d65 6474 7570 6c65 7320 6672  g namedtuples fr
-00020160: 6f6d 2063 6f6d 7069 6c65 6420 6675 6e63  om compiled func
-00020170: 7469 6f6e 7320 646f 6573 6e27 7420 776f  tions doesn't wo
-00020180: 726b 2e20 5365 653a 0a23 2022 416c 6c6f  rk. See:.# "Allo
-00020190: 7720 7265 7475 726e 696e 6720 6e61 6d65  w returning name
-000201a0: 6474 7570 6c65 7320 6672 6f6d 2063 6f6d  dtuples from com
-000201b0: 7069 6c65 6420 6675 6e63 7469 6f6e 7322  piled functions"
-000201c0: 0a23 204e 6f74 6520 5b47 7261 6420 666f  .# Note [Grad fo
-000201d0: 7277 6172 6420 6f75 7470 7574 2073 7065  rward output spe
-000201e0: 635d 0a23 2049 6620 6974 2064 6964 2077  c].# If it did w
-000201f0: 6f72 6b20 6974 2077 6f75 6c64 2062 6520  ork it would be 
-00020200: 6e69 6365 2074 6f20 7573 6520 7468 6973  nice to use this
-00020210: 206e 616d 6564 7475 706c 650a 2320 696e   namedtuple.# in
-00020220: 7374 6561 6420 6f66 2074 6865 2070 6c61  stead of the pla
-00020230: 696e 2074 7570 6c65 206f 7220 6469 6374  in tuple or dict
-00020240: 2074 6861 7420 7765 2772 6520 7573 696e   that we're usin
-00020250: 6720 6e6f 772e 0a54 6f72 6368 4175 746f  g now..TorchAuto
-00020260: 6772 6164 466f 7277 6172 6444 6174 6120  gradForwardData 
-00020270: 3d20 6e61 6d65 6474 7570 6c65 280a 2020  = namedtuple(.  
-00020280: 2020 2254 6f72 6368 4175 746f 6772 6164    "TorchAutograd
-00020290: 466f 7277 6172 6444 6174 6122 2c0a 2020  ForwardData",.  
-000202a0: 2020 5b22 6f75 7470 7574 222c 2022 666c    ["output", "fl
-000202b0: 6174 5f61 7267 7322 2c20 2266 6c61 745f  at_args", "flat_
-000202c0: 6f75 7470 7574 225d 2c0a 290a 0a0a 6465  output"],.)...de
-000202d0: 6620 666f 7277 6172 645f 616e 645f 6261  f forward_and_ba
-000202e0: 636b 7761 7264 5f66 726f 6d5f 7472 6163  ckward_from_trac
-000202f0: 6528 7472 6163 653a 2054 7261 6365 2c20  e(trace: Trace, 
-00020300: 746f 7263 685f 6175 746f 6772 6164 3d46  torch_autograd=F
-00020310: 616c 7365 2920 2d3e 2046 6f72 7761 7264  alse) -> Forward
-00020320: 4261 636b 7761 7264 5472 6163 6573 3a0a  BackwardTraces:.
-00020330: 2020 2020 2222 2247 656e 6572 6174 6573      """Generates
-00020340: 2074 6865 2066 6f72 7761 7264 2061 6e64   the forward and
-00020350: 2062 6163 6b77 6172 6420 7061 7373 6573   backward passes
-00020360: 2066 726f 6d20 6120 7472 6163 652e 0a0a   from a trace...
-00020370: 2020 2020 5468 6973 2069 7320 6120 636f      This is a co
-00020380: 6e76 656e 6965 6e63 6520 6675 6e63 7469  nvenience functi
-00020390: 6f6e 2074 6861 7420 636f 6d62 696e 6573  on that combines
-000203a0: 2074 6865 2066 756e 6374 696f 6e61 6c69   the functionali
-000203b0: 7479 206f 660a 2020 2020 6061 7567 6d65  ty of.    `augme
-000203c0: 6e74 6564 5f66 6f72 7761 7264 5f70 6173  nted_forward_pas
-000203d0: 7360 2061 6e64 2060 6261 636b 7761 7264  s` and `backward
-000203e0: 5f70 6173 7360 2e20 5468 6520 6d61 696e  _pass`. The main
-000203f0: 2064 6966 6665 7265 6e63 6520 6973 2074   difference is t
-00020400: 6861 740a 2020 2020 7468 6973 2066 756e  hat.    this fun
-00020410: 6374 696f 6e20 646f 6573 206e 6f74 2072  ction does not r
-00020420: 6571 7569 7265 2074 6865 2075 7365 7220  equire the user 
-00020430: 746f 2070 726f 7669 6465 206e 6577 2069  to provide new i
-00020440: 6e70 7574 7320 666f 7220 7468 650a 2020  nputs for the.  
-00020450: 2020 7472 6163 6520 6576 616c 7561 7469    trace evaluati
-00020460: 6f6e 2e20 496e 7374 6561 6420 6974 2075  on. Instead it u
-00020470: 7365 7320 7468 6520 696e 7075 7473 2074  ses the inputs t
-00020480: 6861 7420 7765 7265 2075 7365 6420 746f  hat were used to
-00020490: 2063 6f6e 7374 7275 6374 0a20 2020 2074   construct.    t
-000204a0: 6865 2074 7261 6365 2e0a 0a20 2020 2041  he trace...    A
-000204b0: 7267 733a 0a20 2020 2020 2020 2074 7261  rgs:.        tra
-000204c0: 6365 2028 5472 6163 6529 3a20 5472 6163  ce (Trace): Trac
-000204d0: 6520 746f 2067 656e 6572 6174 6520 7468  e to generate th
-000204e0: 6520 666f 7277 6172 6420 616e 6420 6261  e forward and ba
-000204f0: 636b 7761 7264 2070 6173 7365 7320 6672  ckward passes fr
-00020500: 6f6d 2e0a 0a20 2020 2052 6574 7572 6e73  om...    Returns
-00020510: 3a0a 2020 2020 2020 2020 466f 7277 6172  :.        Forwar
-00020520: 6442 6163 6b77 6172 6454 7261 6365 733a  dBackwardTraces:
-00020530: 2041 206e 616d 6564 2074 7570 6c65 2063   A named tuple c
-00020540: 6f6e 7461 696e 696e 6720 7468 6520 666f  ontaining the fo
-00020550: 7277 6172 6420 616e 6420 6261 636b 7761  rward and backwa
-00020560: 7264 0a20 2020 2020 2020 2020 2020 2074  rd.            t
-00020570: 7261 6365 732e 0a0a 2020 2020 4578 616d  races...    Exam
-00020580: 706c 653a 0a20 2020 2020 2020 203e 3e3e  ple:.        >>>
-00020590: 2069 6d70 6f72 7420 746f 7263 680a 2020   import torch.  
-000205a0: 2020 2020 2020 3e3e 3e20 6672 6f6d 2074        >>> from t
-000205b0: 6875 6e64 6572 2069 6d70 6f72 7420 636f  hunder import co
-000205c0: 6d70 696c 652c 206c 6173 745f 7472 6163  mpile, last_trac
-000205d0: 6573 0a20 2020 2020 2020 203e 3e3e 2066  es.        >>> f
-000205e0: 726f 6d20 7468 756e 6465 722e 636f 7265  rom thunder.core
-000205f0: 2e74 7261 6e73 666f 726d 7320 696d 706f  .transforms impo
-00020600: 7274 2066 6f72 7761 7264 5f61 6e64 5f62  rt forward_and_b
-00020610: 6163 6b77 6172 645f 6672 6f6d 5f74 7261  ackward_from_tra
-00020620: 6365 0a20 2020 2020 2020 203e 3e3e 2064  ce.        >>> d
-00020630: 6566 2066 2878 293a 0a20 2020 2020 2020  ef f(x):.       
-00020640: 202e 2e2e 2020 2020 2072 6574 7572 6e20   ...     return 
-00020650: 746f 7263 682e 7369 6e28 7829 0a20 2020  torch.sin(x).   
-00020660: 2020 2020 203e 3e3e 2078 203d 2074 6f72       >>> x = tor
-00020670: 6368 2e74 656e 736f 7228 332e 3029 0a20  ch.tensor(3.0). 
-00020680: 2020 2020 2020 203e 3e3e 2063 6620 3d20         >>> cf = 
-00020690: 636f 6d70 696c 6528 6629 0a20 2020 2020  compile(f).     
-000206a0: 2020 203e 3e3e 206f 7574 203d 2063 6628     >>> out = cf(
-000206b0: 7829 0a20 2020 2020 2020 203e 3e3e 2074  x).        >>> t
-000206c0: 7261 6365 203d 206c 6173 745f 7472 6163  race = last_trac
-000206d0: 6573 2863 6629 5b30 5d0a 2020 2020 2020  es(cf)[0].      
-000206e0: 2020 3e3e 3e20 666f 7277 6172 645f 616e    >>> forward_an
-000206f0: 645f 6261 636b 7761 7264 5f66 726f 6d5f  d_backward_from_
-00020700: 7472 6163 6528 7472 6163 6529 0a20 2020  trace(trace).   
-00020710: 2020 2020 202e 2e2e 2046 6f72 7761 7264       ... Forward
-00020720: 4261 636b 7761 7264 5472 6163 6573 280a  BackwardTraces(.
-00020730: 2020 2020 2020 2020 2e2e 2e20 666f 7277          ... forw
-00020740: 6172 645f 7472 6163 653d 2320 696d 706f  ard_trace=# impo
-00020750: 7274 2074 6875 6e64 6572 2061 7320 7468  rt thunder as th
-00020760: 756e 6465 720a 2020 2020 2020 2020 2e2e  under.        ..
-00020770: 2e20 2320 696d 706f 7274 2074 6875 6e64  . # import thund
-00020780: 6572 2e63 6f72 652e 7072 696d 7320 6173  er.core.prims as
-00020790: 2070 7269 6d73 0a20 2020 2020 2020 202e   prims.        .
-000207a0: 2e2e 2069 6d70 6f72 7420 746f 7263 680a  .. import torch.
-000207b0: 2020 2020 2020 2020 2e2e 2e0a 2020 2020          ....    
-000207c0: 2020 2020 2e2e 2e20 4074 6f72 6368 2e6e      ... @torch.n
-000207d0: 6f5f 6772 6164 2829 0a20 2020 2020 2020  o_grad().       
-000207e0: 202e 2e2e 2064 6566 2061 7567 6d65 6e74   ... def augment
-000207f0: 6564 5f66 6f72 7761 7264 5f66 6e28 2a61  ed_forward_fn(*a
-00020800: 7267 7329 3a0a 2020 2020 2020 2020 2e2e  rgs):.        ..
-00020810: 2e20 2020 2320 6172 6773 3a20 2243 6f6c  .   # args: "Col
-00020820: 6c65 6374 696f 6e22 203d 2020 2874 302c  lection" =  (t0,
-00020830: 2920 2028 7472 6976 6961 6c20 756e 7061  )  (trivial unpa
-00020840: 636b 290a 2020 2020 2020 2020 2e2e 2e20  ck).        ... 
-00020850: 2020 7430 2c20 5c0a 2020 2020 2020 2020    t0, \.        
-00020860: 2e2e 2e20 2020 3d20 6172 6773 0a20 2020  ...   = args.   
-00020870: 2020 2020 202e 2e2e 2020 2074 3120 3d20       ...   t1 = 
-00020880: 7072 696d 732e 7369 6e28 7430 2920 2023  prims.sin(t0)  #
-00020890: 2074 313a 2022 6370 7520 6633 325b 5d22   t1: "cpu f32[]"
-000208a0: 0a20 2020 2020 2020 202e 2e2e 2020 2072  .        ...   r
-000208b0: 6574 7572 6e20 7431 2c20 2874 302c 292c  eturn t1, (t0,),
-000208c0: 0a20 2020 2020 2020 202e 2e2e 2062 6163  .        ... bac
-000208d0: 6b77 6172 645f 7472 6163 653d 2320 696d  kward_trace=# im
-000208e0: 706f 7274 2074 6875 6e64 6572 2061 7320  port thunder as 
-000208f0: 7468 756e 6465 720a 2020 2020 2020 2020  thunder.        
-00020900: 2e2e 2e20 2320 696d 706f 7274 2074 6875  ... # import thu
-00020910: 6e64 6572 2e63 6f72 652e 7072 696d 7320  nder.core.prims 
-00020920: 6173 2070 7269 6d73 0a20 2020 2020 2020  as prims.       
-00020930: 202e 2e2e 2069 6d70 6f72 7420 746f 7263   ... import torc
-00020940: 680a 2020 2020 2020 2020 2e2e 2e0a 2020  h.        ....  
-00020950: 2020 2020 2020 2e2e 2e20 4074 6f72 6368        ... @torch
-00020960: 2e6e 6f5f 6772 6164 2829 0a20 2020 2020  .no_grad().     
-00020970: 2020 202e 2e2e 2064 6566 2062 6163 6b77     ... def backw
-00020980: 6172 645f 666e 2873 6176 6564 5f66 6f72  ard_fn(saved_for
-00020990: 5f62 6163 6b77 6172 642c 2063 6f74 616e  _backward, cotan
-000209a0: 6765 6e74 7329 3a0a 2020 2020 2020 2020  gents):.        
-000209b0: 2e2e 2e20 2020 2320 7361 7665 645f 666f  ...   # saved_fo
-000209c0: 725f 6261 636b 7761 7264 3a20 2243 6f6c  r_backward: "Col
-000209d0: 6c65 6374 696f 6e22 203d 2020 2874 302c  lection" =  (t0,
-000209e0: 2920 2028 7472 6976 6961 6c20 756e 7061  )  (trivial unpa
-000209f0: 636b 290a 2020 2020 2020 2020 2e2e 2e20  ck).        ... 
-00020a00: 2020 2320 636f 7461 6e67 656e 7473 3a20    # cotangents: 
-00020a10: 2263 7075 2066 3332 5b5d 2220 3d20 2063  "cpu f32[]" =  c
-00020a20: 6f74 616e 6765 6e74 7320 2028 7472 6976  otangents  (triv
-00020a30: 6961 6c20 756e 7061 636b 290a 2020 2020  ial unpack).    
-00020a40: 2020 2020 2e2e 2e20 2020 7430 2c20 5c0a      ...   t0, \.
-00020a50: 2020 2020 2020 2020 2e2e 2e20 2020 3d20          ...   = 
-00020a60: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-00020a70: 7264 0a20 2020 2020 2020 202e 2e2e 2020  rd.        ...  
-00020a80: 2074 3120 3d20 7072 696d 732e 636f 7328   t1 = prims.cos(
-00020a90: 7430 2920 2023 2074 313a 2022 6370 7520  t0)  # t1: "cpu 
-00020aa0: 6633 325b 5d22 0a20 2020 2020 2020 202e  f32[]".        .
-00020ab0: 2e2e 2020 2074 3220 3d20 7072 696d 732e  ..   t2 = prims.
-00020ac0: 6d75 6c28 636f 7461 6e67 656e 7473 2c20  mul(cotangents, 
-00020ad0: 7431 2920 2023 2074 323a 2022 6370 7520  t1)  # t2: "cpu 
-00020ae0: 6633 325b 5d22 0a20 2020 2020 2020 202e  f32[]".        .
-00020af0: 2e2e 2020 2072 6574 7572 6e20 2874 322c  ..   return (t2,
-00020b00: 2929 0a20 2020 2022 2222 0a0a 2020 2020  )).    """..    
-00020b10: 6f75 7470 7574 5f73 7065 6320 3d20 4e6f  output_spec = No
-00020b20: 6e65 0a0a 2020 2020 6465 6620 6175 676d  ne..    def augm
-00020b30: 656e 7465 645f 666f 7277 6172 645f 666e  ented_forward_fn
-00020b40: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
-00020b50: 293a 0a20 2020 2020 2020 2072 6573 756c  ):.        resul
-00020b60: 742c 2065 6e76 203d 2061 7567 6d65 6e74  t, env = augment
-00020b70: 6564 5f66 6f72 7761 7264 5f70 6173 7328  ed_forward_pass(
-00020b80: 2a61 7267 732c 2074 7261 6365 3d74 7261  *args, trace=tra
-00020b90: 6365 2c20 2a2a 6b77 6172 6773 290a 2020  ce, **kwargs).  
-00020ba0: 2020 2020 2020 7361 7665 645f 666f 725f        saved_for_
-00020bb0: 6261 636b 7761 7264 203d 2064 6563 6f6e  backward = decon
-00020bc0: 7374 7275 6374 5f66 6f72 7761 7264 5f65  struct_forward_e
-00020bd0: 6e76 5f66 6f72 5f62 6163 6b77 6172 6428  nv_for_backward(
-00020be0: 7472 6163 652c 2065 6e76 290a 2020 2020  trace, env).    
-00020bf0: 2020 2020 6966 2074 6f72 6368 5f61 7574      if torch_aut
-00020c00: 6f67 7261 643a 0a20 2020 2020 2020 2020  ograd:.         
-00020c10: 2020 206e 6f6e 6c6f 6361 6c20 6f75 7470     nonlocal outp
-00020c20: 7574 5f73 7065 630a 2020 2020 2020 2020  ut_spec.        
-00020c30: 2020 2020 666c 6174 5f61 7267 732c 205f      flat_args, _
-00020c40: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
-00020c50: 2861 7267 732c 206b 7761 7267 7329 290a  (args, kwargs)).
-00020c60: 2020 2020 2020 2020 2020 2020 666c 6174              flat
-00020c70: 5f6f 7574 7075 742c 206f 7574 7075 745f  _output, output_
-00020c80: 7370 6563 203d 2074 7265 655f 666c 6174  spec = tree_flat
-00020c90: 7465 6e28 7265 7375 6c74 290a 2020 2020  ten(result).    
-00020ca0: 2020 2020 2020 2020 666c 6174 5f6f 7574          flat_out
-00020cb0: 7075 7420 3d20 7475 706c 6528 666c 6174  put = tuple(flat
-00020cc0: 5f6f 7574 7075 7429 0a20 2020 2020 2020  _output).       
-00020cd0: 2020 2020 2023 2053 6565 204e 6f74 6520       # See Note 
-00020ce0: 5b47 7261 6420 666f 7277 6172 6420 6f75  [Grad forward ou
-00020cf0: 7470 7574 2073 7065 635d 0a20 2020 2020  tput spec].     
-00020d00: 2020 2020 2020 2066 6f72 5f61 7574 6f67         for_autog
-00020d10: 7261 6420 3d20 546f 7263 6841 7574 6f67  rad = TorchAutog
-00020d20: 7261 6446 6f72 7761 7264 4461 7461 280a  radForwardData(.
-00020d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020d40: 7265 7375 6c74 2c0a 2020 2020 2020 2020  result,.        
-00020d50: 2020 2020 2020 2020 666c 6174 5f61 7267          flat_arg
-00020d60: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00020d70: 2020 2066 6c61 745f 6f75 7470 7574 2c0a     flat_output,.
-00020d80: 2020 2020 2020 2020 2020 2020 292e 5f61              )._a
-00020d90: 7364 6963 7428 290a 2020 2020 2020 2020  sdict().        
-00020da0: 2020 2020 7265 7475 726e 2028 666f 725f      return (for_
-00020db0: 6175 746f 6772 6164 2c20 7361 7665 645f  autograd, saved_
-00020dc0: 666f 725f 6261 636b 7761 7264 290a 2020  for_backward).  
-00020dd0: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-00020de0: 756c 742c 2073 6176 6564 5f66 6f72 5f62  ult, saved_for_b
-00020df0: 6163 6b77 6172 640a 0a20 2020 2023 2043  ackward..    # C
-00020e00: 6f70 7920 7468 6520 7369 676e 6174 7572  opy the signatur
-00020e10: 6520 6f66 2074 6865 206f 7269 6769 6e61  e of the origina
-00020e20: 6c20 6675 6e63 7469 6f6e 2073 6f20 7468  l function so th
-00020e30: 6174 2074 6865 2061 7267 756d 656e 7473  at the arguments
-00020e40: 2061 7265 0a20 2020 2023 206e 616d 6564   are.    # named
-00020e50: 2063 6f72 7265 6374 6c79 2069 6e20 7468   correctly in th
-00020e60: 6520 6175 676d 656e 7465 6420 666f 7277  e augmented forw
-00020e70: 6172 6420 7061 7373 2069 6e73 7465 6164  ard pass instead
-00020e80: 206f 6620 6265 696e 6720 6e61 6d65 640a   of being named.
-00020e90: 2020 2020 2320 2261 7267 7322 2061 6e64      # "args" and
-00020ea0: 2022 6b77 6172 6773 222e 0a20 2020 2061   "kwargs"..    a
-00020eb0: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-00020ec0: 5f66 6e2e 5f5f 7369 676e 6174 7572 655f  _fn.__signature_
-00020ed0: 5f20 3d20 696e 7370 6563 742e 7369 676e  _ = inspect.sign
-00020ee0: 6174 7572 6528 7472 6163 652e 666e 290a  ature(trace.fn).
-00020ef0: 0a20 2020 2064 6566 206f 6e65 735f 6c69  .    def ones_li
-00020f00: 6b65 2878 293a 0a20 2020 2020 2020 2069  ke(x):.        i
-00020f10: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-00020f20: 5465 6e73 6f72 5072 6f78 7929 3a0a 2020  TensorProxy):.  
-00020f30: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00020f40: 2066 756c 6c5f 6c69 6b65 2878 2c20 6669   full_like(x, fi
-00020f50: 6c6c 5f76 616c 7565 3d31 290a 2020 2020  ll_value=1).    
-00020f60: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00020f70: 6e63 6528 782c 204e 756d 6265 7250 726f  nce(x, NumberPro
-00020f80: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
-00020f90: 2072 6574 7572 6e20 7479 7065 2878 2e76   return type(x.v
-00020fa0: 616c 7565 2928 3129 0a20 2020 2020 2020  alue)(1).       
-00020fb0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00020fc0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-00020fd0: 2020 2020 666f 7277 6172 645f 7472 6163      forward_trac
-00020fe0: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
-00020ff0: 6163 6528 2928 6175 676d 656e 7465 645f  ace()(augmented_
-00021000: 666f 7277 6172 645f 666e 2c20 2a74 7261  forward_fn, *tra
-00021010: 6365 2e61 7267 732c 202a 2a74 7261 6365  ce.args, **trace
-00021020: 2e6b 7761 7267 7329 0a20 2020 2023 2057  .kwargs).    # W
-00021030: 6520 7365 7420 666f 7277 6172 6420 7472  e set forward tr
-00021040: 6163 6520 746f 2063 6f6e 7374 7275 6374  ace to construct
-00021050: 2070 726f 7869 6573 2062 6563 6175 7365   proxies because
-00021060: 2077 6520 6e65 6564 2074 6865 7365 2070   we need these p
-00021070: 726f 7869 6573 2074 6f0a 2020 2020 2320  roxies to.    # 
-00021080: 6861 7665 2064 6966 6665 7265 6e74 206e  have different n
-00021090: 616d 6573 2074 6861 6e20 7468 6520 6f6e  ames than the on
-000210a0: 6573 2069 6e20 7468 6520 666f 7277 6172  es in the forwar
-000210b0: 6420 7472 6163 652e 0a20 2020 2074 7279  d trace..    try
-000210c0: 3a0a 2020 2020 2020 2020 7472 6163 6563  :.        tracec
-000210d0: 7478 5f74 6f6b 656e 203d 2073 6574 5f74  tx_token = set_t
-000210e0: 7261 6365 6374 7828 666f 7277 6172 645f  racectx(forward_
-000210f0: 7472 6163 6529 0a20 2020 2020 2020 2023  trace).        #
-00021100: 2057 6520 646f 6e27 7420 7761 6e74 2074   We don't want t
-00021110: 6f20 7265 636f 7264 2074 686f 7365 206f  o record those o
-00021120: 6e65 735f 6c69 6b65 2063 616c 6c73 2069  nes_like calls i
-00021130: 6e20 7468 6520 666f 7277 6172 6420 7472  n the forward tr
-00021140: 6163 652e 0a20 2020 2020 2020 2077 6974  ace..        wit
-00021150: 6820 6465 7461 6368 6564 5f74 7261 6365  h detached_trace
-00021160: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00021170: 6966 2074 6f72 6368 5f61 7574 6f67 7261  if torch_autogra
-00021180: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-00021190: 2020 2023 2049 7427 7320 6173 7375 6d65     # It's assume
-000211a0: 6420 7468 6174 2066 6f72 7761 7264 5f74  d that forward_t
-000211b0: 7261 6365 2e6f 7574 7075 745b 305d 2069  race.output[0] i
-000211c0: 7320 6120 6469 6374 2066 726f 6d20 546f  s a dict from To
-000211d0: 7263 6841 7574 6f67 7261 6446 6f72 7761  rchAutogradForwa
-000211e0: 7264 4461 7461 0a20 2020 2020 2020 2020  rdData.         
-000211f0: 2020 2020 2020 2066 6c61 745f 6f75 7470         flat_outp
-00021200: 7574 203d 2066 6f72 7761 7264 5f74 7261  ut = forward_tra
-00021210: 6365 2e6f 7574 7075 745b 305d 5b22 666c  ce.output[0]["fl
-00021220: 6174 5f6f 7574 7075 7422 5d0a 2020 2020  at_output"].    
-00021230: 2020 2020 2020 2020 2020 2020 636f 7461              cota
-00021240: 6e67 656e 7473 203d 2075 7469 6c73 2e73  ngents = utils.s
-00021250: 6571 7565 6e63 6966 7928 7472 6565 5f6d  equencify(tree_m
-00021260: 6170 286c 616d 6264 6120 763a 206f 6e65  ap(lambda v: one
-00021270: 735f 6c69 6b65 2876 292c 2066 6c61 745f  s_like(v), flat_
-00021280: 6f75 7470 7574 2929 0a20 2020 2020 2020  output)).       
-00021290: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000212a0: 2020 2020 2020 2020 2020 2063 6f74 616e             cotan
-000212b0: 6765 6e74 7320 3d20 7574 696c 732e 7365  gents = utils.se
-000212c0: 7175 656e 6369 6679 2874 7265 655f 6d61  quencify(tree_ma
-000212d0: 7028 6c61 6d62 6461 2076 3a20 6f6e 6573  p(lambda v: ones
-000212e0: 5f6c 696b 6528 7629 2c20 7472 6163 652e  _like(v), trace.
-000212f0: 6f75 7470 7574 2929 0a20 2020 2066 696e  output)).    fin
-00021300: 616c 6c79 3a0a 2020 2020 2020 2020 7265  ally:.        re
-00021310: 7365 745f 7472 6163 6563 7478 2874 7261  set_tracectx(tra
-00021320: 6365 6374 785f 746f 6b65 6e29 0a0a 2020  cectx_token)..  
-00021330: 2020 6465 6620 6261 636b 7761 7264 5f66    def backward_f
-00021340: 6e28 7361 7665 645f 666f 725f 6261 636b  n(saved_for_back
-00021350: 7761 7264 2c20 636f 7461 6e67 656e 7473  ward, cotangents
-00021360: 293a 0a20 2020 2020 2020 2065 6e76 203d  ):.        env =
-00021370: 2072 6563 6f6e 7374 7275 6374 5f66 6f72   reconstruct_for
-00021380: 7761 7264 5f65 6e76 5f66 6f72 5f62 6163  ward_env_for_bac
-00021390: 6b77 6172 6428 7472 6163 652c 2073 6176  kward(trace, sav
-000213a0: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
-000213b0: 0a20 2020 2020 2020 2069 6620 746f 7263  .        if torc
-000213c0: 685f 6175 746f 6772 6164 3a0a 2020 2020  h_autograd:.    
-000213d0: 2020 2020 2020 2020 636f 7461 6e67 656e          cotangen
-000213e0: 7473 203d 2074 7265 655f 756e 666c 6174  ts = tree_unflat
-000213f0: 7465 6e28 636f 7461 6e67 656e 7473 2c20  ten(cotangents, 
-00021400: 6f75 7470 7574 5f73 7065 6329 0a20 2020  output_spec).   
-00021410: 2020 2020 206f 7574 203d 2062 6163 6b77       out = backw
-00021420: 6172 645f 7061 7373 2865 6e76 2c20 7472  ard_pass(env, tr
-00021430: 6163 652c 2063 6f74 616e 6765 6e74 7329  ace, cotangents)
-00021440: 0a20 2020 2020 2020 2069 6620 746f 7263  .        if torc
-00021450: 685f 6175 746f 6772 6164 3a0a 2020 2020  h_autograd:.    
-00021460: 2020 2020 2020 2020 676b 7761 7267 7320          gkwargs 
-00021470: 3d20 6f75 745b 2d31 5d20 6966 2069 7369  = out[-1] if isi
-00021480: 6e73 7461 6e63 6528 6f75 745b 2d31 5d2c  nstance(out[-1],
-00021490: 2064 6963 7429 2065 6c73 6520 7b7d 0a20   dict) else {}. 
-000214a0: 2020 2020 2020 2020 2020 2067 6172 6773             gargs
-000214b0: 203d 206f 7574 5b3a 2d31 5d20 6966 2069   = out[:-1] if i
-000214c0: 7369 6e73 7461 6e63 6528 6f75 745b 2d31  sinstance(out[-1
-000214d0: 5d2c 2064 6963 7429 2065 6c73 6520 6f75  ], dict) else ou
-000214e0: 740a 2020 2020 2020 2020 2020 2020 676b  t.            gk
-000214f0: 7761 7267 7320 3d20 7b6b 3a20 676b 7761  wargs = {k: gkwa
-00021500: 7267 732e 6765 7428 6b2c 204e 6f6e 6529  rgs.get(k, None)
-00021510: 2066 6f72 206b 2069 6e20 7472 6163 652e   for k in trace.
-00021520: 6b77 6172 6773 7d0a 2020 2020 2020 2020  kwargs}.        
-00021530: 2020 2020 6f75 7420 3d20 282a 6761 7267      out = (*garg
-00021540: 732c 2067 6b77 6172 6773 290a 2020 2020  s, gkwargs).    
-00021550: 2020 2020 2020 2020 6f75 7420 3d20 7472          out = tr
-00021560: 6565 5f66 6c61 7474 656e 286f 7574 295b  ee_flatten(out)[
-00021570: 305d 0a20 2020 2020 2020 2072 6574 7572  0].        retur
-00021580: 6e20 6f75 740a 0a20 2020 2073 6176 6564  n out..    saved
-00021590: 5f66 6f72 5f62 6163 6b77 6172 6420 3d20  _for_backward = 
-000215a0: 666f 7277 6172 645f 7472 6163 652e 6f75  forward_trace.ou
-000215b0: 7470 7574 5b31 5d0a 2020 2020 6261 636b  tput[1].    back
-000215c0: 7761 7264 5f74 7261 6365 203d 2063 6f6e  ward_trace = con
-000215d0: 7374 7275 6374 5f74 7261 6365 2872 656e  struct_trace(ren
-000215e0: 616d 655f 7072 6f78 6965 733d 4661 6c73  ame_proxies=Fals
-000215f0: 6529 2862 6163 6b77 6172 645f 666e 2c20  e)(backward_fn, 
-00021600: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-00021610: 7264 2c20 636f 7461 6e67 656e 7473 290a  rd, cotangents).
-00021620: 0a20 2020 2023 2057 6520 6172 6520 646f  .    # We are do
-00021630: 6e65 2077 6974 6820 636f 6e73 7472 7563  ne with construc
-00021640: 7469 6e67 2074 6865 2066 6f72 7761 7264  ting the forward
-00021650: 2061 6e64 2062 6163 6b77 6172 6420 7061   and backward pa
-00021660: 7373 6573 2061 7420 7468 6973 0a20 2020  sses at this.   
-00021670: 2023 2073 7461 6765 2e20 5468 6520 666f   # stage. The fo
-00021680: 6c6c 6f77 696e 6720 6973 206e 6f74 2073  llowing is not s
-00021690: 7472 6963 746c 7920 6e65 6365 7373 6172  trictly necessar
-000216a0: 792c 2062 7574 2069 7427 7320 676f 6f64  y, but it's good
-000216b0: 2074 6f20 6669 6c74 6572 0a20 2020 2023   to filter.    #
-000216c0: 206f 7574 2074 6865 2075 6e75 7365 6420   out the unused 
-000216d0: 656c 656d 656e 7473 206f 6620 7468 6520  elements of the 
-000216e0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-000216f0: 7264 2061 6e64 2066 6c61 7474 656e 2069  rd and flatten i
-00021700: 7420 666f 7220 6d6f 7265 0a20 2020 2023  t for more.    #
-00021710: 2063 6f6d 7061 6374 2062 6163 6b77 6172   compact backwar
-00021720: 6420 7472 6163 652e 0a0a 2020 2020 2320  d trace...    # 
-00021730: 4e6f 7720 7765 2063 616e 2064 6574 6572  Now we can deter
-00021740: 6d69 6e65 2065 7861 6374 6c79 2077 6861  mine exactly wha
-00021750: 7427 7320 7573 6564 2069 6e20 7468 6520  t's used in the 
-00021760: 6261 636b 7761 7264 2070 6173 7320 6672  backward pass fr
-00021770: 6f6d 2074 6865 0a20 2020 2023 2073 6176  om the.    # sav
-00021780: 6564 5f66 6f72 5f62 6163 6b77 6172 642e  ed_for_backward.
-00021790: 2057 6520 6361 6e20 666c 6174 7465 6e20   We can flatten 
-000217a0: 616e 6420 6669 6c74 6572 2074 6865 2073  and filter the s
-000217b0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-000217c0: 640a 2020 2020 636f 6e73 756d 6572 7320  d.    consumers 
-000217d0: 3d20 7574 696c 732e 636f 6e73 756d 6572  = utils.consumer
-000217e0: 7328 6261 636b 7761 7264 5f74 7261 6365  s(backward_trace
-000217f0: 290a 0a20 2020 2023 2046 6f72 7761 7264  )..    # Forward
-00021800: 2773 2061 6e64 2062 6163 6b77 6172 6427  's and backward'
-00021810: 7320 2273 6176 6564 5f66 6f72 5f62 6163  s "saved_for_bac
-00021820: 6b77 6172 6422 2061 7265 206e 6f74 206e  kward" are not n
-00021830: 6563 6573 7361 7269 6c79 2074 6865 2073  ecessarily the s
-00021840: 616d 650a 2020 2020 2320 6173 2074 6865  ame.    # as the
-00021850: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-00021860: 6172 642c 2062 6563 6175 7365 2073 6f6d  ard, because som
-00021870: 6520 6f72 2061 6c6c 2065 6c65 6d65 6e74  e or all element
-00021880: 7320 6f66 2074 6865 0a20 2020 2023 2073  s of the.    # s
-00021890: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-000218a0: 6420 7265 7375 6c74 7320 6d69 6768 7420  d results might 
-000218b0: 6265 2072 652d 7072 6f78 6966 6965 642e  be re-proxified.
-000218c0: 0a20 2020 2062 775f 666c 6174 5f73 6176  .    bw_flat_sav
-000218d0: 6564 5f66 6f72 5f62 6163 6b77 6172 642c  ed_for_backward,
-000218e0: 2073 7065 6320 3d20 7472 6565 5f66 6c61   spec = tree_fla
-000218f0: 7474 656e 2862 6163 6b77 6172 645f 7472  tten(backward_tr
-00021900: 6163 652e 6172 6773 5b30 5d29 0a20 2020  ace.args[0]).   
-00021910: 2066 775f 666c 6174 5f73 6176 6564 5f66   fw_flat_saved_f
-00021920: 6f72 5f62 6163 6b77 6172 642c 205f 203d  or_backward, _ =
-00021930: 2074 7265 655f 666c 6174 7465 6e28 666f   tree_flatten(fo
-00021940: 7277 6172 645f 7472 6163 652e 6f75 7470  rward_trace.outp
-00021950: 7574 5b31 5d29 0a20 2020 2075 7365 645f  ut[1]).    used_
-00021960: 6d61 736b 203d 206c 6973 7428 6c65 6e28  mask = list(len(
-00021970: 636f 6e73 756d 6572 732e 6765 7428 782c  consumers.get(x,
-00021980: 2028 2929 2920 3e20 3020 666f 7220 7820   ())) > 0 for x 
-00021990: 696e 2062 775f 666c 6174 5f73 6176 6564  in bw_flat_saved
-000219a0: 5f66 6f72 5f62 6163 6b77 6172 6429 0a0a  _for_backward)..
-000219b0: 2020 2020 2320 446f 6e27 7420 7573 6520      # Don't use 
-000219c0: 7468 6520 7361 6d65 2076 6172 6961 626c  the same variabl
-000219d0: 6520 7477 6963 6520 696e 2074 6865 2062  e twice in the b
-000219e0: 6163 6b77 6172 6420 7061 7373 0a20 2020  ackward pass.   
-000219f0: 2073 6565 6e20 3d20 7365 7428 290a 2020   seen = set().  
-00021a00: 2020 6672 6f6d 2074 6875 6e64 6572 2e63    from thunder.c
-00021a10: 6f72 652e 7072 6f78 6965 7320 696d 706f  ore.proxies impo
-00021a20: 7274 2056 6172 6961 626c 650a 0a20 2020  rt Variable..   
-00021a30: 2066 6f72 2069 2c20 7820 696e 2065 6e75   for i, x in enu
-00021a40: 6d65 7261 7465 2866 775f 666c 6174 5f73  merate(fw_flat_s
-00021a50: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-00021a60: 6429 3a0a 2020 2020 2020 2020 7820 3d20  d):.        x = 
-00021a70: 7661 7269 6162 6c65 6966 7928 7829 0a20  variableify(x). 
-00021a80: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-00021a90: 696e 7374 616e 6365 2878 2c20 5661 7269  instance(x, Vari
-00021aa0: 6162 6c65 293a 0a20 2020 2020 2020 2020  able):.         
-00021ab0: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
-00021ac0: 2020 2020 6966 2078 2069 6e20 7365 656e      if x in seen
-00021ad0: 3a0a 2020 2020 2020 2020 2020 2020 7573  :.            us
-00021ae0: 6564 5f6d 6173 6b5b 695d 203d 2046 616c  ed_mask[i] = Fal
-00021af0: 7365 0a20 2020 2020 2020 2065 6c73 653a  se.        else:
-00021b00: 0a20 2020 2020 2020 2020 2020 2073 6565  .            see
-00021b10: 6e2e 6164 6428 7829 0a0a 2020 2020 6f6e  n.add(x)..    on
-00021b20: 6c79 5f75 7365 645f 6677 5f73 6176 6564  ly_used_fw_saved
-00021b30: 5f66 6f72 5f62 6163 6b77 6172 6420 3d20  _for_backward = 
-00021b40: 7475 706c 6528 636f 6d70 7265 7373 2866  tuple(compress(f
-00021b50: 775f 666c 6174 5f73 6176 6564 5f66 6f72  w_flat_saved_for
-00021b60: 5f62 6163 6b77 6172 642c 2075 7365 645f  _backward, used_
-00021b70: 6d61 736b 2929 0a20 2020 206f 6e6c 795f  mask)).    only_
-00021b80: 7573 6564 5f62 775f 7361 7665 645f 666f  used_bw_saved_fo
-00021b90: 725f 6261 636b 7761 7264 203d 2074 7570  r_backward = tup
-00021ba0: 6c65 2863 6f6d 7072 6573 7328 6277 5f66  le(compress(bw_f
-00021bb0: 6c61 745f 7361 7665 645f 666f 725f 6261  lat_saved_for_ba
-00021bc0: 636b 7761 7264 2c20 7573 6564 5f6d 6173  ckward, used_mas
-00021bd0: 6b29 290a 0a20 2020 2023 2057 6520 6e65  k))..    # We ne
-00021be0: 6564 2074 6f20 7570 6461 7465 2074 6865  ed to update the
-00021bf0: 2074 7261 6365 7320 7769 7468 2074 6865   traces with the
-00021c00: 206e 6577 2073 6176 6564 5f66 6f72 5f62   new saved_for_b
-00021c10: 6163 6b77 6172 640a 2020 2020 5f75 7064  ackward.    _upd
-00021c20: 6174 655f 666f 7277 6172 645f 7769 7468  ate_forward_with
-00021c30: 5f6e 6577 5f73 6176 6564 5f66 6f72 5f62  _new_saved_for_b
-00021c40: 6163 6b77 6172 6428 666f 7277 6172 645f  ackward(forward_
-00021c50: 7472 6163 652c 206f 6e6c 795f 7573 6564  trace, only_used
-00021c60: 5f66 775f 7361 7665 645f 666f 725f 6261  _fw_saved_for_ba
-00021c70: 636b 7761 7264 290a 2020 2020 5f75 7064  ckward).    _upd
-00021c80: 6174 655f 6261 636b 7761 7264 5f77 6974  ate_backward_wit
-00021c90: 685f 6e65 775f 7361 7665 645f 666f 725f  h_new_saved_for_
-00021ca0: 6261 636b 7761 7264 2862 6163 6b77 6172  backward(backwar
-00021cb0: 645f 7472 6163 652c 206f 6e6c 795f 7573  d_trace, only_us
-00021cc0: 6564 5f62 775f 7361 7665 645f 666f 725f  ed_bw_saved_for_
-00021cd0: 6261 636b 7761 7264 290a 2020 2020 666f  backward).    fo
-00021ce0: 7277 6172 645f 7472 6163 652e 7365 745f  rward_trace.set_
-00021cf0: 7072 6f76 656e 616e 6365 2854 7261 6365  provenance(Trace
-00021d00: 5072 6f76 656e 616e 6365 2822 4175 676d  Provenance("Augm
-00021d10: 656e 7465 6420 666f 7277 6172 6420 7061  ented forward pa
-00021d20: 7373 2229 290a 2020 2020 6261 636b 7761  ss")).    backwa
-00021d30: 7264 5f74 7261 6365 2e73 6574 5f70 726f  rd_trace.set_pro
-00021d40: 7665 6e61 6e63 6528 5472 6163 6550 726f  venance(TracePro
-00021d50: 7665 6e61 6e63 6528 2242 6163 6b77 6172  venance("Backwar
-00021d60: 6420 7061 7373 2229 290a 2020 2020 7265  d pass")).    re
-00021d70: 7475 726e 2046 6f72 7761 7264 4261 636b  turn ForwardBack
-00021d80: 7761 7264 5472 6163 6573 2866 6f72 7761  wardTraces(forwa
-00021d90: 7264 5f74 7261 6365 2c20 6261 636b 7761  rd_trace, backwa
-00021da0: 7264 5f74 7261 6365 290a 0a0a 2320 646f  rd_trace)...# do
-00021db0: 2077 6520 6861 7070 656e 2074 6f20 7761   we happen to wa
-00021dc0: 6e74 2074 6f20 7265 6769 7374 6572 2060  nt to register `
-00021dd0: 6c74 6f72 6368 6020 6f70 7320 7375 6368  ltorch` ops such
-00021de0: 2061 7320 606c 746f 7263 682e 6c61 7965   as `ltorch.laye
-00021df0: 725f 6e6f 726d 6020 6173 2077 656c 6c3f  r_norm` as well?
-00021e00: 0a61 7574 6f63 6173 745f 696d 706c 733a  .autocast_impls:
-00021e10: 2064 6963 745b 7072 696d 732e 5072 696d   dict[prims.Prim
-00021e20: 4944 732c 2043 616c 6c61 626c 655d 203d  IDs, Callable] =
-00021e30: 207b 7d0a 0a0a 6465 6620 7265 6769 7374   {}...def regist
-00021e40: 6572 5f61 7574 6f63 6173 745f 7275 6c65  er_autocast_rule
-00021e50: 286f 7029 3a0a 2020 2020 6465 6620 6465  (op):.    def de
-00021e60: 636f 7261 746f 7228 6675 6e63 293a 0a20  corator(func):. 
-00021e70: 2020 2020 2020 2061 7574 6f63 6173 745f         autocast_
-00021e80: 696d 706c 735b 6f70 5d20 3d20 6675 6e63  impls[op] = func
-00021e90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00021ea0: 6675 6e63 0a0a 2020 2020 7265 7475 726e  func..    return
-00021eb0: 2064 6563 6f72 6174 6f72 0a0a 0a64 6566   decorator...def
-00021ec0: 206d 6179 6265 5f64 6f77 6e63 6173 745f   maybe_downcast_
-00021ed0: 746f 2864 7479 7065 2c20 6172 6773 293a  to(dtype, args):
-00021ee0: 0a20 2020 2061 6c6c 6f77 6564 5f64 6f77  .    allowed_dow
-00021ef0: 6e63 6173 745f 7479 7065 7320 3d20 2864  ncast_types = (d
-00021f00: 7479 7065 732e 666c 6f61 7431 362c 2064  types.float16, d
-00021f10: 7479 7065 732e 6266 6c6f 6174 3136 2c20  types.bfloat16, 
-00021f20: 6474 7970 6573 2e66 6c6f 6174 3332 290a  dtypes.float32).
-00021f30: 0a20 2020 2064 6566 206d 6170 5f66 6e28  .    def map_fn(
-00021f40: 6129 3a0a 2020 2020 2020 2020 6966 2069  a):.        if i
-00021f50: 7369 6e73 7461 6e63 6528 612c 2054 656e  sinstance(a, Ten
-00021f60: 736f 7250 726f 7879 2920 616e 6420 612e  sorProxy) and a.
-00021f70: 6474 7970 6520 696e 2061 6c6c 6f77 6564  dtype in allowed
-00021f80: 5f64 6f77 6e63 6173 745f 7479 7065 733a  _downcast_types:
-00021f90: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00021fa0: 7572 6e20 6d61 7962 655f 636f 6e76 6572  urn maybe_conver
-00021fb0: 745f 746f 5f64 7479 7065 2861 2c20 6474  t_to_dtype(a, dt
-00021fc0: 7970 6529 0a20 2020 2020 2020 2072 6574  ype).        ret
-00021fd0: 7572 6e20 610a 0a20 2020 2072 6574 7572  urn a..    retur
-00021fe0: 6e20 7472 6565 5f6d 6170 286d 6170 5f66  n tree_map(map_f
-00021ff0: 6e2c 2061 7267 7329 0a0a 0a40 7265 6769  n, args)...@regi
-00022000: 7374 6572 5f61 7574 6f63 6173 745f 7275  ster_autocast_ru
-00022010: 6c65 2822 746f 7263 682e 6d61 746d 756c  le("torch.matmul
-00022020: 2229 0a40 7265 6769 7374 6572 5f61 7574  ").@register_aut
-00022030: 6f63 6173 745f 7275 6c65 2870 7269 6d73  ocast_rule(prims
-00022040: 2e50 7269 6d49 4473 2e4d 4154 4d55 4c29  .PrimIDs.MATMUL)
-00022050: 0a64 6566 2061 7574 6f63 6173 745f 6d61  .def autocast_ma
-00022060: 746d 756c 5f72 756c 6528 612c 2062 2c20  tmul_rule(a, b, 
-00022070: 6474 7970 6529 3a0a 2020 2020 2222 2241  dtype):.    """A
-00022080: 7574 6f63 6173 7420 7275 6c65 2066 6f72  utocast rule for
-00022090: 206d 6174 6d75 6c22 2222 0a20 2020 2072   matmul""".    r
-000220a0: 6574 7572 6e20 7072 696d 732e 6d61 746d  eturn prims.matm
-000220b0: 756c 282a 286d 6179 6265 5f64 6f77 6e63  ul(*(maybe_downc
-000220c0: 6173 745f 746f 2864 7479 7065 2c20 2861  ast_to(dtype, (a
-000220d0: 2c20 6229 2929 290a 0a0a 4072 6567 6973  , b))))...@regis
-000220e0: 7465 725f 6175 746f 6361 7374 5f72 756c  ter_autocast_rul
-000220f0: 6528 2274 6f72 6368 2e6e 6e2e 6675 6e63  e("torch.nn.func
-00022100: 7469 6f6e 616c 2e6c 696e 6561 7222 290a  tional.linear").
-00022110: 4072 6567 6973 7465 725f 6175 746f 6361  @register_autoca
-00022120: 7374 5f72 756c 6528 7072 696d 732e 5072  st_rule(prims.Pr
-00022130: 696d 4944 732e 4c49 4e45 4152 290a 6465  imIDs.LINEAR).de
-00022140: 6620 6175 746f 6361 7374 5f6c 696e 6561  f autocast_linea
-00022150: 725f 7275 6c65 2861 2c20 772c 2062 6961  r_rule(a, w, bia
-00022160: 732c 2064 7479 7065 293a 0a20 2020 2069  s, dtype):.    i
-00022170: 6620 6269 6173 2069 7320 4e6f 6e65 3a0a  f bias is None:.
-00022180: 2020 2020 2020 2020 2320 446f 6e27 7420          # Don't 
-00022190: 7061 7373 2060 6269 6173 6020 746f 206d  pass `bias` to m
-000221a0: 6179 6265 5f64 6f77 6e63 6173 745f 746f  aybe_downcast_to
-000221b0: 2e0a 2020 2020 2020 2020 646f 776e 6361  ..        downca
-000221c0: 7374 5f61 7267 7320 3d20 6d61 7962 655f  st_args = maybe_
-000221d0: 646f 776e 6361 7374 5f74 6f28 6474 7970  downcast_to(dtyp
-000221e0: 652c 2028 612c 2077 2929 202b 2028 6269  e, (a, w)) + (bi
-000221f0: 6173 2c29 0a20 2020 2065 6c73 653a 0a20  as,).    else:. 
-00022200: 2020 2020 2020 2064 6f77 6e63 6173 745f         downcast_
-00022210: 6172 6773 203d 206d 6179 6265 5f64 6f77  args = maybe_dow
-00022220: 6e63 6173 745f 746f 2864 7479 7065 2c20  ncast_to(dtype, 
-00022230: 2861 2c20 772c 2062 6961 7329 290a 0a20  (a, w, bias)).. 
-00022240: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
-00022250: 6c69 6e65 6172 282a 646f 776e 6361 7374  linear(*downcast
-00022260: 5f61 7267 7329 0a0a 0a40 7265 6769 7374  _args)...@regist
-00022270: 6572 5f61 7574 6f63 6173 745f 7275 6c65  er_autocast_rule
-00022280: 2822 746f 7263 682e 6e6e 2e66 756e 6374  ("torch.nn.funct
-00022290: 696f 6e61 6c2e 7363 616c 6564 5f64 6f74  ional.scaled_dot
-000222a0: 5f70 726f 6475 6374 5f61 7474 656e 7469  _product_attenti
-000222b0: 6f6e 2229 0a64 6566 2061 7574 6f63 6173  on").def autocas
-000222c0: 745f 7363 616c 6564 5f64 6f74 5f70 726f  t_scaled_dot_pro
-000222d0: 6475 6374 5f61 7474 656e 7469 6f6e 280a  duct_attention(.
-000222e0: 2020 2020 7175 6572 792c 0a20 2020 206b      query,.    k
-000222f0: 6579 2c0a 2020 2020 7661 6c75 652c 0a20  ey,.    value,. 
-00022300: 2020 2061 7474 6e5f 6d61 736b 2c0a 2020     attn_mask,.  
-00022310: 2020 6472 6f70 6f75 745f 702c 0a20 2020    dropout_p,.   
-00022320: 2069 735f 6361 7573 616c 2c0a 2020 2020   is_causal,.    
-00022330: 2a2c 0a20 2020 2064 7479 7065 2c0a 2020  *,.    dtype,.  
-00022340: 2020 7363 616c 652c 0a29 3a0a 2020 2020    scale,.):.    
-00022350: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
-00022360: 6368 2069 6d70 6f72 7420 7363 616c 6564  ch import scaled
-00022370: 5f64 6f74 5f70 726f 6475 6374 5f61 7474  _dot_product_att
-00022380: 656e 7469 6f6e 0a0a 2020 2020 712c 206b  ention..    q, k
-00022390: 2c20 7620 3d20 6d61 7962 655f 646f 776e  , v = maybe_down
-000223a0: 6361 7374 5f74 6f28 6474 7970 652c 2028  cast_to(dtype, (
-000223b0: 7175 6572 792c 206b 6579 2c20 7661 6c75  query, key, valu
-000223c0: 6529 290a 2020 2020 7265 7475 726e 2073  e)).    return s
-000223d0: 6361 6c65 645f 646f 745f 7072 6f64 7563  caled_dot_produc
-000223e0: 745f 6174 7465 6e74 696f 6e28 712c 206b  t_attention(q, k
-000223f0: 2c20 762c 2061 7474 6e5f 6d61 736b 2c20  , v, attn_mask, 
-00022400: 6472 6f70 6f75 745f 702c 2069 735f 6361  dropout_p, is_ca
-00022410: 7573 616c 2c20 7363 616c 653d 7363 616c  usal, scale=scal
-00022420: 6529 0a0a 0a64 6566 2061 7574 6f63 6173  e)...def autocas
-00022430: 745f 7379 6d62 6f6c 5f6d 6170 7065 7228  t_symbol_mapper(
-00022440: 626f 756e 645f 7379 6d62 6f6c 3a20 426f  bound_symbol: Bo
-00022450: 756e 6453 796d 626f 6c49 6e74 6572 6661  undSymbolInterfa
-00022460: 6365 2c20 6474 7970 653a 2064 7479 7065  ce, dtype: dtype
-00022470: 732e 6474 7970 6529 3a0a 2020 2020 2222  s.dtype):.    ""
-00022480: 2252 6574 7572 6e20 7468 6520 6361 6c6c  "Return the call
-00022490: 6162 6c65 2069 6d70 6c65 6d65 6e74 696e  able implementin
-000224a0: 6720 7468 6520 6175 746f 6361 7374 2072  g the autocast r
-000224b0: 756c 6520 666f 7220 7468 6520 7379 6d62  ule for the symb
-000224c0: 6f6c 2e0a 0a20 2020 2041 7267 733a 0a20  ol...    Args:. 
-000224d0: 2020 2020 2020 2062 6f75 6e64 5f73 796d         bound_sym
-000224e0: 626f 6c3a 204d 6170 7065 6420 746f 2069  bol: Mapped to i
-000224f0: 7473 2061 7574 6f63 6173 7420 7275 6c65  ts autocast rule
-00022500: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-00022510: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
-00022520: 3a20 5468 6520 6361 6c6c 6162 6c65 2069  : The callable i
-00022530: 6d70 6c65 6d65 6e74 696e 6720 7468 6520  mplementing the 
-00022540: 6175 746f 6361 7374 2072 756c 6520 666f  autocast rule fo
-00022550: 7220 7468 6520 7379 6d62 6f6c 2e0a 2020  r the symbol..  
-00022560: 2020 2222 220a 2020 2020 6175 746f 6361    """.    autoca
-00022570: 7374 5f69 6d70 6c3a 2043 616c 6c61 626c  st_impl: Callabl
-00022580: 6520 7c20 4e6f 6e65 203d 2061 7574 6f63  e | None = autoc
-00022590: 6173 745f 696d 706c 732e 6765 7428 626f  ast_impls.get(bo
-000225a0: 756e 645f 7379 6d62 6f6c 2e73 796d 2e69  und_symbol.sym.i
-000225b0: 6429 0a20 2020 2072 6574 7572 6e20 626f  d).    return bo
-000225c0: 756e 645f 7379 6d62 6f6c 2e73 796d 2069  und_symbol.sym i
-000225d0: 6620 6175 746f 6361 7374 5f69 6d70 6c20  f autocast_impl 
-000225e0: 6973 204e 6f6e 6520 656c 7365 2070 6172  is None else par
-000225f0: 7469 616c 2861 7574 6f63 6173 745f 696d  tial(autocast_im
-00022600: 706c 2c20 6474 7970 653d 6474 7970 6529  pl, dtype=dtype)
-00022610: 0a0a 0a64 6566 2061 7574 6f63 6173 7428  ...def autocast(
-00022620: 6675 6e63 3a20 4361 6c6c 6162 6c65 2c20  func: Callable, 
-00022630: 6474 7970 653a 2064 7479 7065 732e 6474  dtype: dtypes.dt
-00022640: 7970 6529 3a0a 2020 2020 2222 2254 7261  ype):.    """Tra
-00022650: 6e73 666f 726d 7320 6120 6675 6e63 7469  nsforms a functi
-00022660: 6f6e 2074 6f20 6175 746f 6361 7374 2063  on to autocast c
-00022670: 6572 7461 696e 206f 7065 7261 7469 6f6e  ertain operation
-00022680: 732e 0a0a 2020 2020 4172 6773 3a0a 2020  s...    Args:.  
-00022690: 2020 2020 2020 6675 6e63 3a20 5468 6520        func: The 
-000226a0: 6675 6e63 7469 6f6e 2074 6f20 6265 2074  function to be t
-000226b0: 7261 6e73 666f 726d 6564 2e0a 2020 2020  ransformed..    
-000226c0: 2020 2020 6474 7970 653a 2054 6865 2064      dtype: The d
-000226d0: 6174 6120 7479 7065 2074 6f20 7768 6963  ata type to whic
-000226e0: 6820 6172 6775 6d65 6e74 7320 6f66 2074  h arguments of t
-000226f0: 6865 2066 756e 6374 696f 6e20 6f72 2073  he function or s
-00022700: 7562 2066 756e 6374 696f 6e73 2063 6f75  ub functions cou
-00022710: 6c64 2067 6574 2063 6173 7420 6966 0a20  ld get cast if. 
-00022720: 2020 2020 2020 2020 2020 2074 6865 7920             they 
-00022730: 6172 6520 6064 7479 7065 732e 666c 6f61  are `dtypes.floa
-00022740: 7433 3260 2e0a 0a20 2020 2052 6574 7572  t32`...    Retur
-00022750: 6e73 3a0a 2020 2020 2020 2020 4361 6c6c  ns:.        Call
-00022760: 6162 6c65 3a20 5468 6520 7472 616e 7366  able: The transf
-00022770: 6f72 6d65 6420 6675 6e63 7469 6f6e 0a20  ormed function. 
-00022780: 2020 2022 2222 0a0a 2020 2020 6966 206e     """..    if n
-00022790: 6f74 2069 7369 6e73 7461 6e63 6528 6474  ot isinstance(dt
-000227a0: 7970 652c 2064 7479 7065 732e 6474 7970  ype, dtypes.dtyp
-000227b0: 6529 3a0a 2020 2020 2020 2020 7261 6973  e):.        rais
-000227c0: 6520 5661 6c75 6545 7272 6f72 2866 2260  e ValueError(f"`
-000227d0: 6474 7970 6560 2069 7320 6578 7065 6374  dtype` is expect
-000227e0: 6564 2074 6f20 6265 2060 7468 756e 6465  ed to be `thunde
-000227f0: 722e 6474 7970 652e 6474 7970 6560 2062  r.dtype.dtype` b
-00022800: 7574 207b 7479 7065 2864 7479 7065 297d  ut {type(dtype)}
-00022810: 2229 0a20 2020 2069 6620 6474 7970 6520  ").    if dtype 
-00022820: 6e6f 7420 696e 207b 6474 7970 6573 2e66  not in {dtypes.f
-00022830: 6c6f 6174 3136 2c20 6474 7970 6573 2e62  loat16, dtypes.b
-00022840: 666c 6f61 7431 367d 3a0a 2020 2020 2020  float16}:.      
-00022850: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00022860: 6f72 2866 2260 6474 7970 6560 2069 7320  or(f"`dtype` is 
-00022870: 6578 7065 6374 6564 2074 6f20 6265 2065  expected to be e
-00022880: 6974 6865 7220 6074 6875 6e64 6572 2e66  ither `thunder.f
-00022890: 6c6f 6174 3136 6020 6f72 2060 7468 756e  loat16` or `thun
-000228a0: 6465 722e 6266 6c6f 6174 3136 602c 2062  der.bfloat16`, b
-000228b0: 7574 207b 6474 7970 657d 2229 0a0a 2020  ut {dtype}")..  
-000228c0: 2020 4077 7261 7073 2866 756e 6329 0a20    @wraps(func). 
-000228d0: 2020 2064 6566 2077 7261 7070 6572 282a     def wrapper(*
-000228e0: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-000228f0: 0a20 2020 2020 2020 2074 7261 6365 203d  .        trace =
-00022900: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
-00022910: 2829 2866 756e 632c 202a 6172 6773 2c20  ()(func, *args, 
-00022920: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
-00022930: 2020 7265 7475 726e 2065 7661 6c5f 7472    return eval_tr
-00022940: 6163 6528 7472 6163 652c 202a 6172 6773  ace(trace, *args
-00022950: 2c20 2a2a 6b77 6172 6773 2c20 7379 6d62  , **kwargs, symb
-00022960: 6f6c 5f6d 6170 7065 723d 7061 7274 6961  ol_mapper=partia
-00022970: 6c28 6175 746f 6361 7374 5f73 796d 626f  l(autocast_symbo
-00022980: 6c5f 6d61 7070 6572 2c20 6474 7970 653d  l_mapper, dtype=
-00022990: 6474 7970 6529 290a 0a20 2020 2072 6574  dtype))..    ret
-000229a0: 7572 6e20 7772 6170 7065 720a            urn wrapper.
+0000ae80: 206c 616d 6264 613a 2066 2243 6f6d 706c   lambda: f"Compl
+0000ae90: 6578 2067 7261 6420 6973 206e 6f74 2073  ex grad is not s
+0000aea0: 7570 706f 7274 6564 2079 6574 222c 0a20  upported yet",. 
+0000aeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aec0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0000aed0: 2020 2020 2020 2020 2020 7670 7269 6d61            vprima
+0000aee0: 6c3a 2056 6172 6961 626c 6520 3d20 7661  l: Variable = va
+0000aef0: 7269 6162 6c65 6966 7928 7072 696d 616c  riableify(primal
+0000af00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000af10: 2020 2020 2020 6163 6375 6d3a 204e 6f6e        accum: Non
+0000af20: 6520 7c20 5465 6e73 6f72 5072 6f78 7920  e | TensorProxy 
+0000af30: 3d20 7072 696d 616c 735f 746f 5f67 696e  = primals_to_gin
+0000af40: 7075 745f 6d61 702e 6765 7428 7670 7269  put_map.get(vpri
+0000af50: 6d61 6c2c 204e 6f6e 6529 0a0a 2020 2020  mal, None)..    
+0000af60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af70: 6966 2061 6363 756d 2069 7320 4e6f 6e65  if accum is None
+0000af80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000af90: 2020 2020 2020 2020 2020 7072 696d 616c            primal
+0000afa0: 735f 746f 5f67 696e 7075 745f 6d61 705b  s_to_ginput_map[
+0000afb0: 7670 7269 6d61 6c5d 203d 2067 7261 640a  vprimal] = grad.
+0000afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000afd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aff0: 2020 6163 6375 6d20 3d20 6163 6375 6d20    accum = accum 
+0000b000: 2b20 6772 6164 0a20 2020 2020 2020 2020  + grad.         
+0000b010: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000b020: 7269 6d61 6c73 5f74 6f5f 6769 6e70 7574  rimals_to_ginput
+0000b030: 5f6d 6170 5b76 7072 696d 616c 5d20 3d20  _map[vprimal] = 
+0000b040: 6163 6375 6d0a 0a20 2020 2020 2020 2020  accum..         
+0000b050: 2020 2023 2048 616e 646c 6573 2067 6574     # Handles get
+0000b060: 5f67 7261 6420 6f70 6572 6174 696f 6e73  _grad operations
+0000b070: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000b080: 5265 7365 7473 2074 6865 2073 7761 706d  Resets the swapm
+0000b090: 6170 2066 6f72 2067 7261 6473 0a20 2020  ap for grads.   
+0000b0a0: 2020 2020 2020 2020 2073 7761 706d 6170           swapmap
+0000b0b0: 3a20 6469 6374 5b56 6172 6961 626c 652c  : dict[Variable,
+0000b0c0: 2050 726f 7879 5d20 3d20 7b7d 0a0a 2020   Proxy] = {}..  
+0000b0d0: 2020 2020 2020 2020 2020 666f 7220 6273            for bs
+0000b0e0: 796d 2069 6e20 6772 6164 7472 632e 626f  ym in gradtrc.bo
+0000b0f0: 756e 645f 7379 6d62 6f6c 733a 0a20 2020  und_symbols:.   
+0000b100: 2020 2020 2020 2020 2020 2020 2069 643a               id:
+0000b110: 2048 6173 6861 626c 6520 3d20 6273 796d   Hashable = bsym
+0000b120: 2e73 796d 2e69 640a 2020 2020 2020 2020  .sym.id.        
+0000b130: 2020 2020 2020 2020 6966 2069 6420 6973          if id is
+0000b140: 2070 6964 732e 4745 545f 4752 4144 3a0a   pids.GET_GRAD:.
+0000b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b160: 2020 2020 7072 696d 616c 3a20 4e75 6d62      primal: Numb
+0000b170: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+0000b180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b190: 2020 2020 2028 7072 696d 616c 2c29 203d       (primal,) =
+0000b1a0: 2062 7379 6d2e 666c 6174 5f61 7267 730a   bsym.flat_args.
+0000b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b1c0: 2020 2020 6772 6164 3a20 4e75 6d62 6572      grad: Number
+0000b1d0: 207c 2054 656e 736f 7250 726f 7879 203d   | TensorProxy =
+0000b1e0: 2062 7379 6d2e 6f75 7470 7574 0a0a 2020   bsym.output..  
+0000b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b200: 2020 7670 7269 6d61 6c3a 2056 6172 6961    vprimal: Varia
+0000b210: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
+0000b220: 2020 2020 2020 2020 7667 7261 643a 2056          vgrad: V
+0000b230: 6172 6961 626c 650a 2020 2020 2020 2020  ariable.        
+0000b240: 2020 2020 2020 2020 2020 2020 7670 7269              vpri
+0000b250: 6d61 6c2c 2076 6772 6164 203d 2076 6172  mal, vgrad = var
+0000b260: 6961 626c 6569 6679 2870 7269 6d61 6c29  iableify(primal)
+0000b270: 2c20 7661 7269 6162 6c65 6966 7928 6772  , variableify(gr
+0000b280: 6164 290a 0a20 2020 2020 2020 2020 2020  ad)..           
+0000b290: 2020 2020 2020 2020 2061 6374 7561 6c5f           actual_
+0000b2a0: 6772 6164 3a20 4e6f 6e65 207c 2054 656e  grad: None | Ten
+0000b2b0: 736f 7250 726f 7879 203d 2070 7269 6d61  sorProxy = prima
+0000b2c0: 6c73 5f74 6f5f 6769 6e70 7574 5f6d 6170  ls_to_ginput_map
+0000b2d0: 2e67 6574 2876 7072 696d 616c 2c20 4e6f  .get(vprimal, No
+0000b2e0: 6e65 290a 0a20 2020 2020 2020 2020 2020  ne)..           
+0000b2f0: 2020 2020 2020 2020 2023 204e 4f54 4520           # NOTE 
+0000b300: 4966 2061 6374 7561 6c5f 6772 6164 2069  If actual_grad i
+0000b310: 7320 4e6f 6e65 2074 6865 6e20 7468 6572  s None then ther
+0000b320: 6527 7320 6120 6765 745f 6772 6164 2829  e's a get_grad()
+0000b330: 2072 6571 7565 7374 2066 6f72 2061 2074   request for a t
+0000b340: 656e 736f 7220 7768 6963 680a 2020 2020  ensor which.    
+0000b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b360: 2320 2020 6861 7320 6e6f 2070 7574 5f67  #   has no put_g
+0000b370: 7261 6428 292c 2073 6f20 7765 2072 6574  rad(), so we ret
+0000b380: 7572 6e20 7a65 726f 7320 666f 7220 7468  urn zeros for th
+0000b390: 6520 6772 6164 0a20 2020 2020 2020 2020  e grad.         
+0000b3a0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+0000b3b0: 4f20 5265 7669 7369 7420 7468 6973 202d  O Revisit this -
+0000b3c0: 2d20 6361 6e20 7765 2072 656d 6f76 6520  - can we remove 
+0000b3d0: 7468 6573 6520 636f 6d70 7574 6174 696f  these computatio
+0000b3e0: 6e73 2c20 6f72 2075 7365 2061 2073 7065  ns, or use a spe
+0000b3f0: 6369 616c 205a 6572 6f54 656e 736f 720a  cial ZeroTensor.
+0000b400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b410: 2020 2020 2320 2020 746f 2073 696d 706c      #   to simpl
+0000b420: 6966 7920 7468 656d 3f0a 2020 2020 2020  ify them?.      
+0000b430: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000b440: 2061 6374 7561 6c5f 6772 6164 2069 7320   actual_grad is 
+0000b450: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000b460: 2020 2020 2020 2020 2020 2020 2020 6163                ac
+0000b470: 7475 616c 5f67 7261 6420 3d20 6c74 6f72  tual_grad = ltor
+0000b480: 6368 2e7a 6572 6f73 5f6c 696b 6528 7072  ch.zeros_like(pr
+0000b490: 696d 616c 290a 2020 2020 2020 2020 2020  imal).          
+0000b4a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0000b4b0: 696d 616c 735f 746f 5f67 696e 7075 745f  imals_to_ginput_
+0000b4c0: 6d61 705b 7670 7269 6d61 6c5d 203d 2061  map[vprimal] = a
+0000b4d0: 6374 7561 6c5f 6772 6164 0a0a 2020 2020  ctual_grad..    
+0000b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4f0: 2320 5570 6461 7465 7320 7468 6520 6772  # Updates the gr
+0000b500: 6164 2061 6c69 6173 206d 6170 0a20 2020  ad alias map.   
+0000b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b520: 2076 6163 7475 616c 5f67 7261 643a 2056   vactual_grad: V
+0000b530: 6172 6961 626c 6520 3d20 7661 7269 6162  ariable = variab
+0000b540: 6c65 6966 7928 6163 7475 616c 5f67 7261  leify(actual_gra
+0000b550: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
+0000b560: 2020 2020 2020 2069 6620 7661 6374 7561         if vactua
+0000b570: 6c5f 6772 6164 2021 3d20 7667 7261 643a  l_grad != vgrad:
+0000b580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b590: 2020 2020 2020 2020 2073 7761 706d 6170           swapmap
+0000b5a0: 5b76 6772 6164 5d20 3d20 6163 7475 616c  [vgrad] = actual
+0000b5b0: 5f67 7261 640a 0a20 2020 2020 2020 2066  _grad..        f
+0000b5c0: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
+0000b5d0: 2020 2020 2320 5265 7374 6f72 6573 2073      # Restores s
+0000b5e0: 636f 7065 0a20 2020 2020 2020 2020 2020  cope.           
+0000b5f0: 2072 6573 6574 5f74 7261 6365 6374 7828   reset_tracectx(
+0000b600: 7472 6163 6563 7478 5f74 6f6b 290a 0a20  tracectx_tok).. 
+0000b610: 2020 2020 2020 2023 2046 696c 7465 7273         # Filters
+0000b620: 2070 7574 5f67 7261 6420 616e 6420 6765   put_grad and ge
+0000b630: 745f 6772 6164 206f 7065 7261 7469 6f6e  t_grad operation
+0000b640: 7320 616e 6420 6170 706c 6965 7320 7468  s and applies th
+0000b650: 6520 7377 6170 6d61 700a 2020 2020 2020  e swapmap.      
+0000b660: 2020 6465 6620 5f66 696c 7465 7228 6273    def _filter(bs
+0000b670: 796d 3a20 426f 756e 6453 796d 626f 6c29  ym: BoundSymbol)
+0000b680: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+0000b690: 2020 2020 2020 6964 3a20 4861 7368 6162        id: Hashab
+0000b6a0: 6c65 203d 2062 7379 6d2e 7379 6d2e 6964  le = bsym.sym.id
+0000b6b0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000b6c0: 7572 6e20 6964 2069 6e20 2870 6964 732e  urn id in (pids.
+0000b6d0: 5055 545f 4752 4144 2c20 7069 6473 2e47  PUT_GRAD, pids.G
+0000b6e0: 4554 5f47 5241 4429 0a0a 2020 2020 2020  ET_GRAD)..      
+0000b6f0: 2020 6772 6164 7472 632e 626f 756e 645f    gradtrc.bound_
+0000b700: 7379 6d62 6f6c 7320 3d20 5b0a 2020 2020  symbols = [.    
+0000b710: 2020 2020 2020 2020 6273 796d 2e66 726f          bsym.fro
+0000b720: 6d5f 6273 796d 5f73 7761 705f 7072 6f78  m_bsym_swap_prox
+0000b730: 6965 7328 7377 6170 6d61 7029 2066 6f72  ies(swapmap) for
+0000b740: 2062 7379 6d20 696e 2067 7261 6474 7263   bsym in gradtrc
+0000b750: 2e62 6f75 6e64 5f73 796d 626f 6c73 2069  .bound_symbols i
+0000b760: 6620 6e6f 7420 5f66 696c 7465 7228 6273  f not _filter(bs
+0000b770: 796d 290a 2020 2020 2020 2020 5d0a 0a20  ym).        ].. 
+0000b780: 2020 2020 2020 2023 2053 5445 5020 464f         # STEP FO
+0000b790: 5552 202d 2d2d 204f 7264 6572 7320 7468  UR --- Orders th
+0000b7a0: 6520 6f70 6572 6174 696f 6e73 0a20 2020  e operations.   
+0000b7b0: 2020 2020 2023 2054 4f44 4f20 436f 6e73       # TODO Cons
+0000b7c0: 6964 6572 2061 6c74 6572 6e61 7469 7665  ider alternative
+0000b7d0: 2073 6368 6564 756c 696e 6720 616c 676f   scheduling algo
+0000b7e0: 7269 7468 6d73 2c20 6d61 7962 6520 6279  rithms, maybe by
+0000b7f0: 2075 7369 6e67 2067 7261 7068 2066 6561   using graph fea
+0000b800: 7475 7265 730a 2020 2020 2020 2020 2320  tures.        # 
+0000b810: 2020 536f 6d65 2069 6465 6173 2061 7265    Some ideas are
+0000b820: 206c 6f6f 6b69 6e67 2061 7420 6d65 6d6f   looking at memo
+0000b830: 7279 2d73 6176 696e 6720 6e6f 6465 732c  ry-saving nodes,
+0000b840: 2061 6e64 206e 6f64 6573 2077 6974 6820   and nodes with 
+0000b850: 6120 6869 6768 2069 6e2d 6465 6772 6565  a high in-degree
+0000b860: 206f 7220 6869 6768 206f 7574 2d64 6567   or high out-deg
+0000b870: 7265 650a 0a20 2020 2020 2020 2023 2043  ree..        # C
+0000b880: 7265 6174 6573 2061 6e20 696e 6974 6961  reates an initia
+0000b890: 6c20 7661 6c69 6420 6f72 6465 7269 6e67  l valid ordering
+0000b8a0: 2074 6f20 4443 452c 2073 6f20 7468 6174   to DCE, so that
+0000b8b0: 2061 6464 6974 696f 6e61 6c20 6f72 6465   additional orde
+0000b8c0: 7269 6e67 2061 6e61 6c79 7369 7320 646f  ring analysis do
+0000b8d0: 6573 6e27 7420 6e65 6564 2074 6f20 636f  esn't need to co
+0000b8e0: 6e73 6964 6572 2061 6c6c 2073 796d 626f  nsider all symbo
+0000b8f0: 6c73 0a20 2020 2020 2020 2072 6f6f 7473  ls.        roots
+0000b900: 2c20 6c65 6176 6573 203d 2062 7379 6d5f  , leaves = bsym_
+0000b910: 6c69 7374 5f74 6f5f 6461 6728 6772 6164  list_to_dag(grad
+0000b920: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
+0000b930: 7329 0a20 2020 2020 2020 206f 7264 6572  s).        order
+0000b940: 6564 5f62 7379 6d73 203d 2074 6f70 6f73  ed_bsyms = topos
+0000b950: 6f72 745f 6273 796d 5f64 6167 2872 6f6f  ort_bsym_dag(roo
+0000b960: 7473 2c20 544f 504f 534f 5254 5f4f 5244  ts, TOPOSORT_ORD
+0000b970: 4552 2e54 4f50 5f44 4f57 4e29 0a20 2020  ER.TOP_DOWN).   
+0000b980: 2020 2020 2067 7261 6474 7263 2e62 6f75       gradtrc.bou
+0000b990: 6e64 5f73 796d 626f 6c73 203d 206f 7264  nd_symbols = ord
+0000b9a0: 6572 6564 5f62 7379 6d73 0a20 2020 2020  ered_bsyms.     
+0000b9b0: 2020 2067 7261 6474 7263 203d 2064 6365     gradtrc = dce
+0000b9c0: 2867 7261 6474 7263 290a 0a20 2020 2020  (gradtrc)..     
+0000b9d0: 2020 2023 2049 6465 6e74 6966 6965 7320     # Identifies 
+0000b9e0: 7468 6520 6f72 6465 7220 6f66 2042 6f75  the order of Bou
+0000b9f0: 6e64 5379 6d62 6f6c 7320 7573 696e 6720  ndSymbols using 
+0000ba00: 6120 2244 4653 2061 6e64 2063 6861 696e  a "DFS and chain
+0000ba10: 2220 616c 676f 7269 7468 6d0a 2020 2020  " algorithm.    
+0000ba20: 2020 2020 2320 544f 444f 2045 6c61 626f      # TODO Elabo
+0000ba30: 7261 7465 206f 6e20 7468 6973 2061 6c67  rate on this alg
+0000ba40: 6f72 6974 686d 2061 6e64 2074 6865 2069  orithm and the i
+0000ba50: 6d70 6c65 6d65 6e74 6174 696f 6e0a 2020  mplementation.  
+0000ba60: 2020 2020 2020 726f 6f74 732c 206c 6561        roots, lea
+0000ba70: 7665 7320 3d20 6273 796d 5f6c 6973 745f  ves = bsym_list_
+0000ba80: 746f 5f64 6167 2867 7261 6474 7263 2e62  to_dag(gradtrc.b
+0000ba90: 6f75 6e64 5f73 796d 626f 6c73 290a 2020  ound_symbols).  
+0000baa0: 2020 2020 2020 6368 6563 6b28 0a20 2020        check(.   
+0000bab0: 2020 2020 2020 2020 206c 656e 286c 6561           len(lea
+0000bac0: 7665 7329 203d 3d20 312c 0a20 2020 2020  ves) == 1,.     
+0000bad0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
+0000bae0: 2245 7870 6563 7465 6420 6f6e 6c79 206f  "Expected only o
+0000baf0: 6e65 206c 6561 6620 6e6f 6465 2077 6865  ne leaf node whe
+0000bb00: 6e20 736f 7274 696e 6720 666f 7220 6772  n sorting for gr
+0000bb10: 6164 2c20 666f 756e 6420 7468 6572 6520  ad, found there 
+0000bb20: 7765 7265 207b 6c65 6e28 6c65 6176 6573  were {len(leaves
+0000bb30: 297d 206c 6561 7665 7322 2c0a 2020 2020  )} leaves",.    
+0000bb40: 2020 2020 290a 2020 2020 2020 2020 286c      ).        (l
+0000bb50: 6561 662c 2920 3d20 6c65 6176 6573 0a0a  eaf,) = leaves..
+0000bb60: 2020 2020 2020 2020 2320 436f 6d70 7574          # Comput
+0000bb70: 6573 2074 6865 2074 656e 736f 7220 6d65  es the tensor me
+0000bb80: 6d6f 7279 2075 7365 6420 6279 2074 6865  mory used by the
+0000bb90: 2067 6976 656e 2070 7974 7265 650a 2020   given pytree.  
+0000bba0: 2020 2020 2020 6465 6620 6d65 6d6f 7279        def memory
+0000bbb0: 5f75 7365 6428 7079 7472 6565 2920 2d3e  _used(pytree) ->
+0000bbc0: 2069 6e74 3a0a 2020 2020 2020 2020 2020   int:.          
+0000bbd0: 2020 6d65 6d6f 7279 5f75 7365 3a20 696e    memory_use: in
+0000bbe0: 7420 3d20 300a 0a20 2020 2020 2020 2020  t = 0..         
+0000bbf0: 2020 2064 6566 2063 6f75 6e74 5f6d 656d     def count_mem
+0000bc00: 6f72 795f 7573 6528 7829 3a0a 2020 2020  ory_use(x):.    
+0000bc10: 2020 2020 2020 2020 2020 2020 6e6f 6e6c              nonl
+0000bc20: 6f63 616c 206d 656d 6f72 795f 7573 650a  ocal memory_use.
+0000bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc40: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+0000bc50: 2054 656e 736f 7250 726f 7879 293a 0a20   TensorProxy):. 
+0000bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc70: 2020 206d 656d 6f72 795f 7573 6520 2b3d     memory_use +=
+0000bc80: 2078 2e64 7479 7065 2e5f 6279 7465 7320   x.dtype._bytes 
+0000bc90: 2a20 782e 6e75 6d65 6c0a 0a20 2020 2020  * x.numel..     
+0000bca0: 2020 2020 2020 2074 7265 655f 6d61 7028         tree_map(
+0000bcb0: 636f 756e 745f 6d65 6d6f 7279 5f75 7365  count_memory_use
+0000bcc0: 2c20 7079 7472 6565 290a 2020 2020 2020  , pytree).      
+0000bcd0: 2020 2020 2020 7265 7475 726e 206d 656d        return mem
+0000bce0: 6f72 795f 7573 650a 0a20 2020 2020 2020  ory_use..       
+0000bcf0: 2023 2054 7275 6520 7768 656e 2061 206e   # True when a n
+0000bd00: 6f64 6520 6973 2061 2022 6c69 6e6b 2220  ode is a "link" 
+0000bd10: 2d2d 2061 206e 6f64 6520 7769 7468 206f  -- a node with o
+0000bd20: 6e6c 7920 6f6e 6520 6368 696c 6420 616e  nly one child an
+0000bd30: 6420 6174 206d 6f73 7420 6f6e 6520 7061  d at most one pa
+0000bd40: 7265 6e74 0a20 2020 2020 2020 2023 2020  rent.        #  
+0000bd50: 2043 6f6e 6365 7074 7561 6c6c 7920 7468   Conceptually th
+0000bd60: 6520 6e6f 6465 2069 7320 6120 226c 696e  e node is a "lin
+0000bd70: 6b22 2069 6e20 6120 6368 6169 6e20 6f66  k" in a chain of
+0000bd80: 206e 6f64 6573 206c 696b 6520 4120 2d3e   nodes like A ->
+0000bd90: 2042 202d 3e20 430a 2020 2020 2020 2020   B -> C.        
+0000bda0: 6465 6620 6973 5f6c 696e 6b28 6e3a 204e  def is_link(n: N
+0000bdb0: 6f64 6529 202d 3e20 626f 6f6c 3a0a 2020  ode) -> bool:.  
+0000bdc0: 2020 2020 2020 2020 2020 5f69 735f 6c69            _is_li
+0000bdd0: 6e6b 203d 206c 656e 286e 2e63 6869 6c64  nk = len(n.child
+0000bde0: 7265 6e29 203d 3d20 3120 616e 6420 6c65  ren) == 1 and le
+0000bdf0: 6e28 6e2e 7061 7265 6e74 7329 203c 3d20  n(n.parents) <= 
+0000be00: 310a 2020 2020 2020 2020 2020 2020 7265  1.            re
+0000be10: 7475 726e 205f 6973 5f6c 696e 6b0a 0a20  turn _is_link.. 
+0000be20: 2020 2020 2020 2063 6f75 6e74 6572 3a20         counter: 
+0000be30: 696e 7420 3d20 300a 0a20 2020 2020 2020  int = 0..       
+0000be40: 2064 6566 205f 6368 6169 6e28 633a 206c   def _chain(c: l
+0000be50: 6973 745b 4e6f 6465 5d2c 2065 6e64 3a20  ist[Node], end: 
+0000be60: 4e6f 6465 2920 2d3e 206c 6973 745b 4e6f  Node) -> list[No
+0000be70: 6465 5d3a 0a20 2020 2020 2020 2020 2020  de]:.           
+0000be80: 206e 6f6e 6c6f 6361 6c20 636f 756e 7465   nonlocal counte
+0000be90: 720a 0a20 2020 2020 2020 2020 2020 2023  r..            #
+0000bea0: 2054 4f44 4f20 4578 7065 7269 6d65 6e74   TODO Experiment
+0000beb0: 2077 6974 6820 6e6f 7420 616c 7761 7973   with not always
+0000bec0: 2066 7573 696e 6720 7468 6973 2069 6e74   fusing this int
+0000bed0: 6f20 7468 6520 636f 6e73 756d 6572 202d  o the consumer -
+0000bee0: 2d20 7468 6572 6520 636f 756c 6420 6265  - there could be
+0000bef0: 2061 6e0a 2020 2020 2020 2020 2020 2020   an.            
+0000bf00: 2320 2020 696e 7465 7265 7374 696e 6720  #   interesting 
+0000bf10: 6d69 6e63 7574 0a20 2020 2020 2020 2020  mincut.         
+0000bf20: 2020 2023 204e 4f54 4520 496e 2074 6869     # NOTE In thi
+0000bf30: 7320 6361 7365 2074 6865 2063 6861 696e  s case the chain
+0000bf40: 2063 616e 6e6f 7420 6265 2065 7874 656e   cannot be exten
+0000bf50: 6465 642c 2061 6e64 2069 7473 206f 7269  ded, and its ori
+0000bf60: 6769 6e20 6973 2069 6e70 7574 2074 6f20  gin is input to 
+0000bf70: 7468 6520 6675 6e63 7469 6f6e 0a20 2020  the function.   
+0000bf80: 2020 2020 2020 2020 2023 2020 2073 6f20           #   so 
+0000bf90: 7468 6973 206a 7573 7420 6675 7365 7320  this just fuses 
+0000bfa0: 6974 2069 6e74 6f20 7468 6520 636f 6e73  it into the cons
+0000bfb0: 756d 6572 0a20 2020 2020 2020 2020 2020  umer.           
+0000bfc0: 2069 6620 6c65 6e28 656e 642e 7061 7265   if len(end.pare
+0000bfd0: 6e74 7329 203d 3d20 303a 0a20 2020 2020  nts) == 0:.     
+0000bfe0: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
+0000bff0: 2069 6e20 633a 0a20 2020 2020 2020 2020   in c:.         
+0000c000: 2020 2020 2020 2020 2020 206e 2e6e 756d             n.num
+0000c010: 6265 7220 3d20 636f 756e 7465 720a 2020  ber = counter.  
+0000c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c030: 2020 636f 756e 7465 7220 2b3d 2031 0a20    counter += 1. 
+0000c040: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000c050: 6574 7572 6e20 5b5d 0a0a 2020 2020 2020  eturn []..      
+0000c060: 2020 2020 2020 2320 4e4f 5445 206c 656e        # NOTE len
+0000c070: 2865 6e64 2e70 6172 656e 7473 2920 3d3d  (end.parents) ==
+0000c080: 2031 206f 6e20 7468 6973 2070 6174 680a   1 on this path.
+0000c090: 2020 2020 2020 2020 2020 2020 2870 6172              (par
+0000c0a0: 656e 742c 2920 3d20 656e 642e 7061 7265  ent,) = end.pare
+0000c0b0: 6e74 730a 0a20 2020 2020 2020 2020 2020  nts..           
+0000c0c0: 2023 2045 7874 656e 6473 2074 6865 2063   # Extends the c
+0000c0d0: 6861 696e 2069 6620 7468 6520 7061 7265  hain if the pare
+0000c0e0: 6e74 2069 7320 6120 6c69 6e6b 0a20 2020  nt is a link.   
+0000c0f0: 2020 2020 2020 2020 2069 6620 6973 5f6c           if is_l
+0000c100: 696e 6b28 7061 7265 6e74 293a 0a20 2020  ink(parent):.   
+0000c110: 2020 2020 2020 2020 2020 2020 2063 2e61               c.a
+0000c120: 7070 656e 6428 7061 7265 6e74 290a 2020  ppend(parent).  
+0000c130: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000c140: 7475 726e 205f 6368 6169 6e28 632c 2070  turn _chain(c, p
+0000c150: 6172 656e 7429 0a0a 2020 2020 2020 2020  arent)..        
+0000c160: 2020 2020 2320 4e4f 5445 2049 6e20 7468      # NOTE In th
+0000c170: 6973 2063 6173 6520 7468 6520 6368 6169  is case the chai
+0000c180: 6e20 6861 7320 6120 7061 7265 6e74 2074  n has a parent t
+0000c190: 6861 7420 6973 206e 6f74 2061 206c 696e  hat is not a lin
+0000c1a0: 6b0a 2020 2020 2020 2020 2020 2020 2320  k.            # 
+0000c1b0: 4669 6e64 7320 7468 6520 6d69 6e63 7574  Finds the mincut
+0000c1c0: 0a20 2020 2020 2020 2020 2020 206d 696e  .            min
+0000c1d0: 6375 745f 6964 783a 2069 6e74 203d 206c  cut_idx: int = l
+0000c1e0: 656e 2863 290a 2020 2020 2020 2020 2020  en(c).          
+0000c1f0: 2020 6d69 6e5f 6d65 6d6f 7279 5f75 7361    min_memory_usa
+0000c200: 6765 3a20 696e 7420 3d20 6d65 6d6f 7279  ge: int = memory
+0000c210: 5f75 7365 6428 7061 7265 6e74 2e62 7379  _used(parent.bsy
+0000c220: 6d2e 6f75 7470 7574 290a 0a20 2020 2020  m.output)..     
+0000c230: 2020 2020 2020 2066 6f72 2069 6478 2c20         for idx, 
+0000c240: 6e20 696e 2065 6e75 6d65 7261 7465 2863  n in enumerate(c
+0000c250: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000c260: 2020 206d 656d 203d 206d 656d 6f72 795f     mem = memory_
+0000c270: 7573 6564 286e 2e62 7379 6d2e 6f75 7470  used(n.bsym.outp
+0000c280: 7574 290a 2020 2020 2020 2020 2020 2020  ut).            
+0000c290: 2020 2020 6966 206d 656d 203c 206d 696e      if mem < min
+0000c2a0: 5f6d 656d 6f72 795f 7573 6167 653a 0a20  _memory_usage:. 
+0000c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c2c0: 2020 206d 696e 6375 745f 6964 7820 3d20     mincut_idx = 
+0000c2d0: 6964 780a 2020 2020 2020 2020 2020 2020  idx.            
+0000c2e0: 2020 2020 2020 2020 6d69 6e5f 6d65 6d6f          min_memo
+0000c2f0: 7279 5f75 7361 6765 203d 206d 656d 0a0a  ry_usage = mem..
+0000c300: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000c310: 6964 782c 206e 2069 6e20 656e 756d 6572  idx, n in enumer
+0000c320: 6174 6528 6329 3a0a 2020 2020 2020 2020  ate(c):.        
+0000c330: 2020 2020 2020 2020 6966 2069 6478 203c          if idx <
+0000c340: 206d 696e 6375 745f 6964 783a 0a20 2020   mincut_idx:.   
+0000c350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c360: 206e 2e6e 756d 6265 7220 3d20 636f 756e   n.number = coun
+0000c370: 7465 720a 2020 2020 2020 2020 2020 2020  ter.            
+0000c380: 2020 2020 2020 2020 636f 756e 7465 7220          counter 
+0000c390: 2b3d 2031 0a0a 2020 2020 2020 2020 2020  += 1..          
+0000c3a0: 2020 2320 5265 7475 726e 7320 7468 6520    # Returns the 
+0000c3b0: 7072 6f64 7563 6572 2d73 6964 6520 6368  producer-side ch
+0000c3c0: 6169 6e20 6375 7420 6966 2069 7420 6578  ain cut if it ex
+0000c3d0: 6973 7473 0a20 2020 2020 2020 2020 2020  ists.           
+0000c3e0: 2069 6620 6d69 6e63 7574 5f69 6478 203c   if mincut_idx <
+0000c3f0: 206c 656e 2863 293a 0a20 2020 2020 2020   len(c):.       
+0000c400: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000c410: 5b63 5b6d 696e 6375 745f 6964 785d 5d0a  [c[mincut_idx]].
+0000c420: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000c430: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c440: 2020 6173 7365 7274 206d 696e 6375 745f    assert mincut_
+0000c450: 6964 7820 3d3d 206c 656e 2863 290a 2020  idx == len(c).  
+0000c460: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000c470: 7475 726e 2065 6e64 2e70 6172 656e 7473  turn end.parents
+0000c480: 0a0a 2020 2020 2020 2020 6465 6620 6368  ..        def ch
+0000c490: 6169 6e5f 6f75 7428 6e3a 204e 6f64 652c  ain_out(n: Node,
+0000c4a0: 2073 7461 636b 3a20 6c69 7374 5b4e 6f64   stack: list[Nod
+0000c4b0: 655d 2920 2d3e 204e 6f6e 653a 0a20 2020  e]) -> None:.   
+0000c4c0: 2020 2020 2020 2020 2023 2053 686f 7274           # Short
+0000c4d0: 2d63 6972 6375 6974 7320 6966 2074 6865  -circuits if the
+0000c4e0: 206f 7269 6769 6e61 6c20 6e6f 6465 206e   original node n
+0000c4f0: 2063 616e 6e6f 7420 6265 2070 6172 7420   cannot be part 
+0000c500: 6f66 2061 2063 6861 696e 0a20 2020 2020  of a chain.     
+0000c510: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+0000c520: 5f6c 696e 6b28 6e29 3a0a 2020 2020 2020  _link(n):.      
+0000c530: 2020 2020 2020 2020 2020 7374 6163 6b2e            stack.
+0000c540: 6170 7065 6e64 286e 290a 2020 2020 2020  append(n).      
+0000c550: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000c560: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000c570: 4e4f 5445 2069 735f 6c69 6e6b 286e 2920  NOTE is_link(n) 
+0000c580: 3d3d 2054 7275 650a 2020 2020 2020 2020  == True.        
+0000c590: 2020 2020 706f 7374 5f63 6861 696e 3a20      post_chain: 
+0000c5a0: 6c69 7374 5b4e 6f64 655d 203d 205f 6368  list[Node] = _ch
+0000c5b0: 6169 6e28 5b6e 5d2c 206e 290a 0a20 2020  ain([n], n)..   
+0000c5c0: 2020 2020 2020 2020 2066 6f72 2070 6320           for pc 
+0000c5d0: 696e 2070 6f73 745f 6368 6169 6e3a 0a20  in post_chain:. 
+0000c5e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000c5f0: 7461 636b 2e61 7070 656e 6428 7063 290a  tack.append(pc).
+0000c600: 0a20 2020 2020 2020 2073 7461 636b 3a20  .        stack: 
+0000c610: 6c69 7374 5b4e 6f64 655d 203d 205b 6c65  list[Node] = [le
+0000c620: 6166 5d0a 2020 2020 2020 2020 7768 696c  af].        whil
+0000c630: 6520 6c65 6e28 7374 6163 6b29 203e 2030  e len(stack) > 0
+0000c640: 3a0a 2020 2020 2020 2020 2020 2020 6e3a  :.            n:
+0000c650: 204e 6f64 6520 3d20 7374 6163 6b2e 706f   Node = stack.po
+0000c660: 7028 290a 0a20 2020 2020 2020 2020 2020  p()..           
+0000c670: 2069 6620 6e2e 6e75 6d62 6572 2069 7320   if n.number is 
+0000c680: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0000c690: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+0000c6a0: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+0000c6b0: 6e2e 6e75 6d62 6572 203d 2063 6f75 6e74  n.number = count
+0000c6c0: 6572 0a20 2020 2020 2020 2020 2020 2063  er.            c
+0000c6d0: 6f75 6e74 6572 202b 3d20 310a 0a20 2020  ounter += 1..   
+0000c6e0: 2020 2020 2020 2020 2066 6f72 2070 2069           for p i
+0000c6f0: 6e20 6e2e 7061 7265 6e74 733a 0a20 2020  n n.parents:.   
+0000c700: 2020 2020 2020 2020 2020 2020 2063 6861               cha
+0000c710: 696e 5f6f 7574 2870 2c20 7374 6163 6b29  in_out(p, stack)
+0000c720: 0a0a 2020 2020 2020 2020 6465 6620 5f73  ..        def _s
+0000c730: 656c 6563 746f 7228 656c 6967 6962 6c65  elector(eligible
+0000c740: 5f6e 6f64 6573 3a20 6c69 7374 5b4e 6f64  _nodes: list[Nod
+0000c750: 655d 2920 2d3e 2069 6e74 3a0a 2020 2020  e]) -> int:.    
+0000c760: 2020 2020 2020 2020 6d69 6e5f 6964 783a          min_idx:
+0000c770: 2069 6e74 203d 2030 0a20 2020 2020 2020   int = 0.       
+0000c780: 2020 2020 206d 696e 5f6e 756d 6265 723a       min_number:
+0000c790: 2069 6e74 203d 2065 6c69 6769 626c 655f   int = eligible_
+0000c7a0: 6e6f 6465 735b 305d 2e6e 756d 6265 720a  nodes[0].number.
+0000c7b0: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
+0000c7c0: 4f54 4520 416c 7468 6f75 6768 2077 6527  OTE Although we'
+0000c7d0: 7665 2061 6c72 6561 6479 2070 726f 6365  ve already proce
+0000c7e0: 7373 6564 2074 6865 2066 6972 7374 2065  ssed the first e
+0000c7f0: 6c65 6d65 6e74 2068 6572 652c 2074 6869  lement here, thi
+0000c800: 7320 7374 696c 6c0a 2020 2020 2020 2020  s still.        
+0000c810: 2020 2020 2320 2020 656e 756d 6572 6174      #   enumerat
+0000c820: 6573 2074 6865 2065 6e74 6972 6520 6c69  es the entire li
+0000c830: 7374 2063 2074 6f20 616c 6967 6e20 7468  st c to align th
+0000c840: 6520 656e 756d 6572 6174 696f 6e20 6964  e enumeration id
+0000c850: 7820 7072 6f70 6572 6c79 0a20 2020 2020  x properly.     
+0000c860: 2020 2020 2020 2066 6f72 2069 6478 2c20         for idx, 
+0000c870: 6e20 696e 2065 6e75 6d65 7261 7465 2865  n in enumerate(e
+0000c880: 6c69 6769 626c 655f 6e6f 6465 7329 3a0a  ligible_nodes):.
+0000c890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c8a0: 6368 6563 6b28 6e2e 6e75 6d62 6572 2069  check(n.number i
+0000c8b0: 7320 6e6f 7420 4e6f 6e65 2c20 6c61 6d62  s not None, lamb
+0000c8c0: 6461 3a20 6622 4578 7065 6374 6564 2065  da: f"Expected e
+0000c8d0: 6163 6820 6e6f 6465 2074 6f20 6265 206e  ach node to be n
+0000c8e0: 756d 6265 7265 642c 2062 7574 207b 6e7d  umbered, but {n}
+0000c8f0: 2077 6173 206e 6f74 2229 0a0a 2020 2020   was not")..    
+0000c900: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000c910: 2e6e 756d 6265 7220 3c20 6d69 6e5f 6e75  .number < min_nu
+0000c920: 6d62 6572 3a0a 2020 2020 2020 2020 2020  mber:.          
+0000c930: 2020 2020 2020 2020 2020 6d69 6e5f 6964            min_id
+0000c940: 7820 3d20 6964 780a 2020 2020 2020 2020  x = idx.        
+0000c950: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+0000c960: 6e75 6d62 6572 203d 206e 2e6e 756d 6265  number = n.numbe
+0000c970: 720a 0a20 2020 2020 2020 2020 2020 2072  r..            r
+0000c980: 6574 7572 6e20 6d69 6e5f 6964 780a 0a20  eturn min_idx.. 
+0000c990: 2020 2020 2020 2073 6f72 7465 645f 6273         sorted_bs
+0000c9a0: 796d 7320 3d20 746f 706f 736f 7274 5f62  yms = toposort_b
+0000c9b0: 7379 6d5f 6461 6728 6c65 6176 6573 2c20  sym_dag(leaves, 
+0000c9c0: 746f 706f 736f 7274 5f6f 7264 6572 3d54  toposort_order=T
+0000c9d0: 4f50 4f53 4f52 545f 4f52 4445 522e 424f  OPOSORT_ORDER.BO
+0000c9e0: 5454 4f4d 5f55 502c 2073 656c 6563 746f  TTOM_UP, selecto
+0000c9f0: 723d 5f73 656c 6563 746f 7229 0a20 2020  r=_selector).   
+0000ca00: 2020 2020 2067 7261 6474 7263 2e62 6f75       gradtrc.bou
+0000ca10: 6e64 5f73 796d 626f 6c73 203d 2073 6f72  nd_symbols = sor
+0000ca20: 7465 645f 6273 796d 730a 2020 2020 2020  ted_bsyms.      
+0000ca30: 2020 6772 6164 7472 6320 3d20 6463 6528    gradtrc = dce(
+0000ca40: 6772 6164 7472 6329 0a0a 2020 2020 2020  gradtrc)..      
+0000ca50: 2020 2320 544f 444f 2043 6f6e 7369 6465    # TODO Conside
+0000ca60: 7220 686f 7720 746f 2068 616e 646c 6520  r how to handle 
+0000ca70: 6772 6164 2077 2e72 2e74 2e20 6f6e 6c79  grad w.r.t. only
+0000ca80: 2073 6f6d 6520 6f75 7470 7574 7320 2d2d   some outputs --
+0000ca90: 2073 686f 756c 6420 616c 6c20 6772 6164   should all grad
+0000caa0: 0a20 2020 2020 2020 2023 2020 206f 7065  .        #   ope
+0000cab0: 7261 7469 6f6e 7320 7573 696e 6720 7468  rations using th
+0000cac0: 6520 6f74 6865 7220 6f75 7470 7574 2062  e other output b
+0000cad0: 6520 7265 6d6f 7665 643f 2057 6861 7420  e removed? What 
+0000cae0: 6b69 6e64 206f 6620 6173 7375 6d70 7469  kind of assumpti
+0000caf0: 6f6e 2064 6f65 7320 7468 6174 0a20 2020  on does that.   
+0000cb00: 2020 2020 2023 2020 206d 616b 6520 6162       #   make ab
+0000cb10: 6f75 7420 7468 6520 6772 6164 2073 7472  out the grad str
+0000cb20: 7563 7475 7265 3f20 5072 6f62 6162 6c79  ucture? Probably
+0000cb30: 2073 6f6d 6520 6b69 6e64 206f 6620 696e   some kind of in
+0000cb40: 6465 7065 6e64 656e 6365 2061 7373 756d  dependence assum
+0000cb50: 7074 696f 6e3f 2041 7265 0a20 2020 2020  ption? Are.     
+0000cb60: 2020 2023 2020 2074 6865 7265 2070 7261     #   there pra
+0000cb70: 6374 6963 616c 2065 7861 6d70 6c65 7320  ctical examples 
+0000cb80: 7768 6572 6520 7468 6174 2773 2061 6e20  where that's an 
+0000cb90: 6973 7375 653f 0a0a 2020 2020 2020 2020  issue?..        
+0000cba0: 656e 645f 7469 6d65 5f6e 7320 3d20 7469  end_time_ns = ti
+0000cbb0: 6d65 2e74 696d 655f 6e73 2829 0a20 2020  me.time_ns().   
+0000cbc0: 2020 2020 2065 6c61 7073 6564 5f74 696d       elapsed_tim
+0000cbd0: 655f 6e73 203d 2065 6e64 5f74 696d 655f  e_ns = end_time_
+0000cbe0: 6e73 202d 2073 7461 7274 5f74 696d 655f  ns - start_time_
+0000cbf0: 6e73 0a20 2020 2020 2020 2065 6c61 7073  ns.        elaps
+0000cc00: 6564 5f74 696d 655f 6d69 6c6c 6973 203d  ed_time_millis =
+0000cc10: 2065 6c61 7073 6564 5f74 696d 655f 6e73   elapsed_time_ns
+0000cc20: 202f 2f20 3130 3030 3030 300a 2020 2020   // 1000000.    
+0000cc30: 2020 2020 6772 6164 7472 632e 7365 745f      gradtrc.set_
+0000cc40: 7072 6f76 656e 616e 6365 2854 7261 6365  provenance(Trace
+0000cc50: 5072 6f76 656e 616e 6365 2866 2247 7261  Provenance(f"Gra
+0000cc60: 6420 2874 6f6f 6b20 7b65 6c61 7073 6564  d (took {elapsed
+0000cc70: 5f74 696d 655f 6d69 6c6c 6973 7d20 6d69  _time_millis} mi
+0000cc80: 6c6c 6973 6563 6f6e 6473 2922 2929 0a0a  lliseconds)"))..
+0000cc90: 2020 2020 2020 2020 7265 7475 726e 2067          return g
+0000cca0: 7261 6474 7263 0a0a 2020 2020 2320 4e4f  radtrc..    # NO
+0000ccb0: 5445 2054 6869 7320 6973 2061 206b 6c75  TE This is a klu
+0000ccc0: 6467 6520 746f 2069 6e64 6963 6174 6520  dge to indicate 
+0000ccd0: 7468 6174 2077 6520 7368 6f75 6c64 6e27  that we shouldn'
+0000cce0: 7420 7573 6520 5079 546f 7263 6827 7320  t use PyTorch's 
+0000ccf0: 6175 746f 6772 6164 2062 6563 6175 7365  autograd because
+0000cd00: 0a20 2020 2023 2020 2077 6527 7265 2075  .    #   we're u
+0000cd10: 7369 6e67 206f 7572 206f 776e 2061 7574  sing our own aut
+0000cd20: 6f67 7261 6420 7472 616e 7366 6f72 6d0a  ograd transform.
+0000cd30: 2020 2020 6366 6e2e 5f75 7369 6e67 5f67      cfn._using_g
+0000cd40: 7261 645f 7472 616e 7366 6f72 6d20 3d20  rad_transform = 
+0000cd50: 5472 7565 0a0a 2020 2020 7265 7475 726e  True..    return
+0000cd60: 2061 6464 5f74 7261 6e73 666f 726d 2863   add_transform(c
+0000cd70: 666e 2c20 5f67 7261 645f 7472 616e 7366  fn, _grad_transf
+0000cd80: 6f72 6d29 0a0a 0a64 6566 2067 7261 645f  orm)...def grad_
+0000cd90: 7631 280a 2020 2020 6366 6e2c 0a29 202d  v1(.    cfn,.) -
+0000cda0: 3e20 4361 6c6c 6162 6c65 3a0a 2020 2020  > Callable:.    
+0000cdb0: 6465 6620 6772 6164 2866 756e 6329 3a0a  def grad(func):.
+0000cdc0: 2020 2020 2020 2020 6465 6620 6772 6164          def grad
+0000cdd0: 5f66 756e 6328 2a61 7267 732c 202a 2a6b  _func(*args, **k
+0000cde0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+0000cdf0: 2020 2020 5f2c 2067 7261 6473 203d 2076      _, grads = v
+0000ce00: 616c 7565 5f61 6e64 5f67 7261 6428 6675  alue_and_grad(fu
+0000ce10: 6e63 2928 2a61 7267 732c 202a 2a6b 7761  nc)(*args, **kwa
+0000ce20: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
+0000ce30: 2067 7261 6473 203d 205b 6720 666f 7220   grads = [g for 
+0000ce40: 6720 696e 2067 7261 6473 2069 6620 6720  g in grads if g 
+0000ce50: 6973 206e 6f74 204e 6f6e 655d 0a20 2020  is not None].   
+0000ce60: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000ce70: 6772 6164 730a 0a20 2020 2020 2020 2072  grads..        r
+0000ce80: 6574 7572 6e20 6772 6164 5f66 756e 630a  eturn grad_func.
+0000ce90: 0a20 2020 2064 6566 205f 6772 6164 5f74  .    def _grad_t
+0000cea0: 7261 6e73 666f 726d 2874 7263 3a20 5472  ransform(trc: Tr
+0000ceb0: 6163 652c 202a 2c20 6578 6563 7574 6f72  ace, *, executor
+0000cec0: 735f 6c69 7374 3a20 5365 7175 656e 6365  s_list: Sequence
+0000ced0: 5b41 6e79 5d29 202d 3e20 5472 6163 653a  [Any]) -> Trace:
+0000cee0: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
+0000cef0: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
+0000cf00: 6365 2829 2867 7261 6428 7472 632e 7079  ce()(grad(trc.py
+0000cf10: 7468 6f6e 5f63 616c 6c61 626c 6528 2929  thon_callable())
+0000cf20: 2c20 2a74 7263 2e61 7267 732c 202a 2a74  , *trc.args, **t
+0000cf30: 7263 2e6b 7761 7267 7329 0a20 2020 2020  rc.kwargs).     
+0000cf40: 2020 2072 6574 7572 6e20 6772 6164 7472     return gradtr
+0000cf50: 630a 0a20 2020 2063 666e 2e5f 7573 696e  c..    cfn._usin
+0000cf60: 675f 6772 6164 5f74 7261 6e73 666f 726d  g_grad_transform
+0000cf70: 203d 2054 7275 650a 2020 2020 7265 7475   = True.    retu
+0000cf80: 726e 2061 6464 5f74 7261 6e73 666f 726d  rn add_transform
+0000cf90: 2863 666e 2c20 5f67 7261 645f 7472 616e  (cfn, _grad_tran
+0000cfa0: 7366 6f72 6d29 0a0a 0a63 6c61 7373 2054  sform)...class T
+0000cfb0: 7261 6e73 666f 726d 7328 456e 756d 293a  ransforms(Enum):
+0000cfc0: 0a20 2020 2049 6465 6e74 6974 794f 7020  .    IdentityOp 
+0000cfd0: 3d20 6175 746f 2829 0a20 2020 2056 6d61  = auto().    Vma
+0000cfe0: 704f 7020 3d20 6175 746f 2829 0a20 2020  pOp = auto().   
+0000cff0: 204a 7670 4f70 203d 2061 7574 6f28 290a   JvpOp = auto().
+0000d000: 2020 2020 566a 704f 7020 3d20 6175 746f      VjpOp = auto
+0000d010: 2829 0a0a 0a40 6c72 755f 6361 6368 6528  ()...@lru_cache(
+0000d020: 6d61 7873 697a 653d 4e6f 6e65 290a 6465  maxsize=None).de
+0000d030: 6620 7379 6d62 6f6c 5f74 6f5f 6576 616c  f symbol_to_eval
+0000d040: 2862 6f75 6e64 5f73 796d 626f 6c29 3a0a  (bound_symbol):.
+0000d050: 2020 2020 2222 224d 6170 2061 2042 6f75      """Map a Bou
+0000d060: 6e64 5379 6d62 6f6c 2074 6f20 6120 6675  ndSymbol to a fu
+0000d070: 6e63 7469 6f6e 2074 6861 7420 6576 616c  nction that eval
+0000d080: 7561 7465 7320 6974 2e0a 0a20 2020 2041  uates it...    A
+0000d090: 7267 733a 0a20 2020 2020 2020 2062 6f75  rgs:.        bou
+0000d0a0: 6e64 5f73 796d 626f 6c3a 2042 6f75 6e64  nd_symbol: Bound
+0000d0b0: 5379 6d62 6f6c 2074 6f20 6d61 700a 2020  Symbol to map.  
+0000d0c0: 2020 2222 220a 2020 2020 2320 5379 6d62    """.    # Symb
+0000d0d0: 6f6c 2069 7320 6361 6c6c 6162 6c65 0a20  ol is callable. 
+0000d0e0: 2020 2072 6574 7572 6e20 626f 756e 645f     return bound_
+0000d0f0: 7379 6d62 6f6c 2e73 796d 0a0a 0a23 2054  symbol.sym...# T
+0000d100: 4f44 4f3a 2043 7572 7265 6e74 6c79 2077  ODO: Currently w
+0000d110: 6520 7573 6520 7472 6163 652e 6172 6773  e use trace.args
+0000d120: 2061 6e64 2074 7261 6365 2e6b 7761 7267   and trace.kwarg
+0000d130: 7320 746f 2067 6574 2074 6865 2061 7267  s to get the arg
+0000d140: 756d 656e 7473 0a23 204d 6179 6265 2077  uments.# Maybe w
+0000d150: 6520 7368 6f75 6c64 2075 7365 2074 6865  e should use the
+0000d160: 7365 2069 6e73 7465 6164 0a74 7261 6e73  se instead.trans
+0000d170: 666f 726d 5f73 6b69 705f 6c69 7374 203d  form_skip_list =
+0000d180: 2028 0a20 2020 2070 7269 6d73 2e50 7269   (.    prims.Pri
+0000d190: 6d49 4473 2e55 4e50 4143 4b5f 454d 5054  mIDs.UNPACK_EMPT
+0000d1a0: 595f 4449 4354 2c0a 2020 2020 7072 696d  Y_DICT,.    prim
+0000d1b0: 732e 5072 696d 4944 732e 554e 5041 434b  s.PrimIDs.UNPACK
+0000d1c0: 5f4b 4559 2c0a 2020 2020 7072 696d 732e  _KEY,.    prims.
+0000d1d0: 5072 696d 4944 732e 554e 5041 434b 5f53  PrimIDs.UNPACK_S
+0000d1e0: 4551 5545 4e43 452c 0a20 2020 2070 7269  EQUENCE,.    pri
+0000d1f0: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
+0000d200: 4b5f 5452 4956 4941 4c2c 0a20 2020 2070  K_TRIVIAL,.    p
+0000d210: 7269 6d73 2e50 7269 6d49 4473 2e52 4554  rims.PrimIDs.RET
+0000d220: 5552 4e2c 0a29 0a0a 0a64 6566 2065 7661  URN,.)...def eva
+0000d230: 6c5f 7472 6163 6528 7472 6163 652c 202a  l_trace(trace, *
+0000d240: 6172 6773 2c20 7379 6d62 6f6c 5f6d 6170  args, symbol_map
+0000d250: 7065 723d 7379 6d62 6f6c 5f74 6f5f 6576  per=symbol_to_ev
+0000d260: 616c 2c20 7769 7468 5f65 6e76 3d46 616c  al, with_env=Fal
+0000d270: 7365 2c20 2a2a 6b77 6172 6773 293a 0a20  se, **kwargs):. 
+0000d280: 2020 2022 2222 4576 616c 7561 7465 2061     """Evaluate a
+0000d290: 2074 7261 6365 2e0a 0a20 2020 2041 7267   trace...    Arg
+0000d2a0: 733a 0a20 2020 2020 2020 2074 7261 6365  s:.        trace
+0000d2b0: 3a20 7472 6163 6520 746f 2065 7661 6c75  : trace to evalu
+0000d2c0: 6174 650a 2020 2020 2020 2020 2a61 7267  ate.        *arg
+0000d2d0: 733a 2061 7267 756d 656e 7473 2074 6f20  s: arguments to 
+0000d2e0: 6576 616c 7561 7465 2074 6865 2074 7261  evaluate the tra
+0000d2f0: 6365 2077 6974 680a 2020 2020 2020 2020  ce with.        
+0000d300: 7379 6d62 6f6c 5f6d 6170 7065 723a 2066  symbol_mapper: f
+0000d310: 756e 6374 696f 6e20 7468 6174 206d 6170  unction that map
+0000d320: 7320 6120 7379 6d62 6f6c 2074 6f20 6120  s a symbol to a 
+0000d330: 6675 6e63 7469 6f6e 2074 6861 7420 6576  function that ev
+0000d340: 616c 7561 7465 7320 6974 0a20 2020 2020  aluates it.     
+0000d350: 2020 202a 2a6b 7761 7267 733a 206b 6579     **kwargs: key
+0000d360: 776f 7264 2061 7267 756d 656e 7473 2074  word arguments t
+0000d370: 6f20 6576 616c 7561 7465 2074 6865 2074  o evaluate the t
+0000d380: 7261 6365 2077 6974 680a 0a20 2020 2052  race with..    R
+0000d390: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0000d3a0: 7265 7375 6c74 206f 6620 6576 616c 7561  result of evalua
+0000d3b0: 7469 6e67 2074 6865 2074 7261 6365 0a20  ting the trace. 
+0000d3c0: 2020 2022 2222 0a20 2020 2065 6e76 203d     """.    env =
+0000d3d0: 207b 7d0a 0a20 2020 2064 6566 2072 6561   {}..    def rea
+0000d3e0: 6428 783a 2056 6172 6961 626c 6529 3a0a  d(x: Variable):.
+0000d3f0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0000d400: 7461 6e63 6528 782c 2056 6172 6961 626c  tance(x, Variabl
+0000d410: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0000d420: 7265 7475 726e 2065 6e76 5b78 2e6e 616d  return env[x.nam
+0000d430: 655d 0a20 2020 2020 2020 2065 6c73 653a  e].        else:
+0000d440: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000d450: 7572 6e20 780a 0a20 2020 2064 6566 2077  urn x..    def w
+0000d460: 7269 7465 2876 3a20 5661 7269 6162 6c65  rite(v: Variable
+0000d470: 2c20 7661 6c3a 2041 6e79 2c20 616c 6c6f  , val: Any, allo
+0000d480: 775f 6475 706c 6963 6174 6573 3d46 616c  w_duplicates=Fal
+0000d490: 7365 2920 2d3e 204e 6f6e 653a 0a20 2020  se) -> None:.   
+0000d4a0: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+0000d4b0: 7374 616e 6365 2876 2c20 5661 7269 6162  stance(v, Variab
+0000d4c0: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
+0000d4d0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+0000d4e0: 2320 4475 706c 6963 6174 6573 2061 7265  # Duplicates are
+0000d4f0: 2061 6c6c 6f77 6564 2061 6e64 206f 7665   allowed and ove
+0000d500: 7277 7269 7474 656e 0a20 2020 2020 2020  rwritten.       
+0000d510: 2069 6620 762e 6e61 6d65 2069 6e20 656e   if v.name in en
+0000d520: 763a 0a20 2020 2020 2020 2020 2020 2069  v:.            i
+0000d530: 6620 616c 6c6f 775f 6475 706c 6963 6174  f allow_duplicat
+0000d540: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0000d550: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+0000d560: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0000d570: 7565 4572 726f 7228 6622 5661 7269 6162  ueError(f"Variab
+0000d580: 6c65 207b 762e 6e61 6d65 7d20 6973 2062  le {v.name} is b
+0000d590: 6569 6e67 206f 7665 7277 7269 7474 656e  eing overwritten
+0000d5a0: 2074 6869 7320 6973 206e 6f74 2061 6c6c   this is not all
+0000d5b0: 6f77 6564 2229 0a20 2020 2020 2020 2065  owed").        e
+0000d5c0: 6e76 5b76 2e6e 616d 655d 203d 2076 616c  nv[v.name] = val
+0000d5d0: 0a0a 2020 2020 7361 6665 5f6d 6170 5f66  ..    safe_map_f
+0000d5e0: 6c61 7428 7772 6974 652c 206c 6973 7428  lat(write, list(
+0000d5f0: 7472 6163 652e 6172 6773 292c 206c 6973  trace.args), lis
+0000d600: 7428 6172 6773 2929 0a20 2020 2073 6166  t(args)).    saf
+0000d610: 655f 6d61 705f 666c 6174 2877 7269 7465  e_map_flat(write
+0000d620: 2c20 6c69 7374 2874 7261 6365 2e6b 7761  , list(trace.kwa
+0000d630: 7267 732e 7661 6c75 6573 2829 292c 206c  rgs.values()), l
+0000d640: 6973 7428 6b77 6172 6773 2e76 616c 7565  ist(kwargs.value
+0000d650: 7328 2929 290a 0a20 2020 2066 6f72 2073  s()))..    for s
+0000d660: 796d 626f 6c20 696e 2074 7261 6365 2e62  ymbol in trace.b
+0000d670: 6f75 6e64 5f73 796d 626f 6c73 3a0a 2020  ound_symbols:.  
+0000d680: 2020 2020 2020 6966 2073 796d 626f 6c2e        if symbol.
+0000d690: 7379 6d2e 6964 2069 6e20 7472 616e 7366  sym.id in transf
+0000d6a0: 6f72 6d5f 736b 6970 5f6c 6973 743a 0a20  orm_skip_list:. 
+0000d6b0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0000d6c0: 6e75 650a 2020 2020 2020 2020 6172 6773  nue.        args
+0000d6d0: 203d 2074 7265 655f 6d61 7028 7265 6164   = tree_map(read
+0000d6e0: 2c20 7379 6d62 6f6c 2e61 7267 7329 0a20  , symbol.args). 
+0000d6f0: 2020 2020 2020 206b 7761 7267 7320 3d20         kwargs = 
+0000d700: 7472 6565 5f6d 6170 2872 6561 642c 2073  tree_map(read, s
+0000d710: 796d 626f 6c2e 6b77 6172 6773 290a 2020  ymbol.kwargs).  
+0000d720: 2020 2020 2020 7072 696d 5f66 756e 6320        prim_func 
+0000d730: 3d20 7379 6d62 6f6c 5f6d 6170 7065 7228  = symbol_mapper(
+0000d740: 7379 6d62 6f6c 290a 2020 2020 2020 2020  symbol).        
+0000d750: 6966 2070 7269 6d5f 6675 6e63 2069 7320  if prim_func is 
+0000d760: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000d770: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+0000d780: 2020 2072 6573 756c 7420 3d20 7072 696d     result = prim
+0000d790: 5f66 756e 6328 2a61 7267 732c 202a 2a6b  _func(*args, **k
+0000d7a0: 7761 7267 7329 0a20 2020 2020 2020 2073  wargs).        s
+0000d7b0: 6166 655f 6d61 705f 666c 6174 2877 7269  afe_map_flat(wri
+0000d7c0: 7465 2c20 6c69 7374 2873 6571 7565 6e63  te, list(sequenc
+0000d7d0: 6966 7928 7379 6d62 6f6c 2e6f 7574 7075  ify(symbol.outpu
+0000d7e0: 7429 292c 206c 6973 7428 7365 7175 656e  t)), list(sequen
+0000d7f0: 6369 6679 2872 6573 756c 7429 2929 0a0a  cify(result)))..
+0000d800: 2020 2020 6966 2077 6974 685f 656e 763a      if with_env:
+0000d810: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000d820: 7472 6565 5f6d 6170 2872 6561 642c 2074  tree_map(read, t
+0000d830: 7261 6365 2e6f 7574 7075 7429 2c20 656e  race.output), en
+0000d840: 760a 0a20 2020 2072 6574 7572 6e20 7472  v..    return tr
+0000d850: 6565 5f6d 6170 2872 6561 642c 2074 7261  ee_map(read, tra
+0000d860: 6365 2e6f 7574 7075 7429 0a0a 0a64 6566  ce.output)...def
+0000d870: 205f 6964 656e 7469 7479 5f63 616c 6c5f   _identity_call_
+0000d880: 6d65 7461 6675 6e63 282a 6172 6773 2c20  metafunc(*args, 
+0000d890: 7472 6163 653a 2054 7261 6365 2c20 2a2a  trace: Trace, **
+0000d8a0: 6b77 6172 6773 293a 0a20 2020 2077 6974  kwargs):.    wit
+0000d8b0: 6820 6465 7461 6368 6564 5f74 7261 6365  h detached_trace
+0000d8c0: 2829 3a0a 2020 2020 2020 2020 7265 7475  ():.        retu
+0000d8d0: 726e 2065 7661 6c5f 7472 6163 6528 7472  rn eval_trace(tr
+0000d8e0: 6163 652c 202a 6172 6773 2c20 2a2a 6b77  ace, *args, **kw
+0000d8f0: 6172 6773 290a 0a0a 6964 656e 7469 7479  args)...identity
+0000d900: 5f63 616c 6c20 3d20 5379 6d62 6f6c 2869  _call = Symbol(i
+0000d910: 643d 5472 616e 7366 6f72 6d73 2e49 6465  d=Transforms.Ide
+0000d920: 6e74 6974 794f 702c 206e 616d 653d 2269  ntityOp, name="i
+0000d930: 6465 6e74 6974 795f 6361 6c6c 222c 206d  dentity_call", m
+0000d940: 6574 613d 5f69 6465 6e74 6974 795f 6361  eta=_identity_ca
+0000d950: 6c6c 5f6d 6574 6166 756e 6329 0a0a 0a64  ll_metafunc)...d
+0000d960: 6566 2069 6465 6e74 6974 7928 6675 6e63  ef identity(func
+0000d970: 293a 0a20 2020 2022 2222 4964 656e 7469  ):.    """Identi
+0000d980: 7479 2074 7261 6e73 666f 726d 2066 6f72  ty transform for
+0000d990: 2061 2054 6875 6e64 6572 2066 756e 6374   a Thunder funct
+0000d9a0: 696f 6e2e 0a0a 2020 2020 4172 6773 3a0a  ion...    Args:.
+0000d9b0: 2020 2020 2020 2020 6675 6e63 2028 4361          func (Ca
+0000d9c0: 6c6c 6162 6c65 293a 2041 2054 6875 6e64  llable): A Thund
+0000d9d0: 6572 2066 756e 6374 696f 6e20 746f 2062  er function to b
+0000d9e0: 6520 7472 616e 7366 6f72 6d65 642e 0a20  e transformed.. 
+0000d9f0: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
+0000da00: 7772 6170 7065 7228 2a61 7267 732c 202a  wrapper(*args, *
+0000da10: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+0000da20: 2020 7472 6163 6520 3d20 636f 6e73 7472    trace = constr
+0000da30: 7563 745f 7472 6163 6528 2928 6675 6e63  uct_trace()(func
+0000da40: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+0000da50: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+0000da60: 6e20 6964 656e 7469 7479 5f63 616c 6c28  n identity_call(
+0000da70: 2a61 7267 732c 202a 2a6b 7761 7267 732c  *args, **kwargs,
+0000da80: 2074 7261 6365 3d74 7261 6365 290a 0a20   trace=trace).. 
+0000da90: 2020 2072 6574 7572 6e20 7772 6170 7065     return wrappe
+0000daa0: 720a 0a0a 6465 6620 5f69 6465 6e74 6974  r...def _identit
+0000dab0: 795f 6361 6c6c 5f70 7974 6f72 6368 282a  y_call_pytorch(*
+0000dac0: 6172 6773 2c20 7472 6163 653a 2054 7261  args, trace: Tra
+0000dad0: 6365 2c20 2a2a 6b77 6172 6773 293a 0a20  ce, **kwargs):. 
+0000dae0: 2020 2069 6d70 6f72 7420 746f 7263 680a     import torch.
+0000daf0: 0a20 2020 2064 6566 2073 796d 626f 6c5f  .    def symbol_
+0000db00: 6d61 7070 6572 286f 7029 3a0a 2020 2020  mapper(op):.    
+0000db10: 2020 2020 6966 206f 702e 6f70 203d 3d20      if op.op == 
+0000db20: 5472 616e 7366 6f72 6d73 2e49 6465 6e74  Transforms.Ident
+0000db30: 6974 794f 703a 0a20 2020 2020 2020 2020  ityOp:.         
+0000db40: 2020 2072 6574 7572 6e20 5f69 6465 6e74     return _ident
+0000db50: 6974 795f 6361 6c6c 5f70 7974 6f72 6368  ity_call_pytorch
+0000db60: 0a0a 2020 2020 2020 2020 746f 7263 685f  ..        torch_
+0000db70: 6f70 203d 206f 7073 5f74 6f5f 746f 7263  op = ops_to_torc
+0000db80: 685f 6f70 735f 6d61 705b 6f70 2e6f 705d  h_ops_map[op.op]
+0000db90: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+0000dba0: 7374 616e 6365 2874 6f72 6368 5f6f 702c  stance(torch_op,
+0000dbb0: 2073 7472 293a 0a20 2020 2020 2020 2020   str):.         
+0000dbc0: 2020 2072 6574 7572 6e20 6765 7461 7474     return getatt
+0000dbd0: 7228 746f 7263 682c 2074 6f72 6368 5f6f  r(torch, torch_o
+0000dbe0: 702e 7374 7269 7028 2270 7974 6f72 6368  p.strip("pytorch
+0000dbf0: 2e22 2929 0a20 2020 2020 2020 2072 6574  .")).        ret
+0000dc00: 7572 6e20 746f 7263 685f 6f70 0a0a 2020  urn torch_op..  
+0000dc10: 2020 7769 7468 2064 6574 6163 6865 645f    with detached_
+0000dc20: 7472 6163 6528 293a 0a20 2020 2020 2020  trace():.       
+0000dc30: 2072 6574 7572 6e20 6576 616c 5f74 7261   return eval_tra
+0000dc40: 6365 2874 7261 6365 2c20 2a61 7267 732c  ce(trace, *args,
+0000dc50: 202a 2a6b 7761 7267 732c 2073 796d 626f   **kwargs, symbo
+0000dc60: 6c5f 6d61 7070 6572 3d73 796d 626f 6c5f  l_mapper=symbol_
+0000dc70: 6d61 7070 6572 290a 0a0a 2320 5265 6769  mapper)...# Regi
+0000dc80: 7374 6572 2074 6865 2069 6465 6e74 6974  ster the identit
+0000dc90: 7920 6361 6c6c 2066 6f72 2050 7954 6f72  y call for PyTor
+0000dca0: 6368 2065 7865 6375 746f 722e 0a23 206f  ch executor..# o
+0000dcb0: 7073 5f74 6f5f 746f 7263 685f 6f70 735f  ps_to_torch_ops_
+0000dcc0: 6d61 705b 5472 616e 7366 6f72 6d73 2e49  map[Transforms.I
+0000dcd0: 6465 6e74 6974 794f 705d 203d 205f 6964  dentityOp] = _id
+0000dce0: 656e 7469 7479 5f63 616c 6c5f 7079 746f  entity_call_pyto
+0000dcf0: 7263 680a 0a0a 2320 564d 4150 2074 7261  rch...# VMAP tra
+0000dd00: 6e73 666f 726d 0a23 202d 2d2d 2d2d 2d2d  nsform.# -------
+0000dd10: 2d2d 2d2d 2d2d 0a0a 0a63 6c61 7373 204e  ------...class N
+0000dd20: 6f74 4d61 7070 6564 3a0a 2020 2020 2222  otMapped:.    ""
+0000dd30: 2252 6570 7265 7365 6e74 7320 6120 6e6f  "Represents a no
+0000dd40: 6e2d 6261 7463 6865 6420 6469 6d65 6e73  n-batched dimens
+0000dd50: 696f 6e2e 2222 220a 0a20 2020 2064 6566  ion."""..    def
+0000dd60: 205f 5f72 6570 725f 5f28 7365 6c66 293a   __repr__(self):
+0000dd70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000dd80: 226e 6f74 5f6d 6170 7065 6422 0a0a 0a40  "not_mapped"...@
+0000dd90: 6461 7461 636c 6173 7328 6672 6f7a 656e  dataclass(frozen
+0000dda0: 3d54 7275 6529 0a63 6c61 7373 2042 6174  =True).class Bat
+0000ddb0: 6368 6564 5661 6c75 653a 0a20 2020 2022  chedValue:.    "
+0000ddc0: 2222 4261 7463 6865 6420 7661 6c75 6520  ""Batched value 
+0000ddd0: 666f 7220 7468 6520 766d 6170 2074 7261  for the vmap tra
+0000dde0: 6e73 666f 726d 2e0a 0a20 2020 2041 7474  nsform...    Att
+0000ddf0: 7269 6275 7465 733a 0a20 2020 2020 2020  ributes:.       
+0000de00: 2076 616c 7565 3a20 4261 7463 6865 6420   value: Batched 
+0000de10: 7661 6c75 652e 0a20 2020 2020 2020 2062  value..        b
+0000de20: 6174 6368 5f64 696d 3a20 4261 7463 6869  atch_dim: Batchi
+0000de30: 6e67 2064 696d 656e 7369 6f6e 206f 7220  ng dimension or 
+0000de40: 6e6f 745f 6d61 7070 6564 0a20 2020 2022  not_mapped.    "
+0000de50: 2222 0a0a 2020 2020 7661 6c75 653a 2041  ""..    value: A
+0000de60: 6e79 0a20 2020 2062 6174 6368 5f64 696d  ny.    batch_dim
+0000de70: 3a20 696e 7420 7c20 4e6f 744d 6170 7065  : int | NotMappe
+0000de80: 640a 0a20 2020 2064 6566 205f 5f69 7465  d..    def __ite
+0000de90: 725f 5f28 7365 6c66 293a 0a20 2020 2020  r__(self):.     
+0000dea0: 2020 2079 6965 6c64 2073 656c 662e 7661     yield self.va
+0000deb0: 6c75 650a 2020 2020 2020 2020 7969 656c  lue.        yiel
+0000dec0: 6420 7365 6c66 2e62 6174 6368 5f64 696d  d self.batch_dim
+0000ded0: 0a0a 0a64 6566 2070 6169 725f 746f 5f62  ...def pair_to_b
+0000dee0: 6174 6368 6564 5f76 616c 7565 2870 6169  atched_value(pai
+0000def0: 7229 3a0a 2020 2020 2222 2243 6f6e 7665  r):.    """Conve
+0000df00: 7274 7320 6120 7061 6972 2074 6f20 6120  rts a pair to a 
+0000df10: 4261 7463 6865 6456 616c 7565 2e0a 0a20  BatchedValue... 
+0000df20: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0000df30: 2070 6169 7220 2853 6571 7565 6e63 6529   pair (Sequence)
+0000df40: 3a20 5061 6972 2074 6f20 636f 6e76 6572  : Pair to conver
+0000df50: 742e 0a0a 2020 2020 5265 7475 726e 733a  t...    Returns:
+0000df60: 0a20 2020 2020 2020 2042 6174 6368 6564  .        Batched
+0000df70: 5661 6c75 653a 2042 6174 6368 6564 5661  Value: BatchedVa
+0000df80: 6c75 6520 7265 7072 6573 656e 7461 7469  lue representati
+0000df90: 6f6e 206f 6620 7468 6520 7061 6972 2e0a  on of the pair..
+0000dfa0: 2020 2020 2222 220a 2020 2020 6966 2069      """.    if i
+0000dfb0: 7369 6e73 7461 6e63 6528 7061 6972 2c20  sinstance(pair, 
+0000dfc0: 4261 7463 6865 6456 616c 7565 293a 0a20  BatchedValue):. 
+0000dfd0: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
+0000dfe0: 6972 0a20 2020 2065 6c73 653a 0a20 2020  ir.    else:.   
+0000dff0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+0000e000: 7374 616e 6365 2870 6169 722c 2053 6571  stance(pair, Seq
+0000e010: 7565 6e63 6529 2061 6e64 206c 656e 2870  uence) and len(p
+0000e020: 6169 7229 203d 3d20 320a 2020 2020 2020  air) == 2.      
+0000e030: 2020 7265 7475 726e 2042 6174 6368 6564    return Batched
+0000e040: 5661 6c75 6528 2a70 6169 7229 0a0a 0a64  Value(*pair)...d
+0000e050: 6566 2076 6563 746f 7269 7a65 645f 6261  ef vectorized_ba
+0000e060: 7463 6865 7228 7072 696d 2c20 6178 6973  tcher(prim, axis
+0000e070: 5f73 697a 652c 2062 6174 6368 6564 5f76  _size, batched_v
+0000e080: 616c 7565 732c 202a 2a6b 7761 7267 7329  alues, **kwargs)
+0000e090: 3a0a 2020 2020 6261 7463 685f 6469 6d20  :.    batch_dim 
+0000e0a0: 3d20 6261 7463 6865 645f 7661 6c75 6573  = batched_values
+0000e0b0: 5b30 5d2e 6261 7463 685f 6469 6d0a 2020  [0].batch_dim.  
+0000e0c0: 2020 6173 7365 7274 2061 6c6c 280a 2020    assert all(.  
+0000e0d0: 2020 2020 2020 6261 7463 685f 6469 6d20        batch_dim 
+0000e0e0: 3d3d 2062 762e 6261 7463 685f 6469 6d20  == bv.batch_dim 
+0000e0f0: 666f 7220 6276 2069 6e20 6261 7463 6865  for bv in batche
+0000e100: 645f 7661 6c75 6573 5b31 3a5d 0a20 2020  d_values[1:].   
+0000e110: 2029 2c20 6622 6076 6563 746f 7269 7a65   ), f"`vectorize
+0000e120: 645f 6261 7463 6865 7260 2067 6f74 2064  d_batcher` got d
+0000e130: 6966 6665 7265 6e74 2062 6174 6368 6564  ifferent batched
+0000e140: 2064 696d 656e 7369 6f6e 7320 7b5b 6276   dimensions {[bv
+0000e150: 2e62 6174 6368 5f64 696d 2066 6f72 2062  .batch_dim for b
+0000e160: 7620 696e 2062 6174 6368 6564 5f76 616c  v in batched_val
+0000e170: 7565 735d 7d22 0a20 2020 2072 6574 7572  ues]}".    retur
+0000e180: 6e20 4261 7463 6865 6456 616c 7565 2870  n BatchedValue(p
+0000e190: 7269 6d28 2a5b 6276 2e76 616c 7565 2066  rim(*[bv.value f
+0000e1a0: 6f72 2062 7620 696e 2062 6174 6368 6564  or bv in batched
+0000e1b0: 5f76 616c 7565 735d 2c20 2a2a 6b77 6172  _values], **kwar
+0000e1c0: 6773 292c 2062 6174 6368 5f64 696d 290a  gs), batch_dim).
+0000e1d0: 0a0a 6e6f 745f 6d61 7070 6564 203d 204e  ..not_mapped = N
+0000e1e0: 6f74 4d61 7070 6564 2829 0a0a 0a64 6566  otMapped()...def
+0000e1f0: 206d 6f76 6564 696d 2878 2c20 7372 633a   movedim(x, src:
+0000e200: 2069 6e74 2c20 6473 743a 2069 6e74 293a   int, dst: int):
+0000e210: 0a20 2020 2070 6572 6d20 3d20 5b69 2066  .    perm = [i f
+0000e220: 6f72 2069 2069 6e20 7261 6e67 6528 782e  or i in range(x.
+0000e230: 6e64 696d 2920 6966 2069 2021 3d20 7372  ndim) if i != sr
+0000e240: 635d 0a20 2020 2070 6572 6d2e 696e 7365  c].    perm.inse
+0000e250: 7274 2864 7374 2c20 7372 6329 0a20 2020  rt(dst, src).   
+0000e260: 2072 6574 7572 6e20 7072 696d 732e 7472   return prims.tr
+0000e270: 616e 7370 6f73 6528 782c 2074 7570 6c65  anspose(x, tuple
+0000e280: 2870 6572 6d29 290a 0a0a 6465 6620 6d6f  (perm))...def mo
+0000e290: 7665 5f62 6174 6368 5f64 696d 2861 7869  ve_batch_dim(axi
+0000e2a0: 735f 7369 7a65 2c20 7372 632c 2064 7374  s_size, src, dst
+0000e2b0: 2c20 7829 3a0a 2020 2020 6966 2073 7263  , x):.    if src
+0000e2c0: 2069 7320 6e6f 745f 6d61 7070 6564 3a0a   is not_mapped:.
+0000e2d0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0000e2e0: 7461 6e63 6528 782c 204e 756d 6265 7229  tance(x, Number)
+0000e2f0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000e300: 7475 726e 2078 0a20 2020 2020 2020 2074  turn x.        t
+0000e310: 6172 6765 745f 7368 6170 6520 3d20 6c69  arget_shape = li
+0000e320: 7374 2878 2e73 6861 7065 290a 2020 2020  st(x.shape).    
+0000e330: 2020 2020 7461 7267 6574 5f73 6861 7065      target_shape
+0000e340: 2e69 6e73 6572 7428 6473 742c 2061 7869  .insert(dst, axi
+0000e350: 735f 7369 7a65 290a 2020 2020 2020 2020  s_size).        
+0000e360: 6263 6173 745f 6469 6d73 203d 206c 6973  bcast_dims = lis
+0000e370: 7428 7261 6e67 6528 6c65 6e28 7461 7267  t(range(len(targ
+0000e380: 6574 5f73 6861 7065 2929 290a 2020 2020  et_shape))).    
+0000e390: 2020 2020 6263 6173 745f 6469 6d73 2e70      bcast_dims.p
+0000e3a0: 6f70 2864 7374 290a 2020 2020 2020 2020  op(dst).        
+0000e3b0: 7265 7475 726e 2070 7269 6d73 2e62 726f  return prims.bro
+0000e3c0: 6164 6361 7374 5f69 6e5f 6469 6d28 782c  adcast_in_dim(x,
+0000e3d0: 2074 6172 6765 745f 7368 6170 652c 2062   target_shape, b
+0000e3e0: 6361 7374 5f64 696d 7329 0a20 2020 2065  cast_dims).    e
+0000e3f0: 6c69 6620 7372 6320 3d3d 2064 7374 3a0a  lif src == dst:.
+0000e400: 2020 2020 2020 2020 7265 7475 726e 2078          return x
+0000e410: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0000e420: 2020 2072 6574 7572 6e20 6d6f 7665 6469     return movedi
+0000e430: 6d28 782c 2073 7263 2c20 6473 7429 0a0a  m(x, src, dst)..
+0000e440: 0a64 6566 2062 696e 6172 795f 6f70 5f62  .def binary_op_b
+0000e450: 6174 6368 696e 675f 7275 6c65 286f 703a  atching_rule(op:
+0000e460: 2070 7269 6d73 2e50 7269 6d49 4473 2c20   prims.PrimIDs, 
+0000e470: 6178 6973 5f73 697a 653a 2069 6e74 2c20  axis_size: int, 
+0000e480: 7661 6c73 5f69 6e3a 2042 6174 6368 6564  vals_in: Batched
+0000e490: 5661 6c75 6529 3a0a 2020 2020 2828 782c  Value):.    ((x,
+0000e4a0: 2078 5f62 6469 6d29 2c20 2879 2c20 795f   x_bdim), (y, y_
+0000e4b0: 6264 696d 2929 203d 2076 616c 735f 696e  bdim)) = vals_in
+0000e4c0: 0a20 2020 2069 6620 785f 6264 696d 2021  .    if x_bdim !
+0000e4d0: 3d20 795f 6264 696d 3a0a 2020 2020 2020  = y_bdim:.      
+0000e4e0: 2020 6966 2078 5f62 6469 6d20 6973 206e    if x_bdim is n
+0000e4f0: 6f74 5f6d 6170 7065 643a 0a20 2020 2020  ot_mapped:.     
+0000e500: 2020 2020 2020 2078 203d 206d 6f76 655f         x = move_
+0000e510: 6261 7463 685f 6469 6d28 6178 6973 5f73  batch_dim(axis_s
+0000e520: 697a 652c 2078 5f62 6469 6d2c 2079 5f62  ize, x_bdim, y_b
+0000e530: 6469 6d2c 2078 290a 2020 2020 2020 2020  dim, x).        
+0000e540: 2020 2020 785f 6264 696d 203d 2079 5f62      x_bdim = y_b
+0000e550: 6469 6d0a 2020 2020 2020 2020 656c 7365  dim.        else
+0000e560: 3a0a 2020 2020 2020 2020 2020 2020 7920  :.            y 
+0000e570: 3d20 6d6f 7665 5f62 6174 6368 5f64 696d  = move_batch_dim
+0000e580: 2861 7869 735f 7369 7a65 2c20 795f 6264  (axis_size, y_bd
+0000e590: 696d 2c20 785f 6264 696d 2c20 7929 0a20  im, x_bdim, y). 
+0000e5a0: 2020 2072 6574 7572 6e20 4261 7463 6865     return Batche
+0000e5b0: 6456 616c 7565 286f 7028 782c 2079 292c  dValue(op(x, y),
+0000e5c0: 2078 5f62 6469 6d29 0a0a 0a64 6566 2073   x_bdim)...def s
+0000e5d0: 696e 5f76 6d61 7028 6178 6973 5f73 697a  in_vmap(axis_siz
+0000e5e0: 653a 2069 6e74 2c20 613a 2042 6174 6368  e: int, a: Batch
+0000e5f0: 6564 5661 6c75 6529 202d 3e20 4261 7463  edValue) -> Batc
+0000e600: 6865 6456 616c 7565 3a0a 2020 2020 7265  hedValue:.    re
+0000e610: 7475 726e 2076 6563 746f 7269 7a65 645f  turn vectorized_
+0000e620: 6261 7463 6865 7228 7072 696d 732e 7369  batcher(prims.si
+0000e630: 6e2c 2061 7869 735f 7369 7a65 2c20 2861  n, axis_size, (a
+0000e640: 2c29 290a 0a0a 6465 6620 636f 735f 766d  ,))...def cos_vm
+0000e650: 6170 2861 7869 735f 7369 7a65 3a20 696e  ap(axis_size: in
+0000e660: 742c 2061 3a20 4261 7463 6865 6456 616c  t, a: BatchedVal
+0000e670: 7565 2920 2d3e 2042 6174 6368 6564 5661  ue) -> BatchedVa
+0000e680: 6c75 653a 0a20 2020 2072 6574 7572 6e20  lue:.    return 
+0000e690: 7665 6374 6f72 697a 6564 5f62 6174 6368  vectorized_batch
+0000e6a0: 6572 2870 7269 6d73 2e63 6f73 2c20 6178  er(prims.cos, ax
+0000e6b0: 6973 5f73 697a 652c 2028 612c 2929 0a0a  is_size, (a,))..
+0000e6c0: 0a64 6566 206d 756c 5f76 6d61 7028 6178  .def mul_vmap(ax
+0000e6d0: 6973 5f73 697a 653a 2069 6e74 2c20 613a  is_size: int, a:
+0000e6e0: 2042 6174 6368 6564 5661 6c75 652c 2062   BatchedValue, b
+0000e6f0: 3a20 4261 7463 6865 6456 616c 7565 2920  : BatchedValue) 
+0000e700: 2d3e 2042 6174 6368 6564 5661 6c75 653a  -> BatchedValue:
+0000e710: 0a20 2020 2072 6574 7572 6e20 6269 6e61  .    return bina
+0000e720: 7279 5f6f 705f 6261 7463 6869 6e67 5f72  ry_op_batching_r
+0000e730: 756c 6528 7072 696d 732e 6d75 6c2c 2061  ule(prims.mul, a
+0000e740: 7869 735f 7369 7a65 2c20 2861 2c20 6229  xis_size, (a, b)
+0000e750: 290a 0a0a 6465 6620 6164 645f 766d 6170  )...def add_vmap
+0000e760: 2861 7869 735f 7369 7a65 3a20 696e 742c  (axis_size: int,
+0000e770: 2061 3a20 4261 7463 6865 6456 616c 7565   a: BatchedValue
+0000e780: 2c20 623a 2042 6174 6368 6564 5661 6c75  , b: BatchedValu
+0000e790: 6529 202d 3e20 4261 7463 6865 6456 616c  e) -> BatchedVal
+0000e7a0: 7565 3a0a 2020 2020 7265 7475 726e 2062  ue:.    return b
+0000e7b0: 696e 6172 795f 6f70 5f62 6174 6368 696e  inary_op_batchin
+0000e7c0: 675f 7275 6c65 2870 7269 6d73 2e61 6464  g_rule(prims.add
+0000e7d0: 2c20 6178 6973 5f73 697a 652c 2028 612c  , axis_size, (a,
+0000e7e0: 2062 2929 0a0a 0a64 6566 2073 756d 5f76   b))...def sum_v
+0000e7f0: 6d61 7028 6178 6973 5f73 697a 653a 2069  map(axis_size: i
+0000e800: 6e74 2c20 613a 2042 6174 6368 6564 5661  nt, a: BatchedVa
+0000e810: 6c75 652c 2064 696d 733a 2053 6571 7565  lue, dims: Seque
+0000e820: 6e63 655b 696e 745d 2c20 2a2a 6b77 6172  nce[int], **kwar
+0000e830: 6773 2920 2d3e 2042 6174 6368 6564 5661  gs) -> BatchedVa
+0000e840: 6c75 653a 0a20 2020 2062 6469 6d20 3d20  lue:.    bdim = 
+0000e850: 612e 6261 7463 685f 6469 6d0a 2020 2020  a.batch_dim.    
+0000e860: 2320 544f 444f 3a20 7265 6d6f 7665 2074  # TODO: remove t
+0000e870: 6869 7320 7768 656e 2064 696d 7320 6265  his when dims be
+0000e880: 636f 6d65 7320 6120 6d61 6e64 6174 6f72  comes a mandator
+0000e890: 7920 6b77 6172 670a 2020 2020 6966 206c  y kwarg.    if l
+0000e8a0: 656e 2864 696d 7329 203e 2030 3a0a 2020  en(dims) > 0:.  
+0000e8b0: 2020 2020 2020 6469 6d73 2c20 5f20 3d20        dims, _ = 
+0000e8c0: 7361 6665 5f7a 6970 282a 6469 6d73 290a  safe_zip(*dims).
+0000e8d0: 2020 2020 6469 6d73 5f62 6566 6f72 6520      dims_before 
+0000e8e0: 3d20 7475 706c 6528 656c 2066 6f72 2065  = tuple(el for e
+0000e8f0: 6c20 696e 2064 696d 7320 6966 2065 6c20  l in dims if el 
+0000e900: 3c20 6264 696d 290a 2020 2020 6469 6d73  < bdim).    dims
+0000e910: 5f61 6674 6572 203d 2074 7570 6c65 2865  _after = tuple(e
+0000e920: 6c20 2b20 3120 666f 7220 656c 2069 6e20  l + 1 for el in 
+0000e930: 6469 6d73 2069 6620 656c 203e 3d20 6264  dims if el >= bd
+0000e940: 696d 290a 2020 2020 6261 7463 6865 645f  im).    batched_
+0000e950: 6469 6d73 203d 2064 696d 735f 6265 666f  dims = dims_befo
+0000e960: 7265 202b 2064 696d 735f 6166 7465 720a  re + dims_after.
+0000e970: 2020 2020 7265 7475 726e 2076 6563 746f      return vecto
+0000e980: 7269 7a65 645f 6261 7463 6865 7228 7072  rized_batcher(pr
+0000e990: 696d 732e 7375 6d2c 2061 7869 735f 7369  ims.sum, axis_si
+0000e9a0: 7a65 2c20 2861 2c29 2c20 6469 6d73 3d62  ze, (a,), dims=b
+0000e9b0: 6174 6368 6564 5f64 696d 732c 202a 2a6b  atched_dims, **k
+0000e9c0: 7761 7267 7329 0a0a 0a23 2054 4f44 4f3a  wargs)...# TODO:
+0000e9d0: 2050 6c65 6173 6520 7465 7374 2074 6869   Please test thi
+0000e9e0: 7320 6578 7465 6e73 6976 656c 790a 6465  s extensively.de
+0000e9f0: 6620 6272 6f61 6463 6173 745f 696e 5f64  f broadcast_in_d
+0000ea00: 696d 5f76 6d61 7028 0a20 2020 2061 7869  im_vmap(.    axi
+0000ea10: 735f 7369 7a65 3a20 696e 742c 2061 3a20  s_size: int, a: 
+0000ea20: 4261 7463 6865 6456 616c 7565 2c20 7368  BatchedValue, sh
+0000ea30: 6170 653a 2053 6571 7565 6e63 655b 4261  ape: Sequence[Ba
+0000ea40: 7463 6865 6456 616c 7565 5d2c 2062 726f  tchedValue], bro
+0000ea50: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
+0000ea60: 733a 2053 6571 7565 6e63 655b 4261 7463  s: Sequence[Batc
+0000ea70: 6865 6456 616c 7565 5d0a 2920 2d3e 2042  hedValue].) -> B
+0000ea80: 6174 6368 6564 5661 6c75 653a 0a20 2020  atchedValue:.   
+0000ea90: 2062 6469 6d20 3d20 612e 6261 7463 685f   bdim = a.batch_
+0000eaa0: 6469 6d0a 2020 2020 2320 544f 444f 3a20  dim.    # TODO: 
+0000eab0: 7265 6d6f 7665 2074 6869 7320 7768 656e  remove this when
+0000eac0: 2073 6861 7065 2061 6e64 2062 726f 6164   shape and broad
+0000ead0: 6361 7374 5f64 696d 656e 7369 6f6e 7320  cast_dimensions 
+0000eae0: 6265 636f 6d65 206d 616e 6461 746f 7279  become mandatory
+0000eaf0: 206b 7761 7267 730a 2020 2020 7368 6170   kwargs.    shap
+0000eb00: 652c 205f 203d 2073 6166 655f 7a69 7028  e, _ = safe_zip(
+0000eb10: 2a73 6861 7065 290a 2020 2020 6966 206c  *shape).    if l
+0000eb20: 656e 2862 726f 6164 6361 7374 5f64 696d  en(broadcast_dim
+0000eb30: 656e 7369 6f6e 7329 203e 2030 3a0a 2020  ensions) > 0:.  
+0000eb40: 2020 2020 2020 6272 6f61 6463 6173 745f        broadcast_
+0000eb50: 6469 6d65 6e73 696f 6e73 2c20 5f20 3d20  dimensions, _ = 
+0000eb60: 7361 6665 5f7a 6970 282a 6272 6f61 6463  safe_zip(*broadc
+0000eb70: 6173 745f 6469 6d65 6e73 696f 6e73 290a  ast_dimensions).
+0000eb80: 2020 2020 6966 2062 6469 6d20 6973 206e      if bdim is n
+0000eb90: 6f74 5f6d 6170 7065 643a 0a20 2020 2020  ot_mapped:.     
+0000eba0: 2020 2072 6574 7572 6e20 4261 7463 6865     return Batche
+0000ebb0: 6456 616c 7565 2870 7269 6d73 2e62 726f  dValue(prims.bro
+0000ebc0: 6164 6361 7374 5f69 6e5f 6469 6d28 612e  adcast_in_dim(a.
+0000ebd0: 7661 6c75 652c 2073 6861 7065 2c20 6272  value, shape, br
+0000ebe0: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
+0000ebf0: 6e73 292c 2062 6469 6d29 0a20 2020 2065  ns), bdim).    e
+0000ec00: 6c73 653a 0a20 2020 2020 2020 206e 6577  lse:.        new
+0000ec10: 5f62 6469 6d20 3d20 6264 696d 202b 2073  _bdim = bdim + s
+0000ec20: 756d 2831 2066 6f72 2064 696d 2069 6e20  um(1 for dim in 
+0000ec30: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
+0000ec40: 696f 6e73 2069 6620 6469 6d20 3c20 6264  ions if dim < bd
+0000ec50: 696d 290a 2020 2020 2020 2020 6e65 775f  im).        new_
+0000ec60: 7368 6170 6520 3d20 6c69 7374 2873 6861  shape = list(sha
+0000ec70: 7065 290a 2020 2020 2020 2020 6e65 775f  pe).        new_
+0000ec80: 7368 6170 652e 696e 7365 7274 286e 6577  shape.insert(new
+0000ec90: 5f62 6469 6d2c 2061 7869 735f 7369 7a65  _bdim, axis_size
+0000eca0: 290a 2020 2020 2020 2020 6e65 775f 6272  ).        new_br
+0000ecb0: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
+0000ecc0: 6e73 203d 2028 302c 2920 2b20 7475 706c  ns = (0,) + tupl
+0000ecd0: 6528 6469 6d20 2b20 3120 6966 2064 696d  e(dim + 1 if dim
+0000ece0: 203e 3d20 6264 696d 2065 6c73 6520 6469   >= bdim else di
+0000ecf0: 6d20 666f 7220 6469 6d20 696e 2062 726f  m for dim in bro
+0000ed00: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
+0000ed10: 7329 0a20 2020 2020 2020 2069 6620 6272  s).        if br
+0000ed20: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
+0000ed30: 6e73 203d 3d20 2829 3a0a 2020 2020 2020  ns == ():.      
+0000ed40: 2020 2020 2020 6e65 775f 6272 6f61 6463        new_broadc
+0000ed50: 6173 745f 6469 6d65 6e73 696f 6e73 203d  ast_dimensions =
+0000ed60: 2028 290a 2020 2020 2020 2020 7265 7475   ().        retu
+0000ed70: 726e 2042 6174 6368 6564 5661 6c75 6528  rn BatchedValue(
+0000ed80: 7072 696d 732e 6272 6f61 6463 6173 745f  prims.broadcast_
+0000ed90: 696e 5f64 696d 2861 2e76 616c 7565 2c20  in_dim(a.value, 
+0000eda0: 6e65 775f 7368 6170 652c 206e 6577 5f62  new_shape, new_b
+0000edb0: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
+0000edc0: 6f6e 7329 2c20 6e65 775f 6264 696d 290a  ons), new_bdim).
+0000edd0: 0a0a 766d 6170 5f69 6d70 6c73 3a20 6469  ..vmap_impls: di
+0000ede0: 6374 5b70 7269 6d73 2e53 796d 626f 6c2c  ct[prims.Symbol,
+0000edf0: 2043 616c 6c61 626c 655d 203d 2064 6963   Callable] = dic
+0000ee00: 7428 290a 0a0a 6465 6620 756e 7772 6170  t()...def unwrap
+0000ee10: 5f6f 6e65 5f6c 6576 656c 5f6f 665f 7375  _one_level_of_su
+0000ee20: 6273 796d 626f 6c73 2874 7261 6365 293a  bsymbols(trace):
+0000ee30: 0a20 2020 206e 6577 5f73 796d 626f 6c73  .    new_symbols
+0000ee40: 5f69 7465 7220 3d20 280a 2020 2020 2020  _iter = (.      
+0000ee50: 2020 626f 756e 645f 7379 6d62 6f6c 2e73    bound_symbol.s
+0000ee60: 7562 7379 6d62 6f6c 7320 6966 206c 656e  ubsymbols if len
+0000ee70: 2862 6f75 6e64 5f73 796d 626f 6c2e 7375  (bound_symbol.su
+0000ee80: 6273 796d 626f 6c73 2920 3e20 3020 656c  bsymbols) > 0 el
+0000ee90: 7365 205b 626f 756e 645f 7379 6d62 6f6c  se [bound_symbol
+0000eea0: 5d0a 2020 2020 2020 2020 666f 7220 626f  ].        for bo
+0000eeb0: 756e 645f 7379 6d62 6f6c 2069 6e20 7472  und_symbol in tr
+0000eec0: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
+0000eed0: 730a 2020 2020 290a 2020 2020 6e65 775f  s.    ).    new_
+0000eee0: 7379 6d62 6f6c 7320 3d20 6c69 7374 2863  symbols = list(c
+0000eef0: 6861 696e 2e66 726f 6d5f 6974 6572 6162  hain.from_iterab
+0000ef00: 6c65 286e 6577 5f73 796d 626f 6c73 5f69  le(new_symbols_i
+0000ef10: 7465 7229 290a 2020 2020 7472 6163 652e  ter)).    trace.
+0000ef20: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
+0000ef30: 6e65 775f 7379 6d62 6f6c 730a 2020 2020  new_symbols.    
+0000ef40: 7265 7475 726e 2074 7261 6365 0a0a 0a64  return trace...d
+0000ef50: 6566 2064 6563 6f6d 706f 7365 645f 666e  ef decomposed_fn
+0000ef60: 5f76 6d61 705f 7275 6c65 2861 7869 735f  _vmap_rule(axis_
+0000ef70: 7369 7a65 2c20 2a61 7267 732c 2066 6e2c  size, *args, fn,
+0000ef80: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+0000ef90: 6172 6773 2c20 696e 5f64 696d 7320 3d20  args, in_dims = 
+0000efa0: 756e 7a69 7032 2861 7267 7329 0a20 2020  unzip2(args).   
+0000efb0: 2075 6e62 6174 6368 6564 5f61 7267 7320   unbatched_args 
+0000efc0: 3d20 7472 6565 5f6d 6170 286c 616d 6264  = tree_map(lambd
+0000efd0: 6120 783a 2072 656d 6f76 655f 6261 7463  a x: remove_batc
+0000efe0: 685f 6469 6d28 7829 2069 6620 6973 696e  h_dim(x) if isin
+0000eff0: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
+0000f000: 5072 6f78 7929 2065 6c73 6520 782c 2061  Proxy) else x, a
+0000f010: 7267 7329 0a20 2020 2074 7261 6365 203d  rgs).    trace =
+0000f020: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
+0000f030: 2829 2866 6e2c 202a 756e 6261 7463 6865  ()(fn, *unbatche
+0000f040: 645f 6172 6773 2c20 2a2a 6b77 6172 6773  d_args, **kwargs
+0000f050: 290a 2020 2020 7472 6163 6520 3d20 756e  ).    trace = un
+0000f060: 7772 6170 5f6f 6e65 5f6c 6576 656c 5f6f  wrap_one_level_o
+0000f070: 665f 7375 6273 796d 626f 6c73 2874 7261  f_subsymbols(tra
+0000f080: 6365 290a 2020 2020 6f75 7473 203d 205f  ce).    outs = _
+0000f090: 766d 6170 5f63 616c 6c5f 6d65 7461 6675  vmap_call_metafu
+0000f0a0: 6e63 2846 616c 7365 2c20 6172 6773 2c20  nc(False, args, 
+0000f0b0: 696e 5f64 696d 732c 2030 2c20 6178 6973  in_dims, 0, axis
+0000f0c0: 5f73 697a 652c 2066 756e 6374 696f 6e5f  _size, function_
+0000f0d0: 7472 6163 653d 7472 6163 652c 202a 2a6b  trace=trace, **k
+0000f0e0: 7761 7267 7329 0a20 2020 2069 6620 6973  wargs).    if is
+0000f0f0: 696e 7374 616e 6365 286f 7574 732c 2053  instance(outs, S
+0000f100: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
+0000f110: 2020 6f75 745f 6469 6d73 203d 2028 302c    out_dims = (0,
+0000f120: 2920 2a20 6c65 6e28 6f75 7473 290a 2020  ) * len(outs).  
+0000f130: 2020 2020 2020 7265 7475 726e 2073 6166        return saf
+0000f140: 655f 6d61 7028 7061 6972 5f74 6f5f 6261  e_map(pair_to_ba
+0000f150: 7463 6865 645f 7661 6c75 652c 2073 6166  tched_value, saf
+0000f160: 655f 7a69 7028 6f75 7473 2c20 6f75 745f  e_zip(outs, out_
+0000f170: 6469 6d73 2929 0a20 2020 2072 6574 7572  dims)).    retur
+0000f180: 6e20 4261 7463 6865 6456 616c 7565 286f  n BatchedValue(o
+0000f190: 7574 732c 2030 290a 0a0a 766d 6170 5f69  uts, 0)...vmap_i
+0000f1a0: 6d70 6c73 5b70 7269 6d73 2e50 7269 6d49  mpls[prims.PrimI
+0000f1b0: 4473 2e53 494e 5d20 3d20 7369 6e5f 766d  Ds.SIN] = sin_vm
+0000f1c0: 6170 0a76 6d61 705f 696d 706c 735b 7072  ap.vmap_impls[pr
+0000f1d0: 696d 732e 5072 696d 4944 732e 434f 535d  ims.PrimIDs.COS]
+0000f1e0: 203d 2063 6f73 5f76 6d61 700a 766d 6170   = cos_vmap.vmap
+0000f1f0: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
+0000f200: 6d49 4473 2e4d 554c 5d20 3d20 6d75 6c5f  mIDs.MUL] = mul_
+0000f210: 766d 6170 0a76 6d61 705f 696d 706c 735b  vmap.vmap_impls[
+0000f220: 7072 696d 732e 5072 696d 4944 732e 4144  prims.PrimIDs.AD
+0000f230: 445d 203d 2061 6464 5f76 6d61 700a 766d  D] = add_vmap.vm
+0000f240: 6170 5f69 6d70 6c73 5b70 7269 6d73 2e50  ap_impls[prims.P
+0000f250: 7269 6d49 4473 2e53 554d 5d20 3d20 7375  rimIDs.SUM] = su
+0000f260: 6d5f 766d 6170 0a76 6d61 705f 696d 706c  m_vmap.vmap_impl
+0000f270: 735b 7072 696d 732e 5072 696d 4944 732e  s[prims.PrimIDs.
+0000f280: 4252 4f41 4443 4153 545f 494e 5f44 494d  BROADCAST_IN_DIM
+0000f290: 5d20 3d20 6272 6f61 6463 6173 745f 696e  ] = broadcast_in
+0000f2a0: 5f64 696d 5f76 6d61 700a 0a0a 6465 6620  _dim_vmap...def 
+0000f2b0: 766d 6170 5f73 796d 626f 6c5f 6d61 7070  vmap_symbol_mapp
+0000f2c0: 6572 2873 796d 626f 6c3a 2070 7269 6d73  er(symbol: prims
+0000f2d0: 2e53 796d 626f 6c2c 202a 2c20 6178 6973  .Symbol, *, axis
+0000f2e0: 5f73 697a 653a 2069 6e74 293a 0a20 2020  _size: int):.   
+0000f2f0: 2022 2222 4d61 7073 2061 2073 796d 626f   """Maps a symbo
+0000f300: 6c20 746f 2061 2076 6d61 7020 6675 6e63  l to a vmap func
+0000f310: 7469 6f6e 2074 6861 7420 6576 616c 7561  tion that evalua
+0000f320: 7465 7320 6974 2e0a 0a20 2020 2041 7267  tes it...    Arg
+0000f330: 733a 0a20 2020 2020 2020 2073 796d 626f  s:.        symbo
+0000f340: 6c20 2870 7269 6d73 2e53 796d 626f 6c29  l (prims.Symbol)
+0000f350: 3a20 5379 6d62 6f6c 2074 6f20 6576 616c  : Symbol to eval
+0000f360: 7561 7465 2e0a 0a20 2020 2052 6169 7365  uate...    Raise
+0000f370: 733a 0a20 2020 2020 2020 204e 6f74 496d  s:.        NotIm
+0000f380: 706c 656d 656e 7465 6445 7272 6f72 3a20  plementedError: 
+0000f390: 4966 2074 6865 2076 6d61 7020 666f 7220  If the vmap for 
+0000f3a0: 7468 6520 7379 6d62 6f6c 2069 7320 6e6f  the symbol is no
+0000f3b0: 7420 696d 706c 656d 656e 7465 642e 0a0a  t implemented...
+0000f3c0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0000f3d0: 2020 2020 2043 616c 6c61 626c 653a 2076       Callable: v
+0000f3e0: 6d61 7020 6675 6e63 7469 6f6e 2074 6861  map function tha
+0000f3f0: 7420 6576 616c 7561 7465 7320 7468 6520  t evaluates the 
+0000f400: 7379 6d62 6f6c 2e0a 2020 2020 2222 220a  symbol..    """.
+0000f410: 0a20 2020 2064 6566 2077 7261 705f 6172  .    def wrap_ar
+0000f420: 6728 7829 3a0a 2020 2020 2020 2020 6966  g(x):.        if
+0000f430: 2069 7369 6e73 7461 6e63 6528 782c 2042   isinstance(x, B
+0000f440: 6174 6368 6564 5661 6c75 6529 3a0a 2020  atchedValue):.  
+0000f450: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000f460: 2078 0a20 2020 2020 2020 2065 6c69 6620   x.        elif 
+0000f470: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
+0000f480: 6d62 6572 293a 0a20 2020 2020 2020 2020  mber):.         
+0000f490: 2020 2072 6574 7572 6e20 4261 7463 6865     return Batche
+0000f4a0: 6456 616c 7565 2878 2c20 6e6f 745f 6d61  dValue(x, not_ma
+0000f4b0: 7070 6564 290a 2020 2020 2020 2020 656c  pped).        el
+0000f4c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000f4d0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+0000f4e0: 2866 2276 6d61 7020 7772 6170 5f61 7267  (f"vmap wrap_arg
+0000f4f0: 2067 6f74 2061 6e20 756e 7375 7070 6f72   got an unsuppor
+0000f500: 7465 6420 7479 7065 207b 7479 7065 2878  ted type {type(x
+0000f510: 297d 2229 0a0a 2020 2020 6966 2073 796d  )}")..    if sym
+0000f520: 626f 6c2e 6172 655f 616c 6c5f 6172 6773  bol.are_all_args
+0000f530: 5f63 6f6e 7374 616e 743a 0a0a 2020 2020  _constant:..    
+0000f540: 2020 2020 6465 6620 5f76 6d61 705f 696d      def _vmap_im
+0000f550: 706c 5f63 6f6e 7374 2873 796d 626f 6c2c  pl_const(symbol,
+0000f560: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
+0000f570: 293a 0a20 2020 2020 2020 2020 2020 206f  ):.            o
+0000f580: 7574 203d 2073 796d 626f 6c5f 746f 5f65  ut = symbol_to_e
+0000f590: 7661 6c28 7379 6d62 6f6c 2928 2a61 7267  val(symbol)(*arg
+0000f5a0: 732c 202a 2a6b 7761 7267 7329 0a0a 2020  s, **kwargs)..  
+0000f5b0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+0000f5c0: 6e73 7461 6e63 6528 6f75 742c 2053 6571  nstance(out, Seq
+0000f5d0: 7565 6e63 6529 3a0a 2020 2020 2020 2020  uence):.        
+0000f5e0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0000f5f0: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
+0000f600: 6261 7463 6865 645f 7661 6c75 652c 2073  batched_value, s
+0000f610: 6166 655f 7a69 7028 6172 6773 2c20 5b6e  afe_zip(args, [n
+0000f620: 6f74 5f6d 6170 7065 645d 202a 206c 656e  ot_mapped] * len
+0000f630: 286f 7574 2929 290a 0a20 2020 2020 2020  (out)))..       
+0000f640: 2020 2020 2072 6574 7572 6e20 4261 7463       return Batc
+0000f650: 6865 6456 616c 7565 286f 7574 2c20 6e6f  hedValue(out, no
+0000f660: 745f 6d61 7070 6564 290a 0a20 2020 2020  t_mapped)..     
+0000f670: 2020 2072 6574 7572 6e20 7061 7274 6961     return partia
+0000f680: 6c28 5f76 6d61 705f 696d 706c 5f63 6f6e  l(_vmap_impl_con
+0000f690: 7374 2c20 7379 6d62 6f6c 290a 0a20 2020  st, symbol)..   
+0000f6a0: 2076 6d61 705f 696d 706c 203d 2076 6d61   vmap_impl = vma
+0000f6b0: 705f 696d 706c 732e 6765 7428 7379 6d62  p_impls.get(symb
+0000f6c0: 6f6c 2e73 796d 2e69 6429 0a20 2020 2069  ol.sym.id).    i
+0000f6d0: 6620 766d 6170 5f69 6d70 6c20 6973 204e  f vmap_impl is N
+0000f6e0: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
+0000f6f0: 6c65 6e28 7379 6d62 6f6c 2e73 7562 7379  len(symbol.subsy
+0000f700: 6d62 6f6c 7329 203e 2030 3a0a 2020 2020  mbols) > 0:.    
+0000f710: 2020 2020 2020 2020 766d 6170 5f69 6d70          vmap_imp
+0000f720: 6c20 3d20 7061 7274 6961 6c28 6465 636f  l = partial(deco
+0000f730: 6d70 6f73 6564 5f66 6e5f 766d 6170 5f72  mposed_fn_vmap_r
+0000f740: 756c 652c 2066 6e3d 7379 6d62 6f6c 2e73  ule, fn=symbol.s
+0000f750: 796d 290a 2020 2020 2020 2020 656c 7365  ym).        else
+0000f760: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0000f770: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
+0000f780: 6564 4572 726f 7228 6622 766d 6170 2066  edError(f"vmap f
+0000f790: 6f72 207b 7379 6d62 6f6c 2e73 796d 2e69  or {symbol.sym.i
+0000f7a0: 647d 2069 7320 6e6f 7420 696d 706c 656d  d} is not implem
+0000f7b0: 656e 7465 6422 290a 0a20 2020 2064 6566  ented")..    def
+0000f7c0: 205f 766d 6170 5f69 6d70 6c28 2a61 7267   _vmap_impl(*arg
+0000f7d0: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+0000f7e0: 2020 2020 2020 6172 6773 203d 2074 7265        args = tre
+0000f7f0: 655f 6d61 7028 7772 6170 5f61 7267 2c20  e_map(wrap_arg, 
+0000f800: 6172 6773 290a 2020 2020 2020 2020 6173  args).        as
+0000f810: 7365 7274 2061 6c6c 2869 7369 6e73 7461  sert all(isinsta
+0000f820: 6e63 6528 6172 672c 2042 6174 6368 6564  nce(arg, Batched
+0000f830: 5661 6c75 6529 2066 6f72 2061 7267 2069  Value) for arg i
+0000f840: 6e20 7472 6565 5f66 6c61 7474 656e 2861  n tree_flatten(a
+0000f850: 7267 7329 5b30 5d29 0a20 2020 2020 2020  rgs)[0]).       
+0000f860: 2072 6574 7572 6e20 766d 6170 5f69 6d70   return vmap_imp
+0000f870: 6c28 6178 6973 5f73 697a 652c 202a 6172  l(axis_size, *ar
+0000f880: 6773 2c20 2a2a 6b77 6172 6773 290a 0a20  gs, **kwargs).. 
+0000f890: 2020 2072 6574 7572 6e20 5f76 6d61 705f     return _vmap_
+0000f8a0: 696d 706c 0a0a 0a64 6566 2072 656d 6f76  impl...def remov
+0000f8b0: 655f 6261 7463 685f 6469 6d28 7465 6e73  e_batch_dim(tens
+0000f8c0: 6f72 3a20 5465 6e73 6f72 5072 6f78 792c  or: TensorProxy,
+0000f8d0: 2062 6174 6368 5f64 696d 3a20 696e 7420   batch_dim: int 
+0000f8e0: 3d20 3029 202d 3e20 5465 6e73 6f72 5072  = 0) -> TensorPr
+0000f8f0: 6f78 793a 0a20 2020 2022 2222 5265 6d6f  oxy:.    """Remo
+0000f900: 7665 7320 7468 6520 6261 7463 6820 6469  ves the batch di
+0000f910: 6d65 6e73 696f 6e20 6672 6f6d 2061 2074  mension from a t
+0000f920: 656e 736f 722e 0a0a 2020 2020 4172 6773  ensor...    Args
+0000f930: 3a0a 2020 2020 2020 2020 7465 6e73 6f72  :.        tensor
+0000f940: 2028 5465 6e73 6f72 5072 6f78 7929 3a20   (TensorProxy): 
+0000f950: 5465 6e73 6f72 2074 6f20 7265 6d6f 7665  Tensor to remove
+0000f960: 2074 6865 2062 6174 6368 2064 696d 656e   the batch dimen
+0000f970: 7369 6f6e 2066 726f 6d2e 0a0a 2020 2020  sion from...    
+0000f980: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+0000f990: 2054 656e 736f 7250 726f 7879 3a20 5465   TensorProxy: Te
+0000f9a0: 6e73 6f72 2077 6974 6820 7468 6520 6261  nsor with the ba
+0000f9b0: 7463 6820 6469 6d65 6e73 696f 6e20 7265  tch dimension re
+0000f9c0: 6d6f 7665 642e 0a20 2020 2022 2222 0a20  moved..    """. 
+0000f9d0: 2020 206e 6577 5f73 6861 7065 203d 2074     new_shape = t
+0000f9e0: 656e 736f 722e 7368 6170 655b 3a62 6174  ensor.shape[:bat
+0000f9f0: 6368 5f64 696d 5d20 2b20 7465 6e73 6f72  ch_dim] + tensor
+0000fa00: 2e73 6861 7065 5b62 6174 6368 5f64 696d  .shape[batch_dim
+0000fa10: 202b 2031 203a 5d0a 2020 2020 7265 7475   + 1 :].    retu
+0000fa20: 726e 2054 656e 736f 7250 726f 7879 286c  rn TensorProxy(l
+0000fa30: 696b 653d 7465 6e73 6f72 2c20 7368 6170  ike=tensor, shap
+0000fa40: 653d 6e65 775f 7368 6170 6529 0a0a 0a23  e=new_shape)...#
+0000fa50: 2054 4f44 4f3a 2069 6e20 4a41 5820 6172   TODO: in JAX ar
+0000fa60: 6773 2c20 696e 5f64 696d 7320 6172 6520  gs, in_dims are 
+0000fa70: 666c 6174 7465 6e65 6420 7468 6520 7361  flattened the sa
+0000fa80: 6d65 2077 6179 0a23 2054 4f44 4f3a 2069  me way.# TODO: i
+0000fa90: 6e20 4a41 5820 6f75 745f 6469 6d73 2061  n JAX out_dims a
+0000faa0: 7265 2066 6c61 7474 656e 6564 2061 7320  re flattened as 
+0000fab0: 7765 6c6c 0a64 6566 205f 766d 6170 5f63  well.def _vmap_c
+0000fac0: 616c 6c5f 6d65 7461 6675 6e63 2864 6574  all_metafunc(det
+0000fad0: 6163 6865 643a 2062 6f6f 6c2c 2061 7267  ached: bool, arg
+0000fae0: 732c 2069 6e5f 6469 6d73 2c20 6f75 745f  s, in_dims, out_
+0000faf0: 6469 6d73 2c20 6178 6973 5f73 697a 652c  dims, axis_size,
+0000fb00: 2066 756e 6374 696f 6e5f 7472 6163 653a   function_trace:
+0000fb10: 2054 7261 6365 2c20 2a2a 6b77 6172 6773   Trace, **kwargs
+0000fb20: 293a 0a20 2020 2022 2222 4d65 7461 6675  ):.    """Metafu
+0000fb30: 6e63 7469 6f6e 2066 6f72 2076 6d61 7020  nction for vmap 
+0000fb40: 6361 6c6c 2e0a 0a20 2020 2041 7267 733a  call...    Args:
+0000fb50: 0a20 2020 2020 2020 2064 6574 6163 6865  .        detache
+0000fb60: 6420 2862 6f6f 6c29 3a20 5768 6574 6865  d (bool): Whethe
+0000fb70: 7220 746f 2064 6574 6163 6820 7468 6520  r to detach the 
+0000fb80: 7472 6163 652e 0a20 2020 2020 2020 2061  trace..        a
+0000fb90: 7267 7320 2854 7570 6c65 5b50 726f 7879  rgs (Tuple[Proxy
+0000fba0: 5d29 3a20 4172 6775 6d65 6e74 7320 746f  ]): Arguments to
+0000fbb0: 2074 6865 2066 756e 6374 696f 6e2e 0a20   the function.. 
+0000fbc0: 2020 2020 2020 2069 6e5f 6469 6d73 2028         in_dims (
+0000fbd0: 5475 706c 655b 696e 745d 293a 2042 6174  Tuple[int]): Bat
+0000fbe0: 6368 2064 696d 656e 7369 6f6e 2066 6f72  ch dimension for
+0000fbf0: 2065 6163 6820 6172 6775 6d65 6e74 2e0a   each argument..
+0000fc00: 2020 2020 2020 2020 6f75 745f 6469 6d73          out_dims
+0000fc10: 2028 5475 706c 655b 696e 745d 293a 2042   (Tuple[int]): B
+0000fc20: 6174 6368 2064 696d 656e 7369 6f6e 2066  atch dimension f
+0000fc30: 6f72 2072 6574 7572 6e20 7661 6c75 6573  or return values
+0000fc40: 2e0a 2020 2020 2020 2020 6675 6e63 7469  ..        functi
+0000fc50: 6f6e 5f74 7261 6365 2028 5472 6163 6529  on_trace (Trace)
+0000fc60: 3a20 5472 6163 6520 746f 2075 7365 2066  : Trace to use f
+0000fc70: 6f72 2074 6865 2066 756e 6374 696f 6e2e  or the function.
+0000fc80: 0a20 2020 2020 2020 206b 7761 7267 733a  .        kwargs:
+0000fc90: 204b 6579 776f 7264 2061 7267 756d 656e   Keyword argumen
+0000fca0: 7473 2e0a 0a20 2020 2052 6169 7365 733a  ts...    Raises:
+0000fcb0: 0a20 2020 2020 2020 2041 7373 6572 7469  .        Asserti
+0000fcc0: 6f6e 4572 726f 723a 2049 6620 7468 6520  onError: If the 
+0000fcd0: 766d 6170 2066 6f72 206b 6579 776f 7264  vmap for keyword
+0000fce0: 2061 7267 756d 656e 7473 2069 7320 6e6f   arguments is no
+0000fcf0: 7420 696d 706c 656d 656e 7465 642e 0a0a  t implemented...
+0000fd00: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0000fd10: 2020 2020 2052 6573 756c 7420 6f66 2074       Result of t
+0000fd20: 6865 2076 6d61 7020 7472 616e 7366 6f72  he vmap transfor
+0000fd30: 6d2e 0a20 2020 2022 2222 0a20 2020 2063  m..    """.    c
+0000fd40: 6f6d 6d6f 6e5f 6465 7669 6365 203d 207b  ommon_device = {
+0000fd50: 782e 6465 7669 6365 2066 6f72 2078 2069  x.device for x i
+0000fd60: 6e20 6172 6773 2069 6620 6973 696e 7374  n args if isinst
+0000fd70: 616e 6365 2878 2c20 5465 6e73 6f72 5072  ance(x, TensorPr
+0000fd80: 6f78 7929 7d0a 2020 2020 6173 7365 7274  oxy)}.    assert
+0000fd90: 206c 656e 2863 6f6d 6d6f 6e5f 6465 7669   len(common_devi
+0000fda0: 6365 2920 3c3d 2031 2c20 2276 6d61 7020  ce) <= 1, "vmap 
+0000fdb0: 666f 7220 6d75 6c74 6970 6c65 2064 6576  for multiple dev
+0000fdc0: 6963 6573 2069 7320 6e6f 7420 696d 706c  ices is not impl
+0000fdd0: 656d 656e 7465 6422 0a20 2020 2028 636f  emented".    (co
+0000fde0: 6d6d 6f6e 5f64 6576 6963 652c 2920 3d20  mmon_device,) = 
+0000fdf0: 636f 6d6d 6f6e 5f64 6576 6963 6520 6966  common_device if
+0000fe00: 206c 656e 2863 6f6d 6d6f 6e5f 6465 7669   len(common_devi
+0000fe10: 6365 2920 3d3d 2031 2065 6c73 6520 2863  ce) == 1 else (c
+0000fe20: 7075 2c29 0a0a 2020 2020 6966 2061 7869  pu,)..    if axi
+0000fe30: 735f 7369 7a65 2069 7320 4e6f 6e65 3a0a  s_size is None:.
+0000fe40: 2020 2020 2020 2020 2861 7869 735f 7369          (axis_si
+0000fe50: 7a65 2c29 203d 207b 782e 7368 6170 655b  ze,) = {x.shape[
+0000fe60: 6178 5d20 666f 7220 782c 2061 7820 696e  ax] for x, ax in
+0000fe70: 207a 6970 2861 7267 732c 2069 6e5f 6469   zip(args, in_di
+0000fe80: 6d73 2920 6966 2061 7820 6973 206e 6f74  ms) if ax is not
+0000fe90: 206e 6f74 5f6d 6170 7065 647d 0a20 2020   not_mapped}.   
+0000fea0: 2069 6e5f 6469 6d73 203d 2069 6e5f 6469   in_dims = in_di
+0000feb0: 6d73 2069 6620 6973 696e 7374 616e 6365  ms if isinstance
+0000fec0: 2869 6e5f 6469 6d73 2c20 5365 7175 656e  (in_dims, Sequen
+0000fed0: 6365 2920 656c 7365 2028 696e 5f64 696d  ce) else (in_dim
+0000fee0: 732c 290a 2020 2020 696e 5f64 696d 7320  s,).    in_dims 
+0000fef0: 3d20 7475 706c 6528 6e6f 745f 6d61 7070  = tuple(not_mapp
+0000ff00: 6564 2069 6620 6973 696e 7374 616e 6365  ed if isinstance
+0000ff10: 2861 2c20 4e75 6d62 6572 2920 656c 7365  (a, Number) else
+0000ff20: 2064 2066 6f72 2061 2c20 6420 696e 2073   d for a, d in s
+0000ff30: 6166 655f 7a69 7028 6172 6773 2c20 696e  afe_zip(args, in
+0000ff40: 5f64 696d 7329 290a 2020 2020 6f75 745f  _dims)).    out_
+0000ff50: 6469 6d73 203d 206f 7574 5f64 696d 7320  dims = out_dims 
+0000ff60: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
+0000ff70: 745f 6469 6d73 2c20 5365 7175 656e 6365  t_dims, Sequence
+0000ff80: 2920 656c 7365 2028 6f75 745f 6469 6d73  ) else (out_dims
+0000ff90: 2c29 0a0a 2020 2020 6374 7820 3d20 6465  ,)..    ctx = de
+0000ffa0: 7461 6368 6564 5f74 7261 6365 2829 2069  tached_trace() i
+0000ffb0: 6620 6465 7461 6368 6564 2065 6c73 6520  f detached else 
+0000ffc0: 6e75 6c6c 636f 6e74 6578 7428 290a 2020  nullcontext().  
+0000ffd0: 2020 7769 7468 2063 7478 3a0a 2020 2020    with ctx:.    
+0000ffe0: 2020 2020 2320 5765 2070 726f 7061 6761      # We propaga
+0000fff0: 7465 2074 6865 2042 6174 6368 5661 6c75  te the BatchValu
+00010000: 6520 7468 726f 7567 6820 7468 6520 7472  e through the tr
+00010010: 6163 652c 2061 6e64 2074 6865 6e20 756e  ace, and then un
+00010020: 7772 6170 2069 7420 6174 2074 6865 2065  wrap it at the e
+00010030: 6e64 0a20 2020 2020 2020 2062 6174 6368  nd.        batch
+00010040: 6564 5f61 7267 7320 3d20 7361 6665 5f6d  ed_args = safe_m
+00010050: 6170 2870 6169 725f 746f 5f62 6174 6368  ap(pair_to_batch
+00010060: 6564 5f76 616c 7565 2c20 7361 6665 5f7a  ed_value, safe_z
+00010070: 6970 2861 7267 732c 2069 6e5f 6469 6d73  ip(args, in_dims
+00010080: 2929 0a20 2020 2020 2020 2072 6573 756c  )).        resul
+00010090: 7420 3d20 6576 616c 5f74 7261 6365 280a  t = eval_trace(.
+000100a0: 2020 2020 2020 2020 2020 2020 6675 6e63              func
+000100b0: 7469 6f6e 5f74 7261 6365 2c20 2a62 6174  tion_trace, *bat
+000100c0: 6368 6564 5f61 7267 732c 2073 796d 626f  ched_args, symbo
+000100d0: 6c5f 6d61 7070 6572 3d70 6172 7469 616c  l_mapper=partial
+000100e0: 2876 6d61 705f 7379 6d62 6f6c 5f6d 6170  (vmap_symbol_map
+000100f0: 7065 722c 2061 7869 735f 7369 7a65 3d61  per, axis_size=a
+00010100: 7869 735f 7369 7a65 292c 202a 2a6b 7761  xis_size), **kwa
+00010110: 7267 730a 2020 2020 2020 2020 290a 2020  rgs.        ).  
+00010120: 2020 2020 2020 2320 556e 7772 6170 7069        # Unwrappi
+00010130: 6e67 2074 6865 2042 6174 6368 6564 5661  ng the BatchedVa
+00010140: 6c75 6527 730a 2020 2020 2020 2020 6966  lue's.        if
+00010150: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
+00010160: 6c74 2c20 5365 7175 656e 6365 293a 0a20  lt, Sequence):. 
+00010170: 2020 2020 2020 2020 2020 2066 6c61 745f             flat_
+00010180: 7265 7375 6c74 2c20 7370 6563 203d 2074  result, spec = t
+00010190: 7265 655f 666c 6174 7465 6e28 7265 7375  ree_flatten(resu
+000101a0: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
+000101b0: 6173 7365 7274 2061 6c6c 2869 7369 6e73  assert all(isins
+000101c0: 7461 6e63 6528 782c 2042 6174 6368 6564  tance(x, Batched
+000101d0: 5661 6c75 6529 2066 6f72 2078 2069 6e20  Value) for x in 
+000101e0: 666c 6174 5f72 6573 756c 7429 0a20 2020  flat_result).   
+000101f0: 2020 2020 2020 2020 206f 7574 732c 2062           outs, b
+00010200: 6469 6d73 203d 2075 6e7a 6970 3228 666c  dims = unzip2(fl
+00010210: 6174 5f72 6573 756c 7429 0a20 2020 2020  at_result).     
+00010220: 2020 2020 2020 2023 2054 4f44 4f3a 2068         # TODO: h
+00010230: 616e 646c 6520 7468 6520 6361 7365 2077  andle the case w
+00010240: 6865 7265 206f 7574 5f64 696d 7320 6973  here out_dims is
+00010250: 2061 2073 696e 676c 6520 7661 6c75 6520   a single value 
+00010260: 6265 7474 6572 0a20 2020 2020 2020 2020  better.         
+00010270: 2020 2069 6620 6c65 6e28 6f75 745f 6469     if len(out_di
+00010280: 6d73 2920 3d3d 2031 3a0a 2020 2020 2020  ms) == 1:.      
+00010290: 2020 2020 2020 2020 2020 6f75 745f 6469            out_di
+000102a0: 6d73 203d 206f 7574 5f64 696d 7320 2a20  ms = out_dims * 
+000102b0: 6c65 6e28 6f75 7473 290a 2020 2020 2020  len(outs).      
+000102c0: 2020 2020 2020 6f75 7473 203d 2073 6166        outs = saf
+000102d0: 655f 6d61 7028 7061 7274 6961 6c28 6d6f  e_map(partial(mo
+000102e0: 7665 5f62 6174 6368 5f64 696d 2c20 6178  ve_batch_dim, ax
+000102f0: 6973 5f73 697a 6529 2c20 6264 696d 732c  is_size), bdims,
+00010300: 206f 7574 5f64 696d 732c 206f 7574 7329   out_dims, outs)
+00010310: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00010320: 7572 6e20 7472 6565 5f75 6e66 6c61 7474  urn tree_unflatt
+00010330: 656e 286f 7574 732c 2073 7065 6329 0a20  en(outs, spec). 
+00010340: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00010350: 616e 6365 2872 6573 756c 742c 204e 756d  ance(result, Num
+00010360: 6265 7229 2061 6e64 2061 7869 735f 7369  ber) and axis_si
+00010370: 7a65 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ze is not None:.
+00010380: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
+00010390: 444f 3a20 6665 7463 6820 7468 6520 6465  DO: fetch the de
+000103a0: 6661 756c 7420 6465 7669 6365 2066 726f  fault device fro
+000103b0: 6d20 7468 6520 636f 6e74 6578 740a 2020  m the context.  
+000103c0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+000103d0: 203d 2066 756c 6c28 7368 6170 653d 2829   = full(shape=()
+000103e0: 2c20 6669 6c6c 5f76 616c 7565 3d72 6573  , fill_value=res
+000103f0: 756c 742c 2064 6576 6963 653d 636f 6d6d  ult, device=comm
+00010400: 6f6e 5f64 6576 6963 6529 0a20 2020 2020  on_device).     
+00010410: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00010420: 4261 7463 6865 6456 616c 7565 2872 6573  BatchedValue(res
+00010430: 756c 742c 206e 6f74 5f6d 6170 7065 6429  ult, not_mapped)
+00010440: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
+00010450: 696e 7374 616e 6365 2872 6573 756c 742c  instance(result,
+00010460: 2042 6174 6368 6564 5661 6c75 6529 2061   BatchedValue) a
+00010470: 6e64 2069 7369 6e73 7461 6e63 6528 7265  nd isinstance(re
+00010480: 7375 6c74 2e76 616c 7565 2c20 4e75 6d62  sult.value, Numb
+00010490: 6572 2920 616e 6420 6178 6973 5f73 697a  er) and axis_siz
+000104a0: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
+000104b0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+000104c0: 7420 3d20 4261 7463 6865 6456 616c 7565  t = BatchedValue
+000104d0: 2866 756c 6c28 7368 6170 653d 2829 2c20  (full(shape=(), 
+000104e0: 6669 6c6c 5f76 616c 7565 3d72 6573 756c  fill_value=resul
+000104f0: 742e 7661 6c75 652c 2064 6576 6963 653d  t.value, device=
+00010500: 636f 6d6d 6f6e 5f64 6576 6963 6529 2c20  common_device), 
+00010510: 7265 7375 6c74 2e62 6174 6368 5f64 696d  result.batch_dim
+00010520: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+00010530: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
+00010540: 6c74 2c20 4261 7463 6865 6456 616c 7565  lt, BatchedValue
+00010550: 290a 2020 2020 2020 2020 6f75 7420 3d20  ).        out = 
+00010560: 6d6f 7665 5f62 6174 6368 5f64 696d 2861  move_batch_dim(a
+00010570: 7869 735f 7369 7a65 2c20 7265 7375 6c74  xis_size, result
+00010580: 2e62 6174 6368 5f64 696d 2c20 6f75 745f  .batch_dim, out_
+00010590: 6469 6d73 5b30 5d2c 2072 6573 756c 742e  dims[0], result.
+000105a0: 7661 6c75 6529 0a20 2020 2020 2020 2072  value).        r
+000105b0: 6574 7572 6e20 6f75 740a 0a0a 766d 6170  eturn out...vmap
+000105c0: 5f63 616c 6c20 3d20 5379 6d62 6f6c 2869  _call = Symbol(i
+000105d0: 643d 5472 616e 7366 6f72 6d73 2e56 6d61  d=Transforms.Vma
+000105e0: 704f 702c 206e 616d 653d 2276 6d61 705f  pOp, name="vmap_
+000105f0: 6361 6c6c 222c 206d 6574 613d 7061 7274  call", meta=part
+00010600: 6961 6c28 5f76 6d61 705f 6361 6c6c 5f6d  ial(_vmap_call_m
+00010610: 6574 6166 756e 632c 2046 616c 7365 2929  etafunc, False))
+00010620: 0a0a 0a23 2054 4f44 4f3a 2068 6f77 2073  ...# TODO: how s
+00010630: 686f 756c 6420 7765 2068 616e 646c 6520  hould we handle 
+00010640: 6f75 745f 6469 6d73 2068 6572 653f 0a23  out_dims here?.#
+00010650: 2061 6c74 686f 7567 6820 6865 7265 2077   although here w
+00010660: 6520 6172 6520 6361 6c6c 696e 6720 766d  e are calling vm
+00010670: 6170 206f 6620 6964 656e 7469 7479 2c20  ap of identity, 
+00010680: 736f 2077 6520 7368 6f75 6c64 206b 6e6f  so we should kno
+00010690: 7720 6672 6f6d 2074 6865 2063 616c 6c20  w from the call 
+000106a0: 746f 2076 6d61 700a 2320 5468 6973 2073  to vmap.# This s
+000106b0: 686f 756c 6420 6265 2066 696e 652e 2049  hould be fine. I
+000106c0: 6620 7765 2068 6176 6520 766d 6170 2869  f we have vmap(i
+000106d0: 6465 6e74 6974 7928 6675 6e63 292c 206f  dentity(func), o
+000106e0: 7574 5f64 696d 733d 4e29 2074 6865 6e20  ut_dims=N) then 
+000106f0: 7468 6973 2072 756c 6520 6973 2066 6972  this rule is fir
+00010700: 7374 2075 7365 640a 2320 746f 2067 6574  st used.# to get
+00010710: 2074 6865 2076 6d61 7070 6564 2072 6573   the vmapped res
+00010720: 756c 7420 6f66 2069 6465 6e74 6974 7928  ult of identity(
+00010730: 6675 6e63 2920 696e 2076 6d61 705f 7379  func) in vmap_sy
+00010740: 6d62 6f6c 5f6d 6170 7065 722c 2061 6e64  mbol_mapper, and
+00010750: 206f 7574 5f64 696d 7320 6973 2068 616e   out_dims is han
+00010760: 646c 6564 0a23 2061 6674 6572 2074 6861  dled.# after tha
+00010770: 7420 696e 2074 6865 206f 7574 6572 205f  t in the outer _
+00010780: 766d 6170 5f63 616c 6c5f 6d65 7461 6675  vmap_call_metafu
+00010790: 6e63 2e0a 6465 6620 5f69 6465 6e74 6974  nc..def _identit
+000107a0: 795f 6361 6c6c 5f76 6d61 7028 6178 6973  y_call_vmap(axis
+000107b0: 5f73 697a 652c 202a 6261 7463 6865 645f  _size, *batched_
+000107c0: 6172 6773 2c20 7472 6163 653a 2054 7261  args, trace: Tra
+000107d0: 6365 2c20 2a2a 6b77 6172 6773 293a 0a20  ce, **kwargs):. 
+000107e0: 2020 2061 7267 732c 2069 6e5f 6469 6d73     args, in_dims
+000107f0: 203d 2075 6e7a 6970 3228 6261 7463 6865   = unzip2(batche
+00010800: 645f 6172 6773 290a 2020 2020 6f75 745f  d_args).    out_
+00010810: 6469 6d73 203d 2030 2020 2320 4669 786d  dims = 0  # Fixm
+00010820: 650a 2020 2020 6f75 7473 2c20 6f75 745f  e.    outs, out_
+00010830: 6469 6d73 203d 205f 766d 6170 5f63 616c  dims = _vmap_cal
+00010840: 6c5f 6d65 7461 6675 6e63 2846 616c 7365  l_metafunc(False
+00010850: 2c20 6172 6773 2c20 696e 5f64 696d 732c  , args, in_dims,
+00010860: 206f 7574 5f64 696d 732c 2061 7869 735f   out_dims, axis_
+00010870: 7369 7a65 2c20 6675 6e63 7469 6f6e 5f74  size, function_t
+00010880: 7261 6365 3d74 7261 6365 2c20 2a2a 6b77  race=trace, **kw
+00010890: 6172 6773 290a 2020 2020 6966 2069 7369  args).    if isi
+000108a0: 6e73 7461 6e63 6528 6f75 7473 2c20 5365  nstance(outs, Se
+000108b0: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
+000108c0: 2072 6574 7572 6e20 7361 6665 5f6d 6170   return safe_map
+000108d0: 2870 6169 725f 746f 5f62 6174 6368 6564  (pair_to_batched
+000108e0: 5f76 616c 7565 2c20 7361 6665 5f7a 6970  _value, safe_zip
+000108f0: 286f 7574 732c 206f 7574 5f64 696d 7329  (outs, out_dims)
+00010900: 290a 2020 2020 7265 7475 726e 2042 6174  ).    return Bat
+00010910: 6368 6564 5661 6c75 6528 6f75 7473 2c20  chedValue(outs, 
+00010920: 6f75 745f 6469 6d73 290a 0a0a 766d 6170  out_dims)...vmap
+00010930: 5f69 6d70 6c73 5b54 7261 6e73 666f 726d  _impls[Transform
+00010940: 732e 4964 656e 7469 7479 4f70 5d20 3d20  s.IdentityOp] = 
+00010950: 5f69 6465 6e74 6974 795f 6361 6c6c 5f76  _identity_call_v
+00010960: 6d61 700a 0a0a 6465 6620 5f6a 7670 5f63  map...def _jvp_c
+00010970: 616c 6c5f 766d 6170 2861 7869 735f 7369  all_vmap(axis_si
+00010980: 7a65 2c20 6261 7463 6865 645f 7072 696d  ze, batched_prim
+00010990: 616c 732c 2062 6174 6368 6564 5f74 616e  als, batched_tan
+000109a0: 6765 6e74 732c 202a 2c20 6675 6e63 7469  gents, *, functi
+000109b0: 6f6e 5f74 7261 6365 3a20 5472 6163 652c  on_trace: Trace,
+000109c0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+000109d0: 7072 696d 616c 732c 2070 7269 6d61 6c73  primals, primals
+000109e0: 5f62 6469 6d73 203d 2073 6166 655f 7a69  _bdims = safe_zi
+000109f0: 7028 2a62 6174 6368 6564 5f70 7269 6d61  p(*batched_prima
+00010a00: 6c73 290a 2020 2020 7461 6e67 656e 7473  ls).    tangents
+00010a10: 2c20 7461 6e67 656e 7473 5f62 6469 6d73  , tangents_bdims
+00010a20: 203d 2073 6166 655f 7a69 7028 2a62 6174   = safe_zip(*bat
+00010a30: 6368 6564 5f74 616e 6765 6e74 7329 0a20  ched_tangents). 
+00010a40: 2020 206a 7670 5f66 756e 6320 3d20 7061     jvp_func = pa
+00010a50: 7274 6961 6c28 5f6a 7670 5f63 616c 6c5f  rtial(_jvp_call_
+00010a60: 6d65 7461 6675 6e63 2c20 4661 6c73 652c  metafunc, False,
+00010a70: 2066 756e 6374 696f 6e5f 7472 6163 653d   function_trace=
+00010a80: 6675 6e63 7469 6f6e 5f74 7261 6365 290a  function_trace).
+00010a90: 2020 2020 766d 6170 7065 645f 6a76 705f      vmapped_jvp_
+00010aa0: 6675 6e63 203d 2076 6d61 7028 6a76 705f  func = vmap(jvp_
+00010ab0: 6675 6e63 2c20 696e 5f64 696d 733d 2870  func, in_dims=(p
+00010ac0: 7269 6d61 6c73 5f62 6469 6d73 2c20 7461  rimals_bdims, ta
+00010ad0: 6e67 656e 7473 5f62 6469 6d73 292c 2061  ngents_bdims), a
+00010ae0: 7869 735f 7369 7a65 3d61 7869 735f 7369  xis_size=axis_si
+00010af0: 7a65 290a 2020 2020 7265 7375 6c74 203d  ze).    result =
+00010b00: 2076 6d61 7070 6564 5f6a 7670 5f66 756e   vmapped_jvp_fun
+00010b10: 6328 7072 696d 616c 732c 2074 616e 6765  c(primals, tange
+00010b20: 6e74 732c 202a 2a6b 7761 7267 7329 0a20  nts, **kwargs). 
+00010b30: 2020 2072 6574 7572 6e20 7472 6565 5f6d     return tree_m
+00010b40: 6170 286c 616d 6264 6120 783a 2042 6174  ap(lambda x: Bat
+00010b50: 6368 6564 5661 6c75 6528 782c 2030 292c  chedValue(x, 0),
+00010b60: 2072 6573 756c 7429 0a0a 0a76 6d61 705f   result)...vmap_
+00010b70: 696d 706c 735b 5472 616e 7366 6f72 6d73  impls[Transforms
+00010b80: 2e4a 7670 4f70 5d20 3d20 5f6a 7670 5f63  .JvpOp] = _jvp_c
+00010b90: 616c 6c5f 766d 6170 0a0a 0a64 6566 2076  all_vmap...def v
+00010ba0: 6d61 7028 6675 6e63 2c20 696e 5f64 696d  map(func, in_dim
+00010bb0: 733d 302c 206f 7574 5f64 696d 733d 302c  s=0, out_dims=0,
+00010bc0: 2061 7869 735f 7369 7a65 3d4e 6f6e 6529   axis_size=None)
+00010bd0: 3a0a 2020 2020 2222 2256 6563 746f 7269  :.    """Vectori
+00010be0: 7a69 6e67 2074 7261 6e73 666f 726d 2066  zing transform f
+00010bf0: 6f72 2061 2054 6875 6e64 6572 2066 756e  or a Thunder fun
+00010c00: 6374 696f 6e2e 0a0a 2020 2020 4172 6773  ction...    Args
+00010c10: 3a0a 2020 2020 2020 2020 6675 6e63 2028  :.        func (
+00010c20: 4361 6c6c 6162 6c65 293a 2041 2054 6875  Callable): A Thu
+00010c30: 6e64 6572 2066 756e 6374 696f 6e20 746f  nder function to
+00010c40: 2062 6520 7472 616e 7366 6f72 6d65 642e   be transformed.
+00010c50: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+00010c60: 2020 2020 2020 2043 616c 6c61 626c 653a         Callable:
+00010c70: 2041 2076 6d61 7070 6564 2076 6572 7369   A vmapped versi
+00010c80: 6f6e 206f 6620 7468 6520 6675 6e63 7469  on of the functi
+00010c90: 6f6e 2e0a 2020 2020 2222 220a 0a20 2020  on..    """..   
+00010ca0: 2023 2054 4f44 4f3a 2066 6c61 7474 656e   # TODO: flatten
+00010cb0: 0a20 2020 2023 2049 6e20 4a41 5820 666c  .    # In JAX fl
+00010cc0: 6174 7465 6e69 6e67 206f 6620 696e 5f64  attening of in_d
+00010cd0: 696d 7320 6973 2072 6174 6865 7220 636f  ims is rather co
+00010ce0: 6d70 6c69 6361 7465 6420 6265 6361 7573  mplicated becaus
+00010cf0: 6520 6974 2063 616e 206f 7074 696f 6e61  e it can optiona
+00010d00: 6c6c 7920 6265 0a20 2020 2023 2073 7065  lly be.    # spe
+00010d10: 6369 6669 6564 2061 7320 6120 e280 9c70  cified as a ...p
+00010d20: 7265 6669 78e2 809d 2070 7974 7265 652c  refix... pytree,
+00010d30: 206d 6561 6e69 6e67 2074 6861 7420 6120   meaning that a 
+00010d40: 7369 6e67 6c65 206c 6561 6620 7661 6c75  single leaf valu
+00010d50: 6520 6361 6e20 6265 2061 7070 6c69 6564  e can be applied
+00010d60: 0a20 2020 2023 2074 6f20 616e 2065 6e74  .    # to an ent
+00010d70: 6972 6520 7375 622d 7079 7472 6565 2e0a  ire sub-pytree..
+00010d80: 0a20 2020 2064 6566 2066 6c61 7474 656e  .    def flatten
+00010d90: 5f66 756e 635f 666f 725f 766d 6170 2866  _func_for_vmap(f
+00010da0: 756e 632c 2061 7267 732c 206b 7761 7267  unc, args, kwarg
+00010db0: 7329 3a0a 2020 2020 2020 2020 666c 6174  s):.        flat
+00010dc0: 5f61 7267 732c 2073 7065 6320 3d20 7472  _args, spec = tr
+00010dd0: 6565 5f66 6c61 7474 656e 2828 6172 6773  ee_flatten((args
+00010de0: 2c20 6b77 6172 6773 2929 0a0a 2020 2020  , kwargs))..    
+00010df0: 2020 2020 6465 6620 666c 6174 5f66 756e      def flat_fun
+00010e00: 6328 2a66 6c61 745f 6172 6773 293a 0a20  c(*flat_args):. 
+00010e10: 2020 2020 2020 2020 2020 2066 6e5f 6172             fn_ar
+00010e20: 6773 2c20 666e 5f6b 7761 7267 7320 3d20  gs, fn_kwargs = 
+00010e30: 7472 6565 5f75 6e66 6c61 7474 656e 2866  tree_unflatten(f
+00010e40: 6c61 745f 6172 6773 2c20 7370 6563 290a  lat_args, spec).
+00010e50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00010e60: 726e 2066 756e 6328 2a66 6e5f 6172 6773  rn func(*fn_args
+00010e70: 2c20 2a2a 666e 5f6b 7761 7267 7329 0a0a  , **fn_kwargs)..
+00010e80: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+00010e90: 6c61 745f 6675 6e63 2c20 666c 6174 5f61  lat_func, flat_a
+00010ea0: 7267 732c 2073 7065 630a 0a20 2020 2064  rgs, spec..    d
+00010eb0: 6566 2077 7261 7070 6572 282a 6172 6773  ef wrapper(*args
+00010ec0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00010ed0: 2020 2020 2066 756e 635f 666c 6174 2c20       func_flat, 
+00010ee0: 6172 6773 5f66 6c61 742c 2061 7267 735f  args_flat, args_
+00010ef0: 7370 6563 203d 2066 6c61 7474 656e 5f66  spec = flatten_f
+00010f00: 756e 635f 666f 725f 766d 6170 2866 756e  unc_for_vmap(fun
+00010f10: 632c 2061 7267 732c 206b 7761 7267 7329  c, args, kwargs)
+00010f20: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00010f30: 7374 616e 6365 2869 6e5f 6469 6d73 2c20  stance(in_dims, 
+00010f40: 696e 7429 3a0a 2020 2020 2020 2020 2020  int):.          
+00010f50: 2020 696e 5f64 696d 735f 666c 6174 203d    in_dims_flat =
+00010f60: 2028 696e 5f64 696d 732c 2920 2a20 6c65   (in_dims,) * le
+00010f70: 6e28 6172 6773 5f66 6c61 7429 0a20 2020  n(args_flat).   
+00010f80: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00010f90: 2020 2020 2020 2069 6e5f 6469 6d73 5f66         in_dims_f
+00010fa0: 6c61 742c 2069 6e5f 6469 6d73 5f73 7065  lat, in_dims_spe
+00010fb0: 6320 3d20 7472 6565 5f66 6c61 7474 656e  c = tree_flatten
+00010fc0: 2869 6e5f 6469 6d73 290a 2020 2020 2020  (in_dims).      
+00010fd0: 2020 2020 2020 6173 7365 7274 206c 656e        assert len
+00010fe0: 2869 6e5f 6469 6d73 5f66 6c61 7429 203d  (in_dims_flat) =
+00010ff0: 3d20 6c65 6e28 6172 6773 5f66 6c61 7429  = len(args_flat)
+00011000: 2c20 2269 6e5f 6469 6d73 206d 7573 7420  , "in_dims must 
+00011010: 6861 7665 2074 6865 2073 616d 6520 6c65  have the same le
+00011020: 6e67 7468 2061 7320 6172 6773 2c20 6b77  ngth as args, kw
+00011030: 6172 6773 220a 2020 2020 2020 2020 756e  args".        un
+00011040: 6261 7463 6865 645f 6172 6773 5f66 6c61  batched_args_fla
+00011050: 7420 3d20 5b72 656d 6f76 655f 6261 7463  t = [remove_batc
+00011060: 685f 6469 6d28 6172 6729 2069 6620 6973  h_dim(arg) if is
+00011070: 696e 7374 616e 6365 2861 7267 2c20 5465  instance(arg, Te
+00011080: 6e73 6f72 5072 6f78 7929 2065 6c73 6520  nsorProxy) else 
+00011090: 6172 6720 666f 7220 6172 6720 696e 2061  arg for arg in a
+000110a0: 7267 735f 666c 6174 5d0a 2020 2020 2020  rgs_flat].      
+000110b0: 2020 7472 6163 6520 3d20 636f 6e73 7472    trace = constr
+000110c0: 7563 745f 7472 6163 6528 2928 6675 6e63  uct_trace()(func
+000110d0: 5f66 6c61 742c 202a 756e 6261 7463 6865  _flat, *unbatche
+000110e0: 645f 6172 6773 5f66 6c61 7429 0a20 2020  d_args_flat).   
+000110f0: 2020 2020 206f 7574 7320 3d20 766d 6170       outs = vmap
+00011100: 5f63 616c 6c28 6172 6773 5f66 6c61 742c  _call(args_flat,
+00011110: 2069 6e5f 6469 6d73 5f66 6c61 742c 206f   in_dims_flat, o
+00011120: 7574 5f64 696d 732c 2061 7869 735f 7369  ut_dims, axis_si
+00011130: 7a65 3d61 7869 735f 7369 7a65 2c20 6675  ze=axis_size, fu
+00011140: 6e63 7469 6f6e 5f74 7261 6365 3d74 7261  nction_trace=tra
+00011150: 6365 290a 2020 2020 2020 2020 7265 7475  ce).        retu
+00011160: 726e 206f 7574 730a 0a20 2020 2072 6574  rn outs..    ret
+00011170: 7572 6e20 7772 6170 7065 720a 0a0a 2320  urn wrapper...# 
+00011180: 544f 444f 2054 6869 7320 6675 6e63 7469  TODO This functi
+00011190: 6f6e 2063 6f6d 6d65 6e74 6564 206f 7574  on commented out
+000111a0: 2062 6563 6175 7365 2069 7420 6361 6c6c   because it call
+000111b0: 7320 6d61 6b65 5f74 7261 6365 642c 2077  s make_traced, w
+000111c0: 6869 6368 2064 6f65 7320 6e6f 7420 6578  hich does not ex
+000111d0: 6973 740a 2320 6465 6620 766d 6170 5f65  ist.# def vmap_e
+000111e0: 6167 6572 2866 756e 632c 2061 7267 732c  ager(func, args,
+000111f0: 2069 6e5f 6469 6d73 3d30 2c20 6f75 745f   in_dims=0, out_
+00011200: 6469 6d73 3d30 2c20 6178 6973 5f73 697a  dims=0, axis_siz
+00011210: 653d 4e6f 6e65 2c20 6578 6563 7574 6f72  e=None, executor
+00011220: 3d22 746f 7263 6822 293a 0a23 2020 2020  ="torch"):.#    
+00011230: 2022 2222 436f 6d70 7574 6573 2074 6865   """Computes the
+00011240: 2076 6d61 7020 6f66 2061 2054 6875 6e64   vmap of a Thund
+00011250: 6572 2066 756e 6374 696f 6e2e 0a0a 2320  er function...# 
+00011260: 2020 2020 4172 6773 3a0a 2320 2020 2020      Args:.#     
+00011270: 2020 2020 6675 6e63 2028 4361 6c6c 6162      func (Callab
+00011280: 6c65 293a 2041 2054 6875 6e64 6572 2066  le): A Thunder f
+00011290: 756e 6374 696f 6e20 746f 2062 6520 7472  unction to be tr
+000112a0: 616e 7366 6f72 6d65 642e 0a23 2020 2020  ansformed..#    
+000112b0: 2020 2020 2061 7267 7320 285f 7479 7065       args (_type
+000112c0: 5f29 3a20 4172 6773 206f 6620 7468 6520  _): Args of the 
+000112d0: 6675 6e63 7469 6f6e 2e0a 2320 2020 2020  function..#     
+000112e0: 2020 2020 6578 6563 7574 6f72 2028 7374      executor (st
+000112f0: 722c 206f 7074 696f 6e61 6c29 3a20 4578  r, optional): Ex
+00011300: 6563 7574 6f72 2074 6f20 7573 652e 2044  ecutor to use. D
+00011310: 6566 6175 6c74 7320 746f 2022 746f 7263  efaults to "torc
+00011320: 6822 2e0a 0a23 2020 2020 2052 6574 7572  h"...#     Retur
+00011330: 6e73 3a0a 2320 2020 2020 2020 2020 5468  ns:.#         Th
+00011340: 6520 7265 7375 6c74 206f 6620 7468 6520  e result of the 
+00011350: 766d 6170 7065 6420 6675 6e63 7469 6f6e  vmapped function
+00011360: 2e0a 2320 2020 2020 2222 220a 2320 2020  ..#     """.#   
+00011370: 2020 2320 544f 444f 3a20 6669 7820 7468    # TODO: fix th
+00011380: 6973 202d 206e 6f74 2061 6c6c 2061 7267  is - not all arg
+00011390: 7320 6d61 7920 6265 2062 6174 6368 6564  s may be batched
+000113a0: 0a23 2020 2020 2023 2054 4f44 4f3a 2068  .#     # TODO: h
+000113b0: 6572 6520 7765 2061 7373 756d 6520 6261  ere we assume ba
+000113c0: 7463 6820 6178 6973 2069 7320 300a 2320  tch axis is 0.# 
+000113d0: 2020 2020 766d 6170 5f74 7261 6365 203d      vmap_trace =
+000113e0: 206d 616b 655f 7472 6163 6528 0a23 2020   make_trace(.#  
+000113f0: 2020 2020 2020 2076 6d61 7028 6675 6e63         vmap(func
+00011400: 2c20 696e 5f64 696d 733d 696e 5f64 696d  , in_dims=in_dim
+00011410: 732c 206f 7574 5f64 696d 733d 6f75 745f  s, out_dims=out_
+00011420: 6469 6d73 2c20 6178 6973 5f73 697a 653d  dims, axis_size=
+00011430: 6178 6973 5f73 697a 6529 2c20 6578 6563  axis_size), exec
+00011440: 7574 6f72 3d65 7865 6375 746f 722c 0a23  utor=executor,.#
+00011450: 2020 2020 2020 2020 202a 6172 6773 290a           *args).
+00011460: 2320 2020 2020 766d 6170 5f74 7261 6365  #     vmap_trace
+00011470: 6420 3d20 6d61 6b65 5f74 7261 6365 6428  d = make_traced(
+00011480: 7061 7274 6961 6c28 6576 616c 5f74 7261  partial(eval_tra
+00011490: 6365 2c20 766d 6170 5f74 7261 6365 292c  ce, vmap_trace),
+000114a0: 2065 7865 6375 746f 723d 6578 6563 7574   executor=execut
+000114b0: 6f72 290a 2320 2020 2020 7265 7475 726e  or).#     return
+000114c0: 2076 6d61 705f 7472 6163 6564 282a 6172   vmap_traced(*ar
+000114d0: 6773 290a 0a0a 2320 4a56 5020 7472 616e  gs)...# JVP tran
+000114e0: 7366 6f72 6d0a 2320 2d2d 2d2d 2d2d 2d2d  sform.# --------
+000114f0: 2d2d 2d2d 2d0a 0a0a 4064 6174 6163 6c61  -----...@datacla
+00011500: 7373 2866 726f 7a65 6e3d 5472 7565 290a  ss(frozen=True).
+00011510: 636c 6173 7320 4a56 5044 7561 6c3a 0a20  class JVPDual:. 
+00011520: 2020 2022 2222 4475 616c 206e 756d 6265     """Dual numbe
+00011530: 7220 666f 7220 7468 6520 4a56 5020 7472  r for the JVP tr
+00011540: 616e 7366 6f72 6d2e 0a0a 2020 2020 4174  ansform...    At
+00011550: 7472 6962 7574 6573 3a0a 2020 2020 2020  tributes:.      
+00011560: 2020 7072 696d 616c 3a20 5072 696d 616c    primal: Primal
+00011570: 2076 616c 7565 2e0a 2020 2020 2020 2020   value..        
+00011580: 7461 6e67 656e 743a 2054 616e 6765 6e74  tangent: Tangent
+00011590: 2076 616c 7565 2e0a 2020 2020 2222 220a   value..    """.
+000115a0: 0a20 2020 2070 7269 6d61 6c3a 2041 6e79  .    primal: Any
+000115b0: 0a20 2020 2074 616e 6765 6e74 3a20 416e  .    tangent: An
+000115c0: 790a 0a20 2020 2064 6566 205f 5f69 7465  y..    def __ite
+000115d0: 725f 5f28 7365 6c66 293a 0a20 2020 2020  r__(self):.     
+000115e0: 2020 2079 6965 6c64 2073 656c 662e 7072     yield self.pr
+000115f0: 696d 616c 0a20 2020 2020 2020 2079 6965  imal.        yie
+00011600: 6c64 2073 656c 662e 7461 6e67 656e 740a  ld self.tangent.
+00011610: 0a0a 6465 6620 7061 6972 5f74 6f5f 6a76  ..def pair_to_jv
+00011620: 705f 6475 616c 2870 6169 7229 3a0a 2020  p_dual(pair):.  
+00011630: 2020 2222 2243 6f6e 7665 7274 7320 6120    """Converts a 
+00011640: 7061 6972 2074 6f20 6120 4a56 5044 7561  pair to a JVPDua
+00011650: 6c2e 0a0a 2020 2020 4172 6773 3a0a 2020  l...    Args:.  
+00011660: 2020 2020 2020 7061 6972 2028 5365 7175        pair (Sequ
+00011670: 656e 6365 293a 2050 6169 7220 746f 2063  ence): Pair to c
+00011680: 6f6e 7665 7274 2e0a 0a20 2020 2052 6574  onvert...    Ret
+00011690: 7572 6e73 3a0a 2020 2020 2020 2020 4a56  urns:.        JV
+000116a0: 5044 7561 6c3a 204a 5650 4475 616c 2072  PDual: JVPDual r
+000116b0: 6570 7265 7365 6e74 6174 696f 6e20 6f66  epresentation of
+000116c0: 2074 6865 2070 6169 722e 0a20 2020 2022   the pair..    "
+000116d0: 2222 0a20 2020 2069 6620 6973 696e 7374  "".    if isinst
+000116e0: 616e 6365 2870 6169 722c 204a 5650 4475  ance(pair, JVPDu
+000116f0: 616c 293a 0a20 2020 2020 2020 2072 6574  al):.        ret
+00011700: 7572 6e20 7061 6972 0a20 2020 2065 6c73  urn pair.    els
+00011710: 653a 0a20 2020 2020 2020 2061 7373 6572  e:.        asser
+00011720: 7420 6973 696e 7374 616e 6365 2870 6169  t isinstance(pai
+00011730: 722c 2053 6571 7565 6e63 6529 2061 6e64  r, Sequence) and
+00011740: 206c 656e 2870 6169 7229 203d 3d20 320a   len(pair) == 2.
+00011750: 2020 2020 2020 2020 7265 7475 726e 204a          return J
+00011760: 5650 4475 616c 282a 7061 6972 290a 0a0a  VPDual(*pair)...
+00011770: 6465 6620 7369 6e5f 6a76 7028 613a 204a  def sin_jvp(a: J
+00011780: 5650 4475 616c 293a 0a20 2020 2078 2c20  VPDual):.    x, 
+00011790: 7864 203d 2061 0a20 2020 2072 6574 7572  xd = a.    retur
+000117a0: 6e20 4a56 5044 7561 6c28 7072 696d 732e  n JVPDual(prims.
+000117b0: 7369 6e28 7829 2c20 7072 696d 732e 636f  sin(x), prims.co
+000117c0: 7328 7829 202a 2078 6429 0a0a 0a64 6566  s(x) * xd)...def
+000117d0: 206d 756c 5f6a 7670 2861 3a20 4a56 5044   mul_jvp(a: JVPD
+000117e0: 7561 6c2c 2062 3a20 4a56 5044 7561 6c29  ual, b: JVPDual)
+000117f0: 3a0a 2020 2020 782c 2078 6420 3d20 610a  :.    x, xd = a.
+00011800: 2020 2020 792c 2079 6420 3d20 620a 2020      y, yd = b.  
+00011810: 2020 7265 7475 726e 204a 5650 4475 616c    return JVPDual
+00011820: 2878 202a 2079 2c20 7820 2a20 7964 202b  (x * y, x * yd +
+00011830: 2079 202a 2078 6429 0a0a 0a64 6566 2061   y * xd)...def a
+00011840: 6464 5f6a 7670 2861 3a20 4a56 5044 7561  dd_jvp(a: JVPDua
+00011850: 6c2c 2062 3a20 4a56 5044 7561 6c29 3a0a  l, b: JVPDual):.
+00011860: 2020 2020 782c 2078 6420 3d20 610a 2020      x, xd = a.  
+00011870: 2020 792c 2079 6420 3d20 620a 2020 2020    y, yd = b.    
+00011880: 7265 7475 726e 204a 5650 4475 616c 2878  return JVPDual(x
+00011890: 202b 2079 2c20 7864 202b 2079 6429 0a0a   + y, xd + yd)..
+000118a0: 0a64 6566 2062 726f 6164 6361 7374 5f69  .def broadcast_i
+000118b0: 6e5f 6469 6d5f 6a76 7028 613a 204a 5650  n_dim_jvp(a: JVP
+000118c0: 4475 616c 2c20 7368 6170 653a 2074 7570  Dual, shape: tup
+000118d0: 6c65 5b4a 5650 4475 616c 2c20 2e2e 2e5d  le[JVPDual, ...]
+000118e0: 2c20 6272 6f61 6463 6173 745f 6469 6d65  , broadcast_dime
+000118f0: 6e73 696f 6e73 3a20 7475 706c 655b 4a56  nsions: tuple[JV
+00011900: 5044 7561 6c2c 202e 2e2e 5d29 202d 3e20  PDual, ...]) -> 
+00011910: 4a56 5044 7561 6c3a 0a20 2020 2078 2c20  JVPDual:.    x, 
+00011920: 7864 203d 2061 0a20 2020 2023 2054 4f44  xd = a.    # TOD
+00011930: 4f3a 2073 6861 7065 2061 6e64 2062 726f  O: shape and bro
+00011940: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
+00011950: 7320 7368 6f75 6c64 2062 6520 7475 706c  s should be tupl
+00011960: 6573 206f 6620 696e 7473 0a20 2020 2023  es of ints.    #
+00011970: 2062 7574 2066 6f72 206e 6f77 2069 7427   but for now it'
+00011980: 7320 6120 7475 706c 6520 6f66 204a 5650  s a tuple of JVP
+00011990: 4475 616c 730a 2020 2020 6966 206c 656e  Duals.    if len
+000119a0: 2873 6861 7065 2920 3e20 3020 616e 6420  (shape) > 0 and 
+000119b0: 6973 696e 7374 616e 6365 2873 6861 7065  isinstance(shape
+000119c0: 5b30 5d2c 204a 5650 4475 616c 293a 0a20  [0], JVPDual):. 
+000119d0: 2020 2020 2020 2073 6861 7065 2c20 5f20         shape, _ 
+000119e0: 3d20 7361 6665 5f7a 6970 282a 7368 6170  = safe_zip(*shap
+000119f0: 6529 0a20 2020 2069 6620 6c65 6e28 6272  e).    if len(br
+00011a00: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
+00011a10: 6e73 2920 3e20 3020 616e 6420 6973 696e  ns) > 0 and isin
+00011a20: 7374 616e 6365 2862 726f 6164 6361 7374  stance(broadcast
+00011a30: 5f64 696d 656e 7369 6f6e 735b 305d 2c20  _dimensions[0], 
+00011a40: 4a56 5044 7561 6c29 3a0a 2020 2020 2020  JVPDual):.      
+00011a50: 2020 6272 6f61 6463 6173 745f 6469 6d65    broadcast_dime
+00011a60: 6e73 696f 6e73 2c20 5f20 3d20 7361 6665  nsions, _ = safe
+00011a70: 5f7a 6970 282a 6272 6f61 6463 6173 745f  _zip(*broadcast_
+00011a80: 6469 6d65 6e73 696f 6e73 290a 2020 2020  dimensions).    
+00011a90: 7265 7475 726e 204a 5650 4475 616c 280a  return JVPDual(.
+00011aa0: 2020 2020 2020 2020 7072 696d 732e 6272          prims.br
+00011ab0: 6f61 6463 6173 745f 696e 5f64 696d 2878  oadcast_in_dim(x
+00011ac0: 2c20 7368 6170 652c 2062 726f 6164 6361  , shape, broadca
+00011ad0: 7374 5f64 696d 656e 7369 6f6e 7329 2c20  st_dimensions), 
+00011ae0: 7072 696d 732e 6272 6f61 6463 6173 745f  prims.broadcast_
+00011af0: 696e 5f64 696d 2878 642c 2073 6861 7065  in_dim(xd, shape
+00011b00: 2c20 6272 6f61 6463 6173 745f 6469 6d65  , broadcast_dime
+00011b10: 6e73 696f 6e73 290a 2020 2020 290a 0a0a  nsions).    )...
+00011b20: 6465 6620 756e 7061 636b 5f73 6571 7565  def unpack_seque
+00011b30: 6e63 655f 6a76 7028 7365 7175 656e 6365  nce_jvp(sequence
+00011b40: 3a20 4a56 5044 7561 6c2c 206c 656e 6774  : JVPDual, lengt
+00011b50: 683a 204a 5650 4475 616c 2920 2d3e 204a  h: JVPDual) -> J
+00011b60: 5650 4475 616c 3a0a 2020 2020 7820 3d20  VPDual:.    x = 
+00011b70: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
+00011b80: 783a 2078 2e70 7269 6d61 6c2c 2073 6571  x: x.primal, seq
+00011b90: 7565 6e63 6529 0a20 2020 2078 6420 3d20  uence).    xd = 
+00011ba0: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
+00011bb0: 783a 2078 2e74 616e 6765 6e74 2c20 7365  x: x.tangent, se
+00011bc0: 7175 656e 6365 290a 2020 2020 6c65 6e67  quence).    leng
+00011bd0: 7468 2c20 5f20 3d20 6c65 6e67 7468 0a20  th, _ = length. 
+00011be0: 2020 2070 7269 6d61 6c73 203d 2070 7269     primals = pri
+00011bf0: 6d73 2e75 6e70 6163 6b5f 7365 7175 656e  ms.unpack_sequen
+00011c00: 6365 2878 2c20 6c65 6e67 7468 290a 2020  ce(x, length).  
+00011c10: 2020 7461 6e67 656e 7473 203d 2070 7269    tangents = pri
+00011c20: 6d73 2e75 6e70 6163 6b5f 7365 7175 656e  ms.unpack_sequen
+00011c30: 6365 2878 642c 206c 656e 6774 6829 0a20  ce(xd, length). 
+00011c40: 2020 2072 6574 7572 6e20 7361 6665 5f6d     return safe_m
+00011c50: 6170 2870 6169 725f 746f 5f6a 7670 5f64  ap(pair_to_jvp_d
+00011c60: 7561 6c2c 2073 6166 655f 7a69 7028 7072  ual, safe_zip(pr
+00011c70: 696d 616c 732c 2074 616e 6765 6e74 7329  imals, tangents)
+00011c80: 290a 0a0a 6465 6620 756e 7061 636b 5f74  )...def unpack_t
+00011c90: 7269 7669 616c 5f6a 7670 2878 3a20 4a56  rivial_jvp(x: JV
+00011ca0: 5044 7561 6c29 202d 3e20 4a56 5044 7561  PDual) -> JVPDua
+00011cb0: 6c3a 0a20 2020 2072 6574 7572 6e20 780a  l:.    return x.
+00011cc0: 0a0a 6a76 705f 696d 706c 733a 2064 6963  ..jvp_impls: dic
+00011cd0: 745b 7072 696d 732e 5379 6d62 6f6c 2c20  t[prims.Symbol, 
+00011ce0: 4361 6c6c 6162 6c65 5d20 3d20 6469 6374  Callable] = dict
+00011cf0: 2829 0a0a 6a76 705f 696d 706c 735b 7072  ()..jvp_impls[pr
+00011d00: 696d 732e 5072 696d 4944 732e 5349 4e5d  ims.PrimIDs.SIN]
+00011d10: 203d 2073 696e 5f6a 7670 0a6a 7670 5f69   = sin_jvp.jvp_i
+00011d20: 6d70 6c73 5b70 7269 6d73 2e50 7269 6d49  mpls[prims.PrimI
+00011d30: 4473 2e4d 554c 5d20 3d20 6d75 6c5f 6a76  Ds.MUL] = mul_jv
+00011d40: 700a 6a76 705f 696d 706c 735b 7072 696d  p.jvp_impls[prim
+00011d50: 732e 5072 696d 4944 732e 4144 445d 203d  s.PrimIDs.ADD] =
+00011d60: 2061 6464 5f6a 7670 0a6a 7670 5f69 6d70   add_jvp.jvp_imp
+00011d70: 6c73 5b70 7269 6d73 2e50 7269 6d49 4473  ls[prims.PrimIDs
+00011d80: 2e42 524f 4144 4341 5354 5f49 4e5f 4449  .BROADCAST_IN_DI
+00011d90: 4d5d 203d 2062 726f 6164 6361 7374 5f69  M] = broadcast_i
+00011da0: 6e5f 6469 6d5f 6a76 700a 2320 6a76 705f  n_dim_jvp.# jvp_
+00011db0: 696d 706c 735b 7072 696d 732e 5072 696d  impls[prims.Prim
+00011dc0: 4944 732e 554e 5041 434b 5f53 4551 5545  IDs.UNPACK_SEQUE
+00011dd0: 4e43 455d 203d 2075 6e70 6163 6b5f 7365  NCE] = unpack_se
+00011de0: 7175 656e 6365 5f6a 7670 0a23 206a 7670  quence_jvp.# jvp
+00011df0: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
+00011e00: 6d49 4473 2e55 4e50 4143 4b5f 5452 4956  mIDs.UNPACK_TRIV
+00011e10: 4941 4c5d 203d 2075 6e70 6163 6b5f 7472  IAL] = unpack_tr
+00011e20: 6976 6961 6c5f 6a76 700a 0a0a 6465 6620  ivial_jvp...def 
+00011e30: 6a76 705f 7379 6d62 6f6c 5f6d 6170 7065  jvp_symbol_mappe
+00011e40: 7228 7379 6d62 6f6c 3a20 7072 696d 732e  r(symbol: prims.
+00011e50: 5379 6d62 6f6c 293a 0a20 2020 2022 2222  Symbol):.    """
+00011e60: 4d61 7073 2061 2073 796d 626f 6c20 746f  Maps a symbol to
+00011e70: 2061 204a 5650 2066 756e 6374 696f 6e20   a JVP function 
+00011e80: 7468 6174 2065 7661 6c75 6174 6573 2069  that evaluates i
+00011e90: 742e 0a0a 2020 2020 4172 6773 3a0a 2020  t...    Args:.  
+00011ea0: 2020 2020 2020 7379 6d62 6f6c 2028 7072        symbol (pr
+00011eb0: 696d 732e 5379 6d62 6f6c 293a 2053 796d  ims.Symbol): Sym
+00011ec0: 626f 6c20 746f 2065 7661 6c75 6174 652e  bol to evaluate.
+00011ed0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
+00011ee0: 2020 2020 2020 4e6f 7449 6d70 6c65 6d65        NotImpleme
+00011ef0: 6e74 6564 4572 726f 723a 2049 6620 7468  ntedError: If th
+00011f00: 6520 4a56 5020 666f 7220 7468 6520 7379  e JVP for the sy
+00011f10: 6d62 6f6c 2069 7320 6e6f 7420 696d 706c  mbol is not impl
+00011f20: 656d 656e 7465 642e 0a0a 2020 2020 5265  emented...    Re
+00011f30: 7475 726e 733a 0a20 2020 2020 2020 2043  turns:.        C
+00011f40: 616c 6c61 626c 653a 204a 5650 2066 756e  allable: JVP fun
+00011f50: 6374 696f 6e20 7468 6174 2065 7661 6c75  ction that evalu
+00011f60: 6174 6573 2074 6865 2073 796d 626f 6c2e  ates the symbol.
+00011f70: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
+00011f80: 6620 7772 6170 5f61 7267 2878 293a 0a20  f wrap_arg(x):. 
+00011f90: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00011fa0: 616e 6365 2878 2c20 4a56 5044 7561 6c29  ance(x, JVPDual)
+00011fb0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00011fc0: 7475 726e 2078 0a20 2020 2020 2020 2065  turn x.        e
+00011fd0: 6c69 6620 6973 696e 7374 616e 6365 2878  lif isinstance(x
+00011fe0: 2c20 4e75 6d62 6572 293a 0a20 2020 2020  , Number):.     
+00011ff0: 2020 2020 2020 2072 6574 7572 6e20 4a56         return JV
+00012000: 5044 7561 6c28 782c 2074 7970 6528 7829  PDual(x, type(x)
+00012010: 2830 2929 0a20 2020 2020 2020 2065 6c73  (0)).        els
+00012020: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00012030: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00012040: 6622 4a56 5020 7772 6170 5f61 7267 2067  f"JVP wrap_arg g
+00012050: 6f74 2061 6e20 756e 7375 7070 6f72 7465  ot an unsupporte
+00012060: 6420 7479 7065 207b 7479 7065 2878 297d  d type {type(x)}
+00012070: 2229 0a0a 2020 2020 2320 4966 2073 796d  ")..    # If sym
+00012080: 626f 6c2e 6172 6773 2064 6f65 736e 2774  bol.args doesn't
+00012090: 2068 6176 6520 7375 6263 6c61 7373 6573   have subclasses
+000120a0: 206f 6620 5661 7269 6162 6c65 2c20 7468   of Variable, th
+000120b0: 656e 2077 6520 6e65 6564 2074 6f20 7265  en we need to re
+000120c0: 7475 726e 2061 207a 6572 6f20 7461 6e67  turn a zero tang
+000120d0: 656e 740a 2020 2020 2320 544f 444f 3a20  ent.    # TODO: 
+000120e0: 7468 6572 6520 6d61 7920 6265 2061 2062  there may be a b
+000120f0: 6574 7465 7220 7761 7920 746f 2064 6574  etter way to det
+00012100: 6563 7420 636f 6e73 7461 6e74 7320 696e  ect constants in
+00012110: 2074 6865 2074 7261 6365 0a20 2020 2069   the trace.    i
+00012120: 6620 7379 6d62 6f6c 2e61 7265 5f61 6c6c  f symbol.are_all
+00012130: 5f61 7267 735f 636f 6e73 7461 6e74 3a0a  _args_constant:.
+00012140: 0a20 2020 2020 2020 2064 6566 207a 6572  .        def zer
+00012150: 6f73 5f6c 696b 6528 7829 3a0a 2020 2020  os_like(x):.    
+00012160: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00012170: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
+00012180: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
+00012190: 2020 2020 2020 2072 6574 7572 6e20 6675         return fu
+000121a0: 6c6c 5f6c 696b 6528 782c 2066 696c 6c5f  ll_like(x, fill_
+000121b0: 7661 6c75 653d 3029 0a20 2020 2020 2020  value=0).       
+000121c0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+000121d0: 616e 6365 2878 2c20 4e75 6d62 6572 5072  ance(x, NumberPr
+000121e0: 6f78 7929 3a0a 2020 2020 2020 2020 2020  oxy):.          
+000121f0: 2020 2020 2020 7265 7475 726e 2074 7970        return typ
+00012200: 6528 782e 7661 6c75 6529 2830 290a 2020  e(x.value)(0).  
+00012210: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+00012220: 7369 6e73 7461 6e63 6528 782c 204e 756d  sinstance(x, Num
+00012230: 6265 7229 3a0a 2020 2020 2020 2020 2020  ber):.          
+00012240: 2020 2020 2020 7265 7475 726e 2074 7970        return typ
+00012250: 6528 7829 2830 290a 2020 2020 2020 2020  e(x)(0).        
+00012260: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00012270: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00012280: 5661 6c75 6545 7272 6f72 2866 227a 6572  ValueError(f"zer
+00012290: 6f73 5f6c 696b 6520 696e 7369 6465 204a  os_like inside J
+000122a0: 5650 2067 6f74 2061 6e20 756e 7375 7070  VP got an unsupp
+000122b0: 6f72 7465 6420 7479 7065 207b 7479 7065  orted type {type
+000122c0: 2878 297d 2229 0a0a 2020 2020 2020 2020  (x)}")..        
+000122d0: 6465 6620 6a76 705f 696d 706c 5f63 6f6e  def jvp_impl_con
+000122e0: 7374 2873 796d 626f 6c2c 202a 6172 6773  st(symbol, *args
+000122f0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00012300: 2020 2020 2020 2020 2070 7269 6d61 6c73           primals
+00012310: 203d 2073 796d 626f 6c5f 746f 5f65 7661   = symbol_to_eva
+00012320: 6c28 7379 6d62 6f6c 2928 2a61 7267 732c  l(symbol)(*args,
+00012330: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
+00012340: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00012350: 616e 6365 2870 7269 6d61 6c73 2c20 5365  ance(primals, Se
+00012360: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
+00012370: 2020 2020 2020 2020 2074 616e 6765 6e74           tangent
+00012380: 7320 3d20 7475 706c 6528 7a65 726f 735f  s = tuple(zeros_
+00012390: 6c69 6b65 2870 2920 666f 7220 7020 696e  like(p) for p in
+000123a0: 2070 7269 6d61 6c73 290a 2020 2020 2020   primals).      
+000123b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000123c0: 2073 6166 655f 6d61 7028 7061 6972 5f74   safe_map(pair_t
+000123d0: 6f5f 6a76 705f 6475 616c 2c20 7361 6665  o_jvp_dual, safe
+000123e0: 5f7a 6970 2870 7269 6d61 6c73 2c20 7461  _zip(primals, ta
+000123f0: 6e67 656e 7473 2929 0a20 2020 2020 2020  ngents)).       
+00012400: 2020 2020 2072 6574 7572 6e20 4a56 5044       return JVPD
+00012410: 7561 6c28 7072 696d 616c 732c 207a 6572  ual(primals, zer
+00012420: 6f73 5f6c 696b 6528 7072 696d 616c 7329  os_like(primals)
+00012430: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00012440: 6e20 7061 7274 6961 6c28 6a76 705f 696d  n partial(jvp_im
+00012450: 706c 5f63 6f6e 7374 2c20 7379 6d62 6f6c  pl_const, symbol
+00012460: 290a 0a20 2020 2023 204e 6f72 6d61 6c20  )..    # Normal 
+00012470: 6361 7365 2c20 7765 2068 6176 6520 6120  case, we have a 
+00012480: 7072 6f78 7920 7461 6e67 656e 740a 2020  proxy tangent.  
+00012490: 2020 6a76 705f 696d 706c 203d 206a 7670    jvp_impl = jvp
+000124a0: 5f69 6d70 6c73 2e67 6574 2873 796d 626f  _impls.get(symbo
+000124b0: 6c2e 7379 6d2e 6964 290a 2020 2020 6966  l.sym.id).    if
+000124c0: 206a 7670 5f69 6d70 6c20 6973 204e 6f6e   jvp_impl is Non
+000124d0: 653a 0a20 2020 2020 2020 2072 6169 7365  e:.        raise
+000124e0: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
+000124f0: 7272 6f72 2866 224a 5650 2066 6f72 207b  rror(f"JVP for {
+00012500: 7379 6d62 6f6c 2e73 796d 2e69 647d 2069  symbol.sym.id} i
+00012510: 7320 6e6f 7420 696d 706c 656d 656e 7465  s not implemente
+00012520: 6422 290a 0a20 2020 2064 6566 205f 6a76  d")..    def _jv
+00012530: 705f 696d 706c 282a 6172 6773 2c20 2a2a  p_impl(*args, **
+00012540: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+00012550: 2061 7267 7320 3d20 7472 6565 5f6d 6170   args = tree_map
+00012560: 2877 7261 705f 6172 672c 2061 7267 7329  (wrap_arg, args)
+00012570: 0a20 2020 2020 2020 2023 2045 7870 6563  .        # Expec
+00012580: 7469 6e67 204a 5650 4475 616c 7320 7772  ting JVPDuals wr
+00012590: 6170 7069 6e67 2070 6169 7273 206f 6620  apping pairs of 
+000125a0: 7072 696d 616c 7320 616e 6420 7461 6e67  primals and tang
+000125b0: 656e 7473 0a20 2020 2020 2020 2061 7373  ents.        ass
+000125c0: 6572 7420 616c 6c28 6973 696e 7374 616e  ert all(isinstan
+000125d0: 6365 2861 7267 2c20 4a56 5044 7561 6c29  ce(arg, JVPDual)
+000125e0: 2066 6f72 2061 7267 2069 6e20 7472 6565   for arg in tree
+000125f0: 5f66 6c61 7474 656e 2861 7267 7329 5b30  _flatten(args)[0
+00012600: 5d29 0a20 2020 2020 2020 2072 6574 7572  ]).        retur
+00012610: 6e20 6a76 705f 696d 706c 282a 6172 6773  n jvp_impl(*args
+00012620: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
+00012630: 2072 6574 7572 6e20 5f6a 7670 5f69 6d70   return _jvp_imp
+00012640: 6c0a 0a0a 6465 6620 5f6a 7670 5f63 616c  l...def _jvp_cal
+00012650: 6c5f 6d65 7461 6675 6e63 2864 6574 6163  l_metafunc(detac
+00012660: 6865 643a 2062 6f6f 6c2c 2070 7269 6d61  hed: bool, prima
+00012670: 6c73 2c20 7461 6e67 656e 7473 2c20 2a2c  ls, tangents, *,
+00012680: 2066 756e 6374 696f 6e5f 7472 6163 653a   function_trace:
+00012690: 2054 7261 6365 2c20 2a2a 6b77 6172 6773   Trace, **kwargs
+000126a0: 293a 0a20 2020 2022 2222 4d65 7461 6675  ):.    """Metafu
+000126b0: 6e63 7469 6f6e 2066 6f72 2074 6865 204a  nction for the J
+000126c0: 5650 2074 7261 6e73 666f 726d 2e0a 0a20  VP transform... 
+000126d0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+000126e0: 2064 6574 6163 6865 6420 2862 6f6f 6c29   detached (bool)
+000126f0: 3a20 5768 6574 6865 7220 746f 2064 6574  : Whether to det
+00012700: 6163 6820 7468 6520 7472 6163 652e 0a20  ach the trace.. 
+00012710: 2020 2020 2020 2070 7269 6d61 6c73 2028         primals (
+00012720: 5475 706c 655b 5072 6f78 795d 293a 2050  Tuple[Proxy]): P
+00012730: 7269 6d61 6c20 7661 6c75 6573 2e0a 2020  rimal values..  
+00012740: 2020 2020 2020 7461 6e67 656e 7473 2028        tangents (
+00012750: 5475 706c 655b 5072 6f78 795d 293a 2054  Tuple[Proxy]): T
+00012760: 616e 6765 6e74 2076 616c 7565 732e 0a20  angent values.. 
+00012770: 2020 2020 2020 2066 756e 6374 696f 6e5f         function_
+00012780: 7472 6163 6520 2854 7261 6365 293a 2054  trace (Trace): T
+00012790: 7261 6365 206f 6620 7468 6520 6675 6e63  race of the func
+000127a0: 7469 6f6e 2074 6f20 6265 2074 7261 6e73  tion to be trans
+000127b0: 666f 726d 6564 2e0a 2020 2020 2020 2020  formed..        
+000127c0: 6b77 6172 6773 3a20 4b65 7977 6f72 6420  kwargs: Keyword 
+000127d0: 6172 6775 6d65 6e74 732e 0a0a 2020 2020  arguments...    
+000127e0: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
+000127f0: 4173 7365 7274 696f 6e45 7272 6f72 3a20  AssertionError: 
+00012800: 4966 2074 6865 204a 5650 2066 6f72 206b  If the JVP for k
+00012810: 6579 776f 7264 2061 7267 756d 656e 7473  eyword arguments
+00012820: 2069 7320 6e6f 7420 696d 706c 656d 656e   is not implemen
+00012830: 7465 642e 0a0a 2020 2020 5265 7475 726e  ted...    Return
+00012840: 733a 0a20 2020 2020 2020 2052 6573 756c  s:.        Resul
+00012850: 7420 6f66 2074 6865 204a 5650 2074 7261  t of the JVP tra
+00012860: 6e73 666f 726d 2e0a 2020 2020 2222 220a  nsform..    """.
+00012870: 2020 2020 6173 7365 7274 206c 656e 286b      assert len(k
+00012880: 7761 7267 7329 203d 3d20 302c 2022 4a56  wargs) == 0, "JV
+00012890: 5020 666f 7220 6b77 6172 6773 2069 7320  P for kwargs is 
+000128a0: 6e6f 7420 696d 706c 656d 656e 7465 6422  not implemented"
+000128b0: 0a0a 2020 2020 6374 7820 3d20 6465 7461  ..    ctx = deta
+000128c0: 6368 6564 5f74 7261 6365 2829 2069 6620  ched_trace() if 
+000128d0: 6465 7461 6368 6564 2065 6c73 6520 6e75  detached else nu
+000128e0: 6c6c 636f 6e74 6578 7428 290a 2020 2020  llcontext().    
+000128f0: 7769 7468 2063 7478 3a0a 2020 2020 2020  with ctx:.      
+00012900: 2020 2320 5772 6170 7069 6e67 2074 6865    # Wrapping the
+00012910: 2070 7269 6d61 6c73 2061 6e64 2074 616e   primals and tan
+00012920: 6765 6e74 7320 696e 204a 5650 4475 616c  gents in JVPDual
+00012930: 7320 6973 206e 6f74 2073 7472 6963 746c  s is not strictl
+00012940: 7920 6e65 6365 7373 6172 792c 2062 7574  y necessary, but
+00012950: 2069 7420 6d61 6b65 730a 2020 2020 2020   it makes.      
+00012960: 2020 2320 7468 6520 636f 6465 206d 6f72    # the code mor
+00012970: 6520 7265 6164 6162 6c65 0a20 2020 2020  e readable.     
+00012980: 2020 2023 2057 6520 7072 6f70 6167 6174     # We propagat
+00012990: 6520 7468 6520 4a56 5044 7561 6c73 2074  e the JVPDuals t
+000129a0: 6872 6f75 6768 2074 6865 2074 7261 6365  hrough the trace
+000129b0: 2c20 616e 6420 7468 656e 2075 6e77 7261  , and then unwra
+000129c0: 7020 7468 656d 2061 7420 7468 6520 656e  p them at the en
+000129d0: 640a 2020 2020 2020 2020 7072 696d 616c  d.        primal
+000129e0: 735f 7461 6e67 656e 7473 5f64 7561 6c73  s_tangents_duals
+000129f0: 203d 2073 6166 655f 6d61 7028 7061 6972   = safe_map(pair
+00012a00: 5f74 6f5f 6a76 705f 6475 616c 2c20 7361  _to_jvp_dual, sa
+00012a10: 6665 5f7a 6970 2870 7269 6d61 6c73 2c20  fe_zip(primals, 
+00012a20: 7461 6e67 656e 7473 2929 0a20 2020 2020  tangents)).     
+00012a30: 2020 2072 6573 756c 7420 3d20 6576 616c     result = eval
+00012a40: 5f74 7261 6365 2866 756e 6374 696f 6e5f  _trace(function_
+00012a50: 7472 6163 652c 202a 7072 696d 616c 735f  trace, *primals_
+00012a60: 7461 6e67 656e 7473 5f64 7561 6c73 2c20  tangents_duals, 
+00012a70: 7379 6d62 6f6c 5f6d 6170 7065 723d 6a76  symbol_mapper=jv
+00012a80: 705f 7379 6d62 6f6c 5f6d 6170 7065 7229  p_symbol_mapper)
+00012a90: 0a20 2020 2020 2020 2023 2055 6e77 7261  .        # Unwra
+00012aa0: 7070 696e 6720 7468 6520 4a56 5044 7561  pping the JVPDua
+00012ab0: 6c73 0a20 2020 2020 2020 2069 6620 6973  ls.        if is
+00012ac0: 696e 7374 616e 6365 2872 6573 756c 742c  instance(result,
+00012ad0: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
+00012ae0: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
+00012af0: 6c6c 2869 7369 6e73 7461 6e63 6528 782c  ll(isinstance(x,
+00012b00: 204a 5650 4475 616c 2920 666f 7220 7820   JVPDual) for x 
+00012b10: 696e 2072 6573 756c 7429 0a20 2020 2020  in result).     
+00012b20: 2020 2020 2020 2070 7269 6d61 6c73 2c20         primals, 
+00012b30: 7461 6e67 656e 7473 203d 2075 6e7a 6970  tangents = unzip
+00012b40: 3228 7265 7375 6c74 290a 2020 2020 2020  2(result).      
+00012b50: 2020 2020 2020 7265 7475 726e 2070 7269        return pri
+00012b60: 6d61 6c73 2c20 7461 6e67 656e 7473 0a20  mals, tangents. 
+00012b70: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+00012b80: 696e 7374 616e 6365 2872 6573 756c 742c  instance(result,
+00012b90: 204a 5650 4475 616c 290a 2020 2020 2020   JVPDual).      
+00012ba0: 2020 7265 7475 726e 2072 6573 756c 742e    return result.
+00012bb0: 7072 696d 616c 2c20 7265 7375 6c74 2e74  primal, result.t
+00012bc0: 616e 6765 6e74 0a0a 0a6a 7670 5f63 616c  angent...jvp_cal
+00012bd0: 6c20 3d20 5379 6d62 6f6c 2869 643d 5472  l = Symbol(id=Tr
+00012be0: 616e 7366 6f72 6d73 2e4a 7670 4f70 2c20  ansforms.JvpOp, 
+00012bf0: 6e61 6d65 3d22 6a76 705f 6361 6c6c 222c  name="jvp_call",
+00012c00: 206d 6574 613d 7061 7274 6961 6c28 5f6a   meta=partial(_j
+00012c10: 7670 5f63 616c 6c5f 6d65 7461 6675 6e63  vp_call_metafunc
+00012c20: 2c20 4661 6c73 6529 290a 0a0a 6465 6620  , False))...def 
+00012c30: 5f69 6465 6e74 6974 795f 6361 6c6c 5f6a  _identity_call_j
+00012c40: 7670 282a 6172 6773 3a20 4a56 5044 7561  vp(*args: JVPDua
+00012c50: 6c2c 2074 7261 6365 3a20 5472 6163 652c  l, trace: Trace,
+00012c60: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+00012c70: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
+00012c80: 7320 3d20 756e 7a69 7032 2861 7267 7329  s = unzip2(args)
+00012c90: 0a20 2020 206f 7574 5f70 7269 6d61 6c73  .    out_primals
+00012ca0: 2c20 6f75 745f 7461 6e67 656e 7473 203d  , out_tangents =
+00012cb0: 205f 6a76 705f 6361 6c6c 5f6d 6574 6166   _jvp_call_metaf
+00012cc0: 756e 6328 4661 6c73 652c 2070 7269 6d61  unc(False, prima
+00012cd0: 6c73 2c20 7461 6e67 656e 7473 2c20 7472  ls, tangents, tr
+00012ce0: 6163 652c 202a 2a6b 7761 7267 7329 0a20  ace, **kwargs). 
+00012cf0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00012d00: 286f 7574 5f70 7269 6d61 6c73 2c20 5365  (out_primals, Se
+00012d10: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
+00012d20: 2072 6574 7572 6e20 7361 6665 5f6d 6170   return safe_map
+00012d30: 2870 6169 725f 746f 5f6a 7670 5f64 7561  (pair_to_jvp_dua
+00012d40: 6c2c 2073 6166 655f 7a69 7028 6f75 745f  l, safe_zip(out_
+00012d50: 7072 696d 616c 732c 206f 7574 5f74 616e  primals, out_tan
+00012d60: 6765 6e74 7329 290a 2020 2020 7265 7475  gents)).    retu
+00012d70: 726e 204a 5650 4475 616c 286f 7574 5f70  rn JVPDual(out_p
+00012d80: 7269 6d61 6c73 2c20 6f75 745f 7461 6e67  rimals, out_tang
+00012d90: 656e 7473 290a 0a0a 6a76 705f 696d 706c  ents)...jvp_impl
+00012da0: 735b 5472 616e 7366 6f72 6d73 2e49 6465  s[Transforms.Ide
+00012db0: 6e74 6974 794f 705d 203d 205f 6964 656e  ntityOp] = _iden
+00012dc0: 7469 7479 5f63 616c 6c5f 6a76 700a 0a0a  tity_call_jvp...
+00012dd0: 6465 6620 5f76 6d61 705f 6361 6c6c 5f6a  def _vmap_call_j
+00012de0: 7670 2861 7267 733a 204a 5650 4475 616c  vp(args: JVPDual
+00012df0: 2c20 696e 5f64 696d 732c 206f 7574 5f64  , in_dims, out_d
+00012e00: 696d 732c 2061 7869 735f 7369 7a65 2c20  ims, axis_size, 
+00012e10: 7472 6163 653a 2054 7261 6365 2c20 2a2a  trace: Trace, **
+00012e20: 6b77 6172 6773 293a 0a20 2020 2070 7269  kwargs):.    pri
+00012e30: 6d61 6c73 2c20 7461 6e67 656e 7473 203d  mals, tangents =
+00012e40: 2073 6166 655f 7a69 7028 2a61 7267 7329   safe_zip(*args)
+00012e50: 0a20 2020 2069 6e5f 6469 6d73 2c20 5f20  .    in_dims, _ 
+00012e60: 3d20 7361 6665 5f7a 6970 282a 696e 5f64  = safe_zip(*in_d
+00012e70: 696d 7329 0a20 2020 206f 7574 5f64 696d  ims).    out_dim
+00012e80: 732c 205f 203d 2073 6166 655f 7a69 7028  s, _ = safe_zip(
+00012e90: 2a6f 7574 5f64 696d 7329 0a20 2020 2076  *out_dims).    v
+00012ea0: 6d61 7070 6564 5f74 7261 6365 203d 2063  mapped_trace = c
+00012eb0: 6f6e 7374 7275 6374 5f74 7261 6365 2829  onstruct_trace()
+00012ec0: 280a 2020 2020 2020 2020 766d 6170 2870  (.        vmap(p
+00012ed0: 6172 7469 616c 2865 7661 6c5f 7472 6163  artial(eval_trac
+00012ee0: 652c 2074 7261 6365 292c 2069 6e5f 6469  e, trace), in_di
+00012ef0: 6d73 3d69 6e5f 6469 6d73 2c20 6f75 745f  ms=in_dims, out_
+00012f00: 6469 6d73 3d6f 7574 5f64 696d 732c 2061  dims=out_dims, a
+00012f10: 7869 735f 7369 7a65 3d61 7869 735f 7369  xis_size=axis_si
+00012f20: 7a65 292c 202a 7072 696d 616c 730a 2020  ze), *primals.  
+00012f30: 2020 290a 2020 2020 766d 6170 7065 645f    ).    vmapped_
+00012f40: 6675 6e63 203d 2070 6172 7469 616c 2865  func = partial(e
+00012f50: 7661 6c5f 7472 6163 652c 2076 6d61 7070  val_trace, vmapp
+00012f60: 6564 5f74 7261 6365 290a 2020 2020 6f75  ed_trace).    ou
+00012f70: 745f 7072 696d 616c 732c 206f 7574 5f74  t_primals, out_t
+00012f80: 616e 6765 6e74 7320 3d20 6a76 7028 766d  angents = jvp(vm
+00012f90: 6170 7065 645f 6675 6e63 2928 7072 696d  apped_func)(prim
+00012fa0: 616c 732c 2074 616e 6765 6e74 732c 202a  als, tangents, *
+00012fb0: 2a6b 7761 7267 7329 0a20 2020 2069 6620  *kwargs).    if 
+00012fc0: 6973 696e 7374 616e 6365 286f 7574 5f70  isinstance(out_p
+00012fd0: 7269 6d61 6c73 2c20 5365 7175 656e 6365  rimals, Sequence
+00012fe0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00012ff0: 6e20 7361 6665 5f6d 6170 2870 6169 725f  n safe_map(pair_
+00013000: 746f 5f6a 7670 5f64 7561 6c2c 2073 6166  to_jvp_dual, saf
+00013010: 655f 7a69 7028 6f75 745f 7072 696d 616c  e_zip(out_primal
+00013020: 732c 206f 7574 5f74 616e 6765 6e74 7329  s, out_tangents)
+00013030: 290a 2020 2020 7265 7475 726e 204a 5650  ).    return JVP
+00013040: 4475 616c 286f 7574 5f70 7269 6d61 6c73  Dual(out_primals
+00013050: 2c20 6f75 745f 7461 6e67 656e 7473 290a  , out_tangents).
+00013060: 0a0a 6a76 705f 696d 706c 735b 5472 616e  ..jvp_impls[Tran
+00013070: 7366 6f72 6d73 2e56 6d61 704f 705d 203d  sforms.VmapOp] =
+00013080: 205f 766d 6170 5f63 616c 6c5f 6a76 700a   _vmap_call_jvp.
+00013090: 0a0a 6465 6620 6a76 7028 6675 6e63 293a  ..def jvp(func):
+000130a0: 0a20 2020 2022 2222 4a61 636f 6269 616e  .    """Jacobian
+000130b0: 2d76 6563 746f 7220 7072 6f64 7563 7420  -vector product 
+000130c0: 7472 616e 7366 6f72 6d20 666f 7220 6120  transform for a 
+000130d0: 5468 756e 6465 7220 6675 6e63 7469 6f6e  Thunder function
+000130e0: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+000130f0: 2020 2020 2066 756e 6320 2843 616c 6c61       func (Calla
+00013100: 626c 6529 3a20 4120 5468 756e 6465 7220  ble): A Thunder 
+00013110: 6675 6e63 7469 6f6e 2074 6f20 6265 2074  function to be t
+00013120: 7261 6e73 666f 726d 6564 2e0a 0a20 2020  ransformed...   
+00013130: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00013140: 2020 4361 6c6c 6162 6c65 3a20 4120 6675    Callable: A fu
+00013150: 6e63 7469 6f6e 2074 6861 7420 636f 6d70  nction that comp
+00013160: 7574 6573 2074 6865 204a 6163 6f62 6961  utes the Jacobia
+00013170: 6e2d 7665 6374 6f72 2070 726f 6475 6374  n-vector product
+00013180: 0a20 2020 2020 2020 2020 2020 2074 616b  .            tak
+00013190: 696e 6720 7072 696d 616c 7320 616e 6420  ing primals and 
+000131a0: 7461 6e67 656e 7473 2061 7320 6172 6775  tangents as argu
+000131b0: 6d65 6e74 732e 0a20 2020 2022 2222 0a0a  ments..    """..
+000131c0: 2020 2020 6465 6620 7772 6170 7065 7228      def wrapper(
+000131d0: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
+000131e0: 7329 3a0a 2020 2020 2020 2020 7472 6163  s):.        trac
+000131f0: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
+00013200: 6163 6528 2928 6675 6e63 2c20 2a70 7269  ace()(func, *pri
+00013210: 6d61 6c73 290a 2020 2020 2020 2020 7265  mals).        re
+00013220: 7475 726e 206a 7670 5f63 616c 6c28 7072  turn jvp_call(pr
+00013230: 696d 616c 732c 2074 616e 6765 6e74 732c  imals, tangents,
+00013240: 2066 756e 6374 696f 6e5f 7472 6163 653d   function_trace=
+00013250: 7472 6163 6529 0a0a 2020 2020 7265 7475  trace)..    retu
+00013260: 726e 2077 7261 7070 6572 0a0a 0a23 2054  rn wrapper...# T
+00013270: 4f44 4f20 5468 6973 2066 756e 6374 696f  ODO This functio
+00013280: 6e20 636f 6d6d 656e 7465 6420 6f75 7420  n commented out 
+00013290: 6265 6361 7573 6520 6974 2063 616c 6c73  because it calls
+000132a0: 206d 616b 655f 7472 6163 6564 2c20 7768   make_traced, wh
+000132b0: 6963 6820 646f 6573 206e 6f74 2065 7869  ich does not exi
+000132c0: 7374 0a23 2064 6566 206a 7670 5f65 6167  st.# def jvp_eag
+000132d0: 6572 2866 756e 632c 2070 7269 6d61 6c73  er(func, primals
+000132e0: 2c20 7461 6e67 656e 7473 2c20 6578 6563  , tangents, exec
+000132f0: 7574 6f72 3d22 746f 7263 6822 293a 0a23  utor="torch"):.#
+00013300: 2020 2020 2022 2222 436f 6d70 7574 6573       """Computes
+00013310: 2074 6865 204a 6163 6f62 6961 6e2d 7665   the Jacobian-ve
+00013320: 6374 6f72 2070 726f 6475 6374 206f 6620  ctor product of 
+00013330: 6120 5468 756e 6465 7220 6675 6e63 7469  a Thunder functi
+00013340: 6f6e 2e0a 0a23 2020 2020 2041 7267 733a  on...#     Args:
+00013350: 0a23 2020 2020 2020 2020 2066 756e 6320  .#         func 
+00013360: 2843 616c 6c61 626c 6529 3a20 4120 5468  (Callable): A Th
+00013370: 756e 6465 7220 6675 6e63 7469 6f6e 2074  under function t
+00013380: 6f20 6265 2074 7261 6e73 666f 726d 6564  o be transformed
+00013390: 2e0a 2320 2020 2020 2020 2020 7072 696d  ..#         prim
+000133a0: 616c 7320 285f 7479 7065 5f29 3a20 5072  als (_type_): Pr
+000133b0: 696d 616c 7320 6f66 2074 6865 2066 756e  imals of the fun
+000133c0: 6374 696f 6e2e 0a23 2020 2020 2020 2020  ction..#        
+000133d0: 2074 616e 6765 6e74 7320 285f 7479 7065   tangents (_type
+000133e0: 5f29 3a20 5461 6e67 656e 7473 206f 6620  _): Tangents of 
+000133f0: 7468 6520 6675 6e63 7469 6f6e 2e0a 2320  the function..# 
+00013400: 2020 2020 2020 2020 6578 6563 7574 6f72          executor
+00013410: 2028 7374 722c 206f 7074 696f 6e61 6c29   (str, optional)
+00013420: 3a20 4578 6563 7574 6f72 2074 6f20 7573  : Executor to us
+00013430: 652e 2044 6566 6175 6c74 7320 746f 2022  e. Defaults to "
+00013440: 746f 7263 6822 2e0a 0a23 2020 2020 2052  torch"...#     R
+00013450: 6574 7572 6e73 3a0a 2320 2020 2020 2020  eturns:.#       
+00013460: 2020 5468 6520 7265 7375 6c74 206f 6620    The result of 
+00013470: 7468 6520 4a61 636f 6269 616e 2d76 6563  the Jacobian-vec
+00013480: 746f 7220 7072 6f64 7563 742e 0a23 2020  tor product..#  
+00013490: 2020 2022 2222 0a23 2020 2020 2074 7261     """.#     tra
+000134a0: 6365 203d 206d 616b 655f 7472 6163 6528  ce = make_trace(
+000134b0: 6675 6e63 2c20 6578 6563 7574 6f72 3d65  func, executor=e
+000134c0: 7865 6375 746f 722c 202a 7072 696d 616c  xecutor, *primal
+000134d0: 7329 0a0a 2320 2020 2020 6465 6620 6a76  s)..#     def jv
+000134e0: 705f 6675 6e63 282a 7072 696d 616c 735f  p_func(*primals_
+000134f0: 616e 645f 7461 6e67 656e 7473 293a 0a23  and_tangents):.#
+00013500: 2020 2020 2020 2020 205f 7072 696d 616c           _primal
+00013510: 732c 205f 7461 6e67 656e 7473 203d 2070  s, _tangents = p
+00013520: 7269 6d61 6c73 5f61 6e64 5f74 616e 6765  rimals_and_tange
+00013530: 6e74 735b 3a20 6c65 6e28 7072 696d 616c  nts[: len(primal
+00013540: 7329 5d2c 2070 7269 6d61 6c73 5f61 6e64  s)], primals_and
+00013550: 5f74 616e 6765 6e74 735b 6c65 6e28 7072  _tangents[len(pr
+00013560: 696d 616c 7329 203a 5d0a 2320 2020 2020  imals) :].#     
+00013570: 2020 2020 7265 7475 726e 205f 6a76 705f      return _jvp_
+00013580: 6361 6c6c 5f6d 6574 6166 756e 6328 5f70  call_metafunc(_p
+00013590: 7269 6d61 6c73 2c20 5f74 616e 6765 6e74  rimals, _tangent
+000135a0: 732c 2074 7261 6365 2c20 6465 7461 6368  s, trace, detach
+000135b0: 6564 3d46 616c 7365 290a 0a23 2020 2020  ed=False)..#    
+000135c0: 206a 7670 5f74 7261 6365 203d 206d 616b   jvp_trace = mak
+000135d0: 655f 7472 6163 6528 6a76 705f 6675 6e63  e_trace(jvp_func
+000135e0: 2c20 6578 6563 7574 6f72 3d65 7865 6375  , executor=execu
+000135f0: 746f 7229 282a 7072 696d 616c 732c 202a  tor)(*primals, *
+00013600: 7461 6e67 656e 7473 290a 2320 2020 2020  tangents).#     
+00013610: 6a76 705f 7472 6163 6564 203d 206d 616b  jvp_traced = mak
+00013620: 655f 7472 6163 6564 2870 6172 7469 616c  e_traced(partial
+00013630: 2865 7661 6c5f 7472 6163 652c 206a 7670  (eval_trace, jvp
+00013640: 5f74 7261 6365 292c 2065 7865 6375 746f  _trace), executo
+00013650: 723d 6578 6563 7574 6f72 290a 2320 2020  r=executor).#   
+00013660: 2020 7265 7475 726e 206a 7670 5f74 7261    return jvp_tra
+00013670: 6365 6428 2a70 7269 6d61 6c73 2c20 2a74  ced(*primals, *t
+00013680: 616e 6765 6e74 7329 0a0a 0a23 2056 4a50  angents)...# VJP
+00013690: 2074 7261 6e73 666f 726d 0a23 203d 3d3d   transform.# ===
+000136a0: 3d3d 3d3d 3d3d 3d3d 3d3d 0a40 6461 7461  ==========.@data
+000136b0: 636c 6173 7328 6672 6f7a 656e 3d54 7275  class(frozen=Tru
+000136c0: 6529 0a63 6c61 7373 2056 4a50 4475 616c  e).class VJPDual
+000136d0: 3a0a 2020 2020 2222 2241 2070 6169 7220  :.    """A pair 
+000136e0: 6f66 2070 7269 6d61 6c20 616e 6420 7361  of primal and sa
+000136f0: 7665 6420 696e 666f 726d 6174 696f 6e20  ved information 
+00013700: 666f 7220 6261 636b 7761 7264 2028 7265  for backward (re
+00013710: 7369 6475 616c 7329 2e0a 0a20 2020 2041  siduals)...    A
+00013720: 7267 733a 0a20 2020 2020 2020 2070 7269  rgs:.        pri
+00013730: 6d61 6c20 2855 6e69 6f6e 5b50 726f 7879  mal (Union[Proxy
+00013740: 2c20 4e75 6d62 6572 5d29 3a20 5072 696d  , Number]): Prim
+00013750: 616c 2076 616c 7565 2c20 692e 652e 2c20  al value, i.e., 
+00013760: 7468 6520 7661 6c75 6520 6265 696e 6720  the value being 
+00013770: 6469 6666 6572 656e 7469 6174 6564 2e0a  differentiated..
+00013780: 2020 2020 2020 2020 7265 7369 6475 616c          residual
+00013790: 7320 2854 7570 6c65 5b50 726f 7879 2c20  s (Tuple[Proxy, 
+000137a0: 2e2e 2e5d 293a 2052 6573 6964 7561 6c73  ...]): Residuals
+000137b0: 2c20 692e 652e 2c20 7468 6520 7661 6c75  , i.e., the valu
+000137c0: 6573 2074 6861 7420 6172 650a 2020 2020  es that are.    
+000137d0: 2020 2020 2020 2020 7361 7665 6420 666f          saved fo
+000137e0: 7220 7468 6520 6261 636b 7761 7264 2e0a  r the backward..
+000137f0: 0a20 2020 2059 6965 6c64 733a 0a20 2020  .    Yields:.   
+00013800: 2020 2020 2054 7570 6c65 5b56 6172 6961       Tuple[Varia
+00013810: 626c 652c 2054 7570 6c65 5b56 6172 6961  ble, Tuple[Varia
+00013820: 626c 652c 202e 2e2e 5d2c 2043 616c 6c61  ble, ...], Calla
+00013830: 626c 655d 3a20 5072 696d 616c 2061 6e64  ble]: Primal and
+00013840: 2072 6573 6964 7561 6c73 0a20 2020 2022   residuals.    "
+00013850: 2222 0a0a 2020 2020 7072 696d 616c 3a20  ""..    primal: 
+00013860: 5072 6f78 7920 7c20 4e75 6d62 6572 0a20  Proxy | Number. 
+00013870: 2020 2072 6573 6964 7561 6c73 3a20 7475     residuals: tu
+00013880: 706c 655b 5072 6f78 792c 202e 2e2e 5d0a  ple[Proxy, ...].
+00013890: 0a20 2020 2064 6566 205f 5f69 7465 725f  .    def __iter_
+000138a0: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
+000138b0: 2079 6965 6c64 2073 656c 662e 7072 696d   yield self.prim
+000138c0: 616c 0a20 2020 2020 2020 2079 6965 6c64  al.        yield
+000138d0: 2073 656c 662e 7265 7369 6475 616c 730a   self.residuals.
+000138e0: 0a0a 636c 6173 7320 4e6f 5075 6c6c 6261  ..class NoPullba
+000138f0: 636b 3a0a 2020 2020 2222 2241 2064 756d  ck:.    """A dum
+00013900: 6d79 2070 756c 6c62 6163 6b20 6675 6e63  my pullback func
+00013910: 7469 6f6e 2074 6861 7420 7265 7475 726e  tion that return
+00013920: 7320 4e6f 6e65 206f 7220 7261 6973 6573  s None or raises
+00013930: 2061 6e20 6572 726f 722e 2222 220a 0a20   an error.""".. 
+00013940: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00013950: 7365 6c66 2c20 6e75 6d5f 6172 6773 3d30  self, num_args=0
+00013960: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00013970: 6e75 6d5f 6172 6773 203d 206e 756d 5f61  num_args = num_a
+00013980: 7267 730a 0a20 2020 2064 6566 205f 5f63  rgs..    def __c
+00013990: 616c 6c5f 5f28 7365 6c66 2c20 2a61 7267  all__(self, *arg
+000139a0: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+000139b0: 2020 2020 2020 6966 2073 656c 662e 6e75        if self.nu
+000139c0: 6d5f 6172 6773 203e 2030 3a0a 2020 2020  m_args > 0:.    
+000139d0: 2020 2020 2020 2020 7265 7475 726e 2028          return (
+000139e0: 4e6f 6e65 2c29 202a 2073 656c 662e 6e75  None,) * self.nu
+000139f0: 6d5f 6172 6773 0a20 2020 2020 2020 2072  m_args.        r
+00013a00: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+00013a10: 7228 2250 756c 6c62 6163 6b20 6361 6c6c  r("Pullback call
+00013a20: 6564 206f 6e20 6120 6e6f 6e2d 6469 6666  ed on a non-diff
+00013a30: 6572 656e 7469 6162 6c65 2073 796d 626f  erentiable symbo
+00013a40: 6c20 6f72 2061 2063 6f6e 7374 616e 742e  l or a constant.
+00013a50: 2229 0a0a 0a63 6c61 7373 205a 6572 6f42  ")...class ZeroB
+00013a60: 6163 6b77 6172 643a 0a20 2020 2022 2222  ackward:.    """
+00013a70: 4120 6865 6c70 6572 2062 6163 6b77 6172  A helper backwar
+00013a80: 6420 6675 6e63 7469 6f6e 2074 6861 7420  d function that 
+00013a90: 7265 7475 726e 7320 7a65 726f 732e 2222  returns zeros.""
+00013aa0: 220a 0a20 2020 2064 6566 205f 5f69 6e69  "..    def __ini
+00013ab0: 745f 5f28 7365 6c66 2c20 6e75 6d5f 6172  t__(self, num_ar
+00013ac0: 6773 293a 0a20 2020 2020 2020 2073 656c  gs):.        sel
+00013ad0: 662e 6e75 6d5f 6172 6773 203d 206e 756d  f.num_args = num
+00013ae0: 5f61 7267 730a 0a20 2020 2064 6566 205f  _args..    def _
+00013af0: 5f63 616c 6c5f 5f28 7365 6c66 2c20 2a61  _call__(self, *a
+00013b00: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
+00013b10: 2020 2020 2020 2020 2320 4173 7375 6d69          # Assumi
+00013b20: 6e67 2074 6861 7420 7468 6520 6669 7273  ng that the firs
+00013b30: 7420 6172 6775 6d65 6e74 7320 6172 6520  t arguments are 
+00013b40: 7468 6520 666f 7277 6172 6420 6172 6775  the forward argu
+00013b50: 6d65 6e74 730a 2020 2020 2020 2020 666f  ments.        fo
+00013b60: 7277 6172 645f 6172 6773 203d 2061 7267  rward_args = arg
+00013b70: 735b 3a20 7365 6c66 2e6e 756d 5f61 7267  s[: self.num_arg
+00013b80: 735d 0a0a 2020 2020 2020 2020 6465 6620  s]..        def 
+00013b90: 7a65 726f 735f 6c69 6b65 2878 293a 0a20  zeros_like(x):. 
+00013ba0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00013bb0: 696e 7374 616e 6365 2878 2c20 5465 6e73  instance(x, Tens
+00013bc0: 6f72 5072 6f78 7929 3a0a 2020 2020 2020  orProxy):.      
+00013bd0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00013be0: 2066 756c 6c5f 6c69 6b65 2878 2c20 6669   full_like(x, fi
+00013bf0: 6c6c 5f76 616c 7565 3d30 290a 2020 2020  ll_value=0).    
+00013c00: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+00013c10: 6e73 7461 6e63 6528 782c 204e 756d 6265  nstance(x, Numbe
+00013c20: 7250 726f 7879 293a 0a20 2020 2020 2020  rProxy):.       
+00013c30: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00013c40: 7479 7065 2878 2e76 616c 7565 2928 3029  type(x.value)(0)
+00013c50: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00013c60: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+00013c70: 4e75 6d62 6572 293a 0a20 2020 2020 2020  Number):.       
+00013c80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00013c90: 7479 7065 2878 2928 3029 0a20 2020 2020  type(x)(0).     
+00013ca0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00013cb0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00013cc0: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
+00013cd0: 7a65 726f 735f 6c69 6b65 2069 6e73 6964  zeros_like insid
+00013ce0: 6520 5a65 726f 4261 636b 7761 7264 2067  e ZeroBackward g
+00013cf0: 6f74 2061 6e20 756e 7375 7070 6f72 7465  ot an unsupporte
+00013d00: 6420 7479 7065 207b 7479 7065 2878 297d  d type {type(x)}
+00013d10: 2229 0a0a 2020 2020 2020 2020 7265 7475  ")..        retu
+00013d20: 726e 2074 7570 6c65 287a 6572 6f73 5f6c  rn tuple(zeros_l
+00013d30: 696b 6528 6172 6729 2066 6f72 2061 7267  ike(arg) for arg
+00013d40: 2069 6e20 666f 7277 6172 645f 6172 6773   in forward_args
+00013d50: 290a 0a0a 2320 4d61 7070 696e 6720 6672  )...# Mapping fr
+00013d60: 6f6d 2073 796d 626f 6c73 2074 6f20 6175  om symbols to au
+00013d70: 676d 656e 7465 6420 7072 696d 616c 2028  gmented primal (
+00013d80: 666f 7277 6172 6429 2066 756e 6374 696f  forward) functio
+00013d90: 6e73 2075 7365 6420 696e 2056 4a50 0a23  ns used in VJP.#
+00013da0: 2054 6865 2061 7567 6d65 6e74 6564 5f70   The augmented_p
+00013db0: 7269 6d61 6c20 6675 6e63 7469 6f6e 2074  rimal function t
+00013dc0: 616b 6573 2074 6865 2070 7269 6d61 6c20  akes the primal 
+00013dd0: 7661 6c75 6573 2061 6e64 2072 6574 7572  values and retur
+00013de0: 6e73 2074 6865 2070 7269 6d61 6c0a 2320  ns the primal.# 
+00013df0: 7265 7375 6c74 2061 6e64 2074 6865 2072  result and the r
+00013e00: 6573 6964 7561 6c73 2028 7361 7665 6420  esiduals (saved 
+00013e10: 7661 6c75 6573 2066 6f72 2074 6865 2062  values for the b
+00013e20: 6163 6b77 6172 6429 2e0a 6175 676d 656e  ackward)..augmen
+00013e30: 7465 645f 666f 7277 6172 645f 696d 706c  ted_forward_impl
+00013e40: 7320 3d20 7b0a 2020 2020 7072 696d 732e  s = {.    prims.
+00013e50: 5072 696d 4944 732e 4143 4f53 3a20 6c61  PrimIDs.ACOS: la
+00013e60: 6d62 6461 2078 3a20 2870 7269 6d73 2e61  mbda x: (prims.a
+00013e70: 636f 7328 7829 2c20 2878 2c29 292c 0a20  cos(x), (x,)),. 
+00013e80: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00013e90: 2e41 434f 5348 3a20 6c61 6d62 6461 2078  .ACOSH: lambda x
+00013ea0: 3a20 2870 7269 6d73 2e61 636f 7368 2878  : (prims.acosh(x
+00013eb0: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
+00013ec0: 696d 732e 5072 696d 4944 732e 4153 494e  ims.PrimIDs.ASIN
+00013ed0: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
+00013ee0: 6d73 2e61 7369 6e28 7829 2c20 2878 2c29  ms.asin(x), (x,)
+00013ef0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00013f00: 6d49 4473 2e41 5349 4e48 3a20 6c61 6d62  mIDs.ASINH: lamb
+00013f10: 6461 2078 3a20 2870 7269 6d73 2e61 7369  da x: (prims.asi
+00013f20: 6e68 2878 292c 2028 782c 2929 2c0a 2020  nh(x), (x,)),.  
+00013f30: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00013f40: 4154 414e 3a20 6c61 6d62 6461 2078 3a20  ATAN: lambda x: 
+00013f50: 2870 7269 6d73 2e61 7461 6e28 7829 2c20  (prims.atan(x), 
+00013f60: 2878 2c29 292c 0a20 2020 2070 7269 6d73  (x,)),.    prims
+00013f70: 2e50 7269 6d49 4473 2e41 5441 4e48 3a20  .PrimIDs.ATANH: 
+00013f80: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
+00013f90: 2e61 7461 6e68 2878 292c 2028 782c 2929  .atanh(x), (x,))
+00013fa0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00013fb0: 4944 732e 4154 414e 323a 206c 616d 6264  IDs.ATAN2: lambd
+00013fc0: 6120 782c 2079 3a20 2870 7269 6d73 2e61  a x, y: (prims.a
+00013fd0: 7461 6e32 2878 2c20 7929 2c20 2878 2c20  tan2(x, y), (x, 
+00013fe0: 7929 292c 0a20 2020 2070 7269 6d73 2e50  y)),.    prims.P
+00013ff0: 7269 6d49 4473 2e43 4f53 483a 206c 616d  rimIDs.COSH: lam
+00014000: 6264 6120 783a 2028 7072 696d 732e 636f  bda x: (prims.co
+00014010: 7368 2878 292c 2028 782c 2929 2c0a 2020  sh(x), (x,)),.  
+00014020: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014030: 4449 4741 4d4d 413a 206c 616d 6264 6120  DIGAMMA: lambda 
+00014040: 783a 2028 7072 696d 732e 6469 6761 6d6d  x: (prims.digamm
+00014050: 6128 7829 2c20 2878 2c29 292c 0a20 2020  a(x), (x,)),.   
+00014060: 2070 7269 6d73 2e50 7269 6d49 4473 2e45   prims.PrimIDs.E
+00014070: 5246 433a 206c 616d 6264 6120 783a 2028  RFC: lambda x: (
+00014080: 7072 696d 732e 6572 6663 2878 292c 2028  prims.erfc(x), (
+00014090: 782c 2929 2c0a 2020 2020 7072 696d 732e  x,)),.    prims.
+000140a0: 5072 696d 4944 732e 4552 4649 4e56 3a20  PrimIDs.ERFINV: 
+000140b0: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
+000140c0: 2e65 7266 696e 7628 7829 2c20 2870 7269  .erfinv(x), (pri
+000140d0: 6d73 2e65 7266 696e 7628 7829 2c29 292c  ms.erfinv(x),)),
+000140e0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+000140f0: 4473 2e45 5246 4349 4e56 3a20 6c61 6d62  Ds.ERFCINV: lamb
+00014100: 6461 2078 3a20 2870 7269 6d73 2e65 7266  da x: (prims.erf
+00014110: 6369 6e76 2878 292c 2028 7072 696d 732e  cinv(x), (prims.
+00014120: 6572 6663 696e 7628 7829 2c29 292c 0a20  erfcinv(x),)),. 
+00014130: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014140: 2e45 5850 323a 206c 616d 6264 6120 783a  .EXP2: lambda x:
+00014150: 2028 7072 696d 732e 6578 7032 2878 292c   (prims.exp2(x),
+00014160: 2028 7072 696d 732e 6578 7032 2878 292c   (prims.exp2(x),
+00014170: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+00014180: 696d 4944 732e 4558 504d 313a 206c 616d  imIDs.EXPM1: lam
+00014190: 6264 6120 783a 2028 7072 696d 732e 6578  bda x: (prims.ex
+000141a0: 706d 3128 7829 2c20 2870 7269 6d73 2e65  pm1(x), (prims.e
+000141b0: 7870 6d31 2878 292c 2929 2c0a 2020 2020  xpm1(x),)),.    
+000141c0: 7072 696d 732e 5072 696d 4944 732e 4c47  prims.PrimIDs.LG
+000141d0: 414d 4d41 3a20 6c61 6d62 6461 2078 3a20  AMMA: lambda x: 
+000141e0: 2870 7269 6d73 2e6c 6761 6d6d 6128 7829  (prims.lgamma(x)
+000141f0: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
+00014200: 6d73 2e50 7269 6d49 4473 2e4e 4454 5249  ms.PrimIDs.NDTRI
+00014210: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
+00014220: 6d73 2e6e 6474 7269 2878 292c 2028 7072  ms.ndtri(x), (pr
+00014230: 696d 732e 6e64 7472 6928 7829 2c29 292c  ims.ndtri(x),)),
+00014240: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+00014250: 4473 2e53 494e 483a 206c 616d 6264 6120  Ds.SINH: lambda 
+00014260: 783a 2028 7072 696d 732e 7369 6e68 2878  x: (prims.sinh(x
+00014270: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
+00014280: 696d 732e 5072 696d 4944 732e 5351 5254  ims.PrimIDs.SQRT
+00014290: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
+000142a0: 6d73 2e73 7172 7428 7829 2c20 2870 7269  ms.sqrt(x), (pri
+000142b0: 6d73 2e73 7172 7428 7829 2c29 292c 0a20  ms.sqrt(x),)),. 
+000142c0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+000142d0: 2e4e 453a 206c 616d 6264 6120 782c 2079  .NE: lambda x, y
+000142e0: 3a20 2870 7269 6d73 2e6e 6528 782c 2079  : (prims.ne(x, y
+000142f0: 292c 2028 782c 2079 2929 2c0a 2020 2020  ), (x, y)),.    
+00014300: 7072 696d 732e 5072 696d 4944 732e 4754  prims.PrimIDs.GT
+00014310: 3a20 6c61 6d62 6461 2078 2c20 793a 2028  : lambda x, y: (
+00014320: 7072 696d 732e 6774 2878 2c20 7929 2c20  prims.gt(x, y), 
+00014330: 2878 2c20 7929 292c 0a20 2020 2070 7269  (x, y)),.    pri
+00014340: 6d73 2e50 7269 6d49 4473 2e4c 453a 206c  ms.PrimIDs.LE: l
+00014350: 616d 6264 6120 782c 2079 3a20 2870 7269  ambda x, y: (pri
+00014360: 6d73 2e6c 6528 782c 2079 292c 2028 782c  ms.le(x, y), (x,
+00014370: 2079 2929 2c0a 2020 2020 7072 696d 732e   y)),.    prims.
+00014380: 5072 696d 4944 732e 4c4f 4731 303a 206c  PrimIDs.LOG10: l
+00014390: 616d 6264 6120 783a 2028 7072 696d 732e  ambda x: (prims.
+000143a0: 6c6f 6731 3028 7829 2c20 2878 2c29 292c  log10(x), (x,)),
+000143b0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+000143c0: 4473 2e4c 4f47 3150 3a20 6c61 6d62 6461  Ds.LOG1P: lambda
+000143d0: 2078 3a20 2870 7269 6d73 2e6c 6f67 3170   x: (prims.log1p
+000143e0: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
+000143f0: 7072 696d 732e 5072 696d 4944 732e 4c4f  prims.PrimIDs.LO
+00014400: 4732 3a20 6c61 6d62 6461 2078 3a20 2870  G2: lambda x: (p
+00014410: 7269 6d73 2e6c 6f67 3228 7829 2c20 2878  rims.log2(x), (x
+00014420: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
+00014430: 7269 6d49 4473 2e5a 4554 413a 206c 616d  rimIDs.ZETA: lam
+00014440: 6264 6120 782c 2079 3a20 2870 7269 6d73  bda x, y: (prims
+00014450: 2e7a 6574 6128 782c 2079 292c 2028 782c  .zeta(x, y), (x,
+00014460: 2079 2929 2c0a 2020 2020 7072 696d 732e   y)),.    prims.
+00014470: 5072 696d 4944 732e 464d 4f44 3a20 6c61  PrimIDs.FMOD: la
+00014480: 6d62 6461 2078 2c20 793a 2028 7072 696d  mbda x, y: (prim
+00014490: 732e 666d 6f64 2878 2c20 7929 2c20 2878  s.fmod(x, y), (x
+000144a0: 2c20 7929 292c 0a7d 0a0a 0a23 204d 6170  , y)),.}...# Map
+000144b0: 7069 6e67 2066 726f 6d20 7379 6d62 6f6c  ping from symbol
+000144c0: 7320 746f 2062 6163 6b77 6172 6420 6675  s to backward fu
+000144d0: 6e63 7469 6f6e 7320 7573 6564 2069 6e20  nctions used in 
+000144e0: 564a 500a 2320 5468 6520 6261 636b 7761  VJP.# The backwa
+000144f0: 7264 2066 756e 6374 696f 6e20 7461 6b65  rd function take
+00014500: 7320 7468 6520 7265 7369 6475 616c 7320  s the residuals 
+00014510: 616e 6420 636f 7461 6e67 656e 7473 2061  and cotangents a
+00014520: 6e64 2072 6574 7572 6e73 2074 6865 0a23  nd returns the.#
+00014530: 2076 6563 746f 722d 4a61 636f 6269 616e   vector-Jacobian
+00014540: 2070 726f 6475 6374 7320 666f 7220 6561   products for ea
+00014550: 6368 2061 7267 756d 656e 742e 0a62 6163  ch argument..bac
+00014560: 6b77 6172 645f 696d 706c 7320 3d20 7b0a  kward_impls = {.
+00014570: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014580: 732e 4143 4f53 3a20 6c61 6d62 6461 2078  s.ACOS: lambda x
+00014590: 2c20 673a 202d 6720 2f20 7072 696d 732e  , g: -g / prims.
+000145a0: 7371 7274 2831 2e30 202d 2078 202a 2078  sqrt(1.0 - x * x
+000145b0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+000145c0: 6d49 4473 2e41 434f 5348 3a20 6c61 6d62  mIDs.ACOSH: lamb
+000145d0: 6461 2078 2c20 673a 2067 202a 2070 7269  da x, g: g * pri
+000145e0: 6d73 2e72 7371 7274 2878 202a 2078 202d  ms.rsqrt(x * x -
+000145f0: 2031 2e30 292c 0a20 2020 2070 7269 6d73   1.0),.    prims
+00014600: 2e50 7269 6d49 4473 2e41 5349 4e3a 206c  .PrimIDs.ASIN: l
+00014610: 616d 6264 6120 782c 2067 3a20 6720 2f20  ambda x, g: g / 
+00014620: 7072 696d 732e 7371 7274 2831 2e30 202d  prims.sqrt(1.0 -
+00014630: 2078 202a 2078 292c 0a20 2020 2070 7269   x * x),.    pri
+00014640: 6d73 2e50 7269 6d49 4473 2e41 5349 4e48  ms.PrimIDs.ASINH
+00014650: 3a20 6c61 6d62 6461 2078 2c20 673a 2067  : lambda x, g: g
+00014660: 202a 2070 7269 6d73 2e72 7371 7274 2831   * prims.rsqrt(1
+00014670: 2e30 202b 2078 202a 2078 292c 0a20 2020  .0 + x * x),.   
+00014680: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
+00014690: 5441 4e3a 206c 616d 6264 6120 782c 2067  TAN: lambda x, g
+000146a0: 3a20 6720 2f20 2831 2e30 202b 2078 202a  : g / (1.0 + x *
+000146b0: 2078 292c 0a20 2020 2070 7269 6d73 2e50   x),.    prims.P
+000146c0: 7269 6d49 4473 2e41 5441 4e48 3a20 6c61  rimIDs.ATANH: la
+000146d0: 6d62 6461 2078 2c20 673a 2067 202f 2028  mbda x, g: g / (
+000146e0: 312e 3020 2d20 7820 2a20 7829 2c0a 2020  1.0 - x * x),.  
+000146f0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014700: 434f 5348 3a20 6c61 6d62 6461 2078 2c20  COSH: lambda x, 
+00014710: 673a 2070 7269 6d73 2e6d 756c 2867 2c20  g: prims.mul(g, 
+00014720: 7072 696d 732e 7369 6e68 2878 2929 2c0a  prims.sinh(x)),.
+00014730: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014740: 732e 4552 4643 3a20 6c61 6d62 6461 2078  s.ERFC: lambda x
+00014750: 2c20 673a 202d 6720 2a20 322e 3020 2f20  , g: -g * 2.0 / 
+00014760: 6d61 7468 2e73 7172 7428 6d61 7468 2e70  math.sqrt(math.p
+00014770: 6929 202a 2070 7269 6d73 2e65 7870 282d  i) * prims.exp(-
+00014780: 7820 2a20 7829 2c0a 2020 2020 7072 696d  x * x),.    prim
+00014790: 732e 5072 696d 4944 732e 4552 4649 4e56  s.PrimIDs.ERFINV
+000147a0: 3a20 6c61 6d62 6461 2072 6573 756c 742c  : lambda result,
+000147b0: 2067 3a20 6720 2a20 302e 3520 2a20 6d61   g: g * 0.5 * ma
+000147c0: 7468 2e73 7172 7428 6d61 7468 2e70 6929  th.sqrt(math.pi)
+000147d0: 202a 2070 7269 6d73 2e65 7870 2872 6573   * prims.exp(res
+000147e0: 756c 742a 2a32 292c 0a20 2020 2070 7269  ult**2),.    pri
+000147f0: 6d73 2e50 7269 6d49 4473 2e45 5246 4349  ms.PrimIDs.ERFCI
+00014800: 4e56 3a20 6c61 6d62 6461 2072 6573 756c  NV: lambda resul
+00014810: 742c 2067 3a20 2d67 202a 2030 2e35 202a  t, g: -g * 0.5 *
+00014820: 206d 6174 682e 7371 7274 286d 6174 682e   math.sqrt(math.
+00014830: 7069 2920 2a20 7072 696d 732e 6578 7028  pi) * prims.exp(
+00014840: 7265 7375 6c74 2a2a 3229 2c0a 2020 2020  result**2),.    
+00014850: 7072 696d 732e 5072 696d 4944 732e 4558  prims.PrimIDs.EX
+00014860: 5032 3a20 6c61 6d62 6461 2072 6573 756c  P2: lambda resul
+00014870: 742c 2067 3a20 6720 2a20 7265 7375 6c74  t, g: g * result
+00014880: 202a 206d 6174 682e 6c6f 6728 322e 3029   * math.log(2.0)
+00014890: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+000148a0: 4944 732e 4558 504d 313a 206c 616d 6264  IDs.EXPM1: lambd
+000148b0: 6120 7265 7375 6c74 2c20 673a 2067 202a  a result, g: g *
+000148c0: 2028 7265 7375 6c74 202b 2031 2e30 292c   (result + 1.0),
+000148d0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+000148e0: 4473 2e4c 4741 4d4d 413a 206c 616d 6264  Ds.LGAMMA: lambd
+000148f0: 6120 782c 2067 3a20 6720 2a20 7072 696d  a x, g: g * prim
+00014900: 732e 6469 6761 6d6d 6128 7829 2c0a 2020  s.digamma(x),.  
+00014910: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014920: 4e44 5452 493a 206c 616d 6264 6120 7265  NDTRI: lambda re
+00014930: 7375 6c74 2c20 673a 2067 202a 2070 7269  sult, g: g * pri
+00014940: 6d73 2e65 7870 2830 2e35 202a 2072 6573  ms.exp(0.5 * res
+00014950: 756c 742a 2a32 2920 2a20 6d61 7468 2e73  ult**2) * math.s
+00014960: 7172 7428 322e 3020 2a20 6d61 7468 2e70  qrt(2.0 * math.p
+00014970: 6929 2c0a 2020 2020 7072 696d 732e 5072  i),.    prims.Pr
+00014980: 696d 4944 732e 5349 4e48 3a20 6c61 6d62  imIDs.SINH: lamb
+00014990: 6461 2078 2c20 673a 2070 7269 6d73 2e6d  da x, g: prims.m
+000149a0: 756c 2867 2c20 7072 696d 732e 636f 7368  ul(g, prims.cosh
+000149b0: 2878 2929 2c0a 2020 2020 7072 696d 732e  (x)),.    prims.
+000149c0: 5072 696d 4944 732e 5351 5254 3a20 6c61  PrimIDs.SQRT: la
+000149d0: 6d62 6461 2072 6573 756c 742c 2067 3a20  mbda result, g: 
+000149e0: 6720 2f20 2832 2e30 202a 2072 6573 756c  g / (2.0 * resul
+000149f0: 7429 2c0a 2020 2020 7072 696d 732e 5072  t),.    prims.Pr
+00014a00: 696d 4944 732e 4e45 3a20 5a65 726f 4261  imIDs.NE: ZeroBa
+00014a10: 636b 7761 7264 286e 756d 5f61 7267 733d  ckward(num_args=
+00014a20: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
+00014a30: 696d 4944 732e 4754 3a20 5a65 726f 4261  imIDs.GT: ZeroBa
+00014a40: 636b 7761 7264 286e 756d 5f61 7267 733d  ckward(num_args=
+00014a50: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
+00014a60: 696d 4944 732e 4c45 3a20 5a65 726f 4261  imIDs.LE: ZeroBa
+00014a70: 636b 7761 7264 286e 756d 5f61 7267 733d  ckward(num_args=
+00014a80: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
+00014a90: 696d 4944 732e 4c4f 4731 303a 206c 616d  imIDs.LOG10: lam
+00014aa0: 6264 6120 782c 2067 3a20 6720 2f20 2878  bda x, g: g / (x
+00014ab0: 202a 2032 2e33 3032 3538 3530 3932 3939   * 2.30258509299
+00014ac0: 3430 3436 292c 0a20 2020 2070 7269 6d73  4046),.    prims
+00014ad0: 2e50 7269 6d49 4473 2e4c 4f47 3150 3a20  .PrimIDs.LOG1P: 
+00014ae0: 6c61 6d62 6461 2078 2c20 673a 2067 202f  lambda x, g: g /
+00014af0: 2028 7820 2b20 3129 2c0a 2020 2020 7072   (x + 1),.    pr
+00014b00: 696d 732e 5072 696d 4944 732e 4c4f 4732  ims.PrimIDs.LOG2
+00014b10: 3a20 6c61 6d62 6461 2078 2c20 673a 2067  : lambda x, g: g
+00014b20: 202f 2028 7820 2a20 302e 3639 3331 3437   / (x * 0.693147
+00014b30: 3138 3035 3539 3934 3533 292c 0a20 2020  1805599453),.   
+00014b40: 2070 7269 6d73 2e50 7269 6d49 4473 2e46   prims.PrimIDs.F
+00014b50: 4d4f 443a 206c 616d 6264 6120 782c 2079  MOD: lambda x, y
+00014b60: 2c20 673a 2028 672c 202d 6720 2a20 7072  , g: (g, -g * pr
+00014b70: 696d 732e 7472 756e 6328 7820 2f20 7929  ims.trunc(x / y)
+00014b80: 292c 0a7d 0a0a 0a64 6566 2072 6567 6973  ),.}...def regis
+00014b90: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
+00014ba0: 7277 6172 6428 6f70 293a 0a20 2020 2022  rward(op):.    "
+00014bb0: 2222 4465 636f 7261 746f 7220 746f 2072  ""Decorator to r
+00014bc0: 6567 6973 7465 7220 616e 2061 7567 6d65  egister an augme
+00014bd0: 6e74 6564 2066 6f72 7761 7264 2069 6d70  nted forward imp
+00014be0: 6c65 6d65 6e74 6174 696f 6e20 666f 7220  lementation for 
+00014bf0: 6120 7379 6d62 6f6c 2e0a 0a20 2020 2041  a symbol...    A
+00014c00: 7267 733a 0a20 2020 2020 2020 206f 7020  rgs:.        op 
+00014c10: 284f 7073 293a 2053 796d 626f 6c20 666f  (Ops): Symbol fo
+00014c20: 7220 7768 6963 6820 746f 2072 6567 6973  r which to regis
+00014c30: 7465 7220 7468 6520 6175 676d 656e 7465  ter the augmente
+00014c40: 6420 666f 7277 6172 6420 696d 706c 656d  d forward implem
+00014c50: 656e 7461 7469 6f6e 2e0a 0a20 2020 2052  entation...    R
+00014c60: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+00014c70: 4361 6c6c 6162 6c65 3a20 4465 636f 7261  Callable: Decora
+00014c80: 746f 7220 6675 6e63 7469 6f6e 2e0a 2020  tor function..  
+00014c90: 2020 2222 220a 0a20 2020 2064 6566 2064    """..    def d
+00014ca0: 6563 6f72 6174 6f72 2866 756e 6329 3a0a  ecorator(func):.
+00014cb0: 2020 2020 2020 2020 6175 676d 656e 7465          augmente
+00014cc0: 645f 666f 7277 6172 645f 696d 706c 735b  d_forward_impls[
+00014cd0: 6f70 5d20 3d20 6675 6e63 0a20 2020 2020  op] = func.     
+00014ce0: 2020 2072 6574 7572 6e20 6675 6e63 0a0a     return func..
+00014cf0: 2020 2020 7265 7475 726e 2064 6563 6f72      return decor
+00014d00: 6174 6f72 0a0a 0a64 6566 2072 6567 6973  ator...def regis
+00014d10: 7465 725f 6261 636b 7761 7264 286f 7029  ter_backward(op)
+00014d20: 3a0a 2020 2020 2222 2244 6563 6f72 6174  :.    """Decorat
+00014d30: 6f72 2074 6f20 7265 6769 7374 6572 2061  or to register a
+00014d40: 2062 6163 6b77 6172 6420 696d 706c 656d   backward implem
+00014d50: 656e 7461 7469 6f6e 2066 6f72 2061 2073  entation for a s
+00014d60: 796d 626f 6c2e 0a0a 2020 2020 4172 6773  ymbol...    Args
+00014d70: 3a0a 2020 2020 2020 2020 6f70 2028 4f70  :.        op (Op
+00014d80: 7329 3a20 5379 6d62 6f6c 2066 6f72 2077  s): Symbol for w
+00014d90: 6869 6368 2074 6f20 7265 6769 7374 6572  hich to register
+00014da0: 2074 6865 2062 6163 6b77 6172 6420 696d   the backward im
+00014db0: 706c 656d 656e 7461 7469 6f6e 2e0a 0a20  plementation... 
+00014dc0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+00014dd0: 2020 2020 4361 6c6c 6162 6c65 3a20 4465      Callable: De
+00014de0: 636f 7261 746f 7220 6675 6e63 7469 6f6e  corator function
+00014df0: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
+00014e00: 6566 2064 6563 6f72 6174 6f72 2866 756e  ef decorator(fun
+00014e10: 6329 3a0a 2020 2020 2020 2020 6261 636b  c):.        back
+00014e20: 7761 7264 5f69 6d70 6c73 5b6f 705d 203d  ward_impls[op] =
+00014e30: 2066 756e 630a 2020 2020 2020 2020 7265   func.        re
+00014e40: 7475 726e 2066 756e 630a 0a20 2020 2072  turn func..    r
+00014e50: 6574 7572 6e20 6465 636f 7261 746f 720a  eturn decorator.
+00014e60: 0a0a 6465 6620 7265 7374 6f72 655f 7265  ..def restore_re
+00014e70: 6475 6365 645f 6469 6d73 2878 2c20 7265  duced_dims(x, re
+00014e80: 6475 6365 645f 6469 6d73 2c20 6f72 6967  duced_dims, orig
+00014e90: 696e 616c 5f73 6861 7065 293a 0a20 2020  inal_shape):.   
+00014ea0: 2022 2222 5265 7374 6f72 6573 2074 6865   """Restores the
+00014eb0: 2072 6564 7563 6564 2064 696d 656e 7369   reduced dimensi
+00014ec0: 6f6e 7320 6f66 2061 2074 656e 736f 722e  ons of a tensor.
+00014ed0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+00014ee0: 2020 2020 7820 2856 6172 6961 626c 6529      x (Variable)
+00014ef0: 3a20 5465 6e73 6f72 2074 6f20 6265 2072  : Tensor to be r
+00014f00: 6573 6861 7065 642e 0a20 2020 2020 2020  eshaped..       
+00014f10: 2072 6564 7563 6564 5f64 696d 7320 2854   reduced_dims (T
+00014f20: 7570 6c65 5b69 6e74 2c20 2e2e 2e5d 293a  uple[int, ...]):
+00014f30: 2054 7570 6c65 206f 6620 7265 6475 6365   Tuple of reduce
+00014f40: 6420 6469 6d65 6e73 696f 6e73 2e0a 2020  d dimensions..  
+00014f50: 2020 2020 2020 6f72 6967 696e 616c 5f73        original_s
+00014f60: 6861 7065 2028 5475 706c 655b 696e 742c  hape (Tuple[int,
+00014f70: 202e 2e2e 5d29 3a20 4f72 6967 696e 616c   ...]): Original
+00014f80: 2073 6861 7065 206f 6620 7468 6520 7465   shape of the te
+00014f90: 6e73 6f72 2e0a 0a20 2020 2052 6574 7572  nsor...    Retur
+00014fa0: 6e73 3a0a 2020 2020 2020 2020 5661 7269  ns:.        Vari
+00014fb0: 6162 6c65 3a20 5465 6e73 6f72 2077 6974  able: Tensor wit
+00014fc0: 6820 7468 6520 7265 6475 6365 6420 6469  h the reduced di
+00014fd0: 6d65 6e73 696f 6e73 2072 6573 746f 7265  mensions restore
+00014fe0: 642e 0a20 2020 2022 2222 0a20 2020 2069  d..    """.    i
+00014ff0: 6620 6f72 6967 696e 616c 5f73 6861 7065  f original_shape
+00015000: 203d 3d20 2829 3a20 2023 2073 6361 6c61   == ():  # scala
+00015010: 720a 2020 2020 2020 2020 7265 7475 726e  r.        return
+00015020: 2078 0a0a 2020 2020 756e 7371 7565 657a   x..    unsqueez
+00015030: 6564 203d 2063 6c61 6e67 2e75 6e73 7175  ed = clang.unsqu
+00015040: 6565 7a65 2878 2c20 7265 6475 6365 645f  eeze(x, reduced_
+00015050: 6469 6d73 290a 2020 2020 7265 7475 726e  dims).    return
+00015060: 2063 6c61 6e67 2e65 7870 616e 6428 756e   clang.expand(un
+00015070: 7371 7565 657a 6564 2c20 6f72 6967 696e  squeezed, origin
+00015080: 616c 5f73 6861 7065 290a 0a0a 4072 6567  al_shape)...@reg
+00015090: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
+000150a0: 7269 6d73 2e50 7269 6d49 4473 2e5a 4554  rims.PrimIDs.ZET
+000150b0: 4129 0a64 6566 207a 6574 615f 6261 636b  A).def zeta_back
+000150c0: 7761 7264 2878 2c20 792c 2067 293a 0a20  ward(x, y, g):. 
+000150d0: 2020 2023 2054 6865 2064 6572 6976 6174     # The derivat
+000150e0: 6976 6520 7772 7420 7468 6520 6669 7273  ive wrt the firs
+000150f0: 7420 6172 6775 6d65 6e74 2069 7320 6e6f  t argument is no
+00015100: 7420 6578 7072 6573 7369 626c 6520 696e  t expressible in
+00015110: 2074 6572 6d73 206f 6620 7a65 7461 206f   terms of zeta o
+00015120: 720a 2020 2020 2320 6f74 6865 7220 7370  r.    # other sp
+00015130: 6563 6961 6c20 6675 6e63 7469 6f6e 730a  ecial functions.
+00015140: 2020 2020 2320 5468 6572 6566 6f72 652c      # Therefore,
+00015150: 2077 6520 636f 6d70 7574 6520 6f6e 6c79   we compute only
+00015160: 2074 6865 2064 6572 6976 6174 6976 6520   the derivative 
+00015170: 7772 7420 7468 6520 7365 636f 6e64 2061  wrt the second a
+00015180: 7267 756d 656e 740a 2020 2020 6779 203d  rgument.    gy =
+00015190: 2067 202a 202d 7820 2a20 7072 696d 732e   g * -x * prims.
+000151a0: 7a65 7461 2878 202b 2031 2e30 2c20 7929  zeta(x + 1.0, y)
+000151b0: 0a0a 2020 2020 2320 5265 7475 726e 2061  ..    # Return a
+000151c0: 206d 6170 7070 696e 6720 6672 6f6d 2074   mappping from t
+000151d0: 6865 2066 6f72 7761 7264 2061 7267 756d  he forward argum
+000151e0: 656e 7473 2074 6f20 7468 6520 6772 6164  ents to the grad
+000151f0: 6965 6e74 730a 2020 2020 7265 7475 726e  ients.    return
+00015200: 207b 2279 223a 2067 797d 0a0a 0a40 7265   {"y": gy}...@re
+00015210: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+00015220: 7072 696d 732e 5072 696d 4944 732e 4449  prims.PrimIDs.DI
+00015230: 4741 4d4d 4129 0a64 6566 2064 6967 616d  GAMMA).def digam
+00015240: 6d61 5f62 6163 6b77 6172 6428 613a 2050  ma_backward(a: P
+00015250: 726f 7879 2c20 6729 3a0a 2020 2020 6672  roxy, g):.    fr
+00015260: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
+00015270: 2069 6d70 6f72 7420 706f 6c79 6761 6d6d   import polygamm
+00015280: 610a 0a20 2020 2072 6574 7572 6e20 6720  a..    return g 
+00015290: 2a20 706f 6c79 6761 6d6d 6128 312c 2061  * polygamma(1, a
+000152a0: 290a 0a0a 4072 6567 6973 7465 725f 6175  )...@register_au
+000152b0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
+000152c0: 2274 6f72 6368 2e70 6f6c 7967 616d 6d61  "torch.polygamma
+000152d0: 2229 0a64 6566 2070 6f6c 7967 616d 6d61  ").def polygamma
+000152e0: 5f61 7567 5f66 7764 286e 3a20 696e 742c  _aug_fwd(n: int,
+000152f0: 2061 3a20 5072 6f78 7929 3a0a 2020 2020   a: Proxy):.    
+00015300: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
+00015310: 6368 2069 6d70 6f72 7420 706f 6c79 6761  ch import polyga
+00015320: 6d6d 610a 0a20 2020 2070 7269 6d61 6c20  mma..    primal 
+00015330: 3d20 706f 6c79 6761 6d6d 6128 6e2c 2061  = polygamma(n, a
+00015340: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
+00015350: 3d20 286e 2c20 6129 0a20 2020 2072 6574  = (n, a).    ret
+00015360: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
+00015370: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
+00015380: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+00015390: 6172 6428 2274 6f72 6368 2e70 6f6c 7967  ard("torch.polyg
+000153a0: 616d 6d61 2229 0a64 6566 2070 6f6c 7967  amma").def polyg
+000153b0: 616d 6d61 5f62 6163 6b77 6172 6428 6e3a  amma_backward(n:
+000153c0: 2069 6e74 2c20 613a 2050 726f 7879 2c20   int, a: Proxy, 
+000153d0: 6729 3a0a 2020 2020 6672 6f6d 2074 6875  g):.    from thu
+000153e0: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
+000153f0: 7420 706f 6c79 6761 6d6d 610a 0a20 2020  t polygamma..   
+00015400: 2072 6574 7572 6e20 4e6f 6e65 2c20 6720   return None, g 
+00015410: 2a20 706f 6c79 6761 6d6d 6128 6e20 2b20  * polygamma(n + 
+00015420: 312c 2061 290a 0a0a 4072 6567 6973 7465  1, a)...@registe
+00015430: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
+00015440: 2e50 7269 6d49 4473 2e41 5441 4e32 290a  .PrimIDs.ATAN2).
+00015450: 6465 6620 6174 616e 325f 6261 636b 7761  def atan2_backwa
+00015460: 7264 2878 2c20 792c 2067 293a 0a20 2020  rd(x, y, g):.   
+00015470: 2061 6c70 6861 203d 2031 2e30 202f 2028   alpha = 1.0 / (
+00015480: 7820 2a20 7820 2b20 7920 2a20 7929 0a20  x * x + y * y). 
+00015490: 2020 2067 7261 645f 7820 3d20 6720 2a20     grad_x = g * 
+000154a0: 7920 2a20 616c 7068 610a 2020 2020 6772  y * alpha.    gr
+000154b0: 6164 5f79 203d 2067 202a 202d 7820 2a20  ad_y = g * -x * 
+000154c0: 616c 7068 610a 2020 2020 7265 7475 726e  alpha.    return
+000154d0: 2067 7261 645f 782c 2067 7261 645f 790a   grad_x, grad_y.
+000154e0: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
+000154f0: 656e 7465 645f 666f 7277 6172 6428 7072  ented_forward(pr
+00015500: 696d 732e 5072 696d 4944 732e 5641 5229  ims.PrimIDs.VAR)
+00015510: 0a64 6566 2076 6172 5f61 7567 5f66 7764  .def var_aug_fwd
+00015520: 2861 2c20 6469 6d2c 202a 2c20 636f 7272  (a, dim, *, corr
+00015530: 6563 7469 6f6e 293a 0a20 2020 2076 203d  ection):.    v =
+00015540: 2070 7269 6d73 2e76 6172 2861 2c20 6469   prims.var(a, di
+00015550: 6d2c 2063 6f72 7265 6374 696f 6e3d 636f  m, correction=co
+00015560: 7272 6563 7469 6f6e 290a 2020 2020 7265  rrection).    re
+00015570: 7475 726e 2056 4a50 4475 616c 2828 762c  turn VJPDual((v,
+00015580: 292c 2028 612c 2064 696d 2c20 636f 7272  ), (a, dim, corr
+00015590: 6563 7469 6f6e 2c20 7629 290a 0a0a 2320  ection, v))...# 
+000155a0: 544f 444f 3a20 6669 7820 6469 7669 7369  TODO: fix divisi
+000155b0: 6f6e 2062 7920 7a65 726f 2077 6865 6e20  on by zero when 
+000155c0: 6e5f 656c 656d 5f72 6564 7563 6564 203d  n_elem_reduced =
+000155d0: 3d20 3020 6f72 2077 6865 6e20 762e 6e75  = 0 or when v.nu
+000155e0: 6d65 6c20 3d3d 2030 0a23 2062 7920 7265  mel == 0.# by re
+000155f0: 7475 726e 696e 6720 7a65 726f 735f 6c69  turning zeros_li
+00015600: 6b65 2861 2920 6f72 2073 696d 696c 6172  ke(a) or similar
+00015610: 2e0a 2320 544f 444f 3a20 6669 7820 6772  ..# TODO: fix gr
+00015620: 6164 2077 6865 6e20 636f 7272 6563 7469  ad when correcti
+00015630: 6f6e 203e 206e 5f65 6c65 6d5f 7265 6475  on > n_elem_redu
+00015640: 6365 642e 0a40 7265 6769 7374 6572 5f62  ced..@register_b
+00015650: 6163 6b77 6172 6428 7072 696d 732e 5072  ackward(prims.Pr
+00015660: 696d 4944 732e 5641 5229 0a64 6566 2076  imIDs.VAR).def v
+00015670: 6172 5f62 6163 6b77 6172 6428 612c 2064  ar_backward(a, d
+00015680: 696d 2c20 636f 7272 6563 7469 6f6e 2c20  im, correction, 
+00015690: 762c 2067 293a 0a20 2020 206e 5f65 6c65  v, g):.    n_ele
+000156a0: 6d5f 7265 6475 6365 6420 3d20 612e 6e75  m_reduced = a.nu
+000156b0: 6d65 6c20 2f2f 2076 2e6e 756d 656c 2069  mel // v.numel i
+000156c0: 6620 612e 6e75 6d65 6c20 213d 2030 2065  f a.numel != 0 e
+000156d0: 6c73 6520 310a 2020 2020 6e6f 726d 616c  lse 1.    normal
+000156e0: 697a 6174 696f 6e5f 7363 616c 6172 203d  ization_scalar =
+000156f0: 206e 5f65 6c65 6d5f 7265 6475 6365 6420   n_elem_reduced 
+00015700: 2d20 636f 7272 6563 7469 6f6e 0a20 2020  - correction.   
+00015710: 2067 203d 2072 6573 746f 7265 5f72 6564   g = restore_red
+00015720: 7563 6564 5f64 696d 7328 672c 2064 696d  uced_dims(g, dim
+00015730: 2c20 612e 7368 6170 6529 0a20 2020 2069  , a.shape).    i
+00015740: 6620 612e 6474 7970 6520 213d 2076 2e64  f a.dtype != v.d
+00015750: 7479 7065 3a0a 2020 2020 2020 2020 6120  type:.        a 
+00015760: 3d20 7072 696d 732e 636f 6e76 6572 745f  = prims.convert_
+00015770: 656c 656d 656e 745f 7479 7065 2861 2c20  element_type(a, 
+00015780: 762e 6474 7970 6529 0a20 2020 206d 6561  v.dtype).    mea
+00015790: 6e20 3d20 7072 696d 732e 7375 6d28 612c  n = prims.sum(a,
+000157a0: 2064 696d 2920 2f20 6e5f 656c 656d 5f72   dim) / n_elem_r
+000157b0: 6564 7563 6564 0a20 2020 206d 6561 6e20  educed.    mean 
+000157c0: 3d20 7265 7374 6f72 655f 7265 6475 6365  = restore_reduce
+000157d0: 645f 6469 6d73 286d 6561 6e2c 2064 696d  d_dims(mean, dim
+000157e0: 2c20 612e 7368 6170 6529 0a20 2020 2072  , a.shape).    r
+000157f0: 6574 7572 6e20 2832 202a 2067 202a 2028  eturn (2 * g * (
+00015800: 6120 2d20 6d65 616e 2929 202f 206e 6f72  a - mean)) / nor
+00015810: 6d61 6c69 7a61 7469 6f6e 5f73 6361 6c61  malization_scala
+00015820: 720a 0a0a 6465 6620 6e5f 656c 656d 5f72  r...def n_elem_r
+00015830: 6564 7563 6564 2861 5f6e 6469 6d2c 2061  educed(a_ndim, a
+00015840: 5f73 6861 7065 2c20 6469 6d73 293a 0a20  _shape, dims):. 
+00015850: 2020 2064 696d 7320 3d20 7574 696c 732e     dims = utils.
+00015860: 6361 6e6f 6e69 6361 6c69 7a65 5f64 696d  canonicalize_dim
+00015870: 7328 615f 6e64 696d 2c20 6469 6d73 290a  s(a_ndim, dims).
+00015880: 2020 2020 7265 6475 6374 696f 6e5f 7369      reduction_si
+00015890: 7a65 203d 2031 0a20 2020 2066 6f72 2069  ze = 1.    for i
+000158a0: 6478 2c20 7369 7a65 2069 6e20 656e 756d  dx, size in enum
+000158b0: 6572 6174 6528 615f 7368 6170 6529 3a0a  erate(a_shape):.
+000158c0: 2020 2020 2020 2020 6966 2069 6478 2069          if idx i
+000158d0: 6e20 6469 6d73 3a0a 2020 2020 2020 2020  n dims:.        
+000158e0: 2020 2020 7265 6475 6374 696f 6e5f 7369      reduction_si
+000158f0: 7a65 202a 3d20 7369 7a65 0a20 2020 2072  ze *= size.    r
+00015900: 6574 7572 6e20 7265 6475 6374 696f 6e5f  eturn reduction_
+00015910: 7369 7a65 0a0a 0a64 6566 206d 6561 6e5f  size...def mean_
+00015920: 6261 636b 7761 7264 2861 5f6e 6469 6d2c  backward(a_ndim,
+00015930: 2061 5f73 6861 7065 2c20 6469 6d73 2c20   a_shape, dims, 
+00015940: 6772 6164 293a 0a20 2020 206d 6561 6e5f  grad):.    mean_
+00015950: 6c6f 6361 6c5f 6772 6164 203d 2031 2e30  local_grad = 1.0
+00015960: 202f 206e 5f65 6c65 6d5f 7265 6475 6365   / n_elem_reduce
+00015970: 6428 615f 6e64 696d 2c20 615f 7368 6170  d(a_ndim, a_shap
+00015980: 652c 2064 696d 7329 0a20 2020 2072 6574  e, dims).    ret
+00015990: 7572 6e20 7265 7374 6f72 655f 7265 6475  urn restore_redu
+000159a0: 6365 645f 6469 6d73 2867 7261 642c 2064  ced_dims(grad, d
+000159b0: 696d 732c 2061 5f73 6861 7065 2920 2a20  ims, a_shape) * 
+000159c0: 6d65 616e 5f6c 6f63 616c 5f67 7261 640a  mean_local_grad.
+000159d0: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
+000159e0: 656e 7465 645f 666f 7277 6172 6428 7072  ented_forward(pr
+000159f0: 696d 732e 5072 696d 4944 732e 5041 4429  ims.PrimIDs.PAD)
+00015a00: 0a64 6566 2070 6164 5f61 7567 5f66 7764  .def pad_aug_fwd
+00015a10: 2861 2c20 7061 6464 696e 675f 7661 6c75  (a, padding_valu
+00015a20: 652c 2070 6164 6469 6e67 5f63 6f6e 6669  e, padding_confi
+00015a30: 6729 3a0a 2020 2020 7265 7475 726e 2056  g):.    return V
+00015a40: 4a50 4475 616c 2828 7072 696d 732e 7061  JPDual((prims.pa
+00015a50: 6428 612c 2070 6164 6469 6e67 5f76 616c  d(a, padding_val
+00015a60: 7565 2c20 7061 6464 696e 675f 636f 6e66  ue, padding_conf
+00015a70: 6967 292c 292c 2028 612c 2070 6164 6469  ig),), (a, paddi
+00015a80: 6e67 5f63 6f6e 6669 6729 290a 0a0a 4072  ng_config))...@r
+00015a90: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
+00015aa0: 2870 7269 6d73 2e50 7269 6d49 4473 2e50  (prims.PrimIDs.P
+00015ab0: 4144 290a 6465 6620 7061 645f 6261 636b  AD).def pad_back
+00015ac0: 7761 7264 2861 2c20 7061 6464 696e 675f  ward(a, padding_
+00015ad0: 636f 6e66 6967 2c20 6729 3a0a 2020 2020  config, g):.    
+00015ae0: 2320 5368 6f72 7420 6369 7263 7569 7420  # Short circuit 
+00015af0: 6f6e 2065 6d70 7479 2069 6e70 7574 2e0a  on empty input..
+00015b00: 2020 2020 6966 2061 6e79 2864 696d 203d      if any(dim =
+00015b10: 3d20 3020 666f 7220 6469 6d20 696e 2061  = 0 for dim in a
+00015b20: 2e73 6861 7065 293a 0a20 2020 2020 2020  .shape):.       
+00015b30: 2072 6574 7572 6e20 6675 6c6c 5f6c 696b   return full_lik
+00015b40: 6528 612c 2066 696c 6c5f 7661 6c75 653d  e(a, fill_value=
+00015b50: 3029 0a0a 2020 2020 2320 556e 2d70 6164  0)..    # Un-pad
+00015b60: 2062 7920 7061 6464 696e 6720 7769 7468   by padding with
+00015b70: 207a 6572 6f20 7661 6c75 6573 0a20 2020   zero values.   
+00015b80: 207a 6572 6f5f 7061 6464 696e 675f 636f   zero_padding_co
+00015b90: 6e66 6967 203d 205b 282d 6c6f 2c20 2d68  nfig = [(-lo, -h
+00015ba0: 692c 2030 2920 666f 7220 6c6f 2c20 6869  i, 0) for lo, hi
+00015bb0: 2c20 5f20 696e 2070 6164 6469 6e67 5f63  , _ in padding_c
+00015bc0: 6f6e 6669 675d 0a0a 2020 2020 6720 3d20  onfig]..    g = 
+00015bd0: 7072 696d 732e 7061 6428 672c 2030 2e30  prims.pad(g, 0.0
+00015be0: 2c20 7a65 726f 5f70 6164 6469 6e67 5f63  , zero_padding_c
+00015bf0: 6f6e 6669 6729 0a0a 2020 2020 2320 556e  onfig)..    # Un
+00015c00: 2d73 6c69 6365 2062 7920 736c 6963 696e  -slice by slicin
+00015c10: 6720 7769 7468 2061 2073 7472 6964 6520  g with a stride 
+00015c20: 6f66 2076 616c 7565 2028 6469 6c61 7469  of value (dilati
+00015c30: 6f6e 202b 2031 290a 2020 2020 666f 7220  on + 1).    for 
+00015c40: 6469 6d2c 2028 5f2c 205f 2c20 6429 2069  dim, (_, _, d) i
+00015c50: 6e20 656e 756d 6572 6174 6528 7061 6464  n enumerate(padd
+00015c60: 696e 675f 636f 6e66 6967 293a 0a20 2020  ing_config):.   
+00015c70: 2020 2020 2067 203d 2073 6c69 6365 5f69       g = slice_i
+00015c80: 6e5f 6469 6d28 672c 2030 2c20 672e 7368  n_dim(g, 0, g.sh
+00015c90: 6170 655b 6469 6d5d 2c20 7374 7269 6465  ape[dim], stride
+00015ca0: 3d64 202b 2031 2c20 6469 6d3d 6469 6d29  =d + 1, dim=dim)
+00015cb0: 0a0a 2020 2020 7265 7475 726e 2067 0a0a  ..    return g..
+00015cc0: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
+00015cd0: 6e74 6564 5f66 6f72 7761 7264 2870 7269  nted_forward(pri
+00015ce0: 6d73 2e50 7269 6d49 4473 2e50 524f 4429  ms.PrimIDs.PROD)
+00015cf0: 0a64 6566 2070 726f 645f 6175 675f 6677  .def prod_aug_fw
+00015d00: 6428 782c 2064 696d 7329 3a0a 2020 2020  d(x, dims):.    
+00015d10: 2222 2241 7567 6d65 6e74 6564 2070 726f  """Augmented pro
+00015d20: 6420 6f70 6572 6174 696f 6e2e 0a0a 2020  d operation...  
+00015d30: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00015d40: 7820 2856 6172 6961 626c 6529 3a20 5465  x (Variable): Te
+00015d50: 6e73 6f72 2074 6f20 6265 206d 756c 7469  nsor to be multi
+00015d60: 706c 6965 642e 0a20 2020 2020 2020 2064  plied..        d
+00015d70: 696d 7320 2854 7570 6c65 5b69 6e74 2c20  ims (Tuple[int, 
+00015d80: 2e2e 2e5d 293a 2044 696d 656e 7369 6f6e  ...]): Dimension
+00015d90: 7320 746f 2062 6520 6d75 6c74 6970 6c69  s to be multipli
+00015da0: 6564 2e0a 0a20 2020 2052 6574 7572 6e73  ed...    Returns
+00015db0: 3a0a 2020 2020 2020 2020 564a 5044 7561  :.        VJPDua
+00015dc0: 6c3a 2050 7269 6d61 6c20 616e 6420 7265  l: Primal and re
+00015dd0: 7369 6475 616c 732e 0a20 2020 2022 2222  siduals..    """
+00015de0: 0a20 2020 2070 7269 6d61 6c20 3d20 7072  .    primal = pr
+00015df0: 696d 732e 7072 6f64 2878 2c20 6469 6d73  ims.prod(x, dims
+00015e00: 290a 0a20 2020 2072 6573 6964 7561 6c73  )..    residuals
+00015e10: 203d 2028 0a20 2020 2020 2020 2070 7269   = (.        pri
+00015e20: 6d61 6c2c 0a20 2020 2020 2020 2078 2c0a  mal,.        x,.
+00015e30: 2020 2020 2020 2020 782e 7368 6170 652c          x.shape,
+00015e40: 0a20 2020 2020 2020 2064 696d 732c 0a20  .        dims,. 
+00015e50: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
+00015e60: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+00015e70: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
+00015e80: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+00015e90: 7072 696d 732e 5072 696d 4944 732e 5052  prims.PrimIDs.PR
+00015ea0: 4f44 290a 6465 6620 7072 6f64 5f70 756c  OD).def prod_pul
+00015eb0: 6c62 6163 6b28 7072 696d 616c 2c20 782c  lback(primal, x,
+00015ec0: 2078 5f73 6861 7065 2c20 7265 6475 6365   x_shape, reduce
+00015ed0: 645f 6469 6d73 2c20 6729 3a0a 2020 2020  d_dims, g):.    
+00015ee0: 7265 7475 726e 2070 7269 6d73 2e64 6976  return prims.div
+00015ef0: 2872 6573 746f 7265 5f72 6564 7563 6564  (restore_reduced
+00015f00: 5f64 696d 7328 7072 696d 616c 202a 2067  _dims(primal * g
+00015f10: 2c20 7265 6475 6365 645f 6469 6d73 2c20  , reduced_dims, 
+00015f20: 785f 7368 6170 6529 2c20 7829 0a0a 0a64  x_shape), x)...d
+00015f30: 6566 206b 6565 7064 696d 5f72 6564 7563  ef keepdim_reduc
+00015f40: 7469 6f6e 2872 6564 7563 7469 6f6e 5f66  tion(reduction_f
+00015f50: 6e2c 2078 2c20 6469 6d73 293a 0a20 2020  n, x, dims):.   
+00015f60: 2022 2222 4170 706c 6965 7320 7265 6475   """Applies redu
+00015f70: 6374 696f 6e20 616e 6420 6669 7865 7320  ction and fixes 
+00015f80: 6f75 7470 7574 2074 6f20 636f 6e66 6f72  output to confor
+00015f90: 6d20 746f 206b 6565 7064 696d 3d54 7275  m to keepdim=Tru
+00015fa0: 6522 2222 0a20 2020 206f 7574 203d 2072  e""".    out = r
+00015fb0: 6564 7563 7469 6f6e 5f66 6e28 782c 2064  eduction_fn(x, d
+00015fc0: 696d 7329 0a20 2020 2061 7267 6d61 785f  ims).    argmax_
+00015fd0: 7375 6d5f 6f75 745f 7368 6170 6520 3d20  sum_out_shape = 
+00015fe0: 5b78 2e73 6861 7065 5b69 5d20 6966 2069  [x.shape[i] if i
+00015ff0: 206e 6f74 2069 6e20 6469 6d73 2065 6c73   not in dims els
+00016000: 6520 3120 666f 7220 6920 696e 2072 616e  e 1 for i in ran
+00016010: 6765 2878 2e6e 6469 6d29 5d0a 2020 2020  ge(x.ndim)].    
+00016020: 6272 6f61 6463 6173 745f 6469 6d73 203d  broadcast_dims =
+00016030: 205b 6920 666f 7220 6920 696e 2072 616e   [i for i in ran
+00016040: 6765 2878 2e6e 6469 6d29 2069 6620 6920  ge(x.ndim) if i 
+00016050: 6e6f 7420 696e 2064 696d 735d 0a20 2020  not in dims].   
+00016060: 2072 6574 7572 6e20 7072 696d 732e 6272   return prims.br
+00016070: 6f61 6463 6173 745f 696e 5f64 696d 286f  oadcast_in_dim(o
+00016080: 7574 2c20 6172 676d 6178 5f73 756d 5f6f  ut, argmax_sum_o
+00016090: 7574 5f73 6861 7065 2c20 6272 6f61 6463  ut_shape, broadc
+000160a0: 6173 745f 6469 6d73 290a 0a0a 2320 496e  ast_dims)...# In
+000160b0: 7370 6972 6564 2066 726f 6d20 6874 7470  spired from http
+000160c0: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f48  s://github.com/H
+000160d0: 4950 532f 6175 746f 6772 6164 2f62 6c6f  IPS/autograd/blo
+000160e0: 622f 6d61 7374 6572 2f61 7574 6f67 7261  b/master/autogra
+000160f0: 642f 6e75 6d70 792f 6e75 6d70 795f 766a  d/numpy/numpy_vj
+00016100: 7073 2e70 7923 4c33 3533 0a64 6566 2067  ps.py#L353.def g
+00016110: 7261 645f 6368 6f6f 7365 725f 6261 636b  rad_chooser_back
+00016120: 7761 7264 2870 7269 6d61 6c2c 2078 2c20  ward(primal, x, 
+00016130: 785f 7368 6170 652c 2072 6564 7563 6564  x_shape, reduced
+00016140: 5f64 696d 732c 2067 293a 0a20 2020 2022  _dims, g):.    "
+00016150: 2222 4275 696c 6473 2067 7261 6469 656e  ""Builds gradien
+00016160: 7420 6f66 2066 756e 6374 696f 6e73 2074  t of functions t
+00016170: 6861 7420 6368 6f6f 7365 2061 2073 696e  hat choose a sin
+00016180: 676c 6520 6974 656d 2c20 7375 6368 2061  gle item, such a
+00016190: 7320 6d69 6e20 6f72 206d 6178 2e22 2222  s min or max."""
+000161a0: 0a20 2020 2067 5f72 6570 6561 7465 6420  .    g_repeated 
+000161b0: 3d20 7265 7374 6f72 655f 7265 6475 6365  = restore_reduce
+000161c0: 645f 6469 6d73 2867 2c20 7265 6475 6365  d_dims(g, reduce
+000161d0: 645f 6469 6d73 2c20 785f 7368 6170 6529  d_dims, x_shape)
+000161e0: 0a20 2020 2070 7269 6d61 6c5f 7265 7065  .    primal_repe
+000161f0: 6174 6564 203d 2072 6573 746f 7265 5f72  ated = restore_r
+00016200: 6564 7563 6564 5f64 696d 7328 7072 696d  educed_dims(prim
+00016210: 616c 2c20 7265 6475 6365 645f 6469 6d73  al, reduced_dims
+00016220: 2c20 785f 7368 6170 6529 0a20 2020 2061  , x_shape).    a
+00016230: 7267 6d61 785f 6c6f 6361 7469 6f6e 7320  rgmax_locations 
+00016240: 3d20 7820 3d3d 2070 7269 6d61 6c5f 7265  = x == primal_re
+00016250: 7065 6174 6564 0a20 2020 2061 7267 6d61  peated.    argma
+00016260: 785f 7375 6d20 3d20 6b65 6570 6469 6d5f  x_sum = keepdim_
+00016270: 7265 6475 6374 696f 6e28 7072 696d 732e  reduction(prims.
+00016280: 7375 6d2c 2061 7267 6d61 785f 6c6f 6361  sum, argmax_loca
+00016290: 7469 6f6e 732c 2072 6564 7563 6564 5f64  tions, reduced_d
+000162a0: 696d 7329 0a20 2020 206f 7574 203d 2067  ims).    out = g
+000162b0: 5f72 6570 6561 7465 6420 2a20 6172 676d  _repeated * argm
+000162c0: 6178 5f6c 6f63 6174 696f 6e73 202f 2061  ax_locations / a
+000162d0: 7267 6d61 785f 7375 6d0a 2020 2020 7265  rgmax_sum.    re
+000162e0: 7475 726e 206f 7574 0a0a 0a72 6567 6973  turn out...regis
+000162f0: 7465 725f 6261 636b 7761 7264 2870 7269  ter_backward(pri
+00016300: 6d73 2e50 7269 6d49 4473 2e41 4d49 4e29  ms.PrimIDs.AMIN)
+00016310: 2867 7261 645f 6368 6f6f 7365 725f 6261  (grad_chooser_ba
+00016320: 636b 7761 7264 290a 0a0a 4072 6567 6973  ckward)...@regis
+00016330: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
+00016340: 7277 6172 6428 7072 696d 732e 5072 696d  rward(prims.Prim
+00016350: 4944 732e 414d 494e 290a 6465 6620 616d  IDs.AMIN).def am
+00016360: 696e 5f61 7567 5f66 7764 2878 2c20 6469  in_aug_fwd(x, di
+00016370: 6d73 293a 0a20 2020 2022 2222 4175 676d  ms):.    """Augm
+00016380: 656e 7465 6420 616d 696e 206f 7065 7261  ented amin opera
+00016390: 7469 6f6e 2e0a 2020 2020 4172 6773 3a0a  tion..    Args:.
+000163a0: 2020 2020 2020 2020 7820 2856 6172 6961          x (Varia
+000163b0: 626c 6529 3a20 5465 6e73 6f72 2074 6f20  ble): Tensor to 
+000163c0: 636f 6d70 7574 6520 616d 696e 206f 6e2e  compute amin on.
+000163d0: 0a20 2020 2020 2020 2064 696d 7320 2854  .        dims (T
+000163e0: 7570 6c65 5b69 6e74 2c20 2e2e 2e5d 293a  uple[int, ...]):
+000163f0: 2044 696d 656e 7369 6f6e 7320 746f 2063   Dimensions to c
+00016400: 6f6d 7075 7465 2061 6d69 6e20 6f76 6572  ompute amin over
+00016410: 2e0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+00016420: 2020 2020 2020 2056 4a50 4475 616c 3a20         VJPDual: 
+00016430: 5072 696d 616c 2061 6e64 2072 6573 6964  Primal and resid
+00016440: 7561 6c73 2e0a 2020 2020 2222 220a 2020  uals..    """.  
+00016450: 2020 7072 696d 616c 203d 2070 7269 6d73    primal = prims
+00016460: 2e61 6d69 6e28 782c 2064 696d 7329 0a0a  .amin(x, dims)..
+00016470: 2020 2020 7265 7369 6475 616c 7320 3d20      residuals = 
+00016480: 280a 2020 2020 2020 2020 7072 696d 616c  (.        primal
+00016490: 2c0a 2020 2020 2020 2020 782c 0a20 2020  ,.        x,.   
+000164a0: 2020 2020 2078 2e73 6861 7065 2c0a 2020       x.shape,.  
+000164b0: 2020 2020 2020 6469 6d73 2c0a 2020 2020        dims,.    
+000164c0: 290a 0a20 2020 2072 6574 7572 6e20 564a  )..    return VJ
+000164d0: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
+000164e0: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
+000164f0: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
+00016500: 6f72 7761 7264 2870 7269 6d73 2e50 7269  orward(prims.Pri
+00016510: 6d49 4473 2e50 4f57 290a 6465 6620 706f  mIDs.POW).def po
+00016520: 775f 6175 675f 6665 6428 782c 2079 293a  w_aug_fed(x, y):
+00016530: 0a20 2020 2022 2222 4175 676d 656e 7465  .    """Augmente
+00016540: 6420 7468 6520 706f 7720 6f70 6572 6174  d the pow operat
+00016550: 696f 6e2e 0a0a 2020 2020 4172 6773 3a0a  ion...    Args:.
+00016560: 2020 2020 2020 2020 7820 2856 6172 6961          x (Varia
+00016570: 626c 6529 3a20 5465 6e73 6f72 2077 6974  ble): Tensor wit
+00016580: 6820 7468 6520 6261 7365 2074 6f20 6265  h the base to be
+00016590: 2065 7870 6f6e 656e 7469 6174 6564 2e0a   exponentiated..
+000165a0: 2020 2020 2020 2020 7920 2856 6172 6961          y (Varia
+000165b0: 626c 6529 3a20 5465 6e73 6f72 2077 6974  ble): Tensor wit
+000165c0: 6820 706f 7765 7220 746f 2072 6169 7365  h power to raise
+000165d0: 2074 6f2e 0a0a 2020 2020 5265 7475 726e   to...    Return
+000165e0: 733a 0a20 2020 2020 2020 2056 4a50 4475  s:.        VJPDu
+000165f0: 616c 3a20 5072 696d 616c 2061 6e64 2072  al: Primal and r
+00016600: 6573 6964 7561 6c73 2e0a 2020 2020 2222  esiduals..    ""
+00016610: 220a 2020 2020 7072 696d 616c 203d 2070  ".    primal = p
+00016620: 7269 6d73 2e70 6f77 2878 2c20 7929 0a20  rims.pow(x, y). 
+00016630: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
+00016640: 7072 696d 616c 2c20 782c 2079 290a 2020  primal, x, y).  
+00016650: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
+00016660: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
+00016670: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
+00016680: 6261 636b 7761 7264 2870 7269 6d73 2e50  backward(prims.P
+00016690: 7269 6d49 4473 2e50 4f57 290a 6465 6620  rimIDs.POW).def 
+000166a0: 706f 775f 6261 636b 7761 7264 2872 6573  pow_backward(res
+000166b0: 756c 742c 2078 2c20 792c 2067 293a 0a20  ult, x, y, g):. 
+000166c0: 2020 2069 6d70 6f72 7420 7468 756e 6465     import thunde
+000166d0: 722e 636c 616e 6720 6173 2074 6c61 6e67  r.clang as tlang
+000166e0: 0a0a 2020 2020 6772 6573 756c 7420 3d20  ..    gresult = 
+000166f0: 6720 2a20 7265 7375 6c74 2020 2320 7265  g * result  # re
+00016700: 7573 6520 636f 6d6d 6f6e 2066 6163 746f  use common facto
+00016710: 720a 2020 2020 6478 203d 2067 202a 2079  r.    dx = g * y
+00016720: 202a 2078 202a 2a20 2879 202d 2031 290a   * x ** (y - 1).
+00016730: 2020 2020 6479 203d 2067 7265 7375 6c74      dy = gresult
+00016740: 202a 2074 6c61 6e67 2e6c 6f67 2878 290a   * tlang.log(x).
+00016750: 2020 2020 7265 7475 726e 2064 782c 2064      return dx, d
+00016760: 790a 0a0a 4072 6567 6973 7465 725f 6175  y...@register_au
+00016770: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
+00016780: 7072 696d 732e 5072 696d 4944 732e 5441  prims.PrimIDs.TA
+00016790: 4e29 0a64 6566 2074 616e 5f61 7567 5f66  N).def tan_aug_f
+000167a0: 7764 2878 293a 0a20 2020 2022 2222 4175  wd(x):.    """Au
+000167b0: 676d 656e 7465 6420 7461 6e20 6f70 6572  gmented tan oper
+000167c0: 6174 696f 6e2e 0a0a 2020 2020 4172 6773  ation...    Args
+000167d0: 3a0a 2020 2020 2020 2020 7820 2856 6172  :.        x (Var
+000167e0: 6961 626c 6529 3a20 5465 6e73 6f72 2074  iable): Tensor t
+000167f0: 6f20 6265 2070 6173 7365 6420 746f 2074  o be passed to t
+00016800: 616e 2e0a 2020 2020 2222 220a 0a20 2020  an..    """..   
+00016810: 2070 7269 6d61 6c20 3d20 7072 696d 732e   primal = prims.
+00016820: 7461 6e28 7829 0a20 2020 2072 6573 6964  tan(x).    resid
+00016830: 7561 6c73 203d 2028 7072 696d 616c 2c29  uals = (primal,)
+00016840: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
+00016850: 7561 6c28 7072 696d 616c 2c20 7265 7369  ual(primal, resi
+00016860: 6475 616c 7329 0a0a 0a40 7265 6769 7374  duals)...@regist
+00016870: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
+00016880: 732e 5072 696d 4944 732e 5441 4e29 0a64  s.PrimIDs.TAN).d
+00016890: 6566 2074 616e 5f62 6163 6b77 6172 6428  ef tan_backward(
+000168a0: 7265 7375 6c74 2c20 6729 3a0a 2020 2020  result, g):.    
+000168b0: 7265 7475 726e 2067 202a 2028 3120 2b20  return g * (1 + 
+000168c0: 7265 7375 6c74 202a 2072 6573 756c 7429  result * result)
+000168d0: 0a0a 0a23 204e 4f54 453a 204a 6178 2075  ...# NOTE: Jax u
+000168e0: 7365 7320 6e70 2e61 7267 736f 7274 2069  ses np.argsort i
+000168f0: 6e20 6974 7320 7472 616e 7370 6f73 6520  n its transpose 
+00016900: 766a 7020 636f 6d70 7574 6174 696f 6e0a  vjp computation.
+00016910: 6465 6620 5f61 7267 736f 7274 2873 6571  def _argsort(seq
+00016920: 293a 0a20 2020 2072 6574 7572 6e20 736f  ):.    return so
+00016930: 7274 6564 2872 616e 6765 286c 656e 2873  rted(range(len(s
+00016940: 6571 2929 2c20 6b65 793d 7365 712e 5f5f  eq)), key=seq.__
+00016950: 6765 7469 7465 6d5f 5f29 0a0a 0a40 7265  getitem__)...@re
+00016960: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
+00016970: 5f66 6f72 7761 7264 2870 7269 6d73 2e50  _forward(prims.P
+00016980: 7269 6d49 4473 2e44 4556 4943 455f 5055  rimIDs.DEVICE_PU
+00016990: 5429 0a64 6566 2064 6576 6963 655f 7075  T).def device_pu
+000169a0: 745f 6175 675f 6677 6428 613a 2054 656e  t_aug_fwd(a: Ten
+000169b0: 736f 7250 726f 7879 2c20 6465 7669 6365  sorProxy, device
+000169c0: 3a20 4465 7669 6365 2920 2d3e 2054 656e  : Device) -> Ten
+000169d0: 736f 7250 726f 7879 3a0a 2020 2020 7072  sorProxy:.    pr
+000169e0: 696d 616c 203d 2070 7269 6d73 2e64 6576  imal = prims.dev
+000169f0: 6963 655f 7075 7428 612c 2064 6576 6963  ice_put(a, devic
+00016a00: 6529 0a20 2020 2072 6573 6964 7561 6c73  e).    residuals
+00016a10: 203d 2028 612e 6465 7669 6365 2c29 0a20   = (a.device,). 
+00016a20: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
+00016a30: 6c28 7072 696d 616c 2c20 7265 7369 6475  l(primal, residu
+00016a40: 616c 7329 0a0a 0a40 7265 6769 7374 6572  als)...@register
+00016a50: 5f62 6163 6b77 6172 6428 7072 696d 732e  _backward(prims.
+00016a60: 5072 696d 4944 732e 4445 5649 4345 5f50  PrimIDs.DEVICE_P
+00016a70: 5554 290a 6465 6620 6465 7669 6365 5f70  UT).def device_p
+00016a80: 7574 5f62 6163 6b77 6172 6428 6f72 6967  ut_backward(orig
+00016a90: 5f64 6576 6963 652c 2067 293a 0a20 2020  _device, g):.   
+00016aa0: 2072 6574 7572 6e20 7072 696d 732e 6465   return prims.de
+00016ab0: 7669 6365 5f70 7574 2867 2c20 6f72 6967  vice_put(g, orig
+00016ac0: 5f64 6576 6963 6529 2c20 4e6f 6e65 0a0a  _device), None..
+00016ad0: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
+00016ae0: 6e74 6564 5f66 6f72 7761 7264 2870 7269  nted_forward(pri
+00016af0: 6d73 2e50 7269 6d49 4473 2e43 4f4e 564f  ms.PrimIDs.CONVO
+00016b00: 4c55 5449 4f4e 290a 6465 6620 636f 6e76  LUTION).def conv
+00016b10: 6f6c 7574 696f 6e5f 6175 675f 6677 6428  olution_aug_fwd(
+00016b20: 0a20 2020 2061 3a20 5072 6f78 792c 0a20  .    a: Proxy,. 
+00016b30: 2020 2077 6569 6768 742c 0a20 2020 2062     weight,.    b
+00016b40: 6961 732c 0a20 2020 2073 7472 6964 652c  ias,.    stride,
+00016b50: 0a20 2020 2070 6164 6469 6e67 2c0a 2020  .    padding,.  
+00016b60: 2020 6469 6c61 7469 6f6e 2c0a 2020 2020    dilation,.    
+00016b70: 7472 616e 7370 6f73 6564 2c0a 2020 2020  transposed,.    
+00016b80: 6f75 7470 7574 5f70 6164 6469 6e67 2c0a  output_padding,.
+00016b90: 2020 2020 6772 6f75 7073 2c0a 293a 0a20      groups,.):. 
+00016ba0: 2020 2070 7269 6d61 6c20 3d20 636f 6e76     primal = conv
+00016bb0: 6f6c 7574 696f 6e28 612c 2077 6569 6768  olution(a, weigh
+00016bc0: 742c 2062 6961 732c 2073 7472 6964 652c  t, bias, stride,
+00016bd0: 2070 6164 6469 6e67 2c20 6469 6c61 7469   padding, dilati
+00016be0: 6f6e 2c20 7472 616e 7370 6f73 6564 2c20  on, transposed, 
+00016bf0: 6f75 7470 7574 5f70 6164 6469 6e67 2c20  output_padding, 
+00016c00: 6772 6f75 7073 290a 2020 2020 7265 7369  groups).    resi
+00016c10: 6475 616c 7320 3d20 2870 7269 6d61 6c2c  duals = (primal,
+00016c20: 2061 2c20 7765 6967 6874 2c20 6269 6173   a, weight, bias
+00016c30: 2c20 7374 7269 6465 2c20 7061 6464 696e  , stride, paddin
+00016c40: 672c 2064 696c 6174 696f 6e2c 2074 7261  g, dilation, tra
+00016c50: 6e73 706f 7365 642c 206f 7574 7075 745f  nsposed, output_
+00016c60: 7061 6464 696e 672c 2067 726f 7570 7329  padding, groups)
+00016c70: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
+00016c80: 7561 6c28 7072 696d 616c 2c20 7265 7369  ual(primal, resi
+00016c90: 6475 616c 7329 0a0a 0a40 7265 6769 7374  duals)...@regist
+00016ca0: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
+00016cb0: 732e 5072 696d 4944 732e 434f 4e56 4f4c  s.PrimIDs.CONVOL
+00016cc0: 5554 494f 4e29 0a64 6566 2063 6f6e 766f  UTION).def convo
+00016cd0: 6c75 7469 6f6e 5f62 6163 6b77 6172 6428  lution_backward(
+00016ce0: 0a20 2020 206f 7574 7075 743a 2050 726f  .    output: Pro
+00016cf0: 7879 2c0a 2020 2020 696e 7075 743a 2050  xy,.    input: P
+00016d00: 726f 7879 2c0a 2020 2020 7765 6967 6874  roxy,.    weight
+00016d10: 2c0a 2020 2020 6269 6173 2c0a 2020 2020  ,.    bias,.    
+00016d20: 7374 7269 6465 2c0a 2020 2020 7061 6464  stride,.    padd
+00016d30: 696e 672c 0a20 2020 2064 696c 6174 696f  ing,.    dilatio
+00016d40: 6e2c 0a20 2020 2074 7261 6e73 706f 7365  n,.    transpose
+00016d50: 642c 0a20 2020 206f 7574 7075 745f 7061  d,.    output_pa
+00016d60: 6464 696e 672c 0a20 2020 2067 726f 7570  dding,.    group
+00016d70: 732c 0a20 2020 2067 7261 642c 0a29 3a0a  s,.    grad,.):.
+00016d80: 2020 2020 2320 5472 616e 7370 6f73 6564      # Transposed
+00016d90: 2063 6f6e 766f 6c75 7469 6f6e 2069 7320   convolution is 
+00016da0: 6e6f 7420 7375 7070 6f72 7465 6421 0a20  not supported!. 
+00016db0: 2020 2061 7373 6572 7420 7472 616e 7370     assert transp
+00016dc0: 6f73 6564 203d 3d20 300a 0a20 2020 2069  osed == 0..    i
+00016dd0: 6e70 7574 5f67 7261 6420 3d20 4e6f 6e65  nput_grad = None
+00016de0: 0a20 2020 2077 6569 6768 745f 6772 6164  .    weight_grad
+00016df0: 203d 204e 6f6e 650a 2020 2020 6269 6173   = None.    bias
+00016e00: 5f67 7261 6420 3d20 4e6f 6e65 0a0a 2020  _grad = None..  
+00016e10: 2020 2320 5368 6f72 7420 6369 7263 7569    # Short circui
+00016e20: 7420 6f6e 207a 6572 6f2d 6469 6d20 6772  t on zero-dim gr
+00016e30: 6164 0a20 2020 2069 6620 616e 7928 7320  ad.    if any(s 
+00016e40: 3d3d 2030 2066 6f72 2073 2069 6e20 6772  == 0 for s in gr
+00016e50: 6164 2e73 6861 7065 293a 0a20 2020 2020  ad.shape):.     
+00016e60: 2020 2069 6e70 7574 5f67 7261 6420 3d20     input_grad = 
+00016e70: 6675 6c6c 5f6c 696b 6528 696e 7075 742c  full_like(input,
+00016e80: 2066 696c 6c5f 7661 6c75 653d 3029 0a20   fill_value=0). 
+00016e90: 2020 2020 2020 2077 6569 6768 745f 6772         weight_gr
+00016ea0: 6164 203d 2066 756c 6c5f 6c69 6b65 2877  ad = full_like(w
+00016eb0: 6569 6768 742c 2066 696c 6c5f 7661 6c75  eight, fill_valu
+00016ec0: 653d 3029 0a20 2020 2020 2020 2069 6620  e=0).        if 
+00016ed0: 6269 6173 2069 7320 6e6f 7420 4e6f 6e65  bias is not None
+00016ee0: 3a0a 2020 2020 2020 2020 2020 2020 6269  :.            bi
+00016ef0: 6173 5f67 7261 6420 3d20 6675 6c6c 5f6c  as_grad = full_l
+00016f00: 696b 6528 6269 6173 2c20 6669 6c6c 5f76  ike(bias, fill_v
+00016f10: 616c 7565 3d30 290a 2020 2020 2020 2020  alue=0).        
+00016f20: 7265 7475 726e 2028 696e 7075 745f 6772  return (input_gr
+00016f30: 6164 2c20 7765 6967 6874 5f67 7261 642c  ad, weight_grad,
+00016f40: 2062 6961 735f 6772 6164 2920 2b20 2828   bias_grad) + ((
+00016f50: 4e6f 6e65 2c29 202a 2036 290a 0a20 2020  None,) * 6)..   
+00016f60: 2062 6174 6368 2c20 696e 5f63 6861 6e6e   batch, in_chann
+00016f70: 656c 732c 202a 7370 6174 6961 6c5f 6469  els, *spatial_di
+00016f80: 6d73 203d 2069 6e70 7574 2e73 6861 7065  ms = input.shape
+00016f90: 0a20 2020 206f 7574 5f63 6861 6e6e 656c  .    out_channel
+00016fa0: 732c 2067 696e 5f63 6861 6e6e 656c 732c  s, gin_channels,
+00016fb0: 202a 6b65 726e 656c 5f64 696d 7320 3d20   *kernel_dims = 
+00016fc0: 7765 6967 6874 2e73 6861 7065 0a20 2020  weight.shape.   
+00016fd0: 2064 696d 203d 206c 656e 2873 7061 7469   dim = len(spati
+00016fe0: 616c 5f64 696d 7329 0a0a 2020 2020 6465  al_dims)..    de
+00016ff0: 6620 6d61 7962 655f 6578 7061 6e64 5f73  f maybe_expand_s
+00017000: 6571 2873 2c20 6469 6d29 3a0a 2020 2020  eq(s, dim):.    
+00017010: 2020 2020 6966 206c 656e 2873 2920 3d3d      if len(s) ==
+00017020: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00017030: 7265 7475 726e 2028 735b 305d 2c29 202a  return (s[0],) *
+00017040: 2064 696d 0a20 2020 2020 2020 2065 6c73   dim.        els
+00017050: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00017060: 6574 7572 6e20 730a 0a20 2020 2073 7472  eturn s..    str
+00017070: 6964 6520 3d20 6d61 7962 655f 6578 7061  ide = maybe_expa
+00017080: 6e64 5f73 6571 2873 7472 6964 652c 2064  nd_seq(stride, d
+00017090: 696d 290a 2020 2020 7061 6464 696e 6720  im).    padding 
+000170a0: 3d20 6d61 7962 655f 6578 7061 6e64 5f73  = maybe_expand_s
+000170b0: 6571 2870 6164 6469 6e67 2c20 6469 6d29  eq(padding, dim)
+000170c0: 0a20 2020 2064 696c 6174 696f 6e20 3d20  .    dilation = 
+000170d0: 6d61 7962 655f 6578 7061 6e64 5f73 6571  maybe_expand_seq
+000170e0: 2864 696c 6174 696f 6e2c 2064 696d 290a  (dilation, dim).
+000170f0: 0a20 2020 2064 6566 2063 6f6e 765f 7472  .    def conv_tr
+00017100: 616e 7370 6f73 6528 7429 3a0a 2020 2020  anspose(t):.    
+00017110: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
+00017120: 2e74 7261 6e73 706f 7365 2874 2c20 2831  .transpose(t, (1
+00017130: 2c20 3029 202b 2074 7570 6c65 2872 616e  , 0) + tuple(ran
+00017140: 6765 2832 2c20 742e 6e64 696d 2929 290a  ge(2, t.ndim))).
+00017150: 0a20 2020 2023 2069 6e70 7574 5f67 7261  .    # input_gra
+00017160: 6420 3d20 7b0a 2020 2020 6465 6620 7472  d = {.    def tr
+00017170: 616e 7370 6f73 655f 616e 645f 666c 6970  anspose_and_flip
+00017180: 5f77 6569 6768 7428 7765 6967 6874 293a  _weight(weight):
+00017190: 0a20 2020 2020 2020 2023 2054 6865 206c  .        # The l
+000171a0: 696e 6573 2062 656c 6f77 2061 7265 2074  ines below are t
+000171b0: 7261 6e73 706f 7369 6e67 2074 6865 2063  ransposing the c
+000171c0: 6861 6e6e 656c 7320 6469 6d73 2e0a 2020  hannels dims..  
+000171d0: 2020 2020 2020 2320 5765 2061 6c73 6f20        # We also 
+000171e0: 6e65 6564 2074 6f20 6578 7472 6163 7420  need to extract 
+000171f0: 7468 6520 6772 6f75 7020 696e 666f 726d  the group inform
+00017200: 6174 696f 6e20 616e 6420 6d65 7267 6520  ation and merge 
+00017210: 6974 0a20 2020 2020 2020 2023 2077 6974  it.        # wit
+00017220: 6820 7468 6520 6469 6d65 6e73 696f 6e20  h the dimension 
+00017230: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
+00017240: 2074 6865 2022 6f75 745f 6368 616e 6e65   the "out_channe
+00017250: 6c73 2220 6469 6d2e 0a20 2020 2020 2020  ls" dim..       
+00017260: 2023 2028 6f75 745f 6368 616e 6e65 6c73   # (out_channels
+00017270: 2c20 6769 6e5f 6368 616e 6e65 6c73 2920  , gin_channels) 
+00017280: 2d3e 2028 6769 6e5f 6368 616e 6e65 6c73  -> (gin_channels
+00017290: 2c20 6f75 745f 6368 616e 6e65 6c73 290a  , out_channels).
+000172a0: 2020 2020 2020 2020 7765 6967 6874 203d          weight =
+000172b0: 2063 6f6e 765f 7472 616e 7370 6f73 6528   conv_transpose(
+000172c0: 7765 6967 6874 290a 2020 2020 2020 2020  weight).        
+000172d0: 2320 5370 6c69 7420 286f 7574 5f63 6861  # Split (out_cha
+000172e0: 6e6e 656c 732c 2920 2d3e 2028 6772 6f75  nnels,) -> (grou
+000172f0: 7073 2c20 6f75 745f 6368 616e 6e65 6c73  ps, out_channels
+00017300: 202f 2f20 6772 6f75 7073 290a 2020 2020   // groups).    
+00017310: 2020 2020 7765 6967 6874 203d 2077 6569      weight = wei
+00017320: 6768 742e 7265 7368 6170 6528 5b67 696e  ght.reshape([gin
+00017330: 5f63 6861 6e6e 656c 732c 2067 726f 7570  _channels, group
+00017340: 732c 206f 7574 5f63 6861 6e6e 656c 7320  s, out_channels 
+00017350: 2f2f 2067 726f 7570 735d 202b 206b 6572  // groups] + ker
+00017360: 6e65 6c5f 6469 6d73 290a 2020 2020 2020  nel_dims).      
+00017370: 2020 2320 4d6f 7669 6e67 2067 726f 7570    # Moving group
+00017380: 7320 746f 2074 6865 206c 6566 742d 6d6f  s to the left-mo
+00017390: 7374 2070 6f73 6974 696f 6e2e 0a20 2020  st position..   
+000173a0: 2020 2020 2023 2028 6769 6e5f 6368 616e       # (gin_chan
+000173b0: 6e65 6c73 2c20 6772 6f75 7073 2c20 6f75  nels, groups, ou
+000173c0: 745f 6368 616e 6e65 6c73 202f 2f20 6772  t_channels // gr
+000173d0: 6f75 7073 2920 2d3e 2028 6772 6f75 7073  oups) -> (groups
+000173e0: 2c20 6769 6e5f 6368 616e 6e65 6c73 2c20  , gin_channels, 
+000173f0: 6f75 745f 6368 616e 6e65 6c73 202f 2f20  out_channels // 
+00017400: 6772 6f75 7073 290a 2020 2020 2020 2020  groups).        
+00017410: 7765 6967 6874 203d 2063 6f6e 765f 7472  weight = conv_tr
+00017420: 616e 7370 6f73 6528 7765 6967 6874 290a  anspose(weight).
+00017430: 2020 2020 2020 2020 2320 5371 7561 7368          # Squash
+00017440: 2028 6772 6f75 7073 2c20 6769 6e5f 6368   (groups, gin_ch
+00017450: 616e 6e65 6c73 2920 2d3e 2028 696e 5f63  annels) -> (in_c
+00017460: 6861 6e6e 656c 7329 0a20 2020 2020 2020  hannels).       
+00017470: 2077 6569 6768 7420 3d20 7765 6967 6874   weight = weight
+00017480: 2e72 6573 6861 7065 285b 696e 5f63 6861  .reshape([in_cha
+00017490: 6e6e 656c 732c 206f 7574 5f63 6861 6e6e  nnels, out_chann
+000174a0: 656c 7320 2f2f 2067 726f 7570 735d 202b  els // groups] +
+000174b0: 206b 6572 6e65 6c5f 6469 6d73 290a 0a20   kernel_dims).. 
+000174c0: 2020 2020 2020 2023 2046 6c69 7020 7370         # Flip sp
+000174d0: 6174 6961 6c20 6469 6d65 6e73 696f 6e73  atial dimensions
+000174e0: 0a20 2020 2020 2020 2077 6569 6768 7420  .        weight 
+000174f0: 3d20 7072 696d 732e 666c 6970 2877 6569  = prims.flip(wei
+00017500: 6768 742c 2074 7570 6c65 2872 616e 6765  ght, tuple(range
+00017510: 2832 2c20 7765 6967 6874 2e6e 6469 6d29  (2, weight.ndim)
+00017520: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
+00017530: 6e20 7765 6967 6874 0a0a 2020 2020 2320  n weight..    # 
+00017540: 5765 206e 6565 6420 746f 2070 6164 2074  We need to pad t
+00017550: 6865 2067 7261 6469 656e 7420 746f 2062  he gradient to b
+00017560: 6520 6162 6c65 2074 6f20 6669 7420 6b65  e able to fit ke
+00017570: 726e 656c 2077 696e 646f 7773 2e0a 2020  rnel windows..  
+00017580: 2020 696e 6974 6961 6c5f 6772 6164 5f70    initial_grad_p
+00017590: 6164 6469 6e67 203d 205b 6420 2a20 286b  adding = [d * (k
+000175a0: 202d 2031 2920 666f 7220 642c 206b 2069   - 1) for d, k i
+000175b0: 6e20 7a69 7028 6469 6c61 7469 6f6e 2c20  n zip(dilation, 
+000175c0: 6b65 726e 656c 5f64 696d 7329 5d0a 0a20  kernel_dims)].. 
+000175d0: 2020 2069 6e70 7574 5f67 7261 6420 3d20     input_grad = 
+000175e0: 636f 6e76 6f6c 7574 696f 6e28 0a20 2020  convolution(.   
+000175f0: 2020 2020 2070 7269 6d73 2e70 6164 280a       prims.pad(.
+00017600: 2020 2020 2020 2020 2020 2020 6772 6164              grad
+00017610: 2c0a 2020 2020 2020 2020 2020 2020 302e  ,.            0.
+00017620: 302c 0a20 2020 2020 2020 2020 2020 2023  0,.            #
+00017630: 2054 6865 2070 6978 6573 2061 7265 2073   The pixes are s
+00017640: 7472 6964 6520 6177 6179 2066 726f 6d20  tride away from 
+00017650: 6561 6368 206f 7468 6572 2069 6e20 7468  each other in th
+00017660: 6520 6f72 6967 696e 616c 2069 6e70 7574  e original input
+00017670: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00017680: 4865 6e63 6520 7765 206e 6565 6420 746f  Hence we need to
+00017690: 2064 696c 6174 6520 7468 6520 6772 6164   dilate the grad
+000176a0: 6965 6e74 2062 7920 6469 6c61 7469 6f6e  ient by dilation
+000176b0: 3d73 7472 6964 6520 2d20 310a 2020 2020  =stride - 1.    
+000176c0: 2020 2020 2020 2020 2320 736f 2074 6861          # so tha
+000176d0: 7420 7468 6572 6520 6172 6520 7374 7269  t there are stri
+000176e0: 6465 202d 2031 207a 6572 6f73 2062 6574  de - 1 zeros bet
+000176f0: 7765 656e 2074 6865 2070 6978 656c 732e  ween the pixels.
+00017700: 0a20 2020 2020 2020 2020 2020 205b 2830  .            [(0
+00017710: 2c20 302c 2030 292c 2028 302c 2030 2c20  , 0, 0), (0, 0, 
+00017720: 3029 5d20 2b20 5b28 302c 2030 2c20 7320  0)] + [(0, 0, s 
+00017730: 2d20 3129 2066 6f72 2073 2069 6e20 7374  - 1) for s in st
+00017740: 7269 6465 5d2c 0a20 2020 2020 2020 2029  ride],.        )
+00017750: 2c0a 2020 2020 2020 2020 7472 616e 7370  ,.        transp
+00017760: 6f73 655f 616e 645f 666c 6970 5f77 6569  ose_and_flip_wei
+00017770: 6768 7428 7765 6967 6874 292c 0a20 2020  ght(weight),.   
+00017780: 2020 2020 204e 6f6e 652c 0a20 2020 2020       None,.     
+00017790: 2020 2023 2053 6574 7469 6e67 2073 7472     # Setting str
+000177a0: 6964 6520 746f 2031 2061 7320 7468 6520  ide to 1 as the 
+000177b0: 6469 7374 616e 6365 2062 6574 7765 656e  distance between
+000177c0: 2070 6978 656c 7320 6973 2074 616b 656e   pixels is taken
+000177d0: 0a20 2020 2020 2020 2023 2063 6172 6520  .        # care 
+000177e0: 6279 2074 6865 2070 6164 2072 6967 6874  by the pad right
+000177f0: 2061 626f 7665 2e0a 2020 2020 2020 2020   above..        
+00017800: 2831 2c29 2c0a 2020 2020 2020 2020 696e  (1,),.        in
+00017810: 6974 6961 6c5f 6772 6164 5f70 6164 6469  itial_grad_paddi
+00017820: 6e67 2c0a 2020 2020 2020 2020 6469 6c61  ng,.        dila
+00017830: 7469 6f6e 2c0a 2020 2020 2020 2020 7472  tion,.        tr
+00017840: 616e 7370 6f73 6564 2c0a 2020 2020 2020  ansposed,.      
+00017850: 2020 6f75 7470 7574 5f70 6164 6469 6e67    output_padding
+00017860: 2c0a 2020 2020 2020 2020 6772 6f75 7073  ,.        groups
+00017870: 2c0a 2020 2020 290a 0a20 2020 2064 6566  ,.    )..    def
+00017880: 2070 6164 5f74 6f5f 696e 7075 7428 6772   pad_to_input(gr
+00017890: 6164 293a 0a20 2020 2020 2020 2023 2057  ad):.        # W
+000178a0: 6520 6e65 6564 2074 6f20 756e 7061 6420  e need to unpad 
+000178b0: 7468 6520 7061 6464 696e 6720 646f 6e65  the padding done
+000178c0: 2074 6f20 7468 6520 696e 7075 7420 7072   to the input pr
+000178d0: 696f 7220 746f 2074 6865 2063 6f6e 766f  ior to the convo
+000178e0: 6c75 7469 6f6e 2e0a 2020 2020 2020 2020  lution..        
+000178f0: 2320 4e6f 7465 2074 6861 7420 6c6f 7720  # Note that low 
+00017900: 616e 6420 6869 6768 2070 6164 6469 6e67  and high padding
+00017910: 2061 7265 206e 6f74 206e 6563 6573 7361   are not necessa
+00017920: 7269 6c79 2065 7175 616c 2c20 736f 2077  rily equal, so w
+00017930: 6520 6361 6e6e 6f74 0a20 2020 2020 2020  e cannot.       
+00017940: 2023 2061 6273 6f72 6220 6974 2069 6e74   # absorb it int
+00017950: 6f20 7468 6520 636f 6e76 6f6c 7574 696f  o the convolutio
+00017960: 6e20 6a75 7374 2079 6574 2c20 756e 6c65  n just yet, unle
+00017970: 7373 2074 6865 2041 5049 2069 7320 6d6f  ss the API is mo
+00017980: 6469 6669 6564 2e0a 2020 2020 2020 2020  dified..        
+00017990: 7061 645f 636f 6e66 6967 203d 205b 2830  pad_config = [(0
+000179a0: 2c20 302c 2030 292c 2028 302c 2030 2c20  , 0, 0), (0, 0, 
+000179b0: 3029 5d0a 2020 2020 2020 2020 666f 7220  0)].        for 
+000179c0: 6f2c 2069 2c20 672c 2070 2069 6e20 7a69  o, i, g, p in zi
+000179d0: 7028 6772 6164 2e73 6861 7065 5b32 3a5d  p(grad.shape[2:]
+000179e0: 2c20 7370 6174 6961 6c5f 6469 6d73 2c20  , spatial_dims, 
+000179f0: 696e 7075 745f 6772 6164 2e73 6861 7065  input_grad.shape
+00017a00: 5b32 3a5d 2c20 7061 6464 696e 6729 3a0a  [2:], padding):.
+00017a10: 2020 2020 2020 2020 2020 2020 6c6f 203d              lo =
+00017a20: 202d 700a 2020 2020 2020 2020 2020 2020   -p.            
+00017a30: 2320 4e6f 7465 2074 6861 7420 2869 202b  # Note that (i +
+00017a40: 2032 202a 2070 2920 6973 2074 6865 2073   2 * p) is the s
+00017a50: 697a 6520 6f66 2074 6865 2070 6164 6465  ize of the padde
+00017a60: 6420 696e 7075 742c 0a20 2020 2020 2020  d input,.       
+00017a70: 2020 2020 2023 2073 6f20 7468 6520 7175       # so the qu
+00017a80: 616e 7469 7479 2028 6920 2b20 3220 2a20  antity (i + 2 * 
+00017a90: 7029 202d 2067 2074 656c 6c73 2075 7320  p) - g tells us 
+00017aa0: 6279 2068 6f77 206d 7563 680a 2020 2020  by how much.    
+00017ab0: 2020 2020 2020 2020 2320 7765 206e 6565          # we nee
+00017ac0: 6420 746f 2070 6164 2074 6865 2067 7261  d to pad the gra
+00017ad0: 6469 656e 7420 736f 2074 6861 7420 7468  dient so that th
+00017ae0: 6520 656c 656d 656e 7473 206f 7574 7369  e elements outsi
+00017af0: 6465 0a20 2020 2020 2020 2020 2020 2023  de.            #
+00017b00: 206f 6620 7468 6520 636f 6e76 6f6c 7574   of the convolut
+00017b10: 696f 6e20 7265 6365 6976 6520 7a65 726f  ion receive zero
+00017b20: 2067 7261 6469 656e 742e 0a20 2020 2020   gradient..     
+00017b30: 2020 2020 2020 2023 2070 2069 7320 6164         # p is ad
+00017b40: 6469 7469 6f6e 616c 6c79 2073 7562 7472  ditionally subtr
+00017b50: 6163 7465 6420 746f 206e 6567 6174 6520  acted to negate 
+00017b60: 7468 6520 696e 7075 7427 7320 7061 640a  the input's pad.
+00017b70: 2020 2020 2020 2020 2020 2020 2320 696e              # in
+00017b80: 2066 6f72 7761 7264 2e0a 2020 2020 2020   forward..      
+00017b90: 2020 2020 2020 6869 203d 2028 6920 2b20        hi = (i + 
+00017ba0: 3220 2a20 7029 202d 2067 202d 2070 0a20  2 * p) - g - p. 
+00017bb0: 2020 2020 2020 2020 2020 2070 6164 5f63             pad_c
+00017bc0: 6f6e 6669 672e 6170 7065 6e64 2828 6c6f  onfig.append((lo
+00017bd0: 2c20 6869 2c20 3029 290a 2020 2020 2020  , hi, 0)).      
+00017be0: 2020 7265 7475 726e 2070 7269 6d73 2e70    return prims.p
+00017bf0: 6164 2867 7261 642c 2030 2e30 2c20 7061  ad(grad, 0.0, pa
+00017c00: 645f 636f 6e66 6967 290a 0a20 2020 2069  d_config)..    i
+00017c10: 6e70 7574 5f67 7261 6420 3d20 7061 645f  nput_grad = pad_
+00017c20: 746f 5f69 6e70 7574 2869 6e70 7574 5f67  to_input(input_g
+00017c30: 7261 6429 0a20 2020 2023 207d 0a0a 2020  rad).    # }..  
+00017c40: 2020 2320 6269 6173 5f67 7261 6420 3d20    # bias_grad = 
+00017c50: 7b0a 2020 2020 6966 2062 6961 7320 6973  {.    if bias is
+00017c60: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00017c70: 2020 2069 6d70 6f72 7420 7468 756e 6465     import thunde
+00017c80: 722e 746f 7263 6820 6173 206c 746f 7263  r.torch as ltorc
+00017c90: 680a 0a20 2020 2020 2020 2062 6961 735f  h..        bias_
+00017ca0: 6772 6164 203d 206c 746f 7263 682e 7375  grad = ltorch.su
+00017cb0: 6d28 6772 6164 2c20 5b64 2066 6f72 2064  m(grad, [d for d
+00017cc0: 2069 6e20 7261 6e67 6528 6772 6164 2e6e   in range(grad.n
+00017cd0: 6469 6d29 2069 6620 6420 213d 2031 5d29  dim) if d != 1])
+00017ce0: 0a20 2020 2023 207d 0a0a 2020 2020 2320  .    # }..    # 
+00017cf0: 7765 6967 6874 2067 7261 6420 3d20 7b0a  weight grad = {.
+00017d00: 2020 2020 6465 6620 7061 645f 7472 616e      def pad_tran
+00017d10: 7370 6f73 655f 616e 645f 7075 7368 5f67  spose_and_push_g
+00017d20: 726f 7570 735f 696e 746f 5f62 6174 6368  roups_into_batch
+00017d30: 6573 2874 293a 0a20 2020 2020 2020 2023  es(t):.        #
+00017d40: 2046 6972 7374 2070 6164 2c2e 2e2e 0a20   First pad,.... 
+00017d50: 2020 2020 2020 2023 2050 6164 2061 7320         # Pad as 
+00017d60: 6e65 6365 7373 6172 7920 736f 2074 6861  necessary so tha
+00017d70: 7420 696e 2063 6f6e 766f 6c75 7469 6f6e  t in convolution
+00017d80: 7320 7765 206e 6576 6572 2061 6476 616e  s we never advan
+00017d90: 6365 0a20 2020 2020 2020 2023 2070 6173  ce.        # pas
+00017da0: 7420 7265 6c65 7661 6e74 2069 6e70 7574  t relevant input
+00017db0: 732e 0a20 2020 2020 2020 2070 6164 5f63  s..        pad_c
+00017dc0: 6f6e 6669 6720 3d20 5b28 302c 2030 2c20  onfig = [(0, 0, 
+00017dd0: 3029 2c20 2830 2c20 302c 2030 295d 0a20  0), (0, 0, 0)]. 
+00017de0: 2020 2020 2020 2066 6f72 206f 2c20 692c         for o, i,
+00017df0: 206b 2c20 702c 2073 2c20 6420 696e 207a   k, p, s, d in z
+00017e00: 6970 2867 7261 642e 7368 6170 655b 323a  ip(grad.shape[2:
+00017e10: 5d2c 2073 7061 7469 616c 5f64 696d 732c  ], spatial_dims,
+00017e20: 206b 6572 6e65 6c5f 6469 6d73 2c20 7061   kernel_dims, pa
+00017e30: 6464 696e 672c 2073 7472 6964 652c 2064  dding, stride, d
+00017e40: 696c 6174 696f 6e29 3a0a 2020 2020 2020  ilation):.      
+00017e50: 2020 2020 2020 2320 5061 6464 696e 6720        # Padding 
+00017e60: 6672 6f6d 2062 656c 6f77 2069 7320 7468  from below is th
+00017e70: 6520 7361 6d65 2e0a 2020 2020 2020 2020  e same..        
+00017e80: 2020 2020 6c6f 203d 2070 0a20 2020 2020      lo = p.     
+00017e90: 2020 2020 2020 2023 2054 6865 7265 2069         # There i
+00017ea0: 7320 616c 7761 7973 2074 6865 206d 6178  s always the max
+00017eb0: 2069 6e64 6578 2069 6478 2069 6e20 7468   index idx in th
+00017ec0: 6520 696e 7075 740a 2020 2020 2020 2020  e input.        
+00017ed0: 2020 2020 2320 7468 6520 7661 6c75 6520      # the value 
+00017ee0: 6f66 2077 6869 6368 2c20 696e 7075 745b  of which, input[
+00017ef0: 6964 785d 2c20 7468 6520 6b65 726e 656c  idx], the kernel
+00017f00: 2074 6f75 6368 6573 2e0a 2020 2020 2020   touches..      
+00017f10: 2020 2020 2020 2320 5468 6520 6b65 726e        # The kern
+00017f20: 656c 2072 6561 6368 2c20 6f72 206b 5f72  el reach, or k_r
+00017f30: 6561 6368 2c20 6973 2065 7861 6374 6c79  each, is exactly
+00017f40: 2069 6478 202b 2031 2e0a 2020 2020 2020   idx + 1..      
+00017f50: 2020 2020 2020 2320 5765 2075 7365 2069        # We use i
+00017f60: 7420 746f 2064 6563 6964 6520 6279 2068  t to decide by h
+00017f70: 6f77 206d 7563 6820 7765 206e 6565 6420  ow much we need 
+00017f80: 746f 2070 6164 2066 726f 6d20 6162 6f76  to pad from abov
+00017f90: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+00017fa0: 6173 2074 6f20 6e6f 7420 6d6f 7665 2070  as to not move p
+00017fb0: 6173 7420 7265 6c65 7661 6e74 2076 616c  ast relevant val
+00017fc0: 7565 732e 0a20 2020 2020 2020 2020 2020  ues..           
+00017fd0: 206b 5f72 6561 6368 203d 2028 6f20 2d20   k_reach = (o - 
+00017fe0: 3129 202a 2073 202b 2064 202a 2028 6b20  1) * s + d * (k 
+00017ff0: 2d20 3129 202b 2031 0a20 2020 2020 2020  - 1) + 1.       
+00018000: 2020 2020 2023 2054 6865 2070 6164 2066       # The pad f
+00018010: 726f 6d20 6162 6f76 6520 6571 7561 6c73  rom above equals
+00018020: 206b 5f72 6561 6368 206d 696e 7573 2074   k_reach minus t
+00018030: 6865 206c 656e 6774 680a 2020 2020 2020  he length.      
+00018040: 2020 2020 2020 2320 6f66 2074 6865 2069        # of the i
+00018050: 6e70 7574 2070 6164 6465 6420 6672 6f6d  nput padded from
+00018060: 2062 656c 6f77 2e0a 2020 2020 2020 2020   below..        
+00018070: 2020 2020 6869 203d 206b 5f72 6561 6368      hi = k_reach
+00018080: 202d 2028 6920 2b20 7029 0a20 2020 2020   - (i + p).     
+00018090: 2020 2020 2020 2070 6164 5f63 6f6e 6669         pad_confi
+000180a0: 672e 6170 7065 6e64 2828 6c6f 2c20 6869  g.append((lo, hi
+000180b0: 2c20 3029 290a 2020 2020 2020 2020 7420  , 0)).        t 
+000180c0: 3d20 7072 696d 732e 7061 6428 742c 2030  = prims.pad(t, 0
+000180d0: 2e30 2c20 7061 645f 636f 6e66 6967 290a  .0, pad_config).
+000180e0: 0a20 2020 2020 2020 205f 2c20 5f2c 202a  .        _, _, *
+000180f0: 745f 7370 6174 6961 6c5f 6469 6d73 203d  t_spatial_dims =
+00018100: 2074 2e73 6861 7065 0a0a 2020 2020 2020   t.shape..      
+00018110: 2020 2320 2e2e 2e20 7468 656e 2064 6f20    # ... then do 
+00018120: 7468 6520 7265 7374 2e0a 2020 2020 2020  the rest..      
+00018130: 2020 2320 742e 7368 6170 6520 3d3d 2028    # t.shape == (
+00018140: 6261 7463 682c 2069 6e5f 6368 616e 6e65  batch, in_channe
+00018150: 6c73 2c20 2e2e 2e29 0a20 2020 2020 2020  ls, ...).       
+00018160: 2023 2054 6865 2072 6573 756c 7420 6f66   # The result of
+00018170: 2074 6869 7320 6675 6e63 7469 6f6e 2068   this function h
+00018180: 6173 2073 6861 7065 0a20 2020 2020 2020  as shape.       
+00018190: 2023 2028 696e 5f63 6861 6e6e 656c 732c   # (in_channels,
+000181a0: 2062 6174 6368 202a 2067 726f 7570 7329   batch * groups)
+000181b0: 0a20 2020 2020 2020 2023 2028 6261 7463  .        # (batc
+000181c0: 682c 2069 6e5f 6368 616e 6e65 6c73 2920  h, in_channels) 
+000181d0: 2d3e 2028 696e 5f63 6861 6e6e 656c 732c  -> (in_channels,
+000181e0: 2062 6174 6368 290a 2020 2020 2020 2020   batch).        
+000181f0: 7420 3d20 636f 6e76 5f74 7261 6e73 706f  t = conv_transpo
+00018200: 7365 2874 290a 2020 2020 2020 2020 2320  se(t).        # 
+00018210: 5370 6c69 7420 2869 6e5f 6368 616e 6e65  Split (in_channe
+00018220: 6c73 2c29 202d 3e20 2867 726f 7570 732c  ls,) -> (groups,
+00018230: 2067 696e 5f63 6861 6e6e 656c 7329 0a20   gin_channels). 
+00018240: 2020 2020 2020 2074 203d 2074 2e72 6573         t = t.res
+00018250: 6861 7065 285b 6772 6f75 7073 2c20 6769  hape([groups, gi
+00018260: 6e5f 6368 616e 6e65 6c73 2c20 6261 7463  n_channels, batc
+00018270: 685d 202b 2074 5f73 7061 7469 616c 5f64  h] + t_spatial_d
+00018280: 696d 7329 0a20 2020 2020 2020 2023 2054  ims).        # T
+00018290: 7261 6e73 706f 7365 2028 6772 6f75 7073  ranspose (groups
+000182a0: 2c20 6769 6e5f 6368 616e 6e65 6c73 2c20  , gin_channels, 
+000182b0: 6261 7463 6829 202d 3e20 2867 696e 5f63  batch) -> (gin_c
+000182c0: 6861 6e6e 656c 732c 2067 726f 7570 732c  hannels, groups,
+000182d0: 2062 6174 6368 290a 2020 2020 2020 2020   batch).        
+000182e0: 7420 3d20 636f 6e76 5f74 7261 6e73 706f  t = conv_transpo
+000182f0: 7365 2874 290a 2020 2020 2020 2020 2320  se(t).        # 
+00018300: 466c 6174 7465 6e20 2867 726f 7570 732c  Flatten (groups,
+00018310: 2062 6174 6368 2920 2d3e 2028 6772 6f75   batch) -> (grou
+00018320: 7073 202a 2062 6174 6368 2c29 0a20 2020  ps * batch,).   
+00018330: 2020 2020 2074 203d 2074 2e72 6573 6861       t = t.resha
+00018340: 7065 285b 6769 6e5f 6368 616e 6e65 6c73  pe([gin_channels
+00018350: 2c20 6772 6f75 7073 202a 2062 6174 6368  , groups * batch
+00018360: 5d20 2b20 745f 7370 6174 6961 6c5f 6469  ] + t_spatial_di
+00018370: 6d73 290a 2020 2020 2020 2020 7265 7475  ms).        retu
+00018380: 726e 2074 0a0a 2020 2020 2320 696e 7075  rn t..    # inpu
+00018390: 7420 7769 6c6c 2068 6176 6520 7368 6170  t will have shap
+000183a0: 6520 2867 696e 5f63 6861 6e6e 656c 732c  e (gin_channels,
+000183b0: 2067 726f 7570 7320 2a20 6261 7463 6829   groups * batch)
+000183c0: 0a20 2020 2069 6e70 7574 203d 2070 6164  .    input = pad
+000183d0: 5f74 7261 6e73 706f 7365 5f61 6e64 5f70  _transpose_and_p
+000183e0: 7573 685f 6772 6f75 7073 5f69 6e74 6f5f  ush_groups_into_
+000183f0: 6261 7463 6865 7328 696e 7075 7429 0a20  batches(input). 
+00018400: 2020 2023 2067 7261 6420 7769 6c6c 2068     # grad will h
+00018410: 6176 6520 7368 6170 6520 286f 7574 5f63  ave shape (out_c
+00018420: 6861 6e6e 656c 732c 2062 6174 6368 290a  hannels, batch).
+00018430: 2020 2020 2320 4e6f 7465 2074 6861 7420      # Note that 
+00018440: 7468 6573 6520 7368 6170 6573 2061 7265  these shapes are
+00018450: 2063 6f6d 7061 7469 626c 6520 666f 7220   compatible for 
+00018460: 6120 6772 6f75 7020 636f 6e76 6f6c 7574  a group convolut
+00018470: 696f 6e2e 0a20 2020 2067 7261 6420 3d20  ion..    grad = 
+00018480: 636f 6e76 5f74 7261 6e73 706f 7365 2867  conv_transpose(g
+00018490: 7261 6429 0a0a 2020 2020 2320 5768 7920  rad)..    # Why 
+000184a0: 646f 2077 6520 666c 6970 2073 7472 6964  do we flip strid
+000184b0: 6520 616e 6420 6469 6c61 7469 6f6e 3f0a  e and dilation?.
+000184c0: 2020 2020 2320 6b65 726e 656c 5b69 5d20      # kernel[i] 
+000184d0: 616e 6420 6b65 726e 656c 5b69 202b 2031  and kernel[i + 1
+000184e0: 5d20 6172 6520 6469 6c61 7469 6f6e 2061  ] are dilation a
+000184f0: 7061 7274 2066 726f 6d20 6561 6368 206f  part from each o
+00018500: 7468 6572 2c0a 2020 2020 2320 736f 2064  ther,.    # so d
+00018510: 696c 6174 696f 6e20 6265 636f 6d65 7320  ilation becomes 
+00018520: 7468 6520 6e65 7720 7374 7269 6465 2e0a  the new stride..
+00018530: 2020 2020 2320 416c 6c20 7468 6520 656c      # All the el
+00018540: 656d 656e 7473 2074 6861 7420 6b65 726e  ements that kern
+00018550: 656c 5b69 5d20 746f 7563 6865 7320 6172  el[i] touches ar
+00018560: 6520 7374 7269 6465 2061 7761 7920 6672  e stride away fr
+00018570: 6f6d 2065 6163 6820 6f74 6865 722c 0a20  om each other,. 
+00018580: 2020 2023 2068 656e 6365 2073 7472 6964     # hence strid
+00018590: 6520 6265 636f 6d65 7320 7468 6520 6e65  e becomes the ne
+000185a0: 7720 6469 6c61 7469 6f6e 2e0a 2020 2020  w dilation..    
+000185b0: 7765 6967 6874 5f67 7261 6420 3d20 636f  weight_grad = co
+000185c0: 6e76 6f6c 7574 696f 6e28 0a20 2020 2020  nvolution(.     
+000185d0: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
+000185e0: 2020 6772 6164 2c0a 2020 2020 2020 2020    grad,.        
+000185f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6469  None,.        di
+00018600: 6c61 7469 6f6e 2c20 2023 2073 6574 2073  lation,  # set s
+00018610: 7472 6964 653d 6469 6c61 7469 6f6e 0a20  tride=dilation. 
+00018620: 2020 2020 2020 2028 302c 292c 0a20 2020         (0,),.   
+00018630: 2020 2020 2073 7472 6964 652c 2020 2320       stride,  # 
+00018640: 7365 7420 6469 6c61 7469 6f6e 3d73 7472  set dilation=str
+00018650: 6964 650a 2020 2020 2020 2020 7472 616e  ide.        tran
+00018660: 7370 6f73 6564 2c0a 2020 2020 2020 2020  sposed,.        
+00018670: 6f75 7470 7574 5f70 6164 6469 6e67 2c0a  output_padding,.
+00018680: 2020 2020 2020 2020 6772 6f75 7073 2c0a          groups,.
+00018690: 2020 2020 290a 0a20 2020 2023 2054 6865      )..    # The
+000186a0: 2072 6573 756c 7420 6f66 2074 6865 2063   result of the c
+000186b0: 6f6e 766f 6c75 7469 6f6e 2068 6173 2073  onvolution has s
+000186c0: 6861 7065 2028 6769 6e5f 6368 616e 6e65  hape (gin_channe
+000186d0: 6c73 2c20 6f75 745f 6368 616e 6e65 6c73  ls, out_channels
+000186e0: 292c 0a20 2020 2023 2073 6f20 7472 616e  ),.    # so tran
+000186f0: 7370 6f73 6974 696f 6e20 6973 2072 6571  sposition is req
+00018700: 7569 7265 642e 0a20 2020 2077 6569 6768  uired..    weigh
+00018710: 745f 6772 6164 203d 2063 6f6e 765f 7472  t_grad = conv_tr
+00018720: 616e 7370 6f73 6528 7765 6967 6874 5f67  anspose(weight_g
+00018730: 7261 6429 0a20 2020 2023 207d 0a0a 2020  rad).    # }..  
+00018740: 2020 7265 7475 726e 2028 696e 7075 745f    return (input_
+00018750: 6772 6164 2c20 7765 6967 6874 5f67 7261  grad, weight_gra
+00018760: 642c 2062 6961 735f 6772 6164 290a 0a0a  d, bias_grad)...
+00018770: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
+00018780: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
+00018790: 6368 2e6c 6f67 5f73 6f66 746d 6178 2229  ch.log_softmax")
+000187a0: 0a64 6566 206c 6f67 5f73 6f66 746d 6178  .def log_softmax
+000187b0: 5f61 7567 5f66 7764 2869 6e70 7574 3a20  _aug_fwd(input: 
+000187c0: 5465 6e73 6f72 5072 6f78 792c 2064 696d  TensorProxy, dim
+000187d0: 3a20 696e 742c 202a 2c20 6474 7970 653d  : int, *, dtype=
+000187e0: 4e6f 6e65 2920 2d3e 2056 4a50 4475 616c  None) -> VJPDual
+000187f0: 3a0a 2020 2020 6672 6f6d 2074 6875 6e64  :.    from thund
+00018800: 6572 2e74 6f72 6368 2069 6d70 6f72 7420  er.torch import 
+00018810: 6c6f 675f 736f 6674 6d61 780a 0a20 2020  log_softmax..   
+00018820: 2070 7269 6d61 6c20 3d20 6c6f 675f 736f   primal = log_so
+00018830: 6674 6d61 7828 696e 7075 742c 2064 696d  ftmax(input, dim
+00018840: 3d64 696d 2c20 6474 7970 653d 6474 7970  =dim, dtype=dtyp
+00018850: 6529 0a20 2020 2072 6573 6964 7561 6c73  e).    residuals
+00018860: 203d 2028 7072 696d 616c 2c20 6469 6d2c   = (primal, dim,
+00018870: 2069 6e70 7574 2e64 7479 7065 290a 2020   input.dtype).  
+00018880: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
+00018890: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
+000188a0: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
+000188b0: 6261 636b 7761 7264 2822 746f 7263 682e  backward("torch.
+000188c0: 6c6f 675f 736f 6674 6d61 7822 290a 6465  log_softmax").de
+000188d0: 6620 6c6f 675f 736f 6674 6d61 785f 6261  f log_softmax_ba
+000188e0: 636b 7761 7264 2870 7269 6d61 6c2c 2064  ckward(primal, d
+000188f0: 696d 2c20 6474 7970 652c 2067 293a 0a20  im, dtype, g):. 
+00018900: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
+00018910: 746f 7263 6820 696d 706f 7274 206c 6f67  torch import log
+00018920: 5f73 6f66 746d 6178 5f62 6163 6b77 6172  _softmax_backwar
+00018930: 640a 0a20 2020 2072 6574 7572 6e20 6c6f  d..    return lo
+00018940: 675f 736f 6674 6d61 785f 6261 636b 7761  g_softmax_backwa
+00018950: 7264 2867 2c20 7072 696d 616c 2c20 6469  rd(g, primal, di
+00018960: 6d2c 2064 7479 7065 290a 0a0a 4072 6567  m, dtype)...@reg
+00018970: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
+00018980: 666f 7277 6172 6428 2274 6f72 6368 2e6e  forward("torch.n
+00018990: 6e2e 6675 6e63 7469 6f6e 616c 2e6e 6c6c  n.functional.nll
+000189a0: 5f6c 6f73 7322 290a 6465 6620 6e6c 6c5f  _loss").def nll_
+000189b0: 6c6f 7373 5f61 7567 5f66 7764 280a 2020  loss_aug_fwd(.  
+000189c0: 2020 696e 7075 743a 2050 726f 7879 2c0a    input: Proxy,.
+000189d0: 2020 2020 7461 7267 6574 3a20 5072 6f78      target: Prox
+000189e0: 792c 0a20 2020 2077 6569 6768 743a 204e  y,.    weight: N
+000189f0: 6f6e 6520 7c20 5072 6f78 792c 0a20 2020  one | Proxy,.   
+00018a00: 2069 676e 6f72 655f 696e 6465 783a 2069   ignore_index: i
+00018a10: 6e74 2c0a 2020 2020 7265 6475 6374 696f  nt,.    reductio
+00018a20: 6e3a 2073 7472 2c0a 2920 2d3e 2056 4a50  n: str,.) -> VJP
+00018a30: 4475 616c 3a0a 2020 2020 6672 6f6d 2074  Dual:.    from t
+00018a40: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
+00018a50: 6f72 7420 5f6e 6c6c 5f6c 6f73 735f 6865  ort _nll_loss_he
+00018a60: 6c70 6572 0a0a 2020 2020 7072 696d 616c  lper..    primal
+00018a70: 2c20 746f 7461 6c5f 7765 6967 6874 203d  , total_weight =
+00018a80: 205f 6e6c 6c5f 6c6f 7373 5f68 656c 7065   _nll_loss_helpe
+00018a90: 7228 0a20 2020 2020 2020 2069 6e70 7574  r(.        input
+00018aa0: 2c0a 2020 2020 2020 2020 7461 7267 6574  ,.        target
+00018ab0: 2c0a 2020 2020 2020 2020 7765 6967 6874  ,.        weight
+00018ac0: 2c0a 2020 2020 2020 2020 6967 6e6f 7265  ,.        ignore
+00018ad0: 5f69 6e64 6578 2c0a 2020 2020 2020 2020  _index,.        
+00018ae0: 7265 6475 6374 696f 6e2c 0a20 2020 2029  reduction,.    )
+00018af0: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
+00018b00: 2028 696e 7075 742c 2074 6172 6765 742c   (input, target,
+00018b10: 2077 6569 6768 742c 2072 6564 7563 7469   weight, reducti
+00018b20: 6f6e 2c20 6967 6e6f 7265 5f69 6e64 6578  on, ignore_index
+00018b30: 2c20 746f 7461 6c5f 7765 6967 6874 290a  , total_weight).
+00018b40: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
+00018b50: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
+00018b60: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
+00018b70: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
+00018b80: 682e 6e6e 2e66 756e 6374 696f 6e61 6c2e  h.nn.functional.
+00018b90: 6e6c 6c5f 6c6f 7373 2229 0a64 6566 206e  nll_loss").def n
+00018ba0: 6c6c 5f6c 6f73 735f 6261 636b 7761 7264  ll_loss_backward
+00018bb0: 2869 6e70 7574 2c20 7461 7267 6574 2c20  (input, target, 
+00018bc0: 7765 6967 6874 2c20 7265 6475 6374 696f  weight, reductio
+00018bd0: 6e2c 2069 676e 6f72 655f 696e 6465 782c  n, ignore_index,
+00018be0: 2074 6f74 616c 5f77 6569 6768 742c 2067   total_weight, g
+00018bf0: 293a 0a20 2020 2066 726f 6d20 7468 756e  ):.    from thun
+00018c00: 6465 722e 746f 7263 6820 696d 706f 7274  der.torch import
+00018c10: 206e 6c6c 5f6c 6f73 735f 6261 636b 7761   nll_loss_backwa
+00018c20: 7264 0a0a 2020 2020 6769 6e70 7574 203d  rd..    ginput =
+00018c30: 206e 6c6c 5f6c 6f73 735f 6261 636b 7761   nll_loss_backwa
+00018c40: 7264 2867 2c20 696e 7075 742c 2074 6172  rd(g, input, tar
+00018c50: 6765 742c 2077 6569 6768 742c 2072 6564  get, weight, red
+00018c60: 7563 7469 6f6e 2c20 6967 6e6f 7265 5f69  uction, ignore_i
+00018c70: 6e64 6578 2c20 746f 7461 6c5f 7765 6967  ndex, total_weig
+00018c80: 6874 290a 2020 2020 7265 7475 726e 2067  ht).    return g
+00018c90: 696e 7075 742c 202a 2828 4e6f 6e65 2c29  input, *((None,)
+00018ca0: 202a 2034 290a 0a0a 4072 6567 6973 7465   * 4)...@registe
+00018cb0: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
+00018cc0: 6172 6428 2274 6f72 6368 2e73 706c 6974  ard("torch.split
+00018cd0: 2229 0a64 6566 2073 706c 6974 5f61 7567  ").def split_aug
+00018ce0: 5f66 7764 2861 3a20 5465 6e73 6f72 5072  _fwd(a: TensorPr
+00018cf0: 6f78 792c 2073 706c 6974 5f73 697a 655f  oxy, split_size_
+00018d00: 6f72 5f73 6563 7469 6f6e 733a 2069 6e74  or_sections: int
+00018d10: 207c 2053 6571 7565 6e63 655b 696e 745d   | Sequence[int]
+00018d20: 2c20 6469 6d3a 2069 6e74 203d 2030 2920  , dim: int = 0) 
+00018d30: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
+00018d40: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
+00018d50: 6368 2069 6d70 6f72 7420 7370 6c69 740a  ch import split.
+00018d60: 0a20 2020 2070 7269 6d61 6c20 3d20 7370  .    primal = sp
+00018d70: 6c69 7428 612c 2073 706c 6974 5f73 697a  lit(a, split_siz
+00018d80: 655f 6f72 5f73 6563 7469 6f6e 732c 2064  e_or_sections, d
+00018d90: 696d 290a 2020 2020 7265 7369 6475 616c  im).    residual
+00018da0: 7320 3d20 2864 696d 2c29 0a20 2020 2072  s = (dim,).    r
+00018db0: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
+00018dc0: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
+00018dd0: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
+00018de0: 6b77 6172 6428 2274 6f72 6368 2e73 706c  kward("torch.spl
+00018df0: 6974 2229 0a64 6566 2073 706c 6974 5f62  it").def split_b
+00018e00: 6163 6b77 6172 6428 6469 6d2c 202a 6772  ackward(dim, *gr
+00018e10: 6164 7329 3a0a 2020 2020 6672 6f6d 2074  ads):.    from t
+00018e20: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
+00018e30: 6f72 7420 6361 740a 0a20 2020 2072 6574  ort cat..    ret
+00018e40: 7572 6e20 6361 7428 6772 6164 732c 2064  urn cat(grads, d
+00018e50: 696d 290a 0a0a 4072 6567 6973 7465 725f  im)...@register_
+00018e60: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00018e70: 6428 2274 6f72 6368 2e6e 6e2e 6675 6e63  d("torch.nn.func
+00018e80: 7469 6f6e 616c 2e65 6d62 6564 6469 6e67  tional.embedding
+00018e90: 2229 0a64 6566 2065 6d62 6564 6469 6e67  ").def embedding
+00018ea0: 5f61 7567 5f66 7764 280a 2020 2020 613a  _aug_fwd(.    a:
+00018eb0: 2050 726f 7879 2c0a 2020 2020 7765 6967   Proxy,.    weig
+00018ec0: 6874 3a20 5072 6f78 792c 0a20 2020 2070  ht: Proxy,.    p
+00018ed0: 6164 6469 6e67 5f69 6478 3a20 696e 7420  adding_idx: int 
+00018ee0: 7c20 4e6f 6e65 2c0a 2020 2020 6d61 785f  | None,.    max_
+00018ef0: 6e6f 726d 3a20 666c 6f61 7420 7c20 4e6f  norm: float | No
+00018f00: 6e65 2c0a 2020 2020 6e6f 726d 5f74 7970  ne,.    norm_typ
+00018f10: 653a 2066 6c6f 6174 2c0a 2020 2020 7363  e: float,.    sc
+00018f20: 616c 655f 6772 6164 5f62 795f 6672 6571  ale_grad_by_freq
+00018f30: 3a20 626f 6f6c 2c0a 2020 2020 7370 6172  : bool,.    spar
+00018f40: 7365 3a20 626f 6f6c 2c0a 2920 2d3e 2056  se: bool,.) -> V
+00018f50: 4a50 4475 616c 3a0a 2020 2020 6672 6f6d  JPDual:.    from
+00018f60: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+00018f70: 6d70 6f72 7420 656d 6265 6464 696e 670a  mport embedding.
+00018f80: 0a20 2020 2070 7269 6d61 6c20 3d20 656d  .    primal = em
+00018f90: 6265 6464 696e 6728 0a20 2020 2020 2020  bedding(.       
+00018fa0: 2061 2c0a 2020 2020 2020 2020 7765 6967   a,.        weig
+00018fb0: 6874 2c0a 2020 2020 2020 2020 7061 6464  ht,.        padd
+00018fc0: 696e 675f 6964 783d 7061 6464 696e 675f  ing_idx=padding_
+00018fd0: 6964 782c 0a20 2020 2020 2020 206d 6178  idx,.        max
+00018fe0: 5f6e 6f72 6d3d 6d61 785f 6e6f 726d 2c0a  _norm=max_norm,.
+00018ff0: 2020 2020 2020 2020 6e6f 726d 5f74 7970          norm_typ
+00019000: 653d 6e6f 726d 5f74 7970 652c 0a20 2020  e=norm_type,.   
+00019010: 2020 2020 2073 6361 6c65 5f67 7261 645f       scale_grad_
+00019020: 6279 5f66 7265 713d 7363 616c 655f 6772  by_freq=scale_gr
+00019030: 6164 5f62 795f 6672 6571 2c0a 2020 2020  ad_by_freq,.    
+00019040: 2020 2020 7370 6172 7365 3d73 7061 7273      sparse=spars
+00019050: 652c 0a20 2020 2029 0a20 2020 2072 6573  e,.    ).    res
+00019060: 6964 7561 6c73 203d 2028 612c 2077 6569  iduals = (a, wei
+00019070: 6768 742e 7368 6170 655b 305d 2c20 7061  ght.shape[0], pa
+00019080: 6464 696e 675f 6964 782c 2073 6361 6c65  dding_idx, scale
+00019090: 5f67 7261 645f 6279 5f66 7265 712c 2073  _grad_by_freq, s
+000190a0: 7061 7273 6529 0a20 2020 2072 6574 7572  parse).    retur
+000190b0: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
+000190c0: 2c20 7265 7369 6475 616c 7329 0a0a 0a40  , residuals)...@
+000190d0: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
+000190e0: 6428 2274 6f72 6368 2e6e 6e2e 6675 6e63  d("torch.nn.func
+000190f0: 7469 6f6e 616c 2e65 6d62 6564 6469 6e67  tional.embedding
+00019100: 2229 0a64 6566 2065 6d62 6564 6469 6e67  ").def embedding
+00019110: 5f62 6163 6b77 6172 6428 612c 206e 756d  _backward(a, num
+00019120: 5f77 6569 6768 7473 2c20 7061 6464 696e  _weights, paddin
+00019130: 675f 6964 782c 2073 6361 6c65 5f67 7261  g_idx, scale_gra
+00019140: 645f 6279 5f66 7265 712c 2073 7061 7273  d_by_freq, spars
+00019150: 652c 2067 293a 0a20 2020 2066 726f 6d20  e, g):.    from 
+00019160: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
+00019170: 706f 7274 2065 6d62 6564 6469 6e67 5f62  port embedding_b
+00019180: 6163 6b77 6172 640a 0a20 2020 2070 6164  ackward..    pad
+00019190: 6469 6e67 5f69 6478 203d 202d 3120 6966  ding_idx = -1 if
+000191a0: 2070 6164 6469 6e67 5f69 6478 2069 7320   padding_idx is 
+000191b0: 4e6f 6e65 2065 6c73 6520 7061 6464 696e  None else paddin
+000191c0: 675f 6964 780a 2020 2020 6777 6569 6768  g_idx.    gweigh
+000191d0: 7420 3d20 656d 6265 6464 696e 675f 6261  t = embedding_ba
+000191e0: 636b 7761 7264 2867 2c20 612c 206e 756d  ckward(g, a, num
+000191f0: 5f77 6569 6768 7473 2c20 7061 6464 696e  _weights, paddin
+00019200: 675f 6964 782c 2073 6361 6c65 5f67 7261  g_idx, scale_gra
+00019210: 645f 6279 5f66 7265 712c 2073 7061 7273  d_by_freq, spars
+00019220: 6529 0a20 2020 2072 6574 7572 6e20 6777  e).    return gw
+00019230: 6569 6768 740a 0a0a 4072 6567 6973 7465  eight...@registe
+00019240: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
+00019250: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
+00019260: 732e 4241 5443 485f 4e4f 524d 290a 6465  s.BATCH_NORM).de
+00019270: 6620 6261 7463 685f 6e6f 726d 5f61 7567  f batch_norm_aug
+00019280: 5f66 7764 280a 2020 2020 613a 2054 656e  _fwd(.    a: Ten
+00019290: 736f 7250 726f 7879 2c0a 2020 2020 7765  sorProxy,.    we
+000192a0: 6967 6874 3a20 4e6f 6e65 207c 2054 656e  ight: None | Ten
+000192b0: 736f 7250 726f 7879 2c0a 2020 2020 6269  sorProxy,.    bi
+000192c0: 6173 3a20 4e6f 6e65 207c 2054 656e 736f  as: None | Tenso
+000192d0: 7250 726f 7879 2c0a 2020 2020 7275 6e6e  rProxy,.    runn
+000192e0: 696e 675f 6d65 616e 3a20 4e6f 6e65 207c  ing_mean: None |
+000192f0: 2054 656e 736f 7250 726f 7879 2c0a 2020   TensorProxy,.  
+00019300: 2020 7275 6e6e 696e 675f 7661 723a 204e    running_var: N
+00019310: 6f6e 6520 7c20 5465 6e73 6f72 5072 6f78  one | TensorProx
+00019320: 792c 0a20 2020 2074 7261 696e 696e 673a  y,.    training:
+00019330: 2062 6f6f 6c2c 0a20 2020 206d 6f6d 656e   bool,.    momen
+00019340: 7475 6d3a 204e 756d 6265 722c 0a20 2020  tum: Number,.   
+00019350: 2065 7073 3a20 4e75 6d62 6572 2c0a 2920   eps: Number,.) 
+00019360: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
+00019370: 7072 696d 616c 203d 2070 7269 6d73 2e62  primal = prims.b
+00019380: 6174 6368 5f6e 6f72 6d28 0a20 2020 2020  atch_norm(.     
+00019390: 2020 2061 2c0a 2020 2020 2020 2020 7765     a,.        we
+000193a0: 6967 6874 2c0a 2020 2020 2020 2020 6269  ight,.        bi
+000193b0: 6173 2c0a 2020 2020 2020 2020 7275 6e6e  as,.        runn
+000193c0: 696e 675f 6d65 616e 2c0a 2020 2020 2020  ing_mean,.      
+000193d0: 2020 7275 6e6e 696e 675f 7661 722c 0a20    running_var,. 
+000193e0: 2020 2020 2020 2074 7261 696e 696e 672c         training,
+000193f0: 0a20 2020 2020 2020 206d 6f6d 656e 7475  .        momentu
+00019400: 6d2c 0a20 2020 2020 2020 2065 7073 2c0a  m,.        eps,.
+00019410: 2020 2020 290a 2020 2020 6f75 7470 7574      ).    output
+00019420: 5f6d 6173 6b20 3d20 5b78 2069 7320 6e6f  _mask = [x is no
+00019430: 7420 4e6f 6e65 2066 6f72 2078 2069 6e20  t None for x in 
+00019440: 2861 2c20 7765 6967 6874 2c20 6269 6173  (a, weight, bias
+00019450: 295d 0a20 2020 206f 7574 7075 742c 2073  )].    output, s
+00019460: 6176 655f 6d65 616e 2c20 7361 7665 5f69  ave_mean, save_i
+00019470: 6e76 7374 6420 3d20 7072 696d 616c 0a20  nvstd = primal. 
+00019480: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
+00019490: 612c 2077 6569 6768 742c 2072 756e 6e69  a, weight, runni
+000194a0: 6e67 5f6d 6561 6e2c 2072 756e 6e69 6e67  ng_mean, running
+000194b0: 5f76 6172 2c20 7361 7665 5f6d 6561 6e2c  _var, save_mean,
+000194c0: 2073 6176 655f 696e 7673 7464 2c20 7472   save_invstd, tr
+000194d0: 6169 6e69 6e67 2c20 6570 732c 206f 7574  aining, eps, out
+000194e0: 7075 745f 6d61 736b 290a 2020 2020 7265  put_mask).    re
+000194f0: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
+00019500: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
+00019510: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
+00019520: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
+00019530: 4473 2e42 4154 4348 5f4e 4f52 4d29 0a64  Ds.BATCH_NORM).d
+00019540: 6566 2062 6174 6368 5f6e 6f72 6d5f 6261  ef batch_norm_ba
+00019550: 636b 7761 7264 2861 2c20 7765 6967 6874  ckward(a, weight
+00019560: 2c20 7275 6e6e 696e 675f 6d65 616e 2c20  , running_mean, 
+00019570: 7275 6e6e 696e 675f 7661 722c 2073 6176  running_var, sav
+00019580: 655f 6d65 616e 2c20 7361 7665 5f69 6e76  e_mean, save_inv
+00019590: 7374 642c 2074 7261 696e 2c20 6570 732c  std, train, eps,
+000195a0: 206f 7574 7075 745f 6d61 736b 2c20 2a67   output_mask, *g
+000195b0: 7261 6473 293a 0a20 2020 2066 726f 6d20  rads):.    from 
+000195c0: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
+000195d0: 706f 7274 2062 6174 6368 5f6e 6f72 6d5f  port batch_norm_
+000195e0: 6261 636b 7761 7264 0a0a 2020 2020 7265  backward..    re
+000195f0: 7375 6c74 203d 2062 6174 6368 5f6e 6f72  sult = batch_nor
+00019600: 6d5f 6261 636b 7761 7264 280a 2020 2020  m_backward(.    
+00019610: 2020 2020 6772 6164 735b 305d 2c20 612c      grads[0], a,
+00019620: 2077 6569 6768 742c 2072 756e 6e69 6e67   weight, running
+00019630: 5f6d 6561 6e2c 2072 756e 6e69 6e67 5f76  _mean, running_v
+00019640: 6172 2c20 7361 7665 5f6d 6561 6e2c 2073  ar, save_mean, s
+00019650: 6176 655f 696e 7673 7464 2c20 7472 6169  ave_invstd, trai
+00019660: 6e2c 2065 7073 2c20 6f75 7470 7574 5f6d  n, eps, output_m
+00019670: 6173 6b0a 2020 2020 290a 2020 2020 7265  ask.    ).    re
+00019680: 7475 726e 202a 7265 7375 6c74 2c20 4e6f  turn *result, No
+00019690: 6e65 2c20 4e6f 6e65 0a0a 0a40 7265 6769  ne, None...@regi
+000196a0: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
+000196b0: 6f72 7761 7264 2822 746f 7263 682e 6375  orward("torch.cu
+000196c0: 6d73 756d 2229 0a64 6566 2063 756d 7375  msum").def cumsu
+000196d0: 6d5f 6175 675f 6677 6428 613a 2050 726f  m_aug_fwd(a: Pro
+000196e0: 7879 2c20 6469 6d3a 2069 6e74 2c20 2a2c  xy, dim: int, *,
+000196f0: 2064 7479 7065 3a20 4e6f 6e65 207c 2064   dtype: None | d
+00019700: 7479 7065 732e 6474 7970 6520 3d20 4e6f  types.dtype = No
+00019710: 6e65 2920 2d3e 2056 4a50 4475 616c 3a0a  ne) -> VJPDual:.
+00019720: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
+00019730: 2e74 6f72 6368 2069 6d70 6f72 7420 6375  .torch import cu
+00019740: 6d73 756d 0a0a 2020 2020 7072 696d 616c  msum..    primal
+00019750: 203d 2063 756d 7375 6d28 612c 2064 696d   = cumsum(a, dim
+00019760: 2c20 6474 7970 653d 6474 7970 6529 0a20  , dtype=dtype). 
+00019770: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
+00019780: 0a20 2020 2020 2020 2061 2e64 7479 7065  .        a.dtype
+00019790: 2c0a 2020 2020 2020 2020 6469 6d2c 0a20  ,.        dim,. 
+000197a0: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
+000197b0: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+000197c0: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
+000197d0: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+000197e0: 2274 6f72 6368 2e63 756d 7375 6d22 290a  "torch.cumsum").
+000197f0: 6465 6620 6375 6d73 756d 5f62 6163 6b77  def cumsum_backw
+00019800: 6172 6428 615f 6474 7970 652c 2064 696d  ard(a_dtype, dim
+00019810: 2c20 6729 3a0a 2020 2020 6720 3d20 672e  , g):.    g = g.
+00019820: 746f 2861 5f64 7479 7065 290a 2020 2020  to(a_dtype).    
+00019830: 6966 2067 2e6e 756d 656c 203c 3d20 3120  if g.numel <= 1 
+00019840: 6f72 2067 2e73 6861 7065 5b64 696d 5d20  or g.shape[dim] 
+00019850: 3d3d 2031 3a0a 2020 2020 2020 2020 7265  == 1:.        re
+00019860: 7475 726e 2067 0a20 2020 2072 6574 7572  turn g.    retur
+00019870: 6e20 672e 666c 6970 2864 696d 292e 6375  n g.flip(dim).cu
+00019880: 6d73 756d 2864 696d 292e 666c 6970 2864  msum(dim).flip(d
+00019890: 696d 290a 0a0a 4072 6567 6973 7465 725f  im)...@register_
+000198a0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+000198b0: 6428 2274 6f72 6368 2e73 6f66 746d 6178  d("torch.softmax
+000198c0: 2229 0a64 6566 2073 6f66 746d 6178 5f61  ").def softmax_a
+000198d0: 7567 5f66 7764 2861 3a20 5072 6f78 792c  ug_fwd(a: Proxy,
+000198e0: 2064 696d 3a20 696e 742c 2064 7479 7065   dim: int, dtype
+000198f0: 3a20 6474 7970 6573 2e64 7479 7065 207c  : dtypes.dtype |
+00019900: 204e 6f6e 6520 3d20 4e6f 6e65 2920 2d3e   None = None) ->
+00019910: 2056 4a50 4475 616c 3a0a 2020 2020 6672   VJPDual:.    fr
+00019920: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
+00019930: 2069 6d70 6f72 7420 736f 6674 6d61 780a   import softmax.
+00019940: 0a20 2020 2070 7269 6d61 6c20 3d20 736f  .    primal = so
+00019950: 6674 6d61 7828 612c 2064 696d 2c20 6474  ftmax(a, dim, dt
+00019960: 7970 653d 6474 7970 6529 0a20 2020 2072  ype=dtype).    r
+00019970: 6573 6964 7561 6c73 203d 2028 7072 696d  esiduals = (prim
+00019980: 616c 2c20 6469 6d29 0a20 2020 2072 6574  al, dim).    ret
+00019990: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
+000199a0: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
+000199b0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+000199c0: 6172 6428 2274 6f72 6368 2e73 6f66 746d  ard("torch.softm
+000199d0: 6178 2229 0a64 6566 2073 6f66 746d 6178  ax").def softmax
+000199e0: 5f62 6163 6b77 6172 6428 7072 696d 616c  _backward(primal
+000199f0: 2c20 6469 6d2c 2067 293a 0a20 2020 2072  , dim, g):.    r
+00019a00: 6574 7572 6e20 7072 696d 616c 202a 2028  eturn primal * (
+00019a10: 6720 2d20 2870 7269 6d61 6c20 2a20 6729  g - (primal * g)
+00019a20: 2e73 756d 2864 696d 2c20 6b65 6570 6469  .sum(dim, keepdi
+00019a30: 6d3d 5472 7565 2929 0a0a 0a64 6566 2069  m=True))...def i
+00019a40: 7465 725f 626f 756e 645f 7379 6d62 6f6c  ter_bound_symbol
+00019a50: 7328 626f 756e 645f 7379 6d62 6f6c 7329  s(bound_symbols)
+00019a60: 3a0a 2020 2020 2222 2249 7465 7261 7465  :.    """Iterate
+00019a70: 206f 7665 7220 626f 756e 6420 7379 6d62   over bound symb
+00019a80: 6f6c 732c 2073 6b69 7070 696e 6720 7379  ols, skipping sy
+00019a90: 6d62 6f6c 7320 7468 6174 2061 7265 206e  mbols that are n
+00019aa0: 6f74 2073 7570 706f 7274 6564 2062 790a  ot supported by.
+00019ab0: 2020 2020 7468 6520 7472 616e 7366 6f72      the transfor
+00019ac0: 6d73 2069 6e66 7261 7374 7275 6374 7572  ms infrastructur
+00019ad0: 652e 0a0a 2020 2020 4172 6773 3a0a 2020  e...    Args:.  
+00019ae0: 2020 2020 2020 626f 756e 645f 7379 6d62        bound_symb
+00019af0: 6f6c 7320 284c 6973 745b 426f 756e 6453  ols (List[BoundS
+00019b00: 796d 626f 6c5d 293a 204c 6973 7420 6f66  ymbol]): List of
+00019b10: 2062 6f75 6e64 2073 796d 626f 6c73 0a0a   bound symbols..
+00019b20: 2020 2020 5969 656c 6473 3a0a 2020 2020      Yields:.    
+00019b30: 2020 2020 426f 756e 6453 796d 626f 6c3a      BoundSymbol:
+00019b40: 2042 6f75 6e64 2073 796d 626f 6c73 2074   Bound symbols t
+00019b50: 6861 7420 6172 6520 7375 7070 6f72 7465  hat are supporte
+00019b60: 6420 6279 2074 6865 2074 7261 6e73 666f  d by the transfo
+00019b70: 726d 730a 2020 2020 2020 2020 696e 6672  rms.        infr
+00019b80: 6173 7472 7563 7475 7265 0a20 2020 2022  astructure.    "
+00019b90: 2222 0a20 2020 2066 6f72 2073 796d 626f  "".    for symbo
+00019ba0: 6c20 696e 2062 6f75 6e64 5f73 796d 626f  l in bound_symbo
+00019bb0: 6c73 3a0a 2020 2020 2020 2020 6966 2073  ls:.        if s
+00019bc0: 796d 626f 6c2e 7379 6d2e 6964 2069 6e20  ymbol.sym.id in 
+00019bd0: 7472 616e 7366 6f72 6d5f 736b 6970 5f6c  transform_skip_l
+00019be0: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
+00019bf0: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
+00019c00: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00019c10: 2020 2020 7969 656c 6420 7379 6d62 6f6c      yield symbol
+00019c20: 0a0a 0a64 6566 2064 6563 6f6e 7374 7275  ...def deconstru
+00019c30: 6374 5f66 6f72 7761 7264 5f65 6e76 5f66  ct_forward_env_f
+00019c40: 6f72 5f62 6163 6b77 6172 6428 7472 6163  or_backward(trac
+00019c50: 652c 2065 6e76 293a 0a20 2020 2023 204e  e, env):.    # N
+00019c60: 6f74 6520 5b53 6176 696e 6720 7468 6520  ote [Saving the 
+00019c70: 666f 7277 6172 6420 656e 7669 726f 6e6d  forward environm
+00019c80: 656e 7420 696e 2074 6865 2062 6163 6b77  ent in the backw
+00019c90: 6172 6420 7275 6c65 5d0a 2020 2020 2320  ard rule].    # 
+00019ca0: 5765 2063 616e 6e6f 7420 7361 7665 2074  We cannot save t
+00019cb0: 6865 2074 7261 6365 206f 626a 6563 7420  he trace object 
+00019cc0: 696e 2074 6865 2072 6573 6964 7561 6c73  in the residuals
+00019cd0: 2062 6563 6175 7365 2065 7865 6375 746f   because executo
+00019ce0: 7273 206d 6179 206e 6f74 0a20 2020 2023  rs may not.    #
+00019cf0: 2062 6520 6162 6c65 2074 6f20 7265 7475   be able to retu
+00019d00: 726e 2069 7420 666f 7220 7468 6520 7370  rn it for the sp
+00019d10: 6c69 7474 6564 2066 6f72 7761 7264 2f62  litted forward/b
+00019d20: 6163 6b77 6172 6420 7061 7373 6573 2e20  ackward passes. 
+00019d30: 496e 7374 6561 642c 2077 650a 2020 2020  Instead, we.    
+00019d40: 2320 7361 7665 2061 7267 7320 616e 6420  # save args and 
+00019d50: 6b77 6172 6773 206f 6620 7468 6520 6f72  kwargs of the or
+00019d60: 6967 696e 616c 2066 756e 6374 696f 6e20  iginal function 
+00019d70: 6361 6c6c 2061 6e64 2072 6563 6f6e 7374  call and reconst
+00019d80: 7275 6374 2074 6865 0a20 2020 2023 2074  ruct the.    # t
+00019d90: 7261 6365 206f 626a 6563 7420 616e 6420  race object and 
+00019da0: 6974 7320 656e 7669 726f 6e6d 656e 7420  its environment 
+00019db0: 6469 6374 2069 6e20 7468 6520 6261 636b  dict in the back
+00019dc0: 7761 7264 2072 756c 652e 2048 6572 6520  ward rule. Here 
+00019dd0: 7765 2072 656c 790a 2020 2020 2320 6f6e  we rely.    # on
+00019de0: 2074 6865 2066 6163 7420 7468 6174 2074   the fact that t
+00019df0: 6865 206f 7264 6572 206f 6620 7468 6520  he order of the 
+00019e00: 7379 6d62 6f6c 7320 696e 2074 6865 2074  symbols in the t
+00019e10: 7261 6365 2069 7320 6465 7465 726d 696e  race is determin
+00019e20: 6973 7469 630a 2020 2020 2320 616e 6420  istic.    # and 
+00019e30: 616c 7761 7973 2074 6865 2073 616d 6520  always the same 
+00019e40: 666f 7220 7468 6520 7361 6d65 2066 756e  for the same fun
+00019e50: 6374 696f 6e20 6361 6c6c 2061 6e64 2074  ction call and t
+00019e60: 6865 2073 616d 6520 7365 7420 6f66 0a20  he same set of. 
+00019e70: 2020 2023 2061 7267 756d 656e 7473 2e20     # arguments. 
+00019e80: 5365 6520 7465 7374 5f67 7261 642e 7079  See test_grad.py
+00019e90: 3a74 6573 745f 746f 7263 685f 6175 746f  :test_torch_auto
+00019ea0: 6772 6164 5f66 756e 6374 696f 6e20 666f  grad_function fo
+00019eb0: 7220 616e 2065 7861 6d70 6c65 0a20 2020  r an example.   
+00019ec0: 2023 2077 6865 7265 2074 6869 7320 6973   # where this is
+00019ed0: 2074 6573 7465 642e 0a20 2020 2062 6f75   tested..    bou
+00019ee0: 6e64 5f73 796d 626f 6c73 203d 2069 7465  nd_symbols = ite
+00019ef0: 725f 626f 756e 645f 7379 6d62 6f6c 7328  r_bound_symbols(
+00019f00: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
+00019f10: 6f6c 7329 0a20 2020 2073 6176 6564 5f66  ols).    saved_f
+00019f20: 6f72 5f62 6163 6b77 6172 6420 3d20 7475  or_backward = tu
+00019f30: 706c 6528 656e 765b 7365 7175 656e 6369  ple(env[sequenci
+00019f40: 6679 2873 796d 626f 6c2e 6f75 7470 7574  fy(symbol.output
+00019f50: 295b 305d 2e6e 616d 655d 2e72 6573 6964  )[0].name].resid
+00019f60: 7561 6c73 2066 6f72 2073 796d 626f 6c20  uals for symbol 
+00019f70: 696e 2062 6f75 6e64 5f73 796d 626f 6c73  in bound_symbols
+00019f80: 290a 2020 2020 7265 7475 726e 2073 6176  ).    return sav
+00019f90: 6564 5f66 6f72 5f62 6163 6b77 6172 640a  ed_for_backward.
+00019fa0: 0a0a 6465 6620 7265 636f 6e73 7472 7563  ..def reconstruc
+00019fb0: 745f 666f 7277 6172 645f 656e 765f 666f  t_forward_env_fo
+00019fc0: 725f 6261 636b 7761 7264 2874 7261 6365  r_backward(trace
+00019fd0: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
+00019fe0: 7761 7264 293a 0a20 2020 2062 6f75 6e64  ward):.    bound
+00019ff0: 5f73 796d 626f 6c73 203d 2069 7465 725f  _symbols = iter_
+0001a000: 626f 756e 645f 7379 6d62 6f6c 7328 7472  bound_symbols(tr
+0001a010: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
+0001a020: 7329 0a0a 2020 2020 7265 636f 6e73 7472  s)..    reconstr
+0001a030: 7563 7465 645f 656e 7620 3d20 7b7d 0a0a  ucted_env = {}..
+0001a040: 2020 2020 666f 7220 6964 782c 2073 796d      for idx, sym
+0001a050: 2069 6e20 656e 756d 6572 6174 6528 626f   in enumerate(bo
+0001a060: 756e 645f 7379 6d62 6f6c 7329 3a0a 2020  und_symbols):.  
+0001a070: 2020 2020 2020 6b20 3d20 7365 7175 656e        k = sequen
+0001a080: 6369 6679 2873 796d 2e6f 7574 7075 7429  cify(sym.output)
+0001a090: 5b30 5d2e 6e61 6d65 0a20 2020 2020 2020  [0].name.       
+0001a0a0: 2076 203d 2056 4a50 4475 616c 284e 6f6e   v = VJPDual(Non
+0001a0b0: 652c 2073 6176 6564 5f66 6f72 5f62 6163  e, saved_for_bac
+0001a0c0: 6b77 6172 645b 6964 785d 290a 2020 2020  kward[idx]).    
+0001a0d0: 2020 2020 7265 636f 6e73 7472 7563 7465      reconstructe
+0001a0e0: 645f 656e 765b 6b5d 203d 2076 0a0a 2020  d_env[k] = v..  
+0001a0f0: 2020 7265 7475 726e 2072 6563 6f6e 7374    return reconst
+0001a100: 7275 6374 6564 5f65 6e76 0a0a 0a64 6566  ructed_env...def
+0001a110: 2064 6563 6f6d 706f 7365 645f 666e 5f61   decomposed_fn_a
+0001a120: 7567 5f66 7764 5f72 756c 6528 2a61 7267  ug_fwd_rule(*arg
+0001a130: 732c 2064 6563 6f6d 706f 7365 645f 666e  s, decomposed_fn
+0001a140: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+0001a150: 2022 2222 4175 676d 656e 7465 6420 666f   """Augmented fo
+0001a160: 7277 6172 6420 7275 6c65 2066 6f72 2063  rward rule for c
+0001a170: 6f6d 706f 7369 7465 2066 756e 6374 696f  omposite functio
+0001a180: 6e73 2069 6d70 6c65 6d65 6e74 6564 2069  ns implemented i
+0001a190: 6e20 7465 726d 7320 6f66 206f 7468 6572  n terms of other
+0001a1a0: 2066 756e 6374 696f 6e73 2074 6861 7420   functions that 
+0001a1b0: 6172 650a 2020 2020 7375 7070 6f73 6564  are.    supposed
+0001a1c0: 2074 6f20 6265 2073 7570 706f 7274 6564   to be supported
+0001a1d0: 2062 7920 7468 6520 564a 5020 696e 6672   by the VJP infr
+0001a1e0: 6173 7472 7563 7475 7265 2e0a 0a20 2020  astructure...   
+0001a1f0: 2041 7267 733a 0a20 2020 2020 2020 2064   Args:.        d
+0001a200: 6563 6f6d 706f 7365 645f 666e 2028 4361  ecomposed_fn (Ca
+0001a210: 6c6c 6162 6c65 293a 2064 6563 6f6d 706f  llable): decompo
+0001a220: 7365 6420 7665 7273 696f 6e20 6f66 2074  sed version of t
+0001a230: 6865 2066 756e 6374 696f 6e0a 0a20 2020  he function..   
+0001a240: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001a250: 2020 4361 6c6c 6162 6c65 3a20 4175 676d    Callable: Augm
+0001a260: 656e 7465 6420 666f 7277 6172 6420 7275  ented forward ru
+0001a270: 6c65 2066 6f72 2074 6865 2063 6f6d 706f  le for the compo
+0001a280: 7369 7465 2066 756e 6374 696f 6e0a 2020  site function.  
+0001a290: 2020 2222 220a 2020 2020 7472 6163 6520    """.    trace 
+0001a2a0: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
+0001a2b0: 6528 2928 6465 636f 6d70 6f73 6564 5f66  e()(decomposed_f
+0001a2c0: 6e2c 202a 6172 6773 2c20 2a2a 6b77 6172  n, *args, **kwar
+0001a2d0: 6773 290a 2020 2020 7472 6163 6520 3d20  gs).    trace = 
+0001a2e0: 756e 7772 6170 5f6f 6e65 5f6c 6576 656c  unwrap_one_level
+0001a2f0: 5f6f 665f 7375 6273 796d 626f 6c73 2874  _of_subsymbols(t
+0001a300: 7261 6365 290a 2020 2020 2320 5468 6572  race).    # Ther
+0001a310: 6520 6d61 7920 6265 2061 2064 6561 6420  e may be a dead 
+0001a320: 6e6f 6465 206c 696b 6520 225f 203d 2070  node like "_ = p
+0001a330: 7269 6d73 2e63 6f6e 7665 7274 5f65 6c65  rims.convert_ele
+0001a340: 6d65 6e74 5f74 7970 6528 302c 2066 6c6f  ment_type(0, flo
+0001a350: 6174 2922 0a20 2020 2023 2069 6e20 7468  at)".    # in th
+0001a360: 6520 7472 6163 652e 2057 6520 6e65 6564  e trace. We need
+0001a370: 2074 6f20 7265 6d6f 7665 2069 7420 6265   to remove it be
+0001a380: 666f 7265 2077 6520 6361 6e20 7573 6520  fore we can use 
+0001a390: 7468 6520 7472 6163 6520 666f 720a 2020  the trace for.  
+0001a3a0: 2020 2320 6175 676d 656e 7465 645f 666f    # augmented_fo
+0001a3b0: 7277 6172 645f 7061 7373 2e0a 2020 2020  rward_pass..    
+0001a3c0: 7472 6163 6520 3d20 6463 6528 7472 6163  trace = dce(trac
+0001a3d0: 6529 0a20 2020 2072 6573 756c 742c 2065  e).    result, e
+0001a3e0: 6e76 203d 2061 7567 6d65 6e74 6564 5f66  nv = augmented_f
+0001a3f0: 6f72 7761 7264 5f70 6173 7328 2a61 7267  orward_pass(*arg
+0001a400: 732c 2074 7261 6365 3d74 7261 6365 2c20  s, trace=trace, 
+0001a410: 2a2a 6b77 6172 6773 290a 2020 2020 7361  **kwargs).    sa
+0001a420: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001a430: 203d 2064 6563 6f6e 7374 7275 6374 5f66   = deconstruct_f
+0001a440: 6f72 7761 7264 5f65 6e76 5f66 6f72 5f62  orward_env_for_b
+0001a450: 6163 6b77 6172 6428 7472 6163 652c 2065  ackward(trace, e
+0001a460: 6e76 290a 2020 2020 2320 5374 6174 6963  nv).    # Static
+0001a470: 2063 6163 6869 6e67 2064 6f65 7320 6e6f   caching does no
+0001a480: 7420 7769 7468 2077 6974 6820 6b77 6172  t with with kwar
+0001a490: 6773 2064 6963 7473 2c20 736f 2077 6527  gs dicts, so we'
+0001a4a0: 7265 2063 6f6e 7665 7274 696e 6720 7468  re converting th
+0001a4b0: 656d 0a20 2020 2023 2074 6f20 4e6f 6e65  em.    # to None
+0001a4c0: 2066 6f72 206e 6f77 2077 6865 6e20 706f   for now when po
+0001a4d0: 7373 6962 6c65 2e0a 2020 2020 6b77 6172  ssible..    kwar
+0001a4e0: 6773 203d 204e 6f6e 6520 6966 206e 6f74  gs = None if not
+0001a4f0: 206b 7761 7267 7320 656c 7365 206b 7761   kwargs else kwa
+0001a500: 7267 730a 2020 2020 7265 7369 6475 616c  rgs.    residual
+0001a510: 7320 3d20 2861 7267 732c 206b 7761 7267  s = (args, kwarg
+0001a520: 732c 2073 6176 6564 5f66 6f72 5f62 6163  s, saved_for_bac
+0001a530: 6b77 6172 6429 0a20 2020 2072 6574 7572  kward).    retur
+0001a540: 6e20 564a 5044 7561 6c28 7265 7375 6c74  n VJPDual(result
+0001a550: 2c20 7265 7369 6475 616c 7329 0a0a 0a64  , residuals)...d
+0001a560: 6566 2064 6563 6f6d 706f 7365 645f 666e  ef decomposed_fn
+0001a570: 5f62 6163 6b77 6172 645f 7275 6c65 2864  _backward_rule(d
+0001a580: 6563 6f6d 706f 7365 645f 666e 2c20 6172  ecomposed_fn, ar
+0001a590: 6773 2c20 6b77 6172 6773 2c20 7361 7665  gs, kwargs, save
+0001a5a0: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
+0001a5b0: 2a67 7261 6473 293a 0a20 2020 206b 7761  *grads):.    kwa
+0001a5c0: 7267 7320 3d20 7b7d 2069 6620 6b77 6172  rgs = {} if kwar
+0001a5d0: 6773 2069 7320 4e6f 6e65 2065 6c73 6520  gs is None else 
+0001a5e0: 6b77 6172 6773 0a20 2020 2074 7261 6365  kwargs.    trace
+0001a5f0: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
+0001a600: 6365 2829 2864 6563 6f6d 706f 7365 645f  ce()(decomposed_
+0001a610: 666e 2c20 2a61 7267 732c 202a 2a6b 7761  fn, *args, **kwa
+0001a620: 7267 7329 0a20 2020 2074 7261 6365 203d  rgs).    trace =
+0001a630: 2075 6e77 7261 705f 6f6e 655f 6c65 7665   unwrap_one_leve
+0001a640: 6c5f 6f66 5f73 7562 7379 6d62 6f6c 7328  l_of_subsymbols(
+0001a650: 7472 6163 6529 0a20 2020 2074 7261 6365  trace).    trace
+0001a660: 203d 2064 6365 2874 7261 6365 290a 2020   = dce(trace).  
+0001a670: 2020 2320 626f 756e 645f 7379 6d62 6f6c    # bound_symbol
+0001a680: 7320 3d20 6974 6572 5f62 6f75 6e64 5f73  s = iter_bound_s
+0001a690: 796d 626f 6c73 2874 7261 6365 2e62 6f75  ymbols(trace.bou
+0001a6a0: 6e64 5f73 796d 626f 6c73 290a 2020 2020  nd_symbols).    
+0001a6b0: 2320 7265 636f 6e73 7472 7563 7465 645f  # reconstructed_
+0001a6c0: 656e 7620 3d20 7b0a 2020 2020 2320 2020  env = {.    #   
+0001a6d0: 2020 7365 7175 656e 6369 6679 2873 796d    sequencify(sym
+0001a6e0: 626f 6c2e 6f75 7470 7574 295b 305d 2e6e  bol.output)[0].n
+0001a6f0: 616d 653a 2056 4a50 4475 616c 284e 6f6e  ame: VJPDual(Non
+0001a700: 652c 2073 6176 6564 5f66 6f72 5f62 6163  e, saved_for_bac
+0001a710: 6b77 6172 645b 695d 290a 2020 2020 2320  kward[i]).    # 
+0001a720: 2020 2020 666f 7220 692c 2073 796d 626f      for i, symbo
+0001a730: 6c20 696e 2065 6e75 6d65 7261 7465 2862  l in enumerate(b
+0001a740: 6f75 6e64 5f73 796d 626f 6c73 290a 2020  ound_symbols).  
+0001a750: 2020 2320 7d0a 2020 2020 7265 636f 6e73    # }.    recons
+0001a760: 7472 7563 7465 645f 656e 7620 3d20 7265  tructed_env = re
+0001a770: 636f 6e73 7472 7563 745f 666f 7277 6172  construct_forwar
+0001a780: 645f 656e 765f 666f 725f 6261 636b 7761  d_env_for_backwa
+0001a790: 7264 2874 7261 6365 2c20 7361 7665 645f  rd(trace, saved_
+0001a7a0: 666f 725f 6261 636b 7761 7264 290a 2020  for_backward).  
+0001a7b0: 2020 7265 7375 6c74 203d 2062 6163 6b77    result = backw
+0001a7c0: 6172 645f 7061 7373 2872 6563 6f6e 7374  ard_pass(reconst
+0001a7d0: 7275 6374 6564 5f65 6e76 2c20 7472 6163  ructed_env, trac
+0001a7e0: 652c 2067 7261 6473 290a 2020 2020 6966  e, grads).    if
+0001a7f0: 206c 656e 2861 7267 7329 203d 3d20 313a   len(args) == 1:
+0001a800: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001a810: 7265 7375 6c74 5b30 5d0a 2020 2020 2320  result[0].    # 
+0001a820: 4261 636b 7761 7264 2070 6173 7320 6d69  Backward pass mi
+0001a830: 6768 7420 7265 7475 726e 2061 2064 6963  ght return a dic
+0001a840: 7420 7769 7468 2067 7261 6473 2062 7574  t with grads but
+0001a850: 2063 7572 7265 6e74 2069 6e74 6572 6661   current interfa
+0001a860: 6365 206f 660a 2020 2020 2320 6261 636b  ce of.    # back
+0001a870: 7761 7264 2072 756c 6520 646f 6573 206e  ward rule does n
+0001a880: 6f74 2073 7570 706f 7274 2069 742e 2053  ot support it. S
+0001a890: 6f20 7765 206a 7573 7420 6472 6f70 2069  o we just drop i
+0001a8a0: 7420 666f 7220 6e6f 772e 0a20 2020 2065  t for now..    e
+0001a8b0: 6c69 6620 6973 696e 7374 616e 6365 2872  lif isinstance(r
+0001a8c0: 6573 756c 745b 2d31 5d2c 2064 6963 7429  esult[-1], dict)
+0001a8d0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0001a8e0: 2072 6573 756c 745b 3a2d 315d 0a20 2020   result[:-1].   
+0001a8f0: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
+0001a900: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
+0001a910: 6e74 6564 5f66 6f72 7761 7264 2822 746f  nted_forward("to
+0001a920: 7263 682e 5465 6e73 6f72 2e63 6f6e 7469  rch.Tensor.conti
+0001a930: 6775 6f75 7322 290a 4072 6567 6973 7465  guous").@registe
+0001a940: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
+0001a950: 6172 6428 2274 6f72 6368 2e63 6f6e 7469  ard("torch.conti
+0001a960: 6775 6f75 7322 290a 6465 6620 636f 6e74  guous").def cont
+0001a970: 6967 756f 7573 5f61 7567 5f66 7764 2878  iguous_aug_fwd(x
+0001a980: 3a20 5465 6e73 6f72 5072 6f78 792c 202f  : TensorProxy, /
+0001a990: 2c20 2a2c 206d 656d 6f72 795f 666f 726d  , *, memory_form
+0001a9a0: 6174 3a20 746f 7263 682e 6d65 6d6f 7279  at: torch.memory
+0001a9b0: 5f66 6f72 6d61 7420 3d20 746f 7263 682e  _format = torch.
+0001a9c0: 636f 6e74 6967 756f 7573 5f66 6f72 6d61  contiguous_forma
+0001a9d0: 7429 202d 3e20 564a 5044 7561 6c3a 0a20  t) -> VJPDual:. 
+0001a9e0: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
+0001a9f0: 746f 7263 6820 696d 706f 7274 2063 6f6e  torch import con
+0001aa00: 7469 6775 6f75 730a 0a20 2020 2072 6574  tiguous..    ret
+0001aa10: 7572 6e20 564a 5044 7561 6c28 636f 6e74  urn VJPDual(cont
+0001aa20: 6967 756f 7573 2878 2c20 6d65 6d6f 7279  iguous(x, memory
+0001aa30: 5f66 6f72 6d61 743d 6d65 6d6f 7279 5f66  _format=memory_f
+0001aa40: 6f72 6d61 7429 2c20 7475 706c 6528 2929  ormat), tuple())
+0001aa50: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
+0001aa60: 6b77 6172 6428 2274 6f72 6368 2e54 656e  kward("torch.Ten
+0001aa70: 736f 722e 636f 6e74 6967 756f 7573 2229  sor.contiguous")
+0001aa80: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+0001aa90: 6172 6428 2274 6f72 6368 2e63 6f6e 7469  ard("torch.conti
+0001aaa0: 6775 6f75 7322 290a 6465 6620 636f 6e74  guous").def cont
+0001aab0: 6967 756f 7573 5f62 6163 6b77 6172 6428  iguous_backward(
+0001aac0: 2a72 6573 6964 7561 6c73 5f61 6e64 5f67  *residuals_and_g
+0001aad0: 7261 6429 202d 3e20 5465 6e73 6f72 5072  rad) -> TensorPr
+0001aae0: 6f78 793a 0a20 2020 2023 2052 6573 6964  oxy:.    # Resid
+0001aaf0: 7561 6c73 2069 7320 6e6f 7420 656d 7074  uals is not empt
+0001ab00: 7920 6265 6361 7573 6520 636f 6e74 6967  y because contig
+0001ab10: 756f 7573 2073 796d 626f 6c20 6861 7320  uous symbol has 
+0001ab20: 7468 6520 7361 6d65 206f 7574 7075 7420  the same output 
+0001ab30: 6173 2069 7473 2069 6e70 7574 0a20 2020  as its input.   
+0001ab40: 2067 203d 2072 6573 6964 7561 6c73 5f61   g = residuals_a
+0001ab50: 6e64 5f67 7261 645b 2d31 5d0a 2020 2020  nd_grad[-1].    
+0001ab60: 7265 7475 726e 2067 0a0a 0a64 6566 2072  return g...def r
+0001ab70: 6563 6970 726f 6361 6c5f 6175 675f 6677  eciprocal_aug_fw
+0001ab80: 6428 613a 2054 656e 736f 7250 726f 7879  d(a: TensorProxy
+0001ab90: 2920 2d3e 2056 4a50 4475 616c 3a0a 2020  ) -> VJPDual:.  
+0001aba0: 2020 7072 696d 616c 203d 2072 6563 6970    primal = recip
+0001abb0: 726f 6361 6c28 6129 0a20 2020 2072 6574  rocal(a).    ret
+0001abc0: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
+0001abd0: 616c 2c20 2870 7269 6d61 6c2c 2929 0a0a  al, (primal,))..
+0001abe0: 0a64 6566 2072 6563 6970 726f 6361 6c5f  .def reciprocal_
+0001abf0: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
+0001ac00: 2067 293a 0a20 2020 2072 6574 7572 6e20   g):.    return 
+0001ac10: 2d67 202a 2070 7269 6d61 6c20 2a20 7072  -g * primal * pr
+0001ac20: 696d 616c 0a0a 0a40 7061 7274 6961 6c28  imal...@partial(
+0001ac30: 7265 6769 7374 6572 5f67 7261 642c 2070  register_grad, p
+0001ac40: 7269 6d73 2e50 7269 6d49 4473 2e52 4543  rims.PrimIDs.REC
+0001ac50: 4950 524f 4341 4c29 0a64 6566 2072 6563  IPROCAL).def rec
+0001ac60: 6970 726f 6361 6c5f 6a6f 696e 745f 666f  iprocal_joint_fo
+0001ac70: 7277 6172 645f 6261 636b 7761 7264 5f72  rward_backward_r
+0001ac80: 756c 6528 613a 2054 656e 736f 7250 726f  ule(a: TensorPro
+0001ac90: 7879 2920 2d3e 2054 656e 736f 7250 726f  xy) -> TensorPro
+0001aca0: 7879 3a0a 2020 2020 7265 7375 6c74 2c20  xy:.    result, 
+0001acb0: 7361 7665 6420 3d20 7265 6369 7072 6f63  saved = reciproc
+0001acc0: 616c 5f61 7567 5f66 7764 2861 290a 2020  al_aug_fwd(a).  
+0001acd0: 2020 6720 3d20 6765 745f 6772 6164 2872    g = get_grad(r
+0001ace0: 6573 756c 7429 0a20 2020 2067 6120 3d20  esult).    ga = 
+0001acf0: 7265 6369 7072 6f63 616c 5f62 6163 6b77  reciprocal_backw
+0001ad00: 6172 6428 2a73 6176 6564 2c20 6729 0a20  ard(*saved, g). 
+0001ad10: 2020 2070 7574 5f67 7261 6428 612c 2067     put_grad(a, g
+0001ad20: 6129 0a20 2020 2072 6574 7572 6e20 7265  a).    return re
+0001ad30: 7375 6c74 0a0a 0a40 7265 6769 7374 6572  sult...@register
+0001ad40: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
+0001ad50: 7264 2822 746f 7263 682e 696e 6465 785f  rd("torch.index_
+0001ad60: 7075 7422 290a 6465 6620 696e 6465 785f  put").def index_
+0001ad70: 7075 745f 6175 675f 6677 6428 0a20 2020  put_aug_fwd(.   
+0001ad80: 2061 3a20 5465 6e73 6f72 5072 6f78 792c   a: TensorProxy,
+0001ad90: 202f 2c20 696e 6469 6365 733a 2053 6571   /, indices: Seq
+0001ada0: 7565 6e63 655b 5465 6e73 6f72 5072 6f78  uence[TensorProx
+0001adb0: 795d 2c20 7661 6c75 6573 3a20 5465 6e73  y], values: Tens
+0001adc0: 6f72 5072 6f78 792c 2061 6363 756d 756c  orProxy, accumul
+0001add0: 6174 653a 2062 6f6f 6c20 3d20 4661 6c73  ate: bool = Fals
+0001ade0: 650a 2920 2d3e 2056 4a50 4475 616c 3a0a  e.) -> VJPDual:.
+0001adf0: 2020 2020 7072 696d 616c 203d 2063 6c61      primal = cla
+0001ae00: 6e67 2e69 6e64 6578 5f70 7574 2861 2c20  ng.index_put(a, 
+0001ae10: 696e 6469 6365 732c 2076 616c 7565 732c  indices, values,
+0001ae20: 2061 6363 756d 756c 6174 6529 0a20 2020   accumulate).   
+0001ae30: 2072 6573 6964 7561 6c73 203d 2028 0a20   residuals = (. 
+0001ae40: 2020 2020 2020 2069 6e64 6963 6573 2c0a         indices,.
+0001ae50: 2020 2020 2020 2020 7661 6c75 6573 2c0a          values,.
+0001ae60: 2020 2020 2020 2020 6163 6375 6d75 6c61          accumula
+0001ae70: 7465 2c0a 2020 2020 290a 2020 2020 7265  te,.    ).    re
+0001ae80: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
+0001ae90: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
+0001aea0: 0a0a 6465 6620 7375 6d5f 746f 2861 3a20  ..def sum_to(a: 
+0001aeb0: 5465 6e73 6f72 5072 6f78 792c 2073 6861  TensorProxy, sha
+0001aec0: 7065 3a20 5365 7175 656e 6365 5b69 6e74  pe: Sequence[int
+0001aed0: 5d29 202d 3e20 5465 6e73 6f72 5072 6f78  ]) -> TensorProx
+0001aee0: 793a 0a20 2020 2069 6620 6e6f 7420 7368  y:.    if not sh
+0001aef0: 6170 653a 0a20 2020 2020 2020 2072 6574  ape:.        ret
+0001af00: 7572 6e20 612e 7375 6d28 290a 2020 2020  urn a.sum().    
+0001af10: 6c65 6164 696e 675f 6469 6d73 203d 2061  leading_dims = a
+0001af20: 2e6e 6469 6d20 2d20 6c65 6e28 7368 6170  .ndim - len(shap
+0001af30: 6529 0a20 2020 2072 6564 7563 655f 6469  e).    reduce_di
+0001af40: 6d73 203d 2074 7570 6c65 2872 616e 6765  ms = tuple(range
+0001af50: 286c 6561 6469 6e67 5f64 696d 7329 2920  (leading_dims)) 
+0001af60: 2b20 7475 706c 6528 0a20 2020 2020 2020  + tuple(.       
+0001af70: 2069 2066 6f72 2069 2069 6e20 7261 6e67   i for i in rang
+0001af80: 6528 6c65 6164 696e 675f 6469 6d73 2c20  e(leading_dims, 
+0001af90: 612e 6e64 696d 2920 6966 2073 6861 7065  a.ndim) if shape
+0001afa0: 5b69 202d 206c 6561 6469 6e67 5f64 696d  [i - leading_dim
+0001afb0: 735d 203d 3d20 3120 616e 6420 612e 7368  s] == 1 and a.sh
+0001afc0: 6170 655b 695d 2021 3d20 310a 2020 2020  ape[i] != 1.    
+0001afd0: 290a 2020 2020 6120 3d20 6c74 6f72 6368  ).    a = ltorch
+0001afe0: 2e73 756d 2861 2c20 6469 6d3d 7265 6475  .sum(a, dim=redu
+0001aff0: 6365 5f64 696d 732c 206b 6565 7064 696d  ce_dims, keepdim
+0001b000: 3d54 7275 6529 0a20 2020 2069 6620 6c65  =True).    if le
+0001b010: 6164 696e 675f 6469 6d73 203e 2030 3a0a  ading_dims > 0:.
+0001b020: 2020 2020 2020 2020 7265 7475 726e 206c          return l
+0001b030: 746f 7263 682e 7669 6577 2861 2c20 7368  torch.view(a, sh
+0001b040: 6170 6529 0a20 2020 2072 6574 7572 6e20  ape).    return 
+0001b050: 610a 0a0a 4072 6567 6973 7465 725f 6261  a...@register_ba
+0001b060: 636b 7761 7264 2822 746f 7263 682e 696e  ckward("torch.in
+0001b070: 6465 785f 7075 7422 290a 6465 6620 696e  dex_put").def in
+0001b080: 6465 785f 7075 745f 6261 636b 7761 7264  dex_put_backward
+0001b090: 2869 6e64 6963 6573 3a20 5365 7175 656e  (indices: Sequen
+0001b0a0: 6365 5b54 656e 736f 7250 726f 7879 5d2c  ce[TensorProxy],
+0001b0b0: 2076 616c 7565 733a 2054 656e 736f 7250   values: TensorP
+0001b0c0: 726f 7879 2c20 6163 6375 6d75 6c61 7465  roxy, accumulate
+0001b0d0: 3a20 626f 6f6c 2c20 673a 2054 656e 736f  : bool, g: Tenso
+0001b0e0: 7250 726f 7879 293a 0a20 2020 2067 5f76  rProxy):.    g_v
+0001b0f0: 616c 7565 7320 3d20 675b 696e 6469 6365  alues = g[indice
+0001b100: 735d 0a20 2020 2023 2074 6f72 6368 2068  s].    # torch h
+0001b110: 6173 2065 7874 7261 206c 6f67 6963 2074  as extra logic t
+0001b120: 6f20 6861 6e64 6c65 2074 6865 2065 7870  o handle the exp
+0001b130: 616e 6465 6420 7661 6c75 6573 0a20 2020  anded values.   
+0001b140: 2069 6620 6e6f 7420 7574 696c 732e 7361   if not utils.sa
+0001b150: 6d65 5f73 6861 7065 2867 5f76 616c 7565  me_shape(g_value
+0001b160: 732e 7368 6170 652c 2076 616c 7565 732e  s.shape, values.
+0001b170: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
+0001b180: 6966 2063 6c61 6e67 2e63 6f6d 7075 7465  if clang.compute
+0001b190: 5f62 726f 6164 6361 7374 5f73 6861 7065  _broadcast_shape
+0001b1a0: 2867 5f76 616c 7565 732e 7368 6170 652c  (g_values.shape,
+0001b1b0: 2076 616c 7565 732e 7368 6170 6529 3a0a   values.shape):.
+0001b1c0: 2020 2020 2020 2020 2020 2020 675f 7661              g_va
+0001b1d0: 6c75 6573 203d 2073 756d 5f74 6f28 675f  lues = sum_to(g_
+0001b1e0: 7661 6c75 6573 2c20 7661 6c75 6573 2e73  values, values.s
+0001b1f0: 6861 7065 290a 2020 2020 6966 2061 6363  hape).    if acc
+0001b200: 756d 756c 6174 653a 0a20 2020 2020 2020  umulate:.       
+0001b210: 2072 6574 7572 6e20 672c 2067 5f76 616c   return g, g_val
+0001b220: 7565 730a 2020 2020 7265 7475 726e 2063  ues.    return c
+0001b230: 6c61 6e67 2e69 6e64 6578 5f70 7574 2867  lang.index_put(g
+0001b240: 2c20 696e 6469 6365 732c 206c 746f 7263  , indices, ltorc
+0001b250: 682e 7a65 726f 735f 6c69 6b65 2876 616c  h.zeros_like(val
+0001b260: 7565 7329 2c20 4661 6c73 6529 2c20 675f  ues), False), g_
+0001b270: 7661 6c75 6573 0a0a 0a64 6566 2075 6e69  values...def uni
+0001b280: 666f 726d 5f61 7567 5f66 7764 2873 6861  form_aug_fwd(sha
+0001b290: 7065 2c20 6d69 6e76 616c 2c20 6d61 7876  pe, minval, maxv
+0001b2a0: 616c 2c20 2a2c 2064 6576 6963 652c 2064  al, *, device, d
+0001b2b0: 7479 7065 293a 0a20 2020 2070 7269 6d61  type):.    prima
+0001b2c0: 6c20 3d20 7072 696d 732e 756e 6966 6f72  l = prims.unifor
+0001b2d0: 6d28 7368 6170 652c 206d 696e 7661 6c2c  m(shape, minval,
+0001b2e0: 206d 6178 7661 6c2c 2064 6576 6963 653d   maxval, device=
+0001b2f0: 6465 7669 6365 2c20 6474 7970 653d 6474  device, dtype=dt
+0001b300: 7970 6529 0a20 2020 2072 6574 7572 6e20  ype).    return 
+0001b310: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+0001b320: 2870 7269 6d61 6c2c 206d 696e 7661 6c2c  (primal, minval,
+0001b330: 206d 6178 7661 6c29 290a 0a0a 6465 6620   maxval))...def 
+0001b340: 756e 6966 6f72 6d5f 6261 636b 7761 7264  uniform_backward
+0001b350: 2870 7269 6d61 6c2c 206d 696e 7661 6c2c  (primal, minval,
+0001b360: 206d 6178 7661 6c2c 2067 293a 0a20 2020   maxval, g):.   
+0001b370: 2023 2075 6e69 666f 726d 2069 7320 696d   # uniform is im
+0001b380: 706c 656d 656e 7465 6420 6173 2028 6d61  plemented as (ma
+0001b390: 7876 616c 202d 206d 696e 7661 6c29 202a  xval - minval) *
+0001b3a0: 2075 6e69 666f 726d 2873 6861 7065 2c20   uniform(shape, 
+0001b3b0: 302c 2031 2920 2b20 6d69 6e76 616c 0a20  0, 1) + minval. 
+0001b3c0: 2020 2075 6e73 6361 6c65 645f 7072 696d     unscaled_prim
+0001b3d0: 616c 203d 2028 7072 696d 616c 202d 206d  al = (primal - m
+0001b3e0: 696e 7661 6c29 202f 2028 6d61 7876 616c  inval) / (maxval
+0001b3f0: 202d 206d 696e 7661 6c29 0a20 2020 2072   - minval).    r
+0001b400: 6564 7563 655f 616c 6c5f 6469 6d73 203d  educe_all_dims =
+0001b410: 2074 7570 6c65 2872 616e 6765 2867 2e6e   tuple(range(g.n
+0001b420: 6469 6d29 290a 2020 2020 7375 6d20 3d20  dim)).    sum = 
+0001b430: 7061 7274 6961 6c28 7072 696d 732e 7375  partial(prims.su
+0001b440: 6d2c 2064 696d 733d 7265 6475 6365 5f61  m, dims=reduce_a
+0001b450: 6c6c 5f64 696d 7329 0a20 2020 2072 6574  ll_dims).    ret
+0001b460: 7572 6e20 4e6f 6e65 2c20 7375 6d28 6720  urn None, sum(g 
+0001b470: 2a20 2831 202d 2075 6e73 6361 6c65 645f  * (1 - unscaled_
+0001b480: 7072 696d 616c 2929 2c20 7375 6d28 6720  primal)), sum(g 
+0001b490: 2a20 756e 7363 616c 6564 5f70 7269 6d61  * unscaled_prima
+0001b4a0: 6c29 0a0a 0a6e 6f6e 6469 6666 6572 656e  l)...nondifferen
+0001b4b0: 7469 6162 6c65 5f76 6a70 5f73 796d 626f  tiable_vjp_symbo
+0001b4c0: 6c73 203d 2028 7072 696d 732e 5072 696d  ls = (prims.Prim
+0001b4d0: 4944 732e 4249 5457 4953 455f 414e 442c  IDs.BITWISE_AND,
+0001b4e0: 2070 7269 6d73 2e50 7269 6d49 4473 2e53   prims.PrimIDs.S
+0001b4f0: 4947 4e42 4954 2c20 7072 696d 732e 5072  IGNBIT, prims.Pr
+0001b500: 696d 4944 732e 4655 4c4c 290a 0a0a 6465  imIDs.FULL)...de
+0001b510: 6620 6973 5f63 6f6e 7374 616e 745f 666f  f is_constant_fo
+0001b520: 725f 766a 7028 7379 6d62 6f6c 3a20 7072  r_vjp(symbol: pr
+0001b530: 696d 732e 5379 6d62 6f6c 2920 2d3e 2062  ims.Symbol) -> b
+0001b540: 6f6f 6c3a 0a20 2020 2022 2222 4368 6563  ool:.    """Chec
+0001b550: 6b20 6966 2061 2073 796d 626f 6c20 6973  k if a symbol is
+0001b560: 2063 6f6e 7374 616e 7420 666f 7220 7468   constant for th
+0001b570: 6520 564a 5020 7472 616e 7366 6f72 6d2e  e VJP transform.
+0001b580: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0001b590: 2020 2020 7379 6d62 6f6c 2028 7072 696d      symbol (prim
+0001b5a0: 732e 5379 6d62 6f6c 293a 2053 796d 626f  s.Symbol): Symbo
+0001b5b0: 6c20 746f 2063 6865 636b 2e0a 0a20 2020  l to check...   
+0001b5c0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001b5d0: 2020 626f 6f6c 3a20 5472 7565 2069 6620    bool: True if 
+0001b5e0: 7468 6520 7379 6d62 6f6c 2069 7320 636f  the symbol is co
+0001b5f0: 6e73 7461 6e74 2c20 4661 6c73 6520 6f74  nstant, False ot
+0001b600: 6865 7277 6973 652e 0a20 2020 2022 2222  herwise..    """
+0001b610: 0a20 2020 2061 7265 5f61 6c6c 5f61 7267  .    are_all_arg
+0001b620: 735f 6e6f 6e5f 6469 6666 6572 656e 7469  s_non_differenti
+0001b630: 6162 6c65 203d 206e 6f74 2061 6e79 2869  able = not any(i
+0001b640: 7369 6e73 7461 6e63 6528 6172 672c 2028  sinstance(arg, (
+0001b650: 466c 6f61 7450 726f 7879 2c20 5465 6e73  FloatProxy, Tens
+0001b660: 6f72 5072 6f78 7929 2920 666f 7220 6172  orProxy)) for ar
+0001b670: 6720 696e 2073 796d 626f 6c2e 666c 6174  g in symbol.flat
+0001b680: 5f61 7267 7329 0a20 2020 2072 6574 7572  _args).    retur
+0001b690: 6e20 280a 2020 2020 2020 2020 6172 655f  n (.        are_
+0001b6a0: 616c 6c5f 6172 6773 5f6e 6f6e 5f64 6966  all_args_non_dif
+0001b6b0: 6665 7265 6e74 6961 626c 650a 2020 2020  ferentiable.    
+0001b6c0: 2020 2020 6f72 2073 796d 626f 6c2e 6172      or symbol.ar
+0001b6d0: 655f 616c 6c5f 6172 6773 5f63 6f6e 7374  e_all_args_const
+0001b6e0: 616e 740a 2020 2020 2020 2020 6f72 2073  ant.        or s
+0001b6f0: 796d 626f 6c2e 7379 6d2e 6964 2069 6e20  ymbol.sym.id in 
+0001b700: 6e6f 6e64 6966 6665 7265 6e74 6961 626c  nondifferentiabl
+0001b710: 655f 766a 705f 7379 6d62 6f6c 730a 2020  e_vjp_symbols.  
+0001b720: 2020 290a 0a0a 6465 6620 766a 705f 7379    )...def vjp_sy
+0001b730: 6d62 6f6c 5f6d 6170 7065 7228 7379 6d62  mbol_mapper(symb
+0001b740: 6f6c 3a20 7072 696d 732e 5379 6d62 6f6c  ol: prims.Symbol
+0001b750: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+0001b760: 7329 3a0a 2020 2020 2222 2253 796d 626f  s):.    """Symbo
+0001b770: 6c20 6d61 7070 6572 2066 6f72 2074 6865  l mapper for the
+0001b780: 2056 4a50 2074 7261 6e73 666f 726d 2e0a   VJP transform..
+0001b790: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+0001b7a0: 2020 2073 796d 626f 6c20 2870 7269 6d73     symbol (prims
+0001b7b0: 2e53 796d 626f 6c29 3a20 5379 6d62 6f6c  .Symbol): Symbol
+0001b7c0: 2074 6f20 6265 206d 6170 7065 642e 0a20   to be mapped.. 
+0001b7d0: 2020 2020 2020 2061 7267 7320 2854 7570         args (Tup
+0001b7e0: 6c65 5b56 6172 6961 626c 655d 293a 2041  le[Variable]): A
+0001b7f0: 7267 756d 656e 7473 2074 6f20 7468 6520  rguments to the 
+0001b800: 7379 6d62 6f6c 2e0a 2020 2020 2020 2020  symbol..        
+0001b810: 6b77 6172 6773 2028 4469 6374 5b73 7472  kwargs (Dict[str
+0001b820: 2c20 5661 7269 6162 6c65 5d29 3a20 4b65  , Variable]): Ke
+0001b830: 7977 6f72 6420 6172 6775 6d65 6e74 7320  yword arguments 
+0001b840: 746f 2074 6865 2073 796d 626f 6c2e 0a0a  to the symbol...
+0001b850: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0001b860: 2020 2020 2043 616c 6c61 626c 653a 2041       Callable: A
+0001b870: 2066 756e 6374 696f 6e20 7468 6174 2063   function that c
+0001b880: 6f6d 7075 7465 7320 7468 6520 564a 5020  omputes the VJP 
+0001b890: 6f66 2074 6865 2073 796d 626f 6c2e 0a20  of the symbol.. 
+0001b8a0: 2020 2022 2222 0a20 2020 2023 2043 6f6e     """.    # Con
+0001b8b0: 7374 616e 7420 6361 7365 0a20 2020 2069  stant case.    i
+0001b8c0: 6620 6973 5f63 6f6e 7374 616e 745f 666f  f is_constant_fo
+0001b8d0: 725f 766a 7028 7379 6d62 6f6c 293a 0a0a  r_vjp(symbol):..
+0001b8e0: 2020 2020 2020 2020 6465 6620 766a 705f          def vjp_
+0001b8f0: 696d 706c 5f63 6f6e 7374 2873 796d 626f  impl_const(symbo
+0001b900: 6c2c 202a 6172 6773 2c20 2a2a 6b77 6172  l, *args, **kwar
+0001b910: 6773 293a 0a20 2020 2020 2020 2020 2020  gs):.           
+0001b920: 2061 7267 732c 206b 7761 7267 7320 3d20   args, kwargs = 
+0001b930: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
+0001b940: 783a 2078 2e70 7269 6d61 6c20 6966 2069  x: x.primal if i
+0001b950: 7369 6e73 7461 6e63 6528 782c 2056 4a50  sinstance(x, VJP
+0001b960: 4475 616c 2920 656c 7365 2078 2c20 2861  Dual) else x, (a
+0001b970: 7267 732c 206b 7761 7267 7329 290a 2020  rgs, kwargs)).  
+0001b980: 2020 2020 2020 2020 2020 7072 696d 616c            primal
+0001b990: 7320 3d20 7379 6d62 6f6c 5f74 6f5f 6576  s = symbol_to_ev
+0001b9a0: 616c 2873 796d 626f 6c29 282a 6172 6773  al(symbol)(*args
+0001b9b0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+0001b9c0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0001b9d0: 7461 6e63 6528 7072 696d 616c 732c 2053  tance(primals, S
+0001b9e0: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
+0001b9f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001ba00: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
+0001ba10: 2078 3a20 564a 5044 7561 6c28 782c 2074   x: VJPDual(x, t
+0001ba20: 7570 6c65 2829 292c 2070 7269 6d61 6c73  uple()), primals
+0001ba30: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0001ba40: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
+0001ba50: 6d61 6c73 2c20 7475 706c 6528 2929 0a0a  mals, tuple())..
+0001ba60: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+0001ba70: 6172 7469 616c 2876 6a70 5f69 6d70 6c5f  artial(vjp_impl_
+0001ba80: 636f 6e73 742c 2073 796d 626f 6c29 0a0a  const, symbol)..
+0001ba90: 2020 2020 2320 4e6f 726d 616c 2063 6173      # Normal cas
+0001baa0: 652c 2077 6520 6861 7665 2061 2070 726f  e, we have a pro
+0001bab0: 7879 2074 616e 6765 6e74 0a20 2020 2076  xy tangent.    v
+0001bac0: 6a70 5f69 6d70 6c20 3d20 6175 676d 656e  jp_impl = augmen
+0001bad0: 7465 645f 666f 7277 6172 645f 696d 706c  ted_forward_impl
+0001bae0: 732e 6765 7428 7379 6d62 6f6c 2e73 796d  s.get(symbol.sym
+0001baf0: 2e69 6429 0a0a 2020 2020 6966 205f 6765  .id)..    if _ge
+0001bb00: 745f 6772 6164 666e 2873 796d 626f 6c29  t_gradfn(symbol)
+0001bb10: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0001bb20: 2020 2020 2020 766a 705f 696d 706c 2c20        vjp_impl, 
+0001bb30: 6261 636b 7761 7264 5f66 6e20 3d20 6d61  backward_fn = ma
+0001bb40: 6b65 5f61 7567 5f66 6f72 7761 7264 5f61  ke_aug_forward_a
+0001bb50: 6e64 5f62 6163 6b77 6172 6428 7379 6d62  nd_backward(symb
+0001bb60: 6f6c 290a 0a20 2020 2069 6620 766a 705f  ol)..    if vjp_
+0001bb70: 696d 706c 2069 7320 4e6f 6e65 3a0a 2020  impl is None:.  
+0001bb80: 2020 2020 2020 2320 5765 2063 6f75 6c64        # We could
+0001bb90: 206e 6f74 2066 696e 6420 6120 564a 5020   not find a VJP 
+0001bba0: 666f 7220 7468 6973 2073 796d 626f 6c2c  for this symbol,
+0001bbb0: 2073 6f20 7765 2074 7279 2074 6f20 6465   so we try to de
+0001bbc0: 636f 6d70 6f73 6520 6974 0a20 2020 2020  compose it.     
+0001bbd0: 2020 2069 6620 6c65 6e28 7379 6d62 6f6c     if len(symbol
+0001bbe0: 2e73 7562 7379 6d62 6f6c 7329 203e 2030  .subsymbols) > 0
+0001bbf0: 2061 6e64 206e 6f74 2069 7369 6e73 7461   and not isinsta
+0001bc00: 6e63 6528 7379 6d62 6f6c 2e73 796d 2e69  nce(symbol.sym.i
+0001bc10: 642c 2070 7269 6d73 2e50 7269 6d49 4473  d, prims.PrimIDs
+0001bc20: 293a 0a20 2020 2020 2020 2020 2020 2076  ):.            v
+0001bc30: 6a70 5f69 6d70 6c20 3d20 7061 7274 6961  jp_impl = partia
+0001bc40: 6c28 6465 636f 6d70 6f73 6564 5f66 6e5f  l(decomposed_fn_
+0001bc50: 6175 675f 6677 645f 7275 6c65 2c20 6465  aug_fwd_rule, de
+0001bc60: 636f 6d70 6f73 6564 5f66 6e3d 7379 6d62  composed_fn=symb
+0001bc70: 6f6c 2e73 796d 290a 2020 2020 2020 2020  ol.sym).        
+0001bc80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001bc90: 2020 2320 5765 2063 6f75 6c64 206e 6f74    # We could not
+0001bca0: 2066 696e 6420 6120 564a 5020 666f 7220   find a VJP for 
+0001bcb0: 7468 6973 2073 796d 626f 6c20 616e 6420  this symbol and 
+0001bcc0: 7765 2063 6f75 6c64 206e 6f74 2064 6563  we could not dec
+0001bcd0: 6f6d 706f 7365 2069 740a 2020 2020 2020  ompose it.      
+0001bce0: 2020 2020 2020 2320 4974 2063 6f75 6c64        # It could
+0001bcf0: 2062 6520 6120 746f 7263 682e 6472 6f70   be a torch.drop
+0001bd00: 6f75 7420 7769 7468 2030 2e30 2070 726f  out with 0.0 pro
+0001bd10: 6261 6269 6c69 7479 2c20 736f 2077 6520  bability, so we 
+0001bd20: 736b 6970 2069 740a 2020 2020 2020 2020  skip it.        
+0001bd30: 2020 2020 6966 2073 796d 626f 6c2e 7379      if symbol.sy
+0001bd40: 6d2e 6964 203d 3d20 2274 6f72 6368 2e6e  m.id == "torch.n
+0001bd50: 6e2e 6675 6e63 7469 6f6e 616c 2e64 726f  n.functional.dro
+0001bd60: 706f 7574 223a 0a20 2020 2020 2020 2020  pout":.         
+0001bd70: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+0001bd80: 6e65 0a20 2020 2020 2020 2020 2020 2070  ne.            p
+0001bd90: 7269 6e74 2866 2256 4a50 2066 6f72 207b  rint(f"VJP for {
+0001bda0: 7379 6d62 6f6c 7d20 6973 206e 6f74 2069  symbol} is not i
+0001bdb0: 6d70 6c65 6d65 6e74 6564 2229 0a20 2020  mplemented").   
+0001bdc0: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
+0001bdd0: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
+0001bde0: 6f72 2866 2256 4a50 2066 6f72 207b 7379  or(f"VJP for {sy
+0001bdf0: 6d62 6f6c 2e73 796d 2e69 647d 2069 7320  mbol.sym.id} is 
+0001be00: 6e6f 7420 696d 706c 656d 656e 7465 6422  not implemented"
+0001be10: 290a 0a20 2020 2064 6566 205f 766a 705f  )..    def _vjp_
+0001be20: 696d 706c 282a 6172 6773 2c20 2a2a 6b77  impl(*args, **kw
+0001be30: 6172 6773 293a 0a20 2020 2020 2020 2070  args):.        p
+0001be40: 7269 6d61 6c73 2c20 6b77 6172 6773 203d  rimals, kwargs =
+0001be50: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
+0001be60: 2078 3a20 782e 7072 696d 616c 2069 6620   x: x.primal if 
+0001be70: 6973 696e 7374 616e 6365 2878 2c20 564a  isinstance(x, VJ
+0001be80: 5044 7561 6c29 2065 6c73 6520 782c 2028  PDual) else x, (
+0001be90: 6172 6773 2c20 6b77 6172 6773 2929 0a20  args, kwargs)). 
+0001bea0: 2020 2020 2020 206f 7574 5f70 7269 6d61         out_prima
+0001beb0: 6c2c 206f 7574 5f72 6573 6964 7561 6c73  l, out_residuals
+0001bec0: 203d 2076 6a70 5f69 6d70 6c28 2a70 7269   = vjp_impl(*pri
+0001bed0: 6d61 6c73 2c20 2a2a 6b77 6172 6773 290a  mals, **kwargs).
+0001bee0: 0a20 2020 2020 2020 2023 2057 6520 6172  .        # We ar
+0001bef0: 6520 7361 7669 6e67 2074 6865 2072 6573  e saving the res
+0001bf00: 6964 7561 6c73 2061 6e64 2070 756c 6c62  iduals and pullb
+0001bf10: 6163 6b20 6f6e 6c79 2069 6e20 7468 6520  ack only in the 
+0001bf20: 6669 7273 7420 6f75 7470 7574 0a20 2020  first output.   
+0001bf30: 2020 2020 2023 2062 6163 6b77 6172 645f       # backward_
+0001bf40: 7061 7373 2074 6865 6e20 7265 7472 6965  pass then retrie
+0001bf50: 7665 7320 7468 6520 7265 7369 6475 616c  ves the residual
+0001bf60: 7320 616e 6420 7075 6c6c 6261 636b 2066  s and pullback f
+0001bf70: 726f 6d20 7468 6520 6669 7273 7420 6f75  rom the first ou
+0001bf80: 7470 7574 0a20 2020 2020 2020 2069 6620  tput.        if 
+0001bf90: 6973 696e 7374 616e 6365 286f 7574 5f70  isinstance(out_p
+0001bfa0: 7269 6d61 6c2c 2053 6571 7565 6e63 6529  rimal, Sequence)
+0001bfb0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0001bfc0: 7475 726e 2028 564a 5044 7561 6c28 6f75  turn (VJPDual(ou
+0001bfd0: 745f 7072 696d 616c 5b30 5d2c 206f 7574  t_primal[0], out
+0001bfe0: 5f72 6573 6964 7561 6c73 292c 202a 2856  _residuals), *(V
+0001bff0: 4a50 4475 616c 286f 2c20 7475 706c 6528  JPDual(o, tuple(
+0001c000: 2929 2066 6f72 206f 2069 6e20 6f75 745f  )) for o in out_
+0001c010: 7072 696d 616c 5b31 3a5d 2929 0a0a 2020  primal[1:]))..  
+0001c020: 2020 2020 2020 7265 7475 726e 2028 564a        return (VJ
+0001c030: 5044 7561 6c28 6f75 745f 7072 696d 616c  PDual(out_primal
+0001c040: 2c20 6f75 745f 7265 7369 6475 616c 7329  , out_residuals)
+0001c050: 2c29 0a0a 2020 2020 7265 7475 726e 205f  ,)..    return _
+0001c060: 766a 705f 696d 706c 0a0a 0a64 6566 2063  vjp_impl...def c
+0001c070: 6865 636b 5f62 7379 6d5f 666f 725f 766a  heck_bsym_for_vj
+0001c080: 7028 6273 796d 293a 0a20 2020 2022 2222  p(bsym):.    """
+0001c090: 0a20 2020 2043 6865 636b 2069 6620 6120  .    Check if a 
+0001c0a0: 626f 756e 6420 7379 6d62 6f6c 2069 7320  bound symbol is 
+0001c0b0: 7375 7070 6f72 7465 6420 6279 2076 6a70  supported by vjp
+0001c0c0: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+0001c0d0: 2020 2020 2062 7379 6d20 2842 6f75 6e64       bsym (Bound
+0001c0e0: 5379 6d62 6f6c 293a 2054 6865 2062 6f75  Symbol): The bou
+0001c0f0: 6e64 2073 796d 626f 6c20 746f 2063 6865  nd symbol to che
+0001c100: 636b 2e0a 0a20 2020 2052 6574 7572 6e73  ck...    Returns
+0001c110: 3a0a 2020 2020 2020 2020 626f 6f6c 3a20  :.        bool: 
+0001c120: 5472 7565 2069 6620 7468 6520 626f 756e  True if the boun
+0001c130: 6420 7379 6d62 6f6c 2069 7320 7375 7070  d symbol is supp
+0001c140: 6f72 7465 6420 6279 2076 6a70 2c20 4661  orted by vjp, Fa
+0001c150: 6c73 6520 6f74 6865 7277 6973 652e 0a20  lse otherwise.. 
+0001c160: 2020 2022 2222 0a0a 2020 2020 6966 2062     """..    if b
+0001c170: 7379 6d2e 7379 6d2e 6964 2069 6e20 7472  sym.sym.id in tr
+0001c180: 616e 7366 6f72 6d5f 736b 6970 5f6c 6973  ansform_skip_lis
+0001c190: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
+0001c1a0: 6e20 5472 7565 0a0a 2020 2020 6966 2062  n True..    if b
+0001c1b0: 7379 6d2e 7379 6d2e 6964 2069 6e20 6261  sym.sym.id in ba
+0001c1c0: 636b 7761 7264 5f69 6d70 6c73 2061 6e64  ckward_impls and
+0001c1d0: 2062 7379 6d2e 7379 6d2e 6964 2069 6e20   bsym.sym.id in 
+0001c1e0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+0001c1f0: 645f 696d 706c 733a 0a20 2020 2020 2020  d_impls:.       
+0001c200: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
+0001c210: 2020 6966 2062 7379 6d2e 7379 6d2e 6964    if bsym.sym.id
+0001c220: 2069 6e20 5f67 7261 645f 666e 5f6d 6170   in _grad_fn_map
+0001c230: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0001c240: 2054 7275 650a 0a20 2020 2023 2057 6520   True..    # We 
+0001c250: 636f 756c 6420 6e6f 7420 6669 6e64 2061  could not find a
+0001c260: 2056 4a50 2066 6f72 2074 6869 7320 7379   VJP for this sy
+0001c270: 6d62 6f6c 2c20 736f 2077 6520 7472 7920  mbol, so we try 
+0001c280: 746f 2064 6563 6f6d 706f 7365 2069 740a  to decompose it.
+0001c290: 2020 2020 2320 696e 746f 2073 7562 2d73      # into sub-s
+0001c2a0: 796d 626f 6c73 2061 6e64 2063 6865 636b  ymbols and check
+0001c2b0: 2069 6620 7468 6579 2061 7265 2073 7570   if they are sup
+0001c2c0: 706f 7274 6564 0a20 2020 2069 6620 6c65  ported.    if le
+0001c2d0: 6e28 6273 796d 2e73 7562 7379 6d62 6f6c  n(bsym.subsymbol
+0001c2e0: 7329 203e 2030 2061 6e64 206e 6f74 2062  s) > 0 and not b
+0001c2f0: 7379 6d2e 7379 6d2e 6973 5f70 7269 6d3a  sym.sym.is_prim:
+0001c300: 0a20 2020 2020 2020 2073 7562 7472 6163  .        subtrac
+0001c310: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
+0001c320: 6163 6528 2928 6273 796d 2e73 796d 2c20  ace()(bsym.sym, 
+0001c330: 2a62 7379 6d2e 6172 6773 2c20 2a2a 6273  *bsym.args, **bs
+0001c340: 796d 2e6b 7761 7267 7329 0a20 2020 2020  ym.kwargs).     
+0001c350: 2020 2073 7562 7472 6163 6520 3d20 756e     subtrace = un
+0001c360: 7772 6170 5f6f 6e65 5f6c 6576 656c 5f6f  wrap_one_level_o
+0001c370: 665f 7375 6273 796d 626f 6c73 2873 7562  f_subsymbols(sub
+0001c380: 7472 6163 6529 0a20 2020 2020 2020 2061  trace).        a
+0001c390: 6c6c 5f73 7570 706f 7274 6564 203d 2061  ll_supported = a
+0001c3a0: 6c6c 2863 6865 636b 5f62 7379 6d5f 666f  ll(check_bsym_fo
+0001c3b0: 725f 766a 7028 7375 6262 7379 6d29 2066  r_vjp(subbsym) f
+0001c3c0: 6f72 2073 7562 6273 796d 2069 6e20 7375  or subbsym in su
+0001c3d0: 6274 7261 6365 2e62 6f75 6e64 5f73 796d  btrace.bound_sym
+0001c3e0: 626f 6c73 290a 2020 2020 2020 2020 7265  bols).        re
+0001c3f0: 7475 726e 2061 6c6c 5f73 7570 706f 7274  turn all_support
+0001c400: 6564 0a0a 2020 2020 7265 7475 726e 2046  ed..    return F
+0001c410: 616c 7365 0a0a 0a64 6566 2061 7567 6d65  alse...def augme
+0001c420: 6e74 6564 5f66 6f72 7761 7264 5f70 6173  nted_forward_pas
+0001c430: 7328 2a61 7267 732c 2074 7261 6365 3a20  s(*args, trace: 
+0001c440: 5472 6163 652c 202a 2a6b 7761 7267 7329  Trace, **kwargs)
+0001c450: 3a0a 2020 2020 2222 2241 7567 6d65 6e74  :.    """Augment
+0001c460: 6564 2066 6f72 7761 7264 2070 6173 7320  ed forward pass 
+0001c470: 666f 7220 7468 6520 564a 5020 7472 616e  for the VJP tran
+0001c480: 7366 6f72 6d2e 0a0a 2020 2020 5468 6520  sform...    The 
+0001c490: 6175 676d 656e 7465 6420 666f 7277 6172  augmented forwar
+0001c4a0: 6420 7061 7373 2069 7320 6120 666f 7277  d pass is a forw
+0001c4b0: 6172 6420 7061 7373 2074 6861 7420 7265  ard pass that re
+0001c4c0: 7475 726e 7320 7468 6520 7265 7369 6475  turns the residu
+0001c4d0: 616c 730a 2020 2020 6f66 2074 6865 2066  als.    of the f
+0001c4e0: 6f72 7761 7264 2070 6173 732e 0a20 2020  orward pass..   
+0001c4f0: 2054 6865 7365 2072 6573 6964 7561 6c73   These residuals
+0001c500: 2061 7265 2075 7365 6420 696e 2074 6865   are used in the
+0001c510: 2062 6163 6b77 6172 6420 7061 7373 2074   backward pass t
+0001c520: 6f20 636f 6d70 7574 6520 7468 6520 564a  o compute the VJ
+0001c530: 5020 616e 6420 7468 6579 0a20 2020 2061  P and they.    a
+0001c540: 7265 2072 6563 6f72 6465 6420 696e 2074  re recorded in t
+0001c550: 6865 2065 6e76 6972 6f6e 6d65 6e74 2064  he environment d
+0001c560: 6963 7469 6f6e 6172 7920 666f 7220 6561  ictionary for ea
+0001c570: 6368 2076 6172 6961 626c 652e 0a0a 2020  ch variable...  
+0001c580: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0001c590: 6172 6773 2028 5475 706c 655b 5661 7269  args (Tuple[Vari
+0001c5a0: 6162 6c65 5d29 3a20 4172 6775 6d65 6e74  able]): Argument
+0001c5b0: 7320 746f 2074 6865 2066 756e 6374 696f  s to the functio
+0001c5c0: 6e2e 0a20 2020 2020 2020 2074 7261 6365  n..        trace
+0001c5d0: 2028 5472 6163 6529 3a20 5472 6163 6520   (Trace): Trace 
+0001c5e0: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
+0001c5f0: 0a20 2020 2020 2020 206b 7761 7267 7320  .        kwargs 
+0001c600: 2844 6963 745b 7374 722c 2056 6172 6961  (Dict[str, Varia
+0001c610: 626c 655d 293a 204b 6579 776f 7264 2061  ble]): Keyword a
+0001c620: 7267 756d 656e 7473 2074 6f20 7468 6520  rguments to the 
+0001c630: 6675 6e63 7469 6f6e 2e0a 0a20 2020 2052  function...    R
+0001c640: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0001c650: 5475 706c 655b 416e 792c 2044 6963 745b  Tuple[Any, Dict[
+0001c660: 7374 722c 2041 6e79 5d5d 3a20 5475 706c  str, Any]]: Tupl
+0001c670: 6520 6f66 2074 6865 2070 7269 6d61 6c20  e of the primal 
+0001c680: 6f75 7470 7574 7320 616e 6420 7468 6520  outputs and the 
+0001c690: 656e 7669 726f 6e6d 656e 742e 0a20 2020  environment..   
+0001c6a0: 2022 2222 0a20 2020 2061 7267 732c 206b   """.    args, k
+0001c6b0: 7761 7267 7320 3d20 7472 6565 5f6d 6170  wargs = tree_map
+0001c6c0: 286c 616d 6264 6120 783a 2056 4a50 4475  (lambda x: VJPDu
+0001c6d0: 616c 2878 2c20 7475 706c 6528 2929 2c20  al(x, tuple()), 
+0001c6e0: 2861 7267 732c 206b 7761 7267 7329 290a  (args, kwargs)).
+0001c6f0: 2020 2020 7265 7375 6c74 2c20 656e 7620      result, env 
+0001c700: 3d20 6576 616c 5f74 7261 6365 280a 2020  = eval_trace(.  
+0001c710: 2020 2020 2020 7472 6163 652c 0a20 2020        trace,.   
+0001c720: 2020 2020 202a 6172 6773 2c0a 2020 2020       *args,.    
+0001c730: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+0001c740: 2020 2020 2020 7769 7468 5f65 6e76 3d54        with_env=T
+0001c750: 7275 652c 0a20 2020 2020 2020 2073 796d  rue,.        sym
+0001c760: 626f 6c5f 6d61 7070 6572 3d76 6a70 5f73  bol_mapper=vjp_s
+0001c770: 796d 626f 6c5f 6d61 7070 6572 2c0a 2020  ymbol_mapper,.  
+0001c780: 2020 290a 2020 2020 7265 7375 6c74 203d    ).    result =
+0001c790: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
+0001c7a0: 2078 3a20 782e 7072 696d 616c 2069 6620   x: x.primal if 
+0001c7b0: 6973 696e 7374 616e 6365 2878 2c20 564a  isinstance(x, VJ
+0001c7c0: 5044 7561 6c29 2065 6c73 6520 782c 2072  PDual) else x, r
+0001c7d0: 6573 756c 7429 0a20 2020 2072 6574 7572  esult).    retur
+0001c7e0: 6e20 7265 7375 6c74 2c20 656e 760a 0a0a  n result, env...
+0001c7f0: 2320 544f 444f 3a20 496e 7374 6561 6420  # TODO: Instead 
+0001c800: 6f66 2075 7369 6e67 2074 6865 2065 6e76  of using the env
+0001c810: 6972 6f6e 6d65 6e74 2064 6963 7469 6f6e  ironment diction
+0001c820: 6172 792c 2077 6520 636f 756c 6420 7573  ary, we could us
+0001c830: 6520 7468 6520 7472 6163 650a 2320 7379  e the trace.# sy
+0001c840: 6d62 6f6c 7320 6f72 6465 7220 2874 6861  mbols order (tha
+0001c850: 7420 7368 6f75 6c64 2062 6520 6465 7465  t should be dete
+0001c860: 726d 696e 6973 7469 6329 2074 6f20 7265  rministic) to re
+0001c870: 7472 6965 7665 2074 6865 2072 6573 6964  trieve the resid
+0001c880: 7561 6c73 206e 6565 6465 640a 2320 666f  uals needed.# fo
+0001c890: 7220 7468 6520 6261 636b 7761 7264 2070  r the backward p
+0001c8a0: 6173 732e 0a64 6566 2062 6163 6b77 6172  ass..def backwar
+0001c8b0: 645f 7061 7373 2866 6f72 7761 7264 5f65  d_pass(forward_e
+0001c8c0: 6e76 2c20 7472 6163 652c 2069 6e69 745f  nv, trace, init_
+0001c8d0: 636f 7461 6e67 656e 7473 293a 0a20 2020  cotangents):.   
+0001c8e0: 2022 2222 4261 636b 7761 7264 2070 6173   """Backward pas
+0001c8f0: 7320 666f 7220 7468 6520 564a 5020 7472  s for the VJP tr
+0001c900: 616e 7366 6f72 6d2e 0a0a 2020 2020 5468  ansform...    Th
+0001c910: 6520 6261 636b 7761 7264 2070 6173 7320  e backward pass 
+0001c920: 6973 2061 2072 6576 6572 7365 206d 6f64  is a reverse mod
+0001c930: 6520 6175 746f 6d61 7469 6320 6469 6666  e automatic diff
+0001c940: 6572 656e 7469 6174 696f 6e20 7061 7373  erentiation pass
+0001c950: 2074 6861 740a 2020 2020 636f 6d70 7574   that.    comput
+0001c960: 6573 2074 6865 2076 6563 746f 722d 4a61  es the vector-Ja
+0001c970: 636f 6269 616e 2070 726f 6475 6374 2028  cobian product (
+0001c980: 564a 5029 206f 6620 7468 6520 6675 6e63  VJP) of the func
+0001c990: 7469 6f6e 2e0a 0a20 2020 2041 7267 733a  tion...    Args:
+0001c9a0: 0a20 2020 2020 2020 2066 6f72 7761 7264  .        forward
+0001c9b0: 5f65 6e76 2028 4469 6374 5b73 7472 2c20  _env (Dict[str, 
+0001c9c0: 416e 795d 293a 2045 6e76 6972 6f6e 6d65  Any]): Environme
+0001c9d0: 6e74 206f 6620 7468 6520 666f 7277 6172  nt of the forwar
+0001c9e0: 6420 7061 7373 2e0a 2020 2020 2020 2020  d pass..        
+0001c9f0: 7472 6163 6520 2854 7261 6365 293a 2054  trace (Trace): T
+0001ca00: 7261 6365 206f 6620 7468 6520 6675 6e63  race of the func
+0001ca10: 7469 6f6e 2e0a 2020 2020 2020 2020 696e  tion..        in
+0001ca20: 6974 5f63 6f74 616e 6765 6e74 7320 2854  it_cotangents (T
+0001ca30: 7570 6c65 5b56 6172 6961 626c 655d 293a  uple[Variable]):
+0001ca40: 2049 6e69 7469 616c 2063 6f74 616e 6765   Initial cotange
+0001ca50: 6e74 732e 0a0a 2020 2020 5265 7475 726e  nts...    Return
+0001ca60: 733a 0a20 2020 2020 2020 2054 7570 6c65  s:.        Tuple
+0001ca70: 5b50 726f 7879 2c20 2e2e 2e5d 3a20 5475  [Proxy, ...]: Tu
+0001ca80: 706c 6520 6f66 2074 6865 2072 6573 756c  ple of the resul
+0001ca90: 7473 206f 6620 7468 6520 6261 636b 7761  ts of the backwa
+0001caa0: 7264 2070 6173 7320 666f 7220 6561 6368  rd pass for each
+0001cab0: 2069 6e70 7574 2e0a 2020 2020 2222 220a   input..    """.
+0001cac0: 2020 2020 656e 7620 3d20 7b7d 0a0a 2020      env = {}..  
+0001cad0: 2020 6465 6620 6765 745f 6772 6164 2878    def get_grad(x
+0001cae0: 3a20 5661 7269 6162 6c65 293a 0a20 2020  : Variable):.   
+0001caf0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0001cb00: 6365 2878 2c20 5661 7269 6162 6c65 293a  ce(x, Variable):
+0001cb10: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
+0001cb20: 6574 7572 6e20 4e6f 6e65 2069 6620 7468  eturn None if th
+0001cb30: 6520 7661 7269 6162 6c65 2077 6173 206e  e variable was n
+0001cb40: 6f74 2075 7365 6420 696e 2074 6865 2063  ot used in the c
+0001cb50: 6f6d 7075 7461 7469 6f6e 2061 6e64 0a20  omputation and. 
+0001cb60: 2020 2020 2020 2020 2020 2023 2068 656e             # hen
+0001cb70: 6365 206e 6f74 2069 6e20 7468 6520 656e  ce not in the en
+0001cb80: 760a 2020 2020 2020 2020 2020 2020 7265  v.            re
+0001cb90: 7475 726e 2065 6e76 2e67 6574 2878 2e6e  turn env.get(x.n
+0001cba0: 616d 652c 204e 6f6e 6529 0a20 2020 2020  ame, None).     
+0001cbb0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001cbc0: 2020 2020 2072 6574 7572 6e20 780a 0a20       return x.. 
+0001cbd0: 2020 2064 6566 2070 7574 5f67 7261 6428     def put_grad(
+0001cbe0: 763a 2056 6172 6961 626c 652c 2076 616c  v: Variable, val
+0001cbf0: 3a20 416e 7929 202d 3e20 4e6f 6e65 3a0a  : Any) -> None:.
+0001cc00: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0001cc10: 7461 6e63 6528 762c 2056 6172 6961 626c  tance(v, Variabl
+0001cc20: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0001cc30: 6966 2076 2e6e 616d 6520 696e 2065 6e76  if v.name in env
+0001cc40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001cc50: 2020 6966 2076 616c 2069 7320 4e6f 6e65    if val is None
+0001cc60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001cc70: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0001cc80: 2020 2020 2020 2020 2020 2020 2023 2041               # A
+0001cc90: 6363 756d 756c 6174 6520 636f 7461 6e67  ccumulate cotang
+0001cca0: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
+0001ccb0: 2020 2020 2065 6e76 5b76 2e6e 616d 655d       env[v.name]
+0001ccc0: 203d 2063 6c61 6e67 2e61 6464 2865 6e76   = clang.add(env
+0001ccd0: 5b76 2e6e 616d 655d 2c20 7661 6c29 2069  [v.name], val) i
+0001cce0: 6620 656e 765b 762e 6e61 6d65 5d20 6973  f env[v.name] is
+0001ccf0: 206e 6f74 204e 6f6e 6520 656c 7365 2076   not None else v
+0001cd00: 616c 0a20 2020 2020 2020 2020 2020 2020  al.             
+0001cd10: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+0001cd20: 2020 2020 2020 656e 765b 762e 6e61 6d65        env[v.name
+0001cd30: 5d20 3d20 7661 6c0a 2020 2020 2020 2020  ] = val.        
+0001cd40: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+0001cd50: 762c 2053 6571 7565 6e63 6529 2061 6e64  v, Sequence) and
+0001cd60: 2061 6c6c 2869 7369 6e73 7461 6e63 6528   all(isinstance(
+0001cd70: 782c 2069 6e74 2920 666f 7220 7820 696e  x, int) for x in
+0001cd80: 2076 293a 0a20 2020 2020 2020 2020 2020   v):.           
+0001cd90: 2023 2054 4f44 4f3a 2072 656d 6f76 6520   # TODO: remove 
+0001cda0: 7768 656e 2077 6520 6d6f 7665 2064 696d  when we move dim
+0001cdb0: 7320 746f 206b 7761 7267 730a 2020 2020  s to kwargs.    
+0001cdc0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+0001cdd0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+0001cde0: 616e 6365 2876 2c20 7374 7229 3a0a 2020  ance(v, str):.  
+0001cdf0: 2020 2020 2020 2020 2020 656e 765b 765d            env[v]
+0001ce00: 203d 2076 616c 0a20 2020 2020 2020 2065   = val.        e
+0001ce10: 6c69 6620 6973 696e 7374 616e 6365 2876  lif isinstance(v
+0001ce20: 2c20 5365 7175 656e 6365 2920 616e 6420  , Sequence) and 
+0001ce30: 7661 6c20 6973 204e 6f6e 653a 0a20 2020  val is None:.   
+0001ce40: 2020 2020 2020 2020 2023 2062 726f 6164           # broad
+0001ce50: 6361 7374 204e 6f6e 6520 746f 2074 6865  cast None to the
+0001ce60: 2072 6967 6874 2073 6861 7065 0a20 2020   right shape.   
+0001ce70: 2020 2020 2020 2020 2073 6166 655f 6d61           safe_ma
+0001ce80: 7028 7075 745f 6772 6164 2c20 762c 205b  p(put_grad, v, [
+0001ce90: 4e6f 6e65 5d20 2a20 6c65 6e28 7629 290a  None] * len(v)).
+0001cea0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+0001ceb0: 6e73 7461 6e63 6528 762c 2053 6571 7565  nstance(v, Seque
+0001cec0: 6e63 6529 2061 6e64 2069 7369 6e73 7461  nce) and isinsta
+0001ced0: 6e63 6528 7661 6c2c 2053 6571 7565 6e63  nce(val, Sequenc
+0001cee0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0001cef0: 7361 6665 5f6d 6170 5f66 6c61 7428 7075  safe_map_flat(pu
+0001cf00: 745f 6772 6164 2c20 762c 2076 616c 290a  t_grad, v, val).
+0001cf10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001cf20: 2020 2020 2020 2020 2020 2320 536b 6970            # Skip
+0001cf30: 2077 7269 7469 6e67 2074 6f20 636f 6e73   writing to cons
+0001cf40: 7461 6e74 730a 2020 2020 2020 2020 2020  tants.          
+0001cf50: 2020 7061 7373 0a0a 2020 2020 6966 2069    pass..    if i
+0001cf60: 7369 6e73 7461 6e63 6528 696e 6974 5f63  sinstance(init_c
+0001cf70: 6f74 616e 6765 6e74 732c 2053 6571 7565  otangents, Seque
+0001cf80: 6e63 6529 2061 6e64 206c 656e 2869 6e69  nce) and len(ini
+0001cf90: 745f 636f 7461 6e67 656e 7473 2920 3d3d  t_cotangents) ==
+0001cfa0: 2031 2061 6e64 206e 6f74 2069 7369 6e73   1 and not isins
+0001cfb0: 7461 6e63 6528 7472 6163 652e 6f75 7470  tance(trace.outp
+0001cfc0: 7574 2c20 5365 7175 656e 6365 293a 0a20  ut, Sequence):. 
+0001cfd0: 2020 2020 2020 2069 6e69 745f 636f 7461         init_cota
+0001cfe0: 6e67 656e 7473 203d 2069 6e69 745f 636f  ngents = init_co
+0001cff0: 7461 6e67 656e 7473 5b30 5d0a 2020 2020  tangents[0].    
+0001d000: 7361 6665 5f6d 6170 5f66 6c61 7428 7075  safe_map_flat(pu
+0001d010: 745f 6772 6164 2c20 7472 6163 652e 6f75  t_grad, trace.ou
+0001d020: 7470 7574 2c20 696e 6974 5f63 6f74 616e  tput, init_cotan
+0001d030: 6765 6e74 7329 0a0a 2020 2020 666f 7220  gents)..    for 
+0001d040: 7379 6d62 6f6c 2069 6e20 7265 7665 7273  symbol in revers
+0001d050: 6564 2874 7261 6365 2e62 6f75 6e64 5f73  ed(trace.bound_s
+0001d060: 796d 626f 6c73 293a 0a20 2020 2020 2020  ymbols):.       
+0001d070: 2069 6620 7379 6d62 6f6c 2e73 796d 2e69   if symbol.sym.i
+0001d080: 6420 696e 2074 7261 6e73 666f 726d 5f73  d in transform_s
+0001d090: 6b69 705f 6c69 7374 3a0a 2020 2020 2020  kip_list:.      
+0001d0a0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+0001d0b0: 2020 2020 2020 2073 796d 626f 6c5f 6f75         symbol_ou
+0001d0c0: 7470 7574 203d 2073 6571 7565 6e63 6966  tput = sequencif
+0001d0d0: 7928 7379 6d62 6f6c 2e6f 7574 7075 7429  y(symbol.output)
+0001d0e0: 0a0a 2020 2020 2020 2020 636f 7461 6e67  ..        cotang
+0001d0f0: 656e 7473 203d 2074 7265 655f 6d61 7028  ents = tree_map(
+0001d100: 6765 745f 6772 6164 2c20 7379 6d62 6f6c  get_grad, symbol
+0001d110: 5f6f 7574 7075 7429 0a20 2020 2020 2020  _output).       
+0001d120: 2023 2048 6176 696e 6720 6120 7369 6e67   # Having a sing
+0001d130: 6c65 2063 6f74 616e 6765 6e74 2069 7320  le cotangent is 
+0001d140: 6120 636f 6d6d 6f6e 2063 6173 652c 2073  a common case, s
+0001d150: 6f20 7765 2066 6c61 7474 656e 2069 740a  o we flatten it.
+0001d160: 2020 2020 2020 2020 2320 4f74 6865 7277          # Otherw
+0001d170: 6973 652c 2077 6520 7769 6c6c 206e 6565  ise, we will nee
+0001d180: 6420 746f 2072 6577 7269 7465 2074 6865  d to rewrite the
+0001d190: 2070 756c 6c62 6163 6b20 6675 6e63 7469   pullback functi
+0001d1a0: 6f6e 730a 2020 2020 2020 2020 636f 7461  ons.        cota
+0001d1b0: 6e67 656e 7473 203d 2074 7265 655f 666c  ngents = tree_fl
+0001d1c0: 6174 7465 6e28 636f 7461 6e67 656e 7473  atten(cotangents
+0001d1d0: 295b 305d 0a20 2020 2020 2020 2072 6573  )[0].        res
+0001d1e0: 6964 7561 6c73 203d 2066 6f72 7761 7264  iduals = forward
+0001d1f0: 5f65 6e76 5b73 796d 626f 6c5f 6f75 7470  _env[symbol_outp
+0001d200: 7574 5b30 5d2e 6e61 6d65 5d2e 7265 7369  ut[0].name].resi
+0001d210: 6475 616c 730a 2020 2020 2020 2020 6966  duals.        if
+0001d220: 2069 735f 636f 6e73 7461 6e74 5f66 6f72   is_constant_for
+0001d230: 5f76 6a70 2873 796d 626f 6c29 3a0a 2020  _vjp(symbol):.  
+0001d240: 2020 2020 2020 2020 2020 2320 5765 2063            # We c
+0001d250: 616e 2073 6b69 7020 7468 6520 7075 6c6c  an skip the pull
+0001d260: 6261 636b 2069 6620 616c 6c20 7468 6520  back if all the 
+0001d270: 6172 6775 6d65 6e74 7320 6172 6520 636f  arguments are co
+0001d280: 6e73 7461 6e74 0a20 2020 2020 2020 2020  nstant.         
+0001d290: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+0001d2a0: 2020 2020 2069 6620 616c 6c28 636f 7461       if all(cota
+0001d2b0: 6e67 656e 7420 6973 204e 6f6e 6520 666f  ngent is None fo
+0001d2c0: 7220 636f 7461 6e67 656e 7420 696e 2063  r cotangent in c
+0001d2d0: 6f74 616e 6765 6e74 7329 3a0a 2020 2020  otangents):.    
+0001d2e0: 2020 2020 2020 2020 2320 5765 2063 616e          # We can
+0001d2f0: 2073 6b69 7020 7468 6520 7075 6c6c 6261   skip the pullba
+0001d300: 636b 2069 6620 7468 6520 636f 7461 6e67  ck if the cotang
+0001d310: 656e 7420 6973 204e 6f6e 650a 2020 2020  ent is None.    
+0001d320: 2020 2020 2020 2020 7361 6665 5f6d 6170          safe_map
+0001d330: 2870 7574 5f67 7261 642c 2073 796d 626f  (put_grad, symbo
+0001d340: 6c2e 6172 6773 2c20 284e 6f6e 652c 2920  l.args, (None,) 
+0001d350: 2a20 6c65 6e28 7379 6d62 6f6c 2e61 7267  * len(symbol.arg
+0001d360: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+0001d370: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+0001d380: 2020 6966 2073 796d 626f 6c2e 7379 6d2e    if symbol.sym.
+0001d390: 6964 203d 3d20 2274 6f72 6368 2e6e 6e2e  id == "torch.nn.
+0001d3a0: 6675 6e63 7469 6f6e 616c 2e64 726f 706f  functional.dropo
+0001d3b0: 7574 2220 616e 6420 6e6f 7420 7379 6d62  ut" and not symb
+0001d3c0: 6f6c 2e73 7562 7379 6d62 6f6c 733a 0a20  ol.subsymbols:. 
+0001d3d0: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
+0001d3e0: 6361 6e20 736b 6970 2074 6865 2070 756c  can skip the pul
+0001d3f0: 6c62 6163 6b20 6966 2074 6865 2064 726f  lback if the dro
+0001d400: 706f 7574 2070 726f 6261 6269 6c69 7479  pout probability
+0001d410: 2069 7320 302e 300a 2020 2020 2020 2020   is 0.0.        
+0001d420: 2020 2020 2320 4173 7375 6d69 6e67 2074      # Assuming t
+0001d430: 6861 7420 7468 6520 6472 6f70 6f75 7420  hat the dropout 
+0001d440: 7379 6d62 6f6c 2068 6173 2074 6865 2073  symbol has the s
+0001d450: 616d 6520 6f75 7470 7574 2061 6e64 2061  ame output and a
+0001d460: 7267 756d 656e 740a 2020 2020 2020 2020  rgument.        
+0001d470: 2020 2020 6173 7365 7274 2073 796d 626f      assert symbo
+0001d480: 6c2e 6f75 7470 7574 2e6e 616d 6520 3d3d  l.output.name ==
+0001d490: 2073 796d 626f 6c2e 6172 6773 5b30 5d2e   symbol.args[0].
+0001d4a0: 6e61 6d65 2c20 2244 726f 706f 7574 2073  name, "Dropout s
+0001d4b0: 796d 626f 6c20 6861 7320 6120 6469 6666  ymbol has a diff
+0001d4c0: 6572 656e 7420 6f75 7470 7574 2061 6e64  erent output and
+0001d4d0: 2061 7267 756d 656e 7422 0a20 2020 2020   argument".     
+0001d4e0: 2020 2020 2020 2069 6620 7379 6d62 6f6c         if symbol
+0001d4f0: 2e61 7267 735b 315d 203d 3d20 302e 3020  .args[1] == 0.0 
+0001d500: 6f72 2073 796d 626f 6c2e 6172 6773 5b32  or symbol.args[2
+0001d510: 5d20 6973 2046 616c 7365 3a0a 2020 2020  ] is False:.    
+0001d520: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0001d530: 696e 7565 0a0a 2020 2020 2020 2020 6261  inue..        ba
+0001d540: 636b 7761 7264 203d 2062 6163 6b77 6172  ckward = backwar
+0001d550: 645f 696d 706c 732e 6765 7428 7379 6d62  d_impls.get(symb
+0001d560: 6f6c 2e73 796d 2e69 6429 0a20 2020 2020  ol.sym.id).     
+0001d570: 2020 2061 7567 5f66 6f72 7761 7264 203d     aug_forward =
+0001d580: 2061 7567 6d65 6e74 6564 5f66 6f72 7761   augmented_forwa
+0001d590: 7264 5f69 6d70 6c73 2e67 6574 2873 796d  rd_impls.get(sym
+0001d5a0: 626f 6c2e 7379 6d2e 6964 290a 0a20 2020  bol.sym.id)..   
+0001d5b0: 2020 2020 2069 6620 5f67 6574 5f67 7261       if _get_gra
+0001d5c0: 6466 6e28 7379 6d62 6f6c 2920 6973 206e  dfn(symbol) is n
+0001d5d0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0001d5e0: 2020 2020 2061 7567 5f66 6f72 7761 7264       aug_forward
+0001d5f0: 2c20 6261 636b 7761 7264 203d 206d 616b  , backward = mak
+0001d600: 655f 6175 675f 666f 7277 6172 645f 616e  e_aug_forward_an
+0001d610: 645f 6261 636b 7761 7264 2873 796d 626f  d_backward(symbo
+0001d620: 6c29 0a0a 2020 2020 2020 2020 6966 2062  l)..        if b
+0001d630: 6163 6b77 6172 6420 6973 204e 6f6e 653a  ackward is None:
+0001d640: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001d650: 6c65 6e28 7379 6d62 6f6c 2e73 7562 7379  len(symbol.subsy
+0001d660: 6d62 6f6c 7329 203e 2030 2061 6e64 206e  mbols) > 0 and n
+0001d670: 6f74 2069 7369 6e73 7461 6e63 6528 7379  ot isinstance(sy
+0001d680: 6d62 6f6c 2e73 796d 2e69 642c 2070 7269  mbol.sym.id, pri
+0001d690: 6d73 2e50 7269 6d49 4473 293a 0a20 2020  ms.PrimIDs):.   
+0001d6a0: 2020 2020 2020 2020 2020 2020 2023 2057               # W
+0001d6b0: 6520 636f 756c 6420 6e6f 7420 6669 6e64  e could not find
+0001d6c0: 2061 2062 6163 6b77 6172 6420 666f 7220   a backward for 
+0001d6d0: 7468 6973 2073 796d 626f 6c2c 2073 6f20  this symbol, so 
+0001d6e0: 7765 2074 7279 2074 6f20 6465 636f 6d70  we try to decomp
+0001d6f0: 6f73 6520 6974 0a20 2020 2020 2020 2020  ose it.         
+0001d700: 2020 2020 2020 2062 6163 6b77 6172 6420         backward 
+0001d710: 3d20 7061 7274 6961 6c28 6465 636f 6d70  = partial(decomp
+0001d720: 6f73 6564 5f66 6e5f 6261 636b 7761 7264  osed_fn_backward
+0001d730: 5f72 756c 652c 2073 796d 626f 6c2e 7379  _rule, symbol.sy
+0001d740: 6d29 0a20 2020 2020 2020 2020 2020 2065  m).            e
+0001d750: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001d760: 2020 2020 2023 2057 6520 636f 756c 6420       # We could 
+0001d770: 6e6f 7420 6669 6e64 2061 2062 6163 6b77  not find a backw
+0001d780: 6172 6420 666f 7220 7468 6973 2073 796d  ard for this sym
+0001d790: 626f 6c20 616e 6420 7765 2063 6f75 6c64  bol and we could
+0001d7a0: 206e 6f74 2064 6563 6f6d 706f 7365 2069   not decompose i
+0001d7b0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+0001d7c0: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
+0001d7d0: 6d65 6e74 6564 4572 726f 7228 6622 4261  mentedError(f"Ba
+0001d7e0: 636b 7761 7264 2066 6f72 207b 7379 6d62  ckward for {symb
+0001d7f0: 6f6c 2e73 796d 2e69 647d 2069 7320 6e6f  ol.sym.id} is no
+0001d800: 7420 696d 706c 656d 656e 7465 6422 290a  t implemented").
+0001d810: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
+0001d820: 3d20 6261 636b 7761 7264 282a 7265 7369  = backward(*resi
+0001d830: 6475 616c 732c 202a 636f 7461 6e67 656e  duals, *cotangen
+0001d840: 7473 290a 2020 2020 2020 2020 6966 2069  ts).        if i
+0001d850: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
+0001d860: 2c20 6469 6374 293a 0a20 2020 2020 2020  , dict):.       
+0001d870: 2020 2020 2023 2049 6620 7468 6520 6261       # If the ba
+0001d880: 636b 7761 7264 2072 6574 7572 6e73 2061  ckward returns a
+0001d890: 2064 6963 742c 2077 6520 6173 7375 6d65   dict, we assume
+0001d8a0: 2074 6861 7420 6974 2069 7320 6120 6469   that it is a di
+0001d8b0: 6374 206f 660a 2020 2020 2020 2020 2020  ct of.          
+0001d8c0: 2020 2320 666f 7277 6172 6420 6172 6775    # forward argu
+0001d8d0: 6d65 6e74 7320 746f 2074 6865 2063 6f72  ments to the cor
+0001d8e0: 7265 7370 6f6e 6469 6e67 0a20 2020 2020  responding.     
+0001d8f0: 2020 2020 2020 2023 2067 7261 6469 656e         # gradien
+0001d900: 7473 2f63 6f74 616e 6765 6e74 732f 6164  ts/cotangents/ad
+0001d910: 6a6f 696e 7473 2f73 656e 7369 7469 7669  joints/sensitivi
+0001d920: 7469 6573 2e0a 2020 2020 2020 2020 2020  ties..          
+0001d930: 2020 7573 6564 5f6e 616d 6573 203d 2073    used_names = s
+0001d940: 6574 2829 0a20 2020 2020 2020 2020 2020  et().           
+0001d950: 2066 6f72 2069 2c20 286b 2c20 7629 2069   for i, (k, v) i
+0001d960: 6e20 656e 756d 6572 6174 6528 696e 7370  n enumerate(insp
+0001d970: 6563 742e 7369 676e 6174 7572 6528 6175  ect.signature(au
+0001d980: 675f 666f 7277 6172 6429 2e70 6172 616d  g_forward).param
+0001d990: 6574 6572 732e 6974 656d 7328 2929 3a0a  eters.items()):.
+0001d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d9b0: 6966 2076 2e6b 696e 6420 696e 2028 696e  if v.kind in (in
+0001d9c0: 7370 6563 742e 5061 7261 6d65 7465 722e  spect.Parameter.
+0001d9d0: 504f 5349 5449 4f4e 414c 5f4f 4e4c 592c  POSITIONAL_ONLY,
+0001d9e0: 2069 6e73 7065 6374 2e50 6172 616d 6574   inspect.Paramet
+0001d9f0: 6572 2e50 4f53 4954 494f 4e41 4c5f 4f52  er.POSITIONAL_OR
+0001da00: 5f4b 4559 574f 5244 293a 0a20 2020 2020  _KEYWORD):.     
+0001da10: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0001da20: 7574 5f67 7261 6428 7379 6d62 6f6c 2e61  ut_grad(symbol.a
+0001da30: 7267 735b 695d 2c20 7265 7375 6c74 2e67  rgs[i], result.g
+0001da40: 6574 286b 2c20 4e6f 6e65 2929 0a20 2020  et(k, None)).   
+0001da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da60: 2075 7365 645f 6e61 6d65 732e 6164 6428   used_names.add(
+0001da70: 6b29 0a0a 2020 2020 2020 2020 2020 2020  k)..            
+0001da80: 2320 466f 7220 6465 7665 6c6f 7065 7220  # For developer 
+0001da90: 636f 6e76 656e 6965 6e63 652c 2077 6520  convenience, we 
+0001daa0: 616c 6c6f 7720 7573 696e 6720 7468 6520  allow using the 
+0001dab0: 6e61 6d65 2066 726f 6d20 7468 650a 2020  name from the.  
+0001dac0: 2020 2020 2020 2020 2020 2320 666f 7277            # forw
+0001dad0: 6172 6420 6d65 7461 2069 6e20 6164 6469  ard meta in addi
+0001dae0: 7469 6f6e 2074 6f20 7468 6520 6e61 6d65  tion to the name
+0001daf0: 2066 726f 6d20 7468 6520 6175 676d 656e   from the augmen
+0001db00: 7465 6420 666f 7277 6172 640a 2020 2020  ted forward.    
+0001db10: 2020 2020 2020 2020 2320 7369 676e 6174          # signat
+0001db20: 7572 652e 0a20 2020 2020 2020 2020 2020  ure..           
+0001db30: 2023 2049 6620 626f 7468 206e 616d 6573   # If both names
+0001db40: 2061 7265 2075 7365 642c 2074 6865 206f   are used, the o
+0001db50: 6e65 2066 726f 6d20 7468 6520 666f 7277  ne from the forw
+0001db60: 6172 6420 6d65 7461 2074 616b 6573 0a20  ard meta takes. 
+0001db70: 2020 2020 2020 2020 2020 2023 2070 7265             # pre
+0001db80: 6365 6465 6e63 652e 0a20 2020 2020 2020  cedence..       
+0001db90: 2020 2020 2066 6f72 2069 2c20 286b 2c20       for i, (k, 
+0001dba0: 7629 2069 6e20 656e 756d 6572 6174 6528  v) in enumerate(
+0001dbb0: 696e 7370 6563 742e 7369 676e 6174 7572  inspect.signatur
+0001dbc0: 6528 7379 6d62 6f6c 2e73 796d 2e6d 6574  e(symbol.sym.met
+0001dbd0: 6129 2e70 6172 616d 6574 6572 732e 6974  a).parameters.it
+0001dbe0: 656d 7328 2929 3a0a 2020 2020 2020 2020  ems()):.        
+0001dbf0: 2020 2020 2020 2020 6966 2076 2e6b 696e          if v.kin
+0001dc00: 6420 696e 2028 696e 7370 6563 742e 5061  d in (inspect.Pa
+0001dc10: 7261 6d65 7465 722e 504f 5349 5449 4f4e  rameter.POSITION
+0001dc20: 414c 5f4f 4e4c 592c 2069 6e73 7065 6374  AL_ONLY, inspect
+0001dc30: 2e50 6172 616d 6574 6572 2e50 4f53 4954  .Parameter.POSIT
+0001dc40: 494f 4e41 4c5f 4f52 5f4b 4559 574f 5244  IONAL_OR_KEYWORD
+0001dc50: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001dc60: 2020 2020 2020 2069 6620 6b20 6e6f 7420         if k not 
+0001dc70: 696e 2075 7365 645f 6e61 6d65 733a 0a20  in used_names:. 
+0001dc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc90: 2020 2020 2020 2070 7574 5f67 7261 6428         put_grad(
+0001dca0: 7379 6d62 6f6c 2e61 7267 735b 695d 2c20  symbol.args[i], 
+0001dcb0: 7265 7375 6c74 2e67 6574 286b 2c20 4e6f  result.get(k, No
+0001dcc0: 6e65 2929 0a20 2020 2020 2020 2020 2020  ne)).           
+0001dcd0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0001dce0: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+0001dcf0: 616e 6365 2872 6573 756c 742c 2053 6571  ance(result, Seq
+0001dd00: 7565 6e63 6529 3a0a 2020 2020 2020 2020  uence):.        
+0001dd10: 2020 2020 7265 7375 6c74 203d 2028 7265      result = (re
+0001dd20: 7375 6c74 2c29 0a0a 2020 2020 2020 2020  sult,)..        
+0001dd30: 6465 6620 6973 5f64 6966 6665 7265 6e74  def is_different
+0001dd40: 6961 626c 6528 6172 6729 3a0a 2020 2020  iable(arg):.    
+0001dd50: 2020 2020 2020 2020 6d61 7463 6820 6172          match ar
+0001dd60: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+0001dd70: 2020 2063 6173 6520 5465 6e73 6f72 5072     case TensorPr
+0001dd80: 6f78 7928 293a 0a20 2020 2020 2020 2020  oxy():.         
+0001dd90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001dda0: 6e20 6474 7970 6573 2e69 735f 696e 6578  n dtypes.is_inex
+0001ddb0: 6163 745f 6474 7970 6528 6172 672e 6474  act_dtype(arg.dt
+0001ddc0: 7970 6529 0a20 2020 2020 2020 2020 2020  ype).           
+0001ddd0: 2020 2020 2063 6173 6520 5365 7175 656e       case Sequen
+0001dde0: 6365 2829 3a0a 2020 2020 2020 2020 2020  ce():.          
+0001ddf0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001de00: 2061 7267 2061 6e64 2061 6c6c 2869 7369   arg and all(isi
+0001de10: 6e73 7461 6e63 6528 782c 2054 656e 736f  nstance(x, Tenso
+0001de20: 7250 726f 7879 2920 616e 6420 6474 7970  rProxy) and dtyp
+0001de30: 6573 2e69 735f 696e 6578 6163 745f 6474  es.is_inexact_dt
+0001de40: 7970 6528 782e 6474 7970 6529 2066 6f72  ype(x.dtype) for
+0001de50: 2078 2069 6e20 6172 6729 0a20 2020 2020   x in arg).     
+0001de60: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+0001de70: 5f3a 0a20 2020 2020 2020 2020 2020 2020  _:.             
+0001de80: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
+0001de90: 6c73 650a 0a20 2020 2020 2020 2069 6620  lse..        if 
+0001dea0: 6c65 6e28 7379 6d62 6f6c 2e61 7267 7329  len(symbol.args)
+0001deb0: 2021 3d20 286f 7269 675f 7265 735f 6c65   != (orig_res_le
+0001dec0: 6e20 3a3d 206c 656e 2872 6573 756c 7429  n := len(result)
+0001ded0: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
+0001dee0: 6865 636b 280a 2020 2020 2020 2020 2020  heck(.          
+0001def0: 2020 2020 2020 6f72 6967 5f72 6573 5f6c        orig_res_l
+0001df00: 656e 203c 3d20 6c65 6e28 7379 6d62 6f6c  en <= len(symbol
+0001df10: 2e61 7267 7329 2c0a 2020 2020 2020 2020  .args),.        
+0001df20: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+0001df30: 6622 4261 636b 7761 7264 2066 6f72 207b  f"Backward for {
+0001df40: 7379 6d62 6f6c 2e73 796d 2e69 647d 2072  symbol.sym.id} r
+0001df50: 6574 7572 6e65 6420 7b6f 7269 675f 7265  eturned {orig_re
+0001df60: 735f 6c65 6e7d 2076 616c 7565 732c 2022  s_len} values, "
+0001df70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001df80: 202b 2066 2262 7574 2065 7870 6563 7465   + f"but expecte
+0001df90: 6420 6174 206d 6f73 7420 7b6c 656e 2873  d at most {len(s
+0001dfa0: 796d 626f 6c2e 6172 6773 297d 222c 0a20  ymbol.args)}",. 
+0001dfb0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0001dfc0: 2020 2020 2020 2020 2023 2041 7373 756d           # Assum
+0001dfd0: 696e 6720 7468 6174 2074 6865 206e 6f6e  ing that the non
+0001dfe0: 2d64 6966 6665 7265 6e74 6961 626c 6520  -differentiable 
+0001dff0: 6172 6775 6d65 6e74 7320 7765 7265 2064  arguments were d
+0001e000: 726f 7070 6564 2066 726f 6d0a 2020 2020  ropped from.    
+0001e010: 2020 2020 2020 2020 2320 7468 6520 6261          # the ba
+0001e020: 636b 7761 7264 2066 756e 6374 696f 6e2c  ckward function,
+0001e030: 2077 6520 6172 6520 676f 696e 6720 746f   we are going to
+0001e040: 2061 7070 656e 6420 4e6f 6e65 2074 6f20   append None to 
+0001e050: 7468 6520 7265 7375 6c74 0a20 2020 2020  the result.     
+0001e060: 2020 2020 2020 2023 2074 6f20 6d61 7463         # to matc
+0001e070: 6820 7468 6520 6e75 6d62 6572 206f 6620  h the number of 
+0001e080: 6172 6775 6d65 6e74 732e 2041 6c74 6572  arguments. Alter
+0001e090: 6e61 7469 7665 6c79 2c20 7765 2063 6f75  natively, we cou
+0001e0a0: 6c64 206a 7573 740a 2020 2020 2020 2020  ld just.        
+0001e0b0: 2020 2020 2320 6861 7665 2061 2066 6f72      # have a for
+0001e0c0: 2d6c 6f6f 7020 7769 7468 2061 2063 6f6e  -loop with a con
+0001e0d0: 6469 7469 6f6e 616c 2077 6865 6e20 7772  ditional when wr
+0001e0e0: 6974 696e 6720 746f 2074 6865 0a20 2020  iting to the.   
+0001e0f0: 2020 2020 2020 2020 2023 2065 6e76 6972           # envir
+0001e100: 6f6e 6d65 6e74 2e0a 0a20 2020 2020 2020  onment...       
+0001e110: 2020 2020 2069 7465 725f 7265 7375 6c74       iter_result
+0001e120: 203d 2069 7465 7228 7265 7375 6c74 290a   = iter(result).
+0001e130: 2020 2020 2020 2020 2020 2020 6e5f 6469              n_di
+0001e140: 6666 6572 656e 7469 6162 6c65 5f61 7267  fferentiable_arg
+0001e150: 7320 3d20 7375 6d28 626f 6f6c 2869 735f  s = sum(bool(is_
+0001e160: 6469 6666 6572 656e 7469 6162 6c65 2861  differentiable(a
+0001e170: 7267 2929 2066 6f72 2061 7267 2069 6e20  rg)) for arg in 
+0001e180: 7379 6d62 6f6c 2e61 7267 7329 0a20 2020  symbol.args).   
+0001e190: 2020 2020 2020 2020 2063 6865 636b 280a           check(.
+0001e1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e1b0: 6e5f 6469 6666 6572 656e 7469 6162 6c65  n_differentiable
+0001e1c0: 5f61 7267 7320 3c3d 206f 7269 675f 7265  _args <= orig_re
+0001e1d0: 735f 6c65 6e2c 0a20 2020 2020 2020 2020  s_len,.         
+0001e1e0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
+0001e1f0: 2242 6163 6b77 6172 6420 666f 7220 7b73  "Backward for {s
+0001e200: 796d 626f 6c2e 7379 6d2e 6964 7d20 7265  ymbol.sym.id} re
+0001e210: 7475 726e 6564 207b 6f72 6967 5f72 6573  turned {orig_res
+0001e220: 5f6c 656e 7d20 7661 6c75 6528 7329 2c20  _len} value(s), 
+0001e230: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001e240: 2020 2b20 6622 6275 7420 6578 7065 6374    + f"but expect
+0001e250: 6564 207b 6e5f 6469 6666 6572 656e 7469  ed {n_differenti
+0001e260: 6162 6c65 5f61 7267 737d 222c 0a20 2020  able_args}",.   
+0001e270: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0001e280: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+0001e290: 2074 7570 6c65 286e 6578 7428 6974 6572   tuple(next(iter
+0001e2a0: 5f72 6573 756c 7429 2069 6620 6973 5f64  _result) if is_d
+0001e2b0: 6966 6665 7265 6e74 6961 626c 6528 6172  ifferentiable(ar
+0001e2c0: 6729 2065 6c73 6520 4e6f 6e65 2066 6f72  g) else None for
+0001e2d0: 2061 7267 2069 6e20 7379 6d62 6f6c 2e61   arg in symbol.a
+0001e2e0: 7267 7329 0a0a 2020 2020 2020 2020 2320  rgs)..        # 
+0001e2f0: 5365 6520 2242 6163 6b77 6172 6420 696d  See "Backward im
+0001e300: 706c 2066 6f72 206f 7073 206f 6620 7468  pl for ops of th
+0001e310: 6520 7479 7065 2053 6571 7565 6e63 655b  e type Sequence[
+0001e320: 5465 6e73 6f72 5072 6f78 795d 2c20 2e2e  TensorProxy], ..
+0001e330: 2e20 2d3e 202e 2e2e 2072 6573 756c 7473  . -> ... results
+0001e340: 2069 6e20 4e6f 6e65 2067 7261 6473 2e22   in None grads."
+0001e350: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
+0001e360: 6973 2061 2074 656d 706f 7261 7279 2077  is a temporary w
+0001e370: 6f72 6b61 726f 756e 642e 0a20 2020 2020  orkaround..     
+0001e380: 2020 2069 6620 7379 6d62 6f6c 2e73 796d     if symbol.sym
+0001e390: 2e69 6420 696e 2028 7072 696d 732e 5072  .id in (prims.Pr
+0001e3a0: 696d 4944 732e 4341 542c 2022 746f 7263  imIDs.CAT, "torc
+0001e3b0: 682e 6361 7422 2c20 2274 6f72 6368 2e73  h.cat", "torch.s
+0001e3c0: 7461 636b 2229 3a0a 2020 2020 2020 2020  tack"):.        
+0001e3d0: 2020 2020 7361 6665 5f6d 6170 5f66 6c61      safe_map_fla
+0001e3e0: 7428 7075 745f 6772 6164 2c20 7379 6d62  t(put_grad, symb
+0001e3f0: 6f6c 2e61 7267 732c 2072 6573 756c 7429  ol.args, result)
+0001e400: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001e410: 2020 2020 2020 2020 2020 2073 6166 655f             safe_
+0001e420: 6d61 7028 7075 745f 6772 6164 2c20 7379  map(put_grad, sy
+0001e430: 6d62 6f6c 2e61 7267 732c 2072 6573 756c  mbol.args, resul
+0001e440: 7429 0a0a 2020 2020 6465 6620 6765 745f  t)..    def get_
+0001e450: 696e 6578 6163 745f 6474 7970 655f 6f72  inexact_dtype_or
+0001e460: 5f6e 6f6e 6528 7829 3a0a 2020 2020 2020  _none(x):.      
+0001e470: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0001e480: 782c 2028 5465 6e73 6f72 5072 6f78 792c  x, (TensorProxy,
+0001e490: 2046 7574 7572 6554 656e 736f 7250 726f   FutureTensorPro
+0001e4a0: 7879 2929 2061 6e64 2064 7479 7065 732e  xy)) and dtypes.
+0001e4b0: 6973 5f69 6e65 7861 6374 5f64 7479 7065  is_inexact_dtype
+0001e4c0: 2878 2e64 7479 7065 293a 0a20 2020 2020  (x.dtype):.     
+0001e4d0: 2020 2020 2020 2072 6574 7572 6e20 780a         return x.
+0001e4e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001e4f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001e500: 204e 6f6e 650a 0a20 2020 2067 6172 6773   None..    gargs
+0001e510: 203d 2074 7265 655f 6d61 7028 6765 745f   = tree_map(get_
+0001e520: 6772 6164 2c20 7475 706c 6528 7472 6163  grad, tuple(trac
+0001e530: 652e 6172 6773 2929 0a20 2020 2067 6b77  e.args)).    gkw
+0001e540: 6172 6773 203d 2074 7265 655f 6d61 7028  args = tree_map(
+0001e550: 6765 745f 6772 6164 2c20 7472 6163 652e  get_grad, trace.
+0001e560: 6b77 6172 6773 290a 2020 2020 676b 7761  kwargs).    gkwa
+0001e570: 7267 7320 3d20 7b6b 3a20 7620 666f 7220  rgs = {k: v for 
+0001e580: 6b2c 2076 2069 6e20 676b 7761 7267 732e  k, v in gkwargs.
+0001e590: 6974 656d 7328 2920 6966 2076 2069 7320  items() if v is 
+0001e5a0: 6e6f 7420 4e6f 6e65 7d0a 2020 2020 6761  not None}.    ga
+0001e5b0: 7267 732c 2067 6b77 6172 6773 203d 2074  rgs, gkwargs = t
+0001e5c0: 7265 655f 6d61 7028 6765 745f 696e 6578  ree_map(get_inex
+0001e5d0: 6163 745f 6474 7970 655f 6f72 5f6e 6f6e  act_dtype_or_non
+0001e5e0: 652c 2028 6761 7267 732c 2067 6b77 6172  e, (gargs, gkwar
+0001e5f0: 6773 2929 0a20 2020 2072 6574 7572 6e20  gs)).    return 
+0001e600: 6761 7267 7320 2b20 2867 6b77 6172 6773  gargs + (gkwargs
+0001e610: 2c29 2069 6620 6c65 6e28 676b 7761 7267  ,) if len(gkwarg
+0001e620: 7329 2021 3d20 3020 656c 7365 2067 6172  s) != 0 else gar
+0001e630: 6773 0a0a 0a64 6566 2076 6a70 5f63 616c  gs...def vjp_cal
+0001e640: 6c5f 6d65 7461 6675 6e63 2864 6574 6163  l_metafunc(detac
+0001e650: 6865 643a 2062 6f6f 6c2c 2070 7269 6d61  hed: bool, prima
+0001e660: 6c73 2c20 636f 7461 6e67 656e 7473 2c20  ls, cotangents, 
+0001e670: 7472 6163 653a 2054 7261 6365 2c20 2a2a  trace: Trace, **
+0001e680: 6b77 6172 6773 293a 0a20 2020 2023 2041  kwargs):.    # A
+0001e690: 7373 756d 696e 6720 7072 696d 616c 7320  ssuming primals 
+0001e6a0: 6973 2066 6c61 740a 0a20 2020 2069 6620  is flat..    if 
+0001e6b0: 6e6f 7420 6973 696e 7374 616e 6365 2870  not isinstance(p
+0001e6c0: 7269 6d61 6c73 2c20 5365 7175 656e 6365  rimals, Sequence
+0001e6d0: 293a 0a20 2020 2020 2020 2070 7269 6d61  ):.        prima
+0001e6e0: 6c73 203d 2028 7072 696d 616c 732c 290a  ls = (primals,).
+0001e6f0: 0a20 2020 2063 7478 203d 2064 6574 6163  .    ctx = detac
+0001e700: 6865 645f 7472 6163 6528 2920 6966 2064  hed_trace() if d
+0001e710: 6574 6163 6865 6420 656c 7365 206e 756c  etached else nul
+0001e720: 6c63 6f6e 7465 7874 2829 0a20 2020 2077  lcontext().    w
+0001e730: 6974 6820 6374 783a 0a20 2020 2020 2020  ith ctx:.       
+0001e740: 2072 6573 756c 742c 2065 6e76 203d 2061   result, env = a
+0001e750: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+0001e760: 5f70 6173 7328 2a70 7269 6d61 6c73 2c20  _pass(*primals, 
+0001e770: 7472 6163 653d 7472 6163 652c 202a 2a6b  trace=trace, **k
+0001e780: 7761 7267 7329 0a20 2020 2020 2020 2063  wargs).        c
+0001e790: 6865 636b 280a 2020 2020 2020 2020 2020  heck(.          
+0001e7a0: 2020 6c65 6e28 7265 7375 6c74 2920 3d3d    len(result) ==
+0001e7b0: 206c 656e 2863 6f74 616e 6765 6e74 7329   len(cotangents)
+0001e7c0: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
+0001e7d0: 6573 756c 742c 2053 6571 7565 6e63 6529  esult, Sequence)
+0001e7e0: 2065 6c73 6520 5472 7565 2c0a 2020 2020   else True,.    
+0001e7f0: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+0001e800: 6622 4578 7065 6374 6564 2063 6f74 616e  f"Expected cotan
+0001e810: 6765 6e74 7320 746f 2062 6520 6120 7365  gents to be a se
+0001e820: 7175 656e 6365 206f 6620 6c65 6e67 7468  quence of length
+0001e830: 207b 6c65 6e28 7265 7375 6c74 297d 2c20   {len(result)}, 
+0001e840: 676f 7420 6120 7365 7175 656e 6365 206f  got a sequence o
+0001e850: 6620 6c65 6e67 7468 207b 6c65 6e28 636f  f length {len(co
+0001e860: 7461 6e67 656e 7473 297d 222c 0a20 2020  tangents)}",.   
+0001e870: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+0001e880: 6574 7572 6e20 7265 7375 6c74 2c20 6261  eturn result, ba
+0001e890: 636b 7761 7264 5f70 6173 7328 656e 762c  ckward_pass(env,
+0001e8a0: 2074 7261 6365 2c20 636f 7461 6e67 656e   trace, cotangen
+0001e8b0: 7473 290a 0a0a 2320 544f 444f 3a20 4361  ts)...# TODO: Ca
+0001e8c0: 6e27 7420 7573 6520 6120 5379 6d62 6f6c  n't use a Symbol
+0001e8d0: 2068 6572 6520 6265 6361 7573 6520 6d69   here because mi
+0001e8e0: 7865 6420 6578 6563 7574 6f72 2073 7962  xed executor syb
+0001e8f0: 7379 6d62 6f6c 7320 7365 656d 2074 6f20  symbols seem to 
+0001e900: 6265 0a23 2075 6e73 7570 706f 7274 6564  be.# unsupported
+0001e910: 2e20 5365 6520 6973 7375 6520 2243 6f75  . See issue "Cou
+0001e920: 6c64 206e 6f74 2066 696e 6420 616e 2065  ld not find an e
+0001e930: 7865 6375 746f 7220 666f 7220 626f 756e  xecutor for boun
+0001e940: 6420 7379 6d62 6f6c 2077 6865 6e20 6974  d symbol when it
+0001e950: 7320 7375 6273 796d 626f 6c73 0a23 2061  s subsymbols.# a
+0001e960: 7265 206e 6f74 2066 756c 6c79 2073 7570  re not fully sup
+0001e970: 706f 7274 6564 2062 7920 6120 7369 6e67  ported by a sing
+0001e980: 6c65 2065 7865 6375 746f 7222 0a76 6a70  le executor".vjp
+0001e990: 5f63 616c 6c20 3d20 7061 7274 6961 6c28  _call = partial(
+0001e9a0: 0a20 2020 2076 6a70 5f63 616c 6c5f 6d65  .    vjp_call_me
+0001e9b0: 7461 6675 6e63 2c20 4661 6c73 650a 2920  tafunc, False.) 
+0001e9c0: 2023 2053 796d 626f 6c28 6964 3d54 7261   # Symbol(id=Tra
+0001e9d0: 6e73 666f 726d 732e 566a 704f 702c 206e  nsforms.VjpOp, n
+0001e9e0: 616d 653d 2276 6a70 5f63 616c 6c22 2c20  ame="vjp_call", 
+0001e9f0: 6d65 7461 3d70 6172 7469 616c 2876 6a70  meta=partial(vjp
+0001ea00: 5f63 616c 6c5f 6d65 7461 6675 6e63 2c20  _call_metafunc, 
+0001ea10: 4661 6c73 6529 290a 0a0a 6465 6620 766a  False))...def vj
+0001ea20: 7028 6675 6e63 293a 0a20 2020 2022 2222  p(func):.    """
+0001ea30: 436f 6d70 7574 6573 2074 6865 2056 4a50  Computes the VJP
+0001ea40: 206f 6620 6120 6675 6e63 7469 6f6e 2e0a   of a function..
+0001ea50: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+0001ea60: 2020 2066 756e 6320 2843 616c 6c61 626c     func (Callabl
+0001ea70: 6529 3a20 4675 6e63 7469 6f6e 2074 6f20  e): Function to 
+0001ea80: 6265 2064 6966 6665 7265 6e74 6961 7465  be differentiate
+0001ea90: 642e 0a20 2020 2022 2222 0a0a 2020 2020  d..    """..    
+0001eaa0: 6465 6620 5f76 6a70 2870 7269 6d61 6c73  def _vjp(primals
+0001eab0: 2c20 636f 7461 6e67 656e 7473 2c20 2a2a  , cotangents, **
+0001eac0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+0001ead0: 2066 6c61 745f 6675 6e63 2c20 666c 6174   flat_func, flat
+0001eae0: 5f61 7267 732c 2073 7065 6320 3d20 666c  _args, spec = fl
+0001eaf0: 6174 7465 6e5f 6675 6e63 2866 756e 632c  atten_func(func,
+0001eb00: 2070 7269 6d61 6c73 2c20 6b77 6172 6773   primals, kwargs
+0001eb10: 290a 2020 2020 2020 2020 7472 6163 6520  ).        trace 
+0001eb20: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
+0001eb30: 6528 2928 666c 6174 5f66 756e 632c 202a  e()(flat_func, *
+0001eb40: 666c 6174 5f61 7267 7329 0a20 2020 2020  flat_args).     
+0001eb50: 2020 2072 6573 756c 742c 2076 6a70 5f72     result, vjp_r
+0001eb60: 6573 756c 7420 3d20 766a 705f 6361 6c6c  esult = vjp_call
+0001eb70: 2866 6c61 745f 6172 6773 2c20 636f 7461  (flat_args, cota
+0001eb80: 6e67 656e 7473 2c20 7472 6163 653d 7472  ngents, trace=tr
+0001eb90: 6163 6529 0a20 2020 2020 2020 2067 7072  ace).        gpr
+0001eba0: 696d 616c 732c 2067 6b77 6172 6773 203d  imals, gkwargs =
+0001ebb0: 2074 7265 655f 756e 666c 6174 7465 6e28   tree_unflatten(
+0001ebc0: 766a 705f 7265 7375 6c74 2c20 7370 6563  vjp_result, spec
+0001ebd0: 290a 2020 2020 2020 2020 6772 6164 7320  ).        grads 
+0001ebe0: 3d20 6770 7269 6d61 6c73 202b 2028 676b  = gprimals + (gk
+0001ebf0: 7761 7267 732c 2920 6966 206c 656e 2867  wargs,) if len(g
+0001ec00: 6b77 6172 6773 2920 213d 2030 2065 6c73  kwargs) != 0 els
+0001ec10: 6520 6770 7269 6d61 6c73 0a20 2020 2020  e gprimals.     
+0001ec20: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+0001ec30: 2c20 6772 6164 730a 0a20 2020 2072 6574  , grads..    ret
+0001ec40: 7572 6e20 5f76 6a70 0a0a 0a64 6566 2076  urn _vjp...def v
+0001ec50: 616c 7565 5f61 6e64 5f67 7261 6428 6675  alue_and_grad(fu
+0001ec60: 6e63 293a 0a20 2020 2022 2222 436f 6d70  nc):.    """Comp
+0001ec70: 7574 6573 2074 6865 2076 616c 7565 2061  utes the value a
+0001ec80: 6e64 2067 7261 6469 656e 7420 6f66 2061  nd gradient of a
+0001ec90: 2066 756e 6374 696f 6e2e 0a0a 2020 2020   function...    
+0001eca0: 5468 6973 2069 7320 6120 636f 6e76 656e  This is a conven
+0001ecb0: 6965 6e63 6520 6675 6e63 7469 6f6e 2074  ience function t
+0001ecc0: 6861 7420 636f 6d62 696e 6573 2074 6865  hat combines the
+0001ecd0: 2066 756e 6374 696f 6e61 6c69 7479 206f   functionality o
+0001ece0: 660a 2020 2020 6076 6a70 5f63 616c 6c60  f.    `vjp_call`
+0001ecf0: 2077 6974 6820 696d 706c 6963 6974 2069   with implicit i
+0001ed00: 6e69 7469 616c 697a 6174 696f 6e20 6f66  nitialization of
+0001ed10: 2074 6865 2063 6f74 616e 6765 6e74 2074   the cotangent t
+0001ed20: 6f20 312e 0a0a 2020 2020 4172 6773 3a0a  o 1...    Args:.
+0001ed30: 2020 2020 2020 2020 6675 6e63 2028 4361          func (Ca
+0001ed40: 6c6c 6162 6c65 293a 2046 756e 6374 696f  llable): Functio
+0001ed50: 6e20 746f 2062 6520 6469 6666 6572 656e  n to be differen
+0001ed60: 7469 6174 6564 2e0a 2020 2020 2222 220a  tiated..    """.
+0001ed70: 0a20 2020 2064 6566 206f 6e65 735f 6c69  .    def ones_li
+0001ed80: 6b65 2878 293a 0a20 2020 2020 2020 2069  ke(x):.        i
+0001ed90: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+0001eda0: 5465 6e73 6f72 5072 6f78 7929 3a0a 2020  TensorProxy):.  
+0001edb0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001edc0: 2066 756c 6c5f 6c69 6b65 2878 2c20 6669   full_like(x, fi
+0001edd0: 6c6c 5f76 616c 7565 3d31 290a 2020 2020  ll_value=1).    
+0001ede0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+0001edf0: 6e63 6528 782c 204e 756d 6265 7250 726f  nce(x, NumberPro
+0001ee00: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
+0001ee10: 2072 6574 7572 6e20 7479 7065 2878 2e76   return type(x.v
+0001ee20: 616c 7565 2928 3129 0a20 2020 2020 2020  alue)(1).       
+0001ee30: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001ee40: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+0001ee50: 726f 7228 6622 6f6e 6573 5f6c 696b 6520  ror(f"ones_like 
+0001ee60: 696e 7369 6465 2076 616c 7565 5f61 6e64  inside value_and
+0001ee70: 5f67 7261 6420 676f 7420 616e 2075 6e73  _grad got an uns
+0001ee80: 7570 706f 7274 6564 2074 7970 6520 7b74  upported type {t
+0001ee90: 7970 6528 7829 7d22 290a 0a20 2020 2064  ype(x)}")..    d
+0001eea0: 6566 205f 7661 6c75 655f 616e 645f 6772  ef _value_and_gr
+0001eeb0: 6164 282a 6172 6773 2c20 2a2a 6b77 6172  ad(*args, **kwar
+0001eec0: 6773 293a 0a20 2020 2020 2020 2074 7261  gs):.        tra
+0001eed0: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
+0001eee0: 7261 6365 2829 2866 756e 632c 202a 6172  race()(func, *ar
+0001eef0: 6773 2c20 2a2a 6b77 6172 6773 290a 2020  gs, **kwargs).  
+0001ef00: 2020 2020 2020 636f 7461 6e67 656e 7473        cotangents
+0001ef10: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
+0001ef20: 6461 2076 3a20 6f6e 6573 5f6c 696b 6528  da v: ones_like(
+0001ef30: 7629 2c20 7472 6163 652e 6f75 7470 7574  v), trace.output
+0001ef40: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0001ef50: 2076 6a70 2866 756e 6329 2861 7267 732c   vjp(func)(args,
+0001ef60: 2063 6f74 616e 6765 6e74 732c 202a 2a6b   cotangents, **k
+0001ef70: 7761 7267 7329 0a0a 2020 2020 7265 7475  wargs)..    retu
+0001ef80: 726e 205f 7661 6c75 655f 616e 645f 6772  rn _value_and_gr
+0001ef90: 6164 0a0a 0a46 6f72 7761 7264 4261 636b  ad...ForwardBack
+0001efa0: 7761 7264 5472 6163 6573 203d 206e 616d  wardTraces = nam
+0001efb0: 6564 7475 706c 6528 2246 6f72 7761 7264  edtuple("Forward
+0001efc0: 4261 636b 7761 7264 5472 6163 6573 222c  BackwardTraces",
+0001efd0: 205b 2266 6f72 7761 7264 5f74 7261 6365   ["forward_trace
+0001efe0: 222c 2022 6261 636b 7761 7264 5f74 7261  ", "backward_tra
+0001eff0: 6365 225d 290a 0a0a 6465 6620 5f73 706c  ce"])...def _spl
+0001f000: 6974 5f73 6176 6564 5f66 6f72 5f62 6163  it_saved_for_bac
+0001f010: 6b77 6172 645f 696e 746f 5f74 656e 736f  kward_into_tenso
+0001f020: 7273 5f61 6e64 5f6f 7468 6572 280a 2020  rs_and_other(.  
+0001f030: 2020 7361 7665 645f 666f 725f 6261 636b    saved_for_back
+0001f040: 7761 7264 3a20 5365 7175 656e 6365 5b56  ward: Sequence[V
+0001f050: 6172 6961 626c 655d 2c0a 2920 2d3e 2074  ariable],.) -> t
+0001f060: 7570 6c65 5b53 6571 7565 6e63 655b 5661  uple[Sequence[Va
+0001f070: 7269 6162 6c65 5d2c 2053 6571 7565 6e63  riable], Sequenc
+0001f080: 655b 5661 7269 6162 6c65 5d5d 3a0a 2020  e[Variable]]:.  
+0001f090: 2020 2222 2253 706c 6974 7320 7361 7665    """Splits save
+0001f0a0: 645f 666f 725f 6261 636b 7761 7264 2069  d_for_backward i
+0001f0b0: 6e74 6f20 7465 6e73 6f72 7320 616e 6420  nto tensors and 
+0001f0c0: 6f74 6865 722e 0a0a 2020 2020 4172 6773  other...    Args
+0001f0d0: 3a0a 2020 2020 2020 2020 7361 7665 645f  :.        saved_
+0001f0e0: 666f 725f 6261 636b 7761 7264 2028 5365  for_backward (Se
+0001f0f0: 7175 656e 6365 5b56 6172 6961 626c 655d  quence[Variable]
+0001f100: 293a 2053 6176 6564 5f66 6f72 5f62 6163  ): Saved_for_bac
+0001f110: 6b77 6172 6420 746f 2073 706c 6974 2e0a  kward to split..
+0001f120: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+0001f130: 2020 2020 2020 7475 706c 655b 5365 7175        tuple[Sequ
+0001f140: 656e 6365 5b56 6172 6961 626c 655d 2c20  ence[Variable], 
+0001f150: 5365 7175 656e 6365 5b56 6172 6961 626c  Sequence[Variabl
+0001f160: 655d 5d3a 2054 7570 6c65 206f 6620 7465  e]]: Tuple of te
+0001f170: 6e73 6f72 7320 616e 6420 6f74 6865 722e  nsors and other.
+0001f180: 0a20 2020 2022 2222 0a20 2020 2069 735f  .    """.    is_
+0001f190: 7465 6e73 6f72 203d 206c 616d 6264 6120  tensor = lambda 
+0001f1a0: 783a 2069 7369 6e73 7461 6e63 6528 782c  x: isinstance(x,
+0001f1b0: 2054 656e 736f 7250 726f 7879 290a 2020   TensorProxy).  
+0001f1c0: 2020 6f74 6865 722c 2074 656e 736f 7273    other, tensors
+0001f1d0: 203d 2075 7469 6c73 2e70 6172 7469 7469   = utils.partiti
+0001f1e0: 6f6e 2869 735f 7465 6e73 6f72 2c20 7361  on(is_tensor, sa
+0001f1f0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001f200: 290a 2020 2020 7265 7475 726e 2074 7570  ).    return tup
+0001f210: 6c65 2874 656e 736f 7273 292c 2074 7570  le(tensors), tup
+0001f220: 6c65 286f 7468 6572 290a 0a0a 6465 6620  le(other)...def 
+0001f230: 5f75 7064 6174 655f 666f 7277 6172 645f  _update_forward_
+0001f240: 7769 7468 5f6e 6577 5f73 6176 6564 5f66  with_new_saved_f
+0001f250: 6f72 5f62 6163 6b77 6172 6428 666f 7277  or_backward(forw
+0001f260: 6172 645f 7472 6163 653a 2054 7261 6365  ard_trace: Trace
+0001f270: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
+0001f280: 7761 7264 3a20 5365 7175 656e 6365 5b56  ward: Sequence[V
+0001f290: 6172 6961 626c 655d 2920 2d3e 204e 6f6e  ariable]) -> Non
+0001f2a0: 653a 0a20 2020 2022 2222 5570 6461 7465  e:.    """Update
+0001f2b0: 7320 7468 6520 666f 7277 6172 6420 7472  s the forward tr
+0001f2c0: 6163 6520 7769 7468 206e 6577 2073 6176  ace with new sav
+0001f2d0: 6564 5f66 6f72 5f62 6163 6b77 6172 642e  ed_for_backward.
+0001f2e0: 0a0a 2020 2020 5468 6973 2069 7320 6e65  ..    This is ne
+0001f2f0: 6365 7373 6172 7920 6265 6361 7573 6520  cessary because 
+0001f300: 7468 6520 7570 6461 7465 6420 7361 7665  the updated save
+0001f310: 645f 666f 725f 6261 636b 7761 7264 2069  d_for_backward i
+0001f320: 7320 6e6f 7420 6176 6169 6c61 626c 650a  s not available.
+0001f330: 2020 2020 7768 656e 2074 6865 2066 6f72      when the for
+0001f340: 7761 7264 2061 6e64 2062 6163 6b77 6172  ward and backwar
+0001f350: 6420 7472 6163 6573 2061 7265 2063 6f6e  d traces are con
+0001f360: 7374 7275 6374 6564 2e0a 0a20 2020 2041  structed...    A
+0001f370: 7267 733a 0a20 2020 2020 2020 2066 6f72  rgs:.        for
+0001f380: 7761 7264 5f74 7261 6365 2028 5472 6163  ward_trace (Trac
+0001f390: 6529 3a20 466f 7277 6172 6420 7472 6163  e): Forward trac
+0001f3a0: 6520 746f 2075 7064 6174 652e 0a20 2020  e to update..   
+0001f3b0: 2020 2020 2073 6176 6564 5f66 6f72 5f62       saved_for_b
+0001f3c0: 6163 6b77 6172 6420 2853 6571 7565 6e63  ackward (Sequenc
+0001f3d0: 655b 5661 7269 6162 6c65 5d29 3a20 5361  e[Variable]): Sa
+0001f3e0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001f3f0: 2074 6f20 7573 6520 746f 0a20 2020 2020   to use to.     
+0001f400: 2020 2020 2020 2075 7064 6174 6520 7468         update th
+0001f410: 6520 666f 7277 6172 6420 7472 6163 652e  e forward trace.
+0001f420: 0a20 2020 2022 2222 0a20 2020 2073 6176  .    """.    sav
+0001f430: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
+0001f440: 3d20 7472 6565 5f6d 6170 286c 616d 6264  = tree_map(lambd
+0001f450: 6120 783a 2078 2e76 616c 7565 2069 6620  a x: x.value if 
+0001f460: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
+0001f470: 6d62 6572 5072 6f78 7929 2065 6c73 6520  mberProxy) else 
+0001f480: 782c 2073 6176 6564 5f66 6f72 5f62 6163  x, saved_for_bac
+0001f490: 6b77 6172 6429 0a20 2020 2073 6176 6564  kward).    saved
+0001f4a0: 5f74 656e 736f 7273 2c20 7361 7665 645f  _tensors, saved_
+0001f4b0: 6f74 6865 7220 3d20 5f73 706c 6974 5f73  other = _split_s
+0001f4c0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001f4d0: 645f 696e 746f 5f74 656e 736f 7273 5f61  d_into_tensors_a
+0001f4e0: 6e64 5f6f 7468 6572 2873 6176 6564 5f66  nd_other(saved_f
+0001f4f0: 6f72 5f62 6163 6b77 6172 6429 0a20 2020  or_backward).   
+0001f500: 2061 7373 6572 7420 666f 7277 6172 645f   assert forward_
+0001f510: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
+0001f520: 6f6c 735b 2d31 5d2e 7379 6d2e 6964 203d  ols[-1].sym.id =
+0001f530: 3d20 7072 696d 732e 5072 696d 4944 732e  = prims.PrimIDs.
+0001f540: 5245 5455 524e 0a20 2020 206e 6577 5f72  RETURN.    new_r
+0001f550: 6574 7572 6e20 3d20 2866 6f72 7761 7264  eturn = (forward
+0001f560: 5f74 7261 6365 2e6f 7574 7075 745b 305d  _trace.output[0]
+0001f570: 2c20 2873 6176 6564 5f74 656e 736f 7273  , (saved_tensors
+0001f580: 2c20 7361 7665 645f 6f74 6865 7229 290a  , saved_other)).
+0001f590: 2020 2020 666f 7277 6172 645f 7472 6163      forward_trac
+0001f5a0: 652e 626f 756e 645f 7379 6d62 6f6c 735b  e.bound_symbols[
+0001f5b0: 2d31 5d20 3d20 7265 706c 6163 6528 666f  -1] = replace(fo
+0001f5c0: 7277 6172 645f 7472 6163 652e 626f 756e  rward_trace.boun
+0001f5d0: 645f 7379 6d62 6f6c 735b 2d31 5d2c 2061  d_symbols[-1], a
+0001f5e0: 7267 733d 6e65 775f 7265 7475 726e 290a  rgs=new_return).
+0001f5f0: 0a0a 6465 6620 5f75 7064 6174 655f 6261  ..def _update_ba
+0001f600: 636b 7761 7264 5f77 6974 685f 6e65 775f  ckward_with_new_
+0001f610: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001f620: 7264 2862 6163 6b77 6172 645f 7472 6163  rd(backward_trac
+0001f630: 653a 2054 7261 6365 2c20 7361 7665 645f  e: Trace, saved_
+0001f640: 666f 725f 6261 636b 7761 7264 3a20 5365  for_backward: Se
+0001f650: 7175 656e 6365 5b56 6172 6961 626c 655d  quence[Variable]
+0001f660: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
+0001f670: 2222 5570 6461 7465 7320 7468 6520 6261  ""Updates the ba
+0001f680: 636b 7761 7264 2074 7261 6365 2077 6974  ckward trace wit
+0001f690: 6820 6e65 7720 7361 7665 645f 666f 725f  h new saved_for_
+0001f6a0: 6261 636b 7761 7264 2e0a 0a20 2020 2054  backward...    T
+0001f6b0: 6869 7320 6973 206e 6563 6573 7361 7279  his is necessary
+0001f6c0: 2062 6563 6175 7365 2074 6865 2075 7064   because the upd
+0001f6d0: 6174 6564 2073 6176 6564 5f66 6f72 5f62  ated saved_for_b
+0001f6e0: 6163 6b77 6172 6420 6973 0a20 2020 206e  ackward is.    n
+0001f6f0: 6f74 2061 7661 696c 6162 6c65 2077 6865  ot available whe
+0001f700: 6e20 7468 6520 6261 636b 7761 7264 2074  n the backward t
+0001f710: 7261 6365 2069 7320 636f 6e73 7472 7563  race is construc
+0001f720: 7465 642e 0a0a 2020 2020 4172 6773 3a0a  ted...    Args:.
+0001f730: 2020 2020 2020 2020 6261 636b 7761 7264          backward
+0001f740: 5f74 7261 6365 2028 5472 6163 6529 3a20  _trace (Trace): 
+0001f750: 4261 636b 7761 7264 2074 7261 6365 2074  Backward trace t
+0001f760: 6f20 7570 6461 7465 2e0a 2020 2020 2020  o update..      
+0001f770: 2020 7361 7665 645f 666f 725f 6261 636b    saved_for_back
+0001f780: 7761 7264 2028 5365 7175 656e 6365 5b56  ward (Sequence[V
+0001f790: 6172 6961 626c 655d 293a 2053 6176 6564  ariable]): Saved
+0001f7a0: 5f66 6f72 5f62 6163 6b77 6172 6420 746f  _for_backward to
+0001f7b0: 2075 7365 2074 6f0a 2020 2020 2020 2020   use to.        
+0001f7c0: 2020 2020 7570 6461 7465 2074 6865 2062      update the b
+0001f7d0: 6163 6b77 6172 6420 7472 6163 652e 0a20  ackward trace.. 
+0001f7e0: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
+0001f7f0: 756e 7061 636b 696e 675f 666e 2873 6176  unpacking_fn(sav
+0001f800: 6564 5f66 6f72 5f62 6163 6b77 6172 642c  ed_for_backward,
+0001f810: 2063 6f74 616e 6765 6e74 7329 3a0a 2020   cotangents):.  
+0001f820: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+0001f830: 636f 7461 6e67 656e 7473 203d 2062 6163  cotangents = bac
+0001f840: 6b77 6172 645f 7472 6163 652e 6172 6773  kward_trace.args
+0001f850: 5b31 5d0a 2020 2020 7361 7665 645f 7465  [1].    saved_te
+0001f860: 6e73 6f72 732c 2073 6176 6564 5f6f 7468  nsors, saved_oth
+0001f870: 6572 203d 205f 7370 6c69 745f 7361 7665  er = _split_save
+0001f880: 645f 666f 725f 6261 636b 7761 7264 5f69  d_for_backward_i
+0001f890: 6e74 6f5f 7465 6e73 6f72 735f 616e 645f  nto_tensors_and_
+0001f8a0: 6f74 6865 7228 7361 7665 645f 666f 725f  other(saved_for_
+0001f8b0: 6261 636b 7761 7264 290a 2020 2020 756e  backward).    un
+0001f8c0: 7061 636b 696e 675f 7472 6163 6520 3d20  packing_trace = 
+0001f8d0: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
+0001f8e0: 7265 6e61 6d65 5f70 726f 7869 6573 3d46  rename_proxies=F
+0001f8f0: 616c 7365 2c20 7573 655f 6463 653d 4661  alse, use_dce=Fa
+0001f900: 6c73 6529 280a 2020 2020 2020 2020 756e  lse)(.        un
+0001f910: 7061 636b 696e 675f 666e 2c20 2873 6176  packing_fn, (sav
+0001f920: 6564 5f74 656e 736f 7273 2c20 7361 7665  ed_tensors, save
+0001f930: 645f 6f74 6865 7229 2c20 636f 7461 6e67  d_other), cotang
+0001f940: 656e 7473 0a20 2020 2029 0a20 2020 2061  ents.    ).    a
+0001f950: 7373 6572 7420 756e 7061 636b 696e 675f  ssert unpacking_
+0001f960: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
+0001f970: 6f6c 735b 2d31 5d2e 7379 6d2e 6964 203d  ols[-1].sym.id =
+0001f980: 3d20 7072 696d 732e 5072 696d 4944 732e  = prims.PrimIDs.
+0001f990: 5245 5455 524e 0a0a 2020 2020 6261 636b  RETURN..    back
+0001f9a0: 7761 7264 5f74 7261 6365 2e61 7267 7320  ward_trace.args 
+0001f9b0: 3d20 756e 7061 636b 696e 675f 7472 6163  = unpacking_trac
+0001f9c0: 652e 6172 6773 0a20 2020 2062 6163 6b77  e.args.    backw
+0001f9d0: 6172 645f 7472 6163 655f 6273 796d 735f  ard_trace_bsyms_
+0001f9e0: 7769 7468 6f75 745f 756e 7061 636b 696e  without_unpackin
+0001f9f0: 6720 3d20 280a 2020 2020 2020 2020 6273  g = (.        bs
+0001fa00: 796d 0a20 2020 2020 2020 2066 6f72 2062  ym.        for b
+0001fa10: 7379 6d20 696e 2062 6163 6b77 6172 645f  sym in backward_
+0001fa20: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
+0001fa30: 6f6c 730a 2020 2020 2020 2020 6966 2062  ols.        if b
+0001fa40: 7379 6d2e 7379 6d2e 6964 0a20 2020 2020  sym.sym.id.     
+0001fa50: 2020 206e 6f74 2069 6e20 280a 2020 2020     not in (.    
+0001fa60: 2020 2020 2020 2020 7072 696d 732e 5072          prims.Pr
+0001fa70: 696d 4944 732e 554e 5041 434b 5f45 4d50  imIDs.UNPACK_EMP
+0001fa80: 5459 5f44 4943 542c 0a20 2020 2020 2020  TY_DICT,.       
+0001fa90: 2020 2020 2070 7269 6d73 2e50 7269 6d49       prims.PrimI
+0001faa0: 4473 2e55 4e50 4143 4b5f 4b45 592c 0a20  Ds.UNPACK_KEY,. 
+0001fab0: 2020 2020 2020 2020 2020 2070 7269 6d73             prims
+0001fac0: 2e50 7269 6d49 4473 2e55 4e50 4143 4b5f  .PrimIDs.UNPACK_
+0001fad0: 5345 5155 454e 4345 2c0a 2020 2020 2020  SEQUENCE,.      
+0001fae0: 2020 2020 2020 7072 696d 732e 5072 696d        prims.Prim
+0001faf0: 4944 732e 554e 5041 434b 5f54 5249 5649  IDs.UNPACK_TRIVI
+0001fb00: 414c 2c0a 2020 2020 2020 2020 290a 2020  AL,.        ).  
+0001fb10: 2020 290a 2020 2020 6261 636b 7761 7264    ).    backward
+0001fb20: 5f74 7261 6365 2e62 6f75 6e64 5f73 796d  _trace.bound_sym
+0001fb30: 626f 6c73 203d 206c 6973 7428 282a 756e  bols = list((*un
+0001fb40: 7061 636b 696e 675f 7472 6163 652e 626f  packing_trace.bo
+0001fb50: 756e 645f 7379 6d62 6f6c 735b 3a2d 315d  und_symbols[:-1]
+0001fb60: 2c20 2a62 6163 6b77 6172 645f 7472 6163  , *backward_trac
+0001fb70: 655f 6273 796d 735f 7769 7468 6f75 745f  e_bsyms_without_
+0001fb80: 756e 7061 636b 696e 6729 290a 0a0a 2320  unpacking))...# 
+0001fb90: 4e4f 5445 3a20 5265 7475 726e 696e 6720  NOTE: Returning 
+0001fba0: 6e61 6d65 6474 7570 6c65 7320 6672 6f6d  namedtuples from
+0001fbb0: 2063 6f6d 7069 6c65 6420 6675 6e63 7469   compiled functi
+0001fbc0: 6f6e 7320 646f 6573 6e27 7420 776f 726b  ons doesn't work
+0001fbd0: 2e20 5365 653a 0a23 2022 416c 6c6f 7720  . See:.# "Allow 
+0001fbe0: 7265 7475 726e 696e 6720 6e61 6d65 6474  returning namedt
+0001fbf0: 7570 6c65 7320 6672 6f6d 2063 6f6d 7069  uples from compi
+0001fc00: 6c65 6420 6675 6e63 7469 6f6e 7322 0a23  led functions".#
+0001fc10: 204e 6f74 6520 5b47 7261 6420 666f 7277   Note [Grad forw
+0001fc20: 6172 6420 6f75 7470 7574 2073 7065 635d  ard output spec]
+0001fc30: 0a23 2049 6620 6974 2064 6964 2077 6f72  .# If it did wor
+0001fc40: 6b20 6974 2077 6f75 6c64 2062 6520 6e69  k it would be ni
+0001fc50: 6365 2074 6f20 7573 6520 7468 6973 206e  ce to use this n
+0001fc60: 616d 6564 7475 706c 650a 2320 696e 7374  amedtuple.# inst
+0001fc70: 6561 6420 6f66 2074 6865 2070 6c61 696e  ead of the plain
+0001fc80: 2074 7570 6c65 206f 7220 6469 6374 2074   tuple or dict t
+0001fc90: 6861 7420 7765 2772 6520 7573 696e 6720  hat we're using 
+0001fca0: 6e6f 772e 0a54 6f72 6368 4175 746f 6772  now..TorchAutogr
+0001fcb0: 6164 466f 7277 6172 6444 6174 6120 3d20  adForwardData = 
+0001fcc0: 6e61 6d65 6474 7570 6c65 280a 2020 2020  namedtuple(.    
+0001fcd0: 2254 6f72 6368 4175 746f 6772 6164 466f  "TorchAutogradFo
+0001fce0: 7277 6172 6444 6174 6122 2c0a 2020 2020  rwardData",.    
+0001fcf0: 5b22 6f75 7470 7574 222c 2022 666c 6174  ["output", "flat
+0001fd00: 5f61 7267 7322 2c20 2266 6c61 745f 6f75  _args", "flat_ou
+0001fd10: 7470 7574 225d 2c0a 290a 0a0a 6465 6620  tput"],.)...def 
+0001fd20: 666f 7277 6172 645f 616e 645f 6261 636b  forward_and_back
+0001fd30: 7761 7264 5f66 726f 6d5f 7472 6163 6528  ward_from_trace(
+0001fd40: 7472 6163 653a 2054 7261 6365 2c20 746f  trace: Trace, to
+0001fd50: 7263 685f 6175 746f 6772 6164 3d46 616c  rch_autograd=Fal
+0001fd60: 7365 2920 2d3e 2046 6f72 7761 7264 4261  se) -> ForwardBa
+0001fd70: 636b 7761 7264 5472 6163 6573 3a0a 2020  ckwardTraces:.  
+0001fd80: 2020 2222 2247 656e 6572 6174 6573 2074    """Generates t
+0001fd90: 6865 2066 6f72 7761 7264 2061 6e64 2062  he forward and b
+0001fda0: 6163 6b77 6172 6420 7061 7373 6573 2066  ackward passes f
+0001fdb0: 726f 6d20 6120 7472 6163 652e 0a0a 2020  rom a trace...  
+0001fdc0: 2020 5468 6973 2069 7320 6120 636f 6e76    This is a conv
+0001fdd0: 656e 6965 6e63 6520 6675 6e63 7469 6f6e  enience function
+0001fde0: 2074 6861 7420 636f 6d62 696e 6573 2074   that combines t
+0001fdf0: 6865 2066 756e 6374 696f 6e61 6c69 7479  he functionality
+0001fe00: 206f 660a 2020 2020 6061 7567 6d65 6e74   of.    `augment
+0001fe10: 6564 5f66 6f72 7761 7264 5f70 6173 7360  ed_forward_pass`
+0001fe20: 2061 6e64 2060 6261 636b 7761 7264 5f70   and `backward_p
+0001fe30: 6173 7360 2e20 5468 6520 6d61 696e 2064  ass`. The main d
+0001fe40: 6966 6665 7265 6e63 6520 6973 2074 6861  ifference is tha
+0001fe50: 740a 2020 2020 7468 6973 2066 756e 6374  t.    this funct
+0001fe60: 696f 6e20 646f 6573 206e 6f74 2072 6571  ion does not req
+0001fe70: 7569 7265 2074 6865 2075 7365 7220 746f  uire the user to
+0001fe80: 2070 726f 7669 6465 206e 6577 2069 6e70   provide new inp
+0001fe90: 7574 7320 666f 7220 7468 650a 2020 2020  uts for the.    
+0001fea0: 7472 6163 6520 6576 616c 7561 7469 6f6e  trace evaluation
+0001feb0: 2e20 496e 7374 6561 6420 6974 2075 7365  . Instead it use
+0001fec0: 7320 7468 6520 696e 7075 7473 2074 6861  s the inputs tha
+0001fed0: 7420 7765 7265 2075 7365 6420 746f 2063  t were used to c
+0001fee0: 6f6e 7374 7275 6374 0a20 2020 2074 6865  onstruct.    the
+0001fef0: 2074 7261 6365 2e0a 0a20 2020 2041 7267   trace...    Arg
+0001ff00: 733a 0a20 2020 2020 2020 2074 7261 6365  s:.        trace
+0001ff10: 2028 5472 6163 6529 3a20 5472 6163 6520   (Trace): Trace 
+0001ff20: 746f 2067 656e 6572 6174 6520 7468 6520  to generate the 
+0001ff30: 666f 7277 6172 6420 616e 6420 6261 636b  forward and back
+0001ff40: 7761 7264 2070 6173 7365 7320 6672 6f6d  ward passes from
+0001ff50: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+0001ff60: 2020 2020 2020 2020 466f 7277 6172 6442          ForwardB
+0001ff70: 6163 6b77 6172 6454 7261 6365 733a 2041  ackwardTraces: A
+0001ff80: 206e 616d 6564 2074 7570 6c65 2063 6f6e   named tuple con
+0001ff90: 7461 696e 696e 6720 7468 6520 666f 7277  taining the forw
+0001ffa0: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
+0001ffb0: 0a20 2020 2020 2020 2020 2020 2074 7261  .            tra
+0001ffc0: 6365 732e 0a0a 2020 2020 4578 616d 706c  ces...    Exampl
+0001ffd0: 653a 0a20 2020 2020 2020 203e 3e3e 2069  e:.        >>> i
+0001ffe0: 6d70 6f72 7420 746f 7263 680a 2020 2020  mport torch.    
+0001fff0: 2020 2020 3e3e 3e20 6672 6f6d 2074 6875      >>> from thu
+00020000: 6e64 6572 2069 6d70 6f72 7420 636f 6d70  nder import comp
+00020010: 696c 652c 206c 6173 745f 7472 6163 6573  ile, last_traces
+00020020: 0a20 2020 2020 2020 203e 3e3e 2066 726f  .        >>> fro
+00020030: 6d20 7468 756e 6465 722e 636f 7265 2e74  m thunder.core.t
+00020040: 7261 6e73 666f 726d 7320 696d 706f 7274  ransforms import
+00020050: 2066 6f72 7761 7264 5f61 6e64 5f62 6163   forward_and_bac
+00020060: 6b77 6172 645f 6672 6f6d 5f74 7261 6365  kward_from_trace
+00020070: 0a20 2020 2020 2020 203e 3e3e 2064 6566  .        >>> def
+00020080: 2066 2878 293a 0a20 2020 2020 2020 202e   f(x):.        .
+00020090: 2e2e 2020 2020 2072 6574 7572 6e20 746f  ..     return to
+000200a0: 7263 682e 7369 6e28 7829 0a20 2020 2020  rch.sin(x).     
+000200b0: 2020 203e 3e3e 2078 203d 2074 6f72 6368     >>> x = torch
+000200c0: 2e74 656e 736f 7228 332e 3029 0a20 2020  .tensor(3.0).   
+000200d0: 2020 2020 203e 3e3e 2063 6620 3d20 636f       >>> cf = co
+000200e0: 6d70 696c 6528 6629 0a20 2020 2020 2020  mpile(f).       
+000200f0: 203e 3e3e 206f 7574 203d 2063 6628 7829   >>> out = cf(x)
+00020100: 0a20 2020 2020 2020 203e 3e3e 2074 7261  .        >>> tra
+00020110: 6365 203d 206c 6173 745f 7472 6163 6573  ce = last_traces
+00020120: 2863 6629 5b30 5d0a 2020 2020 2020 2020  (cf)[0].        
+00020130: 3e3e 3e20 666f 7277 6172 645f 616e 645f  >>> forward_and_
+00020140: 6261 636b 7761 7264 5f66 726f 6d5f 7472  backward_from_tr
+00020150: 6163 6528 7472 6163 6529 0a20 2020 2020  ace(trace).     
+00020160: 2020 202e 2e2e 2046 6f72 7761 7264 4261     ... ForwardBa
+00020170: 636b 7761 7264 5472 6163 6573 280a 2020  ckwardTraces(.  
+00020180: 2020 2020 2020 2e2e 2e20 666f 7277 6172        ... forwar
+00020190: 645f 7472 6163 653d 2320 696d 706f 7274  d_trace=# import
+000201a0: 2074 6875 6e64 6572 2061 7320 7468 756e   thunder as thun
+000201b0: 6465 720a 2020 2020 2020 2020 2e2e 2e20  der.        ... 
+000201c0: 2320 696d 706f 7274 2074 6875 6e64 6572  # import thunder
+000201d0: 2e63 6f72 652e 7072 696d 7320 6173 2070  .core.prims as p
+000201e0: 7269 6d73 0a20 2020 2020 2020 202e 2e2e  rims.        ...
+000201f0: 2069 6d70 6f72 7420 746f 7263 680a 2020   import torch.  
+00020200: 2020 2020 2020 2e2e 2e0a 2020 2020 2020        ....      
+00020210: 2020 2e2e 2e20 4074 6f72 6368 2e6e 6f5f    ... @torch.no_
+00020220: 6772 6164 2829 0a20 2020 2020 2020 202e  grad().        .
+00020230: 2e2e 2064 6566 2061 7567 6d65 6e74 6564  .. def augmented
+00020240: 5f66 6f72 7761 7264 5f66 6e28 2a61 7267  _forward_fn(*arg
+00020250: 7329 3a0a 2020 2020 2020 2020 2e2e 2e20  s):.        ... 
+00020260: 2020 2320 6172 6773 3a20 2243 6f6c 6c65    # args: "Colle
+00020270: 6374 696f 6e22 203d 2020 2874 302c 2920  ction" =  (t0,) 
+00020280: 2028 7472 6976 6961 6c20 756e 7061 636b   (trivial unpack
+00020290: 290a 2020 2020 2020 2020 2e2e 2e20 2020  ).        ...   
+000202a0: 7430 2c20 5c0a 2020 2020 2020 2020 2e2e  t0, \.        ..
+000202b0: 2e20 2020 3d20 6172 6773 0a20 2020 2020  .   = args.     
+000202c0: 2020 202e 2e2e 2020 2074 3120 3d20 7072     ...   t1 = pr
+000202d0: 696d 732e 7369 6e28 7430 2920 2023 2074  ims.sin(t0)  # t
+000202e0: 313a 2022 6370 7520 6633 325b 5d22 0a20  1: "cpu f32[]". 
+000202f0: 2020 2020 2020 202e 2e2e 2020 2072 6574         ...   ret
+00020300: 7572 6e20 7431 2c20 2874 302c 292c 0a20  urn t1, (t0,),. 
+00020310: 2020 2020 2020 202e 2e2e 2062 6163 6b77         ... backw
+00020320: 6172 645f 7472 6163 653d 2320 696d 706f  ard_trace=# impo
+00020330: 7274 2074 6875 6e64 6572 2061 7320 7468  rt thunder as th
+00020340: 756e 6465 720a 2020 2020 2020 2020 2e2e  under.        ..
+00020350: 2e20 2320 696d 706f 7274 2074 6875 6e64  . # import thund
+00020360: 6572 2e63 6f72 652e 7072 696d 7320 6173  er.core.prims as
+00020370: 2070 7269 6d73 0a20 2020 2020 2020 202e   prims.        .
+00020380: 2e2e 2069 6d70 6f72 7420 746f 7263 680a  .. import torch.
+00020390: 2020 2020 2020 2020 2e2e 2e0a 2020 2020          ....    
+000203a0: 2020 2020 2e2e 2e20 4074 6f72 6368 2e6e      ... @torch.n
+000203b0: 6f5f 6772 6164 2829 0a20 2020 2020 2020  o_grad().       
+000203c0: 202e 2e2e 2064 6566 2062 6163 6b77 6172   ... def backwar
+000203d0: 645f 666e 2873 6176 6564 5f66 6f72 5f62  d_fn(saved_for_b
+000203e0: 6163 6b77 6172 642c 2063 6f74 616e 6765  ackward, cotange
+000203f0: 6e74 7329 3a0a 2020 2020 2020 2020 2e2e  nts):.        ..
+00020400: 2e20 2020 2320 7361 7665 645f 666f 725f  .   # saved_for_
+00020410: 6261 636b 7761 7264 3a20 2243 6f6c 6c65  backward: "Colle
+00020420: 6374 696f 6e22 203d 2020 2874 302c 2920  ction" =  (t0,) 
+00020430: 2028 7472 6976 6961 6c20 756e 7061 636b   (trivial unpack
+00020440: 290a 2020 2020 2020 2020 2e2e 2e20 2020  ).        ...   
+00020450: 2320 636f 7461 6e67 656e 7473 3a20 2263  # cotangents: "c
+00020460: 7075 2066 3332 5b5d 2220 3d20 2063 6f74  pu f32[]" =  cot
+00020470: 616e 6765 6e74 7320 2028 7472 6976 6961  angents  (trivia
+00020480: 6c20 756e 7061 636b 290a 2020 2020 2020  l unpack).      
+00020490: 2020 2e2e 2e20 2020 7430 2c20 5c0a 2020    ...   t0, \.  
+000204a0: 2020 2020 2020 2e2e 2e20 2020 3d20 7361        ...   = sa
+000204b0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+000204c0: 0a20 2020 2020 2020 202e 2e2e 2020 2074  .        ...   t
+000204d0: 3120 3d20 7072 696d 732e 636f 7328 7430  1 = prims.cos(t0
+000204e0: 2920 2023 2074 313a 2022 6370 7520 6633  )  # t1: "cpu f3
+000204f0: 325b 5d22 0a20 2020 2020 2020 202e 2e2e  2[]".        ...
+00020500: 2020 2074 3220 3d20 7072 696d 732e 6d75     t2 = prims.mu
+00020510: 6c28 636f 7461 6e67 656e 7473 2c20 7431  l(cotangents, t1
+00020520: 2920 2023 2074 323a 2022 6370 7520 6633  )  # t2: "cpu f3
+00020530: 325b 5d22 0a20 2020 2020 2020 202e 2e2e  2[]".        ...
+00020540: 2020 2072 6574 7572 6e20 2874 322c 2929     return (t2,))
+00020550: 0a20 2020 2022 2222 0a0a 2020 2020 6f75  .    """..    ou
+00020560: 7470 7574 5f73 7065 6320 3d20 4e6f 6e65  tput_spec = None
+00020570: 0a0a 2020 2020 6465 6620 6175 676d 656e  ..    def augmen
+00020580: 7465 645f 666f 7277 6172 645f 666e 282a  ted_forward_fn(*
+00020590: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
+000205a0: 0a20 2020 2020 2020 2072 6573 756c 742c  .        result,
+000205b0: 2065 6e76 203d 2061 7567 6d65 6e74 6564   env = augmented
+000205c0: 5f66 6f72 7761 7264 5f70 6173 7328 2a61  _forward_pass(*a
+000205d0: 7267 732c 2074 7261 6365 3d74 7261 6365  rgs, trace=trace
+000205e0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+000205f0: 2020 2020 7361 7665 645f 666f 725f 6261      saved_for_ba
+00020600: 636b 7761 7264 203d 2064 6563 6f6e 7374  ckward = deconst
+00020610: 7275 6374 5f66 6f72 7761 7264 5f65 6e76  ruct_forward_env
+00020620: 5f66 6f72 5f62 6163 6b77 6172 6428 7472  _for_backward(tr
+00020630: 6163 652c 2065 6e76 290a 2020 2020 2020  ace, env).      
+00020640: 2020 6966 2074 6f72 6368 5f61 7574 6f67    if torch_autog
+00020650: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
+00020660: 206e 6f6e 6c6f 6361 6c20 6f75 7470 7574   nonlocal output
+00020670: 5f73 7065 630a 2020 2020 2020 2020 2020  _spec.          
+00020680: 2020 666c 6174 5f61 7267 732c 205f 203d    flat_args, _ =
+00020690: 2074 7265 655f 666c 6174 7465 6e28 2861   tree_flatten((a
+000206a0: 7267 732c 206b 7761 7267 7329 290a 2020  rgs, kwargs)).  
+000206b0: 2020 2020 2020 2020 2020 666c 6174 5f6f            flat_o
+000206c0: 7574 7075 742c 206f 7574 7075 745f 7370  utput, output_sp
+000206d0: 6563 203d 2074 7265 655f 666c 6174 7465  ec = tree_flatte
+000206e0: 6e28 7265 7375 6c74 290a 2020 2020 2020  n(result).      
+000206f0: 2020 2020 2020 666c 6174 5f6f 7574 7075        flat_outpu
+00020700: 7420 3d20 7475 706c 6528 666c 6174 5f6f  t = tuple(flat_o
+00020710: 7574 7075 7429 0a20 2020 2020 2020 2020  utput).         
+00020720: 2020 2023 2053 6565 204e 6f74 6520 5b47     # See Note [G
+00020730: 7261 6420 666f 7277 6172 6420 6f75 7470  rad forward outp
+00020740: 7574 2073 7065 635d 0a20 2020 2020 2020  ut spec].       
+00020750: 2020 2020 2066 6f72 5f61 7574 6f67 7261       for_autogra
+00020760: 6420 3d20 546f 7263 6841 7574 6f67 7261  d = TorchAutogra
+00020770: 6446 6f72 7761 7264 4461 7461 280a 2020  dForwardData(.  
+00020780: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00020790: 7375 6c74 2c0a 2020 2020 2020 2020 2020  sult,.          
+000207a0: 2020 2020 2020 666c 6174 5f61 7267 732c        flat_args,
+000207b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000207c0: 2066 6c61 745f 6f75 7470 7574 2c0a 2020   flat_output,.  
+000207d0: 2020 2020 2020 2020 2020 292e 5f61 7364            )._asd
+000207e0: 6963 7428 290a 2020 2020 2020 2020 2020  ict().          
+000207f0: 2020 7265 7475 726e 2028 666f 725f 6175    return (for_au
+00020800: 746f 6772 6164 2c20 7361 7665 645f 666f  tograd, saved_fo
+00020810: 725f 6261 636b 7761 7264 290a 2020 2020  r_backward).    
+00020820: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+00020830: 742c 2073 6176 6564 5f66 6f72 5f62 6163  t, saved_for_bac
+00020840: 6b77 6172 640a 0a20 2020 2023 2043 6f70  kward..    # Cop
+00020850: 7920 7468 6520 7369 676e 6174 7572 6520  y the signature 
+00020860: 6f66 2074 6865 206f 7269 6769 6e61 6c20  of the original 
+00020870: 6675 6e63 7469 6f6e 2073 6f20 7468 6174  function so that
+00020880: 2074 6865 2061 7267 756d 656e 7473 2061   the arguments a
+00020890: 7265 0a20 2020 2023 206e 616d 6564 2063  re.    # named c
+000208a0: 6f72 7265 6374 6c79 2069 6e20 7468 6520  orrectly in the 
+000208b0: 6175 676d 656e 7465 6420 666f 7277 6172  augmented forwar
+000208c0: 6420 7061 7373 2069 6e73 7465 6164 206f  d pass instead o
+000208d0: 6620 6265 696e 6720 6e61 6d65 640a 2020  f being named.  
+000208e0: 2020 2320 2261 7267 7322 2061 6e64 2022    # "args" and "
+000208f0: 6b77 6172 6773 222e 0a20 2020 2061 7567  kwargs"..    aug
+00020900: 6d65 6e74 6564 5f66 6f72 7761 7264 5f66  mented_forward_f
+00020910: 6e2e 5f5f 7369 676e 6174 7572 655f 5f20  n.__signature__ 
+00020920: 3d20 696e 7370 6563 742e 7369 676e 6174  = inspect.signat
+00020930: 7572 6528 7472 6163 652e 666e 206f 7220  ure(trace.fn or 
+00020940: 7472 6163 652e 7079 7468 6f6e 5f63 616c  trace.python_cal
+00020950: 6c61 626c 6528 2929 0a0a 2020 2020 6465  lable())..    de
+00020960: 6620 6f6e 6573 5f6c 696b 6528 7829 3a0a  f ones_like(x):.
+00020970: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00020980: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
+00020990: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
+000209a0: 2020 2072 6574 7572 6e20 6675 6c6c 5f6c     return full_l
+000209b0: 696b 6528 782c 2066 696c 6c5f 7661 6c75  ike(x, fill_valu
+000209c0: 653d 3129 0a20 2020 2020 2020 2065 6c69  e=1).        eli
+000209d0: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+000209e0: 4e75 6d62 6572 5072 6f78 7929 3a0a 2020  NumberProxy):.  
+000209f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00020a00: 2074 7970 6528 782e 7661 6c75 6529 2831   type(x.value)(1
+00020a10: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00020a20: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00020a30: 726e 204e 6f6e 650a 0a20 2020 2066 6f72  rn None..    for
+00020a40: 7761 7264 5f74 7261 6365 203d 2063 6f6e  ward_trace = con
+00020a50: 7374 7275 6374 5f74 7261 6365 2829 2861  struct_trace()(a
+00020a60: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+00020a70: 5f66 6e2c 202a 7472 6163 652e 6172 6773  _fn, *trace.args
+00020a80: 2c20 2a2a 7472 6163 652e 6b77 6172 6773  , **trace.kwargs
+00020a90: 290a 2020 2020 2320 5765 2073 6574 2066  ).    # We set f
+00020aa0: 6f72 7761 7264 2074 7261 6365 2074 6f20  orward trace to 
+00020ab0: 636f 6e73 7472 7563 7420 7072 6f78 6965  construct proxie
+00020ac0: 7320 6265 6361 7573 6520 7765 206e 6565  s because we nee
+00020ad0: 6420 7468 6573 6520 7072 6f78 6965 7320  d these proxies 
+00020ae0: 746f 0a20 2020 2023 2068 6176 6520 6469  to.    # have di
+00020af0: 6666 6572 656e 7420 6e61 6d65 7320 7468  fferent names th
+00020b00: 616e 2074 6865 206f 6e65 7320 696e 2074  an the ones in t
+00020b10: 6865 2066 6f72 7761 7264 2074 7261 6365  he forward trace
+00020b20: 2e0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
+00020b30: 2020 2074 7261 6365 6374 785f 746f 6b65     tracectx_toke
+00020b40: 6e20 3d20 7365 745f 7472 6163 6563 7478  n = set_tracectx
+00020b50: 2866 6f72 7761 7264 5f74 7261 6365 290a  (forward_trace).
+00020b60: 2020 2020 2020 2020 2320 5765 2064 6f6e          # We don
+00020b70: 2774 2077 616e 7420 746f 2072 6563 6f72  't want to recor
+00020b80: 6420 7468 6f73 6520 6f6e 6573 5f6c 696b  d those ones_lik
+00020b90: 6520 6361 6c6c 7320 696e 2074 6865 2066  e calls in the f
+00020ba0: 6f72 7761 7264 2074 7261 6365 2e0a 2020  orward trace..  
+00020bb0: 2020 2020 2020 7769 7468 2064 6574 6163        with detac
+00020bc0: 6865 645f 7472 6163 6528 293a 0a20 2020  hed_trace():.   
+00020bd0: 2020 2020 2020 2020 2069 6620 746f 7263           if torc
+00020be0: 685f 6175 746f 6772 6164 3a0a 2020 2020  h_autograd:.    
+00020bf0: 2020 2020 2020 2020 2020 2020 2320 4974              # It
+00020c00: 2773 2061 7373 756d 6564 2074 6861 7420  's assumed that 
+00020c10: 666f 7277 6172 645f 7472 6163 652e 6f75  forward_trace.ou
+00020c20: 7470 7574 5b30 5d20 6973 2061 2064 6963  tput[0] is a dic
+00020c30: 7420 6672 6f6d 2054 6f72 6368 4175 746f  t from TorchAuto
+00020c40: 6772 6164 466f 7277 6172 6444 6174 610a  gradForwardData.
+00020c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c60: 666c 6174 5f6f 7574 7075 7420 3d20 666f  flat_output = fo
+00020c70: 7277 6172 645f 7472 6163 652e 6f75 7470  rward_trace.outp
+00020c80: 7574 5b30 5d5b 2266 6c61 745f 6f75 7470  ut[0]["flat_outp
+00020c90: 7574 225d 0a20 2020 2020 2020 2020 2020  ut"].           
+00020ca0: 2020 2020 2063 6f74 616e 6765 6e74 7320       cotangents 
+00020cb0: 3d20 7574 696c 732e 7365 7175 656e 6369  = utils.sequenci
+00020cc0: 6679 2874 7265 655f 6d61 7028 6c61 6d62  fy(tree_map(lamb
+00020cd0: 6461 2076 3a20 6f6e 6573 5f6c 696b 6528  da v: ones_like(
+00020ce0: 7629 2c20 666c 6174 5f6f 7574 7075 7429  v), flat_output)
+00020cf0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00020d00: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00020d10: 2020 2020 636f 7461 6e67 656e 7473 203d      cotangents =
+00020d20: 2075 7469 6c73 2e73 6571 7565 6e63 6966   utils.sequencif
+00020d30: 7928 7472 6565 5f6d 6170 286c 616d 6264  y(tree_map(lambd
+00020d40: 6120 763a 206f 6e65 735f 6c69 6b65 2876  a v: ones_like(v
+00020d50: 292c 2074 7261 6365 2e6f 7574 7075 7429  ), trace.output)
+00020d60: 290a 2020 2020 6669 6e61 6c6c 793a 0a20  ).    finally:. 
+00020d70: 2020 2020 2020 2072 6573 6574 5f74 7261         reset_tra
+00020d80: 6365 6374 7828 7472 6163 6563 7478 5f74  cectx(tracectx_t
+00020d90: 6f6b 656e 290a 0a20 2020 2064 6566 2062  oken)..    def b
+00020da0: 6163 6b77 6172 645f 666e 2873 6176 6564  ackward_fn(saved
+00020db0: 5f66 6f72 5f62 6163 6b77 6172 642c 2063  _for_backward, c
+00020dc0: 6f74 616e 6765 6e74 7329 3a0a 2020 2020  otangents):.    
+00020dd0: 2020 2020 656e 7620 3d20 7265 636f 6e73      env = recons
+00020de0: 7472 7563 745f 666f 7277 6172 645f 656e  truct_forward_en
+00020df0: 765f 666f 725f 6261 636b 7761 7264 2874  v_for_backward(t
+00020e00: 7261 6365 2c20 7361 7665 645f 666f 725f  race, saved_for_
+00020e10: 6261 636b 7761 7264 290a 2020 2020 2020  backward).      
+00020e20: 2020 6966 2074 6f72 6368 5f61 7574 6f67    if torch_autog
+00020e30: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
+00020e40: 2063 6f74 616e 6765 6e74 7320 3d20 7472   cotangents = tr
+00020e50: 6565 5f75 6e66 6c61 7474 656e 2863 6f74  ee_unflatten(cot
+00020e60: 616e 6765 6e74 732c 206f 7574 7075 745f  angents, output_
+00020e70: 7370 6563 290a 2020 2020 2020 2020 6f75  spec).        ou
+00020e80: 7420 3d20 6261 636b 7761 7264 5f70 6173  t = backward_pas
+00020e90: 7328 656e 762c 2074 7261 6365 2c20 636f  s(env, trace, co
+00020ea0: 7461 6e67 656e 7473 290a 2020 2020 2020  tangents).      
+00020eb0: 2020 6966 2074 6f72 6368 5f61 7574 6f67    if torch_autog
+00020ec0: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
+00020ed0: 2067 6b77 6172 6773 203d 206f 7574 5b2d   gkwargs = out[-
+00020ee0: 315d 2069 6620 6973 696e 7374 616e 6365  1] if isinstance
+00020ef0: 286f 7574 5b2d 315d 2c20 6469 6374 2920  (out[-1], dict) 
+00020f00: 656c 7365 207b 7d0a 2020 2020 2020 2020  else {}.        
+00020f10: 2020 2020 6761 7267 7320 3d20 6f75 745b      gargs = out[
+00020f20: 3a2d 315d 2069 6620 6973 696e 7374 616e  :-1] if isinstan
+00020f30: 6365 286f 7574 5b2d 315d 2c20 6469 6374  ce(out[-1], dict
+00020f40: 2920 656c 7365 206f 7574 0a20 2020 2020  ) else out.     
+00020f50: 2020 2020 2020 2067 6b77 6172 6773 203d         gkwargs =
+00020f60: 207b 6b3a 2067 6b77 6172 6773 2e67 6574   {k: gkwargs.get
+00020f70: 286b 2c20 4e6f 6e65 2920 666f 7220 6b20  (k, None) for k 
+00020f80: 696e 2074 7261 6365 2e6b 7761 7267 737d  in trace.kwargs}
+00020f90: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00020fa0: 203d 2028 2a67 6172 6773 2c20 676b 7761   = (*gargs, gkwa
+00020fb0: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
+00020fc0: 206f 7574 203d 2074 7265 655f 666c 6174   out = tree_flat
+00020fd0: 7465 6e28 6f75 7429 5b30 5d0a 2020 2020  ten(out)[0].    
+00020fe0: 2020 2020 7265 7475 726e 206f 7574 0a0a      return out..
+00020ff0: 2020 2020 7361 7665 645f 666f 725f 6261      saved_for_ba
+00021000: 636b 7761 7264 203d 2066 6f72 7761 7264  ckward = forward
+00021010: 5f74 7261 6365 2e6f 7574 7075 745b 315d  _trace.output[1]
+00021020: 0a20 2020 2062 6163 6b77 6172 645f 7472  .    backward_tr
+00021030: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
+00021040: 7472 6163 6528 7265 6e61 6d65 5f70 726f  trace(rename_pro
+00021050: 7869 6573 3d46 616c 7365 2928 6261 636b  xies=False)(back
+00021060: 7761 7264 5f66 6e2c 2073 6176 6564 5f66  ward_fn, saved_f
+00021070: 6f72 5f62 6163 6b77 6172 642c 2063 6f74  or_backward, cot
+00021080: 616e 6765 6e74 7329 0a0a 2020 2020 2320  angents)..    # 
+00021090: 5765 2061 7265 2064 6f6e 6520 7769 7468  We are done with
+000210a0: 2063 6f6e 7374 7275 6374 696e 6720 7468   constructing th
+000210b0: 6520 666f 7277 6172 6420 616e 6420 6261  e forward and ba
+000210c0: 636b 7761 7264 2070 6173 7365 7320 6174  ckward passes at
+000210d0: 2074 6869 730a 2020 2020 2320 7374 6167   this.    # stag
+000210e0: 652e 2054 6865 2066 6f6c 6c6f 7769 6e67  e. The following
+000210f0: 2069 7320 6e6f 7420 7374 7269 6374 6c79   is not strictly
+00021100: 206e 6563 6573 7361 7279 2c20 6275 7420   necessary, but 
+00021110: 6974 2773 2067 6f6f 6420 746f 2066 696c  it's good to fil
+00021120: 7465 720a 2020 2020 2320 6f75 7420 7468  ter.    # out th
+00021130: 6520 756e 7573 6564 2065 6c65 6d65 6e74  e unused element
+00021140: 7320 6f66 2074 6865 2073 6176 6564 5f66  s of the saved_f
+00021150: 6f72 5f62 6163 6b77 6172 6420 616e 6420  or_backward and 
+00021160: 666c 6174 7465 6e20 6974 2066 6f72 206d  flatten it for m
+00021170: 6f72 650a 2020 2020 2320 636f 6d70 6163  ore.    # compac
+00021180: 7420 6261 636b 7761 7264 2074 7261 6365  t backward trace
+00021190: 2e0a 0a20 2020 2023 204e 6f77 2077 6520  ...    # Now we 
+000211a0: 6361 6e20 6465 7465 726d 696e 6520 6578  can determine ex
+000211b0: 6163 746c 7920 7768 6174 2773 2075 7365  actly what's use
+000211c0: 6420 696e 2074 6865 2062 6163 6b77 6172  d in the backwar
+000211d0: 6420 7061 7373 2066 726f 6d20 7468 650a  d pass from the.
+000211e0: 2020 2020 2320 7361 7665 645f 666f 725f      # saved_for_
+000211f0: 6261 636b 7761 7264 2e20 5765 2063 616e  backward. We can
+00021200: 2066 6c61 7474 656e 2061 6e64 2066 696c   flatten and fil
+00021210: 7465 7220 7468 6520 7361 7665 645f 666f  ter the saved_fo
+00021220: 725f 6261 636b 7761 7264 0a20 2020 2063  r_backward.    c
+00021230: 6f6e 7375 6d65 7273 203d 2075 7469 6c73  onsumers = utils
+00021240: 2e63 6f6e 7375 6d65 7273 2862 6163 6b77  .consumers(backw
+00021250: 6172 645f 7472 6163 6529 0a0a 2020 2020  ard_trace)..    
+00021260: 2320 466f 7277 6172 6427 7320 616e 6420  # Forward's and 
+00021270: 6261 636b 7761 7264 2773 2022 7361 7665  backward's "save
+00021280: 645f 666f 725f 6261 636b 7761 7264 2220  d_for_backward" 
+00021290: 6172 6520 6e6f 7420 6e65 6365 7373 6172  are not necessar
+000212a0: 696c 7920 7468 6520 7361 6d65 0a20 2020  ily the same.   
+000212b0: 2023 2061 7320 7468 6520 7361 7665 645f   # as the saved_
+000212c0: 666f 725f 6261 636b 7761 7264 2c20 6265  for_backward, be
+000212d0: 6361 7573 6520 736f 6d65 206f 7220 616c  cause some or al
+000212e0: 6c20 656c 656d 656e 7473 206f 6620 7468  l elements of th
+000212f0: 650a 2020 2020 2320 7361 7665 645f 666f  e.    # saved_fo
+00021300: 725f 6261 636b 7761 7264 2072 6573 756c  r_backward resul
+00021310: 7473 206d 6967 6874 2062 6520 7265 2d70  ts might be re-p
+00021320: 726f 7869 6669 6564 2e0a 2020 2020 6277  roxified..    bw
+00021330: 5f66 6c61 745f 7361 7665 645f 666f 725f  _flat_saved_for_
+00021340: 6261 636b 7761 7264 2c20 7370 6563 203d  backward, spec =
+00021350: 2074 7265 655f 666c 6174 7465 6e28 6261   tree_flatten(ba
+00021360: 636b 7761 7264 5f74 7261 6365 2e61 7267  ckward_trace.arg
+00021370: 735b 305d 290a 2020 2020 6677 5f66 6c61  s[0]).    fw_fla
+00021380: 745f 7361 7665 645f 666f 725f 6261 636b  t_saved_for_back
+00021390: 7761 7264 2c20 5f20 3d20 7472 6565 5f66  ward, _ = tree_f
+000213a0: 6c61 7474 656e 2866 6f72 7761 7264 5f74  latten(forward_t
+000213b0: 7261 6365 2e6f 7574 7075 745b 315d 290a  race.output[1]).
+000213c0: 2020 2020 7573 6564 5f6d 6173 6b20 3d20      used_mask = 
+000213d0: 6c69 7374 286c 656e 2863 6f6e 7375 6d65  list(len(consume
+000213e0: 7273 2e67 6574 2878 2c20 2829 2929 203e  rs.get(x, ())) >
+000213f0: 2030 2066 6f72 2078 2069 6e20 6277 5f66   0 for x in bw_f
+00021400: 6c61 745f 7361 7665 645f 666f 725f 6261  lat_saved_for_ba
+00021410: 636b 7761 7264 290a 0a20 2020 2023 2044  ckward)..    # D
+00021420: 6f6e 2774 2075 7365 2074 6865 2073 616d  on't use the sam
+00021430: 6520 7661 7269 6162 6c65 2074 7769 6365  e variable twice
+00021440: 2069 6e20 7468 6520 6261 636b 7761 7264   in the backward
+00021450: 2070 6173 730a 2020 2020 7365 656e 203d   pass.    seen =
+00021460: 2073 6574 2829 0a20 2020 2066 726f 6d20   set().    from 
+00021470: 7468 756e 6465 722e 636f 7265 2e70 726f  thunder.core.pro
+00021480: 7869 6573 2069 6d70 6f72 7420 5661 7269  xies import Vari
+00021490: 6162 6c65 0a0a 2020 2020 666f 7220 692c  able..    for i,
+000214a0: 2078 2069 6e20 656e 756d 6572 6174 6528   x in enumerate(
+000214b0: 6677 5f66 6c61 745f 7361 7665 645f 666f  fw_flat_saved_fo
+000214c0: 725f 6261 636b 7761 7264 293a 0a20 2020  r_backward):.   
+000214d0: 2020 2020 2078 203d 2076 6172 6961 626c       x = variabl
+000214e0: 6569 6679 2878 290a 2020 2020 2020 2020  eify(x).        
+000214f0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+00021500: 6528 782c 2056 6172 6961 626c 6529 3a0a  e(x, Variable):.
+00021510: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00021520: 696e 7565 0a20 2020 2020 2020 2069 6620  inue.        if 
+00021530: 7820 696e 2073 6565 6e3a 0a20 2020 2020  x in seen:.     
+00021540: 2020 2020 2020 2075 7365 645f 6d61 736b         used_mask
+00021550: 5b69 5d20 3d20 4661 6c73 650a 2020 2020  [i] = False.    
+00021560: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00021570: 2020 2020 2020 7365 656e 2e61 6464 2878        seen.add(x
+00021580: 290a 0a20 2020 206f 6e6c 795f 7573 6564  )..    only_used
+00021590: 5f66 775f 7361 7665 645f 666f 725f 6261  _fw_saved_for_ba
+000215a0: 636b 7761 7264 203d 2074 7570 6c65 2863  ckward = tuple(c
+000215b0: 6f6d 7072 6573 7328 6677 5f66 6c61 745f  ompress(fw_flat_
+000215c0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+000215d0: 7264 2c20 7573 6564 5f6d 6173 6b29 290a  rd, used_mask)).
+000215e0: 2020 2020 6f6e 6c79 5f75 7365 645f 6277      only_used_bw
+000215f0: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
+00021600: 6172 6420 3d20 7475 706c 6528 636f 6d70  ard = tuple(comp
+00021610: 7265 7373 2862 775f 666c 6174 5f73 6176  ress(bw_flat_sav
+00021620: 6564 5f66 6f72 5f62 6163 6b77 6172 642c  ed_for_backward,
+00021630: 2075 7365 645f 6d61 736b 2929 0a0a 2020   used_mask))..  
+00021640: 2020 2320 5765 206e 6565 6420 746f 2075    # We need to u
+00021650: 7064 6174 6520 7468 6520 7472 6163 6573  pdate the traces
+00021660: 2077 6974 6820 7468 6520 6e65 7720 7361   with the new sa
+00021670: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+00021680: 0a20 2020 205f 7570 6461 7465 5f66 6f72  .    _update_for
+00021690: 7761 7264 5f77 6974 685f 6e65 775f 7361  ward_with_new_sa
+000216a0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+000216b0: 2866 6f72 7761 7264 5f74 7261 6365 2c20  (forward_trace, 
+000216c0: 6f6e 6c79 5f75 7365 645f 6677 5f73 6176  only_used_fw_sav
+000216d0: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
+000216e0: 0a20 2020 205f 7570 6461 7465 5f62 6163  .    _update_bac
+000216f0: 6b77 6172 645f 7769 7468 5f6e 6577 5f73  kward_with_new_s
+00021700: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+00021710: 6428 6261 636b 7761 7264 5f74 7261 6365  d(backward_trace
+00021720: 2c20 6f6e 6c79 5f75 7365 645f 6277 5f73  , only_used_bw_s
+00021730: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+00021740: 6429 0a20 2020 2066 6f72 7761 7264 5f74  d).    forward_t
+00021750: 7261 6365 2e73 6574 5f70 726f 7665 6e61  race.set_provena
+00021760: 6e63 6528 5472 6163 6550 726f 7665 6e61  nce(TraceProvena
+00021770: 6e63 6528 2241 7567 6d65 6e74 6564 2066  nce("Augmented f
+00021780: 6f72 7761 7264 2070 6173 7322 2929 0a20  orward pass")). 
+00021790: 2020 2062 6163 6b77 6172 645f 7472 6163     backward_trac
+000217a0: 652e 7365 745f 7072 6f76 656e 616e 6365  e.set_provenance
+000217b0: 2854 7261 6365 5072 6f76 656e 616e 6365  (TraceProvenance
+000217c0: 2822 4261 636b 7761 7264 2070 6173 7322  ("Backward pass"
+000217d0: 2929 0a20 2020 2072 6574 7572 6e20 466f  )).    return Fo
+000217e0: 7277 6172 6442 6163 6b77 6172 6454 7261  rwardBackwardTra
+000217f0: 6365 7328 666f 7277 6172 645f 7472 6163  ces(forward_trac
+00021800: 652c 2062 6163 6b77 6172 645f 7472 6163  e, backward_trac
+00021810: 6529 0a0a 0a23 2064 6f20 7765 2068 6170  e)...# do we hap
+00021820: 7065 6e20 746f 2077 616e 7420 746f 2072  pen to want to r
+00021830: 6567 6973 7465 7220 606c 746f 7263 6860  egister `ltorch`
+00021840: 206f 7073 2073 7563 6820 6173 2060 6c74   ops such as `lt
+00021850: 6f72 6368 2e6c 6179 6572 5f6e 6f72 6d60  orch.layer_norm`
+00021860: 2061 7320 7765 6c6c 3f0a 6175 746f 6361   as well?.autoca
+00021870: 7374 5f69 6d70 6c73 3a20 6469 6374 5b70  st_impls: dict[p
+00021880: 7269 6d73 2e50 7269 6d49 4473 2c20 4361  rims.PrimIDs, Ca
+00021890: 6c6c 6162 6c65 5d20 3d20 7b7d 0a0a 0a64  llable] = {}...d
+000218a0: 6566 2072 6567 6973 7465 725f 6175 746f  ef register_auto
+000218b0: 6361 7374 5f72 756c 6528 6f70 293a 0a20  cast_rule(op):. 
+000218c0: 2020 2064 6566 2064 6563 6f72 6174 6f72     def decorator
+000218d0: 2866 756e 6329 3a0a 2020 2020 2020 2020  (func):.        
+000218e0: 6175 746f 6361 7374 5f69 6d70 6c73 5b6f  autocast_impls[o
+000218f0: 705d 203d 2066 756e 630a 2020 2020 2020  p] = func.      
+00021900: 2020 7265 7475 726e 2066 756e 630a 0a20    return func.. 
+00021910: 2020 2072 6574 7572 6e20 6465 636f 7261     return decora
+00021920: 746f 720a 0a0a 6465 6620 6d61 7962 655f  tor...def maybe_
+00021930: 646f 776e 6361 7374 5f74 6f28 6474 7970  downcast_to(dtyp
+00021940: 652c 2061 7267 7329 3a0a 2020 2020 616c  e, args):.    al
+00021950: 6c6f 7765 645f 646f 776e 6361 7374 5f74  lowed_downcast_t
+00021960: 7970 6573 203d 2028 6474 7970 6573 2e66  ypes = (dtypes.f
+00021970: 6c6f 6174 3136 2c20 6474 7970 6573 2e62  loat16, dtypes.b
+00021980: 666c 6f61 7431 362c 2064 7479 7065 732e  float16, dtypes.
+00021990: 666c 6f61 7433 3229 0a0a 2020 2020 6465  float32)..    de
+000219a0: 6620 6d61 705f 666e 2861 293a 0a20 2020  f map_fn(a):.   
+000219b0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+000219c0: 6365 2861 2c20 5465 6e73 6f72 5072 6f78  ce(a, TensorProx
+000219d0: 7929 2061 6e64 2061 2e64 7479 7065 2069  y) and a.dtype i
+000219e0: 6e20 616c 6c6f 7765 645f 646f 776e 6361  n allowed_downca
+000219f0: 7374 5f74 7970 6573 3a0a 2020 2020 2020  st_types:.      
+00021a00: 2020 2020 2020 7265 7475 726e 206d 6179        return may
+00021a10: 6265 5f63 6f6e 7665 7274 5f74 6f5f 6474  be_convert_to_dt
+00021a20: 7970 6528 612c 2064 7479 7065 290a 2020  ype(a, dtype).  
+00021a30: 2020 2020 2020 7265 7475 726e 2061 0a0a        return a..
+00021a40: 2020 2020 7265 7475 726e 2074 7265 655f      return tree_
+00021a50: 6d61 7028 6d61 705f 666e 2c20 6172 6773  map(map_fn, args
+00021a60: 290a 0a0a 4072 6567 6973 7465 725f 6175  )...@register_au
+00021a70: 746f 6361 7374 5f72 756c 6528 2274 6f72  tocast_rule("tor
+00021a80: 6368 2e6d 6174 6d75 6c22 290a 4072 6567  ch.matmul").@reg
+00021a90: 6973 7465 725f 6175 746f 6361 7374 5f72  ister_autocast_r
+00021aa0: 756c 6528 7072 696d 732e 5072 696d 4944  ule(prims.PrimID
+00021ab0: 732e 4d41 544d 554c 290a 6465 6620 6175  s.MATMUL).def au
+00021ac0: 746f 6361 7374 5f6d 6174 6d75 6c5f 7275  tocast_matmul_ru
+00021ad0: 6c65 2861 2c20 622c 2064 7479 7065 293a  le(a, b, dtype):
+00021ae0: 0a20 2020 2022 2222 4175 746f 6361 7374  .    """Autocast
+00021af0: 2072 756c 6520 666f 7220 6d61 746d 756c   rule for matmul
+00021b00: 2222 220a 2020 2020 7265 7475 726e 2070  """.    return p
+00021b10: 7269 6d73 2e6d 6174 6d75 6c28 2a28 6d61  rims.matmul(*(ma
+00021b20: 7962 655f 646f 776e 6361 7374 5f74 6f28  ybe_downcast_to(
+00021b30: 6474 7970 652c 2028 612c 2062 2929 2929  dtype, (a, b))))
+00021b40: 0a0a 0a40 7265 6769 7374 6572 5f61 7574  ...@register_aut
+00021b50: 6f63 6173 745f 7275 6c65 2822 746f 7263  ocast_rule("torc
+00021b60: 682e 6e6e 2e66 756e 6374 696f 6e61 6c2e  h.nn.functional.
+00021b70: 6c69 6e65 6172 2229 0a40 7265 6769 7374  linear").@regist
+00021b80: 6572 5f61 7574 6f63 6173 745f 7275 6c65  er_autocast_rule
+00021b90: 2870 7269 6d73 2e50 7269 6d49 4473 2e4c  (prims.PrimIDs.L
+00021ba0: 494e 4541 5229 0a64 6566 2061 7574 6f63  INEAR).def autoc
+00021bb0: 6173 745f 6c69 6e65 6172 5f72 756c 6528  ast_linear_rule(
+00021bc0: 612c 2077 2c20 6269 6173 2c20 6474 7970  a, w, bias, dtyp
+00021bd0: 6529 3a0a 2020 2020 6966 2062 6961 7320  e):.    if bias 
+00021be0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00021bf0: 2023 2044 6f6e 2774 2070 6173 7320 6062   # Don't pass `b
+00021c00: 6961 7360 2074 6f20 6d61 7962 655f 646f  ias` to maybe_do
+00021c10: 776e 6361 7374 5f74 6f2e 0a20 2020 2020  wncast_to..     
+00021c20: 2020 2064 6f77 6e63 6173 745f 6172 6773     downcast_args
+00021c30: 203d 206d 6179 6265 5f64 6f77 6e63 6173   = maybe_downcas
+00021c40: 745f 746f 2864 7479 7065 2c20 2861 2c20  t_to(dtype, (a, 
+00021c50: 7729 2920 2b20 2862 6961 732c 290a 2020  w)) + (bias,).  
+00021c60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00021c70: 646f 776e 6361 7374 5f61 7267 7320 3d20  downcast_args = 
+00021c80: 6d61 7962 655f 646f 776e 6361 7374 5f74  maybe_downcast_t
+00021c90: 6f28 6474 7970 652c 2028 612c 2077 2c20  o(dtype, (a, w, 
+00021ca0: 6269 6173 2929 0a0a 2020 2020 7265 7475  bias))..    retu
+00021cb0: 726e 2070 7269 6d73 2e6c 696e 6561 7228  rn prims.linear(
+00021cc0: 2a64 6f77 6e63 6173 745f 6172 6773 290a  *downcast_args).
+00021cd0: 0a0a 4072 6567 6973 7465 725f 6175 746f  ..@register_auto
+00021ce0: 6361 7374 5f72 756c 6528 2274 6f72 6368  cast_rule("torch
+00021cf0: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e73  .nn.functional.s
+00021d00: 6361 6c65 645f 646f 745f 7072 6f64 7563  caled_dot_produc
+00021d10: 745f 6174 7465 6e74 696f 6e22 290a 6465  t_attention").de
+00021d20: 6620 6175 746f 6361 7374 5f73 6361 6c65  f autocast_scale
+00021d30: 645f 646f 745f 7072 6f64 7563 745f 6174  d_dot_product_at
+00021d40: 7465 6e74 696f 6e28 0a20 2020 2071 7565  tention(.    que
+00021d50: 7279 2c0a 2020 2020 6b65 792c 0a20 2020  ry,.    key,.   
+00021d60: 2076 616c 7565 2c0a 2020 2020 6174 746e   value,.    attn
+00021d70: 5f6d 6173 6b2c 0a20 2020 2064 726f 706f  _mask,.    dropo
+00021d80: 7574 5f70 2c0a 2020 2020 6973 5f63 6175  ut_p,.    is_cau
+00021d90: 7361 6c2c 0a20 2020 202a 2c0a 2020 2020  sal,.    *,.    
+00021da0: 6474 7970 652c 0a20 2020 2073 6361 6c65  dtype,.    scale
+00021db0: 2c0a 293a 0a20 2020 2066 726f 6d20 7468  ,.):.    from th
+00021dc0: 756e 6465 722e 746f 7263 6820 696d 706f  under.torch impo
+00021dd0: 7274 2073 6361 6c65 645f 646f 745f 7072  rt scaled_dot_pr
+00021de0: 6f64 7563 745f 6174 7465 6e74 696f 6e0a  oduct_attention.
+00021df0: 0a20 2020 2071 2c20 6b2c 2076 203d 206d  .    q, k, v = m
+00021e00: 6179 6265 5f64 6f77 6e63 6173 745f 746f  aybe_downcast_to
+00021e10: 2864 7479 7065 2c20 2871 7565 7279 2c20  (dtype, (query, 
+00021e20: 6b65 792c 2076 616c 7565 2929 0a20 2020  key, value)).   
+00021e30: 2072 6574 7572 6e20 7363 616c 6564 5f64   return scaled_d
+00021e40: 6f74 5f70 726f 6475 6374 5f61 7474 656e  ot_product_atten
+00021e50: 7469 6f6e 2871 2c20 6b2c 2076 2c20 6174  tion(q, k, v, at
+00021e60: 746e 5f6d 6173 6b2c 2064 726f 706f 7574  tn_mask, dropout
+00021e70: 5f70 2c20 6973 5f63 6175 7361 6c2c 2073  _p, is_causal, s
+00021e80: 6361 6c65 3d73 6361 6c65 290a 0a0a 6465  cale=scale)...de
+00021e90: 6620 6175 746f 6361 7374 5f73 796d 626f  f autocast_symbo
+00021ea0: 6c5f 6d61 7070 6572 2862 6f75 6e64 5f73  l_mapper(bound_s
+00021eb0: 796d 626f 6c3a 2042 6f75 6e64 5379 6d62  ymbol: BoundSymb
+00021ec0: 6f6c 496e 7465 7266 6163 652c 2064 7479  olInterface, dty
+00021ed0: 7065 3a20 6474 7970 6573 2e64 7479 7065  pe: dtypes.dtype
+00021ee0: 293a 0a20 2020 2022 2222 5265 7475 726e  ):.    """Return
+00021ef0: 2074 6865 2063 616c 6c61 626c 6520 696d   the callable im
+00021f00: 706c 656d 656e 7469 6e67 2074 6865 2061  plementing the a
+00021f10: 7574 6f63 6173 7420 7275 6c65 2066 6f72  utocast rule for
+00021f20: 2074 6865 2073 796d 626f 6c2e 0a0a 2020   the symbol...  
+00021f30: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00021f40: 626f 756e 645f 7379 6d62 6f6c 3a20 4d61  bound_symbol: Ma
+00021f50: 7070 6564 2074 6f20 6974 7320 6175 746f  pped to its auto
+00021f60: 6361 7374 2072 756c 652e 0a0a 2020 2020  cast rule...    
+00021f70: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+00021f80: 2043 616c 6c61 626c 653a 2054 6865 2063   Callable: The c
+00021f90: 616c 6c61 626c 6520 696d 706c 656d 656e  allable implemen
+00021fa0: 7469 6e67 2074 6865 2061 7574 6f63 6173  ting the autocas
+00021fb0: 7420 7275 6c65 2066 6f72 2074 6865 2073  t rule for the s
+00021fc0: 796d 626f 6c2e 0a20 2020 2022 2222 0a20  ymbol..    """. 
+00021fd0: 2020 2061 7574 6f63 6173 745f 696d 706c     autocast_impl
+00021fe0: 3a20 4361 6c6c 6162 6c65 207c 204e 6f6e  : Callable | Non
+00021ff0: 6520 3d20 6175 746f 6361 7374 5f69 6d70  e = autocast_imp
+00022000: 6c73 2e67 6574 2862 6f75 6e64 5f73 796d  ls.get(bound_sym
+00022010: 626f 6c2e 7379 6d2e 6964 290a 2020 2020  bol.sym.id).    
+00022020: 7265 7475 726e 2062 6f75 6e64 5f73 796d  return bound_sym
+00022030: 626f 6c2e 7379 6d20 6966 2061 7574 6f63  bol.sym if autoc
+00022040: 6173 745f 696d 706c 2069 7320 4e6f 6e65  ast_impl is None
+00022050: 2065 6c73 6520 7061 7274 6961 6c28 6175   else partial(au
+00022060: 746f 6361 7374 5f69 6d70 6c2c 2064 7479  tocast_impl, dty
+00022070: 7065 3d64 7479 7065 290a 0a0a 6465 6620  pe=dtype)...def 
+00022080: 6175 746f 6361 7374 2866 756e 633a 2043  autocast(func: C
+00022090: 616c 6c61 626c 652c 2064 7479 7065 3a20  allable, dtype: 
+000220a0: 6474 7970 6573 2e64 7479 7065 293a 0a20  dtypes.dtype):. 
+000220b0: 2020 2022 2222 5472 616e 7366 6f72 6d73     """Transforms
+000220c0: 2061 2066 756e 6374 696f 6e20 746f 2061   a function to a
+000220d0: 7574 6f63 6173 7420 6365 7274 6169 6e20  utocast certain 
+000220e0: 6f70 6572 6174 696f 6e73 2e0a 0a20 2020  operations...   
+000220f0: 2041 7267 733a 0a20 2020 2020 2020 2066   Args:.        f
+00022100: 756e 633a 2054 6865 2066 756e 6374 696f  unc: The functio
+00022110: 6e20 746f 2062 6520 7472 616e 7366 6f72  n to be transfor
+00022120: 6d65 642e 0a20 2020 2020 2020 2064 7479  med..        dty
+00022130: 7065 3a20 5468 6520 6461 7461 2074 7970  pe: The data typ
+00022140: 6520 746f 2077 6869 6368 2061 7267 756d  e to which argum
+00022150: 656e 7473 206f 6620 7468 6520 6675 6e63  ents of the func
+00022160: 7469 6f6e 206f 7220 7375 6220 6675 6e63  tion or sub func
+00022170: 7469 6f6e 7320 636f 756c 6420 6765 7420  tions could get 
+00022180: 6361 7374 2069 660a 2020 2020 2020 2020  cast if.        
+00022190: 2020 2020 7468 6579 2061 7265 2060 6474      they are `dt
+000221a0: 7970 6573 2e66 6c6f 6174 3332 602e 0a0a  ypes.float32`...
+000221b0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+000221c0: 2020 2020 2043 616c 6c61 626c 653a 2054       Callable: T
+000221d0: 6865 2074 7261 6e73 666f 726d 6564 2066  he transformed f
+000221e0: 756e 6374 696f 6e0a 2020 2020 2222 220a  unction.    """.
+000221f0: 0a20 2020 2069 6620 6e6f 7420 6973 696e  .    if not isin
+00022200: 7374 616e 6365 2864 7479 7065 2c20 6474  stance(dtype, dt
+00022210: 7970 6573 2e64 7479 7065 293a 0a20 2020  ypes.dtype):.   
+00022220: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00022230: 4572 726f 7228 6622 6064 7479 7065 6020  Error(f"`dtype` 
+00022240: 6973 2065 7870 6563 7465 6420 746f 2062  is expected to b
+00022250: 6520 6074 6875 6e64 6572 2e64 7479 7065  e `thunder.dtype
+00022260: 2e64 7479 7065 6020 6275 7420 7b74 7970  .dtype` but {typ
+00022270: 6528 6474 7970 6529 7d22 290a 2020 2020  e(dtype)}").    
+00022280: 6966 2064 7479 7065 206e 6f74 2069 6e20  if dtype not in 
+00022290: 7b64 7479 7065 732e 666c 6f61 7431 362c  {dtypes.float16,
+000222a0: 2064 7479 7065 732e 6266 6c6f 6174 3136   dtypes.bfloat16
+000222b0: 7d3a 0a20 2020 2020 2020 2072 6169 7365  }:.        raise
+000222c0: 2056 616c 7565 4572 726f 7228 6622 6064   ValueError(f"`d
+000222d0: 7479 7065 6020 6973 2065 7870 6563 7465  type` is expecte
+000222e0: 6420 746f 2062 6520 6569 7468 6572 2060  d to be either `
+000222f0: 7468 756e 6465 722e 666c 6f61 7431 3660  thunder.float16`
+00022300: 206f 7220 6074 6875 6e64 6572 2e62 666c   or `thunder.bfl
+00022310: 6f61 7431 3660 2c20 6275 7420 7b64 7479  oat16`, but {dty
+00022320: 7065 7d22 290a 0a20 2020 2040 7772 6170  pe}")..    @wrap
+00022330: 7328 6675 6e63 290a 2020 2020 6465 6620  s(func).    def 
+00022340: 7772 6170 7065 7228 2a61 7267 732c 202a  wrapper(*args, *
+00022350: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+00022360: 2020 7472 6163 6520 3d20 636f 6e73 7472    trace = constr
+00022370: 7563 745f 7472 6163 6528 2928 6675 6e63  uct_trace()(func
+00022380: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+00022390: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+000223a0: 6e20 6576 616c 5f74 7261 6365 2874 7261  n eval_trace(tra
+000223b0: 6365 2c20 2a61 7267 732c 202a 2a6b 7761  ce, *args, **kwa
+000223c0: 7267 732c 2073 796d 626f 6c5f 6d61 7070  rgs, symbol_mapp
+000223d0: 6572 3d70 6172 7469 616c 2861 7574 6f63  er=partial(autoc
+000223e0: 6173 745f 7379 6d62 6f6c 5f6d 6170 7065  ast_symbol_mappe
+000223f0: 722c 2064 7479 7065 3d64 7479 7065 2929  r, dtype=dtype))
+00022400: 0a0a 2020 2020 7265 7475 726e 2077 7261  ..    return wra
+00022410: 7070 6572 0a                             pper.
```

### Comparing `lightning-thunder-0.1.0/thunder/core/utils.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/utils.py`

 * *Files 0% similar despite different names*

```diff
@@ -739,24 +739,21 @@
 
 class FrozenDict(_UserDictT[T, T1], Mapping[T, T1]):
     """Simple wrapper around `MappingProxyType` with various sugar.
     (More permissive ctor, type checking, etc.)
     """
 
     @overload
-    def __init__(self, data: Mapping[T, T1]) -> None:
-        ...
+    def __init__(self, data: Mapping[T, T1]) -> None: ...
 
     @overload
-    def __init__(self, data: Iterable[T, T1]) -> None:
-        ...
+    def __init__(self, data: Iterable[T, T1]) -> None: ...
 
     @overload
-    def __init__(self, *args: Any, **kwargs: Any) -> None:
-        ...
+    def __init__(self, *args: Any, **kwargs: Any) -> None: ...
 
     def __init__(self, *args, **kwargs) -> None:
         super().__init__(*args, **kwargs)
         self.data = MappingProxyType({**self.data})
 
     def __repr__(self) -> str:
         body = ", ".join(f"{k}: {v}" for k, v in self.items())
@@ -830,16 +827,15 @@
     for zipped in itertools.zip_longest(*args, fillvalue=null):
         if null in zipped:
             raise ValueError(f"length mismatch: {list(map(len, args))}")
         yield zipped
 
 
 @overload
-def safe_zip(x: Iterable[T], y: Iterable[T1], /) -> Iterable[tuple[T, T1]]:
-    ...
+def safe_zip(x: Iterable[T], y: Iterable[T1], /) -> Iterable[tuple[T, T1]]: ...
 
 
 def safe_zip(*args):
     """Zip args, which must all have the same length.
 
     Args:
         *args: arguments to zip
```

### Comparing `lightning-thunder-0.1.0/thunder/core/vjp_utils.py` & `lightning-thunder-0.2.0.dev20240404/thunder/core/vjp_utils.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,24 +1,35 @@
 import inspect
+from collections.abc import Callable
+from functools import wraps
 from inspect import Parameter, Signature
 from itertools import chain
-from collections.abc import Callable
 
 from thunder.core import prims, utils
 from thunder.core.prims import PrimIDs
-from thunder.core.proxies import variableify, Proxy
+from thunder.core.proxies import Proxy, variableify
 from thunder.core.pytree import tree_flatten, tree_map
 from thunder.core.symbol import BoundSymbol
 from thunder.core.trace import from_trace, TraceCtx
 from thunder.core.transform_common import dce
 
 
 _cache = {}
 
 
+def disable_caching_split_forward_and_backward(fn):
+    @wraps(fn)
+    def wrapper(*args, **kwargs):
+        return fn(*args, **kwargs)
+
+    wrapper._disable_caching = True
+
+    return wrapper
+
+
 def make_aug_forward_and_backward(bsym: BoundSymbol) -> tuple[Callable, Callable]:
     """
     Given a bound symbol, return a pair of forward and backward functions
     implementing the forward and backward passes for the given bound symbol.
 
     The forward function is the same as the original bound symbol's function,
     but with the addition of saving the intermediates from the forward function
@@ -42,15 +53,15 @@
     utils.check(
         joint_forward_backward is not None,
         lambda: f"Cannot generate forward and backward functions for {bsym.sym.name}",
     )
 
     key = (bsym.sym, subkey := _make_cache_key(bsym.args, bsym.kwargs))
     cached_result = _cache.get(key, None) if subkey is not None else None
-    if cached_result is not None:
+    if cached_result is not None and not getattr(joint_forward_backward, "_disable_caching", False):
         return cached_result
 
     joint_trace = thunder.trace(inline_trace=False, use_dce=False)(joint_forward_backward, *bsym.args, **bsym.kwargs)
     consumers = utils.consumers(joint_trace)
 
     def find_backward_input(forward_output):
         output_consumers = consumers.get(forward_output, None)
```

### Comparing `lightning-thunder-0.1.0/thunder/cudagraphs/__init__.py` & `lightning-thunder-0.2.0.dev20240404/thunder/cudagraphs/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/distributed/__init__.py` & `lightning-thunder-0.2.0.dev20240404/thunder/distributed/__init__.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,13 +1,14 @@
 import os
 from itertools import chain
 from contextlib import contextmanager
 from contextvars import ContextVar, Token
 from enum import auto, Enum
-from typing import TYPE_CHECKING
+from typing import TYPE_CHECKING, Any
+from collections.abc import Generator
 from functools import partial
 
 
 import torch
 import torch.distributed as tdist
 
 import thunder.core.utils as utils
@@ -54,29 +55,43 @@
     Returns:
         Whether to skip data parallel grad sync.
     """
     return _skip_data_parallel_grad_sync.get()
 
 
 @contextmanager
-def skip_data_parallel_grad_sync() -> None:
+def skip_data_parallel_grad_sync() -> Generator[Any, Any, Any]:
     """A context manager to skip data parallel grad sync."""
     token = set_skip_data_parallel_grad_sync(True)
     try:
         yield
     finally:
         reset_skip_data_parallel_grad_sync(token)
 
 
 def _sync_grads(module: torch.nn.Module) -> None:
     import thunder
 
+    if hasattr(module, "process_group_for_ddp"):
+        # This branch is required when a function that takes the model as an input is jitted instead
+        # of the model itself. In that case, the user won't have a reference to a `ThunderModule` so this needs to use
+        # the reference set by ddp and fsdp on the module directly
+        process_group = module.process_group_for_ddp
+    elif (cd := thunder.compile_data(module)) is not None:
+        # The ordinary jitted module branch
+        process_group = cd.process_group_for_ddp
+    else:
+        raise RuntimeError(
+            f"Expected `{type(module).__name__}` to have been jitted or to contain a `process_group_for_ddp` attribute"
+        )
+
     params_with_grad = [p for p in module.parameters() if p.grad is not None]
+    if not params_with_grad:
+        return
     grads = [p.grad for p in params_with_grad]
-    process_group = thunder.compile_data(module).process_group_for_ddp
     torch._foreach_div_(grads, process_group.size())
     with tdist.distributed_c10d._coalescing_manager(group=process_group, async_ops=True) as cm:
         for g in grads:
             tdist.distributed_c10d.all_reduce(g)
     cm.wait()
```

### Comparing `lightning-thunder-0.1.0/thunder/distributed/bucketing.py` & `lightning-thunder-0.2.0.dev20240404/thunder/distributed/bucketing.py`

 * *Files 1% similar despite different names*

```diff
@@ -136,15 +136,15 @@
     def _maybe_allreduce(self, bucket: Bucket, group: ProcessGroup) -> None:
         if bucket.recieved_all_tensors():
             self.bucket_to_future[bucket] = dist_prims.all_reduce(
                 bucket.pack(),
                 dist_prims.DistributedReduceOps.SUM,
                 group=group,
                 do_async=True,
-                skip_clone=False,
+                skip_clone=True,
             )
 
     def tell(self, grad: TensorProxy, group: ProcessGroup) -> None:
         bucket = self.grad_to_bucket[grad]
         bucket.tell(grad)
 
         self._maybe_allreduce(bucket, group)
```

### Comparing `lightning-thunder-0.1.0/thunder/distributed/checkpoint.py` & `lightning-thunder-0.2.0.dev20240404/thunder/distributed/checkpoint.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/distributed/prims.py` & `lightning-thunder-0.2.0.dev20240404/thunder/distributed/prims.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/distributed/transforms/ddp.py` & `lightning-thunder-0.2.0.dev20240404/thunder/distributed/transforms/ddp.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/distributed/transforms/fsdp.py` & `lightning-thunder-0.2.0.dev20240404/thunder/distributed/transforms/fsdp.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/distributed/utils.py` & `lightning-thunder-0.2.0.dev20240404/thunder/distributed/utils.py`

 * *Files 3% similar despite different names*

```diff
@@ -80,20 +80,20 @@
     order_in_trace = {bsym: i for i, bsym in enumerate(execution_trace.bound_symbols)}
 
     def prefer_comm_over_other_over_wait_over_allgather(eligible_nodes: list[Node]) -> int:
         # Prefer communication ops other than "all_gather_prim_impl" over other nodes and prefer other
         # nodes over "wait_prim_impl", pick "all_gather_prim_impl" last.
         def key(node: Node) -> int:
             match node.bsym.sym.id:
-                case (wait_prim_impl.id | unpack_for_fsdp_prim_impl.id):
+                case wait_prim_impl.id | unpack_for_fsdp_prim_impl.id:
                     return len(order_in_trace)
-                case (reduce_scatter_prim_impl.id | all_reduce_prim_impl.id):
+                case reduce_scatter_prim_impl.id | all_reduce_prim_impl.id:
                     # Prefer larger communication ops over smaller ones
                     return -node.bsym.args[0].numel
-                case (all_gather_prim_impl.id):
+                case all_gather_prim_impl.id:
                     return len(order_in_trace) + order_in_trace[node.bsym]
                 case _:
                     # Prefer nodes that are earlier in the trace
                     return order_in_trace[node.bsym]
 
         return max(range(len(eligible_nodes)), key=lambda i: key(eligible_nodes[i]))
 
@@ -137,17 +137,17 @@
     order_in_trace = {bsym: i for i, bsym in enumerate(execution_trace.bound_symbols)}
 
     def prefer_comm_over_other_over_wait(eligible_nodes: list[Node]) -> int:
         # Prefer communication ops over other nodes and prefer other
         # nodes over "wait_prim_impl"
         def key(node: Node) -> int:
             match node.bsym.sym.id:
-                case (wait_prim_impl.id):
+                case wait_prim_impl.id:
                     return len(order_in_trace)
-                case (reduce_scatter_prim_impl.id | all_reduce_prim_impl.id | all_gather_prim_impl.id):
+                case reduce_scatter_prim_impl.id | all_reduce_prim_impl.id | all_gather_prim_impl.id:
                     # Prefer larger communication ops over smaller ones
                     return -node.bsym.args[0].numel
                 case _:
                     # Prefer nodes that are earlier in the trace
                     return order_in_trace[node.bsym]
 
         return min(range(len(eligible_nodes)), key=lambda i: key(eligible_nodes[i]))
```

### Comparing `lightning-thunder-0.1.0/thunder/examine/__init__.py` & `lightning-thunder-0.2.0.dev20240404/thunder/examine/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/examine/memory_caculation.py` & `lightning-thunder-0.2.0.dev20240404/thunder/examine/memory_caculation.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/executors/__init__.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/executors/apex_entropyex.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/apex_entropyex.py`

 * *Files 22% similar despite different names*

```diff
@@ -7,18 +7,14 @@
 from lightning_utilities.core.imports import package_available
 
 import thunder.torch as ltorch
 from thunder.core.proxies import TensorProxy
 from thunder.core.symbol import Symbol
 from thunder.core.utils import check, same_shape
 from thunder.core.transforms import get_grad, put_grad, put_grads, mean_backward, restore_reduced_dims
-from thunder.core.transforms import (
-    register_augmented_forward_with_checker,
-    register_backward,
-)
 
 from thunder.extend import OperatorExecutor, register_executor
 
 __all__ = [
     "apex_ex",
 ]
 
@@ -193,84 +189,14 @@
     # than 30 and not a multiple of 4
     if a.shape[1] < 30 and a.shape[1] % 4 != 0:
         return False
 
     return True
 
 
-# Check out the 'add vjp rule' dev tutorial on how to add a VJP rule for any
-# Symbol. We use our new primitives to register a VJP rule for
-# torch.nn.functional.cross_entropy. This function is registered as the
-# augmented forward rule for torch.nn.functional.cross_entropy below
-def apex_cross_entropy_forward_rule(
-    a,
-    target,
-    weight=None,
-    size_average=None,
-    ignore_index=-100,
-    reduce=None,
-    reduction="mean",
-    label_smoothing=0.0,
-):
-    loss, max_log_sum_exp = apex_xentropy(
-        a,
-        target=target,
-        reduction=reduction,
-        label_smoothing=label_smoothing,
-    )
-    primal = loss
-    saved_for_backward = (a, target, max_log_sum_exp, reduction, label_smoothing)
-    return primal, saved_for_backward
-
-
-register_augmented_forward_with_checker(
-    apex_ex,
-    ltorch.cross_entropy.id,
-    _cross_entropy_checker,
-    apex_cross_entropy_forward_rule,
-)
-
-
-# This function is the backward rule for torch.nn.functional.cross_entropy. It
-# accepts the primal output and saved_for_backward from the forward pass and
-# returns the backward output. The backward output is a tuple of the backward
-# output for each differentiable Tensor input to the forward pass. In this case,
-# the forward pass has 1 such input, so the backward output is a single Tensor.
-# This function is registered as the backward rule for
-# torch.nn.functional.cross_entropy
-@register_backward((apex_ex, ltorch.cross_entropy.id))
-def apex_cross_entropy_backward_rule(
-    logits,
-    labels,
-    max_log_sum_exp,
-    reduction,
-    smoothing,
-    grad,
-):
-    from thunder.core.transforms import mean_backward, sum_backward
-
-    if reduction == "mean":
-        grad = mean_backward(max_log_sum_exp.ndim, max_log_sum_exp.shape, (0,), grad)
-    elif reduction == "sum":
-        grad = sum_backward(max_log_sum_exp.shape, (0,), grad)
-    elif reduction == "none":
-        pass
-    else:
-        raise ValueError(f"Invalid reduction: {reduction}")
-
-    grad_logits = apex_xentropy_bwd(
-        grad,
-        logits,
-        target=labels,
-        max_log_sum_exp=max_log_sum_exp,
-        label_smoothing=smoothing,
-    )
-    return grad_logits
-
-
 # Translate calls from torch.nn.functional.cross_entropy to apex_xentropy (when the checker above returns True)
 def _cross_entropy_transform(
     a: TensorProxy,
     /,
     target: TensorProxy,
     weight: None | TensorProxy = None,
     size_average: None | Any = None,
```

### Comparing `lightning-thunder-0.1.0/thunder/executors/cudnn_layernormex.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/cudnn_layernormex.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,43 +1,41 @@
 from typing import Any
 
 import torch
 import numpy as np
 
 from lightning_utilities.core.imports import package_available
 
-CUDNN_AVAILABLE = package_available("cudnn")
-
 cudnn: None | Any = None
 cudnn_backend_version: None | Any = None
-if CUDNN_AVAILABLE:
+if package_available("cudnn"):
     import cudnn
 
     cudnn_backend_version = cudnn.backend_version()
 
 
-def cudnn_available() -> bool:
-    return CUDNN_AVAILABLE
-
-
 # WARNING: cudnn layernorm executor is experimental. Tests that use cudnn might fail.
 from dataclasses import dataclass
 from functools import lru_cache
 from typing import Union, Dict
 
 import thunder.core.dtypes as dtypes
 from thunder.core.proxies import TensorProxy
 
 from thunder.executors.cudnnex import CudnnTensorAttributes, torch_to_cudnn_dtype
 
 
 def make_cacheable_cudnn_graph_inputs(func):
     def wrapper(*args, **kwargs):
         cudnn_input_args = [
-            CudnnTensorAttributes(arg.size(), arg.stride(), arg.dtype) if isinstance(arg, torch.Tensor) else arg
+            (
+                CudnnTensorAttributes(arg.size(), arg.stride(), arg.dtype, args.device_index)
+                if isinstance(arg, torch.Tensor)
+                else arg
+            )
             for arg in args
         ]
         return func(*cudnn_input_args, **kwargs)
 
     return wrapper
 
 
@@ -86,17 +84,19 @@
 # convert all tensor shapes to above format
 def _transform_layer_norm_inputs(a, normalized_shape, weight, bias):
     elements_to_normalize = np.prod(normalized_shape)
     batch_size = np.prod(a.shape[: -len(normalized_shape)], dtype=int)
 
     # Assume strides to be NCHW contiguous
     assumed_stride = (elements_to_normalize, 1, 1, 1)
-    a_4d = CudnnTensorAttributes((batch_size, elements_to_normalize, 1, 1), assumed_stride, a.dtype)
-    weight_4d = CudnnTensorAttributes((1, elements_to_normalize, 1, 1), assumed_stride, weight.dtype)
-    bias_4d = CudnnTensorAttributes((1, elements_to_normalize, 1, 1), assumed_stride, bias.dtype)
+    a_4d = CudnnTensorAttributes((batch_size, elements_to_normalize, 1, 1), assumed_stride, a.dtype, a.device.index)
+    weight_4d = CudnnTensorAttributes(
+        (1, elements_to_normalize, 1, 1), assumed_stride, weight.dtype, weight.device.index
+    )
+    bias_4d = CudnnTensorAttributes((1, elements_to_normalize, 1, 1), assumed_stride, bias.dtype, bias.device.index)
 
     return a_4d, weight_4d, bias_4d
 
 
 def layer_norm_impl(a, normalized_shape, weight=None, bias=None, eps=1e-5):
     a_4d, weight_4d, bias_4d = _transform_layer_norm_inputs(a, normalized_shape, weight, bias)
     input, scale, B, epsilon, Y, graph = _make_cudnn_layer_norm_graph(a_4d, weight_4d, bias_4d)
```

### Comparing `lightning-thunder-0.1.0/thunder/executors/cudnnex.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/cudnnex.py`

 * *Files 11% similar despite different names*

```diff
@@ -1,59 +1,85 @@
-from typing import Any, Optional
+from typing import Any
 
 import torch
 import numpy as np
 import random
 
 from lightning_utilities.core.imports import package_available
 
-CUDNN_AVAILABLE = package_available("cudnn")
+
+def cudnn_available() -> bool:
+    return package_available("cudnn")
+
+
+def cudnn_version() -> int:
+    if cudnn_available():
+        return cudnn.backend_version()
+    return 0
+
 
 cudnn: None | Any = None
 cudnn_backend_version: None | Any = None
-if CUDNN_AVAILABLE:
+if cudnn_available():
     import cudnn
 
     cudnn_backend_version = cudnn.backend_version()
-    cudnn_handle = cudnn.create_handle()
+    # Mapping from device to cudnn handles
+    device_to_cudnn_handle = {}
 
 
-def cudnn_available() -> bool:
-    return CUDNN_AVAILABLE
+# This function creates a new handle for the device that cudnn should
+# run its kernels on. As the suggested approach by cudnn is to make a few handles
+# as possible, this function caches these per-device handles.
+def _get_cudnn_handle(query_device):
+    handle = device_to_cudnn_handle.get(query_device, None)
+    if handle is None:
+        with torch.cuda.device(query_device):
+            handle = cudnn.create_handle()
+            device_to_cudnn_handle[query_device] = handle
+
+    # Make sure the user stream is set on the handle
+    # Fetch the current user stream and pass the data pointer to set_stream API
+    cudnn.set_stream(handle=handle, stream=torch.cuda.current_stream(device=query_device).cuda_stream)
+
+    return handle
 
 
+# WARNING: cudnn executor is experimental. Tests that use cudnn might fail.\n
+# Issue for tracking support: https://github.com/Lightning-AI/lightning-thunder/issues/880~
+
 from dataclasses import dataclass
 from functools import lru_cache
 from typing import Union, Dict
 
 from thunder.core.langctxs import langctx
 import thunder.core.dtypes as dtypes
 from thunder.torch import TensorLike
+from thunder.core.compile_data import get_compile_option
 from thunder.core.proxies import Proxy, TensorProxy
 
 
 from thunder.core.transforms import (
     get_grad,
     put_grad,
     put_grads,
-    register_augmented_forward_with_checker,
-    register_backward,
 )
 from thunder.extend import OperatorExecutor, register_executor
 import thunder.torch as ltorch
 
 cudnn_ex: OperatorExecutor = OperatorExecutor("cudnn", version=cudnn_backend_version)
 register_executor(cudnn_ex)
 
 
 @dataclass(frozen=True)
 class CudnnTensorAttributes:
     size: tuple
     stride: tuple
     dtype: torch.dtype
+    device_index: int
 
 
 from collections import OrderedDict
 
 
 # Cache already built cudnn graphs to save on runtime compilation overhead
 class CudnnexLRUCache(OrderedDict):
@@ -76,15 +102,17 @@
 
 
 _cudnnex_cache = CudnnexLRUCache(maxlen=1024)
 
 
 def _make_cudnn_sdpa_forward_graph(query, key, value, attn_mask, dropout_p, is_causal):
     graph = cudnn.pygraph(
-        intermediate_data_type=cudnn.data_type.FLOAT, compute_data_type=cudnn.data_type.FLOAT, handle=cudnn_handle
+        intermediate_data_type=cudnn.data_type.FLOAT,
+        compute_data_type=cudnn.data_type.FLOAT,
+        handle=_get_cudnn_handle(query.device_index),
     )
 
     Q = graph.tensor(name="Q", dim=query.size, stride=query.stride, data_type=torch_to_cudnn_dtype(query.dtype))
     K = graph.tensor(name="K", dim=key.size, stride=key.stride, data_type=torch_to_cudnn_dtype(key.dtype))
     V = graph.tensor(name="V", dim=value.size, stride=value.stride, data_type=torch_to_cudnn_dtype(value.dtype))
     Bias = None
     if attn_mask is not None:
@@ -183,36 +211,43 @@
         strides = [1] * len(shape)
         stride = 1
         for i in reversed(range(len(shape))):
             strides[i] = stride
             stride *= shape[i]
         return tuple(strides)
 
-    query_4d = CudnnTensorAttributes(query.shape, compute_NHWC_strides(query.shape), query.dtype)
+    query_4d = CudnnTensorAttributes(query.shape, compute_NHWC_strides(query.shape), query.dtype, query.device.index)
 
-    key_4d = CudnnTensorAttributes(key.shape, compute_NHWC_strides(key.shape), key.dtype)
+    key_4d = CudnnTensorAttributes(key.shape, compute_NHWC_strides(key.shape), key.dtype, key.device.index)
 
-    value_4d = CudnnTensorAttributes(value.shape, compute_NHWC_strides(value.shape), value.dtype)
+    value_4d = CudnnTensorAttributes(value.shape, compute_NHWC_strides(value.shape), value.dtype, value.device.index)
 
     attn_mask_4d = None
     if attn_mask is not None:
         # Make attn_mask to be of the same dimensionality as other input tensors
         attn_mask_shape = (1,) * (query.ndim - attn_mask.ndim) + attn_mask.shape
 
         # cudnn does not support boolean attn_mask, so make one with -inf
         attn_mask_dtype = query.dtype if attn_mask.dtype in [torch.bool, dtypes.bool8] else attn_mask.dtype
-        attn_mask_4d = CudnnTensorAttributes(attn_mask_shape, compute_NHWC_strides(attn_mask_shape), attn_mask_dtype)
+        attn_mask_4d = CudnnTensorAttributes(
+            attn_mask_shape, compute_NHWC_strides(attn_mask_shape), attn_mask_dtype, attn_mask.device.index
+        )
 
     return query_4d, key_4d, value_4d, attn_mask_4d
 
 
 # sdpa requires that the embedding dim stride be one.
 # And when registering for sdpa, cudnn assumes NHWC layout. (See _transform_sdpa_inputs())
 def _sdpa_enforce_input_tensor_contiguity(a: torch.Tensor) -> torch.Tensor:
     if a.stride(-1) == 1:
+        # TODO(vedaanta-nvidia): there's an inconsistency between
+        # _transform_sdpa_inputs and this function, leading to a potential bug.
+        # _transform_sdpa_inputs always creates contiguous strides, but code
+        # here creates a partially contiguous stride when the last dimension is
+        # contiguous but other dimensions are not.
         return a
     else:
         return a.contiguous()
 
 
 def _cudnn_sdpa_forward_meta(
     query: TensorLike,
@@ -300,94 +335,73 @@
         Offset: offset_tensor,
         O: O_actual,
         softmax_stats: softmax_stats_actual,
     }
     if attn_mask is not None:
         cudnn_to_torch_tensor[Bias] = attn_mask.detach()
 
-    graph.execute(cudnn_to_torch_tensor, workspace)
+    # Even though the handle is created on query.device, cudnn still requires to set current device to query.device.
+    # This is most probably a bug and is being actively looked into.
+    with torch.cuda.device(query.device):
+        graph.execute(cudnn_to_torch_tensor, workspace, handle=_get_cudnn_handle(query.device))
 
     return O_actual, softmax_stats_actual, seed_tensor, offset_tensor
 
 
-# NOTE Uses the torch language context to resolve .size calls
-@langctx("torch")
-def _cudnn_sdpa_forward_checker(
+def _cudnn_sdpa_checker(
     query: TensorLike,
     key: TensorLike,
     value: TensorLike,
     attn_mask: TensorLike | None = None,
     dropout_p: float = 0.0,
     is_causal: bool = False,
     *,
     scale: float | None = None,
 ) -> bool:
+    # TODO(#58): make the checker more conservative.
     if cudnn is None:
         return False
 
-    query_4d, key_4d, value_4d, attn_mask_4d = _transform_sdpa_inputs(query, key, value, attn_mask)
+    if len(query.size()) != 4:
+        return False
+    _, _, _, d_q = query.size()
 
-    try:
-        _make_cudnn_sdpa_forward_graph(query_4d, key_4d, value_4d, attn_mask_4d, dropout_p, is_causal)
-    except Exception as e:
+    if len(value.size()) != 4:
         return False
+    _, _, _, d_kv = value.size()
 
     # Bug in cudnn 8.9.5 and earlier where embedding dim support is missing
-    _, _, _, d_q = query.size()
-    _, _, _, d_kv = value.size()
     for d in [d_q, d_kv]:
         if d % 8 != 0 or d > 128:
             return False
 
     return True
 
 
-@langctx("torch")
-def _cudnn_sdpa_backward_checker(
-    query: TensorLike,
-    key: TensorLike,
-    value: TensorLike,
-    attn_mask: TensorLike | None = None,
-    dropout_p: float = 0.0,
-    is_causal: bool = False,
-    *,
-    scale: float | None = None,
-) -> bool:
-    if cudnn is None:
-        return False
-
-    query_4d, key_4d, value_4d, attn_mask_4d = _transform_sdpa_inputs(query, key, value, attn_mask)
-
-    try:
-        _make_cudnn_sdpa_backward_graph(query_4d, key_4d, value_4d, attn_mask_4d, dropout_p, is_causal)
-    except Exception as e:
-        return False
-
-    return True
-
-
 cudnn_sdpa_fwd = cudnn_ex.register_operator(
     "cudnn_sdpa_fwd",
     meta=_cudnn_sdpa_forward_meta,
     fn=_cudnn_sdpa_fwd_impl,
 )
 
 
-def _make_cudnn_sdpa_backward_graph(query, key, value, attn_mask, dropout_p, is_causal):
+def _make_cudnn_sdpa_backward_graph(
+    query, key, value, attn_mask, dropout_p, is_causal, grad_query_stride, grad_key_stride, grad_value_stride
+):
     b, h, s_q, _ = query.size
     _, _, _, d_v = value.size
 
     # cuDNN < 9.0.0 might produce nan gradients for sequence length < 64
     assert s_q >= 64, "CUDNN SDPA requires sequence length to be at least 64 for backward pass"
 
     graph = cudnn.pygraph(
         io_data_type=torch_to_cudnn_dtype(query.dtype),
         intermediate_data_type=cudnn.data_type.FLOAT,
         compute_data_type=cudnn.data_type.FLOAT,
-        handle=cudnn_handle,
+        handle=_get_cudnn_handle(query.device_index),
     )
 
     Q = graph.tensor(name="Q", dim=query.size, stride=query.stride, data_type=torch_to_cudnn_dtype(query.dtype))
     K = graph.tensor(name="K", dim=key.size, stride=key.stride, data_type=torch_to_cudnn_dtype(key.dtype))
     V = graph.tensor(name="V", dim=value.size, stride=value.stride, data_type=torch_to_cudnn_dtype(value.dtype))
 
     dim_o = (b, h, s_q, d_v)
@@ -438,17 +452,21 @@
         attn_scale=Attn_scale,
         bias=Bias,
         dBias=dBias,
         use_causal_mask=is_causal,
         dropout=dropout_tuple,
     )
 
-    dQ.set_output(True).set_dim(query.size).set_stride(query.stride).set_data_type(torch_to_cudnn_dtype(query.dtype))
-    dK.set_output(True).set_dim(key.size).set_stride(key.stride).set_data_type(torch_to_cudnn_dtype(key.dtype))
-    dV.set_output(True).set_dim(value.size).set_stride(value.stride).set_data_type(torch_to_cudnn_dtype(value.dtype))
+    dQ.set_output(True).set_dim(query.size).set_stride(grad_query_stride).set_data_type(
+        torch_to_cudnn_dtype(query.dtype)
+    )
+    dK.set_output(True).set_dim(key.size).set_stride(grad_key_stride).set_data_type(torch_to_cudnn_dtype(key.dtype))
+    dV.set_output(True).set_dim(value.size).set_stride(grad_value_stride).set_data_type(
+        torch_to_cudnn_dtype(value.dtype)
+    )
 
     # Validate the graph before querying the cache key
     # Validation makes sure all missing properties are inferred and filled, as they affect cache key.
     graph.validate()
     cache_key = graph.key()
 
     # If a built graph does not exist in cache already, make one and place it in
@@ -474,56 +492,109 @@
             dV,
             dBias,
             graph,
         )
     return _cudnnex_cache[cache_key]
 
 
-def cudnn_sdpa_backward_meta(
+def _replace_dim_with(size: torch.Size, dim: int, dim_size: int) -> torch.Size:
+    return torch.Size(size[:dim] + (dim_size,) + size[dim + 1 :])
+
+
+def _cudnn_sdpa_bwd_meta(
     grad_out: TensorLike,
     query: TensorLike,
     key: TensorLike,
     value: TensorLike,
     attn_mask: None | TensorProxy,
     dropout_p: float,
     is_causal: bool,
     out: TensorLike,
     softmax_stats: TensorLike,
     philox_seed: TensorLike,
     philox_offset: TensorLike,
     *,
     scale: None | float = None,
-) -> (TensorProxy, TensorProxy, TensorProxy):
-    grad_query = TensorProxy(like=query)
-    grad_key = TensorProxy(like=key)
-    grad_value = TensorProxy(like=value)
+    cat_grad_qkv: bool,
+) -> tuple[TensorProxy, ...]:
+    if cat_grad_qkv:
+        grad_qkv = TensorProxy(
+            like=query, shape=_replace_dim_with(query.size(), 1, query.size(1) + key.size(1) + value.size(1))
+        )
+        grads = (grad_qkv,)
+    else:
+        grad_query = TensorProxy(like=query)
+        grad_key = TensorProxy(like=key)
+        grad_value = TensorProxy(like=value)
+        grads = (grad_query, grad_key, grad_value)
 
     if attn_mask is not None:
-        grad_attn_mask = TensorProxy(like=attn_mask, shape=attn_mask.shape)
-        return (grad_query, grad_key, grad_value, grad_attn_mask)
-    else:
-        return (grad_query, grad_key, grad_value)
+        grad_attn_mask = TensorProxy(like=attn_mask)
+        grads = grads + (grad_attn_mask,)
+
+    return grads
 
 
-def cudnn_sdpa_bwd_impl(
+def _same_size_except(*args, except_dim: int) -> bool:
+    shapes = [_replace_dim_with(shape, except_dim, 0) for shape in args]
+    return all(shape == shapes[0] for shape in shapes)
+
+
+# Allocates an empty tensor that will hold dQ, dK, and dV, concatenated.
+# `query`, `key` and `value` merely provide necessary metadata such as sizes
+# and dtypes. They don't have to be passed in as `torch.Tensor`s.
+def _allocate_catted_grad_qkv(
+    query: torch.Tensor,
+    key: torch.Tensor,
+    value: torch.Tensor,
+) -> torch.Tensor:
+    assert _same_size_except(query.size(), key.size(), value.size(), except_dim=1)
+    assert query.dtype == key.dtype == value.dtype
+    assert query.device == key.device == value.device
+
+    b, s, d = query.size(0), query.size(2), query.size(3)
+    h_q, h_k, h_v = query.size(1), key.size(1), value.size(1)
+    h_qkv = h_q + h_k + h_v
+
+    # Create grad_qkv as a tensor of size [b,h_qkv,s,d] and allocation order
+    # [0,2,1,3] from major to minor.
+    return torch.empty(b, s, h_qkv, d, dtype=query.dtype, device=query.device).permute(0, 2, 1, 3)
+
+
+def _cudnn_sdpa_bwd_impl(
     grad_out: torch.Tensor,
     query: torch.Tensor,
     key: torch.Tensor,
     value: torch.Tensor,
     attn_mask: None | torch.Tensor,
     dropout_p: float,
     is_causal: bool,
     out: torch.Tensor,
     softmax_stats: torch.Tensor,
     philox_seed: torch.Tensor,
     philox_offset: torch.Tensor,
     *,
     scale: None | float = None,
-) -> (torch.Tensor, torch.Tensor, torch.Tensor):
+    cat_grad_qkv: bool,
+) -> tuple[torch.Tensor, ...]:
     query_4d, key_4d, value_4d, attn_mask_4d = _transform_sdpa_inputs(query, key, value, attn_mask)
+    query = _sdpa_enforce_input_tensor_contiguity(query)
+    key = _sdpa_enforce_input_tensor_contiguity(key)
+    value = _sdpa_enforce_input_tensor_contiguity(value)
+
+    # When cat_grad_qkv is on, allocate dQKV and make dQ, dK, and dV
+    # slices of that. Otherwise, allocate them individually.
+    grad_qkv: None | torch.Tensor = None
+    if cat_grad_qkv:
+        grad_qkv = _allocate_catted_grad_qkv(query, key, value)
+        grad_query, grad_key, grad_value = grad_qkv.split([query.size(1), key.size(1), value.size(1)], dim=1)
+    else:
+        grad_query = torch.empty_like(query)
+        grad_key = torch.empty_like(key)
+        grad_value = torch.empty_like(value)
 
     (
         Q,
         K,
         V,
         O,
         dO,
@@ -540,24 +611,19 @@
     ) = _make_cudnn_sdpa_backward_graph(
         query_4d,
         key_4d,
         value_4d,
         attn_mask_4d,
         dropout_p,
         is_causal,
+        grad_query.stride(),
+        grad_key.stride(),
+        grad_value.stride(),
     )
 
-    query = _sdpa_enforce_input_tensor_contiguity(query)
-    key = _sdpa_enforce_input_tensor_contiguity(key)
-    value = _sdpa_enforce_input_tensor_contiguity(value)
-
-    grad_query = torch.empty_like(query)
-    grad_key = torch.empty_like(key)
-    grad_value = torch.empty_like(value)
-
     # Default value of scale, if not provided, in all torch versions
     if scale is None:
         scale = query.shape[-1] ** -0.5
     Attn_scale_cpu = torch.full((1, 1, 1, 1), scale, dtype=torch.float32, device="cpu")
 
     cudnn_to_torch_tensor = {
         dO: grad_out.detach(),
@@ -582,124 +648,38 @@
         grad_attn_mask = torch.empty_like(attn_mask) if attn_mask is not None else None
 
         cudnn_to_torch_tensor[Bias] = attn_mask.detach()
         cudnn_to_torch_tensor[dBias] = grad_attn_mask
 
     workspace = torch.empty(graph.get_workspace_size(), device=query.device, dtype=torch.uint8)
 
-    graph.execute(cudnn_to_torch_tensor, workspace)
+    # Even though the handle is created on query.device, cudnn still requires to set current device to query.device.
+    # This is most probably a bug and is being actively looked into.
+    with torch.cuda.device(query.device):
+        graph.execute(cudnn_to_torch_tensor, workspace, handle=_get_cudnn_handle(query.device))
 
-    if attn_mask is None:
-        return grad_query, grad_key, grad_value
+    if cat_grad_qkv:
+        grads = (grad_qkv,)
     else:
-        return grad_query, grad_key, grad_value, grad_attn_mask
+        grads = (grad_query, grad_key, grad_value)
+
+    if attn_mask is not None:
+        grads = grads + (grad_attn_mask,)
+    return grads
 
 
 cudnn_sdpa_bwd = cudnn_ex.register_operator(
     "cudnn_sdpa_bwd",
-    meta=cudnn_sdpa_backward_meta,
-    fn=cudnn_sdpa_bwd_impl,
-)
-
-
-@langctx("torch")
-def cudnn_sdpa_aug_fw_rule_checker(
-    query: TensorProxy,
-    key: TensorProxy,
-    value: TensorProxy,
-    attn_mask: None | TensorProxy,
-    dropout_p: float,
-    is_causal: bool,
-    *,
-    scale: None | float,
-) -> bool:
-    from thunder.core.compile_data import get_compile_data
-
-    cd = get_compile_data()
-    if cudnn_ex in cd.executors_list:
-        is_forward_supported = _cudnn_sdpa_forward_checker(
-            query, key, value, attn_mask, dropout_p, is_causal, scale=scale
-        )
-        is_backward_supported = _cudnn_sdpa_backward_checker(
-            query, key, value, attn_mask, dropout_p, is_causal, scale=scale
-        )
-        return is_forward_supported and is_backward_supported
-    return False
-
-
-def cudnn_sdpa_aug_fw_rule(
-    query,
-    key,
-    value,
-    attn_mask=None,
-    dropout_p: float = 0.0,
-    is_causal: bool = False,
-    *,
-    scale: float | None = None,
-):
-    output, softmax_stats, seed, offset = cudnn_sdpa_fwd(
-        query, key, value, attn_mask, dropout_p, is_causal, scale=scale
-    )
-    saved_for_backward = (
-        query,
-        key,
-        value,
-        attn_mask,
-        dropout_p,
-        is_causal,
-        scale,
-        output,
-        softmax_stats,
-        seed,
-        offset,
-    )
-    return output, saved_for_backward
-
-
-register_augmented_forward_with_checker(
-    cudnn_ex,
-    "torch.nn.functional.scaled_dot_product_attention",
-    cudnn_sdpa_aug_fw_rule_checker,
-    cudnn_sdpa_aug_fw_rule,
+    meta=_cudnn_sdpa_bwd_meta,
+    fn=_cudnn_sdpa_bwd_impl,
 )
 
 
-@register_backward((cudnn_ex, "torch.nn.functional.scaled_dot_product_attention"))
-def cudnn_sdpa_backward_rule(
-    query: Proxy,
-    key: Proxy,
-    value: Proxy,
-    attn_mask: None | Proxy,
-    dropout_p: float,
-    is_causal: bool,
-    scale: None | float,
-    out: Proxy,
-    softmax_stats: Proxy,
-    seed: Proxy,
-    offset: Proxy,
-    grad_out: Proxy,
-):
-    return cudnn_sdpa_bwd(
-        grad_out,
-        query,
-        key,
-        value,
-        attn_mask,
-        dropout_p,
-        is_causal,
-        out,
-        softmax_stats,
-        seed,
-        offset,
-        scale=scale,
-    )
-
-
 @langctx("torch")
-def _cudnn_sdpa_transform(
+def _cudnn_sdpa_fwd_wrapper(
     query: TensorProxy,
     key: TensorProxy,
     value: TensorProxy,
     attn_mask: None | TensorProxy = None,
     dropout_p: float = 0.0,
     is_causal: bool = False,
     *,
@@ -707,50 +687,73 @@
 ) -> TensorProxy:
     output, _, _, _ = cudnn_sdpa_fwd(query, key, value, attn_mask, dropout_p, is_causal, scale=scale)
 
     return output
 
 
 @langctx("torch")
-def _cudnn_sdpa_grad(
+def _cudnn_sdpa_bwd_wrapper(
     query: TensorProxy,
     key: TensorProxy,
     value: TensorProxy,
     attn_mask: None | TensorProxy,
     dropout_p: float = 0.0,
     is_causal: bool = False,
     *,
     scale: None | float = None,
 ):
     primal, softmax_stats, seed, offset = cudnn_sdpa_fwd(
         query, key, value, attn_mask, dropout_p, is_causal, scale=scale
     )
 
-    g = get_grad(primal)
-    grad_query, grad_key, grad_val, grad_attn_mask = cudnn_sdpa_bwd(
-        g,
+    description = """\
+This flag is for enabling nvFuser's zipping optimization that seeks to avoid
+expensive concatenation. https://github.com/NVIDIA/Fuser/issues/1768 has more
+details. When this flag is true, cudnn_sdpa_bwd may cat dQ, dK and dV as one
+tensor and return them as slices of that tensor.
+"""
+    may_cat_grad_qkv: None | bool = get_compile_option("cudnn_sdpa_bwd_may_cat_grad_qkv", description)
+    if may_cat_grad_qkv is None:
+        may_cat_grad_qkv = False
+    assert isinstance(may_cat_grad_qkv, bool)
+    cat_grad_qkv = may_cat_grad_qkv and _same_size_except(query.size(), key.size(), value.size(), except_dim=1)
+
+    grads = cudnn_sdpa_bwd(
+        get_grad(primal),
         query,
         key,
         value,
         attn_mask,
         dropout_p,
         is_causal,
         primal,
         softmax_stats,
         seed,
         offset,
         scale=scale,
+        cat_grad_qkv=cat_grad_qkv,
     )
-    put_grads((query, key, value), (grad_query, grad_key, grad_val))
+
     if attn_mask is not None:
+        grad_attn_mask = grads[-1]
+        grads = grads[:-1]
         put_grad(attn_mask, grad_attn_mask)
 
+    if cat_grad_qkv:
+        # The `split` is done outside `cudnn_sdpa_bwd` so it can be picked up
+        # by nvfuserex.
+        (grad_qkv,) = grads
+        grad_query, grad_key, grad_value = grad_qkv.split([query.size(1), key.size(1), value.size(1)], dim=1)
+    else:
+        grad_query, grad_key, grad_value = grads
+    put_grads((query, key, value), (grad_query, grad_key, grad_value))
+
     return primal
 
 
 # Registers the implementation for torch.nn.functional.scaled_dot_product_attention
 cudnn_ex.register_implementation(
     ltorch.scaled_dot_product_attention,
-    checker=_cudnn_sdpa_forward_checker,
-    execution_transform=_cudnn_sdpa_transform,
-    grad_transform=_cudnn_sdpa_grad,
+    checker=_cudnn_sdpa_checker,
+    execution_transform=_cudnn_sdpa_fwd_wrapper,
+    grad_transform=_cudnn_sdpa_bwd_wrapper,
 )
```

### Comparing `lightning-thunder-0.1.0/thunder/executors/data_dependent_partition.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/data_dependent_partition.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/executors/nvfuserex.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/nvfuserex.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/executors/nvfuserex_impl.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/nvfuserex_impl.py`

 * *Files 2% similar despite different names*

```diff
@@ -783,15 +783,15 @@
             #   may be suboptimal for real-world performance.
             #   Provide a mechanism to switch between "test" and "perf" modes
             #   so that we can continue to generate single node fusions when testing.
             # if len(bsyms) > 1:
             region = Region(producers, consumers, bsyms)
 
             # Acquires the nv_enable_bookend compile option, which defaults to True
-            bookend_help = """
+            bookend_help = """\
 nvFuser's 'bookending' heuristic tries to gather metadata operations---such as
 transpose, reshape, or view---into the beginning and ends of blocks that utilize
 nvFuser. By pushing these ops to the edges, they will get dropped by the nvFuser
 executor and picked up by other executors, such as Torch's eager mode, that will
 often just instantly return an alias. For some complicated cases (typically when
 the metadata operation is awkward enough to force the output tensor to be
 instantiated) this heuristic actually leads to worse code.
@@ -1083,28 +1083,22 @@
     return fd.ops.broadcast_in_dim(nva, shape, broadcast_dimensions)
 
 
 register_supported(PrimIDs.BROADCAST_IN_DIM, broadcast_in_dim, _broadcast_in_dim_check)
 
 
 def _cat_check(tensors: list[TensorProxy], dim: int) -> bool:
-    # nvFuser cat fusion is currently disabled due to issue:
-    #   "nvFuser doesn't support cating with an empty tensor"
-    return False
+    if nv_version < LooseVersion("0.1.7"):
+        return False
 
     # Validates tensors and concatenated dimension lengths
     for t in tensors:
         if not is_supported_tensor(t):
             return False
 
-        # See https://github.com/NVIDIA/Fuser/issues/21
-        #   nvFuser cannot concatenate dimensions of length 1
-        if t.shape[dim] == 1:
-            return False
-
     return True
 
 
 # NOTE nvFuser's cat prim accepts dim as a Python Number, not a constant
 def cat(tensors: list[TensorProxy], dim: int, *, fd: FusionDefinition, lc_to_nv_map: dict) -> Any:
     nvtensors = list(getnv(t, fd, lc_to_nv_map) for t in tensors)
 
@@ -2002,14 +1996,54 @@
     nvdims = list(dim)
     return fd.ops.var_mean(nva, nvdims, correction)
 
 
 register_supported(PrimIDs.VAR_MEAN, var_mean, _var_mean_check)
 
 
+def _batch_norm_check(
+    a: TensorProxy,
+    weight: None | TensorProxy,
+    bias: None | TensorProxy,
+    running_mean: None | TensorProxy,
+    running_var: None | TensorProxy,
+    training: bool,
+    momentum: Number,
+    eps: Number,
+) -> bool:
+    return are_supported_tensors(*(x for x in (a, weight, bias, running_mean, running_var) if x is not None))
+
+
+def batch_norm(
+    a: TensorProxy,
+    weight: None | TensorProxy,
+    bias: None | TensorProxy,
+    running_mean: None | TensorProxy,
+    running_var: None | TensorProxy,
+    training: bool,
+    momentum: Number,
+    eps: Number,
+    *,
+    fd: FusionDefinition,
+    lc_to_nv_map: dict,
+) -> Any:
+    nva = getnv(a, fd, lc_to_nv_map)
+    nvweight = None if weight is None else getnv(weight, fd, lc_to_nv_map)
+    nvbias = None if bias is None else getnv(bias, fd, lc_to_nv_map)
+    nvrunning_mean = None if running_mean is None else getnv(running_mean, fd, lc_to_nv_map)
+    nvrunning_var = None if running_var is None else getnv(running_var, fd, lc_to_nv_map)
+    nvmomentum = getnv(momentum, fd, lc_to_nv_map)
+    nveps = getnv(eps, fd, lc_to_nv_map)
+
+    return fd.ops.batch_norm(nva, nvweight, nvbias, nvrunning_mean, nvrunning_var, nvmomentum, nveps, training)
+
+
+register_supported(PrimIDs.BATCH_NORM, batch_norm, _batch_norm_check)
+
+
 # Removes excessive float casts, like those that occur when autocasting
 # NOTE This passes actually changes a program's semantics, because it will take a sequence like
 #   fp32 -> fp16 -> fp32 and remove all the operations, but casting fp32 values to fp16 can
 #   changes the values (because most fp32 values are not representable in fp16)
 # NOTE This only handles conversions performed by CONVERT_ELEMENT_TYPE, and not conversions caused
 #   by other Symbols, like torch.to, which may be unflattened
 # TODO This could be extended to non-float conversions, like complex -> complex conversions
```

### Comparing `lightning-thunder-0.1.0/thunder/executors/passes.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/passes.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/executors/pythonex.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/pythonex.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/executors/sdpaex.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/sdpaex.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/executors/torch_autograd.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/torch_autograd.py`

 * *Files 1% similar despite different names*

```diff
@@ -198,15 +198,15 @@
     flat_args, _ = tree_flatten((args, kwargs))
     tensor_cls = (torch.Tensor, TensorProxy)
     requires_grad_mask = tuple(isinstance(arg, tensor_cls) and arg.requires_grad for arg in flat_args)
     # If none of the inputs require gradients, raise an error
     if not any(requires_grad_mask):
         raise RuntimeError("PyTorch's Autograd interface requires at least one tensor input with requires_grad=True")
 
-    primal_trace = make_trace(func)(*args, **kwargs)
+    primal_trace = make_trace(func)(*args, **kwargs) if not compile_data.using_jit else computation_trc
     primal_trace = sort_data_parallel_syncs(primal_trace)
 
     if compile_stats is not None:
         compile_stats.last_traces.append(primal_trace)
 
     # torch.autograd.Function doesn't support non-flat outputs, the
     # grads wouldn't be propagated and backward receives None for each
```

### Comparing `lightning-thunder-0.1.0/thunder/executors/torch_compile.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/torch_compile.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/executors/torchex.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/torchex.py`

 * *Files 1% similar despite different names*

```diff
@@ -739,25 +739,27 @@
 _register_elementwise_unary_implementation(ltorch.trunc, trunc)
 _register_elementwise_unary_implementation(ltorch.real, real)
 
 # nn.functional elementwise unary
 gelu = _register_torch_operation("gelu", module=torch.nn.functional)
 relu = _register_torch_operation("relu", module=torch.nn.functional)
 relu6 = _register_torch_operation("relu6", module=torch.nn.functional)
+hardswish = _register_torch_operation("hardswish", module=torch.nn.functional)
 selu = _register_torch_operation("selu", module=torch.nn.functional)
 silu = _register_torch_operation("silu", module=torch.nn.functional)
 
 
 def _elementwise_unary_with_inplace_checker(a: TensorProxy, /, inplace: bool = False) -> bool:
     return isinstance(a, TensorProxy) and not inplace
 
 
 _register_elementwise_unary_implementation(ltorch.gelu, gelu, checker=_always_executable)
 _register_elementwise_unary_implementation(ltorch.relu, relu, checker=_elementwise_unary_with_inplace_checker)
 _register_elementwise_unary_implementation(ltorch.relu6, relu6, checker=_elementwise_unary_with_inplace_checker)
+_register_elementwise_unary_implementation(ltorch.hardswish, hardswish, checker=_elementwise_unary_with_inplace_checker)
 _register_elementwise_unary_implementation(ltorch.selu, selu, checker=_elementwise_unary_with_inplace_checker)
 _register_elementwise_unary_implementation(ltorch.silu, silu)
 
 #
 # Elementwise binary operations
 #
 # TODO Review type promotion differences
@@ -1005,14 +1007,15 @@
 prod = _register_torch_operation("prod", module=torch._refs)
 sum = _register_torch_operation("sum")
 cumsum = _register_torch_operation("cumsum")
 var = _register_torch_operation("var")
 var_mean = _register_torch_operation("var_mean")
 argmax = _register_torch_operation("argmax")
 argmin = _register_torch_operation("argmin")
+topk = _register_torch_operation("topk")
 
 
 # NOTE The following transforms are necessary because thunder uses the parameter name 'dims' while PyTorch
 #   uses 'dim'
 def _amax_prim_transform(a: TensorProxy, /, dims: Sequence[int]) -> TensorProxy:
     return amax(a, dims)
 
@@ -1049,33 +1052,46 @@
     return argmax(a, dim)
 
 
 def _argmin_transform(a: TensorProxy, /, dim: int):
     return argmin(a, dim)
 
 
+# NOTE This transform translates number proxies to boolean values
+# and handles dim = None
+def _topk_transform(
+    a: TensorProxy, /, k: int, dim: int | None = None, largest: Number = 1, sorted: Number = 1, *, out=None
+):
+    if dim is None:
+        dim = a.ndim - 1 if a.ndim > 0 else 0
+
+    return topk(a, k, dim, bool(largest), bool(sorted), out=out)
+
+
 _register_implementation(prims.amax, checker=_always_executable, execution_transform=_amax_prim_transform)
 _register_implementation(prims.amin, checker=_always_executable, execution_transform=_amin_prim_transform)
 _register_implementation(prims.prod, checker=_always_executable, execution_transform=_prod_prim_transform)
 _register_implementation(prims.sum, checker=_always_executable, execution_transform=_sum_prim_transform)
 _register_implementation(prims.var, checker=_always_executable, execution_transform=_var_prim_transform)
 _register_implementation(prims.var_mean, checker=_always_executable, execution_transform=_var_mean_prim_transform)
 _register_implementation(prims.argmax, checker=_always_executable, execution_transform=_argmax_transform)
 _register_implementation(prims.argmin, checker=_always_executable, execution_transform=_argmin_transform)
+_register_implementation(prims.topk, checker=_always_executable, execution_transform=_topk_transform)
 
 _register_implementation(ltorch.amax, amax, checker=_always_executable)
 _register_implementation(ltorch.amin, amin, checker=_always_executable)
 _register_implementation(ltorch.mean, mean, checker=_always_executable)
 _register_implementation(ltorch.prod, prod, checker=_always_executable)
 _register_implementation(ltorch.sum, sum, checker=_always_executable)
 _register_implementation(ltorch.cumsum, checker=_always_executable, execution_transform=_cumsum_transform)
 _register_implementation(ltorch.var, var, checker=_always_executable)
 _register_implementation(ltorch.var_mean, var_mean, checker=_always_executable)
 _register_implementation(ltorch.argmax, argmax, checker=_always_executable)
 _register_implementation(ltorch.argmin, argmin, checker=_always_executable)
+_register_implementation(ltorch.topk, topk, checker=_always_executable, execution_transform=_topk_transform)
 
 #
 # Scatter and gather operations
 #
 
 index_add = _register_torch_operation("index_add")
 index_put = _register_torch_operation("index_put")
@@ -1159,17 +1175,23 @@
 
 #
 # Normalization operations
 #
 
 layer_norm = _register_torch_operation("layer_norm", module=torch.nn.functional)
 batch_norm = _register_torch_operation("batch_norm", module=torch.nn.functional)
+native_batch_norm = _register_torch_operation("torch.ops.aten.native_batch_norm", like=prims.batch_norm)
+native_batch_norm_backward = _register_torch_operation(
+    "torch.ops.aten.native_batch_norm_backward", like=ltorch.batch_norm_backward
+)
 
 _register_implementation(ltorch.layer_norm, layer_norm, checker=_always_executable)
 _register_implementation(ltorch.batch_norm, batch_norm, checker=_always_executable)
+_register_implementation(prims.batch_norm, native_batch_norm, checker=_always_executable)
+_register_implementation(ltorch.batch_norm_backward, native_batch_norm_backward, checker=_always_executable)
 
 #
 # NN operations
 #
 
 bmm = _register_torch_operation("bmm")
 convolution = _register_torch_operation("convolution")
@@ -1596,15 +1618,17 @@
         return buffer
 
     def _unpack_prim_impl(
         buffer: torch.Tensor,
         tensors: list[torch.Tensor],
         bucket_key: str,
     ) -> list[torch.Tensor]:
-        return torch._utils._unflatten_dense_tensors(buffer, tensors)
+        _, views = _key_to_bucket_and_views[bucket_key]
+        torch._foreach_copy_(tensors, views, non_blocking=True)
+        return tensors
 
     # TODO(crcrpar): Make this compatible with the torch.compile executor as it's doing really well for cat and reshape.
     # NOTE(crcrpar): why no caching/resue of buffer?
     # This prim is only used by fsdp backward for now.
     # Bucketing of reduce-scatter, i.e., creating a buffer for
     # multiple unsharded gradients is a bit tricky because it requires
     # indices for copies from unsharded ones to their bucket.
```

### Comparing `lightning-thunder-0.1.0/thunder/executors/transformer_engineex.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/transformer_engineex.py`

 * *Files 8% similar despite different names*

```diff
@@ -15,19 +15,17 @@
 from thunder.core.proxies import TensorProxy
 from thunder.core.trace import get_tracectx
 from thunder.core.symbol import Symbol, BoundSymbol
 import thunder.core.devices as devices
 import thunder.core.prims as prims
 from thunder.core.proxies import TensorProxy, CollectionProxy
 from thunder.core.symbol import Symbol
-from thunder.core.transforms import (
-    register_augmented_forward_with_checker,
-    register_backward,
-)
+from thunder.core.vjp_utils import disable_caching_split_forward_and_backward
 from thunder.extend import OperatorExecutor, register_executor
+from thunder.core.langctxs import langctx, Languages
 
 __all__ = [
     "transformer_engine_ex",
 ]
 
 TE_AVAILABLE: bool = package_available("transformer_engine")
 
@@ -369,14 +367,18 @@
 
     return bsym.output[0]
 
 
 #
 # Registers transformer_engine_ex as an executor for torch.nn.functional.linear
 #
+
+
+# NOTE: We need langctx so that we can resolve `view` on TensorProxy.
+@langctx(Languages.TORCH)
 def _linear_checker(
     a: TensorProxy,
     w: TensorProxy,
     bias: None | TensorProxy,
 ) -> bool:
     def is_cuda(t):
         return t.device.devicetype == devices.DeviceType.CUDA
@@ -398,40 +400,35 @@
 def linear_forwad_rule(a, w, bias):
     out, ctx_idx = _create_fp8_linear_bound_symbol(a, w, bias, is_grad_enabled=True)
     primal = out
     saved_for_backward = (a.shape, w.shape, bias.shape if bias is not None else None, ctx_idx)
     return primal, saved_for_backward
 
 
-def linear_forward_rule_checker(a: TensorProxy, w: TensorProxy, bias: None | TensorProxy) -> bool:
-    from thunder.core.compile_data import get_compile_data
-
-    cd = get_compile_data()
-    if transformer_engine_ex in cd.executors_list:
-        return _linear_checker(a, w, bias)
-    return False
-
-
-register_augmented_forward_with_checker(
-    transformer_engine_ex,
-    prims.linear.id,
-    linear_forward_rule_checker,
-    linear_forwad_rule,
-)
-
-
-@register_backward((transformer_engine_ex, prims.linear.id))
 def linear_backward_rule(a_shape, w_shape, b_shape, ctx_idx, grad):
     return te_functional_linear_backward(grad, a_shape, w_shape, b_shape, ctx_idx)
 
 
 # Translate calls from torch.nn.functional.linear to te.Linear (when the checker above returns True)
 def _linear_transform(a: TensorProxy, w: TensorProxy, b: TensorProxy) -> torch.Tensor:
     return _create_fp8_linear_bound_symbol(a, w, b, is_grad_enabled=False)
 
 
+@disable_caching_split_forward_and_backward
+def _linear_grad(a: TensorProxy, w: TensorProxy, b: TensorProxy) -> TensorProxy:
+    out, saved_for_backward = linear_forwad_rule(a, w, b)
+    g = prims.get_grad(out)
+    ga, gw, gb = linear_backward_rule(*saved_for_backward, g)
+    prims.put_grad(a, ga)
+    prims.put_grad(w, gw)
+    if b is not None:
+        prims.put_grad(b, gb)
+    return out
+
+
 # Registers the implementation for torch.nn.functional.linear
 transformer_engine_ex.register_implementation(
     prims.linear,
     checker=_linear_checker,
     execution_transform=_linear_transform,
+    grad_transform=_linear_grad,
 )
```

### Comparing `lightning-thunder-0.1.0/thunder/executors/triton_crossentropy.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/triton_crossentropy_impl.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,28 +1,24 @@
 import math
 from enum import Enum
 
 import torch
 
-
-import thunder.torch as ltorch
+from thunder.extend import OperatorExecutor, register_executor
 from thunder.executors import triton_utils
 
-
 # Requires triton 2.1 or greater
 min_triton_version = "2.1"
+
 triton_version: None | str = triton_utils.triton_version()
-assert triton_version is not None, f"Trying to import a Triton executor, but Triton is unavailable"
 TRITON_AVAILABLE: bool = triton_utils.is_triton_version_at_least(min_triton_version)
 assert (
     TRITON_AVAILABLE
 ), f"Trying to import a Triton executor, but it requires Triton version {min_triton_version} or greater, and the current Triton version is {triton_version}"
 
-from thunder.extend import OperatorExecutor, register_executor
-
 triton_ex: OperatorExecutor = OperatorExecutor("triton", version=triton_version)
 register_executor(triton_ex)
 
 import triton  # noqa: E402
 import triton.language as tl  # noqa: E402
 
 # Temporarily borrowed from https://github.com/openai/triton
```

### Comparing `lightning-thunder-0.1.0/thunder/executors/utils.py` & `lightning-thunder-0.2.0.dev20240404/thunder/executors/utils.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/extend/__init__.py` & `lightning-thunder-0.2.0.dev20240404/thunder/extend/__init__.py`

 * *Files 8% similar despite different names*

```diff
@@ -21,15 +21,14 @@
     "get_executor",
     "set_default_executors",
     "set_always_executors",
     "add_default_executor",
     "add_always_executor",
     "remove_default_executor",
     "remove_always_executor",
-    "register_lookaside",
 ]
 
 
 class ImplInfo:
     def __init__(
         self,
         *,
@@ -46,14 +45,15 @@
 
 class Executor:
     def __init__(self, name: Hashable, *, version: None | Any = None):
         self._name: Hashable = name
         self._version = version
 
         self._implmap: dict[Hashable, ImplInfo] = {}
+        self._lookasides: dict[Callable, Callable] = {}
 
     @property
     def name(self) -> Hashable:
         return self._name
 
     @property
     def version(self) -> Any:
@@ -236,15 +236,15 @@
             executor=self,
             _bind_postprocess=_bind_postprocess,
             python_printer=python_printer,
         )
         self.opmap[name] = sym
 
         if replaces is not None:
-            register_lookaside(replaces, sym)
+            self._lookasides[replaces] = sym
 
         return sym
 
     def register_implementation(
         self,
         sym_or_id: Symbol | Hashable,
         op: None | Symbol = None,
@@ -302,21 +302,17 @@
         cudnnex,
         nvfuserex,
         pythonex,
         sdpaex,
         torch_compile,
         torchex,
         transformer_engineex,
+        triton_crossentropy,
     )
 
-    if torch.cuda.is_available():
-        # raise an error when a dependency is not available at import time
-        # TODO: this should only happen at runtime
-        from thunder.executors import triton_crossentropy
-
     return tuple(_executor_map.values())
 
 
 def get_default_executors() -> tuple[Executor]:
     return tuple(_default_executors)
 
 
@@ -382,14 +378,7 @@
     id: Hashable = ex.name if isinstance(ex, Executor) else ex
 
     if id in _executor_map:
         del _executor_map[id]
 
     remove_always_executor(id)
     remove_default_executor(id)
-
-
-def register_lookaside(function, symbol) -> None:
-    """register `symbol` as a lookaside for `function`"""
-    import thunder.core.jit_ext
-
-    thunder.core.jit_ext._general_jit_lookaside_map[function] = thunder.core.jit_ext.interpreter_needs_wrap(symbol)
```

### Comparing `lightning-thunder-0.1.0/thunder/functional.py` & `lightning-thunder-0.2.0.dev20240404/thunder/functional.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/numpy/__init__.py` & `lightning-thunder-0.2.0.dev20240404/thunder/numpy/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/numpy/langctx.py` & `lightning-thunder-0.2.0.dev20240404/thunder/numpy/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.1.0/thunder/torch/__init__.py` & `lightning-thunder-0.2.0.dev20240404/thunder/torch/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -1204,14 +1204,25 @@
 # id=torch.relu because we ignore inplace argument in torch.nn.functional.relu
 @torchsymbol(torch.nn.functional.relu6, id="torch.relu6", is_method=False)
 def relu6(a: TensorProxy, /, inplace: bool = False) -> TensorLike:
     utils.check(not inplace, lambda: f"relu6 only supports inplace=False", exception_type=NotImplementedError)
     return clamp(a, 0, 6)
 
 
+@torchsymbol(torch.nn.functional.hardswish, id="torch.hardswish", is_method=False)
+def hardswish(a: TensorProxy, /, inplace: bool = False) -> TensorLike:
+    utils.check(not inplace, lambda: f"hardswish only supports inplace=False", exception_type=NotImplementedError)
+    utils.check(
+        dtypes.is_float_dtype(a.dtype),
+        lambda: f"hardswish only supports floating point dtypes, got {a.dtype}",
+        exception_type=ValueError,
+    )
+    return a * relu6(a + 3) / 6
+
+
 # id=torch.selu because we ignore inplace argument in torch.nn.functional.selu
 @torchsymbol(torch.selu, torch.nn.functional.selu, id="torch.selu", is_method=False)
 def selu(a: TensorProxy, /, inplace: bool = False) -> TensorLike:
     utils.check(not inplace, lambda: f"selu only supports inplace=False", exception_type=NotImplementedError)
 
     alpha = 1.6732632423543772848170429916717
     scale = 1.0507009873554804934193349852946
@@ -1793,14 +1804,21 @@
 
 
 @torchsymbol(torch.argmin, is_method=True)
 def argmin(a: TensorLike, /, dim: int | None = None, keepdim: bool | None = False):
     return clang.argmin(a, dim, keepdim)
 
 
+@torchsymbol(torch.topk, is_method=True)
+def topk(
+    a: TensorLike, /, k: int, dim: None | int = None, largest: bool = True, sorted: bool = True, *, out=None
+) -> (TensorLike, TensorLike):
+    return clang.topk(a, k, dim, largest, sorted, out=out)
+
+
 #
 # Scatter and gather-related operations
 #
 
 
 # NOTE PyTorch also has an alpha parameter
 @torchsymbol(torch.index_add)
@@ -1864,15 +1882,15 @@
         exception_type=NotImplementedError,
     )
 
     operands = list(utils.sequencify(operands))
     utils.check_types(operands, TensorProxy)
 
     orig_eq = equation
-    # Removes spaces and replaces ... with . to faciliate parsing later
+    # Removes spaces and replaces ... with . to facilitate parsing later
     equation = re.sub(r"\s", "", equation)
     equation = re.sub(r"\.\.\.", ".", equation)
 
     # Splits the equation into input/output subscripts
     input_output_subscripts = equation.split("->")
     input_subscript: str
     output_subscript: None | str = None
@@ -2470,101 +2488,197 @@
         normalized_shape = a.shape[-normalized_ndim:]
     if bias is not None:
         normalized_ndim = len(bias.shape)
         normalized_shape = a.shape[-normalized_ndim:]
     return _native_layer_norm(a, normalized_shape, weight, bias, eps)[0]
 
 
-# we need variance for batch_norm
-def _normalize_mean_var(a: TensorProxy, /, norm_dims, eps: Number) -> tuple[TensorLike, TensorLike, TensorLike]:
-    """Computes mean and var of a tensor along norm_dims. Used as a helper function for normalization layers.
-
-    Args:
-        a (Tensor): input tensor
-        norm_dims (DimsType): dimensions to normalize over
-        eps (float): epsilon for numerical stability
-
-    Returns:
-        out (Tensor): normalized tensor.
-        mean (Tensor): mean of the tensor along norm_dims.
-        var (Tensor): var of the tensor along norm_dims.
-    """
-    norm_dims = utils.canonicalize_dims(a.ndim, norm_dims)
-    computation_dtype = utils.get_computation_dtype(a.dtype)
-    a_acc = to(a, computation_dtype)
-    biased_var, mean = var_mean(a_acc, dim=norm_dims, correction=0, keepdim=True)
-    rstd = rsqrt(biased_var + eps)
-    out = (a - mean) * rstd
-    return out, mean, biased_var
-
-
-# TODO: likely want to refactor these normalizations
-def _native_batch_norm(
-    a: TensorProxy,
-    /,
-    weight: TensorProxy,
-    bias: TensorProxy,
-    eps: Number,
-) -> tuple[TensorLike, TensorLike, TensorLike]:
+@torchsymbol(torch.nn.functional.batch_norm)
+def batch_norm(
+    a: TensorLike,
+    running_mean: None | TensorLike = None,
+    running_var: None | TensorLike = None,
+    weight: None | TensorLike = None,
+    bias: None | TensorLike = None,
+    training: bool = False,
+    momentum: Number = 0.1,
+    eps: Number = 1e-5,
+) -> TensorLike:
     # Validates inputs
     input_shape = tuple(a.shape)
     utils.check(len(input_shape) >= 2, lambda: f"Expected input_shape={input_shape} to have length >= 2!")
 
     # NOTE Containers are canonicalized in the following checks since
     #   (1, 2, 3) != [1, 2, 3]
     utils.check(
-        weight is None or weight.shape == (input_shape[1],) or weight.shape == (),
+        weight is None or weight.shape == (input_shape[1],),
         lambda: f"Expected weight.shape={weight.shape} to be {(input_shape[1],)}!",
     )
     utils.check(
-        bias is None or bias.shape == (input_shape[1],) or bias.shape == (),
+        bias is None or bias.shape == (input_shape[1],),
         lambda: f"Expected bias.shape={bias.shape} to be {(input_shape[1],)}!",
     )
+    utils.check(
+        running_mean is None or running_mean.shape == (input_shape[1],),
+        lambda: f"Expected running_mean.shape={running_mean.shape} to be {(input_shape[1],)}!",
+    )
+    utils.check(
+        running_var is None or running_var.shape == (input_shape[1],),
+        lambda: f"Expected running_var.shape={running_var.shape} to be {(input_shape[1],)}!",
+    )
+    if training:
+        size_prods = input_shape[0]
+        for i in range(len(input_shape) - 2):
+            size_prods *= input_shape[i + 2]
+        utils.check(
+            size_prods != 1, lambda: f"Expected more than 1 value per channel when training, got input size {size}"
+        )
+    else:
+        utils.check(
+            running_mean is not None and running_var is not None,
+            lambda: f"running_mean and running_var must be defined in evaluation mode",
+        )
+    computation_dtype = utils.get_computation_dtype(a.dtype)
+    a_dtype = a.dtype
+    # Check mixed input types
+    params = [x for x in (weight, bias, running_mean, running_var) if x is not None]
+    if params:
+        if utils.is_low_precision_dtype(a.dtype):
+            utils.check(
+                utils.are_same_dtypes(params[0], a) or utils.are_same_dtypes(params[0], computation_dtype),
+                lambda: f"Expected to have type {computation_dtype} or {a.dtype} but got {params[0].dtype}",
+            )
+        else:
+            utils.check_same_dtype(params[0], a)
+        utils.check_same_dtype(*params)
 
-    params_shape = (1, -1) + (1,) * (a.ndim - 2)
-    reduction_dims = (0,) + tuple(range(2, a.ndim))
-    out, mean, var = _normalize_mean_var(a, reduction_dims, eps)
+    # inplace operation is not supported, so running mean and running var can not be casted,
+    # they are passed to prim operator directly
+    (
+        a,
+        weight,
+        bias,
+    ) = (
+        to(x, computation_dtype) if x is not None else x
+        for x in (
+            a,
+            weight,
+            bias,
+        )
+    )
+    result = prims.batch_norm(a, weight, bias, running_mean, running_var, training, momentum, eps)
+    output = to(result[0], a_dtype)
+    return output
 
-    # Handles weight and bias
+
+@torchsymbol("batch_norm_backward", id="batch_norm_backward")
+def batch_norm_backward(
+    g: TensorLike,
+    a: TensorLike,
+    weight: None | TensorLike,
+    running_mean: None | TensorLike,
+    running_var: None | TensorLike,
+    save_mean: None | TensorLike,
+    save_invstd: None | TensorLike,
+    train: bool,
+    eps: Number,
+    output_mask: list[bool],
+) -> tuple[TensorLike, None | TensorLike, None | TensorLike]:
+    utils.check(a.ndim >= 2, lambda: f"Input tensor must have at least batch and channel dimensions!")
+    if train:
+        utils.check(
+            save_mean is not None and save_invstd is not None,
+            lambda: f"when train=True, save_mean and save_invstd are required",
+        )
+    else:
+        utils.check(
+            running_mean is not None and running_var is not None,
+            lambda: f"when train=False, running_mean and running_var are required",
+        )
+    a_dtype = a.dtype
     if weight is not None:
-        weight = reshape(weight, params_shape)
-        out = out * weight
-    if bias is not None:
-        bias = reshape(bias, params_shape)
-        out = out + bias
+        weight_dtype = weight.dtype
+    else:
+        weight_dtype = a_dtype
+    computation_dtype = utils.get_computation_dtype(a.dtype)
+    (
+        grad_out_cast,
+        a_cast,
+        weight_cast,
+        running_mean_cast,
+        running_var_cast,
+        save_mean_cast,
+        save_invstd_cast,
+    ) = (
+        to(x, computation_dtype) if x is not None else x
+        for x in (
+            g,
+            a,
+            weight,
+            running_mean,
+            running_var,
+            save_mean,
+            save_invstd,
+        )
+    )
+    input_shape = a.shape
+    input_rank = a.dim()
+    axis = 1
+    input_size_prod = 1
+    for x in input_shape:
+        input_size_prod *= x
+
+    num_features = input_size_prod / input_shape[axis]
+    mean = save_mean_cast
+    invstd = save_invstd_cast
+    if not train:
+        mean = running_mean_cast
+        invstd = rsqrt(running_var_cast + eps)
+    broadcast_mask = [1] * input_rank
+    broadcast_mask[axis] = input_shape[axis]
+
+    reduction_axes = []
+    for i in range(input_rank):
+        if i != axis:
+            reduction_axes.append(i)
+
+    mean = reshape(mean, broadcast_mask)
+    norm = 1.0 / num_features
+    grad_output_sum = sum(grad_out_cast, reduction_axes)
+    dot_p = sum(grad_out_cast * (a_cast - mean), reduction_axes)
 
-    out = to(out, a.dtype)
-    # TODO Is the following conversion or conversions CPU only?
-    # if input.device.type == "cpu":
-    mean = to(mean, a.dtype)
-    var = to(var, a.dtype)
+    grad_mean = reshape(grad_output_sum * norm, broadcast_mask)
+    proj_scale = reshape(mul(dot_p * norm, invstd * invstd), broadcast_mask)
 
-    return out, mean, var
+    if weight_cast is None:
+        grad_scale = reshape(invstd, broadcast_mask) * 1.0
+    else:
+        grad_scale = reshape(invstd * weight_cast, broadcast_mask)
 
+    if train:
+        proj = (a_cast - mean) * proj_scale
+        grad_input = ((grad_out_cast - proj) - grad_mean) * grad_scale
+    else:
+        grad_input = grad_out_cast * grad_scale
 
-# TODO Move this to nn.functional
-@torchsymbol(torch.nn.functional.batch_norm, is_prim=True)
-def batch_norm(
-    a: TensorLike,
-    running_mean: None | TensorLike = None,
-    running_var: None | TensorLike = None,
-    weight: None | TensorLike = None,
-    bias: None | TensorLike = None,
-    training: bool = False,
-    momentum: None | Number = 0.1,
-    eps: Number = 1e-5,
-) -> TensorLike:
-    from thunder.core.trace import detached_trace
+    if output_mask[1]:
+        grad_weight = dot_p * invstd
+    else:
+        grad_weight = None
 
-    with detached_trace():
-        out, mean, var = _native_batch_norm(a, weight, bias, eps)
-        if training and momentum is not None and running_mean is not None and running_var is not None:
-            running_mean = (1 - momentum) * running_mean + momentum * mean
-            running_var = (1 - momentum) * running_var + momentum * var
-    return out
+    if output_mask[2]:
+        grad_bias = grad_output_sum
+    else:
+        grad_bias = None
+
+    return (
+        grad_input.to(a_dtype),
+        None if grad_weight is None else clang.maybe_convert_to_dtype(grad_weight, weight_dtype),
+        None if grad_bias is None else clang.maybe_convert_to_dtype(grad_bias, weight_dtype),
+    )
 
 
 #
 # NN Operations
 #
```

### Comparing `lightning-thunder-0.1.0/thunder/torch/langctx.py` & `lightning-thunder-0.2.0.dev20240404/thunder/torch/langctx.py`

 * *Files identical despite different names*

